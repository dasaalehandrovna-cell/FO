#—Å–æ–∑–¥–∞—ë—Ç –¥—É–±–ª—å –∏–Ω—Ñ–æ
# ============================================
# –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è 9.8.3
# –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –æ–¥–Ω–∏–º –æ–∫–Ω–æ–º –∏ CSV
# ============================================

# -----------------------------
# –û–¢–°–ï–ö 1 ‚Äî –ò–º–ø–æ—Ä—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
# -----------------------------
import os
import json
import csv
import logging
import re
import threading
import time
from datetime import datetime
from zoneinfo import ZoneInfo

import telebot
from flask import Flask, request
from telebot import types

TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")
APP_URL = os.getenv("APP_URL", "https://yourapp.onrender.com")
TZ = ZoneInfo("America/Argentina/Catamarca")
DATA_FILE = "data.json"
CSV_FILE = "data.csv"
LOG_FILE = "log.txt"
PORT = int(os.environ.get("PORT", 5000))
VERSION = "9.8.3"

if not TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# -----------------------------
# –û–¢–°–ï–ö 2 ‚Äî –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# -----------------------------
logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[logging.FileHandler(LOG_FILE, encoding="utf-8"), logging.StreamHandler()]
)

def log_info(msg):
    logging.info(msg)

def log_error(msg):
    logging.error(msg)

log_info(f"–°—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –í–µ—Ä—Å–∏—è {VERSION}")

# -----------------------------
# –û–¢–°–ï–ö 3 ‚Äî –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏ IO
# -----------------------------
def default_data():
    return {
        "overall_balance": 0,
        "records": [],
        "chats": {},
        "active_messages": {},
        "processed_messages": [],
        "forward_targets": [],
        "tracked_messages": {},
        "next_id": 1
    }

def load_data():
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, "r", encoding="utf-8") as f:
                d = json.load(f)
        except:
            d = default_data()
    else:
        d = default_data()
    base = default_data()
    for k, v in base.items():
        if k not in d:
            d[k] = v
    return d

def save_data(d):
    try:
        with open(DATA_FILE, "w", encoding="utf-8") as f:
            json.dump(d, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è data.json: {e}")

data = load_data()

if OWNER_ID:
    try:
        oi = int(OWNER_ID)
        if oi not in data.get("forward_targets", []):
            data["forward_targets"].append(oi)
            save_data(data)
    except Exception:
        pass

# -----------------------------
# –û–¢–°–ï–ö 4 ‚Äî –ß–∞—Ç/–¥–∞—Ç–∞
# -----------------------------
def get_today_key():
    return datetime.now(TZ).strftime("%Y-%m-%d")

def get_chat_store(chat_id):
    cid = str(chat_id)
    if cid not in data["chats"]:
        data["chats"][cid] = {"balance": 0, "records": [], "next_id": 1, "daily_records": {}, "active_windows": {}}
        save_data(data)
    return data["chats"][cid]

def get_today_active_window(chat_id):
    today = get_today_key()
    day_map = data["active_messages"].get(today, {})
    return day_map.get(str(chat_id))

def set_today_active_window(chat_id, message_id):
    today = get_today_key()
    if "active_messages" not in data:
        data["active_messages"] = {}
    if today not in data["active_messages"]:
        data["active_messages"][today] = {}
    data["active_messages"][today][str(chat_id)] = message_id
    save_data(data)
# -----------------------------
# –û–¢–°–ï–ö 5 ‚Äî –†–∞–±–æ—Ç–∞ —Å –∑–∞–ø–∏—Å—è–º–∏
# -----------------------------
def add_record_to_chat(chat_id, amount, note, owner):
    store = get_chat_store(chat_id)
    rid = data.get("next_id", 1)
    rec = {"id": rid, "short_id": f"R{rid}", "timestamp": datetime.now(TZ).isoformat(timespec="seconds"), "amount": amount, "note": note, "owner": owner}
    data.setdefault("records", []).append(rec)
    store.setdefault("records", []).append(rec)
    day = get_today_key()
    store.setdefault("daily_records", {}).setdefault(day, []).append(rec)
    store["balance"] = store.get("balance", 0) + amount
    data["overall_balance"] = data.get("overall_balance", 0) + amount
    data["next_id"] = rid + 1
    save_data(data)
    try: export_to_csv(data)
    except: pass
    return rec

def update_record_in_chat(chat_id, rid, new_amount, new_note):
    store = get_chat_store(chat_id)
    found = None
    for r in store.get("records", []):
        if r["id"] == rid:
            r["amount"] = new_amount
            r["note"] = new_note
            found = r
            break
    if found:
        for day_recs in store.get("daily_records", {}).values():
            for r in day_recs:
                if r["id"] == rid:
                    r.update(found)
        store["balance"] = sum([x["amount"] for x in store.get("records", [])])
        data["overall_balance"] = sum([x["amount"] for x in data.get("records", [])])
        save_data(data)
        export_to_csv(data)
        return True, found
    return False, None

def delete_record_in_chat(chat_id, rid):
    store = get_chat_store(chat_id)
    removed = None
    for r in list(store.get("records", [])):
        if r["id"] == rid or str(r["id"]) == str(rid) or r.get("short_id") == f"R{rid}":
            removed = r
            store["records"].remove(r)
            break
    if removed:
        for day_key, recs in store.get("daily_records", {}).items():
            store["daily_records"][day_key] = [x for x in recs if x["id"] != rid]
        store["balance"] = sum([x["amount"] for x in store.get("records", [])])
        data["records"] = [x for x in data.get("records", []) if x["id"] != rid]
        data["overall_balance"] = sum([x["amount"] for x in data.get("records", [])])
        save_data(data)
        export_to_csv(data)
        return True, removed
    return False, None

def export_to_csv(d):
    try:
        with open(CSV_FILE, "w", newline='', encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
            for cid, cdata in d.get("chats", {}).items():
                for day_key, records in cdata.get("daily_records", {}).items():
                    for r in records:
                        writer.writerow([cid, r.get("id"), r.get("short_id"), r.get("timestamp"), r.get("amount"), r.get("note"), r.get("owner"), day_key])
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ CSV: {e}")

# -----------------------------
# –û–¢–°–ï–ö 6 ‚Äî –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
# -----------------------------
def build_main_keyboard(chat_id=None, confirm_reset=False):
    kb = types.InlineKeyboardMarkup(row_width=3)
    kb.row(
        types.InlineKeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å", callback_data="btn_balance"),
        types.InlineKeyboardButton("üìä –û—Ç—á—ë—Ç", callback_data="btn_report"),
        types.InlineKeyboardButton("üìÇ CSV", callback_data="btn_csv")
    )
    if confirm_reset:
        kb.row(
            types.InlineKeyboardButton("‚úÖ –î–∞", callback_data="confirm_reset"),
            types.InlineKeyboardButton("‚ùå –ù–µ—Ç", callback_data="cancel_reset")
        )
    else:
        kb.row(types.InlineKeyboardButton("‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ", callback_data="btn_reset"))
    kb.row(
        types.InlineKeyboardButton("üöÄ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="btn_start"),
        types.InlineKeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ", callback_data="btn_cod")
    )
    balance_text = ""
    if chat_id is not None:
        store = get_chat_store(chat_id)
        balance_text = f"üí∞ {store.get('balance', 0)} ARS"
    kb.add(types.InlineKeyboardButton(balance_text or "üí∞ 0 ARS", callback_data="noop"))
    return kb

def build_edit_keyboard():
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("‚úè –ò–∑–º–µ–Ω–∏—Ç—å", callback_data="edit_change"),
        types.InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å", callback_data="edit_delete")
    )
    kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="edit_back"))
    return kb

# -----------------------------
# –û–¢–°–ï–ö 7 ‚Äî –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞
# -----------------------------
def update_or_send_today_window(chat_id, create_if_missing=True):
    today_key = get_today_key()
    store = get_chat_store(chat_id)
    day_records = store.get("daily_records", {}).get(today_key, [])

    daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
    daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
    overall_balance = store.get("balance", 0)

    if not day_records:
        text = (
            f"üìÖ {today_key}\n"
            f"–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π.\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥: {daily_income} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {abs(daily_expense)} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {overall_balance} ARS"
        )
    else:
        lines = [f"üìÖ {today_key}", "üìã –û–ø–µ—Ä–∞—Ü–∏–∏:"]
        for r in day_records[-50:]:
            sign = "+" if r["amount"] > 0 else "-"
            lines.append(f"{r['short_id']}: {sign}{abs(r['amount'])} ‚Äî {r.get('note','')}")
        lines.append(
            f"\nüíµ –ü—Ä–∏—Ö–æ–¥: {daily_income} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {abs(daily_expense)} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {overall_balance} ARS"
        )
        text = "\n".join(lines)

    kb = build_main_keyboard(chat_id)
    today_msgs = data.setdefault("active_messages", {}).setdefault(today_key, {})
    active_id = today_msgs.get(str(chat_id))

    # –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–µ –æ–∫–Ω–æ –µ—Å—Ç—å ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –µ–≥–æ
    if active_id:
        try:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
        except telebot.apihelper.ApiException as e:
            log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–∫–Ω–æ {active_id} –¥–ª—è —á–∞—Ç–∞ {chat_id}: {e}")
        return

    # –ï—Å–ª–∏ create_if_missing=False ‚Äî –Ω–µ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ
    if not create_if_missing:
        return

    # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ, –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –Ω–µ—Ç
    try:
        sent = bot.send_message(chat_id, text, reply_markup=kb)
        today_msgs[str(chat_id)] = sent.message_id
        save_data(data)
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è {chat_id}: {e}")

# -----------------------------
# –û–¢–°–ï–ö 8 ‚Äî Callback –∫–Ω–æ–ø–æ–∫
# -----------------------------
@bot.callback_query_handler(func=lambda c: True)
def handle_callback(call):
    chat_id = call.message.chat.id
    store = get_chat_store(chat_id)
    today_key = get_today_key()
    day_records = store.get("daily_records", {}).get(today_key, [])
    today_msgs = data.setdefault("active_messages", {}).setdefault(today_key, {})
    active_id = today_msgs.get(str(chat_id))

    # –ö–Ω–æ–ø–∫–∞ "–ë–∞–ª–∞–Ω—Å"
    if call.data == "btn_balance":
        daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
        daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
        overall_balance = store.get("balance", 0)

        text = (
            f"üìÖ {today_key}\n\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {overall_balance} ARS\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è: {daily_income} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è: {abs(daily_expense)} ARS"
        )

        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–∫–Ω–∞ (–ë–∞–ª–∞–Ω—Å): {e}")
        else:
            update_or_send_today_window(chat_id)

        bot.answer_callback_query(call.id, "–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—ë–Ω ‚úÖ")
        return

    # –ö–Ω–æ–ø–∫–∞ "–û—Ç—á—ë—Ç"
    if call.data == "btn_report":
        expenses = [r for r in day_records if r["amount"] < 0]
        daily_expense_total = sum(abs(r["amount"]) for r in expenses)

        if not expenses:
            text = f"üìÖ {today_key}\n–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è.\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: 0 ARS"
        else:
            lines = [f"üìÖ {today_key}", "üìã –†–∞—Å—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å:"]
            for r in expenses[-30:]:
                lines.append(f"{r['short_id']}: -{abs(r['amount'])} ‚Äî {r.get('note','')}")
            lines.append(f"\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {daily_expense_total} ARS")
            text = "\n".join(lines)

        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–∫–Ω–∞ (–û—Ç—á—ë—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤): {e}")
        else:
            update_or_send_today_window(chat_id)

        bot.answer_callback_query(call.id, "–û—Ç—á—ë—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –æ–±–Ω–æ–≤–ª—ë–Ω üìä")
        return

    # –ö–Ω–æ–ø–∫–∞ "CSV"
    if call.data == "btn_csv":
        try:
            with open(CSV_FILE, "rb") as f:
                bot.send_document(chat_id, f, caption="üìÇ –í–∞—à —Ñ–∞–π–ª data.csv")
            bot.answer_callback_query(call.id, "CSV –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω üìÅ")
        except Exception as e:
            bot.send_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ CSV: {e}")
            bot.answer_callback_query(call.id)
        return

        # –ö–Ω–æ–ø–∫–∞ "–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö"
    if call.data == "btn_reset":
        store["records"] = []
        store["daily_records"] = {}
        store["balance"] = 0
        data["records"] = []
        data["overall_balance"] = 0
        save_data(data)
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, "–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã üßπ")
        return

    # –ö–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å"
    if call.data == "btn_start":
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, "–û–∫–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ üîÑ")
        return

    # –ö–Ω–æ–ø–∫–∞ "–ò–Ω—Ñ–æ" ‚Äî —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
    if call.data == "btn_cod":
        info_text = (
            f"‚ÑπÔ∏è –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è {VERSION}\n\n"
            "üìå –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "/start - –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞ –æ—Ç—á—ë—Ç–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è\n"
            "/balance - –ü–æ–∫–∞–∑–∞—Ç—å –æ–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –∑–∞ –¥–µ–Ω—å\n"
            "/report - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è\n"
            "/csv - –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª —Å –∏—Å—Ç–æ—Ä–∏–µ–π –æ–ø–µ—Ä–∞—Ü–∏–π\n"
            "/reset - –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏\n"
            "/update - –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –æ–∫–Ω–æ\n"
            "/info - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ –æ–∫–Ω–æ —Å–æ —Å–ø–∏—Å–∫–æ–º –∫–æ–º–∞–Ω–¥\n\n"
            "üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π:\n"
            "+500 –ó–∞—Ä–ø–ª–∞—Ç–∞\n"
            "-150 –û–±–µ–¥\n"
            "200 –¢–∞–∫—Å–∏\n\n"
            "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏ \"–ò–∑–º–µ–Ω–∏—Ç—å\" / \"–£–¥–∞–ª–∏—Ç—å\""
        )

        bot.send_message(chat_id, info_text, reply_markup=None)
        bot.answer_callback_query(call.id, "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è üìÑ")
        return

    # –ö–Ω–æ–ø–∫–∞ "No operation" ‚Äî –ø—É—Å—Ç—ã—à–∫–∞
    if call.data == "noop":
        bot.answer_callback_query(call.id)
        return 


# -----------------------------
# –û–¢–°–ï–ö 9 ‚Äî –í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
# -----------------------------
num_re = re.compile(r'([+-]?\s*\d+)')

@bot.message_handler(func=lambda m: True)
def handle_message(msg):
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    wait_action = store.get("edit_wait")

    # –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å
    if wait_action is None:
        m = num_re.search(msg.text)
        if m:
            try:
                raw = m.group(1).replace(" ", "")
                if raw.startswith("+"):
                    amount = int(raw[1:])        # –ü—Ä–∏—Ö–æ–¥
                elif raw.startswith("-"):
                    amount = -int(raw[1:])       # –†–∞—Å—Ö–æ–¥
                else:
                    amount = -int(raw)           # –ë–µ–∑ –∑–Ω–∞–∫–∞ = —Ä–∞—Å—Ö–æ–¥

                note = msg.text.replace(m.group(1), "").strip()
                add_record_to_chat(chat_id, amount, note, msg.from_user.id)
                update_or_send_today_window(chat_id)
            except Exception as e:
                log_error(f"–û—à–∏–±–∫–∞ –∞–≤—Ç–æ-–¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏: {e}")
        return

    # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É–º–º—ã –∏ –∑–∞–º–µ—Ç–∫–∏
    if wait_action == "change_id":
        try:
            rid = int(msg.text.strip())
            store["edit_target"] = rid
            store["edit_wait"] = "change_value"
            bot.send_message(chat_id, f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—É–º–º—É –∏ –∑–∞–º–µ—Ç–∫—É –¥–ª—è –∑–∞–ø–∏—Å–∏ {rid}:")
        except:
            bot.send_message(chat_id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID")
        return

    if wait_action == "change_value":
        rid = store.get("edit_target")
        if not rid:
            store["edit_wait"] = None
            return
        parts = msg.text.strip().split(" ", 1)
        try:
            amount = int(parts[0])
            note = parts[1] if len(parts) > 1 else ""
            success, _ = update_record_in_chat(chat_id, rid, amount, note)
            store["edit_wait"] = None
            store["edit_target"] = None
            update_or_send_today_window(chat_id)
            msg_text = f"‚úÖ –ó–∞–ø–∏—Å—å {rid} –∏–∑–º–µ–Ω–µ–Ω–∞" if success else f"‚ùå –ó–∞–ø–∏—Å—å {rid} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            bot.send_message(chat_id, msg_text)
        except:
            bot.send_message(chat_id, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ —Å—É–º–º—ã")
        return

    # –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
    if wait_action == "delete_id":
        try:
            rid = int(msg.text.strip())
            success, _ = delete_record_in_chat(chat_id, rid)
            store["edit_wait"] = None
            update_or_send_today_window(chat_id)
            msg_text = f"‚úÖ –ó–∞–ø–∏—Å—å {rid} —É–¥–∞–ª–µ–Ω–∞" if success else f"‚ùå –ó–∞–ø–∏—Å—å {rid} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            bot.send_message(chat_id, msg_text)
        except:
            bot.send_message(chat_id, "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏")

# -----------------------------
# –û–¢–°–ï–ö 13 ‚Äî Flask webhook
# -----------------------------
@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    update = telebot.types.Update.de_json(request.get_data().decode("utf-8"))
    bot.process_new_updates([update])
    return "OK", 200

@app.route("/", methods=["GET"])
def index():
    return f"–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ¬´–§–û¬ª ‚Äî –≤–µ—Ä—Å–∏—è {VERSION} —Ä–∞–±–æ—Ç–∞–µ—Ç", 200

# -----------------------------
# –û–¢–°–ï–ö 14 ‚Äî Webhook —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫
# -----------------------------
def set_webhook():
    url = f"{APP_URL}/{TOKEN}"
    try:
        bot.remove_webhook()
        time.sleep(0.5)
        bot.set_webhook(url=url)
        log_info(f"Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {url}")
    except Exception as e:
        log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook: {e}")

# -----------------------------
# –û–¢–°–ï–ö 15 ‚Äî –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Å–º–µ–Ω—ã –¥–Ω—è
# -----------------------------
def schedule_daily_window_creation():
    def task():
        last_day = get_today_key()
        while True:
            try:
                time.sleep(60)
                current_day = get_today_key()
                if current_day != last_day:
                    for chat_id_str in list(data.get("chats", {}).keys()):
                        try:
                            chat_id = int(chat_id_str)
                        except: continue
                        try:
                            update_or_send_today_window(chat_id)
                        except Exception as e:
                            log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–∫–Ω–∞ –Ω–æ–≤–æ–≥–æ –¥–Ω—è –¥–ª—è {chat_id}: {e}")
                    last_day = current_day
            except Exception as e:
                log_error(f"–û—à–∏–±–∫–∞ –≤ daily loop: {e}")
                time.sleep(5)
    thread = threading.Thread(target=task, daemon=True)
    thread.start()

# -----------------------------
# –û–¢–°–ï–ö 16 ‚Äî –ó–∞–ø—É—Å–∫
# -----------------------------
if __name__ == "__main__":
    set_webhook()
    schedule_daily_window_creation()
    log_info(f"–ë–æ—Ç –§–û –≤–µ—Ä—Å–∏–∏ {VERSION} –∑–∞–ø—É—â–µ–Ω")

    # –°–æ–æ–±—â–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É –≤ Telegram
    try:
        if OWNER_ID:
            bot.send_message(int(OWNER_ID), f"‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! (–≤–µ—Ä—Å–∏—è {VERSION})")
    except Exception as e:
        log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ: {e}")

    app.run(host="0.0.0.0", port=PORT)



# ============================================
# –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è 9.8.3
# –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è (–æ–¥–∏–Ω —Ñ–∞–π–ª) —Å –æ–¥–Ω–∏–º –æ–∫–Ω–æ–º –∏ CSV
# –û—Ç—Å–µ–∫–∏ 1‚Äì13 (–ø–æ–¥–æ—Ç—Å–µ–∫–∏ –≤–Ω—É—Ç—Ä–∏)
# ============================================

# -----------------------------
# –û–¢–°–ï–ö 1 ‚Äî –ò–º–ø–æ—Ä—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
# -----------------------------
import os
import json
import csv
import logging
import re
import threading
import time
from datetime import datetime
from zoneinfo import ZoneInfo

import telebot
from flask import Flask, request
from telebot import types

TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")
APP_URL = os.getenv("APP_URL", "https://yourapp.onrender.com")
TZ = ZoneInfo("America/Argentina/Catamarca")
DATA_FILE = "data.json"
CSV_FILE = "data.csv"
LOG_FILE = "log.txt"
PORT = int(os.environ.get("PORT", 5000))
VERSION = "9.8.3"

if not TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# -----------------------------
# –û–¢–°–ï–ö 2 ‚Äî –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# -----------------------------
logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[logging.FileHandler(LOG_FILE, encoding="utf-8"), logging.StreamHandler()]
)

def log_info(msg):
    logging.info(msg)

def log_error(msg):
    logging.error(msg)

log_info(f"–°—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –í–µ—Ä—Å–∏—è {VERSION}")

# -----------------------------
# –û–¢–°–ï–ö 3 ‚Äî –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏ IO
# -----------------------------
def default_data():
    return {
        "overall_balance": 0,
        "records": [],
        "chats": {},
        "active_messages": {},
        "processed_messages": [],
        "forward_targets": [],
        "tracked_messages": {},
        "next_id": 1
    }

def load_data():
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, "r", encoding="utf-8") as f:
                d = json.load(f)
        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è {DATA_FILE}: {e}")
            d = default_data()
    else:
        d = default_data()
    base = default_data()
    for k, v in base.items():
        if k not in d:
            d[k] = v
    return d

def save_data(d):
    try:
        with open(DATA_FILE, "w", encoding="utf-8") as f:
            json.dump(d, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è data.json: {e}")

data = load_data()

# –ü–æ–¥–æ—Ç—Å–µ–∫ 3.1 ‚Äî –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤ forward_targets (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω)
if OWNER_ID:
    try:
        oi = int(OWNER_ID)
        if oi not in data.get("forward_targets", []):
            data["forward_targets"].append(oi)
            save_data(data)
    except Exception as e:
        log_error(f"OWNER_ID –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω: {e}")

# -----------------------------
# –û–¢–°–ï–ö 4 ‚Äî –ß–∞—Ç/–¥–∞—Ç–∞ (—Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
# -----------------------------
def get_today_key():
    return datetime.now(TZ).strftime("%Y-%m-%d")

def get_chat_store(chat_id):
    cid = str(chat_id)
    if cid not in data["chats"]:
        data["chats"][cid] = {
            "balance": 0,
            "records": [],
            "next_id": 1,
            "daily_records": {},
            "active_windows": {},
            "edit_wait": None,
            "edit_target": None
        }
        save_data(data)
    return data["chats"][cid]

def get_today_active_window(chat_id):
    today = get_today_key()
    return data.setdefault("active_messages", {}).get(today, {}).get(str(chat_id))

def set_today_active_window(chat_id, message_id):
    today = get_today_key()
    data.setdefault("active_messages", {}).setdefault(today, {})[str(chat_id)] = message_id
    save_data(data)

# -----------------------------
# –û–¢–°–ï–ö 5 ‚Äî –†–∞–±–æ—Ç–∞ —Å –∑–∞–ø–∏—Å—è–º–∏
# -----------------------------
def add_record_to_chat(chat_id, amount, note, owner):
    store = get_chat_store(chat_id)
    rid = data.get("next_id", 1)
    rec = {
        "id": rid,
        "short_id": f"R{rid}",
        "timestamp": datetime.now(TZ).isoformat(timespec="seconds"),
        "amount": amount,
        "note": note,
        "owner": owner
    }
    data.setdefault("records", []).append(rec)
    store.setdefault("records", []).append(rec)
    day = get_today_key()
    store.setdefault("daily_records", {}).setdefault(day, []).append(rec)
    store["balance"] = store.get("balance", 0) + amount
    data["overall_balance"] = sum(r["amount"] for r in data.get("records", []))
    data["next_id"] = rid + 1
    save_data(data)
    try:
        export_to_csv(data)
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –≤ CSV: {e}")
    return rec

def update_record_in_chat(chat_id, rid, new_amount, new_note):
    store = get_chat_store(chat_id)
    found = None
    for r in store.get("records", []):
        if r["id"] == rid:
            r["amount"] = new_amount
            r["note"] = new_note
            found = r
            break
    if found:
        for day_recs in store.get("daily_records", {}).values():
            for r in day_recs:
                if r["id"] == rid:
                    r.update(found)
        store["balance"] = sum(x["amount"] for x in store.get("records", []))
        data["overall_balance"] = sum(x["amount"] for x in data.get("records", []))
        save_data(data)
        export_to_csv(data)
        return True, found
    return False, None

def delete_record_in_chat(chat_id, rid):
    store = get_chat_store(chat_id)
    removed = None
    for r in list(store.get("records", [])):
        if r["id"] == rid or str(r["id"]) == str(rid) or r.get("short_id") == f"R{rid}":
            removed = r
            store["records"].remove(r)
            break
    if removed:
        for day_key, recs in list(store.get("daily_records", {}).items()):
            store["daily_records"][day_key] = [x for x in recs if x["id"] != rid]
        store["balance"] = sum(x["amount"] for x in store.get("records", []))
        data["records"] = [x for x in data.get("records", []) if x["id"] != rid]
        data["overall_balance"] = sum(x["amount"] for x in data.get("records", []))
        save_data(data)
        export_to_csv(data)
        return True, removed
    return False, None

def export_to_csv(d):
    try:
        with open(CSV_FILE, "w", newline='', encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
            for cid, cdata in d.get("chats", {}).items():
                for day_key, records in cdata.get("daily_records", {}).items():
                    for r in records:
                        writer.writerow([cid, r.get("id"), r.get("short_id"), r.get("timestamp"), r.get("amount"), r.get("note"), r.get("owner"), day_key])
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ CSV: {e}")

# -----------------------------
# –û–¢–°–ï–ö 6 ‚Äî –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
# -----------------------------
def build_main_keyboard(chat_id=None, confirm_reset=False):
    kb = types.InlineKeyboardMarkup(row_width=3)
    kb.row(
        types.InlineKeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å", callback_data="btn_balance"),
        types.InlineKeyboardButton("üìä –û—Ç—á—ë—Ç", callback_data="btn_report"),
        types.InlineKeyboardButton("üìÇ CSV", callback_data="btn_csv")
    )
    if confirm_reset:
        kb.row(
            types.InlineKeyboardButton("‚úÖ –î–∞", callback_data="confirm_reset"),
            types.InlineKeyboardButton("‚ùå –ù–µ—Ç", callback_data="cancel_reset")
        )
    else:
        kb.row(types.InlineKeyboardButton("‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ", callback_data="btn_reset"))
    kb.row(
        types.InlineKeyboardButton("üöÄ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="btn_start"),
        types.InlineKeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ", callback_data="btn_cod")
    )
    balance_text = ""
    if chat_id is not None:
        store = get_chat_store(chat_id)
        balance_text = f"üí∞ {store.get('balance', 0)} ARS"
    kb.add(types.InlineKeyboardButton(balance_text or "üí∞ 0 ARS", callback_data="noop"))
    return kb

def build_edit_keyboard():
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("‚úè –ò–∑–º–µ–Ω–∏—Ç—å", callback_data="edit_change"),
        types.InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å", callback_data="edit_delete")
    )
    kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="edit_back"))
    return kb

# -----------------------------
# –û–¢–°–ï–ö 7 ‚Äî –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞
# -----------------------------
def update_or_send_today_window(chat_id, create_if_missing=True):
    today_key = get_today_key()
    store = get_chat_store(chat_id)
    day_records = store.get("daily_records", {}).get(today_key, [])

    daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
    daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
    overall_balance = store.get("balance", 0)

    if not day_records:
        text = (
            f"üìÖ {today_key}\n"
            f"–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π.\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥: {daily_income} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {abs(daily_expense)} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {overall_balance} ARS"
        )
    else:
        lines = [f"üìÖ {today_key}", "üìã –û–ø–µ—Ä–∞—Ü–∏–∏:"]
        for r in day_records[-50:]:
            sign = "+" if r["amount"] > 0 else "-"
            lines.append(f"{r['short_id']}: {sign}{abs(r['amount'])} ‚Äî {r.get('note','')}")
        lines.append(
            f"\nüíµ –ü—Ä–∏—Ö–æ–¥: {daily_income} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {abs(daily_expense)} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {overall_balance} ARS"
        )
        text = "\n".join(lines)

    kb = build_main_keyboard(chat_id)
    today_msgs = data.setdefault("active_messages", {}).setdefault(today_key, {})
    active_id = today_msgs.get(str(chat_id))

    # –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–µ –æ–∫–Ω–æ –µ—Å—Ç—å ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –µ–≥–æ
    if active_id:
        try:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            return
        except telebot.apihelper.ApiException as e:
            # –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –ø–æ–ø—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ
            log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–∫–Ω–æ {active_id} –¥–ª—è —á–∞—Ç–∞ {chat_id}: {e}")

    # –ï—Å–ª–∏ create_if_missing=False ‚Äî –Ω–µ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ
    if not create_if_missing:
        return

    # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ, –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –Ω–µ—Ç –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å
    try:
        sent = bot.send_message(chat_id, text, reply_markup=kb)
        today_msgs[str(chat_id)] = sent.message_id
        save_data(data)
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è {chat_id}: {e}")

# -----------------------------
# –û–¢–°–ï–ö 8 ‚Äî Callback –∫–Ω–æ–ø–æ–∫
# -----------------------------
@bot.callback_query_handler(func=lambda c: True)
def handle_callback(call):
    chat_id = call.message.chat.id
    store = get_chat_store(chat_id)
    today_key = get_today_key()
    day_records = store.get("daily_records", {}).get(today_key, [])
    today_msgs = data.setdefault("active_messages", {}).setdefault(today_key, {})
    active_id = today_msgs.get(str(chat_id))

    # 8.1 ‚Äî –ö–Ω–æ–ø–∫–∞ "–ë–∞–ª–∞–Ω—Å"
    if call.data == "btn_balance":
        send_balance(chat_id)
        bot.answer_callback_query(call.id, "–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—ë–Ω ‚úÖ")
        return

    # 8.2 ‚Äî –ö–Ω–æ–ø–∫–∞ "–û—Ç—á—ë—Ç"
    if call.data == "btn_report":
        send_report(chat_id)
        bot.answer_callback_query(call.id, "–û—Ç—á—ë—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –æ–±–Ω–æ–≤–ª—ë–Ω üìä")
        return

    # 8.3 ‚Äî –ö–Ω–æ–ø–∫–∞ "CSV"
    if call.data == "btn_csv":
        send_csv(chat_id)
        bot.answer_callback_query(call.id, "CSV –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω üìÅ")
        return

    # 8.4 ‚Äî –ö–Ω–æ–ø–∫–∞ "–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö"
    if call.data == "btn_reset":
        reset_data(chat_id)
        bot.answer_callback_query(call.id, "–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã üßπ")
        return

    # 8.5 ‚Äî –ö–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å"
    if call.data == "btn_start":
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, "–û–∫–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ üîÑ")
        return

    # 8.6 ‚Äî –ö–Ω–æ–ø–∫–∞ "–ò–Ω—Ñ–æ"
    if call.data == "btn_cod":
        send_info(chat_id)
        bot.answer_callback_query(call.id, "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è üìÑ")
        return

    # 8.7 ‚Äî –ö–Ω–æ–ø–∫–∞ "No operation" ‚Äî –ø—É—Å—Ç—ã—à–∫–∞
    if call.data == "noop":
        bot.answer_callback_query(call.id)
        return

# -----------------------------
# –û–¢–°–ï–ö 9 ‚Äî –°–ª—ç—à-–∫–æ–º–∞–Ω–¥—ã (–∫–æ–º–∞–Ω–¥—ã /...)
# -----------------------------
@bot.message_handler(commands=["start"])
def cmd_start(msg):
    chat_id = msg.chat.id
    # –°–æ–∑–¥–∞—ë–º –æ–∫–Ω–æ, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
    today_msgs = data.setdefault("active_messages", {}).setdefault(get_today_key(), {})
    if str(chat_id) in today_msgs:
        # –û–±–Ω–æ–≤–∏–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –æ–∫–Ω–æ
        update_or_send_today_window(chat_id, create_if_missing=False)
    else:
        update_or_send_today_window(chat_id, create_if_missing=True)
    bot.send_message(chat_id, f"‚úÖ –û–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–æ/–æ–±–Ω–æ–≤–ª–µ–Ω–æ ‚Äî –≤–µ—Ä—Å–∏—è {VERSION}")

@bot.message_handler(commands=["balance"])
def cmd_balance(msg):
    send_balance(msg.chat.id)

@bot.message_handler(commands=["report"])
def cmd_report(msg):
    send_report(msg.chat.id)

@bot.message_handler(commands=["csv"])
def cmd_csv(msg):
    send_csv(msg.chat.id)

@bot.message_handler(commands=["reset"])
def cmd_reset(msg):
    reset_data(msg.chat.id)

@bot.message_handler(commands=["update"])
def cmd_update(msg):
    update_or_send_today_window(msg.chat.id)

@bot.message_handler(commands=["info"])
def cmd_info(msg):
    send_info(msg.chat.id)

# -----------------------------
# –û–¢–°–ï–ö 10 ‚Äî –£—Ç–∏–ª–∏—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–Ω–æ–ø–∫–∞–º–∏ –∏ –∫–æ–º–∞–Ω–¥–∞–º–∏)
# -----------------------------
def send_balance(chat_id):
    store = get_chat_store(chat_id)
    today_key = get_today_key()
    day_records = store.get("daily_records", {}).get(today_key, [])
    daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
    daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
    overall_balance = store.get("balance", 0)

    text = (
        f"üìÖ {today_key}\n\n"
        f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {overall_balance} ARS\n"
        f"üíµ –ü—Ä–∏—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è: {daily_income} ARS\n"
        f"üí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è: {abs(daily_expense)} ARS"
    )

    active_id = get_today_active_window(chat_id)
    if active_id:
        try:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
            return
        except telebot.apihelper.ApiException as e:
            log_error(f"send_balance: –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å {active_id}: {e}")
    # –µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ (–∏ –∑–∞–ø–æ–º–∏–Ω–∞–µ–º)
    sent = bot.send_message(chat_id, text, reply_markup=build_main_keyboard(chat_id))
    set_today_active_window(chat_id, sent.message_id)

def send_report(chat_id):
    store = get_chat_store(chat_id)
    today_key = get_today_key()
    day_records = store.get("daily_records", {}).get(today_key, [])
    expenses = [r for r in day_records if r["amount"] < 0]
    total = sum(abs(r["amount"]) for r in expenses)

    if not expenses:
        text = f"üìÖ {today_key}\n–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è.\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: 0 ARS"
    else:
        lines = [f"üìÖ {today_key}", "üìã –†–∞—Å—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å:"]
        for r in expenses[-30:]:
            lines.append(f"{r['short_id']}: -{abs(r['amount'])} ‚Äî {r.get('note','')}")
        lines.append(f"\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {total} ARS")
        text = "\n".join(lines)

    active_id = get_today_active_window(chat_id)
    if active_id:
        try:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
            return
        except telebot.apihelper.ApiException as e:
            log_error(f"send_report: –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å {active_id}: {e}")
    sent = bot.send_message(chat_id, text, reply_markup=build_main_keyboard(chat_id))
    set_today_active_window(chat_id, sent.message_id)

def send_csv(chat_id):
    try:
        with open(CSV_FILE, "rb") as f:
            bot.send_document(chat_id, f, caption="üìÇ –í–∞—à —Ñ–∞–π–ª data.csv")
    except Exception as e:
        bot.send_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ CSV: {e}")

def reset_data(chat_id):
    store = get_chat_store(chat_id)
    store["records"] = []
    store["daily_records"] = {}
    store["balance"] = 0
    data["records"] = []
    data["overall_balance"] = 0
    save_data(data)
    update_or_send_today_window(chat_id)

def send_info(chat_id):
    info_text = (
        f"‚ÑπÔ∏è –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è {VERSION}\n\n"
        "üìå –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/start - –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞ –æ—Ç—á—ë—Ç–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è\n"
        "/balance - –ü–æ–∫–∞–∑–∞—Ç—å –æ–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –∑–∞ –¥–µ–Ω—å\n"
        "/report - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è\n"
        "/csv - –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª —Å –∏—Å—Ç–æ—Ä–∏–µ–π –æ–ø–µ—Ä–∞—Ü–∏–π\n"
        "/reset - –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏\n"
        "/update - –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –æ–∫–Ω–æ\n"
        "/info - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ –æ–∫–Ω–æ —Å–æ —Å–ø–∏—Å–∫–æ–º –∫–æ–º–∞–Ω–¥\n\n"
        "üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π ‚Äî –ø—Ä–∏–º–µ—Ä—ã:\n"
        "+500 –ó–∞—Ä–ø–ª–∞—Ç–∞\n"
        "-150 –û–±–µ–¥\n"
        "200 –¢–∞–∫—Å–∏  (–±–µ–∑ –∑–Ω–∞–∫–∞ = —Ä–∞—Å—Ö–æ–¥)\n\n"
        "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏: –Ω–∞–∂–º–∏—Ç–µ '‚úè –ò–∑–º–µ–Ω–∏—Ç—å' –≤ –æ–∫–Ω–µ –∏ —Å–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º\n"
        "üóë –£–¥–∞–ª–µ–Ω–∏–µ: –Ω–∞–∂–º–∏—Ç–µ 'üóë –£–¥–∞–ª–∏—Ç—å' –∏ —É–∫–∞–∂–∏—Ç–µ ID"
    )
    bot.send_message(chat_id, info_text)

# -----------------------------
# –û–¢–°–ï–ö 11 ‚Äî –í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ)
# -----------------------------
num_re = re.compile(r'([+-]?\s*\d+)')

@bot.message_handler(func=lambda m: True)
def handle_message(msg):
    # –∑–∞—â–∏—â–∞–µ–º –æ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –±–µ–∑ —Ç–µ–∫—Å—Ç–∞
    if not msg.text:
        return

    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    wait_action = store.get("edit_wait")

    # 11.1 ‚Äî –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    if wait_action is None:
        m = num_re.search(msg.text)
        if m:
            try:
                raw = m.group(1).replace(" ", "")
                if raw.startswith("+"):
                    amount = int(raw[1:])
                elif raw.startswith("-"):
                    amount = -int(raw[1:])
                else:
                    amount = -int(raw)
                note = msg.text.replace(m.group(1), "").strip()
                add_record_to_chat(chat_id, amount, note, msg.from_user.id)
                update_or_send_today_window(chat_id)
            except Exception as e:
                log_error(f"–û—à–∏–±–∫–∞ –∞–≤—Ç–æ-–¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏: {e}")
        return

    # 11.2 ‚Äî –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –≤–≤–æ–¥ ID
    if wait_action == "change_id":
        try:
            rid = int(msg.text.strip())
            store["edit_target"] = rid
            store["edit_wait"] = "change_value"
            bot.send_message(chat_id, f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—É–º–º—É –∏ –∑–∞–º–µ—Ç–∫—É –¥–ª—è –∑–∞–ø–∏—Å–∏ {rid}:")
        except:
            bot.send_message(chat_id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID")
        return

    # 11.3 ‚Äî –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –≤–≤–æ–¥ —Å—É–º–º—ã –∏ –∑–∞–º–µ—Ç–∫–∏
    if wait_action == "change_value":
        rid = store.get("edit_target")
        if not rid:
            store["edit_wait"] = None
            return
        parts = msg.text.strip().split(" ", 1)
        try:
            amount = int(parts[0])
            note = parts[1] if len(parts) > 1 else ""
            success, _ = update_record_in_chat(chat_id, rid, amount, note)
            store["edit_wait"] = None
            store["edit_target"] = None
            update_or_send_today_window(chat_id)
            msg_text = f"‚úÖ –ó–∞–ø–∏—Å—å {rid} –∏–∑–º–µ–Ω–µ–Ω–∞" if success else f"‚ùå –ó–∞–ø–∏—Å—å {rid} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            bot.send_message(chat_id, msg_text)
        except:
            bot.send_message(chat_id, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ —Å—É–º–º—ã")
        return

    # 11.4 ‚Äî –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
    if wait_action == "delete_id":
        try:
            rid = int(msg.text.strip())
            success, _ = delete_record_in_chat(chat_id, rid)
            store["edit_wait"] = None
            update_or_send_today_window(chat_id)
            msg_text = f"‚úÖ –ó–∞–ø–∏—Å—å {rid} —É–¥–∞–ª–µ–Ω–∞" if success else f"‚ùå –ó–∞–ø–∏—Å—å {rid} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            bot.send_message(chat_id, msg_text)
        except:
            bot.send_message(chat_id, "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏")
        return

# -----------------------------
# –û–¢–°–ï–ö 12 ‚Äî Webhook / Flask routes
# -----------------------------
@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    update = telebot.types.Update.de_json(request.get_data().decode("utf-8"))
    bot.process_new_updates([update])
    return "OK", 200

@app.route("/", methods=["GET"])
def index():
    return f"–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ¬´–§–û¬ª ‚Äî –≤–µ—Ä—Å–∏—è {VERSION} —Ä–∞–±–æ—Ç–∞–µ—Ç", 200

# -----------------------------
# –û–¢–°–ï–ö 13 ‚Äî Webhook —É—Å—Ç–∞–Ω–æ–≤–∫–∞, –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–Ω—è –∏ –∑–∞–ø—É—Å–∫
# -----------------------------
def set_webhook():
    url = f"{APP_URL}/{TOKEN}"
    try:
        bot.remove_webhook()
        time.sleep(0.5)
        bot.set_webhook(url=url)
        log_info(f"Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {url}")
    except Exception as e:
        log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook: {e}")

def schedule_daily_window_creation():
    def task():
        last_day = get_today_key()
        while True:
            try:
                time.sleep(60)
                current_day = get_today_key()
                if current_day != last_day:
                    for chat_id_str in list(data.get("chats", {}).keys()):
                        try:
                            chat_id = int(chat_id_str)
                        except:
                            continue
                        try:
                            update_or_send_today_window(chat_id)
                        except Exception as e:
                            log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–∫–Ω–∞ –Ω–æ–≤–æ–≥–æ –¥–Ω—è –¥–ª—è {chat_id}: {e}")
                    last_day = current_day
            except Exception as e:
                log_error(f"–û—à–∏–±–∫–∞ –≤ daily loop: {e}")
                time.sleep(5)
    thread = threading.Thread(target=task, daemon=True)
    thread.start()

if __name__ == "__main__":
    # –£—Å—Ç–∞–Ω–æ–≤–∏–º webhook –∏ –∑–∞–ø—É—Å—Ç–∏–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
    set_webhook()
    schedule_daily_window_creation()
    log_info(f"–ë–æ—Ç –§–û –≤–µ—Ä—Å–∏–∏ {VERSION} –∑–∞–ø—É—â–µ–Ω")

    # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–ª–∞–¥–µ–ª—å—Ü—É
    try:
        if OWNER_ID:
            bot.send_message(int(OWNER_ID), f"‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! (–≤–µ—Ä—Å–∏—è {VERSION})")
    except Exception as e:
        log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ: {e}")

    app.run(host="0.0.0.0", port=PORT)











# ============================================
# –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è 9.8.3
# –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –æ–¥–Ω–∏–º –æ–∫–Ω–æ–º –∏ CSV
# ============================================

# -----------------------------
# –û–¢–°–ï–ö 1 ‚Äî –ò–º–ø–æ—Ä—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
# -----------------------------
import os
import json
import csv
import logging
import re
import threading
import time
from datetime import datetime
from zoneinfo import ZoneInfo

import telebot
from flask import Flask, request
from telebot import types

TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")
APP_URL = os.getenv("APP_URL", "https://yourapp.onrender.com")
TZ = ZoneInfo("America/Argentina/Catamarca")
DATA_FILE = "data.json"
CSV_FILE = "data.csv"
LOG_FILE = "log.txt"
PORT = int(os.environ.get("PORT", 5000))
VERSION = "9.8.3"

if not TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# -----------------------------
# –û–¢–°–ï–ö 2 ‚Äî –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# -----------------------------
logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[logging.FileHandler(LOG_FILE, encoding="utf-8"), logging.StreamHandler()]
)

def log_info(msg):
    logging.info(msg)

def log_error(msg):
    logging.error(msg)

log_info(f"–°—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –í–µ—Ä—Å–∏—è {VERSION}")

# -----------------------------
# –û–¢–°–ï–ö 3 ‚Äî –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏ IO
# -----------------------------
def default_data():
    return {
        "overall_balance": 0,
        "records": [],
        "chats": {},
        "active_messages": {},
        "processed_messages": [],
        "forward_targets": [],
        "tracked_messages": {},
        "next_id": 1
    }

def load_data():
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, "r", encoding="utf-8") as f:
                d = json.load(f)
        except:
            d = default_data()
    else:
        d = default_data()
    base = default_data()
    for k, v in base.items():
        if k not in d:
            d[k] = v
    return d

def save_data(d):
    try:
        with open(DATA_FILE, "w", encoding="utf-8") as f:
            json.dump(d, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è data.json: {e}")

data = load_data()

if OWNER_ID:
    try:
        oi = int(OWNER_ID)
        if oi not in data.get("forward_targets", []):
            data["forward_targets"].append(oi)
            save_data(data)
    except Exception:
        pass

# -----------------------------
# –û–¢–°–ï–ö 4 ‚Äî –ß–∞—Ç/–¥–∞—Ç–∞
# -----------------------------
def get_today_key():
    return datetime.now(TZ).strftime("%Y-%m-%d")

def get_chat_store(chat_id):
    cid = str(chat_id)
    if cid not in data["chats"]:
        data["chats"][cid] = {"balance": 0, "records": [], "next_id": 1, "daily_records": {}, "active_windows": {}}
        save_data(data)
    return data["chats"][cid]

def get_today_active_window(chat_id):
    today = get_today_key()
    day_map = data["active_messages"].get(today, {})
    return day_map.get(str(chat_id))

def set_today_active_window(chat_id, message_id):
    today = get_today_key()
    if "active_messages" not in data:
        data["active_messages"] = {}
    if today not in data["active_messages"]:
        data["active_messages"][today] = {}
    data["active_messages"][today][str(chat_id)] = message_id
    save_data(data)
# -----------------------------
# –û–¢–°–ï–ö 5 ‚Äî –†–∞–±–æ—Ç–∞ —Å –∑–∞–ø–∏—Å—è–º–∏
# -----------------------------
def add_record_to_chat(chat_id, amount, note, owner):
    store = get_chat_store(chat_id)
    rid = data.get("next_id", 1)
    rec = {"id": rid, "short_id": f"R{rid}", "timestamp": datetime.now(TZ).isoformat(timespec="seconds"), "amount": amount, "note": note, "owner": owner}
    data.setdefault("records", []).append(rec)
    store.setdefault("records", []).append(rec)
    day = get_today_key()
    store.setdefault("daily_records", {}).setdefault(day, []).append(rec)
    store["balance"] = store.get("balance", 0) + amount
    data["overall_balance"] = data.get("overall_balance", 0) + amount
    data["next_id"] = rid + 1
    save_data(data)
    try: export_to_csv(data)
    except: pass
    return rec

def update_record_in_chat(chat_id, rid, new_amount, new_note):
    store = get_chat_store(chat_id)
    found = None
    for r in store.get("records", []):
        if r["id"] == rid:
            r["amount"] = new_amount
            r["note"] = new_note
            found = r
            break
    if found:
        for day_recs in store.get("daily_records", {}).values():
            for r in day_recs:
                if r["id"] == rid:
                    r.update(found)
        store["balance"] = sum([x["amount"] for x in store.get("records", [])])
        data["overall_balance"] = sum([x["amount"] for x in data.get("records", [])])
        save_data(data)
        export_to_csv(data)
        return True, found
    return False, None

def delete_record_in_chat(chat_id, rid):
    store = get_chat_store(chat_id)
    removed = None
    for r in list(store.get("records", [])):
        if r["id"] == rid or str(r["id"]) == str(rid) or r.get("short_id") == f"R{rid}":
            removed = r
            store["records"].remove(r)
            break
    if removed:
        for day_key, recs in store.get("daily_records", {}).items():
            store["daily_records"][day_key] = [x for x in recs if x["id"] != rid]
        store["balance"] = sum([x["amount"] for x in store.get("records", [])])
        data["records"] = [x for x in data.get("records", []) if x["id"] != rid]
        data["overall_balance"] = sum([x["amount"] for x in data.get("records", [])])
        save_data(data)
        export_to_csv(data)
        return True, removed
    return False, None

def export_to_csv(d):
    try:
        with open(CSV_FILE, "w", newline='', encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
            for cid, cdata in d.get("chats", {}).items():
                for day_key, records in cdata.get("daily_records", {}).items():
                    for r in records:
                        writer.writerow([cid, r.get("id"), r.get("short_id"), r.get("timestamp"), r.get("amount"), r.get("note"), r.get("owner"), day_key])
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ CSV: {e}")

# -----------------------------
# –û–¢–°–ï–ö 6 ‚Äî –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
# -----------------------------
def build_main_keyboard(chat_id=None, confirm_reset=False):
    kb = types.InlineKeyboardMarkup(row_width=3)
    kb.row(
        types.InlineKeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å", callback_data="btn_balance"),
        types.InlineKeyboardButton("üìä –û—Ç—á—ë—Ç", callback_data="btn_report"),
        types.InlineKeyboardButton("üìÇ CSV", callback_data="btn_csv")
    )
    if confirm_reset:
        kb.row(
            types.InlineKeyboardButton("‚úÖ –î–∞", callback_data="confirm_reset"),
            types.InlineKeyboardButton("‚ùå –ù–µ—Ç", callback_data="cancel_reset")
        )
    else:
        kb.row(types.InlineKeyboardButton("‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ", callback_data="btn_reset"))
    kb.row(
        types.InlineKeyboardButton("üöÄ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="btn_start"),
        types.InlineKeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ", callback_data="btn_cod")
    )
    balance_text = ""
    if chat_id is not None:
        store = get_chat_store(chat_id)
        balance_text = f"üí∞ {store.get('balance', 0)} ARS"
    kb.add(types.InlineKeyboardButton(balance_text or "üí∞ 0 ARS", callback_data="noop"))
    return kb

def build_edit_keyboard():
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("‚úè –ò–∑–º–µ–Ω–∏—Ç—å", callback_data="edit_change"),
        types.InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å", callback_data="edit_delete")
    )
    kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="edit_back"))
    return kb

# -----------------------------
# –û–¢–°–ï–ö 7 ‚Äî –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞
# -----------------------------
def update_or_send_today_window(chat_id, create_if_missing=True):
    today_key = get_today_key()
    store = get_chat_store(chat_id)
    day_records = store.get("daily_records", {}).get(today_key, [])

    daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
    daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
    overall_balance = store.get("balance", 0)

    if not day_records:
        text = (
            f"üìÖ {today_key}\n"
            f"–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π.\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥: {daily_income} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {abs(daily_expense)} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {overall_balance} ARS"
        )
    else:
        lines = [f"üìÖ {today_key}", "üìã –û–ø–µ—Ä–∞—Ü–∏–∏:"]
        for r in day_records[-50:]:
            sign = "+" if r["amount"] > 0 else "-"
            lines.append(f"{r['short_id']}: {sign}{abs(r['amount'])} ‚Äî {r.get('note','')}")
        lines.append(
            f"\nüíµ –ü—Ä–∏—Ö–æ–¥: {daily_income} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {abs(daily_expense)} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {overall_balance} ARS"
        )
        text = "\n".join(lines)

    kb = build_main_keyboard(chat_id)
    today_msgs = data.setdefault("active_messages", {}).setdefault(today_key, {})
    active_id = today_msgs.get(str(chat_id))

    # –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–µ –æ–∫–Ω–æ –µ—Å—Ç—å ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –µ–≥–æ
    if active_id:
        try:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
        except telebot.apihelper.ApiException as e:
            log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–∫–Ω–æ {active_id} –¥–ª—è —á–∞—Ç–∞ {chat_id}: {e}")
        return

    # –ï—Å–ª–∏ create_if_missing=False ‚Äî –Ω–µ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ
    if not create_if_missing:
        return

    # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ, –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –Ω–µ—Ç
    try:
        sent = bot.send_message(chat_id, text, reply_markup=kb)
        today_msgs[str(chat_id)] = sent.message_id
        save_data(data)
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è {chat_id}: {e}")

# -----------------------------
# –û–¢–°–ï–ö 8 ‚Äî Callback –∫–Ω–æ–ø–æ–∫
# -----------------------------
@bot.callback_query_handler(func=lambda c: True)
def handle_callback(call):
    chat_id = call.message.chat.id
    store = get_chat_store(chat_id)
    today_key = get_today_key()
    day_records = store.get("daily_records", {}).get(today_key, [])
    today_msgs = data.setdefault("active_messages", {}).setdefault(today_key, {})
    active_id = today_msgs.get(str(chat_id))

    # –ö–Ω–æ–ø–∫–∞ "–ë–∞–ª–∞–Ω—Å"
    if call.data == "btn_balance":
        daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
        daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
        overall_balance = store.get("balance", 0)

        text = (
            f"üìÖ {today_key}\n\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {overall_balance} ARS\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è: {daily_income} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è: {abs(daily_expense)} ARS"
        )

        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–∫–Ω–∞ (–ë–∞–ª–∞–Ω—Å): {e}")
        else:
            update_or_send_today_window(chat_id)

        bot.answer_callback_query(call.id, "–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—ë–Ω ‚úÖ")
        return

    # –ö–Ω–æ–ø–∫–∞ "–û—Ç—á—ë—Ç"
    if call.data == "btn_report":
        expenses = [r for r in day_records if r["amount"] < 0]
        daily_expense_total = sum(abs(r["amount"]) for r in expenses)

        if not expenses:
            text = f"üìÖ {today_key}\n–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è.\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: 0 ARS"
        else:
            lines = [f"üìÖ {today_key}", "üìã –†–∞—Å—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å:"]
            for r in expenses[-30:]:
                lines.append(f"{r['short_id']}: -{abs(r['amount'])} ‚Äî {r.get('note','')}")
            lines.append(f"\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {daily_expense_total} ARS")
            text = "\n".join(lines)

        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–∫–Ω–∞ (–û—Ç—á—ë—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤): {e}")
        else:
            update_or_send_today_window(chat_id)

        bot.answer_callback_query(call.id, "–û—Ç—á—ë—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –æ–±–Ω–æ–≤–ª—ë–Ω üìä")
        return

    # –ö–Ω–æ–ø–∫–∞ "CSV"
    if call.data == "btn_csv":
        try:
            with open(CSV_FILE, "rb") as f:
                bot.send_document(chat_id, f, caption="üìÇ –í–∞—à —Ñ–∞–π–ª data.csv")
            bot.answer_callback_query(call.id, "CSV –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω üìÅ")
        except Exception as e:
            bot.send_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ CSV: {e}")
            bot.answer_callback_query(call.id)
        return

        # –ö–Ω–æ–ø–∫–∞ "–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö"
    if call.data == "btn_reset":
        store["records"] = []
        store["daily_records"] = {}
        store["balance"] = 0
        data["records"] = []
        data["overall_balance"] = 0
        save_data(data)
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, "–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã üßπ")
        return

    # –ö–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å"
    if call.data == "btn_start":
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, "–û–∫–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ üîÑ")
        return

    # –ö–Ω–æ–ø–∫–∞ "–ò–Ω—Ñ–æ" ‚Äî —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
    if call.data == "btn_cod":
        info_text = (
            f"‚ÑπÔ∏è –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è {VERSION}\n\n"
            "üìå –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "/start - –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞ –æ—Ç—á—ë—Ç–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è\n"
            "/balance - –ü–æ–∫–∞–∑–∞—Ç—å –æ–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –∑–∞ –¥–µ–Ω—å\n"
            "/report - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è\n"
            "/csv - –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª —Å –∏—Å—Ç–æ—Ä–∏–µ–π –æ–ø–µ—Ä–∞—Ü–∏–π\n"
            "/reset - –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏\n"
            "/update - –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –æ–∫–Ω–æ\n"
            "/info - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ –æ–∫–Ω–æ —Å–æ —Å–ø–∏—Å–∫–æ–º –∫–æ–º–∞–Ω–¥\n\n"
            "üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π:\n"
            "+500 –ó–∞—Ä–ø–ª–∞—Ç–∞\n"
            "-150 –û–±–µ–¥\n"
            "200 –¢–∞–∫—Å–∏\n\n"
            "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏ \"–ò–∑–º–µ–Ω–∏—Ç—å\" / \"–£–¥–∞–ª–∏—Ç—å\""
        )

        bot.send_message(chat_id, info_text, reply_markup=None)
        bot.answer_callback_query(call.id, "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è üìÑ")
        return

    # –ö–Ω–æ–ø–∫–∞ "No operation" ‚Äî –ø—É—Å—Ç—ã—à–∫–∞
    if call.data == "noop":
        bot.answer_callback_query(call.id)
        return 


# -----------------------------
# –û–¢–°–ï–ö 9 ‚Äî –í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
# -----------------------------
num_re = re.compile(r'([+-]?\s*\d+)')

@bot.message_handler(func=lambda m: True)
def handle_message(msg):
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    wait_action = store.get("edit_wait")

    # –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å
    if wait_action is None:
        m = num_re.search(msg.text)
        if m:
            try:
                raw = m.group(1).replace(" ", "")
                if raw.startswith("+"):
                    amount = int(raw[1:])        # –ü—Ä–∏—Ö–æ–¥
                elif raw.startswith("-"):
                    amount = -int(raw[1:])       # –†–∞—Å—Ö–æ–¥
                else:
                    amount = -int(raw)           # –ë–µ–∑ –∑–Ω–∞–∫–∞ = —Ä–∞—Å—Ö–æ–¥

                note = msg.text.replace(m.group(1), "").strip()
                add_record_to_chat(chat_id, amount, note, msg.from_user.id)
                update_or_send_today_window(chat_id)
            except Exception as e:
                log_error(f"–û—à–∏–±–∫–∞ –∞–≤—Ç–æ-–¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏: {e}")
        return

    # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É–º–º—ã –∏ –∑–∞–º–µ—Ç–∫–∏
    if wait_action == "change_id":
        try:
            rid = int(msg.text.strip())
            store["edit_target"] = rid
            store["edit_wait"] = "change_value"
            bot.send_message(chat_id, f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—É–º–º—É –∏ –∑–∞–º–µ—Ç–∫—É –¥–ª—è –∑–∞–ø–∏—Å–∏ {rid}:")
        except:
            bot.send_message(chat_id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID")
        return

    if wait_action == "change_value":
        rid = store.get("edit_target")
        if not rid:
            store["edit_wait"] = None
            return
        parts = msg.text.strip().split(" ", 1)
        try:
            amount = int(parts[0])
            note = parts[1] if len(parts) > 1 else ""
            success, _ = update_record_in_chat(chat_id, rid, amount, note)
            store["edit_wait"] = None
            store["edit_target"] = None
            update_or_send_today_window(chat_id)
            msg_text = f"‚úÖ –ó–∞–ø–∏—Å—å {rid} –∏–∑–º–µ–Ω–µ–Ω–∞" if success else f"‚ùå –ó–∞–ø–∏—Å—å {rid} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            bot.send_message(chat_id, msg_text)
        except:
            bot.send_message(chat_id, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ —Å—É–º–º—ã")
        return

    # –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
    if wait_action == "delete_id":
        try:
            rid = int(msg.text.strip())
            success, _ = delete_record_in_chat(chat_id, rid)
            store["edit_wait"] = None
            update_or_send_today_window(chat_id)
            msg_text = f"‚úÖ –ó–∞–ø–∏—Å—å {rid} —É–¥–∞–ª–µ–Ω–∞" if success else f"‚ùå –ó–∞–ø–∏—Å—å {rid} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            bot.send_message(chat_id, msg_text)
        except:
            bot.send_message(chat_id, "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏")

# -----------------------------
# –û–¢–°–ï–ö 13 ‚Äî Flask webhook
# -----------------------------
@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    update = telebot.types.Update.de_json(request.get_data().decode("utf-8"))
    bot.process_new_updates([update])
    return "OK", 200

@app.route("/", methods=["GET"])
def index():
    return f"–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ¬´–§–û¬ª ‚Äî –≤–µ—Ä—Å–∏—è {VERSION} —Ä–∞–±–æ—Ç–∞–µ—Ç", 200

# -----------------------------
# –û–¢–°–ï–ö 14 ‚Äî Webhook —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫
# -----------------------------
def set_webhook():
    url = f"{APP_URL}/{TOKEN}"
    try:
        bot.remove_webhook()
        time.sleep(0.5)
        bot.set_webhook(url=url)
        log_info(f"Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {url}")
    except Exception as e:
        log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook: {e}")

# -----------------------------
# –û–¢–°–ï–ö 15 ‚Äî –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Å–º–µ–Ω—ã –¥–Ω—è
# -----------------------------
def schedule_daily_window_creation():
    def task():
        last_day = get_today_key()
        while True:
            try:
                time.sleep(60)
                current_day = get_today_key()
                if current_day != last_day:
                    for chat_id_str in list(data.get("chats", {}).keys()):
                        try:
                            chat_id = int(chat_id_str)
                        except: continue
                        try:
                            update_or_send_today_window(chat_id)
                        except Exception as e:
                            log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–∫–Ω–∞ –Ω–æ–≤–æ–≥–æ –¥–Ω—è –¥–ª—è {chat_id}: {e}")
                    last_day = current_day
            except Exception as e:
                log_error(f"–û—à–∏–±–∫–∞ –≤ daily loop: {e}")
                time.sleep(5)
    thread = threading.Thread(target=task, daemon=True)
    thread.start()

# -----------------------------
# –û–¢–°–ï–ö 16 ‚Äî –ó–∞–ø—É—Å–∫
# -----------------------------
if __name__ == "__main__":
    set_webhook()
    schedule_daily_window_creation()
    log_info(f"–ë–æ—Ç –§–û –≤–µ—Ä—Å–∏–∏ {VERSION} –∑–∞–ø—É—â–µ–Ω")

    # –°–æ–æ–±—â–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É –≤ Telegram
    try:
        if OWNER_ID:
            bot.send_message(int(OWNER_ID), f"‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! (–≤–µ—Ä—Å–∏—è {VERSION})")
    except Exception as e:
        log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ: {e}")

    app.run(host="0.0.0.0", port=PORT)





# ============================================
# –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è 9.6.1.7
# –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è (–≥–∏–±—Ä–∏–¥ 9.6.1.6 + –æ–¥–Ω–æ–æ–∫–Ω–æ–≤—ã–π —Ä–µ–∂–∏–º)
# –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –∫–æ–º–∞–Ω–¥—ã –ª–∞—Ç–∏–Ω–∏—Ü–µ–π
# ============================================

# -----------------------------
# –û–¢–°–ï–ö 1 ‚Äî –ò–º–ø–æ—Ä—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
# -----------------------------
import os
import json
import csv
import logging
import re
import threading
import time
from datetime import datetime
from zoneinfo import ZoneInfo

import telebot
from flask import Flask, request
from telebot import types

# --------------------------------------------
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
# --------------------------------------------
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")  # —Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ —á–∏—Å–ª–æ
APP_URL = os.getenv("APP_URL", "https://fo-1.onrender.com")  # Render URL
TZ = ZoneInfo("America/Argentina/Catamarca")
DATA_FILE = "data.json"
CSV_FILE = "data.csv"
LOG_FILE = "log.txt"
PORT = int(os.environ.get("PORT", 5000))
VERSION = "9.6.1.7"

if not TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# -----------------------------
# –û–¢–°–ï–ö 2 ‚Äî –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# -----------------------------
logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[
        logging.FileHandler(LOG_FILE, encoding="utf-8"),
        logging.StreamHandler()
    ]
)

def log_info(msg):
    logging.info(msg)

def log_error(msg):
    logging.error(msg)

log_info(f"–°—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –í–µ—Ä—Å–∏—è {VERSION}")

# -----------------------------
# –û–¢–°–ï–ö 3 ‚Äî –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏ IO
# -----------------------------
def default_data():
    return {
        "overall_balance": 0,
        "records": [],           # –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
        "chats": {},             # chat_id -> { balance, records, next_id, daily_records, active_windows }
        "active_messages": {},   # YYYY-MM-DD -> { chat_id_str -> message_id }
        "processed_messages": [],# list of "chat:msgid" - –¥–ª—è –¥–µ–¥—É–ø–∞
        "forward_targets": [],   # list of chat ids
        "tracked_messages": {},  # –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ç.–¥.
        "next_id": 1
    }

def load_data():
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, "r", encoding="utf-8") as f:
                d = json.load(f)
        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ data.json: {e}")
            d = default_data()
    else:
        d = default_data()
    # ensure keys
    base = default_data()
    for k, v in base.items():
        if k not in d:
            d[k] = v
    return d

def save_data(d):
    try:
        with open(DATA_FILE, "w", encoding="utf-8") as f:
            json.dump(d, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è data.json: {e}")

data = load_data()

# –¥–æ–±–∞–≤–ª—è–µ–º OWNER_ID –≤ forward targets, –µ—Å–ª–∏ –∑–∞–¥–∞–Ω
if OWNER_ID:
    try:
        oi = int(OWNER_ID)
        if oi not in data.get("forward_targets", []):
            data["forward_targets"].append(oi)
            save_data(data)
    except Exception:
        pass

# -----------------------------
# –û–¢–°–ï–ö 4 ‚Äî –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ —á–∞—Ç—É/–¥–∞—Ç–µ
# -----------------------------
def get_today_key():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç YYYY-MM-DD –ø–æ TZ"""
    return datetime.now(TZ).strftime("%Y-%m-%d")

def get_chat_store(chat_id):
    cid = str(chat_id)
    if cid not in data["chats"]:
        data["chats"][cid] = {
            "balance": 0,
            "records": [],         # –≤—Å–µ –∑–∞–ø–∏—Å–∏ —á–∞—Ç–∞ (–ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏)
            "next_id": 1,
            "daily_records": {},   # YYYY-MM-DD -> [records]
            "active_windows": {}   # YYYY-MM-DD -> message_id   (backwards-compatible)
        }
        save_data(data)
    return data["chats"][cid]

def get_today_active_window(chat_id):
    """–ß–∏—Ç–∞–µ—Ç –∏–∑ data['active_messages'][today_key][chat_id_str] ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ"""
    today = get_today_key()
    if "active_messages" not in data:
        data["active_messages"] = {}
    day_map = data["active_messages"].get(today, {})
    return day_map.get(str(chat_id))

def set_today_active_window(chat_id, message_id):
    today = get_today_key()
    if "active_messages" not in data:
        data["active_messages"] = {}
    if today not in data["active_messages"]:
        data["active_messages"][today] = {}
    data["active_messages"][today][str(chat_id)] = message_id
    save_data(data)

# -----------------------------
# –û–¢–°–ï–ö 5 ‚Äî –†–∞–±–æ—Ç–∞ —Å –∑–∞–ø–∏—Å—è–º–∏ (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å—Ç–∞—Ä–æ–≥–æ –±–æ—Ç–∞)
# -----------------------------
def add_record_to_chat(chat_id, amount, note, owner):
    """–î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∏ –¥–Ω–µ–≤–Ω—ã–µ —Å–ø–∏—Å–∫–∏ ‚Äî —Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å–æ —Å—Ç–∞—Ä–æ–π —Å—Ö–µ–º–æ–π."""
    store = get_chat_store(chat_id)
    rid = data.get("next_id", 1)
    rec = {
        "id": rid,
        "short_id": f"R{rid}",
        "timestamp": datetime.now(TZ).isoformat(timespec="seconds"),
        "amount": amount,
        "note": note,
        "owner": owner
    }
    # –≥–ª–æ–±–∞–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å (–µ—Å–ª–∏ —É —Ç–µ–±—è –±—ã–ª–∞ –¥—Ä—É–≥–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–∞–∫ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    data.setdefault("records", []).append(rec)
    # —á–∞—Ç-—É—Ä–æ–≤–µ–Ω—å
    store.setdefault("records", []).append(rec)
    # –¥–Ω–µ–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏
    day = get_today_key()
    store.setdefault("daily_records", {}).setdefault(day, []).append(rec)
    # –±–∞–ª–∞–Ω—Å
    store["balance"] = store.get("balance", 0) + amount
    data["overall_balance"] = data.get("overall_balance", 0) + amount
    data["next_id"] = rid + 1
    save_data(data)
    try:
        export_to_csv(data)
    except Exception:
        pass
    return rec

def update_record_in_chat(chat_id, rid, new_amount, new_note):
    store = get_chat_store(chat_id)
    found = None
    for r in store.get("records", []):
        if r["id"] == rid:
            diff = new_amount - r["amount"]
            r["amount"] = new_amount
            r["note"] = new_note
            found = r
            break
    if found:
        # update daily records
        for day_recs in store.get("daily_records", {}).values():
            for r in day_recs:
                if r["id"] == rid:
                    r.update(found)
        store["balance"] = sum([x["amount"] for x in store.get("records", [])])
        data["overall_balance"] = sum([x["amount"] for x in data.get("records", [])])
        save_data(data)
        export_to_csv(data)
        return True, found
    return False, None

def delete_record_in_chat(chat_id, rid):
    store = get_chat_store(chat_id)
    removed = None
    for r in list(store.get("records", [])):
        if r["id"] == rid or str(r["id"]) == str(rid) or r.get("short_id") == f"R{rid}":
            removed = r
            store["records"].remove(r)
            break
    if removed:
        # remove from daily records
        for day_key, recs in store.get("daily_records", {}).items():
            store["daily_records"][day_key] = [x for x in recs if x["id"] != rid]
        store["balance"] = sum([x["amount"] for x in store.get("records", [])])
        # also remove from global
        data["records"] = [x for x in data.get("records", []) if x["id"] != rid]
        data["overall_balance"] = sum([x["amount"] for x in data.get("records", [])])
        save_data(data)
        export_to_csv(data)
        return True, removed
    return False, None

def get_daily_records(chat_id, day_key=None):
    store = get_chat_store(chat_id)
    if not day_key:
        day_key = get_today_key()
    return store.get("daily_records", {}).get(day_key, [])

def export_to_csv(d):
    try:
        with open(CSV_FILE, "w", newline='', encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
            for cid, cdata in d.get("chats", {}).items():
                for day_key, records in cdata.get("daily_records", {}).items():
                    for r in records:
                        writer.writerow([cid, r.get("id"), r.get("short_id"), r.get("timestamp"),
                                         r.get("amount"), r.get("note"), r.get("owner"), day_key])
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ CSV: {e}")

# -----------------------------
# –û–¢–°–ï–ö 6 ‚Äî –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—Å–ø–æ–º. (–ø–∞—Ä—Å–∏–Ω–≥ —á–∏—Å–µ–ª)
# -----------------------------
num_re = re.compile(r'([+-]?\s*\d+)')

def extract_first_number(s):
    if not s:
        return None, None
    m = num_re.search(s)
    if not m:
        return None, None
    token = m.group(1)
    token_clean = token.replace(" ", "")
    try:
        amt = int(token_clean)
    except:
        return None, None
    return amt, token.strip()

# -----------------------------
# –û–¢–°–ï–ö 7 ‚Äî –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏ –∫–Ω–æ–ø–∫–∏ (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∏–¥ —Å—Ç–∞—Ä–æ–≥–æ –±–æ—Ç–∞)
# -----------------------------
def build_main_keyboard(chat_id=None):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.add(
        types.InlineKeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å", callback_data="btn_balance"),
        types.InlineKeyboardButton("üìä –û—Ç—á—ë—Ç", callback_data="btn_report"),
    )
    kb.add(
        types.InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data="btn_edit"),
        types.InlineKeyboardButton("‚öôÔ∏è –°–±—Ä–æ—Å", callback_data="btn_reset"),
    )
    kb.add(
        types.InlineKeyboardButton("üöÄ –°—Ç–∞—Ä—Ç", callback_data="btn_start"),
        types.InlineKeyboardButton("üìò –û –∫–æ–¥–µ", callback_data="btn_cod"),
    )
    balance_text = ""
    if chat_id is not None:
        store = get_chat_store(chat_id)
        balance_text = f"üí∞ {store.get('balance', 0)} ARS"
    kb.add(types.InlineKeyboardButton(balance_text or "üí∞ 0 ARS", callback_data="noop"))
    return kb

def build_edit_list_keyboard(chat_id):
    store = get_chat_store(chat_id)
    kb = types.InlineKeyboardMarkup()
    records = store.get("records", [])[-20:]
    if not records:
        kb.add(types.InlineKeyboardButton("–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π", callback_data="noop"))
        kb.add(types.InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="btn_start"))
        return kb
    for r in records:
        sign = "+" if r["amount"] > 0 else ""
        label = f"{r['short_id']}: {sign}{r['amount']} ARS {r.get('note','')}"
        kb.row(
            types.InlineKeyboardButton(label, callback_data=f"noop_row:{r['id']}"),
            types.InlineKeyboardButton("‚úè", callback_data=f"edit_select:{r['id']}"),
            types.InlineKeyboardButton("üóë", callback_data=f"delete_record:{r['id']}")
        )
    kb.add(types.InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="btn_start"))
    return kb

# -----------------------------
# –û–¢–°–ï–ö 8 ‚Äî –ö–æ–º–∞–Ω–¥—ã (start, help, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ—Å—ã–ª–∫–æ–π)
# -----------------------------
@bot.message_handler(commands=["start"])
def cmd_start(msg):
    text = (
        "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ¬´–§–û¬ª\n\n"
        "üìã –ö–æ–º–∞–Ω–¥—ã:\n"
        "/start ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ\n"
        "/myid ‚Äî –≤–∞—à user ID\n"
        "/chatid ‚Äî ID —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞\n"
        "/balance ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –±–∞–ª–∞–Ω—Å —á–∞—Ç–∞\n"
        "/report ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è\n"
        "/reset ‚Äî –æ–±–Ω—É–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (–≤–ª–∞–¥–µ–ª–µ—Ü)\n\n"
        "üì§ –ü–µ—Ä–µ—Å—ã–ª–∫–∞:\n"
        "/addforward <chat_id> ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å –ø–µ—Ä–µ—Å—ã–ª–∫–∏\n"
        "/removeforward <chat_id> ‚Äî —É–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å –ø–µ—Ä–µ—Å—ã–ª–∫–∏\n        /listforwards ‚Äî —Å–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π\n\n"
        "üí° –î–ª—è –∑–∞–ø–∏—Å–∏: –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É —Å —Å—É–º–º–æ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä:\n"
        "+1000 –∑–∞—Ä–ø–ª–∞—Ç–∞\n"
        "-200 —Ö–ª–µ–±\n\n"
        "üìå –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –æ–¥–Ω–æ–º –∞–∫—Ç–∏–≤–Ω–æ–º –æ–∫–Ω–µ (—Å–æ–æ–±—â–µ–Ω–∏–∏) —ç—Ç–æ–≥–æ —á–∞—Ç–∞."
    )
    bot.send_message(msg.chat.id, f"üí¨ –í–µ—Ä—Å–∏—è: {VERSION}\n\n" + text, reply_markup=build_main_keyboard(msg.chat.id))

@bot.message_handler(commands=["myid"])
def cmd_myid(msg):
    bot.reply_to(msg, f"üÜî –í–∞—à user ID: {msg.from_user.id}")

@bot.message_handler(commands=["chatid"])
def cmd_chatid(msg):
    bot.reply_to(msg, f"üí¨ ID —á–∞—Ç–∞: {msg.chat.id}")

@bot.message_handler(commands=["balance"])
def cmd_balance(msg):
    store = get_chat_store(msg.chat.id)
    bot.reply_to(msg, f"üí∞ –ë–∞–ª–∞–Ω—Å —ç—Ç–æ–≥–æ —á–∞—Ç–∞: {store.get('balance', 0)} ARS", reply_markup=build_main_keyboard(msg.chat.id))

@bot.message_handler(commands=["report"])
def cmd_report(msg):
    recs = get_daily_records(msg.chat.id)
    if not recs:
        bot.send_message(msg.chat.id, "–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è.", reply_markup=build_main_keyboard(msg.chat.id))
        return
    lines = ["üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–µ–≥–æ–¥–Ω—è:"]
    for r in recs[-50:]:
        sign = "+" if r["amount"] > 0 else ""
        lines.append(f"{r['short_id']}: {sign}{r['amount']} ‚Äî {r.get('note','')}")
    bot.send_message(msg.chat.id, "\n".join(lines), reply_markup=build_main_keyboard(msg.chat.id))

@bot.message_handler(commands=["reset"])
def cmd_reset(msg):
    if OWNER_ID is None or str(msg.from_user.id) != str(OWNER_ID):
        bot.send_message(msg.chat.id, "–¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.", reply_markup=build_main_keyboard(msg.chat.id))
        return
    global data
    data = default_data()
    # re-add owner to forward targets
    try:
        if OWNER_ID:
            data["forward_targets"].append(int(OWNER_ID))
    except Exception:
        pass
    save_data(data)
    export_to_csv(data)
    bot.send_message(msg.chat.id, "‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã.", reply_markup=build_main_keyboard(msg.chat.id))
    log_info("–î–ê–ù–ù–´–ï –û–ë–ù–£–õ–ï–ù–´ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º")

# Forward commands (owner only)
@bot.message_handler(commands=["addforward"])
def cmd_addforward(msg):
    if OWNER_ID is None or str(msg.from_user.id) != str(OWNER_ID):
        return
    parts = msg.text.split()
    if len(parts) < 2:
        bot.reply_to(msg, "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /addforward <chat_id>")
        return
    try:
        cid = int(parts[1])
    except:
        bot.reply_to(msg, "–ù–µ–≤–µ—Ä–Ω—ã–π chat_id (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ).")
        return
    if cid in data["forward_targets"]:
        bot.reply_to(msg, "–≠—Ç–æ—Ç —á–∞—Ç —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ –ø–µ—Ä–µ—Å—ã–ª–∫–∏.")
        return
    data["forward_targets"].append(cid)
    save_data(data)
    bot.reply_to(msg, f"‚úÖ –¶–µ–ª—å –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞: {cid}")

@bot.message_handler(commands=["removeforward"])
def cmd_removeforward(msg):
    if OWNER_ID is None or str(msg.from_user.id) != str(OWNER_ID):
        return
    parts = msg.text.split()
    if len(parts) < 2:
        bot.reply_to(msg, "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /removeforward <chat_id>")
        return
    try:
        cid = int(parts[1])
    except:
        bot.reply_to(msg, "–ù–µ–≤–µ—Ä–Ω—ã–π chat_id (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ).")
        return
    if cid not in data["forward_targets"]:
        bot.reply_to(msg, "–≠—Ç–æ—Ç —á–∞—Ç –Ω–µ –≤ —Å–ø–∏—Å–∫–µ –ø–µ—Ä–µ—Å—ã–ª–∫–∏.")
        return
    data["forward_targets"].remove(cid)
    save_data(data)
    bot.reply_to(msg, f"‚úÖ –¶–µ–ª—å –ø–µ—Ä–µ—Å—ã–ª–∫–∏ —É–¥–∞–ª–µ–Ω–∞: {cid}")

@bot.message_handler(commands=["listforwards"])
def cmd_listforwards(msg):
    if not data["forward_targets"]:
        bot.reply_to(msg, "–°–ø–∏—Å–æ–∫ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –ø—É—Å—Ç.", reply_markup=build_main_keyboard(msg.chat.id))
        return
    text = "üì® –¶–µ–ª–∏ –ø–µ—Ä–µ—Å—ã–ª–∫–∏:\n" + "\n".join(map(str, data["forward_targets"]))
    bot.reply_to(msg, text, reply_markup=build_main_keyboard(msg.chat.id))

# -----------------------------
# –û–¢–°–ï–ö 9 ‚Äî –û–±—Ä–∞–±–æ—Ç–∫–∞ inline callback'–æ–≤
# -----------------------------
@bot.callback_query_handler(func=lambda c: True)
def handle_callback(call):
    try:
        data_cd = call.data
        cid = call.message.chat.id
        mid = call.message.message_id

        # –ë–∞–ª–∞–Ω—Å
        if data_cd == "btn_balance":
            store = get_chat_store(cid)
            text = f"üí∞ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å —ç—Ç–æ–≥–æ —á–∞—Ç–∞: {store.get('balance', 0)} ARS"
            # —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ –æ–∫–Ω–æ (–µ—Å–ª–∏ –µ—Å—Ç—å), –∏–Ω–∞—á–µ –æ–±—ã—á–Ω—ã–π –æ—Ç–≤–µ—Ç
            active_id = get_today_active_window(cid)
            if active_id:
                try:
                    bot.edit_message_text(text, cid, active_id, reply_markup=build_main_keyboard(cid))
                except:
                    bot.edit_message_text(text, cid, mid, reply_markup=build_main_keyboard(cid))
            else:
                bot.edit_message_text(text, cid, mid, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        # –û—Ç—á—ë—Ç
        elif data_cd == "btn_report":
            recs = get_daily_records(cid)
            if not recs:
                text = "üìã –ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π."
            else:
                lines = ["üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:"]
                for r in recs[-20:]:
                    sign = "+" if r["amount"] > 0 else ""
                    lines.append(f"{r['short_id']}: {sign}{r['amount']} ARS ‚Äî {r.get('note','')}")
                text = "\n".join(lines)
            active_id = get_today_active_window(cid)
            if active_id:
                try:
                    bot.edit_message_text(text, cid, active_id, reply_markup=build_main_keyboard(cid))
                except:
                    bot.send_message(cid, text, reply_markup=build_main_keyboard(cid))
            else:
                bot.send_message(cid, text, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        # –°–±—Ä–æ—Å
        elif data_cd == "btn_reset":
            if str(call.from_user.id) != str(OWNER_ID):
                bot.answer_callback_query(call.id, text="–¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.")
                return
            chat_store = data["chats"].get(str(cid))
            if chat_store:
                chat_store["records"] = []
                chat_store["balance"] = 0
                chat_store["daily_records"] = {}
                chat_store["next_id"] = 1
            save_data(data)
            text = "‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞ —Å–±—Ä–æ—à–µ–Ω—ã."
            try:
                bot.edit_message_text(text, cid, mid, reply_markup=build_main_keyboard(cid))
            except:
                bot.send_message(cid, text, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫
        elif data_cd == "btn_edit":
            kb = build_edit_list_keyboard(cid)
            active_id = get_today_active_window(cid)
            if active_id:
                try:
                    bot.edit_message_text("–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏—è:", cid, active_id, reply_markup=kb)
                except:
                    bot.send_message(cid, "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏—è:", reply_markup=kb)
            else:
                sent = bot.send_message(cid, "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏—è:", reply_markup=kb)
                set_today_active_window(cid, sent.message_id)
            bot.answer_callback_query(call.id)

        # –°—Ç–∞—Ä—Ç (–≤–µ—Ä–Ω—É—Ç—å –º–µ–Ω—é)
        elif data_cd == "btn_start":
            text = "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
            try:
                bot.edit_message_text(text, cid, mid, reply_markup=build_main_keyboard(cid))
            except:
                bot.send_message(cid, text, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        # –û –∫–æ–¥–µ
        elif data_cd == "btn_cod":
            info_text = (
                f"ü§ñ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è {VERSION}\n\n"
                "‚Ä¢ –£—á—ë—Ç –ø–æ –¥–Ω—è–º (–æ–¥–Ω–æ –æ–∫–Ω–æ –≤ –¥–µ–Ω—å)\n"
                "‚Ä¢ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π\n"
                "‚Ä¢ –ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤–ª–∞–¥–µ–ª—å—Ü–µ–º\n"
            )
            try:
                bot.edit_message_text(info_text, cid, mid, reply_markup=build_main_keyboard(cid))
            except:
                bot.send_message(cid, info_text, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        # –í—ã–±—Ä–∞—Ç—å –∑–∞–ø–∏—Å—å (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ) ‚Äî –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ state
        elif data_cd.startswith("edit_select:"):
            rid = int(data_cd.split(":")[1])
            chat_state = data.setdefault("tracked_messages", {})
            chat_key = str(cid)
            user_states = chat_state.setdefault(chat_key, {})
            user_states[str(call.from_user.id)] = {
                "action": "edit_wait_value",
                "rid": rid,
                "msg_id": mid
            }
            save_data(data)
            text = f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è R{rid} (–Ω–∞–ø—Ä–∏–º–µ—Ä: +500 –ø—Ä–æ–¥–∞–∂–∞)"
            try:
                bot.edit_message_text(text, cid, mid, reply_markup=build_main_keyboard(cid))
            except:
                bot.send_message(cid, text, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        # –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
        elif data_cd.startswith("delete_record:"):
            rid = int(data_cd.split(":")[1])
            ok, rec = delete_record_in_chat(cid, rid)
            if ok:
                text = f"‚úÖ –ó–∞–ø–∏—Å—å R{rid} —É–¥–∞–ª–µ–Ω–∞.\nüí∞ –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—ë–Ω: {get_chat_store(cid).get('balance', 0)} ARS"
            else:
                text = "‚ö†Ô∏è –ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."
            try:
                bot.edit_message_text(text, cid, mid, reply_markup=build_main_keyboard(cid))
            except:
                bot.send_message(cid, text, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        # –ù–∞–∑–∞–¥ / noop
        elif data_cd in ("btn_back", "noop"):
            try:
                bot.edit_message_reply_markup(cid, mid, reply_markup=build_main_keyboard(cid))
            except:
                bot.answer_callback_query(call.id)
        else:
            bot.answer_callback_query(call.id)

    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback: {e}")

# -----------------------------
# –û–¢–°–ï–ö 10 ‚Äî –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–¥–Ω–æ –æ–∫–Ω–æ)
# -----------------------------
@bot.message_handler(func=lambda m: True, content_types=[
    "text", "photo", "document", "voice", "video", "audio", "sticker"
])
def handle_message(msg):
    # –∏–∑–±–µ–≥–∞–µ–º –±–æ—Ç–æ–≤ –∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    if not getattr(msg, "from_user", None) or msg.from_user.is_bot:
        return

    chat_id = msg.chat.id
    user_id = msg.from_user.id

    # 1) –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (inline edit)
    chat_state = data.setdefault("tracked_messages", {})
    user_states = chat_state.get(str(chat_id), {})
    state = user_states.get(str(user_id))
    if state and state.get("action") == "edit_wait_value":
        rid = state.get("rid")
        target_msg_id = get_today_active_window(chat_id)
        lines = msg.text.splitlines() if msg.text else []
        if not lines:
            try:
                bot.edit_message_text("–í–≤–µ–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É —Å —á–∏—Å–ª–æ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä: +500 –ø—Ä–æ–¥–∞–∂–∞.", chat_id, target_msg_id, reply_markup=build_main_keyboard(chat_id))
            except:
                bot.send_message(chat_id, "–í–≤–µ–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É —Å —á–∏—Å–ª–æ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä: +500 –ø—Ä–æ–¥–∞–∂–∞.", reply_markup=build_main_keyboard(chat_id))
            return
        first_line = lines[0].strip()
        amt, token = extract_first_number(first_line)
        if amt is None:
            try:
                bot.edit_message_text("–ß–∏—Å–ª–æ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.", chat_id, target_msg_id, reply_markup=build_main_keyboard(chat_id))
            except:
                bot.send_message(chat_id, "–ß–∏—Å–ª–æ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.", reply_markup=build_main_keyboard(chat_id))
            return
        m = num_re.search(first_line)
        note = first_line[m.end():].strip() if m else ""
        final_amt = amt if token.lstrip().startswith("+") else -abs(amt)
        ok, updated = update_record_in_chat(chat_id, rid, final_amt, note)
        # clear state
        user_states.pop(str(user_id), None)
        save_data(data)
        if ok:
            # –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –æ–∫–Ω–æ
            update_or_send_today_window(chat_id)
        return

    # 2) –ü—Ä–æ–ø—É—Å–∫ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö –æ–±—Ä–∞–±–æ—Ç–æ–∫
    msg_key = f"{chat_id}:{msg.message_id}"
    processed = data.setdefault("processed_messages", [])
    if msg_key in processed:
        return

    # 3) –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ (–¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏)
    owner_int = int(OWNER_ID) if OWNER_ID and OWNER_ID.isdigit() else None
    is_owner_msg = (owner_int is not None and user_id == owner_int)

    # 4) –°–æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ (—Ç–µ–∫—Å—Ç –∏–ª–∏ caption)
    lines = []
    if msg.content_type == "text" and msg.text:
        lines = msg.text.splitlines()
    elif getattr(msg, "caption", None):
        lines = msg.caption.splitlines()

    # 5) –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏, –µ—Å–ª–∏ –µ—Å—Ç—å —á–∏—Å–ª–æ
    added = False
    for line in lines:
        line = line.strip()
        if not line:
            continue
        amt, token = extract_first_number(line)
        if amt is None:
            continue
        m = num_re.search(line)
        note = line[m.end():].strip() if m else ""
        final_amt = amt if token.lstrip().startswith("+") else -abs(amt)
        add_record_to_chat(chat_id, final_amt, note, user_id)
        added = True

    # 6) –ü–æ–º–µ—Ç–∫–∞ –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ
    processed.append(msg_key)
    # –¥–µ—Ä–∂–∏–º –¥–ª–∏–Ω—É —Å–ø–∏—Å–∫–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö
    if len(processed) > 2000:
        processed = processed[-1000:]
    data["processed_messages"] = processed
    save_data(data)

    # 7) –û–±–Ω–æ–≤–ª—è–µ–º/—Å–æ–∑–¥–∞—ë–º –∞–∫—Ç–∏–≤–Ω–æ–µ –æ–∫–Ω–æ (–≥–ª–∞–≤–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è)
    if added:
        update_or_send_today_window(chat_id)

    # 8) –ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ (–∫–∞–∫ –≤ —Å—Ç–∞—Ä–æ–º –±–æ—Ç–µ)
    if is_owner_msg:
        for target in data.get("forward_targets", []):
            try:
                t = int(target)
            except:
                continue
            if t == chat_id:
                # –µ—Å–ª–∏ –≤–ª–∞–¥–µ–ª–µ—Ü –ø–∏—à–µ—Ç –≤ —Ü–µ–ª—å ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –æ–∫–Ω–æ –≤–ª–∞–¥–µ–ª—å—Ü–∞
                update_or_send_today_window(owner_int)
                continue
            try:
                sent = bot.copy_message(chat_id=t, from_chat_id=chat_id, message_id=msg.message_id)
                # –ø–æ–º–µ—á–∞–µ–º —á—Ç–æ–±—ã –Ω–µ –∑–∞–¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ
                data.setdefault("processed_messages", []).append(f"{sent.chat.id}:{sent.message_id}")
            except Exception as e:
                log_error(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –≤ {t}: {e}")
        save_data(data)

# -----------------------------
# –û–¢–°–ï–ö 11 ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞ (—è–¥—Ä–æ –æ–¥–Ω–æ–æ–∫–Ω–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞)
# -----------------------------
def update_or_send_today_window(chat_id):
    """–ö–ª—é—á–µ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –æ–±–Ω–æ–≤–ª—è–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–µ –æ–∫–Ω–æ –¥–Ω—è (edit_message_text) –∏–ª–∏ —Å–æ–∑–¥–∞—ë—Ç –û–î–ù–û —Å–æ–æ–±—â–µ–Ω–∏–µ."""
    today_key = get_today_key()
    active_id = get_today_active_window(chat_id)
    store = get_chat_store(chat_id)
    day_records = store.get("daily_records", {}).get(today_key, [])

    # —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –æ–∫–Ω–∞
    if not day_records:
        text = f"üìÖ {today_key}\n–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π.\nüí∞ –ë–∞–ª–∞–Ω—Å: {store.get('balance', 0)} ARS"
    else:
        lines = [f"üìÖ {today_key}", "üìã –û–ø–µ—Ä–∞—Ü–∏–∏:"]
        for r in day_records[-50:]:
            sign = "+" if r["amount"] > 0 else ""
            lines.append(f"{r['short_id']}: {sign}{r['amount']} ‚Äî {r.get('note','')}")
        lines.append(f"\nüí∞ –ë–∞–ª–∞–Ω—Å: {store.get('balance', 0)} ARS")
        text = "\n".join(lines)

    # –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
    kb = build_main_keyboard(chat_id)

    # –ø—ã—Ç–∞–µ–º—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –∏–Ω–∞—á–µ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ –æ–¥–Ω–æ–æ–∫–Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –∑–∞–ø–æ–º–∏–Ω–∞–µ–º id
    if active_id:
        try:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            return
        except Exception as e:
            # –Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ‚Äî —É–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å active –∏ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ
            log_error(f"edit_message_text failed for chat {chat_id}, id {active_id}: {e}")
            # —É–¥–∞–ª—è–µ–º —Å–ª–æ–º–∞–Ω–Ω—ã–π active id
            try:
                if get_today_key() in data.get("active_messages", {}):
                    data["active_messages"][get_today_key()].pop(str(chat_id), None)
                save_data(data)
            except:
                pass

    # –µ—Å–ª–∏ –Ω–µ—Ç active_id ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∏ –∑–∞–ø–æ–º–∏–Ω–∞–µ–º
    try:
        sent = bot.send_message(chat_id, text, reply_markup=kb)
        set_today_active_window(chat_id, sent.message_id)
    except Exception as e:
        log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –æ–∫–Ω–æ –¥–Ω—è –¥–ª—è {chat_id}: {e}")

# -----------------------------
# –û–¢–°–ï–ö 12 ‚Äî –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö active_messages (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# -----------------------------
def cleanup_old_active_messages(retain_days=7):
    """–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ ‚Äî —É–¥–∞–ª—è–µ–º –∫–ª—é—á–∏ active_messages —Å—Ç–∞—Ä—à–µ retain_days (—á—Ç–æ–±—ã data –Ω–µ —Ä–æ—Å–ª–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ)."""
    try:
        today = datetime.now(TZ).date()
        keys = list(data.get("active_messages", {}).keys())
        for day_key in keys:
            try:
                dt = datetime.fromisoformat(day_key)
            except:
                # day_key –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
                try:
                    dt = datetime.strptime(day_key, "%Y-%m-%d")
                except:
                    continue
            if (today - dt.date()).days > retain_days:
                data["active_messages"].pop(day_key, None)
        save_data(data)
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ cleanup_old_active_messages: {e}")

# -----------------------------
# –û–¢–°–ï–ö 13 ‚Äî Flask webhook –∏ web endpoints
# -----------------------------
@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    update = telebot.types.Update.de_json(request.get_data().decode("utf-8"))
    bot.process_new_updates([update])
    return "OK", 200

@app.route("/", methods=["GET"])
def index():
    return f"–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ¬´–§–û¬ª ‚Äî –≤–µ—Ä—Å–∏—è {VERSION} —Ä–∞–±–æ—Ç–∞–µ—Ç", 200

# -----------------------------
# –û–¢–°–ï–ö 14 ‚Äî Webhook —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫
# -----------------------------
def set_webhook():
    url = f"{APP_URL}/{TOKEN}"
    try:
        bot.remove_webhook()
        time.sleep(0.5)
        bot.set_webhook(url=url)
        log_info(f"Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {url}")
    except Exception as e:
        log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook: {e}")

# -----------------------------
# –û–¢–°–ï–ö 15 ‚Äî –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Å–º–µ–Ω—ã –¥–Ω—è (—Å–æ–∑–¥–∞—ë—Ç –æ–∫–Ω–∞ –≤ –ø–æ–ª–Ω–æ—á—å, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# -----------------------------
def schedule_daily_window_creation():
    """–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞: –ø—Ä–∏ —Å–º–µ–Ω–µ –¥–∞—Ç—ã –≤—ã–∑—ã–≤–∞–µ—Ç update_or_send_today_window –¥–ª—è –≤—Å–µ—Ö —á–∞—Ç–æ–≤.
       –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É; –µ—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Å–º–µ–Ω–∞ –¥–∞—Ç—ã ‚Äî —Å–æ–∑–¥–∞–µ—Ç –æ–∫–Ω–∞ –¥–ª—è –≤—Å–µ—Ö —á–∞—Ç–æ–≤.
       (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω, –Ω–æ –ø–æ–ª–µ–∑–µ–Ω —á—Ç–æ–±—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Ç—å –æ–∫–Ω–æ –≤–ª–∞–¥–µ–ª—å—Ü—É –∏ –¥—Ä.)"""
    def task():
        last_day = get_today_key()
        while True:
            try:
                time.sleep(60)
                current_day = get_today_key()
                if current_day != last_day:
                    for chat_id_str in list(data.get("chats", {}).keys()):
                        try:
                            chat_id = int(chat_id_str)
                        except:
                            continue
                        try:
                            update_or_send_today_window(chat_id)
                        except Exception as e:
                            log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–∫–Ω–∞ –Ω–æ–≤–æ–≥–æ –¥–Ω—è –¥–ª—è {chat_id}: {e}")
                    last_day = current_day
                    # –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–ª—é—á–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                    cleanup_old_active_messages(retain_days=14)
            except Exception as e:
                log_error(f"–û—à–∏–±–∫–∞ –≤ daily loop: {e}")
                time.sleep(5)
    thread = threading.Thread(target=task, daemon=True)
    thread.start()

# -----------------------------
# –û–¢–°–ï–ö 16 ‚Äî –ó–∞–ø—É—Å–∫
# -----------------------------
if __name__ == "__main__":
    set_webhook()
    schedule_daily_window_creation()
    log_info(f"–ë–æ—Ç –§–û –≤–µ—Ä—Å–∏–∏ {VERSION} –∑–∞–ø—É—â–µ–Ω")
    app.run(host="0.0.0.0", port=PORT)

# ============================================
# –ö–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞
# –°—Ç—Ä–æ–∫ –∫–æ–¥–∞: ~470
# –í–µ—Ä—Å–∏—è: 9.6.1.7
# –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è
# ============================================

















# ============================================
# –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ¬´–§–û¬ª ‚Äî –≤–µ—Ä—Å–∏—è 9.6.1.7
# –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è
# –ë–∞–∑–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 9.6.1.6
# –û–¢–°–ï–ö 1 ‚Äî –ò–º–ø–æ—Ä—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
# ============================================

import os
import json
import csv
import re
import threading
from datetime import datetime, timedelta
from zoneinfo import ZoneInfo

import telebot
from flask import Flask, request
from telebot import types

# -----------------------------
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
# -----------------------------
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")
if not TOKEN:
    raise ValueError("‚ùå –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!")

VERSION = "9.6.1.7"
TZ = ZoneInfo("America/Argentina/Catamarca")
DATA_FILE = "data.json"
CSV_FILE = "data.csv"
PORT = int(os.environ.get("PORT", 5000))

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# -----------------------------
# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
# -----------------------------
def log_info(text):
    print(f"[INFO] {datetime.now(TZ).strftime('%H:%M:%S')} ‚Äî {text}")

def log_error(text):
    print(f"[ERROR] {datetime.now(TZ).strftime('%H:%M:%S')} ‚Äî {text}")

# -----------------------------
# –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
# -----------------------------
def default_data():
    return {
        "chats": {},
        "processed_messages": [],
        "forward_targets": []
    }

def load_data():
    if os.path.exists(DATA_FILE):
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            try:
                d = json.load(f)
            except Exception:
                d = default_data()
    else:
        d = default_data()
    return d

def save_data(d):
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(d, f, ensure_ascii=False, indent=2)

data = load_data()

# ============================================
# –ö–æ–Ω–µ—Ü –æ—Ç—Å–µ–∫–∞ 1
# –°—Ç—Ä–æ–∫: 94
# –í–µ—Ä—Å–∏—è: 9.6.1.7
# –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è
# ============================================

# ============================================
# –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ¬´–§–û¬ª ‚Äî –≤–µ—Ä—Å–∏—è 9.6.1.7
# –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è
# –û–¢–°–ï–ö 2 ‚Äî –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —á–∞—Ç–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
# ============================================

# -----------------------------
# –†–∞–±–æ—Ç–∞ —Å —á–∞—Ç–∞–º–∏ –∏ –¥–∞–Ω–Ω—ã–º–∏
# -----------------------------
def get_chat_store(chat_id):
    """–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —á–∞—Ç–∞"""
    cid = str(chat_id)
    if cid not in data["chats"]:
        data["chats"][cid] = {
            "balance": 0,
            "records": [],
            "daily_records": {},
            "active_windows": {},
            "next_id": 1
        }
        save_data(data)
    store = data["chats"][cid]
    if "daily_records" not in store:
        store["daily_records"] = {}
    if "active_windows" not in store:
        store["active_windows"] = {}
    return store

# -----------------------------
# –ö–ª—é—á —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
# -----------------------------
def get_today_key():
    return datetime.now(TZ).strftime("%Y-%m-%d")

def get_today_active_window(chat_id):
    store = get_chat_store(chat_id)
    today_key = get_today_key()
    return store.get("active_windows", {}).get(today_key)

def set_today_active_window(chat_id, message_id):
    store = get_chat_store(chat_id)
    today_key = get_today_key()
    store.setdefault("active_windows", {})[today_key] = message_id
    save_data(data)

# -----------------------------
# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
# -----------------------------
def add_record_to_chat(chat_id, amount, note, owner):
    store = get_chat_store(chat_id)
    ts = datetime.now(TZ).isoformat(timespec="seconds")
    rid = store.get("next_id", 1)
    rec = {
        "id": rid,
        "short_id": f"R{rid}",
        "timestamp": ts,
        "amount": amount,
        "note": note,
        "owner": owner
    }
    # –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ–±—â–∏–µ –∏ –¥–Ω–µ–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏
    store.setdefault("records", []).append(rec)
    today_key = get_today_key()
    store.setdefault("daily_records", {}).setdefault(today_key, []).append(rec)
    # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –∏ —Å—á—ë—Ç—á–∏–∫
    store["balance"] = store.get("balance", 0) + amount
    store["next_id"] = rid + 1
    save_data(data)
    export_to_csv(data)

    sign = "+" if amount > 0 else ""
    log_info(f"[CHAT {chat_id}] {sign}{amount} {note}")
    return rec

# -----------------------------
# –≠–∫—Å–ø–æ—Ä—Ç CSV
# -----------------------------
def export_to_csv(d):
    """–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π –≤–æ –≤—Å–µ —á–∞—Ç—ã –≤ —Ñ–∞–π–ª CSV"""
    with open(CSV_FILE, "w", encoding="utf-8", newline="") as f:
        writer = csv.writer(f)
        writer.writerow(["chat_id", "record_id", "timestamp", "amount", "note", "owner"])
        for cid, store in d.get("chats", {}).items():
            for r in store.get("records", []):
                writer.writerow([cid, r["id"], r["timestamp"], r["amount"], r["note"], r["owner"]])
    log_info("üíæ –î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ CSV.")


# ============================================
# –ö–æ–Ω–µ—Ü –æ—Ç—Å–µ–∫–∞ 2
# –°—Ç—Ä–æ–∫: 118
# –í–µ—Ä—Å–∏—è: 9.6.1.7
# –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è
# ============================================


# ============================================
# –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ¬´–§–û¬ª ‚Äî –≤–µ—Ä—Å–∏—è 9.6.1.7
# –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è
# –û–¢–°–ï–ö 3 ‚Äî –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–∫–Ω–∞ –¥–Ω—è –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
# ============================================

# -----------------------------
# –û—Å–Ω–æ–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
# -----------------------------
def build_main_keyboard(chat_id):
    kb = types.InlineKeyboardMarkup()
    kb.add(
        types.InlineKeyboardButton("‚ûï –ü—Ä–∏—Ö–æ–¥", callback_data="add_income"),
        types.InlineKeyboardButton("‚ûñ –†–∞—Å—Ö–æ–¥", callback_data="add_expense")
    )
    kb.add(types.InlineKeyboardButton("üìÑ –û—Ç—á—ë—Ç", callback_data="show_report"))
    return kb

# -----------------------------
# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
# -----------------------------
def update_main_window(chat_id):
    try:
        today_key = get_today_key()
        store = get_chat_store(chat_id)
        day_records = store.get("daily_records", {}).get(today_key, [])

        if not day_records:
            text = f"üìÖ {today_key}\n–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π.\nüí∞ –ë–∞–ª–∞–Ω—Å: {store.get('balance', 0)} ARS"
        else:
            lines = [f"üìÖ {today_key}", "üìã –û–ø–µ—Ä–∞—Ü–∏–∏:"]
            for r in day_records[-20:]:
                sign = "+" if r["amount"] > 0 else ""
                lines.append(f"{r['short_id']}: {sign}{r['amount']} ‚Äî {r.get('note','')}")
            lines.append(f"\nüí∞ –ë–∞–ª–∞–Ω—Å: {store.get('balance', 0)} ARS")
            text = "\n".join(lines)

        active_id = get_today_active_window(chat_id)
        if active_id:
            try:
                bot.edit_message_text(
                    text,
                    chat_id,
                    active_id,
                    reply_markup=build_main_keyboard(chat_id)
                )
                return
            except Exception as e:
                log_error(f"–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–∫–Ω–∞ ({chat_id}, id={active_id}): {e}")
                # –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å ‚Äî —É–¥–∞–ª–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ –æ–∫–Ω–æ –∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ
                try:
                    store["active_windows"].pop(today_key, None)
                except Exception:
                    pass
                save_data(data)

        # –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ (—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)
        sent = bot.send_message(chat_id, text, reply_markup=build_main_keyboard(chat_id))
        set_today_active_window(chat_id, sent.message_id)

    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –≤ update_main_window: {e}")

# -----------------------------
# –ü–æ–∫–∞–∑ –æ—Ç—á—ë—Ç–∞ (–ø–æ –∫–Ω–æ–ø–∫–µ)
# -----------------------------
def show_report(chat_id):
    store = get_chat_store(chat_id)
    lines = [f"üìä –û—Ç—á—ë—Ç –ø–æ —á–∞—Ç—É {chat_id}", ""]
    total_income = sum(r["amount"] for r in store["records"] if r["amount"] > 0)
    total_expense = sum(r["amount"] for r in store["records"] if r["amount"] < 0)
    lines.append(f"üíµ –ü—Ä–∏—Ö–æ–¥: {total_income}")
    lines.append(f"üí∏ –†–∞—Å—Ö–æ–¥: {total_expense}")
    lines.append(f"üí∞ –ë–∞–ª–∞–Ω—Å: {store.get('balance', 0)}")
    text = "\n".join(lines)
    bot.send_message(chat_id, text)

# ============================================
# –ö–æ–Ω–µ—Ü –æ—Ç—Å–µ–∫–∞ 3
# –°—Ç—Ä–æ–∫: 129
# –í–µ—Ä—Å–∏—è: 9.6.1.7
# –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è
# ============================================

# ============================================
# –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ¬´–§–û¬ª ‚Äî –≤–µ—Ä—Å–∏—è 9.6.1.7
# –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è
# –û–¢–°–ï–ö 4 ‚Äî Flask webhook, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫
# ============================================

# -----------------------------
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
# -----------------------------
@bot.message_handler(func=lambda m: True, content_types=["text"])
def handle_message(message):
    chat_id = message.chat.id
    text = message.text.strip()
    mid = message.message_id

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–≤—Ç–æ—Ä
    if mid in data.get("processed_messages", []):
        return
    data["processed_messages"].append(mid)
    if len(data["processed_messages"]) > 10000:
        data["processed_messages"] = data["processed_messages"][-5000:]
    save_data(data)

    # –†–∞—Å—Ö–æ–¥ / –ü—Ä–∏—Ö–æ–¥
    m = re.match(r"^([+-]?\d+)\s*(.*)$", text)
    if m:
        amount = int(m.group(1))
        note = m.group(2).strip() or "-"
        add_record_to_chat(chat_id, amount, note, message.from_user.first_name)
        update_main_window(chat_id)
        return

    # –ö–æ–º–∞–Ω–¥—ã
    if text.lower() in ["/–±–∞–ª–∞–Ω—Å", "/balance"]:
        store = get_chat_store(chat_id)
        bot.send_message(chat_id, f"üí∞ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {store.get('balance', 0)} ARS")
    elif text.lower() in ["/–æ—Ç—á–µ—Ç", "/report"]:
        show_report(chat_id)
    elif text.lower() in ["/—Å–±—Ä–æ—Å", "/reset"]:
        data["chats"][str(chat_id)] = {
            "balance": 0,
            "records": [],
            "daily_records": {},
            "active_windows": {},
            "next_id": 1
        }
        save_data(data)
        bot.send_message(chat_id, "üßπ –î–∞–Ω–Ω—ã–µ –ø–æ —ç—Ç–æ–º—É —á–∞—Ç—É —Å–±—Ä–æ—à–µ–Ω—ã.")
        update_main_window(chat_id)
    elif text.lower() in ["/–≤–µ—Ä—Å–∏—è", "/version"]:
        bot.send_message(chat_id, f"‚öôÔ∏è –í–µ—Ä—Å–∏—è –±–æ—Ç–∞: {VERSION}")
    else:
        bot.send_message(chat_id, "‚ùî –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: +1000 –∏–ª–∏ -500) –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.")

# -----------------------------
# Callback-–∫–Ω–æ–ø–∫–∏
# -----------------------------
@bot.callback_query_handler(func=lambda call: True)
def callback_handler(call):
    chat_id = call.message.chat.id
    data_cb = call.data

    if data_cb == "add_income":
        bot.send_message(chat_id, "–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—Ö–æ–¥: +—Å—É–º–º–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π")
    elif data_cb == "add_expense":
        bot.send_message(chat_id, "–í–≤–µ–¥–∏—Ç–µ —Ä–∞—Å—Ö–æ–¥: -—Å—É–º–º–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π")
    elif data_cb == "show_report":
        show_report(chat_id)

# -----------------------------
# Flask Webhook
# -----------------------------
@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    update = telebot.types.Update.de_json(request.data.decode("utf-8"))
    bot.process_new_updates([update])
    return "OK", 200

@app.route("/", methods=["GET"])
def index():
    return f"–ë–æ—Ç –§–û {VERSION} —Ä–∞–±–æ—Ç–∞–µ—Ç.", 200

# -----------------------------
# –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
# -----------------------------
def schedule_daily_window_creation():
    """–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–Ω–µ–≤–Ω—ã—Ö –æ–∫–æ–Ω (—Ä–∞–∑ –≤ —Å—É—Ç–∫–∏)"""
    def task():
        while True:
            now = datetime.now(TZ)
            if now.hour == 0 and now.minute == 0:
                for cid in data.get("chats", {}).keys():
                    try:
                        update_main_window(int(cid))
                    except Exception as e:
                        log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –æ–∫–Ω–æ –¥–ª—è —á–∞—Ç–∞ {cid}: {e}")
                save_data(data)
            threading.Event().wait(60)
    thread = threading.Thread(target=task, daemon=True)
    thread.start()

# -----------------------------
# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# -----------------------------
if __name__ == "__main__":
    log_info(f"üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –§–û –≤–µ—Ä—Å–∏–∏ {VERSION}")
    bot.remove_webhook()
    webhook_url = f"https://fo-1.onrender.com/{TOKEN}"
    bot.set_webhook(url=webhook_url)
    log_info(f"üåê Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {webhook_url}")

    schedule_daily_window_creation()
    app.run(host="0.0.0.0", port=PORT)

# ============================================
# –ö–æ–Ω–µ—Ü –æ—Ç—Å–µ–∫–∞ 4
# –°—Ç—Ä–æ–∫: 201
# –í–µ—Ä—Å–∏—è: 9.6.1.7
# –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è
# ============================================
# --------------------------------------------
# –û–¢–°–ï–ö 5 ‚Äî –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏ –∫–Ω–æ–ø–∫–∏ (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π)
# --------------------------------------------
from telebot import types

def build_main_keyboard(chat_id=None):
    """
    –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (–∫–æ–º–ø–∞–∫—Ç–Ω–æ–µ, –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É),
    —Å –∫–Ω–æ–ø–∫–∞–º–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞.
    """
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.add(
        types.InlineKeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å", callback_data="btn_balance"),
        types.InlineKeyboardButton("üìä –û—Ç—á—ë—Ç", callback_data="btn_report"),
    )
    kb.add(
        types.InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data="btn_edit"),
        types.InlineKeyboardButton("‚öôÔ∏è –°–±—Ä–æ—Å", callback_data="btn_reset"),
    )
    kb.add(
        types.InlineKeyboardButton("üöÄ –°—Ç–∞—Ä—Ç", callback_data="btn_start"),
        types.InlineKeyboardButton("üìò –û –∫–æ–¥–µ", callback_data="btn_cod"),
    )

    # --- –Ω–∏–∂–Ω—è—è —Å—Ç—Ä–æ–∫–∞ —Å –±–∞–ª–∞–Ω—Å–æ–º ---
    balance_text = ""
    if chat_id is not None:
        store = get_chat_store(chat_id)
        balance_text = f"üí∞ {store.get('balance', 0)} ARS"
    kb.add(types.InlineKeyboardButton(balance_text or "üí∞ 0 ARS", callback_data="noop"))
    return kb


def build_edit_list_keyboard(chat_id):
    """
    –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å –º–∞–ª–µ–Ω—å–∫–∏–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏ ‚úè –∏ üóë
    (–≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É, –∫–æ–º–ø–∞–∫—Ç–Ω–æ).
    """
    store = get_chat_store(chat_id)
    kb = types.InlineKeyboardMarkup()
    records = store.get("records", [])[-20:]
    if not records:
        kb.add(types.InlineKeyboardButton("–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π", callback_data="noop"))
        kb.add(types.InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="btn_start"))
        return kb

    for r in records:
        sign = "+" if r["amount"] > 0 else ""
        label = f"{r['short_id']}: {sign}{r['amount']} ARS {r.get('note','')}"
        # –Ω–µ–±–æ–ª—å—à–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ —à–∏—Ä–∏–Ω–µ
        kb.row(
            types.InlineKeyboardButton(label, callback_data=f"noop_row:{r['id']}"),
            types.InlineKeyboardButton("‚úè", callback_data=f"edit_select:{r['id']}"),
            types.InlineKeyboardButton("üóë", callback_data=f"delete_record:{r['id']}")
        )

    # –∫–Ω–æ–ø–∫–∞ "–Ω–∞–∑–∞–¥" –≤ –∫–æ–Ω—Ü–µ
    kb.add(types.InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="btn_start"))
    return kb

# 6--------------------------------------------
# –û–¢–°–ï–ö 6 ‚Äî –ö–æ–º–∞–Ω–¥—ã (–æ—Å–Ω–æ–≤–Ω—ã–µ)
# --------------------------------------------
@bot.message_handler(commands=["start"])
def cmd_start(msg):
    text = (
        "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ¬´–§–û¬ª\n\n"
        "–ö–æ–º–∞–Ω–¥—ã (–ª–∞—Ç–∏–Ω–∏—Ü–µ–π):\n"
        "/start ‚Äì –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É\n"
        "/myid ‚Äì –ø–æ–∫–∞–∑–∞—Ç—å –≤–∞—à user ID\n"
        "/chatid ‚Äì –ø–æ–∫–∞–∑–∞—Ç—å ID —á–∞—Ç–∞\n"
        "/balance ‚Äì –ø–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å (–¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞)\n"
        "/report ‚Äì –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞)\n"
        "/reset ‚Äì –æ–±–Ω—É–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü)\n"
        "/addforward <chat_id> ‚Äì –¥–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏ (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü)\n"
        "/removeforward <chat_id> ‚Äì —É–±—Ä–∞—Ç—å —Ü–µ–ª—å –ø–µ—Ä–µ—Å—ã–ª–∫–∏ (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü)\n"
        "/listforwards ‚Äì —Å–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π –ø–µ—Ä–µ—Å—ã–ª–∫–∏\n"
        "/cod ‚Äì –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä—Å–∏–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö\n"
        "/edit ‚Äì —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (—Å–ø–∏—Å–æ–∫ –∏ –≤—ã–±–æ—Ä)\n"
        "/delete <–Ω–æ–º–µ—Ä> ‚Äì —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ –Ω–æ–º–µ—Ä—É\n\n"
        "–î–ª—è –∑–∞–ø–∏—Å–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫, –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π —É—á—ë—Ç.\n"
        "–ü—Ä–∏–º–µ—Ä—ã:\n+1000 –∑–∞—Ä–ø–ª–∞—Ç–∞\n-123 —Ö–ª–µ–±\n200 —Å–æ–∫\n"
    )
    bot.send_message(msg.chat.id, f"üí¨ –í–µ—Ä—Å–∏—è: {VERSION}\n\n{text}", reply_markup=build_main_keyboard())

@bot.message_handler(commands=["myid"])
def cmd_myid(msg):
    uid = msg.from_user.id
    bot.reply_to(msg, f"üÜî –í–∞—à user ID: {uid}")

@bot.message_handler(commands=["chatid"])
def cmd_chatid(msg):
    cid = msg.chat.id
    bot.reply_to(msg, f"üí¨ ID —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞: {cid}")

@bot.message_handler(commands=["balance"])
def cmd_balance(msg):
    store = get_chat_store(msg.chat.id)
    bot.reply_to(msg, f"üí∞ –ë–∞–ª–∞–Ω—Å —ç—Ç–æ–≥–æ —á–∞—Ç–∞: {store.get('balance',0)} ars", reply_markup=build_main_keyboard())

@bot.message_handler(commands=["report"])
def cmd_report(msg):
    store = get_chat_store(msg.chat.id)
    recs = store.get("records", [])
    if not recs:
        bot.send_message(msg.chat.id, "–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —ç—Ç–æ–º —á–∞—Ç–µ.", reply_markup=build_main_keyboard())
        return
    text_lines = ["üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —ç—Ç–æ–≥–æ —á–∞—Ç–∞:"]
    for r in recs[-50:]:
        sign = "+" if r["amount"] > 0 else ""
        text_lines.append(f"{r['short_id']}: {sign}{r['amount']} ‚Äî {r.get('note','')}")
    bot.send_message(msg.chat.id, "\n".join(text_lines), reply_markup=build_main_keyboard())

@bot.message_handler(commands=["reset"])
def cmd_reset(msg):
    if OWNER_ID is None or str(msg.from_user.id) != str(OWNER_ID):
        bot.send_message(msg.chat.id, "–¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.", reply_markup=build_main_keyboard())
        return
    global data
    data = default_data()
    try:
        if OWNER_ID:
            data["forward_targets"].append(int(OWNER_ID))
    except Exception:
        pass
    save_data(data)
    export_to_csv(data)
    bot.send_message(msg.chat.id, "‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã.", reply_markup=build_main_keyboard())
    log_info("–î–ê–ù–ù–´–ï –û–ë–ù–£–õ–ï–ù–´ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º")

@bot.message_handler(commands=["addforward"])
def cmd_addforward(msg):
    if OWNER_ID is None or str(msg.from_user.id) != str(OWNER_ID):
        return
    parts = msg.text.split()
    if len(parts) < 2:
        bot.reply_to(msg, "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /addforward <chat_id>")
        return
    try:
        cid = int(parts[1])
    except Exception:
        bot.reply_to(msg, "–ù–µ–≤–µ—Ä–Ω—ã–π chat_id (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ).")
        return
    if cid in data["forward_targets"]:
        bot.reply_to(msg, "–≠—Ç–æ—Ç —á–∞—Ç —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ –ø–µ—Ä–µ—Å—ã–ª–∫–∏.")
        return
    data["forward_targets"].append(cid)
    save_data(data)
    bot.reply_to(msg, f"‚úÖ –¶–µ–ª—å –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞: {cid}")

@bot.message_handler(commands=["removeforward"])
def cmd_removeforward(msg):
    if OWNER_ID is None or str(msg.from_user.id) != str(OWNER_ID):
        return
    parts = msg.text.split()
    if len(parts) < 2:
        bot.reply_to(msg, "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /removeforward <chat_id>")
        return
    try:
        cid = int(parts[1])
    except Exception:
        bot.reply_to(msg, "–ù–µ–≤–µ—Ä–Ω—ã–π chat_id (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ).")
        return
    if cid not in data["forward_targets"]:
        bot.reply_to(msg, "–≠—Ç–æ—Ç —á–∞—Ç –Ω–µ –≤ —Å–ø–∏—Å–∫–µ –ø–µ—Ä–µ—Å—ã–ª–∫–∏.")
        return
    data["forward_targets"].remove(cid)
    save_data(data)
    bot.reply_to(msg, f"‚úÖ –¶–µ–ª—å –ø–µ—Ä–µ—Å—ã–ª–∫–∏ —É–¥–∞–ª–µ–Ω–∞: {cid}")

@bot.message_handler(commands=["listforwards"])
def cmd_listforwards(msg):
    if not data["forward_targets"]:
        bot.reply_to(msg, "–°–ø–∏—Å–æ–∫ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –ø—É—Å—Ç.", reply_markup=build_main_keyboard())
        return
    text = "üì® –¶–µ–ª–∏ –ø–µ—Ä–µ—Å—ã–ª–∫–∏:\n" + "\n".join(map(str, data["forward_targets"]))
    bot.reply_to(msg, text, reply_markup=build_main_keyboard())

@bot.message_handler(commands=["cod"])
def cmd_cod(msg):
    text = (
        f"üìò –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–¥–µ ‚Äî –≤–µ—Ä—Å–∏—è {VERSION}\n\n"
        "–ö—Ä–∞—Ç–∫–æ–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:\n"
        "- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ\n"
        "- –ö–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ –ª–∞—Ç–∏–Ω–∏—Ü–µ\n"
        "- –î–æ–±–∞–≤–ª–µ–Ω—ã inline-–∫–Ω–æ–ø–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞\n"
        "- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ\n"
        "- –ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–µ —á–∞—Ç—ã (–±–µ–∑ —ç—Ö–∞)\n"
        "- –û—Ç–¥–µ–ª—å–Ω—ã–π —É—á—ë—Ç –ø–æ –∫–∞–∂–¥–æ–º—É —á–∞—Ç—É\n"
        "- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π —á–µ—Ä–µ–∑ /edit –∏ /delete\n"
        "- –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è = –æ—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å\n\n"
        "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å–∏—è 9.6.1.6 ‚Äî —Å–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É—á—ë—Ç, —É–ª—É—á—à–µ–Ω–Ω–∞—è –ø–µ—Ä–µ—Å—ã–ª–∫–∞, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ."
    )
    bot.send_message(msg.chat.id, text, reply_markup=build_main_keyboard())

@bot.message_handler(commands=["edit"])
def cmd_edit(msg):
    kb = build_edit_list_keyboard(msg.chat.id)
    if not kb.keyboard:
        bot.reply_to(msg, "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —ç—Ç–æ–º —á–∞—Ç–µ.", reply_markup=build_main_keyboard())
        return
    bot.send_message(msg.chat.id, "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:", reply_markup=kb)

@bot.message_handler(commands=["delete"])
def cmd_delete(msg):
    parts = msg.text.split()
    if len(parts) < 2:
        bot.reply_to(msg, "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /delete <–Ω–æ–º–µ—Ä –∏–ª–∏ R–Ω–æ–º–µ—Ä>")
        return
    token = parts[1].strip()
    if token.upper().startswith("R"):
        token = token[1:]
    try:
        rid = int(token)
    except Exception:
        bot.reply_to(msg, "–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–ø–∏—Å–∏.")
        return
    ok, rec = delete_record_in_chat(msg.chat.id, rid)
    if ok:
        bot.reply_to(msg, f"‚úÖ –ó–∞–ø–∏—Å—å R{rid} —É–¥–∞–ª–µ–Ω–∞. –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—ë–Ω: {get_chat_store(msg.chat.id).get('balance',0)} ars", reply_markup=build_main_keyboard())
    else:
        bot.reply_to(msg, "–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", reply_markup=build_main_keyboard())


# --------------------------------------------
# –û–¢–°–ï–ö 7 ‚Äî –û–±—Ä–∞–±–æ—Ç–∫–∞ callback'–æ–≤ (–≤ –æ–¥–Ω–æ–º –æ–∫–Ω–µ, —Å –∫–Ω–æ–ø–∫–æ–π –ù–∞–∑–∞–¥)
# --------------------------------------------
@bot.callback_query_handler(func=lambda c: True)
def handle_callback(call):
    try:
        data_cd = call.data
        cid = call.message.chat.id
        mid = call.message.message_id

        # --- üí∞ –ë–∞–ª–∞–Ω—Å ---
        if data_cd == "btn_balance":
            store = get_chat_store(cid)
            text = f"üí∞ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å —ç—Ç–æ–≥–æ —á–∞—Ç–∞: {store.get('balance', 0)} ARS"
            bot.edit_message_text(text, cid, mid, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        # --- üìä –û—Ç—á—ë—Ç ---
        elif data_cd == "btn_report":
            recs = get_chat_store(cid).get("records", [])
            if not recs:
                text = "üìã –ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π."
            else:
                text_lines = ["üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:"]
                for r in recs[-20:]:
                    sign = "+" if r["amount"] > 0 else ""
                    text_lines.append(f"{r['short_id']}: {sign}{r['amount']} ARS ‚Äî {r.get('note','')}")
                text = "\n".join(text_lines)
            bot.edit_message_text(text, cid, mid, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        # --- ‚öôÔ∏è –°–±—Ä–æ—Å ---
        elif data_cd == "btn_reset":
            if str(call.from_user.id) != str(OWNER_ID):
                bot.answer_callback_query(call.id, text="–¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.")
                return
            chat_store = data["chats"].get(str(cid))
            if chat_store:
                chat_store["records"] = []
                chat_store["balance"] = 0
                chat_store["daily_records"] = {}
                chat_store["next_id"] = 1
            save_data(data)
            text = "‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞ —Å–±—Ä–æ—à–µ–Ω—ã."
            bot.edit_message_text(text, cid, mid, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        # --- ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ---
        elif data_cd == "btn_edit":
            kb = build_edit_list_keyboard(cid)
            text = "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏—è:"
            bot.edit_message_text(text, cid, mid, reply_markup=kb)
            bot.answer_callback_query(call.id)

        # --- üöÄ –°—Ç–∞—Ä—Ç ---
        elif data_cd == "btn_start":
            text = "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
            bot.edit_message_text(text, cid, mid, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        # --- üìò –û –∫–æ–¥–µ ---
        elif data_cd == "btn_cod":
            info_text = (
                "ü§ñ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è 9.8.X (–¥–Ω–µ–≤–Ω–æ–π —É—á—ë—Ç)\n\n"
                "üìÇ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:\n"
                "‚Ä¢ –£—á—ë—Ç –ø–æ –¥–Ω—è–º (–Ω–æ–≤—ã–µ —Å—É—Ç–∫–∏ ‚Äî –Ω–æ–≤–æ–µ –æ–∫–Ω–æ)\n"
                "‚Ä¢ –û–±—â–∏–π –±–∞–ª–∞–Ω—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è\n"
                "‚Ä¢ –£–¥–æ–±–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π\n"
                "‚Ä¢ –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ –æ–¥–Ω–æ–º –æ–∫–Ω–µ\n\n"
                "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –¥–æ–±–∞–≤–ª–µ–Ω –¥–Ω–µ–≤–Ω–æ–π —É—á—ë—Ç –∏ –±–∞–ª–∞–Ω—Å –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ."
            )
            bot.edit_message_text(info_text, cid, mid, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        # --- ‚úè –í—ã–±–æ—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ---
        elif data_cd.startswith("edit_select:"):
            rid = int(data_cd.split(":")[1])
            chat_state = data.setdefault("tracked_messages", {})
            chat_key = str(cid)
            user_states = chat_state.setdefault(chat_key, {})
            user_states[str(call.from_user.id)] = {
                "action": "edit_wait_value",
                "rid": rid,
                "msg_id": mid
            }
            save_data(data)
            text = f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è R{rid} (–Ω–∞–ø—Ä–∏–º–µ—Ä: +500 –ø—Ä–æ–¥–∞–∂–∞)"
            bot.edit_message_text(text, cid, mid, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        # --- üóë –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ ---
        elif data_cd.startswith("delete_record:"):
            rid = int(data_cd.split(":")[1])
            ok, rec = delete_record_in_chat(cid, rid)
            if ok:
                text = f"‚úÖ –ó–∞–ø–∏—Å—å R{rid} —É–¥–∞–ª–µ–Ω–∞.\nüí∞ –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—ë–Ω: {get_chat_store(cid).get('balance', 0)} ARS"
            else:
                text = "‚ö†Ô∏è –ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."
            bot.edit_message_text(text, cid, mid, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        # --- ‚¨ÖÔ∏è –ù–∞–∑–∞–¥ (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞) ---
        elif data_cd in ("btn_back", "noop"):
            bot.edit_message_reply_markup(cid, mid, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        else:
            bot.answer_callback_query(call.id)

    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback: {e}")


# --------------------------------------------
# –û–¢–°–ï–ö 8 ‚Äî –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–¥–Ω–æ –æ–∫–Ω–æ –≤ –¥–µ–Ω—å)
# --------------------------------------------
@bot.message_handler(func=lambda m: True, content_types=[
    "text", "photo", "document", "voice", "video", "audio", "sticker"
])
def handle_message(msg):
    if not getattr(msg, "from_user", None) or msg.from_user.is_bot:
        return

    chat_id = msg.chat.id
    user_id = msg.from_user.id
    today_key = get_today_key()
    store = get_chat_store(chat_id)

    # --- 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    user_states = data.setdefault("tracked_messages", {}).get(str(chat_id), {})
    state = user_states.get(str(user_id))
    if state and state.get("action") == "edit_wait_value":
        rid = state.get("rid")
        target_msg_id = get_today_active_window(chat_id)
        lines = msg.text.splitlines() if msg.text else []
        if not lines:
            bot.edit_message_text(
                "–í–≤–µ–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É —Å —á–∏—Å–ª–æ–º, –ø—Ä–∏–º–µ—Ä: +500 –ø—Ä–æ–¥–∞–∂–∞.",
                chat_id, target_msg_id, reply_markup=build_main_keyboard(chat_id)
            )
            return
        first_line = lines[0].strip()
        amt, token = extract_first_number(first_line)
        if amt is None:
            bot.edit_message_text(
                "–ß–∏—Å–ª–æ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.",
                chat_id, target_msg_id, reply_markup=build_main_keyboard(chat_id)
            )
            return
        m = num_re.search(first_line)
        note = first_line[m.end():].strip() if m else ""
        final_amt = amt if token.lstrip().startswith("+") else -abs(amt)
        ok, updated = update_record_in_chat(chat_id, rid, final_amt, note)
        user_states.pop(str(user_id), None)
        save_data(data)
        if ok:
            update_main_window(chat_id)
        return

    # --- 2. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥—É–±–ª–∏
    msg_key = f"{chat_id}:{msg.message_id}"
    processed = data.setdefault("processed_messages", [])
    if msg_key in processed:
        return

    # --- 3. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞
    owner_int = int(OWNER_ID) if OWNER_ID and OWNER_ID.isdigit() else None
    is_owner_msg = (owner_int is not None and user_id == owner_int)

    # --- 4. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —É—á—ë—Ç–∞
    lines = []
    if msg.content_type == "text" and msg.text:
        lines = msg.text.splitlines()
    elif msg.caption:
        lines = msg.caption.splitlines()

    # --- 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø–∏—Å–µ–π (—É—á—ë—Ç)
    added = False
    for line in lines:
        line = line.strip()
        if not line:
            continue
        amt, token = extract_first_number(line)
        if amt is None:
            continue
        m = num_re.search(line)
        note = line[m.end():].strip() if m else ""
        final_amt = amt if token.lstrip().startswith("+") else -abs(amt)
        add_record_to_chat(chat_id, final_amt, note, user_id)
        added = True

    # --- 6. –ü–æ–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º
    processed.append(msg_key)
    if len(processed) > 1000:
        processed = processed[-500:]
    data["processed_messages"] = processed
    save_data(data)

    # --- 7. –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ –æ–∫–Ω–æ
    update_main_window(chat_id)

    # --- 8. –ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞
    if is_owner_msg:
        for target in data.get("forward_targets", []):
            try:
                t = int(target)
            except Exception:
                continue
            if t == chat_id:
                # –µ—Å–ª–∏ –≤–ª–∞–¥–µ–ª–µ—Ü –ø–∏—à–µ—Ç –≤ —Ü–µ–ª—å ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –æ–∫–Ω–æ –≤–ª–∞–¥–µ–ª—å—Ü–∞, –±–µ–∑ –¥—É–±–ª–µ–π
                update_main_window(owner_int)
                continue
            try:
                sent = bot.copy_message(chat_id=t, from_chat_id=chat_id, message_id=msg.message_id)
                key = f"{sent.chat.id}:{sent.message_id}"
                processed.append(key)
            except Exception as e:
                log_error(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –≤ {t}: {e}")
        save_data(data)


# --------------------------------------------
# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –æ–∫–Ω–∞
# --------------------------------------------
def update_main_window(chat_id):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–µ–∫—É—â–µ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ –ø–æ –¥–∞–Ω–Ω—ã–º –¥–Ω—è, –Ω–µ —Å–æ–∑–¥–∞–≤–∞—è –Ω–æ–≤–æ–µ."""
    today_key = get_today_key()
    store = get_chat_store(chat_id)
    active_id = get_today_active_window(chat_id)

    # –ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –æ–∫–Ω–æ
    text = ""
    try:
        day_records = get_daily_records(chat_id, today_key)
        if not day_records:
            text = f"üìÖ {today_key}\n–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π.\nüí∞ –ë–∞–ª–∞–Ω—Å: {store.get('balance', 0)} ARS"
        else:
            lines = [f"üìÖ {today_key}", "üìã –û–ø–µ—Ä–∞—Ü–∏–∏:"]
            for r in day_records[-20:]:
                sign = "+" if r["amount"] > 0 else ""
                lines.append(f"{r['short_id']}: {sign}{r['amount']} ‚Äî {r.get('note','')}")
            lines.append(f"\nüí∞ –ë–∞–ª–∞–Ω—Å: {store.get('balance', 0)} ARS")
            text = "\n".join(lines)

        # –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–µ –æ–∫–Ω–æ –µ—Å—Ç—å ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
        if active_id:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
        else:
            # –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–µ—Ç ‚Äî –∏—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞ –≤ —ç—Ç–æ–º —á–∞—Ç–µ
            messages = get_chat_store(chat_id).get("records", [])
            if messages:
                # –Ω–µ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ
                possible_id = get_today_active_window(chat_id)
                if possible_id:
                    bot.edit_message_text(text, chat_id, possible_id, reply_markup=build_main_keyboard(chat_id))
            else:
                # –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å
                log_info(f"–ù–µ—Ç –æ–∫–Ω–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —á–∞—Ç–µ {chat_id}")
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ–∫–Ω–∞ (–±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ): {e}")

# --------------------------------------------
# –û–¢–°–ï–ö 9 ‚Äî –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞ –Ω–æ–≤–æ–≥–æ –¥–Ω—è (—Å –≤–µ—Ä—Å–∏–µ–π –∫–æ–¥–∞)
# --------------------------------------------

VERSION = "9.8.1.1"

def schedule_daily_window_creation():
    """–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞: —Å–ª–µ–¥–∏—Ç –∑–∞ —Å–º–µ–Ω–æ–π —Å—É—Ç–æ–∫ –∏ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–µ –æ–∫–Ω–æ –≤ –∫–∞–∂–¥–æ–º —á–∞—Ç–µ."""
    def task():
        try:
            last_day = get_today_key()
            while True:
                try:
                    time.sleep(60)  # –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
                    current_day = get_today_key()
                    if current_day != last_day:
                        # –°–º–µ–Ω–∞ —Å—É—Ç–æ–∫ ‚Äî —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—Å–µ—Ö —á–∞—Ç–æ–≤
                        for chat_id_str in list(data.get("chats", {}).keys()):
                            try:
                                chat_id = int(chat_id_str)
                            except Exception:
                                continue
                            text = (
                                f"üóì {current_day}\n"
                                f"ü§ñ –í–µ—Ä—Å–∏—è –±–æ—Ç–∞: {VERSION}\n\n"
                                f"üí∞ –ë–∞–ª–∞–Ω—Å: {get_chat_store(chat_id).get('balance', 0)} ARS"
                            )
                            try:
                                sent = bot.send_message(chat_id, text, reply_markup=build_main_keyboard(chat_id))
                                set_today_active_window(chat_id, sent.message_id)
                                log_info(f"–°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤–æ–µ –æ–∫–Ω–æ –¥–Ω—è {current_day} –¥–ª—è —á–∞—Ç–∞ {chat_id}")
                            except Exception as e:
                                log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –æ–∫–Ω–æ –¥–Ω—è –¥–ª—è {chat_id}: {e}")
                        last_day = current_day
                except Exception as loop_exc:
                    # –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ –≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞ ‚Äî –ª–æ–≥–∏—Ä—É–µ–º –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º (—á—Ç–æ–±—ã –ø–æ—Ç–æ–∫ –Ω–µ —É–º–µ—Ä)
                    log_error(f"–û—à–∏–±–∫–∞ –≤ daily loop: {loop_exc}")
                    time.sleep(5)
        except Exception as e:
            log_error(f"–§–∞—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ schedule_daily_window_creation: {e}")

    thread = threading.Thread(target=task, daemon=True)
    thread.start()

# --------------------------------------------
# –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞
# --------------------------------------------
schedule_daily_window_creation()