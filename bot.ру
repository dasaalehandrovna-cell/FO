# –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è 9.8.3 (—Å –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ–º –∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ–∫–Ω–∞)
# –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: pyTelegramBotAPI, flask
# pip install pyTelegramBotAPI flask

import os
import json
import csv
import logging
import re
import threading
import time
from datetime import datetime
from zoneinfo import ZoneInfo

import telebot
from telebot import types
from flask import Flask, request

# -----------------------------
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# -----------------------------
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")  # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
APP_URL = os.getenv("APP_URL", "https://yourapp.onrender.com")
TZ = ZoneInfo("America/Argentina/Catamarca")
DATA_FILE = "data.json"
CSV_FILE = "data.csv"
LOG_FILE = "log.txt"
PORT = int(os.environ.get("PORT", 5000))
VERSION = "9.8.3"

if not TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# -----------------------------
# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# -----------------------------
logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[logging.FileHandler(LOG_FILE, encoding="utf-8"), logging.StreamHandler()]
)

def log_info(msg):
    logging.info(msg)
def log_error(msg):
    logging.error(msg)

log_info(f"–°—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –í–µ—Ä—Å–∏—è {VERSION}")

# -----------------------------
# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
# -----------------------------
_data_lock = threading.Lock()

def default_data():
    return {
        "overall_balance": 0,
        "records": [],
        "chats": {},                 # chat_id -> store
        "active_messages": {},       # day_key -> { chat_id: message_id }
        "processed_messages": [],
        "forward_targets": [],
        "tracked_messages": {},
        "next_id": 1
    }

def load_data():
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, "r", encoding="utf-8") as f:
                d = json.load(f)
        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ data.json: {e}")
            d = default_data()
    else:
        d = default_data()
    base = default_data()
    for k, v in base.items():
        if k not in d:
            d[k] = v
    return d

def save_data():
    with _data_lock:
        try:
            with open(DATA_FILE, "w", encoding="utf-8") as f:
                json.dump(data, f, ensure_ascii=False, indent=2)
        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è data.json: {e}")

data = load_data()

# –¥–æ–±–∞–≤–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤ forward_targets –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω
if OWNER_ID:
    try:
        oi = int(OWNER_ID)
        if oi not in data.get("forward_targets", []):
            data["forward_targets"].append(oi)
            save_data()
    except Exception:
        pass

# -----------------------------
# –£—Ç–∏–ª–∏—Ç—ã –¥–∞—Ç—ã/—á–∞—Ç–∞
# -----------------------------
def get_today_key():
    return datetime.now(TZ).strftime("%Y-%m-%d")

def get_chat_store(chat_id):
    cid = str(chat_id)
    with _data_lock:
        if cid not in data["chats"]:
            data["chats"][cid] = {
                "balance": 0,
                "records": [],
                "next_id": 1,
                "daily_records": {},
                "active_windows": {},
                "edit_wait": None,
                "edit_target": None
            }
            save_data()
        return data["chats"][cid]

def get_today_active_window(chat_id):
    today = get_today_key()
    day_map = data["active_messages"].get(today, {})
    return day_map.get(str(chat_id))

def set_today_active_window(chat_id, message_id):
    today = get_today_key()
    with _data_lock:
        if "active_messages" not in data:
            data["active_messages"] = {}
        if today not in data["active_messages"]:
            data["active_messages"][today] = {}
        data["active_messages"][today][str(chat_id)] = message_id
        save_data()

# -----------------------------
# –≠–∫—Å–ø–æ—Ä—Ç CSV
# -----------------------------
def export_to_csv():
    try:
        with _data_lock:
            d = data.copy()
        with open(CSV_FILE, "w", newline='', encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
            for cid, cdata in d.get("chats", {}).items():
                for day_key, records in cdata.get("daily_records", {}).items():
                    for r in records:
                        writer.writerow([cid, r.get("id"), r.get("short_id"), r.get("timestamp"), r.get("amount"), r.get("note"), r.get("owner"), day_key])
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ CSV: {e}")

# -----------------------------
# –†–∞–±–æ—Ç–∞ —Å –∑–∞–ø–∏—Å—è–º–∏
# -----------------------------
def _next_global_id():
    with _data_lock:
        nid = data.get("next_id", 1)
        data["next_id"] = nid + 1
        save_data()
    return nid

def add_record_to_chat(chat_id, amount, note, owner):
    store = get_chat_store(chat_id)
    rid = _next_global_id()
    rec = {
        "id": rid,
        "short_id": f"R{rid}",
        "timestamp": datetime.now(TZ).isoformat(timespec="seconds"),
        "amount": amount,
        "note": note,
        "owner": owner
    }
    with _data_lock:
        data.setdefault("records", []).append(rec)
        store.setdefault("records", []).append(rec)
        day = get_today_key()
        store.setdefault("daily_records", {}).setdefault(day, []).append(rec)
        store["balance"] = store.get("balance", 0) + amount
        data["overall_balance"] = data.get("overall_balance", 0) + amount
        save_data()
    try:
        export_to_csv()
    except:
        pass
    return rec

def update_record_in_chat(chat_id, rid, new_amount, new_note):
    store = get_chat_store(chat_id)
    found = None
    with _data_lock:
        for r in store.get("records", []):
            if r["id"] == rid:
                r["amount"] = new_amount
                r["note"] = new_note
                found = r
                break
        if found:
            for day_recs in store.get("daily_records", {}).values():
                for r in day_recs:
                    if r["id"] == rid:
                        r.update(found)
            store["balance"] = sum([x["amount"] for x in store.get("records", [])])
            data["overall_balance"] = sum([x["amount"] for x in data.get("records", [])])
            save_data()
            try:
                export_to_csv()
            except:
                pass
            return True, found
    return False, None

def delete_record_in_chat(chat_id, rid):
    store = get_chat_store(chat_id)
    removed = None
    with _data_lock:
        for r in list(store.get("records", [])):
            if r["id"] == rid or str(r["id"]) == str(rid) or r.get("short_id") == f"R{rid}":
                removed = r
                store["records"].remove(r)
                break
        if removed:
            for day_key, recs in store.get("daily_records", {}).items():
                store["daily_records"][day_key] = [x for x in recs if x["id"] != rid]
            store["balance"] = sum([x["amount"] for x in store.get("records", [])])
            data["records"] = [x for x in data.get("records", []) if x["id"] != rid]
            data["overall_balance"] = sum([x["amount"] for x in data.get("records", [])])
            save_data()
            try:
                export_to_csv()
            except:
                pass
            return True, removed
    return False, None

# -----------------------------
# –ü–∞—Ä—Å–∏–Ω–≥ —Å—É–º–º—ã (—Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã)
# -----------------------------
def parse_amount_token(token: str):
    """
    –ü–∞—Ä—Å–∏—Ç —Ç–æ–∫–µ–Ω —Å—É–º–º—ã –≤ int.
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç—ã: +500, -150, 200 (–±–µ–∑ –∑–Ω–∞–∫–∞ -> —Ä–∞—Å—Ö–æ–¥, —Ç.–µ. -200),
    ^+^500^, ^-^150^, ^+500^ –∏ —Ç.–ø.
    """
    if token is None:
        raise ValueError("–ü—É—Å—Ç–æ–π —Ç–æ–∫–µ–Ω")
    t = str(token).strip().replace("^", "").replace(" ", "")
    if not t:
        raise ValueError("–ü—É—Å—Ç–æ–π —Ç–æ–∫–µ–Ω –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏")
    if t.startswith("+"):
        return int(t[1:])
    if t.startswith("-"):
        return -int(t[1:])
    # –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ –±–µ–∑ –∑–Ω–∞–∫–∞ ‚Äî —Å—á–∏—Ç–∞–µ–º —Ä–∞—Å—Ö–æ–¥ (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ)
    return -int(t)

# -----------------------------
# –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
# -----------------------------
def build_main_keyboard(chat_id=None, confirm_reset=False):
    kb = types.InlineKeyboardMarkup(row_width=3)
    kb.row(
        types.InlineKeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å", callback_data="btn_balance"),
        types.InlineKeyboardButton("üìä –û—Ç—á—ë—Ç", callback_data="btn_report"),
        types.InlineKeyboardButton("üìÇ CSV", callback_data="btn_csv")
    )
    kb.row(types.InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data="btn_edit_list"))
    if confirm_reset:
        kb.row(
            types.InlineKeyboardButton("‚úÖ –î–∞", callback_data="confirm_reset"),
            types.InlineKeyboardButton("‚ùå –ù–µ—Ç", callback_data="cancel_reset")
        )
    else:
        kb.row(types.InlineKeyboardButton("‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ", callback_data="btn_reset"))
    kb.row(
        types.InlineKeyboardButton("üöÄ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="btn_start"),
        types.InlineKeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ", callback_data="btn_cod")
    )
    balance_text = ""
    if chat_id is not None:
        store = get_chat_store(chat_id)
        balance_text = f"üí∞ {store.get('balance', 0)} ARS"
    kb.add(types.InlineKeyboardButton(balance_text or "üí∞ 0 ARS", callback_data="noop"))
    return kb

def build_edit_keyboard_for_record(rid):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("‚úè –ò–∑–º–µ–Ω–∏—Ç—å", callback_data=f"edit_change_{rid}"),
        types.InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å", callback_data=f"edit_delete_{rid}")
    )
    kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="edit_back_to_list"))
    return kb

def build_confirm_delete_keyboard(rid):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(types.InlineKeyboardButton("‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å", callback_data=f"confirm_delete_{rid}"),
           types.InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_delete"))
    return kb

# -----------------------------
# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ / —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –æ–∫–Ω–∞
# -----------------------------
def update_or_send_today_window(chat_id, create_if_missing=True):
    today_key = get_today_key()
    store = get_chat_store(chat_id)
    day_records = store.get("daily_records", {}).get(today_key, [])

    daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
    daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
    overall_balance = store.get("balance", 0)

    if not day_records:
        text = (
            f"üìÖ {today_key}\n"
            f"–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π.\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥: {daily_income} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {abs(daily_expense)} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {overall_balance} ARS"
        )
    else:
        lines = [f"üìÖ {today_key}", "üìã –û–ø–µ—Ä–∞—Ü–∏–∏:"]
        for r in day_records[-50:]:
            sign = "+" if r["amount"] > 0 else "-"
            lines.append(f"{r['short_id']}: {sign}{abs(r['amount'])} ‚Äî {r.get('note','')}")
        lines.append(
            f"\nüíµ –ü—Ä–∏—Ö–æ–¥: {daily_income} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {abs(daily_expense)} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {overall_balance} ARS"
        )
        text = "\n".join(lines)

    kb = build_main_keyboard(chat_id)
    today_msgs = None
    with _data_lock:
        today_msgs = data.setdefault("active_messages", {}).setdefault(today_key, {})
        active_id = today_msgs.get(str(chat_id))

    # –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–µ –æ–∫–Ω–æ –µ—Å—Ç—å ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –µ–≥–æ
    if active_id:
        try:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
        except telebot.apihelper.ApiException as e:
            log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–∫–Ω–æ {active_id} –¥–ª—è —á–∞—Ç–∞ {chat_id}: {e}")
        return

    # –ï—Å–ª–∏ create_if_missing=False ‚Äî –Ω–µ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ
    if not create_if_missing:
        return

    # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ, –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –Ω–µ—Ç
    try:
        sent = bot.send_message(chat_id, text, reply_markup=kb)
        set_today_active_window(chat_id, sent.message_id)
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è {chat_id}: {e}")

# -----------------------------
# –õ–æ–≥–∏–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –æ–∫–Ω–∞ (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å -> —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ —á–µ—Ä–µ–∑ 2—Å –∏ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä–æ–µ —á–µ—Ä–µ–∑ 0.5—Å)
# -----------------------------
def edit_then_duplicate_window(chat_id):
    """
    –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –æ–∫–Ω–æ (–µ—Å–ª–∏ –µ—Å—Ç—å),
    –∑–∞—Ç–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —á–µ—Ä–µ–∑ 0.5 —Å–µ–∫—É–Ω–¥—ã.
    """
    today_key = get_today_key()
    with _data_lock:
        today_msgs = data.setdefault("active_messages", {}).setdefault(today_key, {})
        active_id = today_msgs.get(str(chat_id))

    # 1. –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–∏–º —Å—Ç–∞—Ä–æ–µ –æ–∫–Ω–æ (–µ—Å–ª–∏ –µ—Å—Ç—å) –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ
    update_or_send_today_window(chat_id, create_if_missing=False)

    if not active_id:
        # –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–∫–Ω–∞ ‚Äî —Å–æ–∑–¥–∞—ë–º –æ–±—ã—á–Ω—ã–π (–ø–æ update_or_send_today_window)
        update_or_send_today_window(chat_id, create_if_missing=True)
        return

    def duplicate():
        try:
            time.sleep(2)  # –∂–¥—ë–º 2 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
            # –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–æ)
            sent = bot.send_message(chat_id, "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...", reply_markup=build_main_keyboard(chat_id))
            # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤–æ–µ –∞–∫—Ç–∏–≤–Ω–æ–µ –æ–∫–Ω–æ
            set_today_active_window(chat_id, sent.message_id)
            # —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 0.5—Å–µ–∫ (–¥–∞—ë–º –Ω–µ–±–æ–ª—å—à—É—é –ø–∞—É–∑—É)
            time.sleep(0.5)
            try:
                bot.delete_message(chat_id, active_id)
            except Exception:
                # –µ—Å–ª–∏ –Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
                pass
            # –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            update_or_send_today_window(chat_id, create_if_missing=False)
        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –æ–∫–Ω–∞ –¥–ª—è {chat_id}: {e}")

    threading.Thread(target=duplicate, daemon=True).start()

# -----------------------------
# –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥)
# -----------------------------
def schedule_auto_delete(chat_id, message_id, text):
    # –Ω–µ —É–¥–∞–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ "–±–æ—Ç –∑–∞–ø—É—â–µ–Ω ‚úÖ"
    try:
        if text and text.strip().lower() == "–±–æ—Ç –∑–∞–ø—É—â–µ–Ω ‚úÖ":
            return
        def worker():
            try:
                time.sleep(30)
                try:
                    bot.delete_message(chat_id, message_id)
                except Exception:
                    pass
            except Exception as e:
                log_error(f"–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è {message_id} –≤ {chat_id}: {e}")
        threading.Thread(target=worker, daemon=True).start()
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏—è: {e}")

# -----------------------------
# Callback handler (inline-–∫–Ω–æ–ø–∫–∏)
# -----------------------------
@bot.callback_query_handler(func=lambda c: True)
def handle_callback(call):
    try:
        chat_id = call.message.chat.id
    except Exception:
        return
    store = get_chat_store(chat_id)
    today_key = get_today_key()
    day_records = store.get("daily_records", {}).get(today_key, [])
    today_msgs = data.setdefault("active_messages", {}).setdefault(today_key, {})
    active_id = today_msgs.get(str(chat_id))

    # ---------- –ë–∞–ª–∞–Ω—Å ----------
    if call.data == "btn_balance":
        daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
        daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
        overall_balance = store.get("balance", 0)

        text = (
            f"üìÖ {today_key}\n\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {overall_balance} ARS\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è: {daily_income} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è: {abs(daily_expense)} ARS"
        )

        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–∫–Ω–∞ (–ë–∞–ª–∞–Ω—Å): {e}")
        else:
            update_or_send_today_window(chat_id)

        bot.answer_callback_query(call.id, "–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—ë–Ω ‚úÖ")
        return

    # ---------- –û—Ç—á—ë—Ç (—Ä–∞—Å—Ö–æ–¥—ã) ----------
    if call.data == "btn_report":
        expenses = [r for r in day_records if r["amount"] < 0]
        daily_expense_total = sum(abs(r["amount"]) for r in expenses)

        if not expenses:
            text = f"üìÖ {today_key}\n–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è.\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: 0 ARS"
        else:
            lines = [f"üìÖ {today_key}", "üìã –†–∞—Å—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å:"]
            for r in expenses[-30:]:
                lines.append(f"{r['short_id']}: -{abs(r['amount'])} ‚Äî {r.get('note','')}")
            lines.append(f"\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {daily_expense_total} ARS")
            text = "\n".join(lines)

        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–∫–Ω–∞ (–û—Ç—á—ë—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤): {e}")
        else:
            update_or_send_today_window(chat_id)

        bot.answer_callback_query(call.id, "–û—Ç—á—ë—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –æ–±–Ω–æ–≤–ª—ë–Ω üìä")
        return

    # ---------- CSV ----------
    if call.data == "btn_csv":
        try:
            export_to_csv()
            with open(CSV_FILE, "rb") as f:
                bot.send_document(chat_id, f, caption="üìÇ –í–∞—à —Ñ–∞–π–ª data.csv")
            bot.answer_callback_query(call.id, "CSV –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω üìÅ")
        except Exception as e:
            bot.send_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ CSV: {e}")
            bot.answer_callback_query(call.id)
        return

    # ---------- –û–±–Ω—É–ª–µ–Ω–∏–µ (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º) ----------
    if call.data == "btn_reset":
        if active_id:
            try:
                bot.edit_message_text("‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ:", chat_id, active_id, reply_markup=build_main_keyboard(chat_id, confirm_reset=True))
            except telebot.apihelper.ApiException as e:
                log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–±—Ä–æ—Å–∞: {e}")
        else:
            update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id)
        return

    if call.data == "confirm_reset":
        # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞
        with _data_lock:
            store["records"] = []
            store["daily_records"] = {}
            store["balance"] = 0
            # —Ç–∞–∫–∂–µ —É–¥–∞–ª—è–µ–º –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞–ª–∏ —ç—Ç–æ–º—É —á–∞—Ç—É (owner)
            data["records"] = [x for x in data.get("records", []) if x.get("owner") != chat_id]
            try:
                data["overall_balance"] = sum([x["amount"] for x in data.get("records", [])])
            except:
                data["overall_balance"] = 0
            save_data()
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, "–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã üßπ")
        return

    if call.data == "cancel_reset":
        if active_id:
            try:
                update_or_send_today_window(chat_id)
            except:
                pass
        bot.answer_callback_query(call.id, "–û—Ç–º–µ–Ω–∞")
        return

    # ---------- –û–±–Ω–æ–≤–∏—Ç—å ----------
    if call.data == "btn_start":
        # –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–∫–Ω–∞ (—Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ —á–µ—Ä–µ–∑ 2—Å –∏ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä–æ–µ —á–µ—Ä–µ–∑ 0.5)
        edit_then_duplicate_window(chat_id)
        bot.answer_callback_query(call.id, "–û–∫–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ üîÑ")
        return

    # ---------- –ò–Ω—Ñ–æ (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –≤ —Ç–æ–º –∂–µ –æ–∫–Ω–µ) ----------
    if call.data == "btn_cod":
        info_text = (
            f"‚ÑπÔ∏è –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è {VERSION}\n\n"
            "üìå –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "/start - –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞ –æ—Ç—á—ë—Ç–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è\n"
            "/balance - –ü–æ–∫–∞–∑–∞—Ç—å –æ–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –∑–∞ –¥–µ–Ω—å\n"
            "/report - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è\n"
            "/csv - –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª —Å –∏—Å—Ç–æ—Ä–∏–µ–π –æ–ø–µ—Ä–∞—Ü–∏–π\n"
            "/reset - –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º)\n"
            "/update - –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –æ–∫–Ω–æ\n"
            "/info - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ –æ–∫–Ω–æ —Å–æ —Å–ø–∏—Å–∫–æ–º –∫–æ–º–∞–Ω–¥\n\n"
            "üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π (–≤ —Å–æ–æ–±—â–µ–Ω–∏–∏):\n"
            "+500 –ó–∞—Ä–ø–ª–∞—Ç–∞\n"
            "-150 –û–±–µ–¥\n"
            "200 –¢–∞–∫—Å–∏  (–±–µ–∑ –∑–Ω–∞–∫–∞ = —Ä–∞—Å—Ö–æ–¥)\n\n"
            "‚úèÔ∏è –ù–∞–∂–º–∏—Ç–µ ¬´‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å¬ª, —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø–∏—Å—è–º–∏ (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å/—É–¥–∞–ª—è—Ç—å)."
        )
        if active_id:
            try:
                bot.edit_message_text(info_text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–∫–Ω–∞ (–ò–Ω—Ñ–æ): {e}")
        else:
            try:
                sent = bot.send_message(chat_id, info_text, reply_markup=build_main_keyboard(chat_id))
                set_today_active_window(chat_id, sent.message_id)
            except Exception as e:
                log_error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–Ω—Ñ–æ: {e}")
        bot.answer_callback_query(call.id)
        return

    # ---------- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20) ----------
    if call.data == "btn_edit_list":
        if not day_records:
            text = f"üìÖ {today_key}\n–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è."
            if active_id:
                try:
                    bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
                except telebot.apihelper.ApiException as e:
                    log_error(f"–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–∫–Ω–∞ (–ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è): {e}")
            else:
                update_or_send_today_window(chat_id)
            bot.answer_callback_query(call.id, "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
            return

        lines = [f"üìÖ {today_key}", "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"]
        kb = types.InlineKeyboardMarkup(row_width=1)
        for r in reversed(day_records[-20:]):
            sign = "+" if r["amount"] > 0 else "-"
            label = f"{r['short_id']}: {sign}{abs(r['amount'])} ‚Äî {r.get('note','')}"
            kb.add(types.InlineKeyboardButton(label, callback_data=f"rec_{r['id']}"))
        kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_main"))
        text = "\n".join(lines)

        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            except telebot.apihelper.ApiException as e:
                log_error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —Å–ø–∏—Å–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
        else:
            try:
                sent = bot.send_message(chat_id, text, reply_markup=kb)
                set_today_active_window(chat_id, sent.message_id)
            except Exception as e:
                log_error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–ø–∏—Å–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
        bot.answer_callback_query(call.id)
        return

    # ---------- –í—ã–±–æ—Ä –∑–∞–ø–∏—Å–∏ ----------
    if call.data and call.data.startswith("rec_"):
        try:
            rid = int(call.data.split("_",1)[1])
        except:
            bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID")
            return
        rec = None
        for r in day_records:
            if r["id"] == rid:
                rec = r
                break
        if not rec:
            bot.answer_callback_query(call.id, "–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            return

        sign = "+" if rec["amount"] > 0 else "-"
        text = f"–ó–∞–ø–∏—Å—å {rec['short_id']}\n{sign}{abs(rec['amount'])} ‚Äî {rec.get('note','')}\n–î–æ–±–∞–≤–ª–µ–Ω–∞: {rec.get('timestamp')}"
        kb = build_edit_keyboard_for_record(rid)

        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            except telebot.apihelper.ApiException as e:
                log_error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –¥–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏: {e}")
        else:
            try:
                sent = bot.send_message(chat_id, text, reply_markup=kb)
                set_today_active_window(chat_id, sent.message_id)
            except Exception as e:
                log_error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏: {e}")
        bot.answer_callback_query(call.id)
        return

    # ---------- –ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å (–∏–Ω–∏—Ü–∏–∞—Ü–∏—è) ----------
    if call.data and call.data.startswith("edit_change_"):
        try:
            rid = int(call.data.split("_",2)[2])
        except:
            bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID")
            return
        store["edit_wait"] = "change_value"
        store["edit_target"] = rid
        save_data()
        bot.send_message(chat_id, f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—É–º–º—É –∏ –∑–∞–º–µ—Ç–∫—É –¥–ª—è –∑–∞–ø–∏—Å–∏ R{rid} –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n<—Å—É–º–º–∞> <–∑–∞–º–µ—Ç–∫–∞>\n–ü—Ä–∏–º–µ—Ä—ã:\n+500 –ó–∞—Ä–ø–ª–∞—Ç–∞\n-150 –û–±–µ–¥\n200 –¢–∞–∫—Å–∏ (–±–µ–∑ –∑–Ω–∞–∫–∞ = —Ä–∞—Å—Ö–æ–¥)")
        bot.answer_callback_query(call.id)
        return

    # ---------- –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ) ----------
    if call.data and call.data.startswith("edit_delete_"):
        try:
            rid = int(call.data.split("_",2)[2])
        except:
            bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID")
            return
        if active_id:
            try:
                bot.edit_message_text(f"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ R{rid}:", chat_id, active_id, reply_markup=build_confirm_delete_keyboard(rid))
            except telebot.apihelper.ApiException as e:
                log_error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è: {e}")
        else:
            try:
                sent = bot.send_message(chat_id, f"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ R{rid}:", reply_markup=build_confirm_delete_keyboard(rid))
                set_today_active_window(chat_id, sent.message_id)
            except Exception as e:
                log_error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è: {e}")
        bot.answer_callback_query(call.id)
        return

    # ---------- –ü–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ ----------
    if call.data and call.data.startswith("confirm_delete_"):
        try:
            rid = int(call.data.split("_",2)[2])
        except:
            bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID")
            return
        success, removed = delete_record_in_chat(chat_id, rid)
        store["edit_wait"] = None
        store["edit_target"] = None
        save_data()
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, "–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞" if success else "–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return

    if call.data == "cancel_delete":
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, "–û—Ç–º–µ–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è")
        return

    # ---------- –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∞–∑–∞–¥ ----------
    if call.data in ("back_to_main", "edit_back_to_list", "edit_back"):
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id)
        return

    # noop
    if call.data == "noop":
        bot.answer_callback_query(call.id)
        return

    bot.answer_callback_query(call.id)
    return

# -----------------------------
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–≤–∫–ª—é—á–∞—è –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π –∏ –≤–≤–æ–¥ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è)
# -----------------------------
num_re = re.compile(r'(\^[+-]\^[0-9]+|\^[+-]?[0-9]+\^|[+-]?\s*\d+)')

@bot.message_handler(func=lambda m: True)
def handle_text_message(msg):
    # –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞
    if msg.from_user is None:
        return
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    wait_action = store.get("edit_wait")

    # –ü–ª–∞–Ω–∏—Ä—É–µ–º –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ –ª—é–±–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–Ω–µ –±–æ—Ç–∞)
    if msg.text:
        try:
            schedule_auto_delete(chat_id, msg.message_id, msg.text)
        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏—è: {e}")

    # –ï—Å–ª–∏ –æ–∂–∏–¥–∞–µ–º –≤–≤–æ–¥ –≤—Ä—É—á–Ω—É—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    if wait_action == "change_value":
        rid = store.get("edit_target")
        if not rid:
            store["edit_wait"] = None
            store["edit_target"] = None
            save_data()
            return
        parts = msg.text.strip().split(" ", 1)
        try:
            raw = parts[0]
            amount = parse_amount_token(raw)
            note = parts[1] if len(parts) > 1 else ""
            success, _ = update_record_in_chat(chat_id, rid, amount, note)
            store["edit_wait"] = None
            store["edit_target"] = None
            save_data()
            edit_then_duplicate_window(chat_id)
            bot.send_message(chat_id, f"‚úÖ –ó–∞–ø–∏—Å—å R{rid} {'–∏–∑–º–µ–Ω–µ–Ω–∞' if success else '–Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}")
        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –≤—Ä—É—á–Ω—É—é: {e}")
            bot.send_message(chat_id, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ —Å—É–º–º—ã. –í–≤–µ–¥–∏—Ç–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ +500 –ó–∞—Ä–ø–ª–∞—Ç–∞ –∏–ª–∏ ^+^500^ –ó–∞—Ä–ø–ª–∞—Ç–∞ –∏–ª–∏ -150 –û–±–µ–¥")
        return

    # –û–±—ã—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏. –ù–∞—Ö–æ–¥–∏–º —Ç–æ–∫–µ–Ω —Å —Å—É–º–º–æ–π.
    if not msg.text:
        return
    m = num_re.search(msg.text)
    if m:
        try:
            raw = m.group(0)
            raw_clean = raw.replace("^", "").replace(" ", "")
            amount = parse_amount_token(raw_clean)
            note = msg.text.replace(m.group(0), "").strip()
            add_record_to_chat(chat_id, amount, note, msg.from_user.id)
            # –æ–±–Ω–æ–≤–ª—è–µ–º –æ–∫–Ω–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
            edit_then_duplicate_window(chat_id)
        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ –∞–≤—Ç–æ-–¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏: {e}")
    return

# -----------------------------
# –ö–æ–º–∞–Ω–¥—ã
# -----------------------------
@bot.message_handler(commands=["start"])
def handle_start(msg):
    chat_id = msg.chat.id
    update_or_send_today_window(chat_id, create_if_missing=True)
    # –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∫–æ—Ç–æ—Ä–æ–µ —É–¥–∞–ª–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 30s)
    try:
        bot.send_message(chat_id, "–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω ‚úÖ")
    except Exception:
        pass

@bot.message_handler(commands=["balance"])
def cmd_balance(msg):
    chat_id = msg.chat.id
    update_or_send_today_window(chat_id)
    bot.reply_to(msg, "–ë–∞–ª–∞–Ω—Å –≤—ã–≤–µ–¥–µ–Ω –≤ –æ–∫–Ω–µ.")

@bot.message_handler(commands=["report"])
def cmd_report(msg):
    chat_id = msg.chat.id
    update_or_send_today_window(chat_id)
    bot.reply_to(msg, "–û—Ç—á—ë—Ç –≤—ã–≤–µ–¥–µ–Ω –≤ –æ–∫–Ω–µ.")

@bot.message_handler(commands=["csv"])
def cmd_csv(msg):
    chat_id = msg.chat.id
    try:
        export_to_csv()
        with open(CSV_FILE, "rb") as f:
            bot.send_document(chat_id, f, caption="üìÇ –í–∞—à —Ñ–∞–π–ª data.csv")
    except Exception as e:
        bot.reply_to(msg, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ CSV: {e}")

@bot.message_handler(commands=["reset"])
def cmd_reset(msg):
    chat_id = msg.chat.id
    update_or_send_today_window(chat_id)
    today_key = get_today_key()
    active_id = get_today_active_window(chat_id)
    if active_id:
        try:
            bot.edit_message_text("‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ:", chat_id, active_id, reply_markup=build_main_keyboard(chat_id, confirm_reset=True))
        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–±—Ä–æ—Å–∞: {e}")
    else:
        update_or_send_today_window(chat_id)

# -----------------------------
# Flask webhook (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# -----------------------------
@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    update = telebot.types.Update.de_json(request.get_data().decode("utf-8"))
    bot.process_new_updates([update])
    return "OK", 200

@app.route("/", methods=["GET"])
def index():
    return f"–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ¬´–§–û¬ª ‚Äî –≤–µ—Ä—Å–∏—è {VERSION} —Ä–∞–±–æ—Ç–∞–µ—Ç", 200

def set_webhook():
    url = f"{APP_URL}/{TOKEN}"
    try:
        bot.remove_webhook()
        time.sleep(0.5)
        bot.set_webhook(url=url)
        log_info(f"Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {url}")
    except Exception as e:
        log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook: {e}")

# -----------------------------
# –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Å–º–µ–Ω—ã –¥–Ω—è ‚Äî —Å–æ–∑–¥–∞—ë—Ç –æ–∫–Ω–æ –Ω–æ–≤–æ–≥–æ –¥–Ω—è —É –≤—Å–µ—Ö —á–∞—Ç–æ–≤
# -----------------------------
def schedule_daily_window_creation():
    def task():
        last_day = get_today_key()
        while True:
            try:
                time.sleep(60)
                current_day = get_today_key()
                if current_day != last_day:
                    with _data_lock:
                        chat_ids = list(data.get("chats", {}).keys())
                    for chat_id_str in chat_ids:
                        try:
                            chat_id = int(chat_id_str)
                        except:
                            continue
                        try:
                            update_or_send_today_window(chat_id)
                        except Exception as e:
                            log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–∫–Ω–∞ –Ω–æ–≤–æ–≥–æ –¥–Ω—è –¥–ª—è {chat_id}: {e}")
                    last_day = current_day
            except Exception as e:
                log_error(f"–û—à–∏–±–∫–∞ –≤ daily loop: {e}")
                time.sleep(5)
    thread = threading.Thread(target=task, daemon=True)
    thread.start()

# -----------------------------
# –ó–∞–ø—É—Å–∫
# -----------------------------
if __name__ == "__main__":
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º webhook, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ APP_URL (–º–æ–∂–Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å Flask)
    try:
        set_webhook()
    except Exception:
        pass

    schedule_daily_window_creation()
    log_info(f"–ë–æ—Ç –§–û –≤–µ—Ä—Å–∏–∏ {VERSION} –∑–∞–ø—É—â–µ–Ω")

    # —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É
    try:
        if OWNER_ID:
            bot.send_message(int(OWNER_ID), f"‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! (–≤–µ—Ä—Å–∏—è {VERSION})")
    except Exception as e:
        log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ: {e}")

    # –ó–∞–ø—É—Å–∫ Flask (–¥–ª—è webhook). –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ bot.polling()
    app.run(host="0.0.0.0", port=PORT)