# ============================================================
# üßæ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è 9.8.6-fo_6+GDriveOnly (UI-full)
# ID Code_019e
# ============================================================
# üß≠ –û–ø–∏—Å–∞–Ω–∏–µ:
#  ‚Ä¢ –ü–æ–ª–Ω—ã–π UI –∫–∞–∫ –≤ 9.8.6-fo_6: –æ–∫–Ω–æ –¥–Ω—è, –∫–Ω–æ–ø–∫–∏, –º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è,
#    –Ω–∞–≤–∏–≥–∞—Ü–∏—è /prev /next /view, –∫–∞–ª–µ–Ω–¥–∞—Ä—å 31 –¥–µ–Ω—å, –æ—Ç—á—ë—Ç—ã, –ø–µ—Ä–µ—Å—á—ë—Ç—ã
#  ‚Ä¢ ‚òÅÔ∏è –ë—ç–∫–∞–ø –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ Google Drive (–±–µ–∑ –∫–∞–Ω–∞–ª–æ–≤, –±–µ–∑ file_id)
#  ‚Ä¢ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è GDrive —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é SERVICE_ACCOUNT_JSON
#  ‚Ä¢ –ü–æ—Å–ª–µ –ö–ê–ñ–î–û–ì–û –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –∞–ø–ª–æ–∞–¥: data.json, data.csv, csv_meta.json
#  ‚Ä¢ –ê–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å Drive –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ, –µ—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç
#  ‚Ä¢ üîÅ –ê–≤—Ç–æ-—É–¥–≤–æ–µ–Ω–∏–µ –≤—Å–µ—Ö –∏–Ω—Ñ–æ-—Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ 30—Å (–∫—Ä–æ–º–µ ‚Äú–±–æ—Ç –∑–∞–ø—É—â–µ–Ω‚Äù)
#  ‚Ä¢ Keep-alive, webhook/polling, –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ–∫–Ω–∞ –Ω–æ–≤–æ–≥–æ –¥–Ω—è
# ============================================================

# ========== –û–¢–°–ï–ö 1 ‚Äî –ò–º–ø–æ—Ä—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ==========
import os
import io
import json
import csv
import re
import html
import logging
import threading
import time
from datetime import datetime, timedelta, timezone
from zoneinfo import ZoneInfo

import requests
import telebot
from telebot import types
from flask import Flask, request

# --- Google Drive ---
from googleapiclient.discovery import build
from google.oauth2 import service_account
from googleapiclient.http import MediaFileUpload, MediaIoBaseDownload

# -----------------------------
# ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
# -----------------------------
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")
APP_URL = os.getenv("APP_URL", "https://yourapp.onrender.com")
PORT = int(os.getenv("PORT", 5000))
VERSION = "9.8.6-fo_6+GDriveOnly"

try:
    TZ = ZoneInfo((os.getenv("TZ") or "America/Argentina/Buenos_Aires").strip())
except Exception:
    TZ = timezone(timedelta(hours=-3))

DATA_FILE = "data.json"
CSV_FILE = "data.csv"
CSV_META_FILE = "csv_meta.json"
LOG_FILE = "log.txt"

KEEP_ALIVE_INTERVAL_SECONDS = int(os.getenv("KEEP_ALIVE_INTERVAL_SECONDS", 11 * 60))
KEEP_ALIVE_SEND_TO_OWNER = True

# Google Drive ENV
SERVICE_ACCOUNT_JSON = os.getenv("SERVICE_ACCOUNT_JSON")  # —Å—Ç—Ä–æ–∫–∞ JSON —Ü–µ–ª–∏–∫–æ–º
GDRIVE_FOLDER_ID = os.getenv("GDRIVE_FOLDER_ID")          # –∏–º—è –∏–ª–∏ ID –ø–∞–ø–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

if not TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# -----------------------------
# üßæ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# -----------------------------
logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[logging.FileHandler(LOG_FILE, encoding="utf-8"), logging.StreamHandler()]
)
def log_info(msg): logging.info(msg)
def log_error(msg): logging.error(msg)

log_info(f"üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ {VERSION}")

# -----------------------------
# ‚è±Ô∏è –í—Ä–µ–º—è –∏ —á–∏—Å–ª–∞
# -----------------------------
def now_local() -> datetime: return datetime.now(TZ)
def today_key() -> str: return now_local().strftime("%Y-%m-%d")
def parse_date_key(s: str):
    try: return datetime.strptime(s, "%Y-%m-%d").date()
    except: return None
def shift_date_key(day_key: str, days: int) -> str:
    d = parse_date_key(day_key) or now_local().date()
    return (d + timedelta(days=days)).strftime("%Y-%m-%d")
def fmt_num(value):
    try: return f"{value:,.0f}".replace(",", ".")
    except: return str(value)

# -----------------------------
# üîÅ –ê–≤—Ç–æ-—É–¥–≤–æ–µ–Ω–∏–µ –∏–Ω—Ñ–æ-—Å–æ–æ–±—â–µ–Ω–∏–π
# -----------------------------
def auto_double_message(chat_id, text):
    if "–±–æ—Ç –∑–∞–ø—É—â–µ–Ω" in (text or "").lower():
        return
    def delayed():
        time.sleep(30)
        try:
            bot.send_message(chat_id, text, parse_mode="HTML")
        except Exception as e:
            log_error(f"auto_double_message: {e}")
    threading.Thread(target=delayed, daemon=True).start()

def send_info(chat_id, text):
    try:
        bot.send_message(chat_id, text, parse_mode="HTML")
        auto_double_message(chat_id, text)
    except Exception as e:
        log_error(f"send_info: {e}")

def send_temp_message(chat_id, text, delay=5):
    msg = bot.send_message(chat_id, text)
    threading.Timer(delay, lambda: bot.delete_message(chat_id, msg.message_id)).start()

# ====== –ß–ê–°–¢–¨ 2/5 ==========================================
# üß© I/O (JSON/CSV) + Google Drive –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏

# ---------- –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π JSON ----------
def _load_json(path, fallback):
    try:
        if os.path.exists(path):
            with open(path, "r", encoding="utf-8") as f:
                return json.load(f)
    except Exception as e:
        log_error(f"_load_json: {path}: {e}")
    return fallback

def _save_json(path, payload):
    try:
        with open(path, "w", encoding="utf-8") as f:
            json.dump(payload, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"_save_json: {path}: {e}")

# ---------- –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö ----------
def default_data():
    return {
        "overall_balance": 0,
        "records": [],
        "chats": {},
        "active_messages": {},
        "next_id": 1
    }

def load_data():
    d = _load_json(DATA_FILE, default_data())
    base = default_data()
    for k, v in base.items():
        if k not in d:
            d[k] = v
    return d

def save_data(d):
    try:
        _save_json(DATA_FILE, d)
        export_to_csv(d)
        log_info("üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ.")
    except Exception as e:
        log_error(f"save_data: {e}")

# ---------- CSV —ç–∫—Å–ø–æ—Ä—Ç ----------
def export_to_csv(d):
    try:
        with open(CSV_FILE, "w", newline="", encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
            for cid, cdata in d.get("chats", {}).items():
                for dk, records in cdata.get("daily_records", {}).items():
                    for r in records:
                        writer.writerow([
                            cid,
                            r.get("id"), r.get("short_id"), r.get("timestamp"),
                            r.get("amount"), r.get("note"), r.get("owner"), dk
                        ])
    except Exception as e:
        log_error(f"export_to_csv: {e}")

# ---------- csv_meta ----------
def _load_csv_meta():
    return _load_json(CSV_META_FILE, {})

def _save_csv_meta(meta: dict):
    try:
        _save_json(CSV_META_FILE, meta)
        log_info("üíæ csv_meta.json –æ–±–Ω–æ–≤–ª—ë–Ω")
    except Exception as e:
        log_error(f"_save_csv_meta: {e}")

# ---------- Google Drive auth ----------
def _build_gdrive_credentials():
    if not SERVICE_ACCOUNT_JSON:
        raise RuntimeError("SERVICE_ACCOUNT_JSON –Ω–µ –∑–∞–¥–∞–Ω–∞")
    try:
        sa_info = json.loads(SERVICE_ACCOUNT_JSON)
        scopes = ["https://www.googleapis.com/auth/drive"]
        return service_account.Credentials.from_service_account_info(sa_info, scopes=scopes)
    except Exception as e:
        log_error(f"GDrive creds error: {e}")
        raise

def _drive_service():
    creds = _build_gdrive_credentials()
    return build("drive", "v3", credentials=creds, cache_discovery=False)

def _gdrive_find_folder(service, name_or_id):
    if name_or_id and re.fullmatch(r"[A-Za-z0-9_-]{10,}", name_or_id):
        return name_or_id
    if not name_or_id:
        return None
    q = f"mimeType='application/vnd.google-apps.folder' and name='{name_or_id}' and trashed=false"
    res = service.files().list(q=q, spaces="drive", fields="files(id,name)", pageSize=10).execute()
    files = res.get("files", [])
    return files[0]["id"] if files else None

def _gdrive_find_file(service, filename, folder_id=None):
    if folder_id:
        q = f"name='{filename}' and '{folder_id}' in parents and trashed=false"
    else:
        q = f"name='{filename}' and trashed=false"
    res = service.files().list(q=q, spaces="drive", fields="files(id,name)", pageSize=5).execute()
    files = res.get("files", [])
    return files[0]["id"] if files else None

def _guess_mime(path):
    n = os.path.basename(path).lower()
    if n.endswith(".json"): return "application/json"
    if n.endswith(".csv"):  return "text/csv"
    return "application/octet-stream"

def _gdrive_upload(service, local_path, folder_id=None):
    name = os.path.basename(local_path)
    file_id = _gdrive_find_file(service, name, folder_id)
    media = MediaFileUpload(local_path, mimetype=_guess_mime(local_path), resumable=True)
    if file_id:
        return service.files().update(fileId=file_id, media_body=media).execute().get("id")
    meta = {"name": name}
    if folder_id: meta["parents"] = [folder_id]
    return service.files().create(body=meta, media_body=media, fields="id").execute().get("id")

def _gdrive_download(service, filename, dest_path, folder_id=None):
    file_id = _gdrive_find_file(service, filename, folder_id)
    if not file_id:
        return False
    req = service.files().get_media(fileId=file_id)
    fh = io.FileIO(dest_path, "wb")
    downloader = MediaIoBaseDownload(fh, req)
    done = False
    while not done:
        status, done = downloader.next_chunk()
    return True

def upload_to_gdrive(path):
    try:
        service = _drive_service()
        folder_id = _gdrive_find_folder(service, GDRIVE_FOLDER_ID) if GDRIVE_FOLDER_ID else None
        fid = _gdrive_upload(service, path, folder_id)
        log_info(f"‚òÅÔ∏è Upload OK: {os.path.basename(path)} ‚Üí {fid}")
        return fid
    except Exception as e:
        log_error(f"upload_to_gdrive({path}): {e}")
        return None

def download_from_gdrive(filename, dest):
    try:
        service = _drive_service()
        folder_id = _gdrive_find_folder(service, GDRIVE_FOLDER_ID) if GDRIVE_FOLDER_ID else None
        ok = _gdrive_download(service, filename, dest, folder_id)
        if ok: log_info(f"‚òÅÔ∏è Download OK: {filename} ‚Üí {dest}")
        else:  log_info(f"‚òÅÔ∏è Download MISS: {filename} (–Ω–µ –Ω–∞–π–¥–µ–Ω)")
        return ok
    except Exception as e:
        log_error(f"download_from_gdrive({filename}): {e}")
        return False

# ---------- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ----------
def restore_from_gdrive_if_needed():
    need = []
    if not os.path.exists(DATA_FILE): need.append(DATA_FILE)
    if not os.path.exists(CSV_FILE): need.append(CSV_FILE)
    if not os.path.exists(CSV_META_FILE): need.append(CSV_META_FILE)
    if not need:
        return
    if OWNER_ID:
        send_info(int(OWNER_ID), "‚òÅÔ∏è –ü—ã—Ç–∞—é—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã —Å Google Drive‚Ä¶")
    for fn in [CSV_META_FILE, DATA_FILE, CSV_FILE]:
        if fn in need:
            download_from_gdrive(fn, fn)
    if not os.path.exists(DATA_FILE): _save_json(DATA_FILE, default_data())
    if not os.path.exists(CSV_META_FILE): _save_json(CSV_META_FILE, {})


# ====== –ß–ê–°–¢–¨ 3/5 ==========================================
# üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ Drive + —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ —á–∞—Ç–∞–º + UI (–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã, —Ä–µ–Ω–¥–µ—Ä)

# ---------- –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–∞ Drive ----------
def _sync_all_backups_gdrive(d):
    try:
        save_data(d)  # –ª–æ–∫–∞–ª—å–Ω–æ: data.json + csv
        meta = _load_csv_meta()
        meta["last_sync"] = now_local().isoformat(timespec="seconds")
        _save_csv_meta(meta)
        for p in (DATA_FILE, CSV_FILE, CSV_META_FILE):
            upload_to_gdrive(p)
    except Exception as e:
        log_error(f"_sync_all_backups_gdrive: {e}")

def sync_all_backups_gdrive_async(d):
    threading.Thread(target=_sync_all_backups_gdrive, args=(d,), daemon=True).start()

# ---------- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ----------
restore_from_gdrive_if_needed()
data = load_data()

# ---------- –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ —á–∞—Ç–∞–º ----------
def get_chat_store(chat_id: int) -> dict:
    cid = str(chat_id)
    if cid not in data["chats"]:
        data["chats"][cid] = {
            "balance": 0,
            "records": [],
            "next_id": 1,
            "daily_records": {},
            "active_windows": {},
            "edit_wait": None,
            "edit_target": None,
            "current_view_day": today_key()
        }
        save_data(data); sync_all_backups_gdrive_async(data)
    store = data["chats"][cid]
    store.setdefault("current_view_day", today_key())
    return store

def set_current_view_day(chat_id: int, day_key: str):
    store = get_chat_store(chat_id)
    store["current_view_day"] = day_key
    save_data(data); sync_all_backups_gdrive_async(data)

def get_current_view_day(chat_id: int) -> str:
    return get_chat_store(chat_id).get("current_view_day", today_key())

def get_active_window_id(chat_id: int, day_key: str):
    return data.setdefault("active_messages", {}).setdefault(day_key, {}).get(str(chat_id))

def set_active_window(chat_id: int, day_key: str, message_id: int):
    data.setdefault("active_messages", {}).setdefault(day_key, {})[str(chat_id)] = message_id
    save_data(data); sync_all_backups_gdrive_async(data)

def clear_active_window(chat_id: int, day_key: str):
    am = data.setdefault("active_messages", {}).setdefault(day_key, {})
    if str(chat_id) in am:
        am.pop(str(chat_id), None)
        save_data(data); sync_all_backups_gdrive_async(data)

def delete_message_safe(chat_id: int, message_id: int):
    try:
        bot.delete_message(chat_id, message_id)
    except Exception:
        pass

def delete_active_window_if_exists(chat_id: int, day_key: str):
    old_id = get_active_window_id(chat_id, day_key)
    if old_id:
        delete_message_safe(chat_id, old_id)
        clear_active_window(chat_id, day_key)

# ---------- UI –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã ----------
def build_main_keyboard(day_key: str, chat_id: int | None = None):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å", callback_data=f"d:{day_key}:balance"),
        types.InlineKeyboardButton("üìä –û—Ç—á—ë—Ç", callback_data=f"d:{day_key}:report"),
    )
    kb.row(
        types.InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data=f"d:{day_key}:refresh"),
        types.InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"d:{day_key}:edit_menu"),
    )
    total = fmt_num(data.get("overall_balance", 0))
    kb.add(types.InlineKeyboardButton(f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {total} ARS", callback_data=f"d:{day_key}:total"))
    return kb

def build_edit_menu_keyboard(day_key: str, chat_id=None):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å", callback_data=f"d:{day_key}:edit_list"),
        types.InlineKeyboardButton("üìÇ –û–±—â–∏–π CSV", callback_data=f"d:{day_key}:csv_all")
    )
    kb.row(
        types.InlineKeyboardButton("üìÖ CSV –∑–∞ –¥–µ–Ω—å", callback_data=f"d:{day_key}:csv_day"),
        types.InlineKeyboardButton("‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å", callback_data=f"d:{day_key}:reset")
    )
    kb.row(
        types.InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data=f"d:{today_key()}:open"),
        types.InlineKeyboardButton("üìÜ –í—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å", callback_data=f"d:{day_key}:pick_date")
    )
    kb.row(
        types.InlineKeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ", callback_data=f"d:{day_key}:info"),
        types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:back_main")
    )
    return kb

def build_edit_keyboard_for_record(day_key: str, rid: int):
    kb = types.InlineKeyboardMarkup(row_width=1)
    kb.add(types.InlineKeyboardButton("‚úè –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é", callback_data=f"d:{day_key}:edit_manual:{rid}"))
    kb.add(types.InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å", callback_data=f"d:{day_key}:edit_delete:{rid}"))
    kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:edit_back"))
    return kb

def build_confirm_delete_keyboard(day_key: str, rid: int):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å", callback_data=f"d:{day_key}:confirm_delete:{rid}"),
        types.InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data=f"d:{day_key}:cancel_delete")
    )
    return kb

def build_reset_confirm_keyboard(day_key: str):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("‚úÖ –î–∞, –æ–±–Ω—É–ª–∏—Ç—å", callback_data=f"d:{day_key}:confirm_reset_all"),
        types.InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data=f"d:{day_key}:cancel_reset_all")
    )
    return kb

def build_last_31days_calendar():
    today = now_local().date()
    days = [today - timedelta(days=i) for i in range(0, 31)]
    kb = types.InlineKeyboardMarkup()
    row = []
    for idx, d in enumerate(days, start=1):
        label = d.strftime("%d/%m"); dk = d.strftime("%Y-%m-%d")
        row.append(types.InlineKeyboardButton(text=label, callback_data=f"d:{dk}:calopen"))
        if idx % 7 == 0:
            kb.row(*row); row = []
    if row: kb.row(*row)
    return kb

# ---------- –†–µ–Ω–¥–µ—Ä –æ–∫–Ω–∞ –¥–Ω—è ----------
def render_day_text(store: dict, day_key: str) -> str:
    day_records = store.get("daily_records", {}).get(day_key, [])
    daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
    daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
    overall_balance = store.get("balance", 0)

    if not day_records:
        text = (
            f"üìÖ {day_key}\n"
            f"–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å.\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥: {fmt_num(daily_income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {fmt_num(abs(daily_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall_balance)} ARS"
        )
    else:
        lines = [f"üìÖ {day_key}", "üìã –û–ø–µ—Ä–∞—Ü–∏–∏:"]
        for r in day_records[-50:]:
            sign = "+" if r["amount"] > 0 else "-"
            lines.append(f"{r['short_id']}: {sign}{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
        lines.append(
            f"\nüíµ –ü—Ä–∏—Ö–æ–¥: {fmt_num(daily_income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {fmt_num(abs(daily_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall_balance)} ARS"
        )
        text = "\n".join(lines)
    return text


# ====== –ß–ê–°–¢–¨ 4/5 ==========================================
# ü™û –û–∫–Ω–æ –¥–Ω—è, –æ–ø–µ—Ä–∞—Ü–∏–∏ (add/update/delete), callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –∫–æ–º–∞–Ω–¥—ã

def update_or_send_day_window(
    chat_id: int,
    day_key: str = None,
    create_if_missing: bool = True,
    force_new: bool = False,
    delete_target_old: bool = False,
    delete_source_old: bool = False,
    source_day_key: str | None = None
):
    day_key = day_key or today_key()
    store = get_chat_store(chat_id)

    if delete_target_old:
        delete_active_window_if_exists(chat_id, day_key)
    if delete_source_old and source_day_key and source_day_key != day_key:
        delete_active_window_if_exists(chat_id, source_day_key)

    set_current_view_day(chat_id, day_key)

    text = render_day_text(store, day_key)
    kb = build_main_keyboard(day_key, chat_id)
    active_id = get_active_window_id(chat_id, day_key)

    if not force_new and active_id:
        try:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            return
        except telebot.apihelper.ApiException as e:
            log_error(f"edit_message_text: {e}")

    if not create_if_missing and not force_new:
        return

    try:
        sent = bot.send_message(chat_id, text, reply_markup=kb)
        set_active_window(chat_id, day_key, sent.message_id)
    except Exception as e:
        log_error(f"send new window: {e}")

# ---------- –û–ø–µ—Ä–∞—Ü–∏–∏ ----------
def add_record_to_chat(chat_id: int, amount: int, note: str, owner):
    store = get_chat_store(chat_id)
    rid = data.get("next_id", 1)
    rec = {
        "id": rid,
        "short_id": f"R{rid}",
        "timestamp": now_local().isoformat(timespec="seconds"),
        "amount": amount,
        "note": note,
        "owner": owner
    }

    data.setdefault("records", []).append(rec)
    store.setdefault("records", []).append(rec)
    day = today_key()
    store.setdefault("daily_records", {}).setdefault(day, []).append(rec)

    store["balance"] = store.get("balance", 0) + amount
    data["overall_balance"] = data.get("overall_balance", 0) + amount
    data["next_id"] = rid + 1

    save_data(data)                          # –ª–æ–∫–∞–ª—å–Ω–æ
    update_or_send_day_window(chat_id, day)  # —Å–Ω–∞—á–∞–ª–∞ UI
    sync_all_backups_gdrive_async(data)      # –∑–∞—Ç–µ–º GDrive

    return rec

def update_record_in_chat(chat_id: int, rid: int, new_amount: int, new_note: str, user=None):
    store = get_chat_store(chat_id)
    found = None
    for r in store.get("records", []):
        if r["id"] == rid:
            r["amount"] = new_amount
            r["note"] = new_note
            found = r
            break
    if found:
        for day_recs in store.get("daily_records", {}).values():
            for r in day_recs:
                if r["id"] == rid:
                    r.update(found)
        store["balance"] = sum(x["amount"] for x in store.get("records", []))
        data["records"] = [x if x["id"] != rid else found for x in data.get("records", [])]
        data["overall_balance"] = sum(x["amount"] for x in data.get("records", []))

        save_data(data)
        sync_all_backups_gdrive_async(data)
        return True, found
    return False, None

def delete_record_in_chat(chat_id: int, rid: int, user=None):
    store = get_chat_store(chat_id)
    removed = None
    for r in list(store.get("records", [])):
        if r["id"] == rid:
            removed = r
            store["records"].remove(r)
            break
    if removed:
        for dk, recs in store.get("daily_records", {}).items():
            store["daily_records"][dk] = [x for x in recs if x["id"] != rid]
        store["balance"] = sum(x["amount"] for x in store.get("records", []))
        data["records"] = [x for x in data.get("records", []) if x["id"] != rid]
        data["overall_balance"] = sum(x["amount"] for x in data.get("records", []))

        save_data(data)
        update_or_send_day_window(chat_id, today_key())
        sync_all_backups_gdrive_async(data)
        return True, removed
    return False, None

# ---------- –ü–∞—Ä—Å–µ—Ä —Å—É–º–º ----------
num_re = re.compile(r'(\^[+-]\^[0-9]+|\^[+-]?[0-9]+\^|[+-]?\s*\d+)')
def parse_amount_token(token: str) -> int:
    t = token.strip()
    for ch in ["^", " ", ".", ",", "-", "_", "'", '"']:
        t = t.replace(ch, "")
    if not t: return 0
    if t[0] == "+": return int(t[1:])
    if t[0] == "-": return -int(t[1:])
    return -int(t)

# ---------- Callback ----------
@bot.callback_query_handler(func=lambda c: True)
def handle_callback(call):
    try:
        chat_id = call.message.chat.id
    except Exception:
        return

    data_str = call.data or ""
    if not data_str.startswith("d:"):
        update_or_send_day_window(chat_id, today_key())
        bot.answer_callback_query(call.id); return

    parts = data_str.split(":")
    if len(parts) < 3:
        bot.answer_callback_query(call.id); return

    day_key = parts[1]
    action_tail = parts[2:]
    action = action_tail[0] if action_tail else ""
    store = get_chat_store(chat_id)
    prev_day = get_current_view_day(chat_id)
    set_current_view_day(chat_id, day_key)

    if action == "calopen":
        update_or_send_day_window(chat_id, day_key, True, True, True, True, prev_day)
        bot.answer_callback_query(call.id, f"–û—Ç–∫—Ä—ã—Ç –¥–µ–Ω—å {day_key}"); return

    if action == "open":
        update_or_send_day_window(chat_id, day_key, True, True, True, False, prev_day)
        bot.answer_callback_query(call.id, f"–û—Ç–∫—Ä—ã—Ç –¥–µ–Ω—å {day_key}"); return

    if action == "pick_date":
        kb = build_last_31days_calendar()
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try: bot.edit_message_text("üóì –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 31 –¥–µ–Ω—å):", chat_id, active_id, reply_markup=kb)
            except telebot.apihelper.ApiException as e: log_error(f"calendar edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id); return

    if action == "edit_menu":
        text = (
            "‚úèÔ∏è –ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n\n"
            "üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é\n"
            "üìÇ –û–±—â–∏–π CSV ‚Äî –ø–æ–ª–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç (–≤ Drive)\n"
            "üìÖ CSV –∑–∞ –¥–µ–Ω—å ‚Äî —ç–∫—Å–ø–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã (–≤ —Ñ–∞–π–ª –ª–æ–∫–∞–ª—å–Ω–æ)\n"
            "‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞\n\n"
            "üìÖ –°–µ–≥–æ–¥–Ω—è / üìÜ –í—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å / ‚ÑπÔ∏è –ò–Ω—Ñ–æ / üîô –ù–∞–∑–∞–¥"
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try: bot.edit_message_text(text, chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e: log_error(f"edit_menu edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key, True)
        bot.answer_callback_query(call.id, "–ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚úèÔ∏è"); return

    if action == "refresh":
        active_id = get_active_window_id(chat_id, day_key)
        text = render_day_text(store, day_key)
        if active_id:
            try: bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e: log_error(f"refresh edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key, True)
        bot.answer_callback_query(call.id, "–û–±–Ω–æ–≤–ª–µ–Ω–æ üîÑ"); return

    if action == "info":
        info_text = (
            f"‚ÑπÔ∏è –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è {VERSION}\n\n"
            "–ö–æ–º–∞–Ω–¥—ã:\n"
            "/start ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –∑–∞ —Å–µ–≥–æ–¥–Ω—è\n"
            "/view YYYY-MM-DD ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –¥–µ–Ω—å\n"
            "/prev /next ‚Äî –Ω–∞–≤–∏–≥–∞—Ü–∏—è\n"
            "/balance ‚Äî –æ—Å—Ç–∞—Ç–æ–∫ –∑–∞ –¥–µ–Ω—å\n"
            "/report ‚Äî —Å–ø–∏—Å–æ–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤\n"
            "/csv ‚Äî –æ–±—â–∏–π CSV ‚Üí –∑–∞–≥—Ä—É–∑–∫–∞ –≤ Drive\n"
            "/reset ‚Äî –æ–±–Ω—É–ª–µ–Ω–∏–µ —á–∞—Ç–∞\n"
            "/ping ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\n"
            "/help ‚Äî –ø–æ–º–æ—â—å\n"
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try: bot.edit_message_text(info_text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e: log_error(f"info edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id); return

    if action == "balance":
        day_records = store.get("daily_records", {}).get(day_key, [])
        inc = sum(r["amount"] for r in day_records if r["amount"] > 0)
        exp = sum(r["amount"] for r in day_records if r["amount"] < 0)
        overall = store.get("balance", 0)
        text = (
            f"üìÖ {day_key}\n\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(inc)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(abs(exp))} ARS\n"
            f"üí∞ –û—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall)} ARS"
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try: bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e: log_error(f"balance edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, "–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—ë–Ω ‚úÖ"); return

    if action == "total":
        all_records = data.get("records", [])
        total = data.get("overall_balance", 0)
        total_income = sum(r["amount"] for r in all_records if r["amount"] > 0)
        total_expense = sum(r["amount"] for r in all_records if r["amount"] < 0)
        text = (
            f"üìä –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è:\n\n"
            f"üíµ –û–±—â–∏–π –ø—Ä–∏—Ö–æ–¥: {fmt_num(total_income)} ARS\n"
            f"üí∏ –û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥: {fmt_num(abs(total_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(total)} ARS"
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try: bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e: log_error(f"total edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, "–û–±—â–∏–π –∏—Ç–æ–≥ üìä"); return

    if action == "report":
        day_records = store.get("daily_records", {}).get(day_key, [])
        expenses = [r for r in day_records if r["amount"] < 0]
        if not expenses:
            text = f"üìÖ {day_key}\n–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å.\nüí∏ –†–∞—Å—Ö–æ–¥: 0 ARS"
        else:
            lines = [f"üìÖ {day_key}", "üìã –†–∞—Å—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å:"]
            for r in expenses[-30:]:
                lines.append(f"{r['short_id']}: -{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
            lines.append(f"\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(sum(abs(r['amount']) for r in expenses))} ARS")
            text = "\n".join(lines)
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try: bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e: log_error(f"report edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, "–û—Ç—á—ë—Ç –æ–±–Ω–æ–≤–ª—ë–Ω üìä"); return

    if action == "csv_all":
        try:
            export_to_csv(data)
            sync_all_backups_gdrive_async(data)  # –∞–ø–ª–æ–∞–¥ –≤ Drive
            bot.answer_callback_query(call.id, "CSV –æ–±–Ω–æ–≤–ª—ë–Ω –∏ –≤—ã–≥—Ä—É–∂–µ–Ω –≤ Google Drive üìÅ")
        except Exception as e:
            bot.answer_callback_query(call.id, f"–û—à–∏–±–∫–∞ CSV: {e}")
        return

    if action == "csv_day":
        filename = f"data_{day_key}.csv"
        day_records = store.get("daily_records", {}).get(day_key, [])
        try:
            with open(filename, "w", newline="", encoding="utf-8") as f:
                w = csv.writer(f)
                w.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
                for r in day_records:
                    w.writerow([chat_id, r.get("id"), r.get("short_id"), r.get("timestamp"),
                                r.get("amount"), r.get("note"), r.get("owner"), day_key])
            # –ë–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞ –≤ —á–∞—Ç: —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç
            bot.answer_callback_query(call.id, f"CSV –∑–∞ –¥–µ–Ω—å {day_key} —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ª–æ–∫–∞–ª—å–Ω–æ")
        except Exception as e:
            bot.answer_callback_query(call.id, f"–û—à–∏–±–∫–∞ CSV –∑–∞ –¥–µ–Ω—å: {e}")
        return

    if action == "reset":
        update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, "–î–ª—è –æ–±–Ω—É–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /reset"); return

    if action in ("back_main", "edit_back", "noop", "info_ok"):
        update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id); return

    if action == "edit_list":
        day_records = store.get("daily_records", {}).get(day_key, [])
        if not day_records:
            text = f"üìÖ {day_key}\n–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å."
            active_id = get_active_window_id(chat_id, day_key)
            if active_id:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))
            bot.answer_callback_query(call.id, "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π"); return
        lines = [f"üìÖ {day_key}", "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"]
        kb = types.InlineKeyboardMarkup(row_width=1)
        for r in reversed(day_records[-20:]):
            sign = "+" if r["amount"] > 0 else "-"
            label = f"{r['short_id']}: {sign}{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}"
            kb.add(types.InlineKeyboardButton(label, callback_data=f"d:{day_key}:rec:{r['id']}"))
        kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:back_main"))
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try: bot.edit_message_text("\n".join(lines), chat_id, active_id, reply_markup=kb)
            except telebot.apihelper.ApiException as e: log_error(f"edit_list: {e}")
        bot.answer_callback_query(call.id); return

    if action == "rec" and len(action_tail) >= 2:
        try: rid = int(action_tail[1])
        except: bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID"); return
        day_records = store.get("daily_records", {}).get(day_key, [])
        rec = next((r for r in day_records if r["id"] == rid), None)
        if not rec:
            bot.answer_callback_query(call.id, "–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"); return
        sign = "+" if rec["amount"] > 0 else "-"
        text = f"–ó–∞–ø–∏—Å—å {rec['short_id']}\n{sign}{fmt_num(abs(rec['amount']))} ‚Äî {rec.get('note','')}\n–î–æ–±–∞–≤–ª–µ–Ω–∞: {rec.get('timestamp')}"
        kb = build_edit_keyboard_for_record(day_key, rid)
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try: bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            except telebot.apihelper.ApiException as e: log_error(f"rec detail: {e}")
        bot.answer_callback_query(call.id); return

    if action == "edit_manual" and len(action_tail) >= 2:
        try: rid = int(action_tail[1])
        except: bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID"); return
        store["edit_wait"] = f"change_value:{day_key}"
        store["edit_target"] = rid
        save_data(data); sync_all_backups_gdrive_async(data)
        kb = types.InlineKeyboardMarkup(row_width=1)
        kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:edit_list"))
        active_id = get_active_window_id(chat_id, day_key)
        text = ("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—É–º–º—É –∏ –∑–∞–º–µ—Ç–∫—É:\n"
                "+500 –ó–∞—Ä–ø–ª–∞—Ç–∞  –∏–ª–∏  ^+^500^ –ó–∞—Ä–ø–ª–∞—Ç–∞  –∏–ª–∏  ^-^150^ –û–±–µ–¥")
        if active_id:
            try: bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            except telebot.apihelper.ApiException as e: log_error(f"edit_manual edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key, True)
        bot.answer_callback_query(call.id, "–û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—É–º–º—ã ‚úèÔ∏è"); return

    if action == "edit_delete" and len(action_tail) >= 2:
        try: rid = int(action_tail[1])
        except: bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID"); return
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(
                    f"‚ùó –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ R{rid}:",
                    chat_id, active_id, reply_markup=build_confirm_delete_keyboard(day_key, rid)
                )
            except telebot.apihelper.ApiException as e:
                log_error(f"edit_delete confirm: {e}")
        bot.answer_callback_query(call.id); return

    if action == "confirm_delete" and len(action_tail) >= 2:
        try: rid = int(action_tail[1])
        except: bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID"); return
        success, _ = delete_record_in_chat(chat_id, rid, user=call.from_user)
        text = "‚úÖ –ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞" if success else "‚ö†Ô∏è –ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))
        bot.answer_callback_query(call.id, "–ì–æ—Ç–æ–≤–æ"); return

    if action == "cancel_delete":
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            bot.edit_message_text("‚úèÔ∏è –ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è", chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))
        bot.answer_callback_query(call.id, "–û—Ç–º–µ–Ω–∞"); return

    if action == "confirm_reset_all":
        try:
            cid = str(chat_id)
            if cid in data.get("chats", {}):
                data["chats"].pop(cid, None)
            data["records"] = [r for r in data.get("records", []) if str(r.get("owner")) != cid]
            data["overall_balance"] = sum(x["amount"] for x in data.get("records", []))
            save_data(data); sync_all_backups_gdrive_async(data)
            text = "‚öôÔ∏è –í—Å–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω—ã."
            active_id = get_active_window_id(chat_id, day_key)
            if active_id:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(today_key(), chat_id))
            else:
                bot.send_message(chat_id, text)
            bot.answer_callback_query(call.id, "–î–∞–Ω–Ω—ã–µ –æ–±–Ω—É–ª–µ–Ω—ã ‚úÖ")
        except Exception as e:
            log_error(f"confirm_reset_all: {e}")
            bot.answer_callback_query(call.id, "–û—à–∏–±–∫–∞")
        return

    bot.answer_callback_query(call.id)

# ---------- –ö–æ–º–∞–Ω–¥—ã ----------
@bot.message_handler(commands=["start","info"])
def cmd_start(msg):
    chat_id = msg.chat.id
    # –°—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –±–µ–∑ —É–¥–≤–æ–µ–Ω–∏—è (—Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–∫—Å—Ç—É)
    bot.send_message(chat_id, f"üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω (GDriveOnly, –≤–µ—Ä—Å–∏—è {VERSION})")
    update_or_send_day_window(chat_id, today_key(), True, True, True)

@bot.message_handler(commands=["help"])
def cmd_help(msg):
    send_info(msg.chat.id,
        "üìò –î–æ–±–∞–≤–ª—è–π—Ç–µ –∑–∞–ø–∏—Å–∏ —Ç–∞–∫: +500 –ó–∞—Ä–ø–ª–∞—Ç–∞ –∏–ª–∏ -150 –û–±–µ–¥.\n\n"
        "–ö–æ–º–∞–Ω–¥—ã: /start /view YYYY-MM-DD /prev /next /balance /report /csv /reset /ping /help\n"
        "CSV/JSON –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ Google Drive."
    )

@bot.message_handler(commands=["ping"])
def cmd_ping(msg):
    send_info(msg.chat.id, "PONG ‚Äî –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ")

@bot.message_handler(commands=["view"])
def cmd_view(msg):
    chat_id = msg.chat.id
    parts = (msg.text or "").split()
    if len(parts) < 2: send_info(chat_id, "–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É: /view YYYY-MM-DD"); return
    d = parse_date_key(parts[1])
    if not d: send_info(chat_id, "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ü—Ä–∏–º–µ—Ä: /view 2025-11-02"); return
    dk = d.strftime("%Y-%m-%d")
    prev_day = get_current_view_day(chat_id)
    update_or_send_day_window(chat_id, dk, True, True, True, False, prev_day)

@bot.message_handler(commands=["prev"])
def cmd_prev(msg):
    chat_id = msg.chat.id
    current = get_current_view_day(chat_id)
    prev_key = shift_date_key(current, -1)
    update_or_send_day_window(chat_id, prev_key, True, True, True, False, current)

@bot.message_handler(commands=["next"])
def cmd_next(msg):
    chat_id = msg.chat.id
    current = get_current_view_day(chat_id)
    next_key = shift_date_key(current, +1)
    update_or_send_day_window(chat_id, next_key, True, True, True, False, current)

@bot.message_handler(commands=["balance"])
def cmd_balance_cmd(msg):
    chat_id = msg.chat.id
    store = get_chat_store(chat_id); dk = today_key()
    day_records = store.get("daily_records", {}).get(dk, [])
    inc = sum(r["amount"] for r in day_records if r["amount"] > 0)
    exp = sum(r["amount"] for r in day_records if r["amount"] < 0)
    bal = store.get("balance", 0)
    send_info(chat_id, f"üìÖ {dk}\n\nüí∞ –û—Å—Ç–∞—Ç–æ–∫: {fmt_num(bal)} ARS\nüíµ –ü—Ä–∏—Ö–æ–¥: {fmt_num(inc)} ARS\nüí∏ –†–∞—Å—Ö–æ–¥: {fmt_num(abs(exp))} ARS")

@bot.message_handler(commands=["report"])
def cmd_report(msg):
    chat_id = msg.chat.id
    store = get_chat_store(chat_id); dk = today_key()
    day_records = store.get("daily_records", {}).get(dk, [])
    expenses = [r for r in day_records if r["amount"] < 0]
    if not expenses:
        send_info(chat_id, f"üìÖ {dk}\n–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è.\nüí∏ –†–∞—Å—Ö–æ–¥: 0 ARS"); return
    lines = [f"üìÖ {dk}", "üìã –†–∞—Å—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å:"]
    for r in expenses[-30:]:
        lines.append(f"{r['short_id']}: -{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
    lines.append(f"\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(sum(abs(r['amount']) for r in expenses))} ARS")
    send_info(chat_id, "\n".join(lines))

@bot.message_handler(commands=["csv"])
def cmd_csv(msg):
    export_to_csv(data)
    sync_all_backups_gdrive_async(data)
    send_info(msg.chat.id, "üìÇ CSV –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω –∏ –≤—ã–≥—Ä—É–∂–µ–Ω –≤ Google Drive.")

# ---------- –ü—Ä–∏—ë–º —Ç–µ–∫—Å—Ç–æ–≤ (–º–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ) ----------
@bot.message_handler(func=lambda m: True)
def handle_message(msg):
    if not msg.text:
        return
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    wait_action = store.get("edit_wait")

    # –†—É—á–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏
    if wait_action and wait_action.startswith("change_value"):
        day_key = today_key()
        if ":" in wait_action: _, day_key = wait_action.split(":", 1)
        rid = store.get("edit_target")
        if not rid:
            store["edit_wait"] = None; store["edit_target"] = None; save_data(data); sync_all_backups_gdrive_async(data); return
        parts = (msg.text or "").strip().split(" ", 1)
        try:
            amount_token = parts[0]
            amount = parse_amount_token(amount_token)
            note = parts[1] if len(parts) > 1 else ""
            success, _ = update_record_in_chat(chat_id, rid, amount, note, user=msg.from_user)
            store["edit_wait"] = None; store["edit_target"] = None; save_data(data); sync_all_backups_gdrive_async(data)
            active_id = get_active_window_id(chat_id, day_key)
            text = render_day_text(store, day_key)
            if active_id:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            else:
                update_or_send_day_window(chat_id, day_key)
            send_info(chat_id, f"‚úÖ –ó–∞–ø–∏—Å—å R{rid} {'–∏–∑–º–µ–Ω–µ–Ω–∞' if success else '–Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}")
        except Exception as e:
            log_error(f"edit manual: {e}")
            send_info(chat_id, "‚ùå –§–æ—Ä–º–∞—Ç: +500 –ó–∞—Ä–ø–ª–∞—Ç–∞ –∏–ª–∏ -150 –û–±–µ–¥")
        return

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–∑ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–ø–æ—Å—Ç—Ä–æ—á–Ω–æ)
    lines = (msg.text or "").strip().split("\n")
    added = 0
    for line in lines:
        line = line.strip()
        if not line: continue
        m = re.search(num_re, line)
        if not m: continue
        try:
            raw = m.group(0)
            raw_clean = raw.replace("^", "").replace(" ", "")
            amount = parse_amount_token(raw_clean)
            note = line.replace(m.group(0), "").strip()
            add_record_to_chat(chat_id, amount, note, msg.from_user.id)
            added += 1
        except Exception as e:
            log_error(f"auto-add record: {e}")
            send_info(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏: {html.escape(line)}")

    dk = today_key()
    active_id = get_active_window_id(chat_id, dk)
    if active_id:
        text = render_day_text(store, dk)
        bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(dk, chat_id))
    else:
        update_or_send_day_window(chat_id, dk)
    if added:
        send_info(chat_id, f"‚úÖ –ó–∞–ø–∏—Å–µ–π –¥–æ–±–∞–≤–ª–µ–Ω–æ: {added}")


# ====== –ß–ê–°–¢–¨ 5/5 ==========================================
# üåê Webhook/Flask, –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∏, keep-alive, –∑–∞–ø—É—Å–∫ (–±–µ–∑ –∫–∞–Ω–∞–ª–æ–≤, —Ç–æ–ª—å–∫–æ GDrive)

# -----------------------------
# üåê Flask webhook
# -----------------------------
@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    try:
        update = telebot.types.Update.de_json(request.get_data().decode("utf-8"))
        bot.process_new_updates([update])
    except Exception as e:
        log_error(f"webhook error: {e}")
    return "OK", 200

@app.route("/", methods=["GET"])
def index():
    return f"–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è {VERSION} —Ä–∞–±–æ—Ç–∞–µ—Ç", 200

# -----------------------------
# üü¢ Keep-alive
# -----------------------------
def keep_alive_task():
    while True:
        try:
            log_info("Keep-alive: –ø–∏–Ω–≥ self –∏, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –≤–ª–∞–¥–µ–ª—å—Ü–∞.")
            if APP_URL:
                try:
                    resp = requests.get(APP_URL, timeout=10)
                    log_info(f"Keep-alive {APP_URL} -> {getattr(resp, 'status_code', '?')}")
                except Exception as e:
                    log_error(f"Keep-alive self-ping error: {e}")
            if KEEP_ALIVE_SEND_TO_OWNER and OWNER_ID:
                try:
                    send_temp_message(int(OWNER_ID), f"üü¢ Keep-alive: –±–æ—Ç {VERSION} –∞–∫—Ç–∏–≤–µ–Ω.\n{now_local().isoformat(timespec='seconds')}")
                except Exception as e:
                    log_error(f"Keep-alive notify owner: {e}")
        except Exception as e:
            log_error(f"Keep-alive loop: {e}")
        time.sleep(max(10, KEEP_ALIVE_INTERVAL_SECONDS))

def start_keep_alive_thread():
    threading.Thread(target=keep_alive_task, daemon=True).start()

# -----------------------------
# üóì –ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞ –Ω–æ–≤–æ–≥–æ –¥–Ω—è
# -----------------------------
def schedule_daily_window_creation():
    def task():
        last_day = today_key()
        while True:
            try:
                time.sleep(60)
                current_day = today_key()
                if current_day != last_day:
                    for chat_id_str in list(data.get("chats", {}).keys()):
                        try: chat_id = int(chat_id_str)
                        except: continue
                        try:
                            update_or_send_day_window(
                                chat_id, current_day,
                                create_if_missing=True, force_new=True,
                                delete_target_old=True, delete_source_old=False
                            )
                        except Exception as e:
                            log_error(f"daily new window {chat_id}: {e}")
                    last_day = current_day
            except Exception as e:
                log_error(f"daily loop: {e}"); time.sleep(5)
    threading.Thread(target=task, daemon=True).start()

# -----------------------------
# ü™ù Webhook
# -----------------------------
def set_webhook():
    url = f"{APP_URL}/{TOKEN}"
    try:
        bot.remove_webhook()
        time.sleep(0.5)
        bot.set_webhook(url=url)
        log_info(f"Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {url}")
    except Exception as e:
        log_error(f"set_webhook: {e}")


# ====== üìÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–∏—Å–ª–∞–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É data.json ======
@bot.message_handler(content_types=["document"])
def handle_document(msg):
    try:
        doc = msg.document
        if not doc or not doc.file_name:
            return

        fname = doc.file_name.lower()
        owner_id = int(OWNER_ID) if OWNER_ID else None

        # üßæ –í–ª–∞–¥–µ–ª–µ—Ü –ø—Ä–∏—Å–ª–∞–ª data.json ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        if fname == "data.json" and owner_id and msg.chat.id == owner_id:
            file_info = bot.get_file(doc.file_id)
            downloaded = bot.download_file(file_info.file_path)
            with open(DATA_FILE, "wb") as f:
                f.write(downloaded)

            # ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–∞
            try:
                with open(DATA_FILE, "r", encoding="utf-8") as f:
                    restored = json.load(f)
                if not isinstance(restored, dict):
                    raise ValueError("–æ–∂–∏–¥–∞–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç (dict)")

                globals()["data"] = restored
                base = default_data()
                for k, v in base.items():
                    if k not in data:
                        data[k] = v

            except Exception as e:
                send_info(msg.chat.id, f"‚ö†Ô∏è –§–∞–π–ª data.json –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ({e}).")
                return

            # üíæ –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            export_to_csv(data)
            _save_csv_meta({
                "restored_from": "manual upload",
                "timestamp": datetime.now(TZ).isoformat(timespec="seconds")
            })
            send_info(msg.chat.id, "‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Ñ–∞–π–ª–∞ data.json –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!")

            # üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å Drive
            save_data(data)
            sync_all_backups_gdrive_async(data)
            time.sleep(1)

            # ü™û –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
            update_or_send_day_window(msg.chat.id, today_key(), True, True, True)
            return

        # –õ—é–±–æ–π –¥—Ä—É–≥–æ–π –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º
        send_info(msg.chat.id, f"üìÑ –ü–æ–ª—É—á–µ–Ω —Ñ–∞–π–ª: {fname}")

    except Exception as e:
        log_error(f"handle_document: {e}")
        send_info(msg.chat.id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: {e}")

# -----------------------------
# üöÄ –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
# -----------------------------
if __name__ == "__main__":
    # Webhook + —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
    set_webhook()
    schedule_daily_window_creation()
    start_keep_alive_thread()

    try:
        if OWNER_ID:
            bot.send_message(int(OWNER_ID), f"‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! (–≤–µ—Ä—Å–∏—è {VERSION})")
    except Exception as e:
        log_error(f"send startup msg: {e}")

    # Flask
    app.run(host="0.0.0.0", port=PORT)