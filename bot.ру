# ============================================
# –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è 9.6.1.6
# –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è
# –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –∫–æ–º–∞–Ω–¥—ã –ª–∞—Ç–∏–Ω–∏—Ü–µ–π.
# –û–¢–°–ï–ö–ò –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω—ã –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö.
# ============================================



# -----------------------------
# –û–¢–°–ï–ö 1 ‚Äî –ò–º–ø–æ—Ä—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
# -----------------------------
import os
import json
import csv              # ‚úÖ –¥–æ–±–∞–≤–ª–µ–Ω —è–≤–Ω—ã–π –∏–º–ø–æ—Ä—Ç CSV
import logging
import requests
import re
from datetime import datetime
from zoneinfo import ZoneInfo

import telebot
from flask import Flask, request
from telebot import types

# --------------------------------------------
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
# --------------------------------------------
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")  # —Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ —á–∏—Å–ª–æ
APP_URL = os.getenv("APP_URL", "https://fo-1.onrender.com")  # URL –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è webhook
TZ = ZoneInfo("America/Argentina/Catamarca")
DATA_FILE = "data.json"
CSV_FILE = "data.csv"
LOG_FILE = "log.txt"
PORT = int(os.environ.get("PORT", 5000))
VERSION = "9.6.1.7"

if not TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

log_info = logging.info
log_error = logging.error

# --------------------------------------------
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
# --------------------------------------------
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")  # —Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ —á–∏—Å–ª–æ
APP_URL = os.getenv("APP_URL", "https://fo-1.onrender.com")  # URL –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è webhook
TZ = ZoneInfo("America/Argentina/Catamarca")
DATA_FILE = "data.json"
CSV_FILE = "data.csv"
LOG_FILE = "log.txt"
PORT = int(os.environ.get("PORT", 5000))
VERSION = "9.6.1.6"

if not TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# --------------------------------------------
# –û–¢–°–ï–ö 2 ‚Äî –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# --------------------------------------------
logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[
        logging.FileHandler(LOG_FILE, encoding="utf-8"),
        logging.StreamHandler()
    ]
)

def log_info(msg):
    logging.info(msg)

def log_error(msg):
    logging.error(msg)

log_info(f"–°—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –í–µ—Ä—Å–∏—è {VERSION}")

# --------------------------------------------
# –û–¢–°–ï–ö 3 ‚Äî –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Ä–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–æ–º
# --------------------------------------------
def default_data():
    return {
        "chats": {},  # chat_id -> { balance, records:[], next_id, daily_records: {YYYY-MM-DD: [rec,...]} }
        "forward_targets": [],  # —Å–ø–∏—Å–æ–∫ chat_id (int)
        "tracked_messages": {},  # –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: chat_id -> {user_id: state}
        "processed_messages": [],  # —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π "chat_id:message_id" —á—Ç–æ–±—ã –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–≤–∞–∂–¥—ã
    }

def load_data():
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, "r", encoding="utf-8") as f:
                d = json.load(f)
        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ data.json: {e}")
            d = default_data()
    else:
        d = default_data()
    # Ensure keys
    for k, v in default_data().items():
        if k not in d:
            d[k] = v
    return d

def save_data(d):
    try:
        with open(DATA_FILE, "w", encoding="utf-8") as f:
            json.dump(d, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è data.json: {e}")

def export_to_csv(d):
    try:
        with open(CSV_FILE, "w", newline='', encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner"])
            for cid, cdata in d.get("chats", {}).items():
                for r in cdata.get("records", []):
                    writer.writerow([cid, r.get("id"), r.get("short_id"), r.get("timestamp"), r.get("amount"), r.get("note"), r.get("owner")])
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ CSV: {e}")

data = load_data()

# –µ—Å–ª–∏ OWNER_ID –∑–∞–¥–∞–Ω –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ ‚Äî —É–±–µ–¥–∏–º—Å—è —á—Ç–æ –æ–Ω –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ forward_targets
if OWNER_ID:
    try:
        owner_int = int(OWNER_ID)
    except Exception:
        owner_int = None
    if owner_int is not None and owner_int not in data["forward_targets"]:
        data["forward_targets"].append(owner_int)
        save_data(data)

# –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è/–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —á–∞—Ç–∞
def get_chat_store(chat_id):
    chat_id = str(chat_id)
    if chat_id not in data["chats"]:
        data["chats"][chat_id] = {
            "balance": 0,
            "records": [],
            "next_id": 1,
            "daily_records": {}  # YYYY-MM-DD -> [rec, ...]
        }
        save_data(data)
    # –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø–æ–ª—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    store = data["chats"][chat_id]
    if "daily_records" not in store:
        store["daily_records"] = {}
    if "records" not in store:
        store["records"] = []
    if "next_id" not in store:
        store["next_id"] = 1
    if "balance" not in store:
        store["balance"] = 0
    return store

# —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
def add_record_to_chat(chat_id, amount, note, owner):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –∏ –≤ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ chat.records, –∏ –≤ daily_records[current_date].
    –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞.
    """
    store = get_chat_store(chat_id)
    ts = datetime.now(TZ)
    ts_iso = ts.isoformat()
    rid = store.get("next_id", 1)
    rec = {
        "id": rid,
        "short_id": f"R{rid}",
        "timestamp": ts_iso,
        "amount": amount,
        "note": note,
        "owner": owner
    }
    store.setdefault("records", []).append(rec)
    # daily
    today = ts.strftime("%Y-%m-%d")
    dr = store.setdefault("daily_records", {})
    day_list = dr.setdefault(today, [])
    day_list.append(rec)
    # update counters
    store["balance"] = sum([r["amount"] for r in store.get("records", [])])
    store["next_id"] = rid + 1
    save_data(data)
    export_to_csv(data)
    if amount >= 0:
        log_info(f"[CHAT {chat_id}] –ü–†–ò–•–û–î: +{amount} {note}")
    else:
        log_info(f"[CHAT {chat_id}] –†–ê–°–•–û–î: {amount} {note}")
    return rec

def delete_record_in_chat(chat_id, rec_id):
    store = get_chat_store(chat_id)
    recs = store.get("records", [])
    to_del = None
    for r in recs:
        if r["id"] == rec_id or str(r["id"]) == str(rec_id) or r["short_id"] == f"R{rec_id}":
            to_del = r
            break
    if not to_del:
        return False, None
    recs.remove(to_del)
    # —É–¥–∞–ª–∏—Ç—å –∏–∑ daily_records (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
    for day, lst in store.get("daily_records", {}).items():
        lst[:] = [x for x in lst if not (x.get("id") == to_del.get("id"))]
    # recalc balance
    store["balance"] = sum([r["amount"] for r in recs])
    save_data(data)
    export_to_csv(data)
    return True, to_del

def update_record_in_chat(chat_id, rec_id, new_amount, new_note):
    store = get_chat_store(chat_id)
    recs = store.get("records", [])
    found = None
    for r in recs:
        if r["id"] == rec_id or str(r["id"]) == str(rec_id) or r["short_id"] == f"R{rec_id}":
            found = r
            break
    if not found:
        return False, None
    # update record fields
    found["amount"] = new_amount
    found["note"] = new_note
    # update in daily_records as well (find by id)
    for day, lst in store.get("daily_records", {}).items():
        for item in lst:
            if item.get("id") == found.get("id"):
                item["amount"] = new_amount
                item["note"] = new_note
    # recompute balance
    store["balance"] = sum([r["amount"] for r in recs])
    save_data(data)
    export_to_csv(data)
    return True, found

# --------------------------------------------
# –û–¢–°–ï–ö 4 ‚Äî –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–ø–∞—Ä—Å–∏–Ω–≥, —á–∞—Ç-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç)
# --------------------------------------------
# –†–∞–∑–±–æ—Ä –ø–µ—Ä–≤–æ–π –Ω–∞–π–¥–µ–Ω–Ω–æ–π —Ü–∏—Ñ—Ä—ã –≤ —Å—Ç—Ä–æ–∫–µ (—Å —É—á—ë—Ç–æ–º –∑–Ω–∞–∫–æ–≤ –∏ –ø—Ä–æ–±–µ–ª–æ–≤)
num_re = re.compile(r'([+-]?\s*\d+)')

def extract_first_number(s):
    """
    –ò—â–µ—Ç –ø–µ—Ä–≤–æ–µ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ —á–∏—Å–ª–∞ –≤ —Å—Ç—Ä–æ–∫–µ. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (amount:int, raw_token:str) –∏–ª–∏ (None, None)
    –ü—Ä–∞–≤–∏–ª–∞:
    - –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–æ–±–µ–ª –º–µ–∂–¥—É –∑–Ω–∞–∫–æ–º –∏ —Ü–∏—Ñ—Ä–æ–π: "+ 100" –∏–ª–∏ "-  50"
    - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ —á–∏—Å–ª–æ —É—á–∏—Ç—ã–≤–∞–µ—Ç –∑–Ω–∞–∫
    """
    if not s:
        return None, None
    m = num_re.search(s)
    if not m:
        return None, None
    token = m.group(1)
    # —É–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –≤–Ω—É—Ç—Ä–∏ —Ç–æ–∫–µ–Ω–∞
    token_clean = token.replace(" ", "")
    try:
        amt = int(token_clean)
    except Exception:
        return None, None
    return amt, token.strip()

def get_chat_store(chat_id):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —á–∞—Ç–∞"""
    chat_id = str(chat_id)
    if chat_id not in data["chats"]:
        data["chats"][chat_id] = {
            "balance": 0,
            "records": [],
            "next_id": 1
        }
        save_data(data)
    return data["chats"][chat_id]

def add_record_to_chat(chat_id, amount, note, owner):
    store = get_chat_store(chat_id)
    ts = datetime.now(TZ).isoformat()
    rid = store.get("next_id", 1)
    rec = {
        "id": rid,
        "short_id": f"R{rid}",
        "timestamp": ts,
        "amount": amount,
        "note": note,
        "owner": owner
    }
    store.setdefault("records", []).append(rec)
    store["balance"] = store.get("balance", 0) + amount
    store["next_id"] = rid + 1
    save_data(data)
    export_to_csv(data)
    if amount >= 0:
        log_info(f"[CHAT {chat_id}] –ü–†–ò–•–û–î: +{amount} {note}")
    else:
        log_info(f"[CHAT {chat_id}] –†–ê–°–•–û–î: {amount} {note}")
    return rec

def delete_record_in_chat(chat_id, rec_id):
    store = get_chat_store(chat_id)
    recs = store.get("records", [])
    to_del = None
    for r in recs:
        if r["id"] == rec_id or str(r["id"]) == str(rec_id) or r["short_id"] == f"R{rec_id}":
            to_del = r
            break
    if not to_del:
        return False, None
    recs.remove(to_del)
    store["balance"] = sum([r["amount"] for r in recs])
    save_data(data)
    export_to_csv(data)
    return True, to_del

def update_record_in_chat(chat_id, rec_id, new_amount, new_note):
    store = get_chat_store(chat_id)
    recs = store.get("records", [])
    found = None
    for r in recs:
        if r["id"] == rec_id or str(r["id"]) == str(rec_id) or r["short_id"] == f"R{rec_id}":
            found = r
            break
    if not found:
        return False, None
    found["amount"] = new_amount
    found["note"] = new_note
    # recompute balance
    store["balance"] = sum([r["amount"] for r in recs])
    save_data(data)
    export_to_csv(data)
    return True, found

# --------------------------------------------
# –û–¢–°–ï–ö 5 ‚Äî –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏ –∫–Ω–æ–ø–∫–∏ (–∫–æ–º–ø–∞–∫—Ç–Ω–∞—è + –±–∞–ª–∞–Ω—Å + –Ω–∞–∑–∞–¥)
# --------------------------------------------
from telebot import types

def build_main_keyboard(chat_id=None):
    """
    –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é. –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω chat_id ‚Äî –≤–Ω–∏–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–ª–∞–Ω—Å –∏ –∫–Ω–æ–ø–∫—É –ù–∞–∑–∞–¥.
    """
    kb = types.InlineKeyboardMarkup()
    kb.row(
        types.InlineKeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å", callback_data="btn_balance"),
        types.InlineKeyboardButton("üìä –û—Ç—á—ë—Ç", callback_data="btn_report")
    )
    kb.row(
        types.InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data="btn_edit"),
        types.InlineKeyboardButton("‚öôÔ∏è –°–±—Ä–æ—Å", callback_data="btn_reset")
    )
    kb.row(
        types.InlineKeyboardButton("üöÄ –°—Ç–∞—Ä—Ç", callback_data="btn_start"),
        types.InlineKeyboardButton("üìò –û –∫–æ–¥–µ", callback_data="btn_cod")
    )

    # –ù–∏–∂–Ω—è—è —Å—Ç—Ä–æ–∫–∞: –ù–∞–∑–∞–¥ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) –∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –±–∞–ª–∞–Ω—Å–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å chat_id)
    footer_left = types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="btn_back")
    if chat_id is None:
        footer_right = types.InlineKeyboardButton(" ", callback_data="noop")
    else:
        store = get_chat_store(chat_id)
        footer_right = types.InlineKeyboardButton(f"üí∞ {store.get('balance',0)} ars", callback_data="noop")
    kb.row(footer_left, footer_right)
    return kb


def build_edit_list_keyboard(chat_id, include_back=True):
    """
    –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å –∫–Ω–æ–ø–∫–∞–º–∏ ‚úè –∏ üóë (–∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ).
    """
    store = get_chat_store(chat_id)
    kb = types.InlineKeyboardMarkup()
    records = store.get("records", [])[-20:]
    if not records:
        kb.add(types.InlineKeyboardButton("–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π", callback_data="noop"))
        kb.row(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="btn_back"),
               types.InlineKeyboardButton(f"üí∞ {store.get('balance',0)} ARS", callback_data="noop"))
        return kb

    for r in records:
        sign = "+" if r["amount"] > 0 else ""
        label = f"{r['short_id']}: {sign}{r['amount']} {r.get('note','')}"
        # –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ ‚úè –∏ üóë
        kb.row(
            types.InlineKeyboardButton(label, callback_data=f"noop_row:{r['id']}"),
            types.InlineKeyboardButton("‚úé", callback_data=f"edit_select:{r['id']}"),
            types.InlineKeyboardButton("‚ùå", callback_data=f"delete_record:{r['id']}")
        )

    kb.row(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="btn_back"),
           types.InlineKeyboardButton(f"üí∞ {store.get('balance',0)} ARS", callback_data="noop"))
    return kb

# 6--------------------------------------------
# –û–¢–°–ï–ö 6 ‚Äî –ö–æ–º–∞–Ω–¥—ã (–æ—Å–Ω–æ–≤–Ω—ã–µ)
# --------------------------------------------
@bot.message_handler(commands=["start"])
def cmd_start(msg):
    text = (
        "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ¬´–§–û¬ª\n\n"
        "–ö–æ–º–∞–Ω–¥—ã (–ª–∞—Ç–∏–Ω–∏—Ü–µ–π):\n"
        "/start ‚Äì –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É\n"
        "/myid ‚Äì –ø–æ–∫–∞–∑–∞—Ç—å –≤–∞—à user ID\n"
        "/chatid ‚Äì –ø–æ–∫–∞–∑–∞—Ç—å ID —á–∞—Ç–∞\n"
        "/balance ‚Äì –ø–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å (–¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞)\n"
        "/report ‚Äì –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞)\n"
        "/reset ‚Äì –æ–±–Ω—É–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü)\n"
        "/addforward <chat_id> ‚Äì –¥–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏ (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü)\n"
        "/removeforward <chat_id> ‚Äì —É–±—Ä–∞—Ç—å —Ü–µ–ª—å –ø–µ—Ä–µ—Å—ã–ª–∫–∏ (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü)\n"
        "/listforwards ‚Äì —Å–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π –ø–µ—Ä–µ—Å—ã–ª–∫–∏\n"
        "/cod ‚Äì –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä—Å–∏–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö\n"
        "/edit ‚Äì —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (—Å–ø–∏—Å–æ–∫ –∏ –≤—ã–±–æ—Ä)\n"
        "/delete <–Ω–æ–º–µ—Ä> ‚Äì —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ –Ω–æ–º–µ—Ä—É\n\n"
        "–î–ª—è –∑–∞–ø–∏—Å–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫, –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π —É—á—ë—Ç.\n"
        "–ü—Ä–∏–º–µ—Ä—ã:\n+1000 –∑–∞—Ä–ø–ª–∞—Ç–∞\n-123 —Ö–ª–µ–±\n200 —Å–æ–∫\n"
    )
    bot.send_message(msg.chat.id, f"üí¨ –í–µ—Ä—Å–∏—è: {VERSION}\n\n{text}", reply_markup=build_main_keyboard())

@bot.message_handler(commands=["myid"])
def cmd_myid(msg):
    uid = msg.from_user.id
    bot.reply_to(msg, f"üÜî –í–∞—à user ID: {uid}")

@bot.message_handler(commands=["chatid"])
def cmd_chatid(msg):
    cid = msg.chat.id
    bot.reply_to(msg, f"üí¨ ID —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞: {cid}")

@bot.message_handler(commands=["balance"])
def cmd_balance(msg):
    store = get_chat_store(msg.chat.id)
    bot.reply_to(msg, f"üí∞ –ë–∞–ª–∞–Ω—Å —ç—Ç–æ–≥–æ —á–∞—Ç–∞: {store.get('balance',0)} ars", reply_markup=build_main_keyboard())

@bot.message_handler(commands=["report"])
def cmd_report(msg):
    store = get_chat_store(msg.chat.id)
    recs = store.get("records", [])
    if not recs:
        bot.send_message(msg.chat.id, "–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —ç—Ç–æ–º —á–∞—Ç–µ.", reply_markup=build_main_keyboard())
        return
    text_lines = ["üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —ç—Ç–æ–≥–æ —á–∞—Ç–∞:"]
    for r in recs[-50:]:
        sign = "+" if r["amount"] > 0 else ""
        text_lines.append(f"{r['short_id']}: {sign}{r['amount']} ‚Äî {r.get('note','')}")
    bot.send_message(msg.chat.id, "\n".join(text_lines), reply_markup=build_main_keyboard())

@bot.message_handler(commands=["reset"])
def cmd_reset(msg):
    if OWNER_ID is None or str(msg.from_user.id) != str(OWNER_ID):
        bot.send_message(msg.chat.id, "–¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.", reply_markup=build_main_keyboard())
        return
    global data
    data = default_data()
    try:
        if OWNER_ID:
            data["forward_targets"].append(int(OWNER_ID))
    except Exception:
        pass
    save_data(data)
    export_to_csv(data)
    bot.send_message(msg.chat.id, "‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã.", reply_markup=build_main_keyboard())
    log_info("–î–ê–ù–ù–´–ï –û–ë–ù–£–õ–ï–ù–´ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º")

@bot.message_handler(commands=["addforward"])
def cmd_addforward(msg):
    if OWNER_ID is None or str(msg.from_user.id) != str(OWNER_ID):
        return
    parts = msg.text.split()
    if len(parts) < 2:
        bot.reply_to(msg, "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /addforward <chat_id>")
        return
    try:
        cid = int(parts[1])
    except Exception:
        bot.reply_to(msg, "–ù–µ–≤–µ—Ä–Ω—ã–π chat_id (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ).")
        return
    if cid in data["forward_targets"]:
        bot.reply_to(msg, "–≠—Ç–æ—Ç —á–∞—Ç —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ –ø–µ—Ä–µ—Å—ã–ª–∫–∏.")
        return
    data["forward_targets"].append(cid)
    save_data(data)
    bot.reply_to(msg, f"‚úÖ –¶–µ–ª—å –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞: {cid}")

@bot.message_handler(commands=["removeforward"])
def cmd_removeforward(msg):
    if OWNER_ID is None or str(msg.from_user.id) != str(OWNER_ID):
        return
    parts = msg.text.split()
    if len(parts) < 2:
        bot.reply_to(msg, "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /removeforward <chat_id>")
        return
    try:
        cid = int(parts[1])
    except Exception:
        bot.reply_to(msg, "–ù–µ–≤–µ—Ä–Ω—ã–π chat_id (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ).")
        return
    if cid not in data["forward_targets"]:
        bot.reply_to(msg, "–≠—Ç–æ—Ç —á–∞—Ç –Ω–µ –≤ —Å–ø–∏—Å–∫–µ –ø–µ—Ä–µ—Å—ã–ª–∫–∏.")
        return
    data["forward_targets"].remove(cid)
    save_data(data)
    bot.reply_to(msg, f"‚úÖ –¶–µ–ª—å –ø–µ—Ä–µ—Å—ã–ª–∫–∏ —É–¥–∞–ª–µ–Ω–∞: {cid}")

@bot.message_handler(commands=["listforwards"])
def cmd_listforwards(msg):
    if not data["forward_targets"]:
        bot.reply_to(msg, "–°–ø–∏—Å–æ–∫ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –ø—É—Å—Ç.", reply_markup=build_main_keyboard())
        return
    text = "üì® –¶–µ–ª–∏ –ø–µ—Ä–µ—Å—ã–ª–∫–∏:\n" + "\n".join(map(str, data["forward_targets"]))
    bot.reply_to(msg, text, reply_markup=build_main_keyboard())

@bot.message_handler(commands=["cod"])
def cmd_cod(msg):
    text = (
        f"üìò –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–¥–µ ‚Äî –≤–µ—Ä—Å–∏—è {VERSION}\n\n"
        "–ö—Ä–∞—Ç–∫–æ–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:\n"
        "- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ\n"
        "- –ö–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ –ª–∞—Ç–∏–Ω–∏—Ü–µ\n"
        "- –î–æ–±–∞–≤–ª–µ–Ω—ã inline-–∫–Ω–æ–ø–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞\n"
        "- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ\n"
        "- –ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–µ —á–∞—Ç—ã (–±–µ–∑ —ç—Ö–∞)\n"
        "- –û—Ç–¥–µ–ª—å–Ω—ã–π —É—á—ë—Ç –ø–æ –∫–∞–∂–¥–æ–º—É —á–∞—Ç—É\n"
        "- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π —á–µ—Ä–µ–∑ /edit –∏ /delete\n"
        "- –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è = –æ—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å\n\n"
        "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å–∏—è 9.6.1.6 ‚Äî —Å–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É—á—ë—Ç, —É–ª—É—á—à–µ–Ω–Ω–∞—è –ø–µ—Ä–µ—Å—ã–ª–∫–∞, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ."
    )
    bot.send_message(msg.chat.id, text, reply_markup=build_main_keyboard())

@bot.message_handler(commands=["edit"])
def cmd_edit(msg):
    kb = build_edit_list_keyboard(msg.chat.id)
    if not kb.keyboard:
        bot.reply_to(msg, "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —ç—Ç–æ–º —á–∞—Ç–µ.", reply_markup=build_main_keyboard())
        return
    bot.send_message(msg.chat.id, "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:", reply_markup=kb)

@bot.message_handler(commands=["delete"])
def cmd_delete(msg):
    parts = msg.text.split()
    if len(parts) < 2:
        bot.reply_to(msg, "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /delete <–Ω–æ–º–µ—Ä –∏–ª–∏ R–Ω–æ–º–µ—Ä>")
        return
    token = parts[1].strip()
    if token.upper().startswith("R"):
        token = token[1:]
    try:
        rid = int(token)
    except Exception:
        bot.reply_to(msg, "–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–ø–∏—Å–∏.")
        return
    ok, rec = delete_record_in_chat(msg.chat.id, rid)
    if ok:
        bot.reply_to(msg, f"‚úÖ –ó–∞–ø–∏—Å—å R{rid} —É–¥–∞–ª–µ–Ω–∞. –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—ë–Ω: {get_chat_store(msg.chat.id).get('balance',0)} ars", reply_markup=build_main_keyboard())
    else:
        bot.reply_to(msg, "–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", reply_markup=build_main_keyboard())


# --------------------------------------------
# –û–¢–°–ï–ö 7 ‚Äî –û–±—Ä–∞–±–æ—Ç–∫–∞ callback'–æ–≤ (–≤ –æ–¥–Ω–æ–º –æ–∫–Ω–µ)
# --------------------------------------------
@bot.callback_query_handler(func=lambda c: True)
def handle_callback(call):
    try:
        data_cd = call.data
        cid = call.message.chat.id
        mid = call.message.message_id

        # --- üí∞ –ë–∞–ª–∞–Ω—Å
        if data_cd == "btn_balance":
            store = get_chat_store(cid)
            text = f"üí∞ –ë–∞–ª–∞–Ω—Å —ç—Ç–æ–≥–æ —á–∞—Ç–∞: {store.get('balance', 0)} ars"
            bot.edit_message_text(text, cid, mid, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        # --- üìä –û—Ç—á—ë—Ç
        elif data_cd == "btn_report":
            recs = get_chat_store(cid).get("records", [])
            if not recs:
                text = "üìã –ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π."
            else:
                text_lines = ["üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:"]
                for r in recs[-20:]:
                    sign = "+" if r["amount"] > 0 else ""
                    text_lines.append(f"{r['short_id']}: {sign}{r['amount']} ‚Äî {r.get('note','')}")
                text = "\n".join(text_lines)
            bot.edit_message_text(text, cid, mid, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        # --- ‚öôÔ∏è –°–±—Ä–æ—Å
        elif data_cd == "btn_reset":
            if str(call.from_user.id) != str(OWNER_ID):
                bot.answer_callback_query(call.id, text="–¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.")
                return
            # —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞
            data["chats"].pop(str(cid), None)
            save_data(data)
            text = "‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞ —Å–±—Ä–æ—à–µ–Ω—ã."
            bot.edit_message_text(text, cid, mid, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        # --- ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤ —Ç–æ–º –∂–µ –æ–∫–Ω–µ)
        elif data_cd == "btn_edit":
            kb = build_edit_list_keyboard(cid)
            text = "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏—è:"
            bot.edit_message_text(text, cid, mid, reply_markup=kb)
            bot.answer_callback_query(call.id)

        # --- üöÄ –°—Ç–∞—Ä—Ç (–æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –æ–∫–Ω–æ)
        elif data_cd == "btn_start":
            text = (
                f"üöÄ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç –∑–∞–ø—É—â–µ–Ω (–≤–µ—Ä—Å–∏—è {VERSION})\n\n"
                "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
                "/balance ‚Äì –ø–æ–∫–∞–∑–∞—Ç—å –±–∞–ª–∞–Ω—Å\n"
                "/report ‚Äì –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏\n"
                "/edit ‚Äì —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å\n"
                "/reset ‚Äì —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü)\n"
                "/cod ‚Äì –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–¥–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\n\n"
                "–ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ: +1000 –ø—Ä–æ–¥–∞–∂–∞  –∏–ª–∏  -500 –µ–¥–∞"
            )
            bot.edit_message_text(text, cid, mid, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        # --- üìò –û –∫–æ–¥–µ (–≤ –æ–¥–Ω–æ–º –æ–∫–Ω–µ)
        elif data_cd == "btn_cod":
            text = (
                f"üìò –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è {VERSION}\n\n"
                "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ: –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –∫–Ω–æ–ø–∫–∏, –∞–≤—Ç–æ–ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook, —É—á—ë—Ç –ø–æ —á–∞—Ç–∞–º.\n"
            )
            bot.edit_message_text(text, cid, mid, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        # --- –∫–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥
        elif data_cd == "btn_back":
            bot.edit_message_text("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:", cid, mid, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        # --- ‚úè –í—ã–±–æ—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: —Å–æ—Ö—Ä–∞–Ω—è–µ–º state + msg_id (—á—Ç–æ–±—ã –ø–æ—Ç–æ–º –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —ç—Ç–æ –æ–∫–Ω–æ)
        elif data_cd.startswith("edit_select:"):
            rid = int(data_cd.split(":")[1])
            chat_state = data.setdefault("tracked_messages", {})
            chat_key = str(cid)
            user_states = chat_state.setdefault(chat_key, {})
            # —Å–æ—Ö—Ä–∞–Ω—è–µ–º, –∫—É–¥–∞ –ø–∏—Å–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç (msg_id) –∏ —á—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º
            user_states[str(call.from_user.id)] = {"action": "edit_wait_value", "rid": rid, "msg_id": mid}
            save_data(data)
            text = f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è R{rid} (–Ω–∞–ø—Ä–∏–º–µ—Ä: +500 –ø—Ä–æ–¥–∞–∂–∞)"
            # –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –æ–∫–Ω–æ, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏–ª–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            bot.edit_message_text(text, cid, mid, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        # --- üóë –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ (–ø–æ –∫–Ω–æ–ø–∫–µ) ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ –∂–µ –æ–∫–Ω–æ
        elif data_cd.startswith("delete_record:"):
            rid = int(data_cd.split(":")[1])
            ok, rec = delete_record_in_chat(cid, rid)
            if ok:
                text = f"‚úÖ –ó–∞–ø–∏—Å—å R{rid} —É–¥–∞–ª–µ–Ω–∞.\n–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—ë–Ω: {get_chat_store(cid).get('balance',0)} ars"
            else:
                text = "‚ö†Ô∏è –ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."
            bot.edit_message_text(text, cid, mid, reply_markup=build_main_keyboard(cid))
            bot.answer_callback_query(call.id)

        else:
            bot.answer_callback_query(call.id)

    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback: {e}")


# --------------------------------------------
# –û–¢–°–ï–ö 8 ‚Äî –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –ø–µ—Ä–µ—Å—ã–ª–∫–∞ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∏ –≤—ã—Ä–æ–≤–Ω–µ–Ω–Ω—ã–π)
# --------------------------------------------
@bot.message_handler(func=lambda m: True, content_types=["text", "photo", "document", "voice", "video", "audio", "sticker"])
def handle_message(msg):
    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–æ–≤ –∏ –±–µ–∑ from_user
    if not getattr(msg, "from_user", None):
        return
    if msg.from_user.is_bot:
        return

    chat_id = msg.chat.id
    user_id = msg.from_user.id

    # --- 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∞–Ω–∞–ª–æ–≥ /edit)
    chat_key = str(chat_id)
    user_states = data.setdefault("tracked_messages", {}).get(chat_key, {})
    state = user_states.get(str(user_id))
    if state and state.get("action") == "edit_wait_value":
        rid = state.get("rid")
        target_msg_id = state.get("msg_id")  # message id –æ–∫–Ω–∞, –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        lines = msg.text.splitlines() if msg.content_type == "text" and msg.text else []
        if not lines:
            bot.edit_message_text("–í–≤–µ–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É —Å —á–∏—Å–ª–æ–º, –ø—Ä–∏–º–µ—Ä: +500 –ø—Ä–æ–¥–∞–∂–∞.", chat_id, target_msg_id, reply_markup=build_main_keyboard(chat_id))
            return
        first_line = lines[0].strip()
        amt, token = extract_first_number(first_line)
        if amt is None:
            bot.edit_message_text("–ß–∏—Å–ª–æ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.", chat_id, target_msg_id, reply_markup=build_main_keyboard(chat_id))
            return
        m = num_re.search(first_line)
        note = first_line[m.end():].strip() if m else ""
        raw_token = token
        if raw_token.lstrip().startswith("+"):
            final_amt = amt
        elif raw_token.lstrip().startswith("-"):
            final_amt = amt
        else:
            final_amt = -abs(amt)
        ok, updated = update_record_in_chat(chat_id, rid, final_amt, note)
        user_states.pop(str(user_id), None)
        save_data(data)
        if ok:
            bot.edit_message_text(f"‚úÖ –ó–∞–ø–∏—Å—å R{rid} –æ–±–Ω–æ–≤–ª–µ–Ω–∞: {updated['amount']} ‚Äî {updated.get('note','')}\nüí∞ –ë–∞–ª–∞–Ω—Å: {get_chat_store(chat_id).get('balance',0)} ARS", chat_id, target_msg_id, reply_markup=build_main_keyboard(chat_id))
        else:
            bot.edit_message_text("–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", chat_id, target_msg_id, reply_markup=build_main_keyboard(chat_id))
        return

    # --- 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ processed_messages (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥—É–±–ª–µ–π)
    processed = data.setdefault("processed_messages", [])
    msg_key = f"{chat_id}:{msg.message_id}"
    if msg_key in processed:
        return

    # --- 3. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞
    owner_int = None
    if OWNER_ID:
        try:
            owner_int = int(OWNER_ID)
        except Exception:
            owner_int = None
    is_owner_msg = (owner_int is not None and user_id == owner_int)

    # --- 4. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    def process_lines_and_record(lines_list, target_chat):
        any_added_local = False
        for line in lines_list:
            line = line.strip()
            if not line:
                continue
            amt, token = extract_first_number(line)
            if amt is None:
                continue
            m = num_re.search(line)
            note = line[m.end():].strip() if m else ""
            raw_token = token
            if raw_token.lstrip().startswith("+"):
                final_amt = amt
            elif raw_token.lstrip().startswith("-"):
                final_amt = amt
            else:
                final_amt = -abs(amt)
            add_record_to_chat(target_chat, final_amt, note, user_id)
            any_added_local = True
        return any_added_local

    # --- 5. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç/–ø–æ–¥–ø–∏—Å—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    lines_for_processing = []
    if msg.content_type == "text" and msg.text:
        lines_for_processing = msg.text.splitlines()
    elif msg.content_type in ["photo", "document", "video", "audio"] and getattr(msg, "caption", None):
        lines_for_processing = msg.caption.splitlines()

    # --- 6. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —ç—Ç–∏ —Å—Ç—Ä–æ–∫–∏
    if lines_for_processing:
        added = process_lines_and_record(lines_for_processing, chat_id)

        # –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–µ—Å–ª–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∏–∑ –¥—Ä—É–≥–æ–≥–æ —á–∞—Ç–∞)
        # –∏ –ø—Ä–∏—à–ª–æ –≤ –ª–∏—á–∫—É –±–æ—Ç–∞ ‚Äî –æ–Ω–æ —Ç–æ–∂–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è
        if msg.chat.type == "private" and added:
            try:
                last_msg_id = msg.message_id - 1  # –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—à–ª–æ–µ –æ–∫–Ω–æ
                new_text = f"‚úÖ –ó–∞–ø–∏—Å–∞–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–∏.\nüí∞ –ë–∞–ª–∞–Ω—Å: {get_chat_store(chat_id).get('balance',0)} ARS"
                bot.edit_message_text(new_text, chat_id, last_msg_id, reply_markup=build_main_keyboard(chat_id))
            except Exception:
                bot.reply_to(msg, f"‚úÖ –ó–∞–ø–∏—Å–∞–Ω–æ.\nüí∞ –ë–∞–ª–∞–Ω—Å: {get_chat_store(chat_id).get('balance',0)} ARS", reply_markup=build_main_keyboard(chat_id))
        elif added:
            bot.reply_to(msg, f"‚úÖ –ó–∞–ø–∏—Å–∞–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–∏.\nüí∞ –ë–∞–ª–∞–Ω—Å: {get_chat_store(chat_id).get('balance',0)} ARS", reply_markup=build_main_keyboard(chat_id))

        processed.append(msg_key)
        if len(processed) > 1000:
            processed = processed[-500:]
        data["processed_messages"] = processed
        save_data(data)

    # --- 7. –ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤ forward_targets (–±–µ–∑ –¥—É–±–ª–µ–π)
    if is_owner_msg:
        for target in list(data.get("forward_targets", [])):
            try:
                t = int(target)
            except Exception:
                continue
            if t == chat_id:
                if owner_int and t != owner_int:
                    try:
                        sent = bot.copy_message(chat_id=owner_int, from_chat_id=chat_id, message_id=msg.message_id)
                        if sent:
                            key = f"{sent.chat.id}:{sent.message_id}"
                            processed.append(key)
                            if len(processed) > 1000:
                                processed = processed[-500:]
                            data["processed_messages"] = processed
                            save_data(data)
                        log_info(f"–í–ª–∞–¥–µ–ª–µ—Ü –Ω–∞–ø–∏—Å–∞–ª –≤ —Ü–µ–ª—å {t} ‚Äî –ø–µ—Ä–µ—Å–ª–∞–Ω–æ –≤ –ª–∏—á–∫—É {owner_int}")
                    except Exception as e:
                        log_error(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü—É: {e}")
                continue
            try:
                sent = bot.copy_message(chat_id=t, from_chat_id=chat_id, message_id=msg.message_id)
                if sent:
                    key = f"{sent.chat.id}:{sent.message_id}"
                    processed.append(key)
                    if len(processed) > 1000:
                        processed = processed[-500:]
                    data["processed_messages"] = processed
                    save_data(data)
                log_info(f"–ü–µ—Ä–µ—Å–ª–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤ {t}")
            except Exception as e:
                log_error(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –≤ {t}: {e}")

# --------------------------------------------
# –û–¢–°–ï–ö 9 ‚Äî Flask webhook endpoints –∏ –∞–≤—Ç–æ—É—Å—Ç–∞–Ω–æ–≤–∫–∞
# --------------------------------------------
@app.route("/", methods=["GET"])
def index():
    return f"–ë–æ—Ç –≤–µ—Ä—Å–∏—è {VERSION} –∑–∞–ø—É—â–µ–Ω."

@app.route("/webhook", methods=["POST"])
def webhook():
    try:
        raw = request.stream.read().decode("utf-8")
        update = telebot.types.Update.de_json(raw)
        bot.process_new_updates([update])
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –≤ webhook: {e}")
    return "ok", 200

def ensure_webhook():
    try:
        webhook_url = f"{APP_URL.rstrip('/')}/webhook"
        info = requests.get(f"https://api.telegram.org/bot{TOKEN}/getWebhookInfo", timeout=10).json()
        current = info.get("result", {}).get("url", "")
        if current != webhook_url:
            r = requests.get(f"https://api.telegram.org/bot{TOKEN}/setWebhook", params={"url": webhook_url}, timeout=10)
            try:
                jr = r.json()
            except Exception:
                jr = {"ok": False, "description": r.text}
            if jr.get("ok"):
                log_info(f"Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {webhook_url}")
            else:
                log_error(f"–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ webhook: {jr}")
        else:
            log_info("Webhook —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.")
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏/—É—Å—Ç–∞–Ω–æ–≤–∫–∏ webhook: {e}")

def notify_owner_start():
    if OWNER_ID is None:
        return
    try:
        owner_int = int(OWNER_ID)
    except Exception:
        return
    try:
        text = f"üí¨ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è {VERSION} –∑–∞–ø—É—â–µ–Ω ‚úÖ"
        bot.send_message(owner_int, text, reply_markup=build_main_keyboard())
        log_info("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.")
    except Exception as e:
        log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É: {e}")

# --------------------------------------------
# –û–¢–°–ï–ö 10 ‚Äî –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# --------------------------------------------
if __name__ == "__main__":
    ensure_webhook()
    notify_owner_start()
    log_info(f"–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω (–≤–µ—Ä—Å–∏—è {VERSION})")
    app.run(host="0.0.0.0", port=PORT)

# ============================================
# –ö–æ–Ω–µ—Ü –∫–æ–¥–∞ ‚Äî –≤–µ—Ä—Å–∏—è 9.6.1.6
# –í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫: 655
# ============================================
