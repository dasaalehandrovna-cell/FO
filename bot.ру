# ============================================
# –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è 9.8.6
# –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è (Flask + Webhook)
# ============================================

import os
import json
import csv
import logging
import re
import threading
import time
from datetime import datetime
from zoneinfo import ZoneInfo
import telebot
from flask import Flask, request
from telebot import types

# -----------------------------
# –û–¢–°–ï–ö 1 ‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# -----------------------------
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")
APP_URL = os.getenv("APP_URL", "https://yourapp.onrender.com")
TZ = ZoneInfo("America/Argentina/Catamarca")
DATA_FILE = "data.json"
CSV_FILE = "data.csv"
LOG_FILE = "log.txt"
PORT = int(os.environ.get("PORT", 5000))
VERSION = "9.8.6"

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# -----------------------------
# –û–¢–°–ï–ö 2 ‚Äî –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# -----------------------------
logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[logging.FileHandler(LOG_FILE, encoding="utf-8"), logging.StreamHandler()]
)

def log_info(msg): logging.info(msg)
def log_error(msg): logging.error(msg)

# -----------------------------
# –û–¢–°–ï–ö 3 ‚Äî –•—Ä–∞–Ω–∏–ª–∏—â–µ
# -----------------------------
def default_data():
    return {"chats": {}, "records": [], "next_id": 1, "overall_balance": 0, "active_messages": {}}

def load_data():
    if os.path.exists(DATA_FILE):
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            try: return json.load(f)
            except: return default_data()
    return default_data()

def save_data(d):
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(d, f, ensure_ascii=False, indent=2)

data = load_data()

def get_today_key(): return datetime.now(TZ).strftime("%Y-%m-%d")

def get_chat_store(chat_id):
    cid = str(chat_id)
    if cid not in data["chats"]:
        data["chats"][cid] = {"balance": 0, "records": [], "daily_records": {}, "edit_wait": None, "edit_target": None}
    return data["chats"][cid]

# -----------------------------
# –û–¢–°–ï–ö 4 ‚Äî CSV —ç–∫—Å–ø–æ—Ä—Ç
# -----------------------------
def export_to_csv():
    try:
        with open(CSV_FILE, "w", newline='', encoding="utf-8") as f:
            w = csv.writer(f)
            w.writerow(["chat_id","id","timestamp","amount","note"])
            for cid, cdata in data["chats"].items():
                for rec in cdata.get("records", []):
                    w.writerow([cid, rec["id"], rec["timestamp"], rec["amount"], rec["note"]])
    except Exception as e:
        log_error(f"CSV error: {e}")

# -----------------------------
# –û–¢–°–ï–ö 5 ‚Äî –î–æ–±–∞–≤–ª–µ–Ω–∏–µ / –ò–∑–º–µ–Ω–µ–Ω–∏–µ / –£–¥–∞–ª–µ–Ω–∏–µ
# -----------------------------
def add_record(chat_id, amount, note, owner):
    store = get_chat_store(chat_id)
    rid = data["next_id"]
    rec = {"id": rid, "timestamp": datetime.now(TZ).isoformat(timespec="seconds"),
           "amount": amount, "note": note, "owner": owner}
    store["records"].append(rec)
    data["records"].append(rec)
    store["balance"] += amount
    data["overall_balance"] = sum(r["amount"] for r in data["records"])
    data["next_id"] += 1
    save_data(data); export_to_csv()

def update_record(chat_id, rid, amount, note):
    store = get_chat_store(chat_id)
    for r in store["records"]:
        if r["id"] == rid:
            store["balance"] -= r["amount"]
            r["amount"], r["note"] = amount, note
            store["balance"] += amount
            save_data(data); export_to_csv()
            return True
    return False

def delete_record(chat_id, rid):
    store = get_chat_store(chat_id)
    for r in store["records"]:
        if r["id"] == rid:
            r["note"] = "—É–¥–∞–ª–µ–Ω–æ"
            r["amount"] = 0
            save_data(data); export_to_csv()
            return True
    return False

# -----------------------------
# –û–¢–°–ï–ö 6 ‚Äî –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
# -----------------------------
def build_main_keyboard(chat_id, confirm_reset=False):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(types.InlineKeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å", callback_data="balance"),
           types.InlineKeyboardButton("üìä –û—Ç—á—ë—Ç", callback_data="report"))
    kb.row(types.InlineKeyboardButton("‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å", callback_data="edit_mode"),
           types.InlineKeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ", callback_data="info"))
    if confirm_reset:
        kb.row(types.InlineKeyboardButton("‚úÖ –î–∞", callback_data="reset_confirm"),
               types.InlineKeyboardButton("‚ùå –ù–µ—Ç", callback_data="reset_cancel"))
    else:
        kb.row(types.InlineKeyboardButton("‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å", callback_data="reset_request"))
    return kb

def build_edit_list(chat_id):
    store = get_chat_store(chat_id)
    kb = types.InlineKeyboardMarkup(row_width=2)
    for r in store["records"][-10:]:
        kb.row(
            types.InlineKeyboardButton(f"#{r['id']} {r['note']} ({r['amount']})", callback_data=f"noop"),
            types.InlineKeyboardButton("‚úè", callback_data=f"edit_{r['id']}"),
            types.InlineKeyboardButton("üóë", callback_data=f"del_{r['id']}")
        )
    kb.row(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_main"))
    return kb

# -----------------------------
# –û–¢–°–ï–ö 7 ‚Äî –û—Å–Ω–æ–≤–Ω–æ–µ –æ–∫–Ω–æ
# -----------------------------
def update_window(chat_id):
    store = get_chat_store(chat_id)
    today = get_today_key()
    recs = store["records"]
    inc = sum(r["amount"] for r in recs if r["amount"] > 0)
    exp = sum(abs(r["amount"]) for r in recs if r["amount"] < 0)
    text = f"üìÖ {today}\nüíµ –ü—Ä–∏—Ö–æ–¥: {inc}\nüí∏ –†–∞—Å—Ö–æ–¥: {exp}\nüí∞ –û—Å—Ç–∞—Ç–æ–∫: {store['balance']} ARS"
    kb = build_main_keyboard(chat_id)
    active_id = data["active_messages"].get(str(chat_id))
    if active_id:
        try:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            return
        except: pass
    msg = bot.send_message(chat_id, text, reply_markup=kb)
    data["active_messages"][str(chat_id)] = msg.message_id
    save_data(data)

# -----------------------------
# –û–¢–°–ï–ö 8 ‚Äî Callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
# -----------------------------
@bot.callback_query_handler(func=lambda c: True)
def callbacks(call):
    chat_id = call.message.chat.id
    data["active_messages"][str(chat_id)] = call.message.message_id

    if call.data == "balance":
        update_window(chat_id)
        bot.answer_callback_query(call.id, "–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—ë–Ω ‚úÖ")

    elif call.data == "report":
        store = get_chat_store(chat_id)
        recs = [r for r in store["records"] if r["amount"] < 0]
        text = "üìä –†–∞—Å—Ö–æ–¥—ã:\n" + "\n".join([f"{r['id']}: {r['note']} ({r['amount']})" for r in recs]) if recs else "–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤"
        bot.edit_message_text(text, chat_id, call.message.message_id, reply_markup=build_main_keyboard(chat_id))
        bot.answer_callback_query(call.id)

    elif call.data == "info":
        info_text = (
            f"‚ÑπÔ∏è –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è {VERSION}\n\n"
            "–ö–æ–º–∞–Ω–¥—ã:\n/start ‚Äî —Å–æ–∑–¥–∞—Ç—å –æ–∫–Ω–æ\n"
            "üí∞ –ë–∞–ª–∞–Ω—Å, üìä –û—Ç—á—ë—Ç, ‚úè –ò–∑–º–µ–Ω–∏—Ç—å, ‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å.\n\n"
            "–î–æ–±–∞–≤–ª—è–π—Ç–µ –∑–∞–ø–∏—Å–∏ –ø—Ä—è–º–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏: +500 –∑–∞—Ä–ø–ª–∞—Ç–∞, -200 –µ–¥–∞."
        )
        bot.edit_message_text(info_text, chat_id, call.message.message_id, reply_markup=build_main_keyboard(chat_id))
        bot.answer_callback_query(call.id)

    elif call.data == "edit_mode":
        kb = build_edit_list(chat_id)
        bot.edit_message_text("‚úè –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å:", chat_id, call.message.message_id, reply_markup=kb)
        bot.answer_callback_query(call.id)

    elif call.data.startswith("edit_"):
        rid = int(call.data.split("_")[1])
        store = get_chat_store(chat_id)
        store["edit_wait"] = "change_value"
        store["edit_target"] = rid
        bot.answer_callback_query(call.id, f"–ò–∑–º–µ–Ω–µ–Ω–∏–µ #{rid}")
        bot.send_message(chat_id, f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—É–º–º—É –∏ –∑–∞–º–µ—Ç–∫—É –¥–ª—è –∑–∞–ø–∏—Å–∏ {rid}:")

    elif call.data.startswith("del_"):
        rid = int(call.data.split("_")[1])
        bot.edit_message_reply_markup(chat_id, call.message.message_id,
                                      reply_markup=types.InlineKeyboardMarkup(row_width=2).row(
                                          types.InlineKeyboardButton("‚úÖ –î–∞", callback_data=f"del_confirm_{rid}"),
                                          types.InlineKeyboardButton("‚ùå –ù–µ—Ç", callback_data="edit_mode")))
        bot.answer_callback_query(call.id, f"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ #{rid}")

    elif call.data.startswith("del_confirm_"):
        rid = int(call.data.split("_")[2])
        delete_record(chat_id, rid)
        bot.answer_callback_query(call.id, f"–ó–∞–ø–∏—Å—å #{rid} —É–¥–∞–ª–µ–Ω–∞")
        update_window(chat_id)

    elif call.data == "reset_request":
        bot.edit_message_reply_markup(chat_id, call.message.message_id, reply_markup=build_main_keyboard(chat_id, confirm_reset=True))
        bot.answer_callback_query(call.id)

    elif call.data == "reset_confirm":
        data["chats"][str(chat_id)] = {"balance": 0, "records": []}
        save_data(data)
        update_window(chat_id)
        bot.answer_callback_query(call.id, "–î–∞–Ω–Ω—ã–µ –æ–±–Ω—É–ª–µ–Ω—ã ‚úÖ")

    elif call.data == "reset_cancel" or call.data == "back_main":
        update_window(chat_id)
        bot.answer_callback_query(call.id)

# -----------------------------
# –û–¢–°–ï–ö 9 ‚Äî –°–æ–æ–±—â–µ–Ω–∏—è (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ)
# -----------------------------
num_re = re.compile(r'([+-]?\d+)')

@bot.message_handler(func=lambda m: True)
def handle_message(msg):
    if not msg.text: return
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)

    if store.get("edit_wait") == "change_value":
        rid = store["edit_target"]
        parts = msg.text.strip().split(" ", 1)
        try:
            amount = int(parts[0])
            note = parts[1] if len(parts) > 1 else ""
            update_record(chat_id, rid, amount, note)
            store["edit_wait"] = None
            update_window(chat_id)
            bot.send_message(chat_id, f"‚úÖ –ó–∞–ø–∏—Å—å #{rid} –∏–∑–º–µ–Ω–µ–Ω–∞")
        except:
            bot.send_message(chat_id, "–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞.")
        return

    m = num_re.search(msg.text)
    if not m: return
    raw = m.group(1)
    amount = int(raw)
    note = msg.text.replace(raw, "").strip()
    add_record(chat_id, amount, note, msg.from_user.id)
    update_window(chat_id)

# -----------------------------
# –û–¢–°–ï–ö 10 ‚Äî Flask + –∑–∞–ø—É—Å–∫
# -----------------------------
@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    bot.process_new_updates([telebot.types.Update.de_json(request.get_data().decode("utf-8"))])
    return "ok", 200

@app.route("/", methods=["GET"])
def index():
    return f"–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç v{VERSION} —Ä–∞–±–æ—Ç–∞–µ—Ç", 200

def set_webhook():
    url = f"{APP_URL}/{TOKEN}"
    bot.remove_webhook()
    time.sleep(1)
    bot.set_webhook(url)

if __name__ == "__main__":
    set_webhook()
    app.run(host="0.0.0.0", port=PORT)