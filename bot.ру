# ============================================
# –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è 9.8.6-fo_4  (ID Code_017)
# –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è (–æ–¥–Ω–∏–º —Ñ–∞–π–ª–æ–º; —Ä–∞–∑–±–∏—Ç–∞ –Ω–∞ 2 —á–∞—Å—Ç–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏)
# –ò–∑–º–µ–Ω–µ–Ω–∏—è:
# 1) –û–∫–Ω–∞ –ø–æ –¥–∞—Ç–∞–º –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ: –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–Ω—è —É–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–æ—à–ª–æ–µ –æ–∫–Ω–æ –≠–¢–û–ô –¥–∞—Ç—ã
# 2) –ö–∞–ª–µ–Ω–¥–∞—Ä—å –≤—ã–±–æ—Ä–∞: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 31 –¥–µ–Ω—å –∫–Ω–æ–ø–∫–∞–º–∏
# ============================================

import os
import json
import csv
import io
import logging
import threading
import time
from datetime import datetime, timedelta
from zoneinfo import ZoneInfo

import requests
import telebot
from flask import Flask, request
from telebot import types

# ---------- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ----------
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")  # —Å—Ç—Ä–æ–∫–∞/None
APP_URL = os.getenv("APP_URL", "https://yourapp.onrender.com")
TZ = ZoneInfo(os.getenv("TZ", "America/Argentina/Catamarca"))

DATA_FILE = "data.json"
LOG_FILE = "log.txt"
PORT = int(os.environ.get("PORT", 5000))
VERSION = "9.8.6-fo_4"

KEEP_ALIVE_INTERVAL_SECONDS = int(os.getenv("KEEP_ALIVE_INTERVAL_SECONDS", 13 * 60))
KEEP_ALIVE_SEND_TO_OWNER = os.getenv("KEEP_ALIVE_SEND_TO_OWNER", "true").lower() in ("1", "true", "yes")

if not TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# ---------- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ----------
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s",
    handlers=[logging.StreamHandler(), logging.FileHandler(LOG_FILE, encoding="utf-8")]
)
log = logging.getLogger("finance-bot")


# ---------- –•–µ–ª–ø–µ—Ä—ã: –¥–∞—Ç–∞/–≤—Ä–µ–º—è ----------
def now_local():
    return datetime.now(TZ)


def date_key(dt: datetime | None = None) -> str:
    d = dt or now_local()
    return d.strftime("%Y-%m-%d")


def parse_date_key(s: str) -> datetime:
    return datetime.strptime(s, "%Y-%m-%d").replace(tzinfo=TZ)


def fmt_num(x: float | int) -> str:
    # —Ñ–æ—Ä–º–∞—Ç —Å —Ç–æ—á–∫–∞–º–∏ –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á –∏ –∑–∞–ø—è—Ç–∞—è –∫–∞–∫ –¥–µ—Å—è—Ç–∏—á–Ω—ã–π (–∞—Ä–≥–µ–Ω—Ç–∏–Ω—Å–∫–∏–π —Å—Ç–∏–ª—å)
    s = f"{x:,.2f}"
    s = s.replace(",", "X").replace(".", ",").replace("X", ".")
    # —É–±—Ä–∞—Ç—å ,00 –µ—Å–ª–∏ —Ü–µ–ª–æ–µ
    if s.endswith(",00"):
        s = s[:-3]
    return s


# ---------- –•—Ä–∞–Ω–∏–ª–∏—â–µ ----------
def _read_json_file(path: str, fallback):
    try:
        if os.path.exists(path):
            with open(path, "r", encoding="utf-8") as f:
                return json.load(f)
    except Exception as e:
        log.error(f"_read_json_file {path}: {e}")
    return fallback


def _write_json_file(path: str, payload):
    try:
        with open(path, "w", encoding="utf-8") as f:
            json.dump(payload, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log.error(f"_write_json_file {path}: {e}")


def load_store():
    return _read_json_file(DATA_FILE, {
        "chats": {},  # chat_id: {...}
    })


def save_store(store):
    _write_json_file(DATA_FILE, store)


def get_chat_store(chat_id: int) -> dict:
    store = load_store()
    chats = store.setdefault("chats", {})
    c = chats.setdefault(str(chat_id), {
        "overall_balance": 0,
        "daily_records": {},     # "YYYY-MM-DD": [ {id, amount, note, ts} ]
        "next_id": 1,
        "active_messages_by_date": {},  # "YYYY-MM-DD": message_id
        "forward_targets": [],   # —Å–ø–∏—Å–æ–∫ chat_id (int)
        "last_open_date": None   # "YYYY-MM-DD"
    })
    return c


def commit_chat_store(chat_id: int, chat_store: dict):
    store = load_store()
    store["chats"][str(chat_id)] = chat_store
    save_store(store)


# ---------- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ) ----------
def send_temp_message(chat_id: int, text: str, ttl: int = 5, reply_to: int | None = None):
    m = bot.send_message(chat_id, text, reply_to_message_id=reply_to)
    def _killer(mid):
        time.sleep(ttl)
        try:
            bot.delete_message(chat_id, mid)
        except Exception:
            pass
    threading.Thread(target=_killer, args=(m.message_id,), daemon=True).start()
    return m


# ---------- CSV –∑–∞ –¥–µ–Ω—å ----------
def csv_bytes_for_day(records: list[dict], day_key: str) -> bytes:
    out = io.StringIO()
    w = csv.writer(out, delimiter=";")
    w.writerow(["date", "id", "amount", "note", "timestamp"])
    for r in records:
        w.writerow([day_key, r["id"], str(r["amount"]), r.get("note", ""), r.get("ts", "")])
    return out.getvalue().encode("utf-8")


# ---------- –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã ----------
BTN_PREV = "‚¨ÖÔ∏è –ü—Ä–µ–¥."
BTN_TODAY = "üìÖ –°–µ–≥–æ–¥–Ω—è"
BTN_NEXT = "‚û°Ô∏è –°–ª–µ–¥."
BTN_PICK = "üìÜ –í—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å"
BTN_EDIT = "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
BTN_EXPORT = "üßæ CSV"
BTN_BACK = "üîô –ù–∞–∑–∞–¥"
BTN_CLEAR = "üóë –û–±–Ω—É–ª–∏—Ç—å"
BTN_FORWARD = "üì£ –§–æ—Ä–≤–∞—Ä–¥"
BTN_SET_RECEIVER = "üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å"

def day_keyboard(day_key: str) -> types.ReplyKeyboardMarkup:
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.row(BTN_PREV, BTN_TODAY, BTN_NEXT)
    kb.row(BTN_PICK, BTN_EDIT, BTN_EXPORT)
    return kb


def edit_keyboard() -> types.ReplyKeyboardMarkup:
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.row(BTN_FORWARD, BTN_SET_RECEIVER)
    kb.row(BTN_CLEAR, BTN_BACK)
    return kb


def calendar_last_31_inline() -> types.InlineKeyboardMarkup:
    # –ö–∞–ª–µ–Ω–¥–∞—Ä—å: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 31 –¥–µ–Ω—å, –≤–∫–ª—é—á–∞—è —Å–µ–≥–æ–¥–Ω—è
    today = now_local().date()
    days = [today - timedelta(days=i) for i in range(0, 31)]
    # –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ 7 –≤ —Ä—è–¥
    kb = types.InlineKeyboardMarkup()
    row = []
    for idx, d in enumerate(days, start=1):
        label = d.strftime("%d/%m")
        cb = f"pick:{d.strftime('%Y-%m-%d')}"
        row.append(types.InlineKeyboardButton(text=label, callback_data=cb))
        if idx % 7 == 0:
            kb.row(*row)
            row = []
    if row:
        kb.row(*row)
    return kb


# ---------- –†–µ–Ω–¥–µ—Ä –æ–∫–Ω–∞ –¥–Ω—è ----------
def render_day_window(chat_id: int, day_key: str, replace_same_date_only: bool = True):
    """
    –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–µ –æ–∫–Ω–æ (–Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ) –¥–ª—è day_key.
    –ï—Å–ª–∏ replace_same_date_only == True:
        - —É–¥–∞–ª—è–µ—Ç –¢–û–õ–¨–ö–û –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –æ–∫–Ω–æ —ç—Ç–æ–π –∂–µ –¥–∞—Ç—ã (–µ—Å–ª–∏ –±—ã–ª–æ),
        - –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç –æ–∫–Ω–∞ –¥—Ä—É–≥–∏—Ö –¥–∞—Ç.
    """
    cs = get_chat_store(chat_id)
    records = cs["daily_records"].get(day_key, [])
    day_income = sum(r["amount"] for r in records if r["amount"] > 0)
    day_expense = sum(-r["amount"] for r in records if r["amount"] < 0)
    day_total = sum(r["amount"] for r in records)

    lines = [
        f"üìÖ {day_key}",
        f"‚ûï –î–æ—Ö–æ–¥: {fmt_num(day_income)}",
        f"‚ûñ –†–∞—Å—Ö–æ–¥: {fmt_num(day_expense)}",
        f"üü∞ –ò—Ç–æ–≥–æ –∑–∞ –¥–µ–Ω—å: {fmt_num(day_total)}",
        "",
        "–í–≤–æ–¥ –æ–ø–µ—Ä–∞—Ü–∏–π:",
        "‚Ä¢ +—Å—É–º–º–∞ —Ç–µ–∫—Å—Ç  ‚Äî –¥–æ—Ö–æ–¥ (–Ω–∞–ø—Ä.  +1200 –ø—Ä–æ–¥–∞–∂–∞)",
        "‚Ä¢ -—Å—É–º–º–∞ —Ç–µ–∫—Å—Ç  ‚Äî —Ä–∞—Å—Ö–æ–¥ (–Ω–∞–ø—Ä.  -350 –µ–¥–∞)",
        "",
        "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏:"
    ]
    for r in records[-10:]:
        sign = "Ôºã" if r["amount"] > 0 else "Ôºç"
        lines.append(f"{r['id']:>4} {sign}{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
    text = "\n".join(lines)

    # –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ù–û–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ
    m = bot.send_message(chat_id, text, reply_markup=day_keyboard(day_key))

    # —É–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –æ–∫–Ω–æ –≠–¢–û–ô –¥–∞—Ç—ã
    prev_mid = cs["active_messages_by_date"].get(day_key)
    if prev_mid and replace_same_date_only:
        try:
            bot.delete_message(chat_id, prev_mid)
        except Exception:
            pass

    # —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ –≠–¢–û–ô –¥–∞—Ç—ã
    cs["active_messages_by_date"][day_key] = m.message_id
    cs["last_open_date"] = day_key
    commit_chat_store(chat_id, cs)
    return m


# ---------- –û–±—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è ----------
def recalc_overall_balance(cs: dict):
    total = 0
    for day, arr in cs["daily_records"].items():
        total += sum(r["amount"] for r in arr)
    cs["overall_balance"] = total


def notify_forward_targets(cs: dict, msg: str):
    for tid in cs.get("forward_targets", []):
        try:
            bot.send_message(tid, msg)
        except Exception:
            pass


# ---------- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ ----------
@bot.message_handler(commands=["start", "help"])
def cmd_start(msg):
    chat_id = msg.chat.id
    cs = get_chat_store(chat_id)
    dkey = cs.get("last_open_date") or date_key()
    send_temp_message(chat_id, f"üëã –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç {VERSION}\n–û—Ç–∫—Ä–æ—é –¥–∞—Ç—É: {dkey}", ttl=3)
    render_day_window(chat_id, dkey)


@bot.message_handler(commands=["balance"])
def cmd_balance(msg):
    chat_id = msg.chat.id
    cs = get_chat_store(chat_id)
    recalc_overall_balance(cs)
    commit_chat_store(chat_id, cs)
    bot.send_message(chat_id, f"üíº –û–±—â–∏–π –±–∞–ª–∞–Ω—Å: {fmt_num(cs['overall_balance'])}")


@bot.message_handler(commands=["export"])
def cmd_export(msg):
    chat_id = msg.chat.id
    cs = get_chat_store(chat_id)
    dkey = cs.get("last_open_date") or date_key()
    records = cs["daily_records"].get(dkey, [])
    if not records:
        send_temp_message(chat_id, f"–ó–∞ {dkey} –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç.", ttl=4)
        return
    data = csv_bytes_for_day(records, dkey)
    bot.send_document(chat_id, ("data_" + dkey + ".csv", data))


@bot.message_handler(commands=["forward_set"])
def cmd_forward_set(msg):
    """
    /forward_set <chat_id>  ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —á–∞—Ç-–ø–æ–ª—É—á–∞—Ç–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    /forward_set -<chat_id> ‚Äî —É–¥–∞–ª–∏—Ç—å
    """
    chat_id = msg.chat.id
    cs = get_chat_store(chat_id)
    parts = msg.text.strip().split()
    if len(parts) < 2:
        send_temp_message(chat_id, "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n/forward_set <chat_id> –∏–ª–∏ /forward_set -<chat_id>", ttl=7)
        return
    try:
        val = int(parts[1])
        if val > 0:
            if val not in cs["forward_targets"]:
                cs["forward_targets"].append(val)
                commit_chat_store(chat_id, cs)
            send_temp_message(chat_id, f"–î–æ–±–∞–≤–ª–µ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—å {val}", ttl=5)
        else:
            rid = abs(val)
            if rid in cs["forward_targets"]:
                cs["forward_targets"].remove(rid)
                commit_chat_store(chat_id, cs)
            send_temp_message(chat_id, f"–£–¥–∞–ª—ë–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—å {rid}", ttl=5)
    except ValueError:
        send_temp_message(chat_id, "Chat ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.", ttl=5)


# ---------- Callback: –≤—ã–±–æ—Ä –¥–∞—Ç—ã –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è ----------
@bot.callback_query_handler(func=lambda c: c.data and c.data.startswith("pick:"))
def cb_pick_date(call: types.CallbackQuery):
    chat_id = call.message.chat.id
    dkey = call.data.split(":", 1)[1]
    try:
        # –ø—Ä–æ—Å—Ç–æ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º
        parse_date_key(dkey)
    except Exception:
        bot.answer_callback_query(call.id, "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞")
        return
    bot.answer_callback_query(call.id, f"–û—Ç–∫—Ä—ã–≤–∞—é {dkey}")
    render_day_window(chat_id, dkey)
# ---------- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤/–∫–Ω–æ–ø–æ–∫ ----------
@bot.message_handler(content_types=["text"])
def on_text(msg):
    chat_id = msg.chat.id
    text = (msg.text or "").strip()
    cs = get_chat_store(chat_id)
    last_key = cs.get("last_open_date") or date_key()

    # --- –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –¥–∞—Ç–∞–º ---
    if text == BTN_TODAY:
        render_day_window(chat_id, date_key())
        return
    if text == BTN_PREV:
        # –ø—Ä–µ–¥—ã–¥—É—â–∏–π –¥–µ–Ω—å –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ
        base = parse_date_key(last_key)
        prev = (base - timedelta(days=1)).strftime("%Y-%m-%d")
        render_day_window(chat_id, prev)
        return
    if text == BTN_NEXT:
        base = parse_date_key(last_key)
        nxt = (base + timedelta(days=1)).strftime("%Y-%m-%d")
        render_day_window(chat_id, nxt)
        return
    if text == BTN_PICK:
        bot.send_message(chat_id, "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 31):", reply_markup=calendar_last_31_inline())
        return

    # --- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ / –≠–∫—Å–ø–æ—Ä—Ç ---
    if text == BTN_EDIT:
        bot.send_message(chat_id, "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:", reply_markup=edit_keyboard())
        return
    if text == BTN_BACK:
        # –Ω–∞–∑–∞–¥ –≤ –æ–∫–Ω–æ –¥–Ω—è
        render_day_window(chat_id, last_key)
        return
    if text == BTN_EXPORT or text == "/csv" or text == "CSV":
        # —ç–∫—Å–ø–æ—Ä—Ç –∑–∞ —Ç–µ–∫—É—â–∏–π –æ—Ç–∫—Ä—ã—Ç—ã–π –¥–µ–Ω—å
        records = cs["daily_records"].get(last_key, [])
        if not records:
            send_temp_message(chat_id, f"–ó–∞ {last_key} –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç.", ttl=4)
            return
        data = csv_bytes_for_day(records, last_key)
        bot.send_document(chat_id, (f"data_{last_key}.csv", data))
        return
    if text == BTN_CLEAR:
        # –æ—á–∏—Å—Ç–∏—Ç—å –∑–∞–ø–∏—Å–∏ –¥–Ω—è —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –≤ –¥–≤–µ —Ñ–∞–∑—ã? –ó–¥–µ—Å—å –¥–µ–ª–∞–µ–º —Å—Ä–∞–∑—É.
        cs["daily_records"][last_key] = []
        recalc_overall_balance(cs)
        commit_chat_store(chat_id, cs)
        notify_forward_targets(cs, f"üóë –û—á–∏—Å—Ç–∫–∞ {last_key} –≤ —á–∞—Ç–µ {chat_id}")
        send_temp_message(chat_id, f"–î–µ–Ω—å {last_key} –æ—á–∏—â–µ–Ω.", ttl=4)
        render_day_window(chat_id, last_key)
        return
    if text == BTN_FORWARD:
        arr = cs.get("forward_targets", [])
        if not arr:
            send_temp_message(chat_id, "–ü–æ–ª—É—á–∞—Ç–µ–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω—ã. –î–æ–±–∞–≤—å—Ç–µ: /forward_set <chat_id>", ttl=7)
        else:
            send_temp_message(chat_id, "–¢–µ–∫—É—â–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–∏:\n" + "\n".join(map(str, arr)), ttl=10)
        return
    if text == BTN_SET_RECEIVER:
        bot.send_message(chat_id, "–î–æ–±–∞–≤–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è: /forward_set <chat_id> –∏–ª–∏ /forward_set -<chat_id>")
        return

    # --- –í–≤–æ–¥ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–æ–º: +—Å—É–º–º–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / -—Å—É–º–º–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ---
    # –ü—Ä–∏–º–µ—Ä—ã: "+1200 –ø—Ä–æ–¥–∞–∂–∞", "-350 –µ–¥–∞", "+1000", "-50"
    if text.startswith("+") or text.startswith("-"):
        try:
            parts = text.split(maxsplit=1)
            amount_str = parts[0]  # +1200 –∏–ª–∏ -350
            note = parts[1] if len(parts) > 1 else ""

            # –ú–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—É—é –Ω–∞ —Ç–æ—á–∫—É –¥–ª—è float; —É–¥–∞–ª—è–µ–º –ø–ª—é—Å—ã
            sign = 1 if amount_str[0] == "+" else -1
            num = amount_str[1:].replace(",", ".")
            amount = sign * float(num)

            # –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å (–ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–∫—Ä—ã—Ç—ã–π)
            records = cs["daily_records"].setdefault(last_key, [])
            rid = cs["next_id"]
            records.append({
                "id": rid,
                "amount": amount,
                "note": note,
                "ts": now_local().isoformat()
            })
            cs["next_id"] = rid + 1
            recalc_overall_balance(cs)
            commit_chat_store(chat_id, cs)

            # —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–µ–º, –∫–æ–º—É –Ω—É–∂–Ω–æ —Ñ–æ—Ä–≤–∞—Ä–¥–∏—Ç—å
            a_txt = f"{'+' if amount > 0 else '-'}{fmt_num(abs(amount))}"
            notify_forward_targets(cs, f"üì£ {last_key}: {a_txt} {note}")

            send_temp_message(chat_id, "OK", ttl=2)
            render_day_window(chat_id, last_key)
            return
        except Exception as e:
            log.error(f"parse +/-: {e}")
            send_temp_message(chat_id, "–ù–µ –ø–æ–Ω—è–ª —Å—É–º–º—É. –ü—Ä–∏–º–µ—Ä: +1200 –ø—Ä–æ–¥–∞–∂–∞", ttl=6)
            return

    # --- –ü—Ä–æ—á–µ–µ: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –æ–∫–Ω–æ –¥–Ω—è ---
    render_day_window(chat_id, last_key)


# ---------- Keep-Alive ----------
def _keep_alive_loop():
    while True:
        try:
            # self-ping
            try:
                requests.get(APP_URL, timeout=10)
            except Exception:
                pass
            # –ø–∏–Ω–≥ –≤–ª–∞–¥–µ–ª—å—Ü–∞ (–Ω–µ —á–∞—â–µ —Ä–∞–∑–∞ –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª)
            if KEEP_ALIVE_SEND_TO_OWNER and OWNER_ID:
                try:
                    bot.send_chat_action(int(OWNER_ID), "typing")
                except Exception:
                    pass
        except Exception as e:
            log.error(f"keep-alive: {e}")
        time.sleep(KEEP_ALIVE_INTERVAL_SECONDS)


# ---------- Webhook ----------
@app.route("/", methods=["GET"])
def index():
    return f"OK {VERSION}", 200


@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    try:
        json_str = request.stream.read().decode("utf-8")
        update = telebot.types.Update.de_json(json_str)
        bot.process_new_updates([update])
    except Exception as e:
        log.error(f"webhook: {e}")
    return "OK", 200


def setup_webhook():
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π
    try:
        bot.remove_webhook()
    except Exception:
        pass
    # –°—Ç–∞–≤–∏–º –Ω–æ–≤—ã–π
    url = f"{APP_URL}/{TOKEN}"
    bot.set_webhook(url=url, max_connections=40)


def run_threads():
    threading.Thread(target=_keep_alive_loop, daemon=True).start()


# ---------- –ó–∞–ø—É—Å–∫ ----------
if __name__ == "__main__":
    setup_webhook()
    run_threads()
    # Flask-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –≤–µ–±—Ö—É–∫–∞
    app.run(host="0.0.0.0", port=PORT)