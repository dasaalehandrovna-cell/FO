# ============================================
# üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî 9.8.7-FO-RESTORE
# –ê–≤—Ç–æ-–±—ç–∫–∞–ø CSV + –º–µ—Ç–∞ –≤ Telegram + –∞–≤—Ç–æ-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
# ============================================

import os
import io
import re
import csv
import json
import time
import threading
import logging
from datetime import datetime
from zoneinfo import ZoneInfo

import requests
from flask import Flask, request

import telebot
from telebot import types
from telebot.types import InputFile

# -------------- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è --------------
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")                     # str –∏–ª–∏ int
APP_URL = os.getenv("APP_URL", "https://yourapp.onrender.com")
TZ = ZoneInfo(os.getenv("TZ_NAME", "America/Argentina/Catamarca"))
PORT = int(os.getenv("PORT", 5000))
VERSION = "9.8.7-FO-RESTORE"

# ‚ùó–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –µ—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ csv_meta.json –Ω–µ—Ç,
# –±–æ—Ç –ø–æ–ø—Ä–æ–±—É–µ—Ç —Å–∫–∞—á–∞—Ç—å –µ–≥–æ –ø–æ —ç—Ç–æ–º—É file_id:
CSV_META_FILE_ID_ENV = os.getenv("CSV_META_FILE_ID", "").strip()

# –ø–æ–≤–µ–¥–µ–Ω–∏–µ keep-alive
KEEP_ALIVE_INTERVAL_SECONDS = int(os.getenv("KEEP_ALIVE_INTERVAL_SECONDS", 13*60))
KEEP_ALIVE_SEND_TO_OWNER = os.getenv("KEEP_ALIVE_SEND_TO_OWNER", "1") == "1"

if not TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")

bot = telebot.TeleBot(TOKEN, threaded=True, parse_mode="HTML")
app = Flask(__name__)

# -------------- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ --------------
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s]: %(message)s"
)
def log_info(msg): logging.info(msg)
def log_error(msg): logging.error(msg)

# -------------- –ü—É—Ç–∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ --------------
DATA_FILE = "data.json"         # —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ø–æ —á–∞—Ç–∞–º)
CSV_META_PATH = "csv_meta.json" # –º–µ—Ç–∞ —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º file_id CSV
LOG_FILE = "log.txt"            # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ

# -------------- –•—Ä–∞–Ω–∏–ª–∏—â–µ –∏ IO --------------
def _read_json_file(path, fallback):
    try:
        if os.path.exists(path):
            with open(path, "r", encoding="utf-8") as f:
                return json.load(f)
    except Exception as e:
        log_error(f"_read_json_file: {path}: {e}")
    return fallback

def _write_json_file(path, payload):
    try:
        with open(path, "w", encoding="utf-8") as f:
            json.dump(payload, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"_write_json_file: {path}: {e}")

def default_chat_store():
    return {
        "overall_balance": 0,
        "daily_records": {},   # { "YYYY-MM-DD": [ {id, short_id, amount, note, ts} ] }
        "next_id": 1,
        "active_messages": {}
    }

def load_data():
    return _read_json_file(DATA_FILE, {"chats": {}})

def save_data(data):
    _write_json_file(DATA_FILE, data)

def get_today_key():
    return datetime.now(TZ).strftime("%Y-%m-%d")

def get_chat_store(chat_id: int):
    data = load_data()
    chats = data.setdefault("chats", {})
    key = str(chat_id)
    if key not in chats:
        chats[key] = default_chat_store()
        save_data(data)
    return chats[key]

def put_chat_store(chat_id: int, store: dict):
    data = load_data()
    data["chats"][str(chat_id)] = store
    save_data(data)

# -------------- –ü–∞—Ä—Å–µ—Ä —Å—É–º–º --------------
# –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã –≤–∏–¥–∞: +500, -150, ^+^500^
num_re = re.compile(r'(\^[+-]\^[0-9]+|\^[+-]?[0-9]+\^|[+-]?\s*\d+)')
def parse_amount_token(token: str) -> int:
    t = token.strip()
    for ch in ["^", " ", ".", ",", "-", "_", "'", '"']:
        t = t.replace(ch, "")
    if not t:
        return 0
    if t[0] == "+":
        return int(t[1:])
    if t[0] == "-":
        return -int(t[1:])
    return int(t)

def fmt_num(n: int) -> str:
    # —Ñ–æ—Ä–º–∞—Ç —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á —Ç–æ—á–∫–∞–º–∏: 123456 -> 123.456
    s = f"{abs(n)}"
    parts = []
    while s:
        parts.append(s[-3:])
        s = s[:-3]
    return ("-" if n < 0 else "") + ".".join(reversed(parts))

# -------------- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è --------------
def send_temp_message(chat_id, text, delay: int = 0):
    try:
        m = bot.send_message(chat_id, text)
        if delay > 0:
            def _del(mid):
                time.sleep(delay)
                try:
                    bot.delete_message(chat_id, mid)
                except Exception:
                    pass
            threading.Thread(target=_del, args=(m.message_id,), daemon=True).start()
        return m
    except Exception as e:
        log_error(f"send_temp_message: {e}")

# -------------- CSV –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (–æ–±—â–µ–µ) --------------
def build_overall_csv_bytes(chat_id: int) -> bytes:
    data = load_data()
    store = data.get("chats", {}).get(str(chat_id), default_chat_store())
    rows = []
    for day_key, items in sorted(store.get("daily_records", {}).items()):
        for r in items:
            rows.append([day_key, r["id"], r.get("short_id", f"R{r['id']}"), r["amount"], r.get("note",""), r["ts"]])
    # –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ CSV (–≤ –ø–∞–º—è—Ç–∏)
    buf = io.StringIO()
    w = csv.writer(buf)
    w.writerow(["date","id","short_id","amount","note","timestamp"])
    w.writerows(rows)
    return buf.getvalue().encode("utf-8")

# -------------- META: –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü—É --------------
def send_meta_to_owner(meta_path=CSV_META_PATH):
    try:
        if not OWNER_ID:
            return
        with open(meta_path, "rb") as f:
            bot.send_document(
                int(OWNER_ID),
                InputFile(f, filename="csv_meta.json"),
                caption="üì¶ Meta backup (file_id –¥–ª—è –∞–≤—Ç–æ-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è)"
            )
        log_info("csv_meta.json –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤–ª–∞–¥–µ–ª—å—Ü—É.")
    except Exception as e:
        log_error(f"send_meta_to_owner: {e}")

# -------------- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ CSV –∏ –º–µ—Ç—ã --------------
def send_overall_csv_and_update_meta(target_chat_id: int):
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç –æ–±—â–∏–π CSV, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ, –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç file_id –≤ csv_meta.json
    –∏ –æ—Ç—Å—ã–ª–∞–µ—Ç –º–µ—Ç—É –≤–ª–∞–¥–µ–ª—å—Ü—É.
    """
    try:
        csv_bytes = build_overall_csv_bytes(target_chat_id)
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ 'data.csv', —á—Ç–æ–±—ã –Ω–µ –≤–∏–¥–µ—Ç—å ¬´—Ä–∞–Ω–¥–æ–º–Ω—ã–µ¬ª –∏–º–µ–Ω–∞
        file_msg = bot.send_document(
            target_chat_id,
            InputFile(io.BytesIO(csv_bytes), filename="data.csv"),
            caption="üìä –û–±—â–µ–µ CSV (–≤—Å–µ –¥–Ω–∏)"
        )
        file_id = file_msg.document.file_id
        meta = {"file_id": file_id, "file_name": "data.csv", "timestamp": time.time()}
        _write_json_file(CSV_META_PATH, meta)
        log_info(f"üì¶ CSV FILE_ID = {file_id}")
        # –æ—Ç–ø—Ä–∞–≤–∏–º –º–µ—Ç—É –≤–ª–∞–¥–µ–ª—å—Ü—É
        send_meta_to_owner(CSV_META_PATH)
        return True
    except Exception as e:
        log_error(f"send_overall_csv_and_update_meta: {e}")
        return False

# -------------- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ –º–µ—Ç–∞ --------------
def _download_file_by_file_id(file_id: str) -> bytes | None:
    try:
        tg_file = bot.get_file(file_id)
        file_path = tg_file.file_path
        url = f"https://api.telegram.org/file/bot{TOKEN}/{file_path}"
        resp = requests.get(url, timeout=30)
        if resp.status_code == 200:
            return resp.content
        log_error(f"_download_file_by_file_id: HTTP {resp.status_code}")
    except Exception as e:
        log_error(f"_download_file_by_file_id: {e}")
    return None

def try_load_meta_from_env_if_missing():
    """–ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–µ—Ç—ã –Ω–µ—Ç, –∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è CSV_META_FILE_ID –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ ‚Äî –∑–∞–±–∏—Ä–∞–µ–º –µ—ë –∏–∑ Telegram."""
    if os.path.exists(CSV_META_PATH):
        return
    if not CSV_META_FILE_ID_ENV:
        log_info("csv_meta.json –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, CSV_META_FILE_ID –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ-–∑–∞–≥—Ä—É–∑–∫—É –º–µ—Ç—ã.")
        return
    log_info("–ü—Ä–æ–±—É–µ–º —Å–∫–∞—á–∞—Ç—å csv_meta.json –ø–æ CSV_META_FILE_ID ...")
    content = _download_file_by_file_id(CSV_META_FILE_ID_ENV)
    if content:
        try:
            meta = json.loads(content.decode("utf-8"))
            _write_json_file(CSV_META_PATH, meta)
            log_info("csv_meta.json –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ Telegram (–ø–æ ENV).")
        except Exception as e:
            log_error(f"try_load_meta_from_env_if_missing: {e}")

def try_restore_csv_from_meta():
    """
    –ê–≤—Ç–æ-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: –µ—Å–ª–∏ –µ—Å—Ç—å csv_meta.json —Å file_id ‚Äî —Å–∫–∞—á–∏–≤–∞–µ–º CSV –∏ –ø–æ–¥–º–µ–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ.
    –§–æ—Ä–º–∞—Ç CSV: date,id,short_id,amount,note,timestamp
    """
    meta = _read_json_file(CSV_META_PATH, {})
    file_id = meta.get("file_id")
    if not file_id:
        log_info("‚ö†Ô∏è CSV file_id –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ Telegram.")
        return False

    log_info("–ü—Ä–æ–±—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å CSV –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É file_id ...")
    content = _download_file_by_file_id(file_id)
    if not content:
        log_error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å CSV –ø–æ file_id.")
        return False

    # –ø–∞—Ä—Å–∏–º CSV –∏ –≤–ª–∏–≤–∞–µ–º –≤ data.json
    try:
        text = content.decode("utf-8")
        rd = csv.DictReader(io.StringIO(text))
        data = load_data()
        chats = data.setdefault("chats", {})
        # –°—Ç—Ä–∞—Ç–µ–≥–∏—è: –≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å–∏ –≤ –¢–ï–ö–£–©–ò–ô —á–∞—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —è–≤–Ω–æ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏.
        # –ê–≤—Ç–æ-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: –ø—Ä–∏–º–µ–Ω–∏–º –∫ –≤–ª–∞–¥–µ–ª—å—Ü—É (–µ—Å–ª–∏ –æ–Ω –∂–µ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å).
        # –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –∏–Ω–∞—á–µ ‚Äî –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º chat_id –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö.
        target_id = str(OWNER_ID) if OWNER_ID else None
        if not target_id:
            log_info("OWNER_ID –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤–ª–∏–≤–∞–Ω–∏–µ CSV.")
            return False

        store = chats.setdefault(target_id, default_chat_store())
        store["daily_records"] = {}
        store["overall_balance"] = 0
        store["next_id"] = 1

        for row in rd:
            day = row["date"]
            rec_id = int(row["id"])
            short_id = row.get("short_id") or f"R{rec_id}"
            amount = int(row["amount"])
            note = row.get("note", "")
            ts = float(row.get("timestamp", time.time()))
            lst = store["daily_records"].setdefault(day, [])
            lst.append({"id": rec_id, "short_id": short_id, "amount": amount, "note": note, "ts": ts})
            store["overall_balance"] += amount
            store["next_id"] = max(store["next_id"], rec_id + 1)

        save_data(data)
        log_info("‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ CSV –∑–∞–≤–µ—Ä—à–µ–Ω–æ.")
        return True
    except Exception as e:
        log_error(f"try_restore_csv_from_meta: {e}")
        return False

# ---- –ê–≤—Ç–æ-–∑–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç—ã –∏ –ø–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ----
try_load_meta_from_env_if_missing()
try_restore_csv_from_meta()
# -------------- –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã --------------
def main_kb():
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.row("üìä –û–±—â–µ–µ CSV", "üí∞ –ë–∞–ª–∞–Ω—Å")
    kb.row("‚ûï –î–æ–±–∞–≤–∏—Ç—å", "üìÖ –°–µ–≥–æ–¥–Ω—è")
    return kb

# -------------- –£—Ç–∏–ª–∏—Ç—ã UI --------------
def show_balance(chat_id: int):
    store = get_chat_store(chat_id)
    bal = store.get("overall_balance", 0)
    bot.send_message(chat_id, f"üí∞ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: <b>{fmt_num(bal)}</b>", reply_markup=main_kb())

def show_today(chat_id: int):
    store = get_chat_store(chat_id)
    day_key = get_today_key()
    items = store.get("daily_records", {}).get(day_key, [])
    if not items:
        bot.send_message(chat_id, f"üìÖ {day_key}\n–ü–æ–∫–∞ –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç.", reply_markup=main_kb())
        return
    lines = [f"üìÖ {day_key} ‚Äî –∑–∞–ø–∏—Å–∏:"]
    for r in items[-30:]:
        sign = "‚ûï" if r["amount"] > 0 else "‚ûñ"
        lines.append(f"{r['short_id']}: {sign}{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
    bot.send_message(chat_id, "\n".join(lines), reply_markup=main_kb())

# -------------- –ó–∞–ø–∏—Å—å –æ–ø–µ—Ä–∞—Ü–∏–∏ --------------
def append_record(chat_id: int, amount: int, note: str):
    store = get_chat_store(chat_id)
    day_key = get_today_key()
    rec_id = store["next_id"]
    store["next_id"] += 1
    short_id = f"R{rec_id}"

    r = {
        "id": rec_id,
        "short_id": short_id,
        "amount": amount,
        "note": note,
        "ts": time.time()
    }
    store["daily_records"].setdefault(day_key, []).append(r)
    store["overall_balance"] += amount
    put_chat_store(chat_id, store)

# -------------- –ö–æ–º–∞–Ω–¥—ã --------------
@bot.message_handler(commands=["start","help"])
def cmd_start(msg):
    chat_id = msg.chat.id
    bot.send_message(
        chat_id,
        "üëã –ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç.\n"
        "‚Ä¢ –û—Ç–ø—Ä–∞–≤–ª—è–π —Å—É–º–º—ã: <code>+500 –ó–∞—Ä–ø–ª–∞—Ç–∞</code> –∏–ª–∏ <code>-150 –û–±–µ–¥</code>\n"
        "‚Ä¢ –ù–∞–∂–º–∏ ¬´üìä –û–±—â–µ–µ CSV¬ª, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å–≤–æ–¥ –∏ –æ–±–Ω–æ–≤–∏—Ç—å –±—ç–∫–∞–ø.\n"
        "‚Ä¢ –ù–∞–∂–º–∏ ¬´üí∞ –ë–∞–ª–∞–Ω—Å¬ª, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å.",
        reply_markup=main_kb()
    )
    show_today(chat_id)

@bot.message_handler(commands=["balance"])
def cmd_balance(msg):
    show_balance(msg.chat.id)

@bot.message_handler(commands=["today"])
def cmd_today(msg):
    show_today(msg.chat.id)

@bot.message_handler(commands=["restore"])
def cmd_restore(msg):
    """
    –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ –ª–æ–∫–∞–ª—å–Ω–æ–º—É csv_meta.json –∏–ª–∏ ENV.
    –ü–æ–ª–µ–∑–Ω–æ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —è–≤–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –Ω–∞ –Ω–æ–≤–æ–º –¥–µ–ø–ª–æ–µ.
    """
    ok = try_restore_csv_from_meta()
    if ok:
        bot.send_message(msg.chat.id, "‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.", reply_markup=main_kb())
    else:
        bot.send_message(msg.chat.id, "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º.", reply_markup=main_kb())

# -------------- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ (—Ç–µ–∫—Å—Ç–∞) --------------
@bot.message_handler(func=lambda m: m.text == "üí∞ –ë–∞–ª–∞–Ω—Å")
def on_balance_btn(msg):
    show_balance(msg.chat.id)

@bot.message_handler(func=lambda m: m.text == "üìÖ –°–µ–≥–æ–¥–Ω—è")
def on_today_btn(msg):
    show_today(msg.chat.id)

@bot.message_handler(func=lambda m: m.text == "üìä –û–±—â–µ–µ CSV")
def on_overall_csv_btn(msg):
    """
    –ö–ù–û–ü–ö–ê ¬´üìä –û–±—â–µ–µ CSV¬ª:
    1) –°–æ–±–∏—Ä–∞–µ–º –æ–±—â–∏–π CSV –ø–æ –≤—Å–µ–º –¥–Ω—è–º
    2) –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ –≤ —ç—Ç–æ—Ç —á–∞—Ç —Å –∏–º–µ–Ω–µ–º 'data.csv'
    3) –û–±–Ω–æ–≤–ª—è–µ–º csv_meta.json (—Å–æ—Ö—Ä–∞–Ω—è–µ–º file_id)
    4) –û—Ç–ø—Ä–∞–≤–ª—è–µ–º csv_meta.json –≤–ª–∞–¥–µ–ª—å—Ü—É (–≤ —á–∞—Ç Telegram)
    """
    ok = send_overall_csv_and_update_meta(msg.chat.id)
    if ok:
        bot.send_message(msg.chat.id, "üì¶ –ë—ç–∫–∞–ø –æ–±–Ω–æ–≤–ª—ë–Ω. –ú–µ—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤–ª–∞–¥–µ–ª—å—Ü—É.", reply_markup=main_kb())
    else:
        bot.send_message(msg.chat.id, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –±—ç–∫–∞–ø.", reply_markup=main_kb())

# -------------- –í–≤–æ–¥ —Å—É–º–º --------------
@bot.message_handler(content_types=["text"])
def on_text(msg):
    text = (msg.text or "").strip()
    # –±—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤—ã—à–µ
    if text in ("üìä –û–±—â–µ–µ CSV","üí∞ –ë–∞–ª–∞–Ω—Å","üìÖ –°–µ–≥–æ–¥–Ω—è"):
        return

    # –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Å—É–º–º—É
    tokens = text.split()
    if not tokens:
        return
    m = num_re.match(tokens[0])
    if not m:
        # –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
        return

    try:
        amount = parse_amount_token(tokens[0])
    except Exception:
        bot.send_message(msg.chat.id, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—É–º–º—É. –ü—Ä–∏–º–µ—Ä: +500 –û–±–µ–¥")
        return

    note = " ".join(tokens[1:]).strip()
    append_record(msg.chat.id, amount, note)
    bot.send_message(msg.chat.id, f"‚úÖ –ó–∞–ø–∏—Å–∞–Ω–æ: {('+' if amount>0 else '')}{fmt_num(amount)} {('- ' + note) if note else ''}")
    show_today(msg.chat.id)
# -------------- Keep-alive --------------
def keep_alive_loop():
    while True:
        try:
            if APP_URL:
                requests.get(APP_URL, timeout=10)
            if KEEP_ALIVE_SEND_TO_OWNER and OWNER_ID:
                # –ª—ë–≥–∫–∏–π "—Ç–∏—Ö–∏–π" –ø–∏–Ω–≥ —Ä–∞–∑ –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª
                try:
                    bot.send_chat_action(int(OWNER_ID), "typing")
                except Exception:
                    pass
        except Exception as e:
            log_error(f"keep_alive_loop: {e}")
        time.sleep(KEEP_ALIVE_INTERVAL_SECONDS)

# -------------- Webhook endpoints --------------
@app.route("/", methods=["GET"])
def index():
    return f"OK {VERSION}"

@app.route("/set_webhook", methods=["GET"])
def set_webhook_route():
    webhook_url = f"{APP_URL}/webhook"
    ok = bot.set_webhook(url=webhook_url, allowed_updates=["message","callback_query"])
    return f"set_webhook: {ok}"

@app.route("/webhook", methods=["POST"])
def webhook():
    try:
        json_str = request.get_data().decode("utf-8")
        update = telebot.types.Update.de_json(json_str)
        bot.process_new_updates([update])
    except Exception as e:
        log_error(f"/webhook: {e}")
    return "OK"

# -------------- –ó–∞–ø—É—Å–∫ --------------
def main():
    # —Å—Ç–∞—Ä—Ç—É–µ–º keep-alive –ø–æ—Ç–æ–∫
    threading.Thread(target=keep_alive_loop, daemon=True).start()

    # –µ—Å–ª–∏ APP_URL —É–∫–∞–∑–∞–Ω ‚Äî —Ä–∞–±–æ—Ç–∞–µ–º —á–µ—Ä–µ–∑ webhook (Flask)
    if APP_URL:
        log_info("–ó–∞–ø—É—Å–∫–∞–µ–º Flask + webhook ...")
        app.run(host="0.0.0.0", port=PORT)
    else:
        # fallback ‚Äî polling
        log_info("APP_URL –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º long polling.")
        bot.remove_webhook()
        bot.infinity_polling(skip_pending=True, allowed_updates=["message","callback_query"])

if __name__ == "__main__":
    main()