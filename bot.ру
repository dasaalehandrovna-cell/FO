import os
from flask import Flask, request
import telebot

# =========================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# =========================
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = int(os.getenv("OWNER_ID", "0"))
PORT = int(os.getenv("PORT", 5000))
WEBHOOK_URL = f"https://{os.getenv('RENDER_EXTERNAL_HOSTNAME')}/{TOKEN}"

bot = telebot.TeleBot(TOKEN)
app = Flask(__name__)

# =========================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook
# =========================
@app.before_first_request
def setup_webhook():
    bot.remove_webhook()
    bot.set_webhook(url=WEBHOOK_URL)
    print(f"‚úÖ Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {WEBHOOK_URL}")

# =========================
# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
# =========================
@bot.message_handler(func=lambda m: True)
def echo_all(message):
    print(f"üì© –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {message.from_user.id}: {message.text}")
    if message.from_user.id == OWNER_ID:
        bot.send_message(message.chat.id, f"‚úÖ –ü—Ä–∏–Ω—è—Ç–æ: {message.text}")
    else:
        bot.send_message(message.chat.id, "‚ùå –ù–µ —Ç–≤–æ–π ID")

# =========================
# Flask endpoint
# =========================
@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    update = telebot.types.Update.de_json(request.data.decode("utf-8"))
    bot.process_new_updates([update])
    return "ok", 200

# =========================
# –ó–∞–ø—É—Å–∫ Flask
# =========================
if __name__ == "__main__":
    print(f"üöÄ –ó–∞–ø—É—Å–∫ –Ω–∞ –ø–æ—Ä—Ç—É {PORT}")
    app.run(host="0.0.0.0", port=PORT)