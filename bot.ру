# ================== ==========================
# üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è 9.8.7-FO-STABLE
# ============================================
# ‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
#  - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—á–Ω—ã–º–∏ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏ –ø–æ –¥–Ω—è–º
#  - –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –æ–∫–Ω–∞ –∏ CSV –ø–æ –¥–∞—Ç–∞–º
#  - –ü–æ–ª–Ω—ã–π Telegram-–±—ç–∫–∞–ø (JSON)
#  - CSV-–±—ç–∫–∞–ø —Å —Å–∞–º–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
#  - –ê–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
#  - Keep-alive + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–ª–∞–¥–µ–ª—å—Ü—É
# ============================================

import os
import io
import re
import csv
import json
import time
import threading
import logging
import requests
from datetime import datetime
from zoneinfo import ZoneInfo
from flask import Flask, request
import telebot
from telebot import types

# --------------------------------------------
# üß© –û–¢–°–ï–ö 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
# --------------------------------------------
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")
APP_URL = os.getenv("APP_URL", "https://yourapp.onrender.com")
TZ = ZoneInfo("America/Argentina/Catamarca")
PORT = int(os.environ.get("PORT", 5000))
VERSION = "9.8.7-FO-STABLE"

DATA_FILE = "data.json"
CSV_FILE = "data.csv"
LOG_FILE = "log.txt"
BACKUP_META_FILE = "backup_meta.json"
CSV_META_FILE = "csv_meta.json"

KEEP_ALIVE_INTERVAL_SECONDS = int(os.getenv("KEEP_ALIVE_INTERVAL_SECONDS", 13 * 60))
KEEP_ALIVE_SEND_TO_OWNER = True

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# --------------------------------------------
# üß© –û–¢–°–ï–ö 2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# --------------------------------------------
logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[logging.FileHandler(LOG_FILE, encoding="utf-8"),
              logging.StreamHandler()]
)
def log_info(m): logging.info(m)
def log_error(m): logging.error(m)
log_info(f"üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –§–û {VERSION}")

# --------------------------------------------
# üß© –û–¢–°–ï–ö 3. –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
# --------------------------------------------
def fmt_num(v):
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —á–∏—Å–ª–æ —Å —Ç–æ—á–∫–∞–º–∏ –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á"""
    try: return f"{v:,.0f}".replace(",", ".")
    except: return str(v)

def delete_message_safe(cid, mid):
    try: bot.delete_message(cid, mid)
    except: pass

def send_temp_message(cid, text, delay=10, **kw):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ)"""
    try:
        m = bot.send_message(cid, text, **kw)
        threading.Timer(delay, lambda: delete_message_safe(cid, m.message_id)).start()
        return m
    except Exception as e:
        log_error(f"send_temp_message: {e}")

def _owner_id_int():
    try: return int(OWNER_ID) if OWNER_ID else None
    except: return None

# --------------------------------------------
# üß© –û–¢–°–ï–ö 4. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Ñ–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
# --------------------------------------------
def default_data():
    return {
        "overall_balance": 0,
        "records": [],
        "chats": {},
        "active_messages": {},
        "next_id": 1,
        "forward_targets": [],
    }

def _read_json_file(p, fb):
    try:
        if os.path.exists(p):
            with open(p, "r", encoding="utf-8") as f: return json.load(f)
    except Exception as e:
        log_error(f"_read_json_file {p}: {e}")
    return fb

def _write_json_file(p, pl):
    try:
        with open(p, "w", encoding="utf-8") as f: json.dump(pl, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"_write_json_file {p}: {e}")

def _merge_defaults(d):
    base = default_data()
    for k, v in base.items():
        if k not in d: d[k] = v
    return d

# --------------------------------------------
# üß© –û–¢–°–ï–ö 5. –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–∑—ã
# --------------------------------------------
def load_data():
    d = _read_json_file(DATA_FILE, default_data())
    return _merge_defaults(d)

def save_data(d):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ –∏ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ CSV –∏ JSON-–±—ç–∫–∞–ø–æ–≤"""
    try:
        _write_json_file(DATA_FILE, d)
        export_to_csv(d)
        schedule_csv_backup()
    except Exception as e:
        log_error(f"save_data: {e}")

data = load_data()

# --------------------------------------------
# üß© –û–¢–°–ï–ö 6. –†–∞–±–æ—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º
# --------------------------------------------
def get_today_key():
    return datetime.now(TZ).strftime("%Y-%m-%d")

def get_chat_store(cid):
    cid = str(cid)
    if cid not in data["chats"]:
        data["chats"][cid] = {
            "balance": 0,
            "records": [],
            "daily_records": {},
            "forward_enabled": False,
            "forward_target_id": None
        }
        save_data(data)
    return data["chats"][cid]

# --------------------------------------------
# üß© –û–¢–°–ï–ö 7. –≠–∫—Å–ø–æ—Ä—Ç CSV
# --------------------------------------------
def export_to_csv(d):
    try:
        with open(CSV_FILE, "w", newline='', encoding="utf-8") as f:
            w = csv.writer(f)
            w.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
            for cid, c in d.get("chats", {}).items():
                for day, recs in c.get("daily_records", {}).items():
                    for r in recs:
                        w.writerow([cid, r["id"], r["short_id"], r["timestamp"],
                                    r["amount"], r["note"], r["owner"], day])
    except Exception as e:
        log_error(f"export_to_csv: {e}")
# --------------------------------------------
# üß© –û–¢–°–ï–ö 8. –û–ø–µ—Ä–∞—Ü–∏–∏: –¥–æ–±–∞–≤–∏—Ç—å / –∏–∑–º–µ–Ω–∏—Ç—å / —É–¥–∞–ª–∏—Ç—å
# --------------------------------------------
def add_record_to_chat(chat_id: int, amount: int, note: str, owner):
    store = get_chat_store(chat_id)
    rid = data.get("next_id", 1)
    rec = {
        "id": rid,
        "short_id": f"R{rid}",
        "timestamp": datetime.now(TZ).isoformat(timespec="seconds"),
        "amount": amount,
        "note": note,
        "owner": owner,
    }
    # –≥–ª–æ–±–∞–ª—å–Ω–∞—è –ª–µ–Ω—Ç–∞
    data.setdefault("records", []).append(rec)
    data["next_id"] = rid + 1
    data["overall_balance"] = data.get("overall_balance", 0) + amount

    # –ª–µ–Ω—Ç–∞ —á–∞—Ç–∞
    store.setdefault("records", []).append(rec)
    day_key = get_today_key()
    store.setdefault("daily_records", {}).setdefault(day_key, []).append(rec)
    store["balance"] = store.get("balance", 0) + amount

    save_data(data)
    return rec


def update_record_in_chat(chat_id: int, rid: int, new_amount: int, new_note: str, user=None):
    store = get_chat_store(chat_id)
    found = None
    for r in store.get("records", []):
        if r["id"] == rid:
            r["amount"] = new_amount
            r["note"] = new_note
            found = r
            break

    if not found:
        return False, None

    # —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –¥–Ω–µ–≤–Ω—ã–µ —Å—Ä–µ–∑—ã
    for day_recs in store.get("daily_records", {}).values():
        for r in day_recs:
            if r["id"] == rid:
                r.update(found)

    # —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ª–µ–Ω—Ç—É
    for i, r in enumerate(data.get("records", [])):
        if r["id"] == rid:
            data["records"][i] = found
            break

    # –ø–µ—Ä–µ—Å—á—ë—Ç –±–∞–ª–∞–Ω—Å–æ–≤
    store["balance"] = sum(x["amount"] for x in store.get("records", []))
    data["overall_balance"] = sum(x["amount"] for x in data.get("records", []))

    save_data(data)
    return True, found


def delete_record_in_chat(chat_id: int, rid: int, user=None):
    store = get_chat_store(chat_id)
    removed = None

    # —É–±—Ä–∞—Ç—å –∏–∑ –∑–∞–ø–∏—Å–µ–π —á–∞—Ç–∞
    for r in list(store.get("records", [])):
        if r["id"] == rid:
            removed = r
            store["records"].remove(r)
            break

    if not removed:
        return False, None

    # —É–±—Ä–∞—Ç—å –∏–∑ –¥–Ω–µ–≤–Ω—ã—Ö —Å—Ä–µ–∑–æ–≤
    for day_key, recs in store.get("daily_records", {}).items():
        store["daily_records"][day_key] = [x for x in recs if x["id"] != rid]

    # —É–±—Ä–∞—Ç—å –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ª–µ–Ω—Ç—ã
    data["records"] = [x for x in data.get("records", []) if x["id"] != rid]

    # –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –±–∞–ª–∞–Ω—Å—ã
    store["balance"] = sum(x["amount"] for x in store.get("records", []))
    data["overall_balance"] = sum(x["amount"] for x in data.get("records", []))

    save_data(data)
    return True, removed


# --------------------------------------------
# üß© –û–¢–°–ï–ö 9. –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
# --------------------------------------------
def build_main_keyboard(day_key: str, chat_id: int | None = None):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å", callback_data=f"d:{day_key}:balance"),
        types.InlineKeyboardButton("üìä –û—Ç—á—ë—Ç", callback_data=f"d:{day_key}:report"),
    )
    kb.row(
        types.InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data=f"d:{day_key}:refresh"),
        types.InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"d:{day_key}:edit_menu"),
    )
    kb.row(
        types.InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data=f"d:{get_today_key()}:open"),
        types.InlineKeyboardButton("üìÜ –í—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å", callback_data=f"d:{day_key}:pick_date"),
    )
    total = fmt_num(data.get("overall_balance", 0))
    kb.add(types.InlineKeyboardButton(f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {total} ARS", callback_data=f"d:{day_key}:total"))
    return kb


def build_edit_menu_keyboard(day_key: str, chat_id=None):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å", callback_data=f"d:{day_key}:edit_list"),
        types.InlineKeyboardButton("üìÇ –û–±—â–∏–π CSV", callback_data=f"d:{day_key}:csv_all")
    )
    kb.row(
        types.InlineKeyboardButton("üìÖ CSV –∑–∞ –¥–µ–Ω—å", callback_data=f"d:{day_key}:csv_day"),
        types.InlineKeyboardButton("üì® –§–æ—Ä–≤–∞—Ä–¥ (–ø–æ–∑–∂–µ)", callback_data=f"d:{day_key}:noop")
    )
    kb.row(
        types.InlineKeyboardButton("‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å", callback_data=f"d:{day_key}:reset"),
        types.InlineKeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ", callback_data=f"d:{day_key}:info")
    )
    kb.row(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:back_main"))
    return kb


def build_edit_keyboard_for_record(day_key: str, rid: int):
    kb = types.InlineKeyboardMarkup(row_width=1)
    kb.add(types.InlineKeyboardButton("‚úè –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é", callback_data=f"d:{day_key}:edit_manual:{rid}"))
    kb.add(types.InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å", callback_data=f"d:{day_key}:edit_delete:{rid}"))
    kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:edit_back"))
    return kb


def build_confirm_delete_keyboard(day_key: str, rid: int):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å", callback_data=f"d:{day_key}:confirm_delete:{rid}"),
        types.InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data=f"d:{day_key}:cancel_delete")
    )
    return kb


def build_reset_confirm_keyboard(day_key: str):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("‚úÖ –î–∞, –æ–±–Ω—É–ª–∏—Ç—å", callback_data=f"d:{day_key}:confirm_reset_all"),
        types.InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data=f"d:{day_key}:cancel_reset_all")
    )
    return kb


# --------------------------------------------
# üß© –û–¢–°–ï–ö 10. –ê–∫—Ç–∏–≤–Ω—ã–µ –æ–∫–Ω–∞: –ø–æ–ª—É—á–∏—Ç—å/—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å
# --------------------------------------------
def get_active_window_id(chat_id: int, day_key: str):
    return data.setdefault("active_messages", {}).setdefault(day_key, {}).get(str(chat_id))


def set_active_window(chat_id: int, day_key: str, message_id: int):
    data.setdefault("active_messages", {}).setdefault(day_key, {})[str(chat_id)] = message_id
    save_data(data)


def clear_active_window(chat_id: int, day_key: str):
    am = data.setdefault("active_messages", {}).setdefault(day_key, {})
    am.pop(str(chat_id), None)
    save_data(data)


def delete_active_window_if_exists(chat_id: int, day_key: str):
    old_id = get_active_window_id(chat_id, day_key)
    if old_id:
        delete_message_safe(chat_id, old_id)
        clear_active_window(chat_id, day_key)


# --------------------------------------------
# üß© –û–¢–°–ï–ö 11. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–∫–Ω–∞ –¥–Ω—è
# --------------------------------------------
def render_day_text(store: dict, day_key: str) -> str:
    day_records = store.get("daily_records", {}).get(day_key, [])
    daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
    daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
    overall_balance = store.get("balance", 0)

    if not day_records:
        text = (
            f"üìÖ {day_key}\n"
            f"–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å.\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥: {fmt_num(daily_income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {fmt_num(abs(daily_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall_balance)} ARS"
        )
    else:
        lines = [f"üìÖ {day_key}", "üìã –û–ø–µ—Ä–∞—Ü–∏–∏:"]
        for r in day_records[-50:]:
            sign = "+" if r["amount"] > 0 else "-"
            lines.append(f"{r['short_id']}: {sign}{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
        lines.append(
            f"\nüíµ –ü—Ä–∏—Ö–æ–¥: {fmt_num(daily_income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {fmt_num(abs(daily_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall_balance)} ARS"
        )
        text = "\n".join(lines)

    return text


def update_or_send_day_window(chat_id: int, day_key: str, create_if_missing=True, force_new=False):
    store = get_chat_store(chat_id)
    text = render_day_text(store, day_key)
    kb = build_main_keyboard(day_key, chat_id)
    active_id = get_active_window_id(chat_id, day_key)

    if not force_new and active_id:
        try:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            return
        except Exception as e:
            log_error(f"edit_message_text: {e}")

    if not create_if_missing and not force_new:
        return

    try:
        sent = bot.send_message(chat_id, text, reply_markup=kb)
        set_active_window(chat_id, day_key, sent.message_id)
    except Exception as e:
        log_error(f"send new window: {e}")


# --------------------------------------------
# üß© –û–¢–°–ï–ö 12. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–ª–±—ç–∫–æ–≤
# --------------------------------------------
@bot.callback_query_handler(func=lambda c: True)
def handle_callback(call):
    try:
        chat_id = call.message.chat.id
    except Exception:
        return

    data_str = call.data or ""
    if not data_str.startswith("d:"):
        update_or_send_day_window(chat_id, get_today_key())
        bot.answer_callback_query(call.id)
        return

    parts = data_str.split(":")
    if len(parts) < 3:
        bot.answer_callback_query(call.id)
        return

    day_key = parts[1]
    action_tail = parts[2:]
    action = action_tail[0] if action_tail else ""
    store = get_chat_store(chat_id)

    # –æ—Ç–∫—Ä—ã—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å (–∫–∞–ª–µ–Ω–¥–∞—Ä—å/—Å–µ–≥–æ–¥–Ω—è)
    if action in ("open", "calopen"):
        update_or_send_day_window(chat_id, day_key, create_if_missing=True, force_new=True)
        bot.answer_callback_query(call.id, f"–û—Ç–∫—Ä—ã—Ç –¥–µ–Ω—å {day_key}")
        return

    if action == "pick_date":
        # –∫–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 31 –¥–Ω—è
        today = datetime.now(TZ).date()
        days = [today - datetime.timedelta(days=i) if hasattr(datetime, 'timedelta') else None]

    if action == "refresh":
        update_or_send_day_window(chat_id, day_key, create_if_missing=True)
        bot.answer_callback_query(call.id, "–û–±–Ω–æ–≤–ª–µ–Ω–æ üîÑ")
        return

    if action == "info":
        info_text = (
            f"‚ÑπÔ∏è –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç {VERSION}\n\n"
            "–ö–æ–º–∞–Ω–¥—ã: /start /view YYYY-MM-DD /prev /next /balance /report /csv /reset /ping\n"
            "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ: +500 –ó–∞—Ä–ø–ª–∞—Ç–∞ –∏–ª–∏ -150 –û–±–µ–¥\n"
            "CSV: –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –∞–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è."
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(info_text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except Exception as e:
                log_error(f"info edit: {e}")
        bot.answer_callback_query(call.id)
        return

    if action == "balance":
        day_records = store.get("daily_records", {}).get(day_key, [])
        inc = sum(r["amount"] for r in day_records if r["amount"] > 0)
        exp = sum(r["amount"] for r in day_records if r["amount"] < 0)
        bal = store.get("balance", 0)
        text = (
            f"üìÖ {day_key}\n\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥: {fmt_num(inc)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {fmt_num(abs(exp))} ARS\n"
            f"üí∞ –û—Å—Ç–∞—Ç–æ–∫: {fmt_num(bal)} ARS"
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except Exception as e:
                log_error(f"balance edit: {e}")
        bot.answer_callback_query(call.id, "–ë–∞–ª–∞–Ω—Å ‚úÖ")
        return

    if action == "total":
        all_records = data.get("records", [])
        total = data.get("overall_balance", 0)
        total_income = sum(r["amount"] for r in all_records if r["amount"] > 0)
        total_expense = sum(r["amount"] for r in all_records if r["amount"] < 0)
        text = (
            f"üìä –û–±—â–∏–µ –∏—Ç–æ–≥–∏:\n\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥: {fmt_num(total_income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {fmt_num(abs(total_expense))} ARS\n"
            f"üí∞ –û—Å—Ç–∞—Ç–æ–∫: {fmt_num(total)} ARS"
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except Exception as e:
                log_error(f"total edit: {e}")
        bot.answer_callback_query(call.id, "–û–±—â–∏–π –∏—Ç–æ–≥ üìä")
        return

    if action == "report":
        day_records = store.get("daily_records", {}).get(day_key, [])
        expenses = [r for r in day_records if r["amount"] < 0]
        total_exp = sum(abs(r["amount"]) for r in expenses)
        if not expenses:
            text = f"üìÖ {day_key}\n–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤. üí∏ 0 ARS"
        else:
            lines = [f"üìÖ {day_key}", "üìã –†–∞—Å—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å:"]
            for r in expenses[-30:]:
                lines.append(f"{r['short_id']}: -{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
            lines.append(f"\nüí∏ –ò—Ç–æ–≥–æ: {fmt_num(total_exp)} ARS")
            text = "\n".join(lines)
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except Exception as e:
                log_error(f"report edit: {e}")
        bot.answer_callback_query(call.id, "–û—Ç—á—ë—Ç üìä")
        return

    if action == "csv_all":
        # üìå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—â–µ–≥–æ CSV
        try:
            export_to_csv(data)
            with open(CSV_FILE, "rb") as f:
                m = bot.send_document(chat_id, f, caption="üìÇ –ü–æ–ª–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç: data.csv")
            # –µ—Å–ª–∏ —ç—Ç–æ –≤–ª–∞–¥–µ–ª–µ—Ü ‚Äî –µ—â—ë –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º/–∑–∞–ø–æ–º–Ω–∏–º CSV meta
            try_sync_csv_meta_after_send(m)
            bot.answer_callback_query(call.id, "CSV –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω üìÅ")
        except Exception as e:
            send_temp_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ CSV: {e}")
            bot.answer_callback_query(call.id)
        return

    if action == "csv_day":
        filename = f"data_{day_key}.csv"
        try:
            # –ª–æ–∫–∞–ª—å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç –¥–Ω—è
            day_records = store.get("daily_records", {}).get(day_key, [])
            with open(filename, "w", newline='', encoding="utf-8") as f:
                w = csv.writer(f)
                w.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
                for r in day_records:
                    w.writerow([chat_id, r["id"], r["short_id"], r["timestamp"], r["amount"], r["note"], r["owner"], day_key])
            with open(filename, "rb") as f:
                bot.send_document(chat_id, f, caption=f"üìÖ –≠–∫—Å–ø–æ—Ä—Ç –∑–∞ –¥–µ–Ω—å: {filename}")
            bot.answer_callback_query(call.id, f"CSV –∑–∞ {day_key} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")
        except Exception as e:
            send_temp_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ {filename}: {e}")
            bot.answer_callback_query(call.id)
        return

    if action == "edit_menu":
        text = ("‚úèÔ∏è –ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n\n"
                "üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å\n"
                "üìÇ –û–±—â–∏–π CSV / üìÖ CSV –∑–∞ –¥–µ–Ω—å\n"
                "‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞\n"
                "‚ÑπÔ∏è –ò–Ω—Ñ–æ / üîô –ù–∞–∑–∞–¥")
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))
            except Exception as e:
                log_error(f"edit_menu edit: {e}")
        bot.answer_callback_query(call.id, "–ú–µ–Ω—é ‚úèÔ∏è")
        return

    if action == "edit_list":
        day_records = store.get("daily_records", {}).get(day_key, [])
        if not day_records:
            text = f"üìÖ {day_key}\n–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π."
            active_id = get_active_window_id(chat_id, day_key)
            if active_id:
                try:
                    bot.edit_message_text(text, chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))
                except Exception as e:
                    log_error(f"edit_list empty: {e}")
            bot.answer_callback_query(call.id, "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π")
            return

        kb = types.InlineKeyboardMarkup(row_width=1)
        for r in reversed(day_records[-20:]):
            sign = "+" if r["amount"] > 0 else "-"
            label = f"{r['short_id']}: {sign}{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}"
            kb.add(types.InlineKeyboardButton(label, callback_data=f"d:{day_key}:rec:{r['id']}"))
        kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:back_main"))

        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text("–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å:", chat_id, active_id, reply_markup=kb)
            except Exception as e:
                log_error(f"edit_list show: {e}")
        bot.answer_callback_query(call.id)
        return

    if action == "rec" and len(action_tail) >= 2:
        try:
            rid = int(action_tail[1])
        except:
            bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID"); return

        day_records = store.get("daily_records", {}).get(day_key, [])
        rec = next((r for r in day_records if r["id"] == rid), None)
        if not rec:
            bot.answer_callback_query(call.id, "–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"); return

        sign = "+" if rec["amount"] > 0 else "-"
        text = f"–ó–∞–ø–∏—Å—å {rec['short_id']}\n{sign}{fmt_num(abs(rec['amount']))} ‚Äî {rec.get('note','')}\n–î–æ–±–∞–≤–ª–µ–Ω–∞: {rec.get('timestamp')}"
        kb = build_edit_keyboard_for_record(day_key, rid)

        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            except Exception as e:
                log_error(f"rec show: {e}")
        bot.answer_callback_query(call.id)
        return

    if action == "edit_manual" and len(action_tail) >= 2:
        try:
            rid = int(action_tail[1])
        except:
            bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID"); return

        store["edit_wait"] = f"change_value:{day_key}"
        store["edit_target"] = rid
        save_data(data)

        text = (
            f"‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ R{rid}\n\n"
            "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—É–º–º—É –∏ –∑–∞–º–µ—Ç–∫—É:\n"
            "+500 –ó–∞—Ä–ø–ª–∞—Ç–∞  –∏–ª–∏  ^+^500^ –ó–∞—Ä–ø–ª–∞—Ç–∞  –∏–ª–∏  ^-^150^ –û–±–µ–¥"
        )
        kb = types.InlineKeyboardMarkup(row_width=1)
        kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:edit_list"))

        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            except Exception as e:
                log_error(f"edit_manual edit: {e}")
        bot.answer_callback_query(call.id, "–û–∂–∏–¥–∞–Ω–∏–µ —Å—É–º–º—ã ‚úèÔ∏è")
        return

    if action == "edit_delete" and len(action_tail) >= 2:
        try:
            rid = int(action_tail[1])
        except:
            bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID"); return

        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(
                    f"‚ùó –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ R{rid}:",
                    chat_id, active_id,
                    reply_markup=build_confirm_delete_keyboard(day_key, rid)
                )
            except Exception as e:
                log_error(f"edit_delete confirm: {e}")
        bot.answer_callback_query(call.id)
        return

    if action == "confirm_delete" and len(action_tail) >= 2:
        try:
            rid = int(action_tail[1])
        except:
            bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID"); return

        ok, _ = delete_record_in_chat(chat_id, rid, user=call.from_user)
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            bot.edit_message_text(
                "‚úÖ –ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞" if ok else "‚ö†Ô∏è –ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞",
                chat_id, active_id,
                reply_markup=build_edit_menu_keyboard(day_key, chat_id)
            )
        bot.answer_callback_query(call.id, "–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞" if ok else "–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return

    if action == "cancel_delete":
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            bot.edit_message_text("‚úèÔ∏è –ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è", chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))
        bot.answer_callback_query(call.id, "–û—Ç–º–µ–Ω–∞")
        return

    if action == "reset":
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(
                    "‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞?",
                    chat_id, active_id,
                    reply_markup=build_reset_confirm_keyboard(day_key)
                )
            except Exception as e:
                log_error(f"reset prompt: {e}")
        bot.answer_callback_query(call.id)
        return

    if action == "confirm_reset_all":
        try:
            cid = str(chat_id)
            # —É–¥–∞–ª–∏—Ç—å –≤—Å—ë –ø–æ —á–∞—Ç—É
            if cid in data.get("chats", {}):
                data["chats"].pop(cid, None)
            # –æ—á–∏—Å—Ç–∏—Ç—å –∑–∞–ø–∏—Å–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ª–µ–Ω—Ç—ã
            data["records"] = [r for r in data.get("records", []) if str(r.get("owner")) != cid]
            data["overall_balance"] = sum(x["amount"] for x in data.get("records", []))
            save_data(data)
            # –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –ø—É—Å—Ç–æ–µ –æ–∫–Ω–æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è
            update_or_send_day_window(chat_id, get_today_key(), create_if_missing=True, force_new=True)
            bot.answer_callback_query(call.id, "–î–∞–Ω–Ω—ã–µ –æ–±–Ω—É–ª–µ–Ω—ã ‚úÖ")
        except Exception as e:
            log_error(f"confirm_reset_all: {e}")
            bot.answer_callback_query(call.id, "–û—à–∏–±–∫–∞")
        return

    if action in ("cancel_reset_all", "edit_back", "back_main", "noop"):
        update_or_send_day_window(chat_id, day_key, create_if_missing=True)
        bot.answer_callback_query(call.id)
        return

    bot.answer_callback_query(call.id)


# --------------------------------------------
# üß© –û–¢–°–ï–ö 13. –ü–∞—Ä—Å–µ—Ä —Å—É–º–º –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
# --------------------------------------------
num_re = re.compile(r'(\^[+-]\^[0-9]+|\^[+-]?[0-9]+\^|[+-]?\s*\d+)')

def parse_amount_token(token: str) -> int:
    t = token.strip()
    for ch in ["^", " ", ".", ",", "-", "_", "'", '"']:
        t = t.replace(ch, "")
    if not t:
        return 0
    if t[0] == "+": return int(t[1:])
    if t[0] == "-": return -int(t[1:])
    return -int(t)  # –±–µ–∑ –∑–Ω–∞–∫–∞ ‚Äî —Å—á–∏—Ç–∞–µ–º —Ä–∞—Å—Ö–æ–¥–æ–º

@bot.message_handler(commands=["start", "info"])
def cmd_start(msg):
    chat_id = msg.chat.id
    update_or_send_day_window(chat_id, get_today_key(), create_if_missing=True, force_new=True)

@bot.message_handler(commands=["help"])
def cmd_help(msg):
    chat_id = msg.chat.id
    send_temp_message(
        chat_id,
        "üìò –§–æ—Ä–º–∞—Ç: +500 –ó–∞—Ä–ø–ª–∞—Ç–∞  –∏–ª–∏  -150 –û–±–µ–¥  (–º–æ–∂–Ω–æ ^+^500^)\n"
        "–ö–æ–º–∞–Ω–¥—ã: /start /view YYYY-MM-DD /prev /next /balance /report /csv /reset /ping",
        delay=15
    )

@bot.message_handler(commands=["ping"])
def cmd_ping(msg):
    send_temp_message(msg.chat.id, "PONG ‚Äî –±–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω ‚úÖ")

def _date_from_cmd(text: str):
    parts = (text or "").split()
    if len(parts) < 2:
        return None
    try:
        return datetime.strptime(parts[1], "%Y-%m-%d").date()
    except Exception:
        return None

@bot.message_handler(commands=["view"])
def cmd_view(msg):
    chat_id = msg.chat.id
    d = _date_from_cmd(msg.text)
    if not d:
        send_temp_message(chat_id, "–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É: /view YYYY-MM-DD"); return
    day_key = d.strftime("%Y-%m-%d")
    update_or_send_day_window(chat_id, day_key, create_if_missing=True, force_new=True)

@bot.message_handler(commands=["prev"])
def cmd_prev(msg):
    chat_id = msg.chat.id
    # –∏—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –æ–∫–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    day_key = get_today_key()
    update_or_send_day_window(chat_id, day_key, create_if_missing=True, force_new=True)

@bot.message_handler(commands=["next"])
def cmd_next(msg):
    chat_id = msg.chat.id
    day_key = get_today_key()
    update_or_send_day_window(chat_id, day_key, create_if_missing=True, force_new=True)

@bot.message_handler(commands=["balance"])
def cmd_balance(msg):
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    dk = get_today_key()
    day_records = store.get("daily_records", {}).get(dk, [])
    inc = sum(r["amount"] for r in day_records if r["amount"] > 0)
    exp = sum(r["amount"] for r in day_records if r["amount"] < 0)
    bal = store.get("balance", 0)
    text = (f"üìÖ {dk}\n\n"
            f"üí∞ –û—Å—Ç–∞—Ç–æ–∫: {fmt_num(bal)} ARS\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥: {fmt_num(inc)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {fmt_num(abs(exp))} ARS")
    bot.send_message(chat_id, text)

@bot.message_handler(commands=["report"])
def cmd_report(msg):
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    dk = get_today_key()
    day_records = store.get("daily_records", {}).get(dk, [])
    expenses = [r for r in day_records if r["amount"] < 0]
    if not expenses:
        bot.send_message(chat_id, f"üìÖ {dk}\n–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ —Å–µ–≥–æ–¥–Ω—è. üí∏ 0 ARS"); return
    lines = [f"üìÖ {dk}", "üìã –†–∞—Å—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å:"]
    for r in expenses[-30:]:
        lines.append(f"{r['short_id']}: -{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
    lines.append(f"\nüí∏ –ò—Ç–æ–≥–æ: {fmt_num(sum(abs(r['amount']) for r in expenses))} ARS")
    bot.send_message(chat_id, "\n".join(lines))

@bot.message_handler(commands=["csv"])
def cmd_csv(msg):
    chat_id = msg.chat.id
    try:
        export_to_csv(data)
        with open(CSV_FILE, "rb") as f:
            m = bot.send_document(chat_id, f, caption="üìÇ –ü–æ–ª–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç: data.csv")
        try_sync_csv_meta_after_send(m)
    except Exception as e:
        send_temp_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ CSV: {e}")

@bot.message_handler(commands=["reset"])
def cmd_reset(msg):
    chat_id = msg.chat.id
    dk = get_today_key()
    active_id = get_active_window_id(chat_id, dk)
    if active_id:
        try:
            bot.edit_message_text(
                "‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞?",
                chat_id, active_id,
                reply_markup=build_reset_confirm_keyboard(dk)
            )
        except Exception as e:
            log_error(f"/reset edit: {e}")
    else:
        bot.send_message(
            chat_id,
            "‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞?",
            reply_markup=build_reset_confirm_keyboard(dk)
        )

# ‚úâÔ∏è –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
@bot.message_handler(func=lambda m: True)
def handle_message(msg):
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    wait_action = store.get("edit_wait")

    # –†–µ–∂–∏–º —Ä—É—á–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    if wait_action and wait_action.startswith("change_value"):
        day_key = get_today_key()
        if ":" in wait_action:
            _, day_key = wait_action.split(":", 1)
        rid = store.get("edit_target")
        if not rid:
            store["edit_wait"] = None
            store["edit_target"] = None
            save_data(data)
            return
        parts = (msg.text or "").strip().split(" ", 1)
        try:
            amount_token = parts[0]
            amount = parse_amount_token(amount_token)
            note = parts[1] if len(parts) > 1 else ""
            ok, _ = update_record_in_chat(chat_id, rid, amount, note, user=msg.from_user)
            store["edit_wait"] = None
            store["edit_target"] = None
            save_data(data)
            update_or_send_day_window(chat_id, day_key)
            send_temp_message(chat_id, f"‚úÖ –ó–∞–ø–∏—Å—å R{rid} {'–∏–∑–º–µ–Ω–µ–Ω–∞' if ok else '–Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}")
        except Exception as e:
            log_error(f"edit manual: {e}")
            send_temp_message(chat_id, "‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞. –ü—Ä–∏–º–µ—Ä: +500 –ó–∞—Ä–ø–ª–∞—Ç–∞ –∏–ª–∏ -150 –û–±–µ–¥", delay=10)
        return

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞)
    if not msg.text:
        return

    lines = (msg.text or "").strip().split("\n")
    added = 0
    for line in lines:
        line = line.strip()
        if not line:
            continue
        m = re.search(num_re, line)
        if not m:
            continue
        try:
            raw = m.group(0)
            raw_clean = raw.replace("^", "").replace(" ", "")
            amount = parse_amount_token(raw_clean)
            note = line.replace(m.group(0), "").strip()
            add_record_to_chat(chat_id, amount, note, msg.from_user.id)
            added += 1
        except Exception as e:
            log_error(f"auto add: {e}")
            send_temp_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞: {line}")

    update_or_send_day_window(chat_id, get_today_key())
    if added:
        send_temp_message(chat_id, f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: {added}")
# --------------------------------------------
# üß© –û–¢–°–ï–ö 14. CSV-–±—ç–∫–∞–ø –≤ Telegram (–≤–ª–∞–¥–µ–ª–µ—Ü)
# --------------------------------------------
_csv_lock = threading.Lock()
_csv_timer = None
_CSV_DEBOUNCE_SECONDS = 2  # —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ —á–∞—Å—Ç—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

def _load_csv_meta():
    return _read_json_file(CSV_META_FILE, {}) or {}

def _save_csv_meta(meta: dict):
    if not isinstance(meta, dict):
        return
    _write_json_file(CSV_META_FILE, meta)

def try_sync_csv_meta_after_send(message_obj):
    """
    –í—ã–∑—ã–≤–∞–µ–º –ö–ê–ñ–î–´–ô —Ä–∞–∑, –∫–æ–≥–¥–∞ –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–∏–ª data.csv –≤—Ä—É—á–Ω—É—é (–∫–Ω–æ–ø–∫–æ–π/–∫–æ–º–∞–Ω–¥–æ–π).
    –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –±—ã–ª–∞ –≤–æ –í–õ–ê–î–ï–õ–¨–¶–£ ‚Äî –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –µ–≥–æ message_id –∏ file_id,
    —á—Ç–æ–±—ã –¥–∞–ª—å—à–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å —Ç–∏—Ö–∏–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.
    """
    try:
        owner = _owner_id_int()
        if not owner or not message_obj:
            return
        if getattr(message_obj, "chat", None) and message_obj.chat.id == owner and getattr(message_obj, "document", None):
            meta = _load_csv_meta()
            meta["message_id"] = message_obj.message_id
            meta["file_id"] = message_obj.document.file_id
            meta["updated_at"] = datetime.now(TZ).isoformat(timespec="seconds")
            _save_csv_meta(meta)
            log_info("CSV meta: —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã message_id/file_id –≤–ª–∞–¥–µ–ª—å—Ü–∞")
    except Exception as e:
        log_error(f"try_sync_csv_meta_after_send: {e}")

def _build_csv_media():
    """–°–æ–∑–¥–∞—ë–º —Å–≤–µ–∂–∏–π file-like –æ–±—ä–µ–∫—Ç –¥–ª—è InputMediaDocument"""
    try:
        with open(CSV_FILE, "rb") as f:
            return io.BytesIO(f.read())
    except Exception as e:
        log_error(f"_build_csv_media: {e}")
        return None

def _csv_send_new_message(owner_id: int):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ù–û–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ —Å CSV –≤–æ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç meta"""
    try:
        with open(CSV_FILE, "rb") as f:
            sent = bot.send_document(owner_id, f, caption="üìÇ –ê–≤—Ç–æ–±—ç–∫–∞–ø CSV (data.csv)")
        meta = {"message_id": sent.message_id, "file_id": sent.document.file_id,
                "updated_at": datetime.now(TZ).isoformat(timespec="seconds")}
        _save_csv_meta(meta)
        log_info("CSV: –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–µ—Ä–≤—ã–π (–∏–ª–∏ –∑–∞–Ω–æ–≤–æ) –±—ç–∫–∞–ø –≤–ª–∞–¥–µ–ª—å—Ü—É.")
        return True
    except Exception as e:
        log_error(f"_csv_send_new_message: {e}")
        return False

def _csv_update_existing_message(owner_id: int, message_id: int):
    """
    –ü—ã—Ç–∞–µ—Ç—Å—è –û–ë–ù–û–í–ò–¢–¨ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞ —á–µ—Ä–µ–∑ editMessageMedia.
    –ï—Å–ª–∏ Telegram –≤–µ—Ä–Ω—ë—Ç –æ—à–∏–±–∫—É (—Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ / –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ) ‚Äî –≤–µ—Ä–Ω—ë–º False,
    —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
    """
    try:
        media_file = _build_csv_media()
        if not media_file:
            return False
        media = types.InputMediaDocument(media=media_file, caption="üìÇ –ê–≤—Ç–æ–±—ç–∫–∞–ø CSV (data.csv)")
        edited = bot.edit_message_media(chat_id=owner_id, message_id=message_id, media=media)
        if edited and getattr(edited, "document", None):
            meta = _load_csv_meta()
            meta["file_id"] = edited.document.file_id
            meta["updated_at"] = datetime.now(TZ).isoformat(timespec="seconds")
            _save_csv_meta(meta)
        return True
    except telebot.apihelper.ApiException as e:
        # –ù–∞–ø—Ä–∏–º–µ—Ä: message to edit not found ‚Äî –∑–Ω–∞—á–∏—Ç, –≤–ª–∞–¥–µ–ª–µ—Ü —É–¥–∞–ª–∏–ª
        log_error(f"_csv_update_existing_message ApiException: {e}")
        return False
    except Exception as e:
        log_error(f"_csv_update_existing_message: {e}")
        return False

def send_or_update_csv_to_owner():
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ-–±—ç–∫–∞–ø–∞ CSV –≤ –ª–∏—á–∫—É –≤–ª–∞–¥–µ–ª—å—Ü–∞.
    –õ–æ–≥–∏–∫–∞:
      1) –ï—Å–ª–∏ –Ω–µ—Ç OWNER_ID ‚Äî –≤—ã—Ö–æ–¥–∏–º.
      2) –ï—Å–ª–∏ –µ—â—ë –ù–ò –†–ê–ó–£ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ CSV ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º meta.
      3) –ï—Å–ª–∏ meta –µ—Å—Ç—å ‚Äî –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å. –ï—Å–ª–∏ –∞–ø–¥–µ–π—Ç –Ω–µ –ø—Ä–æ—à—ë–ª (—Ñ–∞–π–ª/—Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ) ‚Äî –æ—Ç–ø—Ä–∞–≤–∏–º –∑–∞–Ω–æ–≤–æ.
    """
    owner = _owner_id_int()
    if not owner:
        return
    try:
        export_to_csv(data)  # —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ CSV —Å–≤–µ–∂–∏–π –Ω–∞ –¥–∏—Å–∫–µ

        meta = _load_csv_meta()
        message_id = meta.get("message_id")

        if not message_id:
            # –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫/–ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è meta ‚Äî —à–ª—ë–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª
            _csv_send_new_message(owner)
            return

        # –±—ã–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å
        ok = _csv_update_existing_message(owner, message_id)
        if not ok:
            # —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ–ø–∞–ª–æ/—É–¥–∞–ª–µ–Ω–æ ‚Äî —à–ª—ë–º –Ω–æ–≤–æ–µ
            _csv_send_new_message(owner)

    except Exception as e:
        log_error(f"send_or_update_csv_to_owner: {e}")

def schedule_csv_backup():
    """
    –î–µ–±–∞—É–Ω—Å-—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è send_or_update_csv_to_owner().
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ save_data() –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –±–∞–∑—ã.
    """
    global _csv_timer
    with _csv_lock:
        if _csv_timer and _csv_timer.is_alive():
            _csv_timer.cancel()
        _csv_timer = threading.Timer(_CSV_DEBOUNCE_SECONDS, send_or_update_csv_to_owner)
        _csv_timer.daemon = True
        _csv_timer.start()


# --------------------------------------------
# üß© –û–¢–°–ï–ö 15. –°–∞–º–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ CSV –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
# --------------------------------------------
def _restore_from_local_csv():
    """–ï—Å–ª–∏ –µ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π data.csv ‚Äî –ø–µ—Ä–µ—á–∏—Ç—ã–≤–∞–µ–º –∏ —Å—Ç—Ä–æ–∏–º –±–∞–∑—É."""
    if not os.path.exists(CSV_FILE):
        return False
    try:
        restored = default_data()
        with open(CSV_FILE, "r", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            for row in reader:
                chat_id = str(row["chat_id"])
                rec = {
                    "id": int(row["ID"]),
                    "short_id": row["short_id"],
                    "timestamp": row["timestamp"],
                    "amount": int(row["amount"]),
                    "note": row["note"],
                    "owner": row["owner"]
                }
                restored["records"].append(rec)
                restored["chats"].setdefault(chat_id, {"records": [], "daily_records": {}, "balance": 0})
                restored["chats"][chat_id]["records"].append(rec)
                day = row["day_key"]
                restored["chats"][chat_id]["daily_records"].setdefault(day, []).append(rec)
                restored["chats"][chat_id]["balance"] += rec["amount"]
                restored["overall_balance"] += rec["amount"]
                restored["next_id"] = max(restored["next_id"], rec["id"] + 1)
        _write_json_file(DATA_FILE, restored)
        return True
    except Exception as e:
        log_error(f"_restore_from_local_csv: {e}")
        return False

def _restore_from_owner_chat_csv():
    """
    –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ CSV –Ω–µ—Ç (–∏–ª–∏ –æ–Ω –ø—É—Å—Ç), –ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –ü–û–°–õ–ï–î–ù–Æ–Æ –≤–µ—Ä—Å–∏—é CSV —É –≤–ª–∞–¥–µ–ª—å—Ü–∞:
    - –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π message_id/file_id ‚Äî —Å–∫–∞—á–∏–≤–∞–µ–º –ø–æ file_id;
    - –µ—Å–ª–∏ meta –Ω–µ—Ç ‚Äî –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ-–¥–æ–∫—É–º–µ–Ω—Ç —Å –∏–º–µ–Ω–µ–º data.csv —Å—Ä–µ–¥–∏ –Ω–µ–¥–∞–≤–Ω–∏—Ö –∞–ø–¥–µ–π—Ç–æ–≤.
    """
    owner = _owner_id_int()
    if not owner:
        return False
    try:
        meta = _load_csv_meta()
        file_id = meta.get("file_id")
        # –µ—Å–ª–∏ –Ω–µ—Ç file_id ‚Äî –ø—Ä–æ–±—É–µ–º –ø–æ–∏—Å–∫–∞—Ç—å –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∞–ø–¥–µ–π—Ç–∞—Ö
        if not file_id:
            updates = bot.get_updates(limit=50)
            for u in reversed(updates):
                m = getattr(u, "message", None)
                if not m or not getattr(m, "document", None):
                    continue
                fn = m.document.file_name.lower()
                if fn == "data.csv" and m.chat and m.chat.id == owner:
                    file_id = m.document.file_id
                    # –∑–∞–æ–¥–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–º meta (—á—Ç–æ–±—ã –¥–∞–ª—å—à–µ —Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ)
                    meta["message_id"] = m.message_id
                    meta["file_id"] = file_id
                    meta["updated_at"] = datetime.now(TZ).isoformat(timespec="seconds")
                    _save_csv_meta(meta)
                    break

        if not file_id:
            return False

        file_info = bot.get_file(file_id)
        raw = bot.download_file(file_info.file_path)
        with open(CSV_FILE, "wb") as f:
            f.write(raw)

        return _restore_from_local_csv()
    except Exception as e:
        log_error(f"_restore_from_owner_chat_csv: {e}")
        return False

def restore_from_csv_on_start():
    """
    –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ:
      1) –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π data.json –ø—É—Å—Ç –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –ø—Ä–æ–±—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π CSV.
      2) –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ CSV –Ω–µ—Ç ‚Äî –ø—Ä–æ–±—É–µ–º —Å–∫–∞—á–∞—Ç—å CSV –∏–∑ —á–∞—Ç–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞.
      3) –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç—å export_to_csv –µ—â—ë —Ä–∞–∑ (–Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º).
    """
    # –ø—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ data.json
    d = _read_json_file(DATA_FILE, None)
    base_needed = (not d) or (isinstance(d, dict) and not d.get("records"))
    if not base_needed:
        return

    # 1) –ª–æ–∫–∞–ª—å–Ω—ã–π CSV
    if _restore_from_local_csv():
        export_to_csv(load_data())
        log_info("üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ –õ–û–ö–ê–õ–¨–ù–û–ì–û CSV.")
        return

    # 2) CSV —É –≤–ª–∞–¥–µ–ª—å—Ü–∞
    if _restore_from_owner_chat_csv():
        export_to_csv(load_data())
        log_info("üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ CSV –≤–ª–∞–¥–µ–ª—å—Ü–∞ (Telegram).")
        return

    log_info("‚ö†Ô∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ CSV –ø—Ä–æ–ø—É—â–µ–Ω–æ ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")


# --------------------------------------------
# üß© –û–¢–°–ï–ö 16. Webhook, keep-alive, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∏ –∑–∞–ø—É—Å–∫
# --------------------------------------------
@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    try:
        update = telebot.types.Update.de_json(request.get_data().decode("utf-8"))
        bot.process_new_updates([update])
    except Exception as e:
        log_error(f"webhook error: {e}")
    return "OK", 200

@app.route("/", methods=["GET"])
def index():
    return f"–§–û-–±–æ—Ç {VERSION} —Ä–∞–±–æ—Ç–∞–µ—Ç", 200

def set_webhook():
    url = f"{APP_URL}/{TOKEN}"
    try:
        bot.remove_webhook()
        time.sleep(0.5)
        bot.set_webhook(url=url)
        log_info(f"Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {url}")
    except Exception as e:
        log_error(f"set_webhook: {e}")

def keep_alive_task():
    while True:
        try:
            if APP_URL:
                try:
                    r = requests.get(APP_URL, timeout=10)
                    log_info(f"Keep-alive self-ping -> {getattr(r,'status_code','?')}")
                except Exception as e:
                    log_error(f"self-ping: {e}")
            if KEEP_ALIVE_SEND_TO_OWNER and OWNER_ID:
                try:
                    bot.send_message(int(OWNER_ID), f"üü¢ –ë–æ—Ç {VERSION} –∞–∫—Ç–∏–≤–µ–Ω {datetime.now(TZ).isoformat(timespec='seconds')}")
                except Exception as e:
                    log_error(f"notify owner: {e}")
        except Exception as e:
            log_error(f"keep_alive loop: {e}")
        time.sleep(max(10, KEEP_ALIVE_INTERVAL_SECONDS))

def start_keep_alive_thread():
    threading.Thread(target=keep_alive_task, daemon=True).start()

def schedule_daily_window_creation():
    def task():
        last = get_today_key()
        while True:
            try:
                time.sleep(60)
                cur = get_today_key()
                if cur != last:
                    # —Å–æ–∑–¥–∞—ë–º –æ–∫–Ω–æ –Ω–æ–≤–æ–≥–æ –¥–Ω—è –¥–ª—è –≤—Å–µ—Ö —á–∞—Ç–æ–≤
                    for chat_id_str in list(data.get("chats", {}).keys()):
                        try:
                            chat_id = int(chat_id_str)
                            update_or_send_day_window(chat_id, cur, create_if_missing=True, force_new=True)
                        except Exception as e:
                            log_error(f"daily window {chat_id_str}: {e}")
                    last = cur
            except Exception as e:
                log_error(f"daily loop: {e}")
                time.sleep(5)
    threading.Thread(target=task, daemon=True).start()

if __name__ == "__main__":
    # 1) –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ CSV –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (–ª–æ–∫–∞–ª—å–Ω—ã–π ‚Üí Telegram)
    restore_from_csv_on_start()

    # 2) Webhook
    set_webhook()

    # 3) –ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞ –Ω–æ–≤–æ–≥–æ –¥–Ω—è
    schedule_daily_window_creation()

    # 4) Keep-alive
    start_keep_alive_thread()

    # 5) –ù–∞ —Å—Ç–∞—Ä—Ç–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º CSV –≤–ª–∞–¥–µ–ª—å—Ü—É (—Å–æ–∑–¥–∞—Å—Ç –∑–∞–Ω–æ–≤–æ, –µ—Å–ª–∏ —É–¥–∞–ª—ë–Ω)
    try:
        send_or_update_csv_to_owner()
    except Exception as e:
        log_error(f"startup csv sync: {e}")

    log_info(f"–ë–æ—Ç {VERSION} –∑–∞–ø—É—â–µ–Ω")
    try:
        if OWNER_ID:
            bot.send_message(int(OWNER_ID), f"‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! ({VERSION})")
    except Exception as e:
        log_error(f"startup notify: {e}")

    app.run(host="0.0.0.0", port=PORT)