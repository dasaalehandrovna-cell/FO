# ============================================
# –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è 9.8.6-fo_6
# ID Code_019b
# ~1265 —Å—Ç—Ä–æ–∫
# ============================================
# –û–±–Ω–æ–≤–ª–µ–Ω–æ:
#  ‚Ä¢ üìÜ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 31 –¥–Ω—è: –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –¥–∞—Ç—ã –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
#  ‚Ä¢ üîÑ –ö–Ω–æ–ø–∫–∞ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Ç–µ–∫—É—â–µ–µ –æ–∫–Ω–æ –¥–Ω—è (–±–µ–∑ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è)
#  ‚Ä¢ ‚ÑπÔ∏è ¬´–ò–Ω—Ñ–æ¬ª ‚Äî –ø–æ–¥—Ä–æ–±–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞ –∏ –∫–æ–º–∞–Ω–¥—ã (–∫–∞–∫ –≤ fo_1)
#  ‚Ä¢ –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –æ–∫–Ω–∞ –ø–æ –¥–∞—Ç–∞–º: —É–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–µ–∂–Ω–µ–µ –æ–∫–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
#  ‚Ä¢ –ó–∞—â–∏—Ç–∞ TZ: fallback –Ω–∞ UTC‚àí3 –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ tzdata
# ============================================

import os
import json
import csv
import re
import logging
import threading
import time
from datetime import datetime, timedelta, timezone
from zoneinfo import ZoneInfo

import requests
import telebot
from telebot import types
from flask import Flask, request

# -----------------------------
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
# -----------------------------
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")  # —Å—Ç—Ä–æ–∫–∞ —Å —á–∏—Å–ª–æ–º –∏–ª–∏ None
APP_URL = os.getenv("APP_URL", "https://yourapp.onrender.com")

# ‚úÖ TZ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è tzdata
try:
    TZ = ZoneInfo((os.getenv("TZ") or "America/Argentina/Buenos_Aires").strip())
except Exception:
    TZ = timezone(timedelta(hours=-3))  # UTC-3 fallback

DATA_FILE = "data.json"
CSV_FILE = "data.csv"
LOG_FILE = "log.txt"
PORT = int(os.environ.get("PORT", 5000))
VERSION = "9.8.6-fo_6"

# Keep-alive
KEEP_ALIVE_INTERVAL_SECONDS = int(os.getenv("KEEP_ALIVE_INTERVAL_SECONDS", 11 * 60))
KEEP_ALIVE_SEND_TO_OWNER = True

# ‚úÖ –ü–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ ‚Äî –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –æ–∫–Ω–∞ –ø–æ –¥–∞—Ç–∞–º
DELETE_SOURCE_WINDOW_ON_NAV = False        # –∏—Å—Ö–æ–¥–Ω—ã–π –¥–µ–Ω—å –ù–ï —É–¥–∞–ª—è–µ–º
DELETE_TARGET_OLD_WINDOW_ON_NAV = True     # —É–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ä–æ–µ –æ–∫–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
ALWAYS_CREATE_NEW_ON_NAV = True            # —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

if not TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# -----------------------------
# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# -----------------------------
logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[logging.FileHandler(LOG_FILE, encoding="utf-8"), logging.StreamHandler()]
)
def log_info(msg): logging.info(msg)
def log_error(msg): logging.error(msg)
log_info(f"–°—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –í–µ—Ä—Å–∏—è {VERSION}")

# -----------------------------
# –í—Ä–µ–º—è/–¥–∞—Ç—ã/—Ñ–æ—Ä–º–∞—Ç
# -----------------------------
def now_local() -> datetime:
    return datetime.now(TZ)

def today_key() -> str:
    return now_local().strftime("%Y-%m-%d")

def parse_date_key(s: str):
    try:
        return datetime.strptime(s, "%Y-%m-%d").date()
    except Exception:
        return None

def shift_date_key(day_key: str, days: int) -> str:
    d = parse_date_key(day_key) or now_local().date()
    return (d + timedelta(days=days)).strftime("%Y-%m-%d")

def fmt_num(value):
    try:
        return f"{value:,.0f}".replace(",", ".")
    except Exception:
        return str(value)

# -----------------------------
# IO JSON, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
# -----------------------------
def default_data():
    return {
        "overall_balance": 0,
        "records": [],
        "chats": {},
        # –∞–∫—Ç–∏–≤–Ω—ã–µ –æ–∫–Ω–∞: {day_key: {chat_id: message_id}}
        "active_messages": {},
        "processed_messages": [],
        "forward_targets": [],
        "tracked_messages": {},
        "next_id": 1
    }

def _load_json(path, fallback):
    try:
        if os.path.exists(path):
            with open(path, "r", encoding="utf-8") as f:
                return json.load(f)
    except Exception as e:
        log_error(f"_load_json: {path}: {e}")
    return fallback

def _save_json(path, payload):
    try:
        with open(path, "w", encoding="utf-8") as f:
            json.dump(payload, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"_save_json: {path}: {e}")

def load_data():
    d = _load_json(DATA_FILE, default_data())
    base = default_data()
    for k, v in base.items():
        if k not in d:
            d[k] = v
    # sanity-check active_messages
    if isinstance(d.get("active_messages"), dict):
        for k, v in list(d["active_messages"].items()):
            if not (isinstance(k, str) and len(k) == 10 and "-" in k and isinstance(v, dict)):
                d["active_messages"] = {}
                break
    return d

def save_data(d):
    _save_json(DATA_FILE, d)

data = load_data()

# –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: –¥–æ–±–∞–≤–∏—Ç—å OWNER_ID –∫–∞–∫ —Ü–µ–ª–µ–≤–æ–π —Ñ–æ—Ä–≤–∞—Ä–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
if OWNER_ID:
    try:
        oi = int(OWNER_ID)
        if oi not in data.get("forward_targets", []):
            data["forward_targets"].append(oi)
            save_data(data)
    except Exception:
        pass

# -----------------------------
# –•—Ä–∞–Ω–∏–ª–∏—â–µ —á–∞—Ç–∞ –∏ –æ–∫–Ω–∞
# -----------------------------
def get_chat_store(chat_id: int) -> dict:
    cid = str(chat_id)
    if cid not in data["chats"]:
        data["chats"][cid] = {
            "balance": 0,
            "records": [],
            "next_id": 1,
            "daily_records": {},        # {day_key: [records]}
            "active_windows": {},       # —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
            "edit_wait": None,
            "edit_target": None,
            "forward_enabled": False,
            "forward_target_id": None,
            "current_view_day": today_key()
        }
        save_data(data)
    store = data["chats"][cid]
    store.setdefault("forward_enabled", False)
    store.setdefault("forward_target_id", None)
    store.setdefault("current_view_day", today_key())
    save_data(data)
    return store

def get_active_window_id(chat_id: int, day_key: str):
    return data.setdefault("active_messages", {}).setdefault(day_key, {}).get(str(chat_id))

def set_active_window(chat_id: int, day_key: str, message_id: int):
    data.setdefault("active_messages", {}).setdefault(day_key, {})[str(chat_id)] = message_id
    save_data(data)

def clear_active_window(chat_id: int, day_key: str):
    am = data.setdefault("active_messages", {}).setdefault(day_key, {})
    if str(chat_id) in am:
        am.pop(str(chat_id), None)
        save_data(data)

def delete_message_safe(chat_id: int, message_id: int):
    try:
        bot.delete_message(chat_id, message_id)
    except Exception:
        pass

def delete_active_window_if_exists(chat_id: int, day_key: str):
    old_id = get_active_window_id(chat_id, day_key)
    if old_id:
        delete_message_safe(chat_id, old_id)
        clear_active_window(chat_id, day_key)

def send_temp_message(chat_id: int, text: str, delay: int = 5, **kwargs):
    try:
        msg = bot.send_message(chat_id, text, **kwargs)
        if delay and delay > 0:
            threading.Timer(delay, lambda: delete_message_safe(chat_id, msg.message_id)).start()
        return msg
    except Exception as e:
        log_error(f"send_temp_message: {e}")
        return None

def set_current_view_day(chat_id: int, day_key: str):
    store = get_chat_store(chat_id)
    store["current_view_day"] = day_key
    save_data(data)

def get_current_view_day(chat_id: int) -> str:
    store = get_chat_store(chat_id)
    return store.get("current_view_day", today_key())

# -----------------------------
# CSV
# -----------------------------
def export_to_csv(d):
    try:
        with open(CSV_FILE, "w", newline='', encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
            for cid, cdata in d.get("chats", {}).items():
                for day_key, records in cdata.get("daily_records", {}).items():
                    for r in records:
                        writer.writerow([cid, r.get("id"), r.get("short_id"), r.get("timestamp"),
                                         r.get("amount"), r.get("note"), r.get("owner"), day_key])
    except Exception as e:
        log_error(f"export_to_csv: {e}")

def export_day_csv(chat_id: int, day_key: str):
    store = get_chat_store(chat_id)
    day_records = store.get("daily_records", {}).get(day_key, [])
    filename = f"data_{day_key}.csv"
    try:
        with open(filename, "w", newline='', encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
            for r in day_records:
                writer.writerow([chat_id, r.get("id"), r.get("short_id"), r.get("timestamp"),
                                 r.get("amount"), r.get("note"), r.get("owner"), day_key])
    except Exception as e:
        log_error(f"export_day_csv: {e}")
        return None
    return filename

# -----------------------------
# –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –∑–∞–ø–∏—Å—è–º–∏
# -----------------------------
def add_record_to_chat(chat_id: int, amount: int, note: str, owner):
    store = get_chat_store(chat_id)
    rid = data.get("next_id", 1)
    rec = {
        "id": rid,
        "short_id": f"R{rid}",
        "timestamp": now_local().isoformat(timespec="seconds"),
        "amount": amount,
        "note": note,
        "owner": owner
    }
    data.setdefault("records", []).append(rec)
    store.setdefault("records", []).append(rec)
    day = today_key()
    store.setdefault("daily_records", {}).setdefault(day, []).append(rec)
    store["balance"] = store.get("balance", 0) + amount
    data["overall_balance"] = data.get("overall_balance", 0) + amount
    data["next_id"] = rid + 1
    save_data(data)
    try:
        export_to_csv(data)
    except Exception as e:
        log_error(f"CSV –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: {e}")

    if store.get("forward_enabled"):
        target = store.get("forward_target_id") or (int(OWNER_ID) if OWNER_ID else None)
        if target:
            try:
                bot.send_message(
                    int(target),
                    f"üí∞ {fmt_num(rec['amount'])} ARS\nüÜî {rec['short_id']}\nüìù {rec.get('note','')}\n‚è± {rec.get('timestamp')}"
                )
            except Exception as e:
                log_error(f"–§–æ—Ä–≤–∞—Ä–¥ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏: {e}")

    return rec

def update_record_in_chat(chat_id: int, rid: int, new_amount: int, new_note: str, user=None, notify_forward=True):
    store = get_chat_store(chat_id)
    found = None
    for r in store.get("records", []):
        if r["id"] == rid:
            r["amount"] = new_amount
            r["note"] = new_note
            found = r
            break
    if found:
        for day_recs in store.get("daily_records", {}).values():
            for r in day_recs:
                if r["id"] == rid:
                    r.update(found)
        store["balance"] = sum(x["amount"] for x in store.get("records", []))
        data["records"] = [x if x["id"] != rid else found for x in data.get("records", [])]
        data["overall_balance"] = sum(x["amount"] for x in data.get("records", []))
        save_data(data)
        try: export_to_csv(data)
        except: pass
        if notify_forward and store.get("forward_enabled"):
            target = store.get("forward_target_id") or (int(OWNER_ID) if OWNER_ID else None)
            if target:
                try:
                    bot.send_message(int(target), f"‚úèÔ∏è –ò–∑–º–µ–Ω–µ–Ω–∞ –∑–∞–ø–∏—Å—å R{rid}\n–°—É–º–º–∞: {fmt_num(new_amount)} ARS\n–ó–∞–º–µ—Ç–∫–∞: {new_note}")
                except Exception as e:
                    log_error(f"–§–æ—Ä–≤–∞—Ä–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è: {e}")
        return True, found
    return False, None

def delete_record_in_chat(chat_id: int, rid: int, user=None, notify_forward=True):
    store = get_chat_store(chat_id)
    removed = None
    for r in list(store.get("records", [])):
        if r["id"] == rid:
            removed = r
            store["records"].remove(r)
            break
    if removed:
        for day_key, recs in store.get("daily_records", {}).items():
            store["daily_records"][day_key] = [x for x in recs if x["id"] != rid]
        store["balance"] = sum(x["amount"] for x in store.get("records", []))
        data["records"] = [x for x in data.get("records", []) if x["id"] != rid]
        data["overall_balance"] = sum(x["amount"] for x in data.get("records", []))
        save_data(data)
        try: export_to_csv(data)
        except: pass
        if notify_forward and store.get("forward_enabled"):
            target = store.get("forward_target_id") or (int(OWNER_ID) if OWNER_ID else None)
            if target:
                try:
                    bot.send_message(int(target), f"üóë –£–¥–∞–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å R{rid}")
                except Exception as e:
                    log_error(f"–§–æ—Ä–≤–∞—Ä–¥ —É–¥–∞–ª–µ–Ω–∏—è: {e}")
        return True, removed
    return False, None

# -----------------------------
# –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
# -----------------------------

def build_main_keyboard(day_key: str, chat_id: int | None = None):
    """‚úÖ –ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ –¥–Ω—è ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–æ–µ –º–µ–Ω—é –∏–∑ 5 –∫–Ω–æ–ø–æ–∫ —Å –æ–±—â–∏–º –æ—Å—Ç–∞—Ç–∫–æ–º"""
    kb = types.InlineKeyboardMarkup(row_width=2)

    # üß≠ –í–µ—Ä—Ö–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
    kb.row(
        types.InlineKeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å", callback_data=f"d:{day_key}:balance"),
        types.InlineKeyboardButton("üìä –û—Ç—á—ë—Ç", callback_data=f"d:{day_key}:report"),
    )
    kb.row(
        types.InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data=f"d:{day_key}:refresh"),
        types.InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"d:{day_key}:edit_menu"),
    )

    # üìä –ü–æ–ª—É—á–∞–µ–º –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    try:
        total = fmt_num(data.get("overall_balance", 0))
    except Exception:
        total = "0"

    # üßÆ –ù–∏–∂–Ω—è—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –æ–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞)
    kb.add(
        types.InlineKeyboardButton(
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {total} ARS",
            callback_data=f"d:{day_key}:total"
        )
    )

    return kb


def build_edit_menu_keyboard(day_key: str, chat_id=None):
    """–ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã"""
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å", callback_data=f"d:{day_key}:edit_list"),
        types.InlineKeyboardButton("üìÇ –û–±—â–∏–π CSV", callback_data=f"d:{day_key}:csv_all")
    )
    kb.row(
        types.InlineKeyboardButton("üìÖ CSV –∑–∞ –¥–µ–Ω—å", callback_data=f"d:{day_key}:csv_day"),
        types.InlineKeyboardButton("üì® –§–æ—Ä–≤–∞—Ä–¥", callback_data=f"d:{day_key}:toggle_forward")
    )
    kb.row(
        types.InlineKeyboardButton("üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å", callback_data=f"d:{day_key}:set_forward_target"),
        types.InlineKeyboardButton("‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å", callback_data=f"d:{day_key}:reset")
    )
    kb.row(
        types.InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data=f"d:{today_key()}:open"),
        types.InlineKeyboardButton("üìÜ –í—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å", callback_data=f"d:{day_key}:pick_date")
    )
    kb.row(
        types.InlineKeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ", callback_data=f"d:{day_key}:info"),
        types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:back_main")
    )
    return kb


def build_edit_keyboard_for_record(day_key: str, rid: int):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏"""
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.add(types.InlineKeyboardButton("‚úè –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é", callback_data=f"d:{day_key}:edit_manual:{rid}"))
    kb.add(types.InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å", callback_data=f"d:{day_key}:edit_delete:{rid}"))
    kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:edit_back"))
    return kb


def build_confirm_delete_keyboard(day_key: str, rid: int):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏"""
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å", callback_data=f"d:{day_key}:confirm_delete:{rid}"),
        types.InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data=f"d:{day_key}:cancel_delete")
    )
    return kb


def build_reset_confirm_keyboard(day_key: str):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–±–Ω—É–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —á–∞—Ç–∞"""
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("‚úÖ –î–∞, –æ–±–Ω—É–ª–∏—Ç—å", callback_data=f"d:{day_key}:confirm_reset_all"),
        types.InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data=f"d:{day_key}:cancel_reset_all")
    )
    return kb

# -----------------------------
# –ö–∞–ª–µ–Ω–¥–∞—Ä—å ¬´–ø–æ—Å–ª–µ–¥–Ω–∏–µ 31 –¥–µ–Ω—å¬ª ‚Äî –≤–∞—Ä–∏–∞–Ω—Ç B (–∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞)
# -----------------------------
def build_last_31days_calendar():
    today = now_local().date()
    days = [today - timedelta(days=i) for i in range(0, 31)]  # —Å—Ç–∞—Ä–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ: —Ç–æ–ª—å–∫–æ –Ω–∞–∑–∞–¥
    kb = types.InlineKeyboardMarkup()
    row = []
    for idx, d in enumerate(days, start=1):
        label = d.strftime("%d/%m")
        day_key = d.strftime("%Y-%m-%d")
        # –≤–∞—Ä–∏–∞–Ω—Ç B ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º calopen, —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        row.append(types.InlineKeyboardButton(text=label, callback_data=f"d:{day_key}:calopen"))
        if idx % 7 == 0:
            kb.row(*row)
            row = []
    if row:
        kb.row(*row)
    return kb

# -----------------------------
# –†–µ–Ω–¥–µ—Ä –æ–∫–Ω–∞ –¥–Ω—è
# -----------------------------
def render_day_text(store: dict, day_key: str) -> str:
    day_records = store.get("daily_records", {}).get(day_key, [])
    daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
    daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
    overall_balance = store.get("balance", 0)

    if not day_records:
        text = (
            f"üìÖ {day_key}\n"
            f"–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å.\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥: {fmt_num(daily_income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {fmt_num(abs(daily_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall_balance)} ARS"
        )
    else:
        lines = [f"üìÖ {day_key}", "üìã –û–ø–µ—Ä–∞—Ü–∏–∏:"]
        for r in day_records[-50:]:
            sign = "+" if r["amount"] > 0 else "-"
            lines.append(f"{r['short_id']}: {sign}{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
        lines.append(
            f"\nüíµ –ü—Ä–∏—Ö–æ–¥: {fmt_num(daily_income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {fmt_num(abs(daily_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall_balance)} ARS"
        )
        text = "\n".join(lines)

    try:
        if store.get("forward_enabled"):
            tgt = store.get("forward_target_id") or OWNER_ID
            text += f"\n\nüì® –ü–µ—Ä–µ—Å—ã–ª–∫–∞: –í–∫–ª—é—á–µ–Ω–∞ ‚Üí {tgt}"
        else:
            text += f"\n\nüì® –ü–µ—Ä–µ—Å—ã–ª–∫–∞: –í—ã–∫–ª—é—á–µ–Ω–∞"
    except:
        pass
    return text

# -----------------------------
# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞ –¥–Ω—è
# -----------------------------
def update_or_send_day_window(
    chat_id: int,
    day_key: str = None,
    create_if_missing: bool = True,
    force_new: bool = False,
    delete_target_old: bool = False,
    delete_source_old: bool = False,
    source_day_key: str | None = None
):
    day_key = day_key or today_key()
    store = get_chat_store(chat_id)

    if delete_target_old:
        delete_active_window_if_exists(chat_id, day_key)
    if delete_source_old and source_day_key and source_day_key != day_key:
        delete_active_window_if_exists(chat_id, source_day_key)

    set_current_view_day(chat_id, day_key)

    text = render_day_text(store, day_key)
    kb = build_main_keyboard(day_key, chat_id)
    active_id = get_active_window_id(chat_id, day_key)

    if not force_new and active_id:
        try:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            return
        except telebot.apihelper.ApiException as e:
            log_error(f"edit_message_text: {e}")

    if not create_if_missing and not force_new:
        return

    try:
        sent = bot.send_message(chat_id, text, reply_markup=kb)
        set_active_window(chat_id, day_key, sent.message_id)
    except Exception as e:
        log_error(f"send new window: {e}")

# -----------------------------
# Callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫
# -----------------------------
@bot.callback_query_handler(func=lambda c: True)
def handle_callback(call):
    try:
        chat_id = call.message.chat.id
    except Exception:
        return

    data_str = call.data or ""
    if not data_str.startswith("d:"):
        update_or_send_day_window(chat_id, today_key())
        bot.answer_callback_query(call.id)
        return

    parts = data_str.split(":")
    if len(parts) < 3:
        bot.answer_callback_query(call.id)
        return

    day_key = parts[1]
    action_tail = parts[2:]
    action = action_tail[0] if action_tail else ""
    store = get_chat_store(chat_id)
    prev_day = get_current_view_day(chat_id)
    set_current_view_day(chat_id, day_key)

    # --- –ö–∞–ª–µ–Ω–¥–∞—Ä—å: –æ—Ç–∫—Ä—ã—Ç–∏–µ –¥–∞—Ç—ã ---
    if action == "calopen":
        update_or_send_day_window(
            chat_id,
            day_key,
            create_if_missing=True,
            force_new=ALWAYS_CREATE_NEW_ON_NAV,
            delete_target_old=DELETE_TARGET_OLD_WINDOW_ON_NAV,
            delete_source_old=True,
            source_day_key=prev_day
        )
        bot.answer_callback_query(call.id, f"–û—Ç–∫—Ä—ã—Ç –¥–µ–Ω—å {day_key}")
        return

    # --- –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–±—ã—á–Ω–æ–≥–æ –¥–Ω—è ---
    if action == "open":
        update_or_send_day_window(
            chat_id,
            day_key,
            create_if_missing=True,
            force_new=ALWAYS_CREATE_NEW_ON_NAV,
            delete_target_old=DELETE_TARGET_OLD_WINDOW_ON_NAV,
            delete_source_old=DELETE_SOURCE_WINDOW_ON_NAV,
            source_day_key=prev_day
        )
        bot.answer_callback_query(call.id, f"–û—Ç–∫—Ä—ã—Ç –¥–µ–Ω—å {day_key}")
        return

    # --- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã ---
    if action == "pick_date":
        kb = build_last_31days_calendar()
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(
                    "üóì –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 31 –¥–µ–Ω—å):",
                    chat_id,
                    active_id,
                    reply_markup=kb
                )
            except telebot.apihelper.ApiException as e:
                log_error(f"calendar edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id)
        return

    # ‚úÖ –û–¥–Ω–æ–æ–∫–æ–Ω–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è)
    if action == "edit_menu":
        text = (
            "‚úèÔ∏è –ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n\n"
            "üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é\n"
            "üìÇ –û–±—â–∏–π CSV ‚Äî –ø–æ–ª–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö\n"
            "üìÖ CSV –∑–∞ –¥–µ–Ω—å ‚Äî —ç–∫—Å–ø–æ—Ä—Ç —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è\n"
            "üì® –§–æ—Ä–≤–∞—Ä–¥ ‚Äî –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –ø–µ—Ä–µ—Å—ã–ª–∫—É –≤–ª–∞–¥–µ–ª—å—Ü—É\n"
            "üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å ‚Äî –∑–∞–¥–∞—Ç—å ID –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏\n"
            "‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞\n\n"
            "üìÖ –°–µ–≥–æ–¥–Ω—è / üìÜ –í—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å / ‚ÑπÔ∏è –ò–Ω—Ñ–æ / üîô –ù–∞–∑–∞–¥"
        )

        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(
                    text,
                    chat_id,
                    active_id,
                    reply_markup=build_edit_menu_keyboard(day_key, chat_id)
                )
            except telebot.apihelper.ApiException as e:
                log_error(f"edit_menu edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key, create_if_missing=True)

        bot.answer_callback_query(call.id, "–ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚úèÔ∏è")
        return

    # üîÑ –û–±–Ω–æ–≤–∏—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–µ–∫—É—â–µ–µ –æ–∫–Ω–æ
    if action == "refresh":
        active_id = get_active_window_id(chat_id, day_key)
        text = render_day_text(store, day_key)
        if active_id:
            try:
                bot.edit_message_text(
                    text,
                    chat_id,
                    active_id,
                    reply_markup=build_main_keyboard(day_key, chat_id)
                )
            except telebot.apihelper.ApiException as e:
                log_error(f"refresh edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key, create_if_missing=True)
        bot.answer_callback_query(call.id, "–û–±–Ω–æ–≤–ª–µ–Ω–æ üîÑ")
        return

    # ‚ÑπÔ∏è –ò–Ω—Ñ–æ
    if action == "info":
        info_text = (
            f"‚ÑπÔ∏è –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è {VERSION}\n\n"
            "üìå –ö–æ–º–∞–Ω–¥—ã:\n"
            "/start ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –∑–∞ —Å–µ–≥–æ–¥–Ω—è\n"
            "/view YYYY-MM-DD ‚Äî –æ—Ç–∫—Ä—ã—Ç—å —É–∫–∞–∑–∞–Ω–Ω—ã–π –¥–µ–Ω—å\n"
            "/prev /next ‚Äî –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–Ω—è–º\n"
            "/balance ‚Äî –æ—Å—Ç–∞—Ç–æ–∫ –∑–∞ –¥–µ–Ω—å\n"
            "/report ‚Äî —Å–ø–∏—Å–æ–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤\n"
            "/csv ‚Äî –æ–±—â–∏–π CSV\n"
            "/reset ‚Äî –æ–±–Ω—É–ª–µ–Ω–∏–µ —á–∞—Ç–∞\n"
            "/ping ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\n\n"
            "üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π:\n"
            "+500 –ó–∞—Ä–ø–ª–∞—Ç–∞ –∏–ª–∏ -150 –û–±–µ–¥\n\n"
            "‚öôÔ∏è –°–∏—Å—Ç–µ–º–Ω–æ: CSV, —Ñ–æ—Ä–≤–∞—Ä–¥, webhook, keep-alive –∞–∫—Ç–∏–≤–Ω—ã."
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(
                    info_text,
                    chat_id,
                    active_id,
                    reply_markup=build_main_keyboard(day_key, chat_id)
                )
            except telebot.apihelper.ApiException as e:
                log_error(f"info edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id)
        return

    # üí∞ –ë–∞–ª–∞–Ω—Å –∑–∞ –¥–µ–Ω—å
    if action == "balance":
        day_records = store.get("daily_records", {}).get(day_key, [])
        daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
        daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
        overall_balance = store.get("balance", 0)
        text = (
            f"üìÖ {day_key}\n\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(daily_income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(abs(daily_expense))} ARS\n"
            f"üí∞ –û—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall_balance)} ARS"
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(
                    text,
                    chat_id,
                    active_id,
                    reply_markup=build_main_keyboard(day_key, chat_id)
                )
            except telebot.apihelper.ApiException as e:
                log_error(f"balance edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, "–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—ë–Ω ‚úÖ")
        return

    # üßÆ –û–±—â–∏–π –∏—Ç–æ–≥ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è
    if action == "total":
        all_records = data.get("records", [])
        total = data.get("overall_balance", 0)
        total_income = sum(r["amount"] for r in all_records if r["amount"] > 0)
        total_expense = sum(r["amount"] for r in all_records if r["amount"] < 0)
        text = (
            f"üìä –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è:\n\n"
            f"üíµ –û–±—â–∏–π –ø—Ä–∏—Ö–æ–¥: {fmt_num(total_income)} ARS\n"
            f"üí∏ –û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥: {fmt_num(abs(total_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(total)} ARS"
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(
                    text,
                    chat_id,
                    active_id,
                    reply_markup=build_main_keyboard(day_key, chat_id)
                )
            except telebot.apihelper.ApiException as e:
                log_error(f"total edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, "–û–±—â–∏–π –∏—Ç–æ–≥ üìä")
        return

    # üìã –û—Ç—á—ë—Ç
    if action == "report":
        day_records = store.get("daily_records", {}).get(day_key, [])
        expenses = [r for r in day_records if r["amount"] < 0]
        daily_expense_total = sum(abs(r["amount"]) for r in expenses)
        if not expenses:
            text = f"üìÖ {day_key}\n–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å.\nüí∏ –†–∞—Å—Ö–æ–¥: 0 ARS"
        else:
            lines = [f"üìÖ {day_key}", "üìã –†–∞—Å—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å:"]
            for r in expenses[-30:]:
                lines.append(f"{r['short_id']}: -{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
            lines.append(f"\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(daily_expense_total)} ARS")
            text = "\n".join(lines)
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(
                    text,
                    chat_id,
                    active_id,
                    reply_markup=build_main_keyboard(day_key, chat_id)
                )
            except telebot.apihelper.ApiException as e:
                log_error(f"report edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, "–û—Ç—á—ë—Ç –æ–±–Ω–æ–≤–ª—ë–Ω üìä")
        return

    # üìÇ CSV (–æ–±—â–∏–π –∏ –¥–Ω–µ–≤–Ω–æ–π)
    if action == "csv_all":
        try:
            export_to_csv(data)
            with open(CSV_FILE, "rb") as f:
                bot.send_document(chat_id, f, caption="üìÇ –ü–æ–ª–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç: data.csv")
            bot.answer_callback_query(call.id, "CSV –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω üìÅ")
        except Exception as e:
            send_temp_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ CSV: {e}")
            bot.answer_callback_query(call.id)
        return

    if action == "csv_day":
        filename = export_day_csv(chat_id, day_key)
        if not filename:
            send_temp_message(chat_id, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å CSV –∑–∞ –¥–µ–Ω—å.")
            bot.answer_callback_query(call.id)
            return
        try:
            with open(filename, "rb") as f:
                bot.send_document(chat_id, f, caption=f"üìÖ CSV –∑–∞ –¥–µ–Ω—å: {filename}")
            bot.answer_callback_query(call.id, f"CSV –∑–∞ –¥–µ–Ω—å {day_key} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")
        except Exception as e:
            send_temp_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ {filename}: {e}")
            bot.answer_callback_query(call.id)
        return

    # –§–æ—Ä–≤–∞—Ä–¥
    if action == "toggle_forward":
        store["forward_enabled"] = not store.get("forward_enabled", False)
        save_data(data)
        status = "–≤–∫–ª—é—á–µ–Ω–∞ ‚úÖ" if store["forward_enabled"] else "–≤—ã–∫–ª—é—á–µ–Ω–∞ ‚ùå"
        update_or_send_day_window(chat_id, day_key)  # –±–µ–∑ new
        bot.answer_callback_query(call.id, f"–ü–µ—Ä–µ—Å—ã–ª–∫–∞ {status}")
        return

    if action == "set_forward_target":
        try:
            bot.answer_callback_query(call.id)
            sent = send_temp_message(chat_id, "–í–≤–µ–¥–∏—Ç–µ ID (–º–æ–∂–Ω–æ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –¥–ª—è —á–∞—Ç–æ–≤) –∏–ª–∏ 0 –¥–ª—è —Å–±—Ä–æ—Å–∞:", delay=25)
            if sent:
                bot.register_next_step_handler(sent, lambda m: process_forward_target(m, day_key))
        except Exception as e:
            log_error(f"set_forward_target: {e}")
            bot.answer_callback_query(call.id, "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—Ä–æ—Å–∏—Ç—å ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è.")
        return

    # –°–±—Ä–æ—Å
    if action == "reset":
        update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, "–î–ª—è –æ–±–Ω—É–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /reset")
        return

    if action in ("back_main", "edit_back", "noop", "info_ok"):
        update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id)
        return
    
     # --- –ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø–∏—Å–µ–π ---
    # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: —Å–ø–∏—Å–∫–∏/–¥–µ—Ç–∞–ª–∏/—É–¥–∞–ª–µ–Ω–∏–µ
    if action == "edit_list":
        day_records = store.get("daily_records", {}).get(day_key, [])
        if not day_records:
            text = f"üìÖ {day_key}\n–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å."
            active_id = get_active_window_id(chat_id, day_key)
            if active_id:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))
            bot.answer_callback_query(call.id, "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
            return

        lines = [f"üìÖ {day_key}", "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"]
        kb = types.InlineKeyboardMarkup(row_width=1)
        for r in reversed(day_records[-20:]):
            sign = "+" if r["amount"] > 0 else "-"
            label = f"{r['short_id']}: {sign}{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}"
            kb.add(types.InlineKeyboardButton(label, callback_data=f"d:{day_key}:rec:{r['id']}"))
        kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:back_main"))
 
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text("\n".join(lines), chat_id, active_id, reply_markup=kb)
            except telebot.apihelper.ApiException as e:
                log_error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —Å–ø–∏—Å–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
        bot.answer_callback_query(call.id)
        return

    # --- –û—Ç–∫—Ä—ã—Ç—å –∑–∞–ø–∏—Å—å ---
    if action == "rec" and len(action_tail) >= 2:
        try:
            rid = int(action_tail[1])
        except:
            bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID")
            return

        day_records = store.get("daily_records", {}).get(day_key, [])
        rec = next((r for r in day_records if r["id"] == rid), None)
        if not rec:
            bot.answer_callback_query(call.id, "–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            return

        sign = "+" if rec["amount"] > 0 else "-"
        text = f"–ó–∞–ø–∏—Å—å {rec['short_id']}\n{sign}{fmt_num(abs(rec['amount']))} ‚Äî {rec.get('note','')}\n–î–æ–±–∞–≤–ª–µ–Ω–∞: {rec.get('timestamp')}"
        kb = build_edit_keyboard_for_record(day_key, rid)
        
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            except telebot.apihelper.ApiException as e:
                log_error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –¥–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏: {e}")
        bot.answer_callback_query(call.id)
        return

    # --- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π edit_manual (–≤ —Ç–æ–º –∂–µ –æ–∫–Ω–µ) ---
    if action == "edit_manual" and len(action_tail) >= 2:
        try:
            rid = int(action_tail[1])
        except:
            bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID")
            return

        # —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è
        store["edit_wait"] = f"change_value:{day_key}"
        store["edit_target"] = rid
        save_data(data)

        # —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏
        text = (
            f"‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ R{rid}\n\n"
            "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—É–º–º—É –∏ –∑–∞–º–µ—Ç–∫—É:\n"
            "+500 –ó–∞—Ä–ø–ª–∞—Ç–∞  –∏–ª–∏  ^+^500^ –ó–∞—Ä–ø–ª–∞—Ç–∞  –∏–ª–∏  ^-^150^ –û–±–µ–¥"
        )
        # –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π ¬´–ù–∞–∑–∞–¥¬ª –¥–ª—è –æ—Ç–º–µ–Ω—ã
        kb = types.InlineKeyboardMarkup(row_width=1)
        kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:edit_list"))

        # –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –æ–∫–Ω–æ
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            except telebot.apihelper.ApiException as e:
                log_error(f"edit_manual edit: {e}")
        else:
            # –µ—Å–ª–∏ –æ–∫–Ω–∞ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ
            update_or_send_day_window(chat_id, day_key, create_if_missing=True)

        bot.answer_callback_query(call.id, "–û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—É–º–º—ã ‚úèÔ∏è")
        return

    if action == "edit_delete" and len(action_tail) >= 2:
        try:
            rid = int(action_tail[1])
        except:
            bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID")
            return

        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(
                    f"‚ùó –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ R{rid}:",
                    chat_id,
                    active_id,
                    reply_markup=build_confirm_delete_keyboard(day_key, rid)
                )
            except telebot.apihelper.ApiException as e:
                log_error(f"edit_delete confirm edit: {e}")
        bot.answer_callback_query(call.id)
        return

    if action == "confirm_delete" and len(action_tail) >= 2:
        try:
            rid = int(action_tail[1])
        except:
            bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID")
            return
        success, _ = delete_record_in_chat(chat_id, rid, user=call.from_user, notify_forward=True)
        text = "‚úÖ –ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞" if success else "‚ö†Ô∏è –ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))

    
        bot.answer_callback_query(call.id, "–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞" if success else "–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return

    if action == "cancel_delete":
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            text = "‚úèÔ∏è –ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
            bot.edit_message_text(text, chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))
    
        bot.answer_callback_query(call.id, "–û—Ç–º–µ–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è")
        return

    bot.answer_callback_query(call.id)
    return–∞

# -----------------------------
# –†—É—á–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã ‚Äî –ø–æ–ª—É—á–∞—Ç–µ–ª—å —Ñ–æ—Ä–≤–∞—Ä–¥–∞
# -----------------------------
def process_forward_target(message, day_key_for_refresh=None):
    try:
        chat_id = message.chat.id
        store = get_chat_store(chat_id)
        text = (message.text or "").strip()

        if text == "0":
            store["forward_target_id"] = None
            save_data(data)
            send_temp_message(chat_id, "‚úÖ –ü–æ–ª—É—á–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Å—ã–ª–∫–∏ —Å–±—Ä–æ—à–µ–Ω (–±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è OWNER_ID, –µ—Å–ª–∏ –æ–Ω –∑–∞–¥–∞–Ω).")
            update_or_send_day_window(chat_id, day_key_for_refresh or today_key())
            return

        if not (text.startswith("-") or text.isdigit()):
            send_temp_message(chat_id, "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID. –ü—Ä–∏–º–µ—Ä: -1001234567890\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ 0 –¥–ª—è —Å–±—Ä–æ—Å–∞.")
            return

        try:
            target = int(text)
        except Exception:
            send_temp_message(chat_id, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å ID. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
            return

        store["forward_target_id"] = target
        save_data(data)
        send_temp_message(chat_id, f"‚úÖ –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –∏–¥—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å ID {target}.")
        update_or_send_day_window(chat_id, day_key_for_refresh or today_key())

    except Exception as e:
        log_error(f"process_forward_target: {e}")
        try:
            send_temp_message(message.chat.id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.")
        except:
            pass

# -----------------------------
# Regex –∏ –ø–∞—Ä—Å–µ—Ä —Å—É–º–º
# -----------------------------
num_re = re.compile(r'(\^[+-]\^[0-9]+|\^[+-]?[0-9]+\^|[+-]?\s*\d+)')
def parse_amount_token(token: str) -> int:
    t = token.strip().replace("^", "").replace(" ", "")
    if t.startswith("+"): return int(t[1:])
    if t.startswith("-"): return -int(t[1:])
    return -int(t)  # –±–µ–∑ –∑–Ω–∞–∫–∞ ‚Äî —Ä–∞—Å—Ö–æ–¥

# -----------------------------
# –ö–æ–º–∞–Ω–¥—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è
# -----------------------------

@bot.message_handler(commands=["start", "info"])
def cmd_start(msg):
    """‚úÖ –ö–æ–º–∞–Ω–¥–∞ /start ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–æ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è"""
    chat_id = msg.chat.id
    update_or_send_day_window(
        chat_id, today_key(),
        create_if_missing=True, force_new=True,
        delete_target_old=True, delete_source_old=False
    )

@bot.message_handler(commands=["help"])
def cmd_help(msg):
    """‚úÖ –ö–æ–º–∞–Ω–¥–∞ /help ‚Äî —Å–ø—Ä–∞–≤–∫–∞"""
    chat_id = msg.chat.id
    send_temp_message(
        chat_id,
        "üìò –î–æ–±–∞–≤–ª—è–π—Ç–µ –∑–∞–ø–∏—Å–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n+500 –ó–∞—Ä–ø–ª–∞—Ç–∞ –∏–ª–∏ -150 –û–±–µ–¥.\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/start /view YYYY-MM-DD /prev /next /balance /report /csv /reset /ping /help",
        delay=15
    )

@bot.message_handler(commands=["ping"])
def cmd_ping(msg):
    """‚úÖ –ö–æ–º–∞–Ω–¥–∞ /ping ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"""
    send_temp_message(msg.chat.id, "PONG ‚Äî –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ")

@bot.message_handler(commands=["view"])
def cmd_view(msg):
    """‚úÖ –ö–æ–º–∞–Ω–¥–∞ /view YYYY-MM-DD ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å"""
    chat_id = msg.chat.id
    parts = (msg.text or "").split()
    if len(parts) < 2:
        send_temp_message(chat_id, "–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É: /view YYYY-MM-DD")
        return
    d = parse_date_key(parts[1])
    if not d:
        send_temp_message(chat_id, "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ü—Ä–∏–º–µ—Ä: /view 2025-11-02")
        return
    day_key = d.strftime("%Y-%m-%d")
    prev_day = get_current_view_day(chat_id)
    update_or_send_day_window(
        chat_id, day_key,
        create_if_missing=True, force_new=True,
        delete_target_old=True, delete_source_old=DELETE_SOURCE_WINDOW_ON_NAV,
        source_day_key=prev_day
    )

@bot.message_handler(commands=["prev"])
def cmd_prev(msg):
    """‚úÖ –ö–æ–º–∞–Ω–¥–∞ /prev ‚Äî –ø–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –¥–Ω—é"""
    chat_id = msg.chat.id
    current = get_current_view_day(chat_id)
    prev_key = shift_date_key(current, -1)
    update_or_send_day_window(
        chat_id, prev_key,
        create_if_missing=True, force_new=True,
        delete_target_old=True, delete_source_old=DELETE_SOURCE_WINDOW_ON_NAV,
        source_day_key=current
    )

@bot.message_handler(commands=["next"])
def cmd_next(msg):
    """‚úÖ –ö–æ–º–∞–Ω–¥–∞ /next ‚Äî –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–Ω—é"""
    chat_id = msg.chat.id
    current = get_current_view_day(chat_id)
    next_key = shift_date_key(current, +1)
    update_or_send_day_window(
        chat_id, next_key,
        create_if_missing=True, force_new=True,
        delete_target_old=True, delete_source_old=DELETE_SOURCE_WINDOW_ON_NAV,
        source_day_key=current
    )

@bot.message_handler(commands=["balance"])
def cmd_balance(msg):
    """‚úÖ –ö–æ–º–∞–Ω–¥–∞ /balance ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –æ—Å—Ç–∞—Ç–æ–∫"""
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    dk = today_key()
    day_records = store.get("daily_records", {}).get(dk, [])
    inc = sum(r["amount"] for r in day_records if r["amount"] > 0)
    exp = sum(r["amount"] for r in day_records if r["amount"] < 0)
    bal = store.get("balance", 0)
    text = (
        f"üìÖ {dk}\n\n"
        f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(bal)} ARS\n"
        f"üíµ –ü—Ä–∏—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(inc)} ARS\n"
        f"üí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(abs(exp))} ARS"
    )
    bot.send_message(chat_id, text)

@bot.message_handler(commands=["report"])
def cmd_report(msg):
    """‚úÖ –ö–æ–º–∞–Ω–¥–∞ /report ‚Äî —Å–ø–∏—Å–æ–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –¥–µ–Ω—å"""
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    dk = today_key()
    day_records = store.get("daily_records", {}).get(dk, [])
    expenses = [r for r in day_records if r["amount"] < 0]
    if not expenses:
        bot.send_message(chat_id, f"üìÖ {dk}\n–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è.\nüí∏ –†–∞—Å—Ö–æ–¥: 0 ARS")
        return
    lines = [f"üìÖ {dk}", "üìã –†–∞—Å—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å:"]
    for r in expenses[-30:]:
        lines.append(f"{r['short_id']}: -{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
    lines.append(f"\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(sum(abs(r['amount']) for r in expenses))} ARS")
    bot.send_message(chat_id, "\n".join(lines))

@bot.message_handler(commands=["csv"])
def cmd_csv(msg):
    """‚úÖ –ö–æ–º–∞–Ω–¥–∞ /csv ‚Äî —ç–∫—Å–ø–æ—Ä—Ç –ø–æ–ª–Ω–æ–≥–æ CSV"""
    chat_id = msg.chat.id
    try:
        export_to_csv(data)
        with open(CSV_FILE, "rb") as f:
            bot.send_document(chat_id, f, caption="üìÇ –ü–æ–ª–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç: data.csv")
    except Exception as e:
        send_temp_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ CSV: {e}")

@bot.message_handler(commands=["reset"])
def cmd_reset(msg):
    """‚úÖ –ö–æ–º–∞–Ω–¥–∞ /reset ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–±–Ω—É–ª–µ–Ω–∏—è –≤ —Ç–æ–º –∂–µ –æ–∫–Ω–µ"""
    chat_id = msg.chat.id
    dk = today_key()
    active_id = get_active_window_id(chat_id, dk)
    if active_id:
        try:
            bot.edit_message_text(
                "‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞?",
                chat_id,
                active_id,
                reply_markup=build_reset_confirm_keyboard(dk)
            )
        except Exception as e:
            log_error(f"/reset edit_message_text: {e}")
    else:
        bot.send_message(
            chat_id,
            "‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞?",
            reply_markup=build_reset_confirm_keyboard(dk)
        )

# -----------------------------
# –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
# -----------------------------
@bot.message_handler(func=lambda m: True)
def handle_message(msg):
    """‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π)"""
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    wait_action = store.get("edit_wait")

    # ‚úÖ 1. –†—É—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
    if wait_action and wait_action.startswith("change_value"):
        day_key = today_key()
        if ":" in wait_action:
            _, day_key = wait_action.split(":", 1)

        rid = store.get("edit_target")
        if not rid:
            store["edit_wait"] = None
            store["edit_target"] = None
            save_data(data)
            return

        parts = (msg.text or "").strip().split(" ", 1)
        try:
            amount_token = parts[0]
            amount = parse_amount_token(amount_token)
            note = parts[1] if len(parts) > 1 else ""
            success, _ = update_record_in_chat(chat_id, rid, amount, note, user=msg.from_user, notify_forward=True)

            # —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
            store["edit_wait"] = None
            store["edit_target"] = None
            save_data(data)

            # –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –æ–∫–Ω–∞
            active_id = get_active_window_id(chat_id, day_key)
            text = render_day_text(store, day_key)
            if active_id:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            else:
                update_or_send_day_window(chat_id, day_key)

            send_temp_message(chat_id, f"‚úÖ –ó–∞–ø–∏—Å—å R{rid} {'–∏–∑–º–µ–Ω–µ–Ω–∞' if success else '–Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}")

        except Exception as e:
            log_error(f"edit manual: {e}")
            send_temp_message(chat_id, "‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞. –ü—Ä–∏–º–µ—Ä: +500 –ó–∞—Ä–ø–ª–∞—Ç–∞ –∏–ª–∏ -150 –û–±–µ–¥", delay=10)
        return

    # ‚úÖ 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
    if not msg.text:
        return

    m = re.search(num_re, msg.text)
    if m:
        try:
            raw = m.group(0)
            raw_clean = raw.replace("^", "").replace(" ", "")
            amount = parse_amount_token(raw_clean)
            note = msg.text.replace(m.group(0), "").strip()

            add_record_to_chat(chat_id, amount, note, msg.from_user.id)

            # –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –æ–∫–Ω–æ
            dk = today_key()
            active_id = get_active_window_id(chat_id, dk)
            if active_id:
                text = render_day_text(store, dk)
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(dk, chat_id))
            else:
                update_or_send_day_window(chat_id, dk)

            send_temp_message(chat_id, "‚úÖ –ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞")

        except Exception as e:
            log_error(f"auto-add record: {e}")
            send_temp_message(chat_id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç.")
        return

    # ‚úÖ 3. –°–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ —Å—É–º–º—ã ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞
    send_temp_message(chat_id, "üìò –ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—É–º–º—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ +500 –ó–∞–º–µ—Ç–∫–∞. /help", delay=10)

# -----------------------------
# Flask webhook
# -----------------------------

@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    """‚úÖ Webhook ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram"""
    try:
        update = telebot.types.Update.de_json(request.get_data().decode("utf-8"))
        bot.process_new_updates([update])
    except Exception as e:
        log_error(f"webhook error: {e}")
    return "OK", 200


@app.route("/", methods=["GET"])
def index():
    """‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    return f"–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ¬´–§–û¬ª ‚Äî –≤–µ—Ä—Å–∏—è {VERSION} —Ä–∞–±–æ—Ç–∞–µ—Ç", 200


# -----------------------------
# Keep-alive
# -----------------------------
def keep_alive_task():
    """‚úÖ –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ keep-alive: –ø–∏–Ω–≥ self –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞"""
    while True:
        try:
            log_info("Keep-alive: –ø–∏–Ω–≥ self –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞.")
            if APP_URL:
                try:
                    resp = requests.get(APP_URL, timeout=10)
                    log_info(f"Keep-alive self-ping {APP_URL} -> {getattr(resp, 'status_code', '?')}")
                except Exception as e:
                    log_error(f"Keep-alive self-ping error: {e}")

            if KEEP_ALIVE_SEND_TO_OWNER and OWNER_ID:
                try:
                    tgt = int(OWNER_ID)
                    send_temp_message(
                        tgt,
                        f"üü¢ Keep-alive: –±–æ—Ç {VERSION} –∞–∫—Ç–∏–≤–µ–Ω.\n"
                        f"{now_local().isoformat(timespec='seconds')}"
                    )
                except Exception as e:
                    log_error(f"Keep-alive notify owner: {e}")

        except Exception as e:
            log_error(f"Keep-alive loop: {e}")

        time.sleep(max(10, KEEP_ALIVE_INTERVAL_SECONDS))


def start_keep_alive_thread():
    """‚úÖ –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞ keep-alive"""
    threading.Thread(target=keep_alive_task, daemon=True).start()


# -----------------------------
# –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫: –æ–∫–Ω–æ –Ω–æ–≤–æ–≥–æ –¥–Ω—è
# -----------------------------
def schedule_daily_window_creation():
    """‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –Ω–æ–≤—ã–π –¥–µ–Ω—å"""
    def task():
        last_day = today_key()
        while True:
            try:
                time.sleep(60)
                current_day = today_key()
                if current_day != last_day:
                    for chat_id_str in list(data.get("chats", {}).keys()):
                        try:
                            chat_id = int(chat_id_str)
                        except:
                            continue
                        try:
                            update_or_send_day_window(
                                chat_id, current_day,
                                create_if_missing=True, force_new=True,
                                delete_target_old=True, delete_source_old=False
                            )
                        except Exception as e:
                            log_error(f"daily new window {chat_id}: {e}")
                    last_day = current_day
            except Exception as e:
                log_error(f"daily loop: {e}")
                time.sleep(5)

    threading.Thread(target=task, daemon=True).start()


# -----------------------------
# Webhook –∏ –∑–∞–ø—É—Å–∫
# -----------------------------
def set_webhook():
    """‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ"""
    url = f"{APP_URL}/{TOKEN}"
    try:
        bot.remove_webhook()
        time.sleep(0.5)
        bot.set_webhook(url=url)
        log_info(f"Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {url}")
    except Exception as e:
        log_error(f"set_webhook: {e}")


if __name__ == "__main__":
    """‚úÖ –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ ‚Äî –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    set_webhook()
    schedule_daily_window_creation()
    start_keep_alive_thread()
    log_info(f"–ë–æ—Ç –§–û –≤–µ—Ä—Å–∏–∏ {VERSION} –∑–∞–ø—É—â–µ–Ω")

    try:
        if OWNER_ID:
            bot.send_message(int(OWNER_ID), f"‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! (–≤–µ—Ä—Å–∏—è {VERSION})")
    except Exception as e:
        log_error(f"send startup msg: {e}")

    app.run(host="0.0.0.0", port=PORT)

# -----------------------------
# –ö–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞ / –û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
# -----------------------------
"""
===============================================================
 –§–ò–ù–ê–ù–°–û–í–´–ô –ë–û–¢ ‚Äî –í–ï–†–°–ò–Ø 9.8.6-fo_6
 ID Code_019b
===============================================================

 üß≠ –ö–†–ê–¢–ö–û:
    ‚Äî –û–¥–Ω–æ–æ–∫–æ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è (–±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
    ‚Äî –ü—Ä–æ—Å–º–æ—Ç—Ä, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–∞—Ç–∞–º
    ‚Äî –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ JSON –∏ —ç–∫—Å–ø–æ—Ä—Ç CSV
    ‚Äî –ê–≤—Ç–æ–ø–∏–Ω–≥ (keep-alive) –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞
    ‚Äî –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–∞—Å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π (—É–¥–∞–ª–µ–Ω–∏–µ, –æ–±–Ω—É–ª–µ–Ω–∏–µ)
    ‚Äî Webhook + Flask (–≥–æ—Ç–æ–≤ –∫ Render, Railway, Replit –∏ —Ç.–ø.)

 üìÅ –°–¢–†–£–ö–¢–£–†–ê:
    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏ IO
    # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    # –†–∞–±–æ—Ç–∞ —Å –∑–∞–ø–∏—Å—è–º–∏
    # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    # Callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    # –ö–æ–º–∞–Ω–¥—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    # –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    # Flask webhook –∏ –∑–∞–ø—É—Å–∫
    # –ö–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞ / –û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

 üîí –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–¨:
    –°–æ–≤–º–µ—Å—Ç–∏–º —Å –≤–µ—Ä—Å–∏—è–º–∏ Code_016‚ÄìCode_019b (–≤–∫–ª—é—á–∞—è –≤—Å–µ FO-–≤–µ—Ç–∫–∏).
    –ú–æ–∂–Ω–æ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å –Ω–∞ Render, Railway, –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ.

 ‚öôÔ∏è –ü–ï–†–ï–ú–ï–ù–ù–´–ï –û–ö–†–£–ñ–ï–ù–ò–Ø:
    BOT_TOKEN ‚Äî —Ç–æ–∫–µ–Ω Telegram-–±–æ—Ç–∞
    OWNER_ID  ‚Äî Telegram ID –≤–ª–∞–¥–µ–ª—å—Ü–∞
    APP_URL   ‚Äî URL –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è webhook
    KEEP_ALIVE_INTERVAL_SECONDS ‚Äî –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø–∏–Ω–≥–∞
    TZ ‚Äî –≤—Ä–µ–º–µ–Ω–Ω–∞—è –∑–æ–Ω–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é America/Argentina/Buenos_Aires)

 üìå –ü–†–ò–ú–ï–ß–ê–ù–ò–Ø:
    ‚Äî –ù–µ –∏–∑–º–µ–Ω—è–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç—Å–µ–∫–∞ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
    ‚Äî –í—Å–µ –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–±–∞–≤–ª—è–π –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –±–ª–æ–∫–∞–º–∏,
      —Å–æ—Ö—Ä–∞–Ω—è—è –≥—Ä–∞–Ω–∏—Ü—ã —Å–µ–∫—Ü–∏–π (# -----------------------------).
    ‚Äî –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç ‚Äú—á–∞—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç—Å–µ–∫–∞‚Äù.
===============================================================
"""