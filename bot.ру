# ============================================
# Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ¾Ñ‚ â€” Ğ²ĞµÑ€ÑĞ¸Ñ 9.6.1.6 (Ğ¾Ğ´Ğ½Ğ¾ Ğ¾ĞºĞ½Ğ¾)
# ============================================

# -----------------------------
# ĞĞ¢Ğ¡Ğ•Ğš 1 â€” Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ñ‹ Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
# -----------------------------
import os, json, csv, logging, re, requests
from datetime import datetime
from zoneinfo import ZoneInfo
import telebot
from flask import Flask, request
from telebot import types

TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")
APP_URL = os.getenv("APP_URL", "https://fo-1.onrender.com")
TZ = ZoneInfo("America/Argentina/Catamarca")
DATA_FILE = "data.json"
CSV_FILE = "data.csv"
LOG_FILE = "log.txt"
PORT = int(os.environ.get("PORT", 5000))
VERSION = "9.6.1.6"

if not TOKEN:
    raise ValueError("BOT_TOKEN Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½!")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# --------------------------------------------
# ĞĞ¢Ğ¡Ğ•Ğš 2 â€” Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
# --------------------------------------------
logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[logging.FileHandler(LOG_FILE, encoding="utf-8"), logging.StreamHandler()]
)
log_info = logging.info
log_error = logging.error
log_info(f"Ğ¡Ñ‚Ğ°Ñ€Ñ‚ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ. Ğ’ĞµÑ€ÑĞ¸Ñ {VERSION}")

# --------------------------------------------
# ĞĞ¢Ğ¡Ğ•Ğš 3 â€” Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ
# --------------------------------------------
def default_data():
    return {
        "chats": {},              # chat_id -> {balance, records[], next_id, active_window_id}
        "forward_targets": [],    # chat_id Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑÑ‹Ğ»ĞºĞ¸
        "tracked_messages": {},   # chat_id -> {user_id: state}
        "processed_messages": []  # Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑÑ‹Ğ»ĞºĞ¸ Ğ±ĞµĞ· Ğ´ÑƒĞ±Ğ»ĞµĞ¹
    }

def load_data():
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, "r", encoding="utf-8") as f:
                d = json.load(f)
        except:
            d = default_data()
    else:
        d = default_data()
    # ensure keys
    for k, v in default_data().items():
        if k not in d:
            d[k] = v
    return d

def save_data(d):
    try:
        with open(DATA_FILE, "w", encoding="utf-8") as f:
            json.dump(d, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ data.json: {e}")

def export_to_csv(d):
    try:
        with open(CSV_FILE, "w", newline='', encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow(["chat_id","id","short_id","timestamp","amount","note","owner"])
            for cid, cdata in d.get("chats", {}).items():
                for r in cdata.get("records", []):
                    writer.writerow([cid, r["id"], r["short_id"], r["timestamp"], r["amount"], r["note"], r["owner"]])
    except Exception as e:
        log_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ° CSV: {e}")

data = load_data()
if OWNER_ID:
    try:
        owner_int = int(OWNER_ID)
        if owner_int not in data["forward_targets"]:
            data["forward_targets"].append(owner_int)
            save_data(data)
    except: pass

# --------------------------------------------
# ĞĞ¢Ğ¡Ğ•Ğš 4 â€” Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸
# --------------------------------------------
num_re = re.compile(r'([+-]?\s*\d+)')

def extract_first_number(s):
    if not s: return None, None
    m = num_re.search(s)
    if not m: return None, None
    token = m.group(1).replace(" ", "")
    try: amt = int(token)
    except: return None, None
    return amt, m.group(1).strip()

def get_chat_store(chat_id):
    chat_id = str(chat_id)
    if chat_id not in data["chats"]:
        data["chats"][chat_id] = {"balance":0,"records":[],"next_id":1,"active_window_id":None}
        save_data(data)
    return data["chats"][chat_id]

def add_record_to_chat(chat_id, amount, note, owner):
    store = get_chat_store(chat_id)
    rid = store.get("next_id", 1)
    ts = datetime.now(TZ).isoformat()
    rec = {"id":rid,"short_id":f"R{rid}","timestamp":ts,"amount":amount,"note":note,"owner":owner}
    store.setdefault("records", []).append(rec)
    store["balance"] = store.get("balance",0) + amount
    store["next_id"] = rid + 1
    save_data(data)
    export_to_csv(data)
    return rec

def delete_record_in_chat(chat_id, rec_id):
    store = get_chat_store(chat_id)
    recs = store.get("records", [])
    for r in recs:
        if r["id"] == rec_id or str(r["id"]) == str(rec_id):
            recs.remove(r)
            store["balance"] = sum([r["amount"] for r in recs])
            save_data(data)
            export_to_csv(data)
            return True, r
    return False, None

def update_record_in_chat(chat_id, rec_id, new_amount, new_note):
    store = get_chat_store(chat_id)
    for r in store.get("records", []):
        if r["id"] == rec_id or str(r["id"]) == str(rec_id):
            r["amount"] = new_amount
            r["note"] = new_note
            store["balance"] = sum([x["amount"] for x in store.get("records",[])])
            save_data(data)
            export_to_csv(data)
            return True, r
    return False, None

def format_amount(v):
    return f"+{v}" if v>0 else f"{v}"

# --------------------------------------------
# ĞĞ¢Ğ¡Ğ•Ğš 5 â€” ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñ‹
# --------------------------------------------
def build_main_keyboard():
    kb = types.InlineKeyboardMarkup()
    kb.row(types.InlineKeyboardButton("ğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ", callback_data="btn_balance"),
           types.InlineKeyboardButton("ğŸ“Š ĞÑ‚Ñ‡Ñ‘Ñ‚", callback_data="btn_report"))
    kb.row(types.InlineKeyboardButton("âœï¸ Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ", callback_data="btn_edit"),
           types.InlineKeyboardButton("âš™ï¸ Ğ¡Ğ±Ñ€Ğ¾Ñ", callback_data="btn_reset"))
    kb.row(types.InlineKeyboardButton("ğŸš€ Ğ¡Ñ‚Ğ°Ñ€Ñ‚", callback_data="btn_start"),
           types.InlineKeyboardButton("ğŸ“˜ Ğ ĞºĞ¾Ğ´Ğµ", callback_data="btn_cod"))
    return kb

def update_main_window(chat_id, extra_text=None):
    store = get_chat_store(chat_id)
    lines = []
    lines.append(f"ğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: {format_amount(store.get('balance',0))} â‚½")
    recs = store.get("records", [])[-20:]
    if recs:
        lines.append("\nğŸ“‹ ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸:")
        for r in recs:
            lines.append(f"{r['short_id']}: {format_amount(r['amount'])} â€” {r.get('note','')}")
    if extra_text:
        lines.append("\n"+extra_text)
    text = "\n".join(lines)
    kb = build_main_keyboard()
    mid = store.get("active_window_id")
    try:
        if mid:
            bot.edit_message_text(text, chat_id, mid, reply_markup=kb)
        else:
            m = bot.send_message(chat_id, text, reply_markup=kb)
            store["active_window_id"] = m.message_id
            save_data(data)
    except:
        m = bot.send_message(chat_id, text, reply_markup=kb)
        store["active_window_id"] = m.message_id
        save_data(data)

# --------------------------------------------
# ĞĞ¢Ğ¡Ğ•Ğš 6 â€” ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ (edit, delete, report, balance)
# --------------------------------------------
@bot.message_handler(commands=["start"])
def cmd_start(msg):
    update_main_window(msg.chat.id, "ğŸ‘‹ Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ¾Ñ‚!")

@bot.message_handler(commands=["balance"])
def cmd_balance(msg):
    update_main_window(msg.chat.id)

@bot.message_handler(commands=["report"])
def cmd_report(msg):
    update_main_window(msg.chat.id)

@bot.message_handler(commands=["delete"])
def cmd_delete(msg):
    parts = msg.text.split()
    if len(parts)<2: return
    rid = int(parts[1].lstrip("R"))
    ok, rec = delete_record_in_chat(msg.chat.id, rid)
    if ok:
        update_main_window(msg.chat.id, f"âœ… Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ R{rid} ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°.")
    else:
        update_main_window(msg.chat.id, f"âŒ Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ R{rid} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°.")

# --------------------------------------------
# ĞĞ¢Ğ¡Ğ•Ğš 7 â€” Callback ĞºĞ½Ğ¾Ğ¿ĞºĞ¸
# --------------------------------------------
@bot.callback_query_handler(func=lambda c: True)
def handle_callback(call):
    chat_id = call.message.chat.id
    data_cd = call.data
    if data_cd=="btn_balance": update_main_window(chat_id)
    elif data_cd=="btn_report": update_main_window(chat_id)
    elif data_cd=="btn_reset":
        if str(call.from_user.id)!=str(OWNER_ID): return
        data["chats"][str(chat_id)] = {"balance":0,"records":[],"next_id":1,"active_window_id=None"}
        save_data(data)
        update_main_window(chat_id, "âœ… Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ±Ñ€Ğ¾ÑˆĞµĞ½Ñ‹ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†ĞµĞ¼")
    elif data_cd=="btn_start": cmd_start(call.message)
    elif data_cd=="btn_cod":
        update_main_window(chat_id, f"ğŸ“˜ Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ¾Ñ‚ v{VERSION}")
    elif data_cd=="btn_edit":
        update_main_window(chat_id, "âœï¸ Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ â€” Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ '+100 Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ°' Ğ¸Ğ»Ğ¸ '-50 Ñ…Ğ»ĞµĞ±'.")

# --------------------------------------------
# ĞĞ¢Ğ¡Ğ•Ğš 8 â€” ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
# --------------------------------------------
@bot.message_handler(func=lambda m: True, content_types=["text"])
def handle_message(msg):
    if not getattr(msg,"from_user",None): return
    if msg.from_user.is_bot: return
    lines = msg.text.splitlines()
    any_added = False
    for line in lines:
        line = line.strip()
        if not line: continue
        amt, token = extract_first_number(line)
        if amt is None: continue
        note = line[num_re.search(line).end():].strip() if num_re.search(line) else ""
        raw_token = token
        if raw_token.startswith("+"): final_amt = amt
        elif raw_token.startswith("-"): final_amt = amt
        else: final_amt = -abs(amt)
        add_record_to_chat(msg.chat.id, final_amt, note, msg.from_user.id)
        any_added = True
    if any_added:
        update_main_window(msg.chat.id, "âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸.")

# --------------------------------------------
# ĞĞ¢Ğ¡Ğ•Ğš 9 â€” Flask webhook
# --------------------------------------------
@app.route("/", methods=["GET"])
def index(): return f"Ğ‘Ğ¾Ñ‚ Ğ²ĞµÑ€ÑĞ¸Ñ {VERSION} Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½."

@app.route("/webhook", methods=["POST"])
def webhook():
    try:
        update = telebot.types.Update.de_json(request.stream.read().decode("utf-8"))
        bot.process_new_updates([update])
    except Exception as e:
        log_error(f"Webhook error: {e}")
    return "ok", 200

def ensure_webhook():
    try:
        url = f"{APP_URL.rstrip('/')}/webhook"
        info = requests.get(f"https://api.telegram.org/bot{TOKEN}/getWebhookInfo", timeout=10).json()
        if info.get("result",{}).get("url","") != url:
            r = requests.get(f"https://api.telegram.org/bot{TOKEN}/setWebhook", params={"url":url}, timeout=10)
            if r.json().get("ok"): log_info(f"Webhook ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½: {url}")
    except Exception as e:
        log_error(f"Webhook setup error: {e}")

# --------------------------------------------
# ĞĞ¢Ğ¡Ğ•Ğš 10 â€” Ğ—Ğ°Ğ¿ÑƒÑĞº
# --------------------------------------------
if __name__=="__main__":
    ensure_webhook()
    if OWNER_ID:
        try: bot.send_message(int(OWNER_ID), f"ğŸ’¬ Ğ‘Ğ¾Ñ‚ v{VERSION} Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ âœ…")
        except: pass
    app.run(host="0.0.0.0", port=PORT)