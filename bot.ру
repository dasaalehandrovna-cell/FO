# ============================================
# üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è 9.8.7-fo_6+autoCSV+jsonsyncHybrid+syncAll
# ID Code_021A
# ============================================
# üß≠ –§—É–Ω–∫—Ü–∏–∏:
#  ‚Ä¢ –ü–æ–ª–Ω–∞—è –ª–æ–≥–∏–∫–∞ 9.8.6-fo_6+autoCSV
#  ‚Ä¢ csv_meta.json + Telegram file_id —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
#  ‚Ä¢ sync_all_backups(): –æ–±–Ω–æ–≤–ª—è–µ—Ç CSV, META –∏ file_id –≤ —Ç–µ—Ö –∂–µ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
#  ‚Ä¢ –ê–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ Telegram, –µ—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –ø–æ—Ç–µ—Ä—è–Ω—ã
# ============================================

import os, io, re, csv, json, time, threading, logging, requests
from datetime import datetime, timedelta, timezone
from zoneinfo import ZoneInfo
import telebot
from telebot import types
from flask import Flask, request

# --------------------------------------------
# ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
# --------------------------------------------
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")
APP_URL = os.getenv("APP_URL", "https://yourapp.onrender.com")
CSV_META_FILE_ID = os.getenv("CSV_META_FILE_ID", "").strip()
try:
    TZ = ZoneInfo((os.getenv("TZ") or "America/Argentina/Buenos_Aires").strip())
except Exception:
    TZ = timezone(timedelta(hours=-3))

PORT = int(os.environ.get("PORT", 5000))
KEEP_ALIVE_INTERVAL_SECONDS = int(os.getenv("KEEP_ALIVE_INTERVAL_SECONDS", 11 * 60))
KEEP_ALIVE_SEND_TO_OWNER = True

DELETE_SOURCE_WINDOW_ON_NAV = False
DELETE_TARGET_OLD_WINDOW_ON_NAV = True
ALWAYS_CREATE_NEW_ON_NAV = True

VERSION = "9.8.7-fo_6+autoCSV+jsonsyncHybrid+syncAll"
DATA_FILE = "data.json"
CSV_FILE = "data.csv"
CSV_META_FILE = "csv_meta.json"

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[logging.FileHandler("log.txt", encoding="utf-8"), logging.StreamHandler()]
)
def log_info(msg): logging.info(msg)
def log_error(msg): logging.error(msg)
log_info(f"üöÄ –ó–∞–ø—É—Å–∫ –≤–µ—Ä—Å–∏–∏ {VERSION}")

# --------------------------------------------
# üïí –í—Ä–µ–º—è –∏ —Ñ–æ—Ä–º–∞—Ç
# --------------------------------------------
def now_local() -> datetime: return datetime.now(TZ)
def today_key() -> str: return now_local().strftime("%Y-%m-%d")
def parse_date_key(s: str):
    try: return datetime.strptime(s, "%Y-%m-%d").date()
    except: return None
def shift_date_key(day_key: str, days: int) -> str:
    d = parse_date_key(day_key) or now_local().date()
    return (d + timedelta(days=days)).strftime("%Y-%m-%d")
def fmt_num(v):
    try: return f"{v:,.0f}".replace(",", ".")
    except: return str(v)

# --------------------------------------------
# üìÅ JSON/CSV META ‚Äî –±–∞–∑–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã
# --------------------------------------------
def safe_json_load(path, fallback):
    try:
        if os.path.exists(path):
            with open(path, "r", encoding="utf-8") as f:
                return json.load(f)
    except Exception as e:
        log_error(f"safe_json_load: {e}")
    return fallback

def safe_json_write(path, payload):
    try:
        with open(path, "w", encoding="utf-8") as f:
            json.dump(payload, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"safe_json_write: {e}")

def _load_csv_meta():
    return safe_json_load(CSV_META_FILE, {})

def _save_csv_meta(meta):
    safe_json_write(CSV_META_FILE, meta)

# --------------------------------------------
# üß© ensure_local_meta_or_fetch
# --------------------------------------------
def ensure_local_meta_or_fetch():
    """–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –Ω–∞–ª–∏—á–∏–µ csv_meta.json; –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø—ã—Ç–∞–µ—Ç—Å—è —Å–∫–∞—á–∞—Ç—å –ø–æ CSV_META_FILE_ID"""
    if os.path.exists(CSV_META_FILE):
        return
    if CSV_META_FILE_ID:
        try:
            log_info("üîé csv_meta.json –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî —Å–∫–∞—á–∏–≤–∞—é –ø–æ CSV_META_FILE_ID...")
            fobj = bot.get_file(CSV_META_FILE_ID)
            url = f"https://api.telegram.org/file/bot{TOKEN}/{fobj.file_path}"
            resp = requests.get(url, timeout=30)
            with open(CSV_META_FILE, "wb") as f:
                f.write(resp.content)
            log_info("‚úÖ csv_meta.json —Å–∫–∞—á–∞–Ω –∏–∑ Telegram.")
            return
        except Exception as e:
            log_error(f"ensure_local_meta_or_fetch: {e}")
    safe_json_write(CSV_META_FILE, {"file_id_csv": None, "meta_file_id": None, "updated": datetime.now().isoformat()})
    log_info("üìÑ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π csv_meta.json")

# --------------------------------------------
# üíæ –°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
# --------------------------------------------
def default_data():
    return {"overall_balance": 0, "records": [], "chats": {}, "active_messages": {}, "next_id": 1}

def _load_json(path, fallback):
    try:
        if os.path.exists(path):
            with open(path, "r", encoding="utf-8") as f:
                return json.load(f)
    except Exception as e:
        log_error(f"_load_json: {path}: {e}")
    return fallback

def _save_json(path, payload):
    try:
        with open(path, "w", encoding="utf-8") as f:
            json.dump(payload, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"_save_json: {path}: {e}")

def load_data():
    d = _load_json(DATA_FILE, default_data())
    base = default_data()
    for k, v in base.items():
        if k not in d:
            d[k] = v
    return d

data = load_data()

# --------------------------------------------
# üì§ CSV —ç–∫—Å–ø–æ—Ä—Ç
# --------------------------------------------
def export_to_csv(d):
    try:
        with open(CSV_FILE, "w", newline="", encoding="utf-8") as f:
            w = csv.writer(f)
            w.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
            for cid, cdata in d.get("chats", {}).items():
                for dk, recs in cdata.get("daily_records", {}).items():
                    for r in recs:
                        w.writerow([cid, r["id"], r["short_id"], r["timestamp"], r["amount"], r["note"], r["owner"], dk])
    except Exception as e:
        log_error(f"export_to_csv: {e}")

# --------------------------------------------
# üîÅ –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è ‚Äî –ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç—Ä—ë—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
# --------------------------------------------
def sync_all_backups(force=False):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç CSV, META –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å file_id –≤ —Ç–µ—Ö –∂–µ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö"""
    try:
        if not OWNER_ID:
            return
        owner_id = int(OWNER_ID)
        meta = _load_csv_meta()

        # 1Ô∏è‚É£ –≠–∫—Å–ø–æ—Ä—Ç –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ CSV
        export_to_csv(data)
        csv_msg_id = meta.get("message_id_csv")
        with open(CSV_FILE, "rb") as f:
            try:
                bot.edit_message_media(
                    chat_id=owner_id,
                    message_id=csv_msg_id,
                    media=telebot.types.InputMediaDocument(f, caption="üìä –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π CSV-–±—ç–∫–∞–ø –¥–∞–Ω–Ω—ã—Ö"),
                )
                log_info("‚ôªÔ∏è CSV –æ–±–Ω–æ–≤–ª—ë–Ω –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏.")
            except Exception as e:
                log_error(f"sync_all_backups CSV edit: {e}")

        # 2Ô∏è‚É£ META ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ json –∏ Telegram —Å–æ–æ–±—â–µ–Ω–∏—è
        meta["updated"] = datetime.now().isoformat()
        if os.path.exists(CSV_FILE):
            meta["csv_size"] = os.path.getsize(CSV_FILE)
        _save_csv_meta(meta)
        meta_msg_id = meta.get("message_id_meta")
        with open(CSV_META_FILE, "rb") as f:
            try:
                bot.edit_message_media(
                    chat_id=owner_id,
                    message_id=meta_msg_id,
                    media=telebot.types.InputMediaDocument(f, caption="üìÑ –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π csv_meta.json"),
                )
                log_info("‚ôªÔ∏è META –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ —Ç–æ–º –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–∏.")
            except Exception as e:
                log_error(f"sync_all_backups META edit: {e}")

        # 3Ô∏è‚É£ file_id —Å–æ–æ–±—â–µ–Ω–∏–µ
        fileid_msg_id = meta.get("message_id_fileid")
        fileid_text = (
            f"ü™Ñ file_id –¥–ª—è CSV_META_FILE_ID:\n`{meta.get('meta_file_id', '‚Äî')}`\n"
            f"‚è± {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
        )
        try:
            bot.edit_message_text(fileid_text, owner_id, fileid_msg_id, parse_mode="Markdown")
            log_info("‚ôªÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ —Å file_id –æ–±–Ω–æ–≤–ª–µ–Ω–æ.")
        except Exception as e:
            log_error(f"sync_all_backups file_id edit: {e}")

        _save_csv_meta(meta)
    except Exception as e:
        log_error(f"sync_all_backups: {e}")
# --------------------------------------------
# üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ CSV (–ª–æ–∫–∞–ª—å–Ω–æ–≥–æ/TG)
# --------------------------------------------
def _build_data_from_csv(path: str):
    try:
        restored = default_data()
        with open(path, "r", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            for row in reader:
                chat_id = str(row["chat_id"])
                rec = {
                    "id": int(row["ID"]),
                    "short_id": row["short_id"],
                    "timestamp": row["timestamp"],
                    "amount": int(row["amount"]),
                    "note": row["note"],
                    "owner": row["owner"]
                }
                restored["records"].append(rec)
                restored["chats"].setdefault(chat_id, {
                    "records": [],
                    "daily_records": {},
                    "balance": 0,
                    "forward_enabled": False,
                    "forward_target_id": None,
                    "current_view_day": today_key()
                })
                restored["chats"][chat_id]["records"].append(rec)
                day = row["day_key"]
                restored["chats"][chat_id]["daily_records"].setdefault(day, []).append(rec)
                restored["chats"][chat_id]["balance"] += rec["amount"]
                restored["overall_balance"] += rec["amount"]
                restored["next_id"] = max(restored["next_id"], rec["id"] + 1)
        return restored
    except Exception as e:
        log_error(f"_build_data_from_csv: {e}")
        return None

def restore_from_telegram_backup_if_possible(current_data):
    """–ï—Å–ª–∏ –µ—Å—Ç—å file_id_csv ‚Äî –ø—ã—Ç–∞–µ—Ç—Å—è —Å–∫–∞—á–∞—Ç—å CSV –∏–∑ Telegram"""
    try:
        meta = _load_csv_meta()
        fid = meta.get("file_id_csv")
        if not fid:
            log_info("‚ÑπÔ∏è –ù–µ—Ç file_id_csv ‚Äî –ø—Ä–æ–ø—É—Å–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.")
            return current_data
        fobj = bot.get_file(fid)
        url = f"https://api.telegram.org/file/bot{TOKEN}/{fobj.file_path}"
        resp = requests.get(url, timeout=30)
        resp.raise_for_status()
        with open(CSV_FILE, "wb") as f:
            f.write(resp.content)
        restored = _build_data_from_csv(CSV_FILE)
        if restored:
            _save_json(DATA_FILE, restored)
            log_info("‚úÖ –î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ Telegram-–±—ç–∫–∞–ø–∞.")
            return restored
    except Exception as e:
        log_error(f"restore_from_telegram_backup_if_possible: {e}")
    return current_data

def restore_from_csv_if_needed():
    """1) –ª–æ–∫–∞–ª—å–Ω—ã–π CSV ‚Üí –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å; 2) –∏–Ω–∞—á–µ ‚Äî –ø–æ –º–µ—Ç–∞ –∏–∑ TG; 3) –∏–Ω–∞—á–µ ‚Äî –ø—É—Å—Ç–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞."""
    try:
        if os.path.exists(CSV_FILE):
            log_info("üìÇ –ù–∞–π–¥–µ–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π data.csv ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é...")
            restored = _build_data_from_csv(CSV_FILE)
            if restored:
                _save_json(DATA_FILE, restored)
                log_info("‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ CSV –∑–∞–≤–µ—Ä—à–µ–Ω–æ.")
                return restored
        ensure_local_meta_or_fetch()
        restored_after_tg = restore_from_telegram_backup_if_possible(data)
        if restored_after_tg is not data:
            return restored_after_tg
        log_info("‚ö†Ô∏è CSV –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî —Å—Ç–∞—Ä—Ç—É—é —Å –ø—É—Å—Ç–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π.")
    except Exception as e:
        log_error(f"restore_from_csv_if_needed: {e}")
    return None

# --------------------------------------------
# üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∞–≤—Ç–æ-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
# --------------------------------------------
def save_data(d, force_backup: bool = False):
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç JSON, –æ–±–Ω–æ–≤–ª—è–µ—Ç CSV –∏ csv_meta.json,
    –∞ —Ç–∞–∫–∂–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Ç—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏—è (CSV/META/file_id).
    """
    try:
        _save_json(DATA_FILE, d)
        export_to_csv(d)
        meta = _load_csv_meta()
        meta["updated"] = datetime.now().isoformat()
        if os.path.exists(CSV_FILE):
            meta["csv_size"] = os.path.getsize(CSV_FILE)
        _save_csv_meta(meta)
        log_info("üíæ –î–∞–Ω–Ω—ã–µ –∏ csv_meta.json —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ.")
        # –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ö–∞–Ω–∏–∑–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        if force_backup:
            log_info("‚ö° –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.")
            sync_all_backups(force=True)
        else:
            threading.Timer(3, sync_all_backups).start()
    except Exception as e:
        log_error(f"save_data: {e}")

# --------------------------------------------
# üóÉ –†–∞–±–æ—Ç–∞ —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –æ–∫–æ–Ω
# --------------------------------------------
def get_chat_store(chat_id: int) -> dict:
    cid = str(chat_id)
    if cid not in data["chats"]:
        data["chats"][cid] = {
            "balance": 0,
            "records": [],
            "next_id": 1,
            "daily_records": {},
            "active_windows": {},
            "edit_wait": None,
            "edit_target": None,
            "forward_enabled": False,
            "forward_target_id": None,
            "current_view_day": today_key()
        }
        save_data(data)
    store = data["chats"][cid]
    store.setdefault("forward_enabled", False)
    store.setdefault("forward_target_id", None)
    store.setdefault("current_view_day", today_key())
    save_data(data)
    return store

def get_active_window_id(chat_id: int, day_key: str):
    return data.setdefault("active_messages", {}).setdefault(day_key, {}).get(str(chat_id))

def set_active_window(chat_id: int, day_key: str, message_id: int):
    data.setdefault("active_messages", {}).setdefault(day_key, {})[str(chat_id)] = message_id
    save_data(data)

def clear_active_window(chat_id: int, day_key: str):
    am = data.setdefault("active_messages", {}).setdefault(day_key, {})
    if str(chat_id) in am:
        am.pop(str(chat_id), None)
        save_data(data)

def delete_message_safe(chat_id: int, message_id: int):
    try:
        bot.delete_message(chat_id, message_id)
    except Exception:
        pass

def delete_active_window_if_exists(chat_id: int, day_key: str):
    old_id = get_active_window_id(chat_id, day_key)
    if old_id:
        delete_message_safe(chat_id, old_id)
        clear_active_window(chat_id, day_key)

def send_temp_message(chat_id: int, text: str, delay: int = 5, **kwargs):
    try:
        msg = bot.send_message(chat_id, text, **kwargs)
        if delay and delay > 0:
            threading.Timer(delay, lambda: delete_message_safe(chat_id, msg.message_id)).start()
        return msg
    except Exception as e:
        log_error(f"send_temp_message: {e}")
        return None

def set_current_view_day(chat_id: int, day_key: str):
    store = get_chat_store(chat_id)
    store["current_view_day"] = day_key
    save_data(data)

def get_current_view_day(chat_id: int) -> str:
    store = get_chat_store(chat_id)
    return store.get("current_view_day", today_key())
# --------------------------------------------
# ‚å®Ô∏è –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
# --------------------------------------------
def build_main_keyboard(day_key: str, chat_id: int | None = None):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å", callback_data=f"d:{day_key}:balance"),
        types.InlineKeyboardButton("üìä –û—Ç—á—ë—Ç", callback_data=f"d:{day_key}:report"),
    )
    kb.row(
        types.InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data=f"d:{day_key}:refresh"),
        types.InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"d:{day_key}:edit_menu"),
    )
    total = fmt_num(data.get("overall_balance", 0))
    kb.add(types.InlineKeyboardButton(f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {total} ARS", callback_data=f"d:{day_key}:total"))
    return kb

def build_edit_menu_keyboard(day_key: str, chat_id=None):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å", callback_data=f"d:{day_key}:edit_list"),
        types.InlineKeyboardButton("üìÇ –û–±—â–∏–π CSV", callback_data=f"d:{day_key}:csv_all")
    )
    kb.row(
        types.InlineKeyboardButton("üìÖ CSV –∑–∞ –¥–µ–Ω—å", callback_data=f"d:{day_key}:csv_day"),
        types.InlineKeyboardButton("üì® –§–æ—Ä–≤–∞—Ä–¥", callback_data=f"d:{day_key}:toggle_forward")
    )
    kb.row(
        types.InlineKeyboardButton("üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å", callback_data=f"d:{day_key}:set_forward_target"),
        types.InlineKeyboardButton("‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å", callback_data=f"d:{day_key}:reset")
    )
    kb.row(
        types.InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data=f"d:{today_key()}:open"),
        types.InlineKeyboardButton("üìÜ –í—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å", callback_data=f"d:{day_key}:pick_date")
    )
    kb.row(
        types.InlineKeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ", callback_data=f"d:{day_key}:info"),
        types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:back_main")
    )
    return kb

def build_edit_keyboard_for_record(day_key: str, rid: int):
    kb = types.InlineKeyboardMarkup(row_width=1)
    kb.add(types.InlineKeyboardButton("‚úè –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é", callback_data=f"d:{day_key}:edit_manual:{rid}"))
    kb.add(types.InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å", callback_data=f"d:{day_key}:edit_delete:{rid}"))
    kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:edit_back"))
    return kb

def build_reset_confirm_keyboard(day_key: str):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("‚úÖ –î–∞, –æ–±–Ω—É–ª–∏—Ç—å", callback_data=f"d:{day_key}:confirm_reset_all"),
        types.InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data=f"d:{day_key}:cancel_reset_all")
    )
    return kb

# --------------------------------------------
# üñº –†–µ–Ω–¥–µ—Ä –æ–∫–Ω–∞ –¥–Ω—è
# --------------------------------------------
def render_day_text(store: dict, day_key: str) -> str:
    day_records = store.get("daily_records", {}).get(day_key, [])
    daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
    daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
    overall_balance = store.get("balance", 0)

    if not day_records:
        text = (
            f"üìÖ {day_key}\n"
            f"–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å.\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥: {fmt_num(daily_income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {fmt_num(abs(daily_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall_balance)} ARS"
        )
    else:
        lines = [f"üìÖ {day_key}", "üìã –û–ø–µ—Ä–∞—Ü–∏–∏:"]
        for r in day_records[-50:]:
            sign = "+" if r["amount"] > 0 else "-"
            lines.append(f"{r['short_id']}: {sign}{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
        lines.append(
            f"\nüíµ –ü—Ä–∏—Ö–æ–¥: {fmt_num(daily_income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {fmt_num(abs(daily_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall_balance)} ARS"
        )
        text = "\n".join(lines)

    if store.get("forward_enabled"):
        tgt = store.get("forward_target_id") or OWNER_ID
        text += f"\n\nüì® –ü–µ—Ä–µ—Å—ã–ª–∫–∞: –í–∫–ª—é—á–µ–Ω–∞ ‚Üí {tgt}"
    else:
        text += f"\n\nüì® –ü–µ—Ä–µ—Å—ã–ª–∫–∞: –í—ã–∫–ª—é—á–µ–Ω–∞"
    return text

# --------------------------------------------
# ‚ûï / ‚úèÔ∏è / üóë –û–ø–µ—Ä–∞—Ü–∏–∏
# --------------------------------------------
def add_record_to_chat(chat_id: int, amount: int, note: str, owner):
    store = get_chat_store(chat_id)
    rid = data.get("next_id", 1)
    rec = {
        "id": rid,
        "short_id": f"R{rid}",
        "timestamp": now_local().isoformat(timespec="seconds"),
        "amount": amount,
        "note": note,
        "owner": owner
    }
    data.setdefault("records", []).append(rec)
    store.setdefault("records", []).append(rec)
    day = today_key()
    store.setdefault("daily_records", {}).setdefault(day, []).append(rec)
    store["balance"] += amount
    data["overall_balance"] += amount
    data["next_id"] = rid + 1
    save_data(data, force_backup=True)
    return rec

def update_record_in_chat(chat_id: int, rid: int, new_amount: int, new_note: str, user=None):
    store = get_chat_store(chat_id)
    found = None
    for r in store.get("records", []):
        if r["id"] == rid:
            r["amount"], r["note"] = new_amount, new_note
            found = r
            break
    if found:
        for day_recs in store.get("daily_records", {}).values():
            for r in day_recs:
                if r["id"] == rid: r.update(found)
        store["balance"] = sum(x["amount"] for x in store["records"])
        data["records"] = [x if x["id"] != rid else found for x in data["records"]]
        data["overall_balance"] = sum(x["amount"] for x in data["records"])
        save_data(data, force_backup=True)
        return True, found
    return False, None

def delete_record_in_chat(chat_id: int, rid: int, user=None):
    store = get_chat_store(chat_id)
    removed = None
    for r in list(store["records"]):
        if r["id"] == rid:
            removed = r
            store["records"].remove(r)
            break
    if removed:
        for dk, recs in store["daily_records"].items():
            store["daily_records"][dk] = [x for x in recs if x["id"] != rid]
        store["balance"] = sum(x["amount"] for x in store["records"])
        data["records"] = [x for x in data["records"] if x["id"] != rid]
        data["overall_balance"] = sum(x["amount"] for x in data["records"])
        save_data(data, force_backup=True)
        return True, removed
    return False, None

# --------------------------------------------
# üß∞ –ö–æ–º–∞–Ω–¥—ã
# --------------------------------------------
@bot.message_handler(commands=["start"])
def cmd_start(msg):
    chat_id = msg.chat.id
    update_or_send_day_window(chat_id, today_key(), create_if_missing=True, force_new=True)
    if str(chat_id) == str(OWNER_ID):
        try:
            sync_all_backups(force=True)
            bot.send_message(chat_id, "üì¶ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚Äî —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.")
        except Exception as e:
            log_error(f"/start: {e}")

@bot.message_handler(commands=["help"])
def cmd_help(msg):
    send_temp_message(
        msg.chat.id,
        "üìò –î–æ–±–∞–≤–ª—è–π—Ç–µ –∑–∞–ø–∏—Å–∏: +500 –ó–∞—Ä–ø–ª–∞—Ç–∞ / -150 –û–±–µ–¥.\n"
        "–ö–æ–º–∞–Ω–¥—ã: /start /view YYYY-MM-DD /prev /next /balance /report /csv /reset /ping /help",
        delay=15
    )

@bot.message_handler(commands=["ping"])
def cmd_ping(msg):
    send_temp_message(msg.chat.id, "PONG ‚Äî –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ")

@bot.message_handler(commands=["csv"])
def cmd_csv(msg):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ —Ç—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏—è (CSV + META + file_id)"""
    chat_id = msg.chat.id
    if str(chat_id) != str(OWNER_ID):
        send_temp_message(chat_id, "‚ö†Ô∏è –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É.")
        return
    try:
        sync_all_backups(force=True)
        send_temp_message(chat_id, "üìÇ –í—Å–µ —Ñ–∞–π–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤ —ç—Ç–∏—Ö –∂–µ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö.")
    except Exception as e:
        log_error(f"/csv: {e}")
        send_temp_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞: {e}")

@bot.message_handler(commands=["sync"])
def cmd_sync(msg):
    chat_id = msg.chat.id
    if str(chat_id) != str(OWNER_ID):
        send_temp_message(chat_id, "‚ö†Ô∏è –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞.")
        return
    try:
        sync_all_backups(force=True)
        send_temp_message(chat_id, "üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è CSV/META/file_id –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.")
    except Exception as e:
        log_error(f"/sync: {e}")
        send_temp_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: {e}")

@bot.message_handler(commands=["file_id"])
def cmd_file_id(msg):
    meta = _load_csv_meta()
    fid = meta.get("meta_file_id")
    bot.send_message(msg.chat.id, fid or "file_id –Ω–µ –Ω–∞–π–¥–µ–Ω")

@bot.message_handler(commands=["reset"])
def cmd_reset(msg):
    chat_id = msg.chat.id
    dk = today_key()
    active_id = get_active_window_id(chat_id, dk)
    kb = build_reset_confirm_keyboard(dk)
    text = "‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞?"
    if active_id:
        try:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
        except Exception:
            bot.send_message(chat_id, text, reply_markup=kb)
    else:
        bot.send_message(chat_id, text, reply_markup=kb)
# --------------------------------------------
# üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 31 –¥–Ω—è
# --------------------------------------------
def build_last_31days_calendar():
    today = now_local().date()
    days = [today - timedelta(days=i) for i in range(0, 31)]
    kb = types.InlineKeyboardMarkup()
    row = []
    for idx, d in enumerate(days, start=1):
        label = d.strftime("%d/%m")
        dk = d.strftime("%Y-%m-%d")
        row.append(types.InlineKeyboardButton(text=label, callback_data=f"d:{dk}:calopen"))
        if idx % 7 == 0:
            kb.row(*row); row = []
    if row: kb.row(*row)
    return kb

# --------------------------------------------
# üîÅ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞ –¥–Ω—è
# --------------------------------------------
def update_or_send_day_window(
    chat_id: int,
    day_key: str = None,
    create_if_missing: bool = True,
    force_new: bool = False,
    delete_target_old: bool = False,
    delete_source_old: bool = False,
    source_day_key: str | None = None
):
    day_key = day_key or today_key()
    store = get_chat_store(chat_id)

    if delete_target_old:
        delete_active_window_if_exists(chat_id, day_key)
    if delete_source_old and source_day_key and source_day_key != day_key:
        delete_active_window_if_exists(chat_id, source_day_key)

    set_current_view_day(chat_id, day_key)

    text = render_day_text(store, day_key)
    kb = build_main_keyboard(day_key, chat_id)
    active_id = get_active_window_id(chat_id, day_key)

    if not force_new and active_id:
        try:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            return
        except telebot.apihelper.ApiException as e:
            log_error(f"edit_message_text: {e}")

    if not create_if_missing and not force_new:
        return

    try:
        sent = bot.send_message(chat_id, text, reply_markup=kb)
        set_active_window(chat_id, day_key, sent.message_id)
    except Exception as e:
        log_error(f"send new window: {e}")

# --------------------------------------------
# üì• –¢–µ–∫—Å—Ç—ã: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
# --------------------------------------------
@bot.message_handler(func=lambda m: True)
def handle_message(msg):
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    wait_action = store.get("edit_wait")

    # 1) –†—É—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
    if wait_action and wait_action.startswith("change_value"):
        day_key = today_key()
        if ":" in wait_action:
            _, day_key = wait_action.split(":", 1)
        rid = store.get("edit_target")
        if not rid:
            store["edit_wait"] = None
            store["edit_target"] = None
            save_data(data)
            return

        parts = (msg.text or "").strip().split(" ", 1)
        try:
            amount_token = parts[0]
            amount = parse_amount_token(amount_token)
            note = parts[1] if len(parts) > 1 else ""
            success, _ = update_record_in_chat(chat_id, rid, amount, note, user=msg.from_user)

            store["edit_wait"] = None
            store["edit_target"] = None
            save_data(data)

            active_id = get_active_window_id(chat_id, day_key)
            text = render_day_text(store, day_key)
            if active_id:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            else:
                update_or_send_day_window(chat_id, day_key)

            send_temp_message(chat_id, f"‚úÖ –ó–∞–ø–∏—Å—å R{rid} {'–∏–∑–º–µ–Ω–µ–Ω–∞' if success else '–Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}")
        except Exception as e:
            log_error(f"edit manual: {e}")
            send_temp_message(chat_id, "‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞. –ü—Ä–∏–º–µ—Ä: +500 –ó–∞—Ä–ø–ª–∞—Ç–∞ –∏–ª–∏ -150 –û–±–µ–¥", delay=10)
        return

    # 2) –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π (–º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ)
    if not msg.text:
        return
    lines = (msg.text or "").strip().split("\n")
    for line in lines:
        line = line.strip()
        if not line: continue
        m = re.search(num_re, line)
        if not m: continue
        try:
            raw = m.group(0)
            raw_clean = raw.replace("^", "").replace(" ", "")
            amount = parse_amount_token(raw_clean)
            note = line.replace(m.group(0), "").strip()
            add_record_to_chat(chat_id, amount, note, msg.from_user.id)
        except Exception as e:
            log_error(f"auto-add record: {e}")
            send_temp_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏: {line}")

    dk = today_key()
    active_id = get_active_window_id(chat_id, dk)
    if active_id:
        text = render_day_text(store, dk)
        bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(dk, chat_id))
    else:
        update_or_send_day_window(chat_id, dk)

    send_temp_message(chat_id, "‚úÖ –ó–∞–ø–∏—Å–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã")

# --------------------------------------------
# üß≤ Callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫
# --------------------------------------------
@bot.callback_query_handler(func=lambda c: True)
def handle_callback(call):
    try:
        chat_id = call.message.chat.id
    except Exception:
        return

    data_str = call.data or ""
    if not data_str.startswith("d:"):
        update_or_send_day_window(chat_id, today_key())
        bot.answer_callback_query(call.id)
        return

    parts = data_str.split(":")
    if len(parts) < 3:
        bot.answer_callback_query(call.id); return

    day_key = parts[1]
    action_tail = parts[2:]
    action = action_tail[0] if action_tail else ""
    store = get_chat_store(chat_id)
    prev_day = get_current_view_day(chat_id)
    set_current_view_day(chat_id, day_key)

    if action == "calopen":
        update_or_send_day_window(
            chat_id, day_key,
            create_if_missing=True,
            force_new=ALWAYS_CREATE_NEW_ON_NAV,
            delete_target_old=DELETE_TARGET_OLD_WINDOW_ON_NAV,
            delete_source_old=True,
            source_day_key=prev_day
        )
        bot.answer_callback_query(call.id, f"–û—Ç–∫—Ä—ã—Ç –¥–µ–Ω—å {day_key}")
        return

    if action == "open":
        update_or_send_day_window(
            chat_id, day_key,
            create_if_missing=True,
            force_new=ALWAYS_CREATE_NEW_ON_NAV,
            delete_target_old=DELETE_TARGET_OLD_WINDOW_ON_NAV,
            delete_source_old=DELETE_SOURCE_WINDOW_ON_NAV,
            source_day_key=prev_day
        )
        bot.answer_callback_query(call.id, f"–û—Ç–∫—Ä—ã—Ç –¥–µ–Ω—å {day_key}")
        return

    if action == "pick_date":
        kb = build_last_31days_calendar()
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text("üóì –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 31 –¥–µ–Ω—å):", chat_id, active_id, reply_markup=kb)
            except telebot.apihelper.ApiException as e:
                log_error(f"calendar edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id)
        return

    if action == "edit_menu":
        text = (
            "‚úèÔ∏è –ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n\n"
            "üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å\n"
            "üìÇ –û–±—â–∏–π CSV ‚Äî –ø–æ–ª–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç (–æ–±–Ω–æ–≤–∏—Ç CSV/META/file_id –≤ —Ç–µ—Ö –∂–µ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö)\n"
            "üìÖ CSV –∑–∞ –¥–µ–Ω—å ‚Äî —ç–∫—Å–ø–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã\n"
            "üì® –§–æ—Ä–≤–∞—Ä–¥ ‚Äî –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å\n"
            "üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å ‚Äî –∑–∞–¥–∞—Ç—å ID –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏\n"
            "‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞\n\n"
            "üìÖ –°–µ–≥–æ–¥–Ω—è / üìÜ –í—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å / ‚ÑπÔ∏è –ò–Ω—Ñ–æ / üîô –ù–∞–∑–∞–¥"
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"edit_menu edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key, create_if_missing=True)
        bot.answer_callback_query(call.id, "–ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚úèÔ∏è")
        return

    if action == "refresh":
        active_id = get_active_window_id(chat_id, day_key)
        text = render_day_text(store, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"refresh edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key, create_if_missing=True)
        bot.answer_callback_query(call.id, "–û–±–Ω–æ–≤–ª–µ–Ω–æ üîÑ")
        return

    if action == "info":
        info_text = (
            f"‚ÑπÔ∏è –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è {VERSION}\n\n"
            "–ö–æ–º–∞–Ω–¥—ã:\n"
            "/start /view YYYY-MM-DD /prev /next /balance /report /csv /reset /ping /help\n\n"
            "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ: +500 –ó–∞—Ä–ø–ª–∞—Ç–∞  –∏–ª–∏  -150 –û–±–µ–¥.\n"
            "–°–∏—Å—Ç–µ–º–Ω–æ: CSV, —Ñ–æ—Ä–≤–∞—Ä–¥, webhook, keep-alive."
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(info_text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"info edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id)
        return

    if action == "balance":
        day_records = store.get("daily_records", {}).get(day_key, [])
        income = sum(r["amount"] for r in day_records if r["amount"] > 0)
        expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
        overall = store.get("balance", 0)
        text = (
            f"üìÖ {day_key}\n\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(abs(expense))} ARS\n"
            f"üí∞ –û—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall)} ARS"
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"balance edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, "–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—ë–Ω ‚úÖ")
        return

    if action == "total":
        all_records = data.get("records", [])
        total = data.get("overall_balance", 0)
        total_income = sum(r["amount"] for r in all_records if r["amount"] > 0)
        total_expense = sum(r["amount"] for r in all_records if r["amount"] < 0)
        text = (
            f"üìä –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è:\n\n"
            f"üíµ –û–±—â–∏–π –ø—Ä–∏—Ö–æ–¥: {fmt_num(total_income)} ARS\n"
            f"üí∏ –û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥: {fmt_num(abs(total_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(total)} ARS"
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"total edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, "–û–±—â–∏–π –∏—Ç–æ–≥ üìä")
        return

    if action == "report":
        day_records = store.get("daily_records", {}).get(day_key, [])
        expenses = [r for r in day_records if r["amount"] < 0]
        if not expenses:
            text = f"üìÖ {day_key}\n–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å.\nüí∏ –†–∞—Å—Ö–æ–¥: 0 ARS"
        else:
            lines = [f"üìÖ {day_key}", "üìã –†–∞—Å—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å:"]
            for r in expenses[-30:]:
                lines.append(f"{r['short_id']}: -{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
            lines.append(f"\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(sum(abs(r['amount']) for r in expenses))} ARS")
            text = "\n".join(lines)
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"report edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, "–û—Ç—á—ë—Ç –æ–±–Ω–æ–≤–ª—ë–Ω üìä")
        return

    # --- CSV: –æ–±—â–∏–π –∏ –¥–Ω–µ–≤–Ω–æ–π ---
    if action == "csv_all":
        try:
            # –û–±–Ω–æ–≤–ª—è–µ–º –í–°–Å –≤ —Ç–µ—Ö –∂–µ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –≤–ª–∞–¥–µ–ª—å—Ü–∞
            sync_all_backups(force=True)
            bot.answer_callback_query(call.id, "CSV/META/file_id –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤ –∏—Å—Ö–æ–¥–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö.")
        except Exception as e:
            send_temp_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ CSV/META/file_id: {e}")
            bot.answer_callback_query(call.id)
        return

    if action == "csv_day":
        try:
            filename = f"data_{day_key}.csv"
            day_records = store.get("daily_records", {}).get(day_key, [])
            with open(filename, "w", newline="", encoding="utf-8") as f:
                w = csv.writer(f)
                w.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
                for r in day_records:
                    w.writerow([chat_id, r.get("id"), r.get("short_id"), r.get("timestamp"),
                                r.get("amount"), r.get("note"), r.get("owner"), day_key])
            with open(filename, "rb") as f:
                bot.send_document(chat_id, f, caption=f"üìÖ CSV –∑–∞ –¥–µ–Ω—å: {filename}")
            bot.answer_callback_query(call.id, f"CSV –∑–∞ –¥–µ–Ω—å {day_key} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")
        except Exception as e:
            send_temp_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ {day_key}: {e}")
            bot.answer_callback_query(call.id)
        return

    # --- –ü–µ—Ä–µ—Å—ã–ª–∫–∞: –≤–∫–ª/–≤—ã–∫–ª ---
    if action == "toggle_forward":
        store["forward_enabled"] = not store.get("forward_enabled", False)
        save_data(data)
        status = "–≤–∫–ª—é—á–µ–Ω–∞ ‚úÖ" if store["forward_enabled"] else "–≤—ã–∫–ª—é—á–µ–Ω–∞ ‚ùå"
        update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, f"–ü–µ—Ä–µ—Å—ã–ª–∫–∞ {status}")
        return

    # --- –ü–µ—Ä–µ—Å—ã–ª–∫–∞: –∑–∞–¥–∞—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è ---
    if action == "set_forward_target":
        try:
            bot.answer_callback_query(call.id)
            sent = send_temp_message(chat_id, "–í–≤–µ–¥–∏—Ç–µ ID (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –¥–ª—è —á–∞—Ç–æ–≤) –∏–ª–∏ 0 –¥–ª—è —Å–±—Ä–æ—Å–∞:", delay=25)
            if sent:
                bot.register_next_step_handler(sent, lambda m: process_forward_target(m, day_key))
        except Exception as e:
            log_error(f"set_forward_target: {e}")
            bot.answer_callback_query(call.id, "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—Ä–æ—Å–∏—Ç—å ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è.")
        return

    if action == "reset":
        update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, "–î–ª—è –æ–±–Ω—É–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /reset")
        return

    if action in ("back_main", "edit_back", "noop", "info_ok"):
        update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id)
        return

    # --- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: —Å–ø–∏—Å–æ–∫/–¥–µ—Ç–∞–ª—å/–≤–≤–æ–¥/—É–¥–∞–ª–µ–Ω–∏–µ ---
    if action == "edit_list":
        day_records = store.get("daily_records", {}).get(day_key, [])
        if not day_records:
            text = f"üìÖ {day_key}\n–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å."
            active_id = get_active_window_id(chat_id, day_key)
            if active_id:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))
            bot.answer_callback_query(call.id, "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
            return
        lines = [f"üìÖ {day_key}", "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"]
        kb = types.InlineKeyboardMarkup(row_width=1)
        for r in reversed(day_records[-20:]):
            sign = "+" if r["amount"] > 0 else "-"
            label = f"{r['short_id']}: {sign}{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}"
            kb.add(types.InlineKeyboardButton(label, callback_data=f"d:{day_key}:rec:{r['id']}"))
        kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:back_main"))
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text("\n".join(lines), chat_id, active_id, reply_markup=kb)
            except telebot.apihelper.ApiException as e:
                log_error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —Å–ø–∏—Å–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
        bot.answer_callback_query(call.id)
        return

    if action == "rec" and len(action_tail) >= 2:
        try:
            rid = int(action_tail[1])
        except:
            bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID"); return
        day_records = store.get("daily_records", {}).get(day_key, [])
        rec = next((r for r in day_records if r["id"] == rid), None)
        if not rec:
            bot.answer_callback_query(call.id, "–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"); return
        sign = "+" if rec["amount"] > 0 else "-"
        text = f"–ó–∞–ø–∏—Å—å {rec['short_id']}\n{sign}{fmt_num(abs(rec['amount']))} ‚Äî {rec.get('note','')}\n–î–æ–±–∞–≤–ª–µ–Ω–∞: {rec.get('timestamp')}"
        kb = build_edit_keyboard_for_record(day_key, rid)
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            except telebot.apihelper.ApiException as e:
                log_error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –¥–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏: {e}")
        bot.answer_callback_query(call.id)
        return

    if action == "edit_manual" and len(action_tail) >= 2:
        try:
            rid = int(action_tail[1])
        except:
            bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID"); return
        store["edit_wait"] = f"change_value:{day_key}"
        store["edit_target"] = rid
        save_data(data)
        text = (
            f"‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ R{rid}\n\n"
            "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—É–º–º—É –∏ –∑–∞–º–µ—Ç–∫—É:\n"
            "+500 –ó–∞—Ä–ø–ª–∞—Ç–∞  –∏–ª–∏  ^+^500^ –ó–∞—Ä–ø–ª–∞—Ç–∞  –∏–ª–∏  ^-^150^ –û–±–µ–¥"
        )
        kb = types.InlineKeyboardMarkup(row_width=1)
        kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:edit_list"))
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            except telebot.apihelper.ApiException as e:
                log_error(f"edit_manual edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key, create_if_missing=True)
        bot.answer_callback_query(call.id, "–û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—É–º–º—ã ‚úèÔ∏è")
        return

    if action == "edit_delete" and len(action_tail) >= 2:
        try:
            rid = int(action_tail[1])
        except:
            bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID"); return
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(
                    f"‚ùó –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ R{rid}:",
                    chat_id, active_id, reply_markup=build_confirm_delete_keyboard(day_key, rid)
                )
            except telebot.apihelper.ApiException as e:
                log_error(f"edit_delete confirm edit: {e}")
        bot.answer_callback_query(call.id)
        return

    if action == "confirm_delete" and len(action_tail) >= 2:
        try:
            rid = int(action_tail[1])
        except:
            bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID"); return
        success, _ = delete_record_in_chat(chat_id, rid, user=call.from_user)
        text = "‚úÖ –ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞" if success else "‚ö†Ô∏è –ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))
        bot.answer_callback_query(call.id, "–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞" if success else "–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return

    if action == "cancel_delete":
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            text = "‚úèÔ∏è –ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
            bot.edit_message_text(text, chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))
        bot.answer_callback_query(call.id, "–û—Ç–º–µ–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è")
        return

    if action == "confirm_reset_all":
        try:
            cid = str(chat_id)
            if cid in data.get("chats", {}):
                data["chats"].pop(cid, None)
            data["records"] = [r for r in data.get("records", []) if str(r.get("owner")) != cid]
            data["overall_balance"] = sum(x["amount"] for x in data.get("records", []))
            save_data(data, force_backup=True)
            text = "‚öôÔ∏è –í—Å–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω—ã."
            active_id = get_active_window_id(chat_id, day_key)
            if active_id:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(today_key(), chat_id))
            else:
                bot.send_message(chat_id, text)
            bot.answer_callback_query(call.id, "–î–∞–Ω–Ω—ã–µ –æ–±–Ω—É–ª–µ–Ω—ã ‚úÖ")
        except Exception as e:
            log_error(f"confirm_reset_all: {e}")
            send_temp_message(chat_id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω—É–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.")
            bot.answer_callback_query(call.id, "–û—à–∏–±–∫–∞ –æ–±–Ω—É–ª–µ–Ω–∏—è")
        return

    bot.answer_callback_query(call.id)

# --------------------------------------------
# üë§ –†—É—á–Ω–æ–π –≤–≤–æ–¥ ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è (—Ñ–æ—Ä–≤–∞—Ä–¥)
# --------------------------------------------
def process_forward_target(message, day_key_for_refresh=None):
    try:
        chat_id = message.chat.id
        store = get_chat_store(chat_id)
        text = (message.text or "").strip()

        if text == "0":
            store["forward_target_id"] = None
            save_data(data)
            send_temp_message(chat_id, "‚úÖ –ü–æ–ª—É—á–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Å—ã–ª–∫–∏ —Å–±—Ä–æ—à–µ–Ω (–±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è OWNER_ID –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏).")
            update_or_send_day_window(chat_id, day_key_for_refresh or today_key())
            return

        if not (text.startswith("-") or text.isdigit()):
            send_temp_message(chat_id, "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID. –ü—Ä–∏–º–µ—Ä: -1001234567890\n–í–≤–µ–¥–∏—Ç–µ —Å–Ω–æ–≤–∞ –∏–ª–∏ 0 –¥–ª—è —Å–±—Ä–æ—Å–∞.")
            return

        target = int(text)
        store["forward_target_id"] = target
        save_data(data)
        send_temp_message(chat_id, f"‚úÖ –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –∏–¥—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å ID {target}.")
        update_or_send_day_window(chat_id, day_key_for_refresh or today_key())
    except Exception as e:
        log_error(f"process_forward_target: {e}")
        try:
            send_temp_message(message.chat.id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.")
        except:
            pass

# --------------------------------------------
# üåê Flask webhook
# --------------------------------------------
@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    try:
        update = telebot.types.Update.de_json(request.get_data().decode("utf-8"))
        bot.process_new_updates([update])
    except Exception as e:
        log_error(f"webhook error: {e}")
    return "OK", 200

@app.route("/", methods=["GET"])
def index():
    return f"–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è {VERSION} —Ä–∞–±–æ—Ç–∞–µ—Ç", 200

# --------------------------------------------
# üü¢ Keep-alive + –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∏
# --------------------------------------------
def keep_alive_task():
    while True:
        try:
            if APP_URL:
                try:
                    resp = requests.get(APP_URL, timeout=10)
                    log_info(f"Keep-alive self-ping {APP_URL} -> {getattr(resp, 'status_code', '?')}")
                except Exception as e:
                    log_error(f"Keep-alive self-p–∏–Ω–≥ error: {e}")
            if KEEP_ALIVE_SEND_TO_OWNER and OWNER_ID:
                try:
                    tgt = int(OWNER_ID)
                    send_temp_message(tgt, f"üü¢ Keep-alive: –±–æ—Ç {VERSION} –∞–∫—Ç–∏–≤–µ–Ω.\n{now_local().isoformat(timespec='seconds')}")
                except Exception as e:
                    log_error(f"Keep-alive notify owner: {e}")
        except Exception as e:
            log_error(f"Keep-alive loop: {e}")
        time.sleep(max(10, KEEP_ALIVE_INTERVAL_SECONDS))

def start_keep_alive_thread():
    threading.Thread(target=keep_alive_task, daemon=True).start()

def schedule_daily_window_creation():
    def task():
        last_day = today_key()
        while True:
            try:
                time.sleep(60)
                current_day = today_key()
                if current_day != last_day:
                    for chat_id_str in list(data.get("chats", {}).keys()):
                        try:
                            chat_id = int(chat_id_str)
                        except:
                            continue
                        try:
                            update_or_send_day_window(
                                chat_id, current_day,
                                create_if_missing=True, force_new=True,
                                delete_target_old=True, delete_source_old=False
                            )
                        except Exception as e:
                            log_error(f"daily new window {chat_id}: {e}")
                    last_day = current_day
            except Exception as e:
                log_error(f"daily loop: {e}")
                time.sleep(5)
    threading.Thread(target=task, daemon=True).start()

# --------------------------------------------
# ü™ù Webhook –∏ –∑–∞–ø—É—Å–∫
# --------------------------------------------
def set_webhook():
    url = f"{APP_URL}/{TOKEN}"
    try:
        bot.remove_webhook()
        time.sleep(0.5)
        bot.set_webhook(url=url)
        log_info(f"Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {url}")
    except Exception as e:
        log_error(f"set_webhook: {e}")

# --------------------------------------------
# ‚ûï –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (/view, /prev, /next, /balance, /report)
# --------------------------------------------
@bot.message_handler(commands=["view"])
def cmd_view(msg):
    chat_id = msg.chat.id
    parts = (msg.text or "").split()
    if len(parts) < 2:
        send_temp_message(chat_id, "–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É: /view YYYY-MM-DD"); return
    d = parse_date_key(parts[1])
    if not d:
        send_temp_message(chat_id, "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü—Ä–∏–º–µ—Ä: /view 2025-11-02"); return
    dk = d.strftime("%Y-%m-%d")
    prev_day = get_current_view_day(chat_id)
    update_or_send_day_window(
        chat_id, dk,
        create_if_missing=True, force_new=True,
        delete_target_old=True, delete_source_old=DELETE_SOURCE_WINDOW_ON_NAV,
        source_day_key=prev_day
    )

@bot.message_handler(commands=["prev"])
def cmd_prev(msg):
    chat_id = msg.chat.id
    current = get_current_view_day(chat_id)
    prev_key = shift_date_key(current, -1)
    update_or_send_day_window(
        chat_id, prev_key,
        create_if_missing=True, force_new=True,
        delete_target_old=True, delete_source_old=DELETE_SOURCE_WINDOW_ON_NAV,
        source_day_key=current
    )

@bot.message_handler(commands=["next"])
def cmd_next(msg):
    chat_id = msg.chat.id
    current = get_current_view_day(chat_id)
    next_key = shift_date_key(current, +1)
    update_or_send_day_window(
        chat_id, next_key,
        create_if_missing=True, force_new=True,
        delete_target_old=True, delete_source_old=DELETE_SOURCE_WINDOW_ON_NAV,
        source_day_key=current
    )

@bot.message_handler(commands=["balance"])
def cmd_balance(msg):
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    dk = today_key()
    day_records = store.get("daily_records", {}).get(dk, [])
    inc = sum(r["amount"] for r in day_records if r["amount"] > 0)
    exp = sum(r["amount"] for r in day_records if r["amount"] < 0)
    bal = store.get("balance", 0)
    text = (
        f"üìÖ {dk}\n\n"
        f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(bal)} ARS\n"
        f"üíµ –ü—Ä–∏—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(inc)} ARS\n"
        f"üí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(abs(exp))} ARS"
    )
    bot.send_message(chat_id, text)

@bot.message_handler(commands=["report"])
def cmd_report(msg):
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    dk = today_key()
    day_records = store.get("daily_records", {}).get(dk, [])
    expenses = [r for r in day_records if r["amount"] < 0]
    if not expenses:
        bot.send_message(chat_id, f"üìÖ {dk}\n–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è.\nüí∏ –†–∞—Å—Ö–æ–¥: 0 ARS"); return
    lines = [f"üìÖ {dk}", "üìã –†–∞—Å—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å:"]
    for r in expenses[-30:]:
        lines.append(f"{r['short_id']}: -{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
    lines.append(f"\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(sum(abs(r['amount']) for r in expenses))} ARS")
    bot.send_message(chat_id, "\n".join(lines))

# --------------------------------------------
# üöÄ –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
# --------------------------------------------
if __name__ == "__main__":
    # 1) –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ CSV –∏–ª–∏ Telegram –ø–æ –º–µ—Ç–∞
    restored_data = restore_from_csv_if_needed()
    if restored_data:
        data = restored_data
        log_info("üíæ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã (CSV/TG).")

    # 2) –í–µ–±—Ö—É–∫
    set_webhook()

    # 3) –ü–ª–∞–Ω–æ–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞ –Ω–æ–≤–æ–≥–æ –¥–Ω—è
    schedule_daily_window_creation()

    # 4) –§–æ–Ω–æ–≤–æ–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 3 —á–∞—Å–∞
    def auto_update_task():
        while True:
            try:
                log_info("üïí –ü–ª–∞–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ JSON –∏ CSV...")
                save_data(data)
                time.sleep(3 * 60 * 60)
            except Exception as e:
                log_error(f"auto_update_task: {e}")
                time.sleep(60)
    threading.Thread(target=auto_update_task, daemon=True).start()

    # 5) Keep-alive
    start_keep_alive_thread()

    # 6) –°–æ–æ–±—â–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É
    log_info(f"–ë–æ—Ç –≤–µ—Ä—Å–∏–∏ {VERSION} –∑–∞–ø—É—â–µ–Ω")
    try:
        if OWNER_ID:
            bot.send_message(int(OWNER_ID), f"‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! (–≤–µ—Ä—Å–∏—è {VERSION})\n"
                                            f"üí° –û—Ç–ø—Ä–∞–≤—å /start –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤.")
    except Exception as e:
        log_error(f"send startup msg: {e}")

    app.run(host="0.0.0.0", port=PORT)