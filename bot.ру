# ============================================================
# üßæ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è 9.8.6-fo_6+GDriveOnly (UI-full + –ø–µ—Ä–µ—Å—ã–ª–∫–∞, –ø—Ä–∞–≤–∫–∏ 1‚Äì9)
# ID Code_021g
# ============================================================
# ‚Ä¢ –ü–æ–ª–Ω—ã–π UI –∫–∞–∫ –≤ Code_019e
# ‚Ä¢ –ë—ç–∫–∞–ø / –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ Google Drive (–æ–±–∞ —Å–ø–æ—Å–æ–±–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
# ‚Ä¢ –ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –º–µ–∂–¥—É —á–∞—Ç–∞–º–∏ (—Ç–æ–ª—å–∫–æ OWNER)
# ‚Ä¢ –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞ /–ø–æ–µ—Ö–∞–ª–∏–§–û123/
# ‚Ä¢ –ü–∞—Ä—Å–µ—Ä —Å—É–º–º —Å –ª—é–±—ã–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º
# ‚Ä¢ –ë–∞–ª–∞–Ω—Å –ø–æ —Ç–µ–∫—É—â–µ–º—É —á–∞—Ç—É –∏ —Ñ–∞–π–ª—ã data_<chat_id>.json –∏ —Ç.–¥.
# ============================================================

import os, json, csv, re, io, html, time, logging, threading, requests
from datetime import datetime, timedelta, timezone
from zoneinfo import ZoneInfo
import telebot
from telebot import types
from flask import Flask, request
# Google Drive
from googleapiclient.discovery import build
from googleapiclient.http import MediaFileUpload, MediaIoBaseDownload
from google.oauth2 import service_account
from google_auth_oauthlib.flow import InstalledAppFlow

# ============================================================
# ‚öôÔ∏è –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
# ============================================================
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")
APP_URL = os.getenv("APP_URL", "https://yourapp.onrender.com")
PORT = int(os.getenv("PORT", 5000))
VERSION = "9.8.6-fo_6+GDriveOnly (UI-full + –ø–µ—Ä–µ—Å—ã–ª–∫–∞)"
KEEP_ALIVE_INTERVAL_SECONDS = 11 * 60

DATA_FILE = "data.json"
CSV_FILE = "data.csv"
CSV_META_FILE = "csv_meta.json"
LOG_FILE = "log.txt"
SCOPES = ["https://www.googleapis.com/auth/drive.file"]

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

try:
    TZ = ZoneInfo(os.getenv("TZ", "America/Argentina/Buenos_Aires"))
except Exception:
    TZ = timezone(timedelta(hours=-3))

# ============================================================
# üß© –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ö GOOGLE DRIVE (2 –≤–∞—Ä–∏–∞–Ω—Ç–∞)
# ============================================================
def build_gdrive_service():
    try:
        # 1Ô∏è‚É£ Service Account
        if os.getenv("SERVICE_ACCOUNT_JSON"):
            creds = service_account.Credentials.from_service_account_info(
                json.loads(os.getenv("SERVICE_ACCOUNT_JSON")), scopes=SCOPES)
            return build("drive", "v3", credentials=creds)
        # 2Ô∏è‚É£ OAuth (token.json + credentials.json)
        elif os.path.exists("token.json"):
            from google.oauth2.credentials import Credentials
            creds = Credentials.from_authorized_user_file("token.json", SCOPES)
            return build("drive", "v3", credentials=creds)
        elif os.path.exists("credentials.json"):
            flow = InstalledAppFlow.from_client_secrets_file("credentials.json", SCOPES)
            creds = flow.run_local_server(port=0)
            with open("token.json", "w") as token:
                token.write(creds.to_json())
            return build("drive", "v3", credentials=creds)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Drive: {e}")
    return None

drive_service = build_gdrive_service()

# ============================================================
# üßæ –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
# ============================================================
logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[logging.FileHandler(LOG_FILE, encoding="utf-8"), logging.StreamHandler()]
)
def log_info(m): logging.info(m)
def log_warn(m): logging.warning(m)
def log_err(m): logging.error(m)

# ============================================================
# ‚è∞ –í–†–ï–ú–Ø
# ============================================================
def now_local(): return datetime.now(TZ)
def today_key(): return now_local().strftime("%Y-%m-%d")

def fmt_num(v):
    try: return f"{v:,.0f}".replace(",", ".")
    except: return str(v)

# ============================================================
# üíæ –î–ê–ù–ù–´–ï
# ============================================================
def default_data():
    return {"records": {}, "chats": {}, "active_finance": [], "forward_rules": {}, "next_id": 1}

def _load_json(path, fb):
    try:
        if os.path.exists(path):
            with open(path, "r", encoding="utf-8") as f: return json.load(f)
    except Exception as e: log_err(f"_load_json {path}: {e}")
    return fb

def _save_json(path, obj):
    try:
        with open(path, "w", encoding="utf-8") as f: json.dump(obj, f, ensure_ascii=False, indent=2)
    except Exception as e: log_err(f"_save_json {path}: {e}")

def load_data(): return _load_json(DATA_FILE, default_data())
data = load_data()

# ============================================================
# üí∞ –ü–ê–†–°–ï–† –°–£–ú–ú
# ============================================================
def parse_amount(raw):
    try:
        s = str(raw).strip().replace(" ", "").replace(",", ".")
        s = re.sub(r"[^0-9\.\-]", "", s)
        return float(s)
    except: return 0.0

# ============================================================
# üì¶ EXPORT/IMPORT –ù–ê DRIVE
# ============================================================
def upload_to_gdrive(filename, chat_id):
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞"""
    if not drive_service: return
    name = f"{os.path.splitext(filename)[0]}_{chat_id}{os.path.splitext(filename)[1]}"
    try:
        media = MediaFileUpload(filename, resumable=True)
        results = drive_service.files().list(q=f"name='{name}'", fields="files(id)").execute()
        files = results.get("files", [])
        if files:
            file_id = files[0]["id"]
            drive_service.files().update(fileId=file_id, media_body=media).execute()
            log_info(f"‚òÅÔ∏è –û–±–Ω–æ–≤–ª—ë–Ω {filename} –¥–ª—è —á–∞—Ç–∞ {chat_id}")
        else:
            file = drive_service.files().create(body={"name": name}, media_body=media, fields="id").execute()
            log_info(f"‚òÅÔ∏è –°–æ–∑–¥–∞–Ω {filename} –¥–ª—è —á–∞—Ç–∞ {chat_id}")
    except Exception as e:
        log_err(f"upload_to_gdrive({filename}): {e}")

def download_from_gdrive(filename, chat_id):
    """–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–∞–π–ª —Å Drive"""
    if not drive_service: return
    name = f"{os.path.splitext(filename)[0]}_{chat_id}{os.path.splitext(filename)[1]}"
    try:
        results = drive_service.files().list(q=f"name='{name}'", fields="files(id)").execute()
        files = results.get("files", [])
        if not files:
            log_warn(f"‚õî {filename} –¥–ª—è {chat_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ Drive")
            return
        file_id = files[0]["id"]
        request = drive_service.files().get_media(fileId=file_id)
        with io.FileIO(filename, "wb") as f: MediaIoBaseDownload(f, request).next_chunk()
        log_info(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω {filename} –¥–ª—è —á–∞—Ç–∞ {chat_id}")
    except Exception as e:
        log_err(f"download_from_gdrive({filename}): {e}")

def export_to_csv(chat_id):
    """–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV –¥–ª—è —á–∞—Ç–∞"""
    try:
        chat_data = data["chats"].get(str(chat_id), {}).get("records", {})
        with open(CSV_FILE, "w", newline="", encoding="utf-8") as f:
            w = csv.writer(f)
            w.writerow(["date", "id", "comment", "amount"])
            for day, recs in chat_data.items():
                for r in recs:
                    w.writerow([day, r.get("id"), r.get("comment"), r.get("amount")])
        upload_to_gdrive(CSV_FILE, chat_id)
    except Exception as e:
        log_err(f"export_to_csv: {e}")

# ============================================================
# üßÆ –ë–ê–õ–ê–ù–°
# ============================================================
def calculate_total_for_chat(chat_id):
    try:
        total = 0
        for day, recs in data["chats"].get(str(chat_id), {}).get("records", {}).items():
            for r in recs: total += r.get("amount", 0)
        return total
    except: return 0

# ============================================================
# üí¨ UI ‚Äî –û–ö–ù–û –î–ù–Ø / –ú–ï–ù–Æ
# ============================================================
def build_main_menu(chat_id, day_key):
    kb = types.InlineKeyboardMarkup()
    kb.row(types.InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å", callback_data=f"add:{day_key}"),
           types.InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"edit:{day_key}"))
    kb.row(types.InlineKeyboardButton("‚¨ÖÔ∏è", callback_data=f"prev:{day_key}"),
           types.InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data="today"),
           types.InlineKeyboardButton("‚û°Ô∏è", callback_data=f"next:{day_key}"))
    kb.row(types.InlineKeyboardButton("üìÜ –í—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å", callback_data=f"calendar:{day_key}"))
    kb.row(types.InlineKeyboardButton("üí∞ –û–±—â–∏–π –∏—Ç–æ–≥", callback_data=f"balance:{day_key}"))
    return kb

def render_day_window(chat_id, day_key):
    chat = data["chats"].setdefault(str(chat_id), {"records": {}})
    recs = chat["records"].get(day_key, [])
    total = sum(r.get("amount",0) for r in recs)
    text = [f"üìÖ <b>{day_key}</b>"]
    for r in recs:
        a = r.get("amount",0)
        sign = "‚ûï" if a>=0 else "‚ûñ"
        text.append(f"{sign} {fmt_num(a)} ‚Äî {html.escape(r.get('comment',''))}")
    text.append(f"\n<b>üí∞ –ò—Ç–æ–≥–æ:</b> {fmt_num(total)}")
    return "\n".join(text), build_main_menu(chat_id, day_key)
# ============================================================
# ‚úèÔ∏è –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ò –î–û–ë–ê–í–õ–ï–ù–ò–ï
# ============================================================

@bot.callback_query_handler(func=lambda c: c.data.startswith("add:"))
def handle_add(call):
    day_key = call.data.split(":", 1)[1]
    chat_id = call.message.chat.id
    bot.send_message(chat_id, f"–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è {day_key}:")
    data["chats"].setdefault(str(chat_id), {"records": {}})
    data["active"] = {"chat": chat_id, "day": day_key}
    _save_json(DATA_FILE, data)

@bot.message_handler(func=lambda m: data.get("active", {}).get("chat") == m.chat.id)
def handle_add_text(msg):
    st = data.get("active", {})
    chat_id, day_key = st["chat"], st["day"]
    parts = msg.text.strip().split(maxsplit=1)
    amount = parse_amount(parts[0]) if parts else 0
    comment = parts[1] if len(parts) > 1 else ""
    chat = data["chats"].setdefault(str(chat_id), {"records": {}})
    recs = chat["records"].setdefault(day_key, [])
    rec_id = data.get("next_id", 1)
    data["next_id"] = rec_id + 1
    recs.append({"id": rec_id, "amount": amount, "comment": comment})
    data.pop("active", None)
    _save_json(DATA_FILE, data)

    # —Å–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –æ–∫–Ω–æ, –ø–æ—Ç–æ–º –¥–µ–ª–∞–µ–º –±—ç–∫–∞–ø
    txt, kb = render_day_window(chat_id, day_key)
    bot.send_message(chat_id, "‚úÖ –ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞.")
    bot.send_message(chat_id, txt, reply_markup=kb, parse_mode="HTML")
    export_to_csv(chat_id)
    upload_to_gdrive(DATA_FILE, chat_id)
    upload_to_gdrive(CSV_META_FILE, chat_id)

@bot.callback_query_handler(func=lambda c: c.data.startswith("edit:"))
def handle_edit_menu(call):
    day = call.data.split(":", 1)[1]
    kb = types.InlineKeyboardMarkup()
    kb.row(types.InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å", callback_data=f"add:{day}"))
    kb.row(types.InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å", callback_data=f"del:{day}"))
    kb.row(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"main:{day}"))
    bot.edit_message_text(f"‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ {day}", call.message.chat.id, call.message.id,
                          reply_markup=kb, parse_mode="HTML")

@bot.callback_query_handler(func=lambda c: c.data.startswith("del:"))
def handle_delete(call):
    day = call.data.split(":", 1)[1]
    chat_id = call.message.chat.id
    recs = data["chats"].get(str(chat_id), {}).get("records", {}).get(day, [])
    if not recs:
        bot.answer_callback_query(call.id, "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π.")
        return
    kb = types.InlineKeyboardMarkup()
    for r in recs:
        kb.row(types.InlineKeyboardButton(f"‚ùå {fmt_num(r['amount'])} {r.get('comment','')[:15]}",
                                          callback_data=f"rm:{day}:{r['id']}"))
    kb.row(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"main:{day}"))
    bot.edit_message_text(f"–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å ({day})", chat_id, call.message.id, reply_markup=kb)

@bot.callback_query_handler(func=lambda c: c.data.startswith("rm:"))
def handle_remove(call):
    _, day, rid = call.data.split(":")
    rid = int(rid)
    chat_id = call.message.chat.id
    recs = data["chats"].get(str(chat_id), {}).get("records", {}).get(day, [])
    data["chats"][str(chat_id)]["records"][day] = [r for r in recs if r["id"] != rid]
    _save_json(DATA_FILE, data)
    txt, kb = render_day_window(chat_id, day)
    bot.edit_message_text(txt, chat_id, call.message.id, reply_markup=kb, parse_mode="HTML")
    export_to_csv(chat_id)
    upload_to_gdrive(DATA_FILE, chat_id)
    upload_to_gdrive(CSV_FILE, chat_id)

# ============================================================
# üìÜ –ö–ê–õ–ï–ù–î–ê–†–¨ –° "–ù–ê–ó–ê–î"
# ============================================================
def build_calendar(day_key):
    kb = types.InlineKeyboardMarkup()
    today = datetime.strptime(day_key, "%Y-%m-%d")
    for i in range(0, 31, 7):
        row = [types.InlineKeyboardButton((today - timedelta(days=j)).strftime("%d"),
               callback_data=f"view:{(today - timedelta(days=j)).strftime('%Y-%m-%d')}") for j in range(i, i+7) if j < 31]
        kb.row(*row)
    kb.row(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"main:{day_key}"))
    return kb

@bot.callback_query_handler(func=lambda c: c.data.startswith("calendar:"))
def show_calendar(call):
    day = call.data.split(":", 1)[1]
    bot.edit_message_text("üìÜ –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å:", call.message.chat.id, call.message.id,
                          reply_markup=build_calendar(day))

# ============================================================
# üîÅ –ü–ï–†–ï–°–´–õ–ö–ê (OWNER)
# ============================================================
def get_forward_rules(): return data.setdefault("forward_rules", {})
def save_rules(): _save_json(DATA_FILE, data); upload_to_gdrive(DATA_FILE, OWNER_ID)

def add_rule(a, b, both=False):
    r = get_forward_rules(); r.setdefault(a, []).append(b)
    if both: r.setdefault(b, []).append(a)
    save_rules()

@bot.message_handler(commands=["–ø–µ—Ä–µ—Å—ã–ª–∫–∞"])
def show_fw(msg):
    if str(msg.chat.id) != str(OWNER_ID): return
    kb = types.InlineKeyboardMarkup()
    for cid in data.get("chats", {}):
        kb.row(types.InlineKeyboardButton(cid, callback_data=f"fwsel:{cid}"))
    bot.send_message(msg.chat.id, "üîÅ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏", reply_markup=kb)

@bot.callback_query_handler(func=lambda c: c.data.startswith("fwsel:"))
def fwsel(call):
    if str(call.message.chat.id) != str(OWNER_ID): return
    src = call.data.split(":",1)[1]
    kb = types.InlineKeyboardMarkup()
    for cid in data.get("chats", {}):
        if cid == src: continue
        kb.row(types.InlineKeyboardButton(f"‚ûú {cid}", callback_data=f"fw1:{src}:{cid}"))
        kb.row(types.InlineKeyboardButton(f"‚áÑ {cid}", callback_data=f"fw2:{src}:{cid}"))
    bot.edit_message_text(f"–ü–µ—Ä–µ—Å—ã–ª–∫–∞ –∏–∑ {src}", call.message.chat.id, call.message.id, reply_markup=kb)

@bot.callback_query_handler(func=lambda c: c.data.startswith(("fw1:","fw2:")))
def add_fw(call):
    if str(call.message.chat.id)!=str(OWNER_ID): return
    p=call.data.split(":"); both=p[0]=="fw2"
    add_rule(p[1],p[2],both)
    bot.answer_callback_query(call.id,"‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–æ")

@bot.message_handler(content_types=["text","photo","video","document","voice","audio","sticker"])
def forward_any(msg):
    cid=str(msg.chat.id)
    if cid not in data.get("active_finance",[]) and cid in data.get("forward_rules",{}):
        for tgt in data["forward_rules"][cid]:
            try:
                if msg.text: bot.send_message(int(tgt), msg.text)
                elif msg.content_type in ["photo","video","document","voice","audio","sticker"]:
                    file_id=getattr(msg, msg.content_type).file_id if hasattr(msg, msg.content_type) else msg.json.get("file_id")
                    bot.send_document(int(tgt), file_id)
            except Exception as e: log_err(f"FW {cid}->{tgt}: {e}")

# ============================================================
# üöÄ –ê–ö–¢–ò–í–ê–¶–ò–Ø –†–ï–ñ–ò–ú–ê
# ============================================================
@bot.message_handler(commands=["–ø–æ–µ—Ö–∞–ª–∏–§–û123"])
def activate(msg):
    cid=str(msg.chat.id)
    if cid not in data["active_finance"]:
        data["active_finance"].append(cid)
        _save_json(DATA_FILE,data)
        bot.send_message(cid,"‚úÖ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!")
    else:
        bot.send_message(cid,"‚öôÔ∏è –£–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.")

# ============================================================
# üåê KEEP-ALIVE + WEBHOOK
# ============================================================
def keep_alive():
    while True:
        try:
            requests.get(APP_URL+"/ping",timeout=10)
        except: pass
        time.sleep(KEEP_ALIVE_INTERVAL_SECONDS)

@app.route("/ping")
def ping(): return "pong",200

@app.route(f"/{TOKEN}",methods=["POST"])
def webhook():
    update=telebot.types.Update.de_json(request.stream.read().decode("utf-8"))
    bot.process_new_updates([update])
    return "!",200

@app.route("/")
def index(): return f"‚úÖ Bot OK ‚Äî {VERSION}",200

def start_webhook():
    bot.remove_webhook(); time.sleep(1)
    bot.set_webhook(url=f"{APP_URL}/{TOKEN}")
    log_info("üåê Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
    app.run(host="0.0.0.0",port=PORT,threaded=True)

# ============================================================
# üèÅ –ó–ê–ü–£–°–ö
# ============================================================
if __name__=="__main__":
    threading.Thread(target=keep_alive,daemon=True).start()
    start_webhook()