# ============================================
# üßæ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç 9.8.6-fo_6 (clean no-GDrive no-search)
# ID Code_019d
# ============================================
# üß≠ –û–ø–∏—Å–∞–Ω–∏–µ:
#  ‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—á–Ω—ã–º–∏ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –ø–æ –¥–Ω—è–º
#  ‚Ä¢ –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ /prev /next –∏ –≤—ã–±–æ—Ä –¥–∞—Ç—ã —á–µ—Ä–µ–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—å
#  ‚Ä¢ –û—Ç—á—ë—Ç—ã, CSV-—ç–∫—Å–ø–æ—Ä—Ç, –ø–µ—Ä–µ—Å—á—ë—Ç –±–∞–ª–∞–Ω—Å–∞ –∏ –ø–µ—Ä–µ—Å—ã–ª–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü—É
#  ‚Ä¢ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ CSV –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ
#  ‚Ä¢ –ê–≤—Ç–æ–ø–∏–Ω–≥ (keep-alive) –∏ webhook –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –Ω–∞ Render
#  ‚Ä¢ ‚ùå –ë–µ–∑ Google Drive –∏ –±–µ–∑ –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤ –ª–∏—á–∫–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞
# ============================================

import os
import json
import csv
import re
import logging
import threading
import time
import html
from datetime import datetime, timedelta, timezone
from zoneinfo import ZoneInfo
import requests
import telebot
from telebot import types
from flask import Flask, request
from telethon import TelegramClient

# -----------------------------
# ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
# -----------------------------
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")
APP_URL = os.getenv("APP_URL", "https://yourapp.onrender.com")
BACKUP_CHAT_ID = os.getenv("BACKUP_CHAT_ID")
PORT = int(os.getenv("PORT", 5000))
VERSION = "9.8.6-fo_6-clean"

try:
    TZ = ZoneInfo((os.getenv("TZ") or "America/Argentina/Buenos_Aires").strip())
except Exception:
    TZ = timezone(timedelta(hours=-3))

DATA_FILE = "data.json"
CSV_FILE = "data.csv"
CSV_META_FILE = "csv_meta.json"
LOG_FILE = "log.txt"

KEEP_ALIVE_INTERVAL_SECONDS = int(os.getenv("KEEP_ALIVE_INTERVAL_SECONDS", 11 * 60))
KEEP_ALIVE_SEND_TO_OWNER = True

if not TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# -----------------------------
# ü§ñ Telethon –∫–ª–∏–µ–Ω—Ç
# -----------------------------
API_ID = int(os.getenv("API_ID", 38779045))
API_HASH = os.getenv("API_HASH", "8d351ca6eb4b233fa86d898c6bdd9173")
SESSION_NAME = "my_account"

tele_client = TelegramClient(SESSION_NAME, API_ID, API_HASH)

async def telethon_info():
    try:
        me = await tele_client.get_me()
        print(f"‚úÖ Telethon –ø–æ–¥–∫–ª—é—á—ë–Ω –∫–∞–∫ {me.first_name} (ID {me.id})")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Telethon: {e}")

with tele_client:
    tele_client.loop.run_until_complete(telethon_info())

# -----------------------------
# üßæ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# -----------------------------
logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[logging.FileHandler(LOG_FILE, encoding="utf-8"), logging.StreamHandler()]
)
def log_info(msg): logging.info(msg)
def log_error(msg): logging.error(msg)
def log_chat(msg: str, error: bool = False):
    log_info(msg) if not error else log_error(msg)
    try:
        if OWNER_ID:
            bot.send_message(int(OWNER_ID), f"ü™µ {msg}")
    except Exception as e:
        log_error(f"log_chat send failed: {e}")

log_info(f"üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ {VERSION}")

# -----------------------------
# üïí –í—Ä–µ–º—è –∏ –¥–∞—Ç—ã
# -----------------------------
def now_local() -> datetime: return datetime.now(TZ)
def today_key() -> str: return now_local().strftime("%Y-%m-%d")
def parse_date_key(s: str):
    try: return datetime.strptime(s, "%Y-%m-%d").date()
    except: return None
def shift_date_key(day_key: str, days: int) -> str:
    d = parse_date_key(day_key) or now_local().date()
    return (d + timedelta(days=days)).strftime("%Y-%m-%d")
def fmt_num(value):
    try: return f"{value:,.0f}".replace(",", ".")
    except: return str(value)
# -----------------------------
# üíæ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ I/O
# -----------------------------
def default_data():
    return {
        "overall_balance": 0,
        "records": [],
        "chats": {},
        "active_messages": {},
        "processed_messages": [],
        "forward_targets": [],
        "tracked_messages": {},
        "next_id": 1
    }

def _load_json(path, fallback):
    try:
        if os.path.exists(path):
            with open(path, "r", encoding="utf-8") as f:
                return json.load(f)
    except Exception as e:
        log_error(f"_load_json: {path}: {e}")
    return fallback

def _save_json(path, payload):
    try:
        with open(path, "w", encoding="utf-8") as f:
            json.dump(payload, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"_save_json: {path}: {e}")

def load_data():
    d = _load_json(DATA_FILE, default_data())
    base = default_data()
    for k, v in base.items():
        if k not in d:
            d[k] = v
    return d

data = load_data()

# -----------------------------
# üì§ –≠–∫—Å–ø–æ—Ä—Ç CSV
# -----------------------------
def export_to_csv(d):
    try:
        with open(CSV_FILE, "w", newline="", encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
            for cid, cdata in d.get("chats", {}).items():
                for dk, records in cdata.get("daily_records", {}).items():
                    for r in records:
                        writer.writerow([
                            cid,
                            r.get("id"), r.get("short_id"), r.get("timestamp"),
                            r.get("amount"), r.get("note"), r.get("owner"), dk
                        ])
    except Exception as e:
        log_error(f"export_to_csv: {e}")

# -----------------------------
# üß† csv_meta.json
# -----------------------------
_CSV_BACKUP_META = "csv_meta.json"
_CSV_DEBOUNCE_SECONDS = 3
_csv_backup_timer = None
_csv_backup_lock = threading.Lock()
_datajson_lock = threading.Lock()
_datajson_timer = None
_DATAJSON_DEBOUNCE_SECONDS = 5

def _load_csv_meta():
    try:
        if os.path.exists(_CSV_BACKUP_META):
            with open(_CSV_BACKUP_META, "r", encoding="utf-8") as f:
                return json.load(f)
    except Exception as e:
        log_error(f"_load_csv_meta: {e}")
    return {}

def _save_csv_meta(meta: dict):
    try:
        with open(_CSV_BACKUP_META, "w", encoding="utf-8") as f:
            json.dump(meta, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"_save_csv_meta: {e}")

# -----------------------------
# ‚òÅÔ∏è –û—Ç–ø—Ä–∞–≤–∫–∞ –±—ç–∫–∞–ø–æ–≤ –≤ –∫–∞–Ω–∞–ª BACKUP_CHAT_ID
# -----------------------------
def send_backup_to_channel():
    if not BACKUP_CHAT_ID:
        log_info("‚ö†Ô∏è BACKUP_CHAT_ID –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±—ç–∫–∞–ø–∞.")
        return
    try:
        success_count = 0
        for fname in [DATA_FILE, CSV_FILE, _CSV_BACKUP_META]:
            if os.path.exists(fname):
                with open(fname, "rb") as f:
                    sent = bot.send_document(
                        int(BACKUP_CHAT_ID),
                        f,
                        caption=f"üßæ {fname} ‚Äî –∞–≤—Ç–æ-–±—ç–∫–∞–ø ({datetime.now(TZ).strftime('%Y-%m-%d %H:%M')})"
                    )
                    success_count += 1
                    log_info(f"‚úÖ {fname} ‚Üí –∫–∞–Ω–∞–ª (message_id={sent.message_id})")
        if success_count == 0:
            log_info("‚ö†Ô∏è –ù–∏ –æ–¥–∏–Ω —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∫–∞–Ω–∞–ª.")
    except Exception as e:
        log_error(f"send_backup_to_channel: {e}")

# -----------------------------
# üì§ CSV –≤–ª–∞–¥–µ–ª—å—Ü—É (—É—Å—Ç–æ–π—á–∏–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ/–ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ)
# -----------------------------
def safe_csv_backup_to_telegram():
    try:
        if not OWNER_ID:
            return
        owner_id = int(OWNER_ID)
        export_to_csv(data)
        meta = _load_csv_meta()
        message_id = meta.get("message_id")

        with open(CSV_FILE, "rb") as f:
            try:
                if message_id:
                    bot.edit_message_media(
                        chat_id=owner_id,
                        message_id=message_id,
                        media=telebot.types.InputMediaDocument(
                            f, caption="üìä –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π CSV-–±—ç–∫–∞–ø –¥–∞–Ω–Ω—ã—Ö"
                        ),
                    )
                    log_info("‚úÖ CSV –æ–±–Ω–æ–≤–ª—ë–Ω –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏.")
                    return
            except telebot.apihelper.ApiTelegramException as e:
                err = str(e).lower()
                log_error(f"CSV edit_message_media error: {err}")
                # –µ—Å–ª–∏ —Å—Ç–∞—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞–¥–∏–º –Ω–æ–≤–æ–µ

            f.seek(0)
            sent = bot.send_document(
                owner_id,
                f,
                caption="üìä –ù–æ–≤—ã–π CSV-–±—ç–∫–∞–ø –¥–∞–Ω–Ω—ã—Ö (—Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)"
            )
            meta["message_id"] = sent.message_id
            if getattr(sent, "document", None) and getattr(sent.document, "file_id", None):
                meta["file_id_csv"] = sent.document.file_id
            meta["timestamp"] = datetime.now(TZ).isoformat(timespec="seconds")
            _save_csv_meta(meta)
            log_info("‚úÖ CSV-–±—ç–∫–∞–ø –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω –∏ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è.")
    except Exception as e:
        log_error(f"safe_csv_backup_to_telegram: {e}")

# -----------------------------
# ‚è≥ –û—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ CSV
# -----------------------------
_debounce_timer = None
def _schedule_csv_backup_debounced(delay: float = 3.0):
    global _debounce_timer
    if _debounce_timer and _debounce_timer.is_alive():
        return
    def _run_backup():
        try:
            log_info("‚è≥ –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–π CSV-–±—ç–∫–∞–ø‚Ä¶")
            safe_csv_backup_to_telegram()
        except Exception as e:
            log_error(f"_run_backup: {e}")
    _debounce_timer = threading.Timer(delay, _run_backup)
    _debounce_timer.daemon = True
    _debounce_timer.start()

# -----------------------------
# üì§ data.json –≤–ª–∞–¥–µ–ª—å—Ü—É (—Å –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π file_id)
# -----------------------------
def send_data_json_to_telegram():
    global _datajson_timer
    with _datajson_lock:
        if _datajson_timer and _datajson_timer.is_alive():
            _datajson_timer.cancel()
        _datajson_timer = threading.Timer(_DATAJSON_DEBOUNCE_SECONDS, _send_data_json_actual)
        _datajson_timer.daemon = True
        _datajson_timer.start()

def _send_data_json_actual():
    try:
        if not OWNER_ID:
            log_chat("‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ data.json ‚Äî OWNER_ID –Ω–µ –∑–∞–¥–∞–Ω.")
            return
        if not os.path.exists(DATA_FILE):
            log_chat("‚ö†Ô∏è –§–∞–π–ª data.json –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.")
            return

        owner_id = int(OWNER_ID)
        meta = _load_csv_meta()

        # —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ –±—ã–ª–∏
        for key in ("message_id_datajson", "message_id_datajson_fid"):
            try:
                if meta.get(key):
                    bot.delete_message(owner_id, meta[key])
            except Exception:
                pass

        # –æ—Ç–ø—Ä–∞–≤–∏—Ç—å data.json
        with open(DATA_FILE, "rb") as f:
            sent = bot.send_document(owner_id, f, caption="üßæ –¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª data.json")
        if getattr(sent, "document", None) and getattr(sent.document, "file_id", None):
            fid = sent.document.file_id
            meta["file_id_datajson"] = fid
            meta["message_id_datajson"] = sent.message_id
            meta["timestamp_datajson"] = datetime.now(TZ).isoformat(timespec="seconds")
            _save_csv_meta(meta)
            fid_msg = bot.send_message(
                owner_id,
                f"ü™Ñ –ê–∫—Ç—É–∞–ª—å–Ω—ã–π file_id –¥–ª—è data.json:\n<code>{html.escape(fid)}</code>",
                parse_mode="HTML"
            )
            meta["message_id_datajson_fid"] = fid_msg.message_id
            _save_csv_meta(meta)
            log_info(f"üíæ file_id –¥–ª—è data.json —Å–æ—Ö—Ä–∞–Ω—ë–Ω: {fid}")
    except Exception as e:
        log_error(f"_send_data_json_actual: {e}")

# -----------------------------
# ‚òÅÔ∏è Telethon-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –∫–∞–Ω–∞–ª–∞ (–ù–ï –∏–∑ –ª–∏—á–∫–∏)
# -----------------------------
async def restore_files_via_telethon():
    """
    –ò—â–µ—Ç –∏ —Å–∫–∞—á–∏–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ —Ñ–∞–π–ª–æ–≤ (data.csv, data.json, csv_meta.json)
    –∏–∑ –∫–∞–Ω–∞–ª–∞ BACKUP_CHAT_ID. –ë–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è getUpdates –∏ –±–µ–∑ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –≤ webhook.
    """
    chat_id = int(BACKUP_CHAT_ID) if BACKUP_CHAT_ID else 0
    if not chat_id:
        log_info("‚ö†Ô∏è BACKUP_CHAT_ID –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫ restore_files_via_telethon.")
        return
    target_files = {"data.csv", "data.json", "csv_meta.json"}
    try:
        async for msg in tele_client.iter_messages(chat_id, limit=100):
            if not msg.file or not msg.file.name:
                continue
            fname = msg.file.name
            if fname in target_files:
                await msg.download_media(file=fname)
                log_info(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω {fname} —á–µ—Ä–µ–∑ Telethon.")
                target_files.remove(fname)
            if not target_files:
                break
        if target_files:
            log_info(f"‚ÑπÔ∏è –ù–µ –Ω–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã: {', '.join(sorted(target_files))}")
    except Exception as e:
        log_error(f"restore_files_via_telethon: {e}")

async def restore_data_json_via_telethon():
    """
    –ù–∞—Ö–æ–¥–∏—Ç –∏ —Å–∫–∞—á–∏–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π data.json –∏–∑ BACKUP_CHAT_ID, –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤ –ø–∞–º—è—Ç—å.
    """
    chat_id = int(BACKUP_CHAT_ID) if BACKUP_CHAT_ID else 0
    if not chat_id:
        log_info("‚ö†Ô∏è BACKUP_CHAT_ID –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫ restore_data_json_via_telethon.")
        return False
    try:
        async for msg in tele_client.iter_messages(chat_id, limit=50):
            if msg.file and msg.file.name and msg.file.name.lower() == "data.json":
                await msg.download_media(file="data.json")
                restored = _load_json("data.json", {})
                if isinstance(restored, dict) and "records" in restored:
                    globals()["data"] = restored
                    log_info("‚úÖ data.json –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ Telethon –∏ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ –ø–∞–º—è—Ç—å.")
                    return True
                break
        log_info("‚ÑπÔ∏è data.json –≤ –∫–∞–Ω–∞–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–µ–≤–µ—Ä–Ω–∞.")
        return False
    except Exception as e:
        log_error(f"restore_data_json_via_telethon: {e}")
        return False

# -----------------------------
# üß∞ –£—Ç–∏–ª–∏—Ç—ã-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ —á–∞—Ç–∞–º
# -----------------------------
def save_data(d):
    try:
        _save_json(DATA_FILE, d)
        export_to_csv(d)
        log_info("üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ.")
    except Exception as e:
        log_error(f"save_data: {e}")

def get_chat_store(chat_id: int) -> dict:
    cid = str(chat_id)
    if cid not in data["chats"]:
        data["chats"][cid] = {
            "balance": 0,
            "records": [],
            "next_id": 1,
            "daily_records": {},
            "active_windows": {},
            "edit_wait": None,
            "edit_target": None,
            "forward_enabled": False,
            "forward_target_id": None,
            "current_view_day": today_key()
        }
        save_data(data)
    store = data["chats"][cid]
    store.setdefault("forward_enabled", False)
    store.setdefault("forward_target_id", None)
    store.setdefault("current_view_day", today_key())
    save_data(data)
    return store

def get_active_window_id(chat_id: int, day_key: str):
    return data.setdefault("active_messages", {}).setdefault(day_key, {}).get(str(chat_id))

def set_active_window(chat_id: int, day_key: str, message_id: int):
    data.setdefault("active_messages", {}).setdefault(day_key, {})[str(chat_id)] = message_id
    save_data(data)

def clear_active_window(chat_id: int, day_key: str):
    am = data.setdefault("active_messages", {}).setdefault(day_key, {})
    if str(chat_id) in am:
        am.pop(str(chat_id), None)
        save_data(data)

def delete_message_safe(chat_id: int, message_id: int):
    try:
        bot.delete_message(chat_id, message_id)
    except Exception:
        pass

def delete_active_window_if_exists(chat_id: int, day_key: str):
    old_id = get_active_window_id(chat_id, day_key)
    if old_id:
        delete_message_safe(chat_id, old_id)
        clear_active_window(chat_id, day_key)


#========================================
#üß© –ß–ê–°–¢–¨ 3 / 4
#(UI-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã, —Ä–µ–Ω–¥–µ—Ä, –æ–ø–µ—Ä–∞—Ü–∏–∏ add/update/delete, callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –∫–æ–º–∞–Ω–¥—ã)
# -----------------------------
# üõ† –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ UI
# -----------------------------
def send_temp_message(chat_id: int, text: str, delay: int = 5, **kwargs):
    try:
        msg = bot.send_message(chat_id, text, **kwargs)
        if delay and delay > 0:
            threading.Timer(delay, lambda: delete_message_safe(chat_id, msg.message_id)).start()
        return msg
    except Exception as e:
        log_error(f"send_temp_message: {e}")
        return None

def set_current_view_day(chat_id: int, day_key: str):
    store = get_chat_store(chat_id)
    store["current_view_day"] = day_key
    save_data(data)

def get_current_view_day(chat_id: int) -> str:
    store = get_chat_store(chat_id)
    return store.get("current_view_day", today_key())

def build_main_keyboard(day_key: str, chat_id: int | None = None):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å", callback_data=f"d:{day_key}:balance"),
        types.InlineKeyboardButton("üìä –û—Ç—á—ë—Ç", callback_data=f"d:{day_key}:report"),
    )
    kb.row(
        types.InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data=f"d:{day_key}:refresh"),
        types.InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"d:{day_key}:edit_menu"),
    )
    total = fmt_num(data.get("overall_balance", 0))
    kb.add(types.InlineKeyboardButton(f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {total} ARS", callback_data=f"d:{day_key}:total"))
    return kb

def build_edit_menu_keyboard(day_key: str, chat_id=None):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å", callback_data=f"d:{day_key}:edit_list"),
        types.InlineKeyboardButton("üìÇ –û–±—â–∏–π CSV", callback_data=f"d:{day_key}:csv_all")
    )
    kb.row(
        types.InlineKeyboardButton("üìÖ CSV –∑–∞ –¥–µ–Ω—å", callback_data=f"d:{day_key}:csv_day"),
        types.InlineKeyboardButton("üì® –§–æ—Ä–≤–∞—Ä–¥", callback_data=f"d:{day_key}:toggle_forward")
    )
    kb.row(
        types.InlineKeyboardButton("üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å", callback_data=f"d:{day_key}:set_forward_target"),
        types.InlineKeyboardButton("‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å", callback_data=f"d:{day_key}:reset")
    )
    kb.row(
        types.InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data=f"d:{today_key()}:open"),
        types.InlineKeyboardButton("üìÜ –í—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å", callback_data=f"d:{day_key}:pick_date")
    )
    kb.row(
        types.InlineKeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ", callback_data=f"d:{day_key}:info"),
        types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:back_main")
    )
    return kb

def build_edit_keyboard_for_record(day_key: str, rid: int):
    kb = types.InlineKeyboardMarkup(row_width=1)
    kb.add(types.InlineKeyboardButton("‚úè –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é", callback_data=f"d:{day_key}:edit_manual:{rid}"))
    kb.add(types.InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å", callback_data=f"d:{day_key}:edit_delete:{rid}"))
    kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:edit_back"))
    return kb

def build_confirm_delete_keyboard(day_key: str, rid: int):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å", callback_data=f"d:{day_key}:confirm_delete:{rid}"),
        types.InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data=f"d:{day_key}:cancel_delete")
    )
    return kb

def build_reset_confirm_keyboard(day_key: str):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("‚úÖ –î–∞, –æ–±–Ω—É–ª–∏—Ç—å", callback_data=f"d:{day_key}:confirm_reset_all"),
        types.InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data=f"d:{day_key}:cancel_reset_all")
    )
    return kb

def build_last_31days_calendar():
    today = now_local().date()
    days = [today - timedelta(days=i) for i in range(0, 31)]
    kb = types.InlineKeyboardMarkup()
    row = []
    for idx, d in enumerate(days, start=1):
        label = d.strftime("%d/%m"); dk = d.strftime("%Y-%m-%d")
        row.append(types.InlineKeyboardButton(text=label, callback_data=f"d:{dk}:calopen"))
        if idx % 7 == 0:
            kb.row(*row); row = []
    if row: kb.row(*row)
    return kb

# -----------------------------
# üñº –†–µ–Ω–¥–µ—Ä –æ–∫–Ω–∞ –¥–Ω—è
# -----------------------------
def render_day_text(store: dict, day_key: str) -> str:
    day_records = store.get("daily_records", {}).get(day_key, [])
    daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
    daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
    overall_balance = store.get("balance", 0)

    if not day_records:
        text = (
            f"üìÖ {day_key}\n"
            f"–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å.\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥: {fmt_num(daily_income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {fmt_num(abs(daily_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall_balance)} ARS"
        )
    else:
        lines = [f"üìÖ {day_key}", "üìã –û–ø–µ—Ä–∞—Ü–∏–∏:"]
        for r in day_records[-50:]:
            sign = "+" if r["amount"] > 0 else "-"
            lines.append(f"{r['short_id']}: {sign}{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
        lines.append(
            f"\nüíµ –ü—Ä–∏—Ö–æ–¥: {fmt_num(daily_income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {fmt_num(abs(daily_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall_balance)} ARS"
        )
        text = "\n".join(lines)

    if store.get("forward_enabled"):
        tgt = store.get("forward_target_id") or OWNER_ID
        text += f"\n\nüì® –ü–µ—Ä–µ—Å—ã–ª–∫–∞: –í–∫–ª—é—á–µ–Ω–∞ ‚Üí {tgt}"
    else:
        text += f"\n\nüì® –ü–µ—Ä–µ—Å—ã–ª–∫–∞: –í—ã–∫–ª—é—á–µ–Ω–∞"
    return text

# -----------------------------
# üîÅ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞ –¥–Ω—è
# -----------------------------
def update_or_send_day_window(
    chat_id: int,
    day_key: str = None,
    create_if_missing: bool = True,
    force_new: bool = False,
    delete_target_old: bool = False,
    delete_source_old: bool = False,
    source_day_key: str | None = None
):
    day_key = day_key or today_key()
    store = get_chat_store(chat_id)

    if delete_target_old:
        delete_active_window_if_exists(chat_id, day_key)
    if delete_source_old and source_day_key and source_day_key != day_key:
        delete_active_window_if_exists(chat_id, source_day_key)

    set_current_view_day(chat_id, day_key)

    text = render_day_text(store, day_key)
    kb = build_main_keyboard(day_key, chat_id)
    active_id = get_active_window_id(chat_id, day_key)

    if not force_new and active_id:
        try:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            return
        except telebot.apihelper.ApiException as e:
            log_error(f"edit_message_text: {e}")

    if not create_if_missing and not force_new:
        return

    try:
        sent = bot.send_message(chat_id, text, reply_markup=kb)
        set_active_window(chat_id, day_key, sent.message_id)
    except Exception as e:
        log_error(f"send new window: {e}")

# -----------------------------
# ‚ûï/‚úèÔ∏è/üóë –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –∑–∞–ø–∏—Å—è–º–∏
# -----------------------------
def add_record_to_chat(chat_id: int, amount: int, note: str, owner):
    store = get_chat_store(chat_id)
    rid = data.get("next_id", 1)
    rec = {
        "id": rid,
        "short_id": f"R{rid}",
        "timestamp": now_local().isoformat(timespec="seconds"),
        "amount": amount,
        "note": note,
        "owner": owner
    }
    data.setdefault("records", []).append(rec)
    store.setdefault("records", []).append(rec)
    day = today_key()
    store.setdefault("daily_records", {}).setdefault(day, []).append(rec)
    store["balance"] = store.get("balance", 0) + amount
    data["overall_balance"] = data.get("overall_balance", 0) + amount
    data["next_id"] = rid + 1

    save_data(data)
    safe_csv_backup_to_telegram()
    send_data_json_to_telegram()
    send_backup_to_channel()
    return rec

def update_record_in_chat(chat_id: int, rid: int, new_amount: int, new_note: str, user=None):
    store = get_chat_store(chat_id)
    found = None
    for r in store.get("records", []):
        if r["id"] == rid:
            r["amount"] = new_amount
            r["note"] = new_note
            found = r
            break
    if found:
        for day_recs in store.get("daily_records", {}).values():
            for r in day_recs:
                if r["id"] == rid:
                    r.update(found)
        store["balance"] = sum(x["amount"] for x in store.get("records", []))
        data["records"] = [x if x["id"] != rid else found for x in data.get("records", [])]
        data["overall_balance"] = sum(x["amount"] for x in data.get("records", []))

        save_data(data)
        safe_csv_backup_to_telegram()
        send_data_json_to_telegram()
        send_backup_to_channel()
        return True, found
    return False, None

def delete_record_in_chat(chat_id: int, rid: int, user=None):
    store = get_chat_store(chat_id)
    removed = None
    for r in list(store.get("records", [])):
        if r["id"] == rid:
            removed = r
            store["records"].remove(r)
            break
    if removed:
        for dk, recs in store.get("daily_records", {}).items():
            store["daily_records"][dk] = [x for x in recs if x["id"] != rid]
        store["balance"] = sum(x["amount"] for x in store.get("records", []))
        data["records"] = [x for x in data.get("records", []) if x["id"] != rid]
        data["overall_balance"] = sum(x["amount"] for x in data.get("records", []))

        save_data(data)
        safe_csv_backup_to_telegram()
        send_data_json_to_telegram()
        return True, removed
    return False, None

# -----------------------------
# üî¢ –ü–∞—Ä—Å–µ—Ä —Å—É–º–º
# -----------------------------
num_re = re.compile(r'(\^[+-]\^[0-9]+|\^[+-]?[0-9]+\^|[+-]?\s*\d+)')
def parse_amount_token(token: str) -> int:
    t = token.strip()
    for ch in ["^", " ", ".", ",", "-", "_", "'", '"']:
        t = t.replace(ch, "")
    if not t: return 0
    if t[0] == "+": return int(t[1:])
    if t[0] == "-": return -int(t[1:])
    return -int(t)

# -----------------------------
# üß≤ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback
# -----------------------------
@bot.callback_query_handler(func=lambda c: True)
def handle_callback(call):
    try:
        chat_id = call.message.chat.id
    except Exception:
        return

    data_str = call.data or ""
    if not data_str.startswith("d:"):
        update_or_send_day_window(chat_id, today_key())
        bot.answer_callback_query(call.id); return

    parts = data_str.split(":")
    if len(parts) < 3:
        bot.answer_callback_query(call.id); return

    day_key = parts[1]
    action_tail = parts[2:]
    action = action_tail[0] if action_tail else ""
    store = get_chat_store(chat_id)
    prev_day = get_current_view_day(chat_id)
    set_current_view_day(chat_id, day_key)

    if action == "calopen":
        update_or_send_day_window(
            chat_id, day_key, create_if_missing=True, force_new=True,
            delete_target_old=True, delete_source_old=True, source_day_key=prev_day
        )
        bot.answer_callback_query(call.id, f"–û—Ç–∫—Ä—ã—Ç –¥–µ–Ω—å {day_key}")
        return

    if action == "open":
        update_or_send_day_window(
            chat_id, day_key, create_if_missing=True, force_new=True,
            delete_target_old=True, delete_source_old=False, source_day_key=prev_day
        )
        bot.answer_callback_query(call.id, f"–û—Ç–∫—Ä—ã—Ç –¥–µ–Ω—å {day_key}")
        return

    if action == "pick_date":
        kb = build_last_31days_calendar()
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text("üóì –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 31 –¥–µ–Ω—å):", chat_id, active_id, reply_markup=kb)
            except telebot.apihelper.ApiException as e:
                log_error(f"calendar edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id); return

    if action == "edit_menu":
        text = (
            "‚úèÔ∏è –ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n\n"
            "üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é\n"
            "üìÇ –û–±—â–∏–π CSV ‚Äî –ø–æ–ª–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç\n"
            "üìÖ CSV –∑–∞ –¥–µ–Ω—å ‚Äî —ç–∫—Å–ø–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã\n"
            "üì® –§–æ—Ä–≤–∞—Ä–¥ ‚Äî –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –ø–µ—Ä–µ—Å—ã–ª–∫—É\n"
            "üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å ‚Äî –∑–∞–¥–∞—Ç—å ID –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏\n"
            "‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞\n\n"
            "üìÖ –°–µ–≥–æ–¥–Ω—è / üìÜ –í—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å / ‚ÑπÔ∏è –ò–Ω—Ñ–æ / üîô –ù–∞–∑–∞–¥"
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"edit_menu edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key, create_if_missing=True)
        bot.answer_callback_query(call.id, "–ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚úèÔ∏è"); return

    if action == "refresh":
        active_id = get_active_window_id(chat_id, day_key)
        text = render_day_text(store, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"refresh edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key, create_if_missing=True)
        bot.answer_callback_query(call.id, "–û–±–Ω–æ–≤–ª–µ–Ω–æ üîÑ"); return

    if action == "info":
        info_text = (
            f"‚ÑπÔ∏è –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è {VERSION}\n\n"
            "üìå –ö–æ–º–∞–Ω–¥—ã:\n"
            "/start ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –∑–∞ —Å–µ–≥–æ–¥–Ω—è\n"
            "/view YYYY-MM-DD ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –¥–µ–Ω—å\n"
            "/prev /next ‚Äî –Ω–∞–≤–∏–≥–∞—Ü–∏—è\n"
            "/balance ‚Äî –æ—Å—Ç–∞—Ç–æ–∫ –∑–∞ –¥–µ–Ω—å\n"
            "/report ‚Äî —Å–ø–∏—Å–æ–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤\n"
            "/csv ‚Äî –æ–±—â–∏–π CSV\n"
            "/reset ‚Äî –æ–±–Ω—É–ª–µ–Ω–∏–µ —á–∞—Ç–∞\n"
            "/ping ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\n"
            "/json ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π data.json\n"
            "/file_id ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å file_id data.json\n"
            "/file_id_all ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ file_id\n"
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(info_text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"info edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id); return

    if action == "balance":
        day_records = store.get("daily_records", {}).get(day_key, [])
        income = sum(r["amount"] for r in day_records if r["amount"] > 0)
        expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
        overall = store.get("balance", 0)
        text = (
            f"üìÖ {day_key}\n\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(abs(expense))} ARS\n"
            f"üí∞ –û—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall)} ARS"
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try: bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e: log_error(f"balance edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, "–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—ë–Ω ‚úÖ"); return

    if action == "total":
        all_records = data.get("records", [])
        total = data.get("overall_balance", 0)
        total_income = sum(r["amount"] for r in all_records if r["amount"] > 0)
        total_expense = sum(r["amount"] for r in all_records if r["amount"] < 0)
        text = (
            f"üìä –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è:\n\n"
            f"üíµ –û–±—â–∏–π –ø—Ä–∏—Ö–æ–¥: {fmt_num(total_income)} ARS\n"
            f"üí∏ –û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥: {fmt_num(abs(total_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(total)} ARS"
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try: bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e: log_error(f"total edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, "–û–±—â–∏–π –∏—Ç–æ–≥ üìä"); return

    if action == "report":
        day_records = store.get("daily_records", {}).get(day_key, [])
        expenses = [r for r in day_records if r["amount"] < 0]
        if not expenses:
            text = f"üìÖ {day_key}\n–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å.\nüí∏ –†–∞—Å—Ö–æ–¥: 0 ARS"
        else:
            lines = [f"üìÖ {day_key}", "üìã –†–∞—Å—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å:"]
            for r in expenses[-30:]:
                lines.append(f"{r['short_id']}: -{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
            lines.append(f"\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(sum(abs(r['amount']) for r in expenses))} ARS")
            text = "\n".join(lines)
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try: bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e: log_error(f"report edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, "–û—Ç—á—ë—Ç –æ–±–Ω–æ–≤–ª—ë–Ω üìä"); return

    if action == "csv_all":
        try:
            export_to_csv(data)
            with open(CSV_FILE, "rb") as f:
                sent = bot.send_document(chat_id, f, caption="üìÇ –ü–æ–ª–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç: data.csv")
            if OWNER_ID and chat_id == int(OWNER_ID):
                meta = {"message_id": sent.message_id, "timestamp": datetime.now(TZ).isoformat(timespec="seconds")}
                _save_csv_meta(meta)
                log_info("‚úÖ –ù–æ–≤—ã–π CSV –Ω–∞–∑–Ω–∞—á–µ–Ω –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π Telegram-–±—ç–∫–∞–ø.")
            bot.answer_callback_query(call.id, "CSV –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω üìÅ")
        except Exception as e:
            send_temp_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ CSV: {e}")
            bot.answer_callback_query(call.id)
        return

    if action == "csv_day":
        filename = f"data_{day_key}.csv"
        day_records = store.get("daily_records", {}).get(day_key, [])
        try:
            with open(filename, "w", newline="", encoding="utf-8") as f:
                w = csv.writer(f)
                w.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
                for r in day_records:
                    w.writerow([chat_id, r.get("id"), r.get("short_id"), r.get("timestamp"),
                                r.get("amount"), r.get("note"), r.get("owner"), day_key])
            with open(filename, "rb") as f:
                bot.send_document(chat_id, f, caption=f"üìÖ CSV –∑–∞ –¥–µ–Ω—å: {filename}")
            bot.answer_callback_query(call.id, f"CSV –∑–∞ –¥–µ–Ω—å {day_key} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")
        except Exception as e:
            send_temp_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ {filename}: {e}")
            bot.answer_callback_query(call.id)
        return

    if action == "toggle_forward":
        store["forward_enabled"] = not store.get("forward_enabled", False)
        save_data(data)
        update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, f"–ü–µ—Ä–µ—Å—ã–ª–∫–∞ {'–≤–∫–ª—é—á–µ–Ω–∞ ‚úÖ' if store['forward_enabled'] else '–≤—ã–∫–ª—é—á–µ–Ω–∞ ‚ùå'}")
        return

    if action == "set_forward_target":
        try:
            bot.answer_callback_query(call.id)
            sent = send_temp_message(chat_id, "–í–≤–µ–¥–∏—Ç–µ ID (–º–æ–∂–Ω–æ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –¥–ª—è —á–∞—Ç–æ–≤) –∏–ª–∏ 0 –¥–ª—è —Å–±—Ä–æ—Å–∞:", delay=25)
            if sent:
                bot.register_next_step_handler(sent, lambda m: process_forward_target(m, day_key))
        except Exception as e:
            log_error(f"set_forward_target: {e}")
            bot.answer_callback_query(call.id, "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—Ä–æ—Å–∏—Ç—å ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è.")
        return

    if action == "reset":
        update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, "–î–ª—è –æ–±–Ω—É–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /reset")
        return

    if action in ("back_main", "edit_back", "noop", "info_ok"):
        update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id)
        return

    if action == "edit_list":
        day_records = store.get("daily_records", {}).get(day_key, [])
        if not day_records:
            text = f"üìÖ {day_key}\n–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å."
            active_id = get_active_window_id(chat_id, day_key)
            if active_id:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))
            bot.answer_callback_query(call.id, "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
            return
        lines = [f"üìÖ {day_key}", "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"]
        kb = types.InlineKeyboardMarkup(row_width=1)
        for r in reversed(day_records[-20:]):
            sign = "+" if r["amount"] > 0 else "-"
            label = f"{r['short_id']}: {sign}{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}"
            kb.add(types.InlineKeyboardButton(label, callback_data=f"d:{day_key}:rec:{r['id']}"))
        kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:back_main"))
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try: bot.edit_message_text("\n".join(lines), chat_id, active_id, reply_markup=kb)
            except telebot.apihelper.ApiException as e: log_error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —Å–ø–∏—Å–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
        bot.answer_callback_query(call.id); return

    if action == "rec" and len(action_tail) >= 2:
        try: rid = int(action_tail[1])
        except: bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID"); return
        day_records = store.get("daily_records", {}).get(day_key, [])
        rec = next((r for r in day_records if r["id"] == rid), None)
        if not rec:
            bot.answer_callback_query(call.id, "–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"); return
        sign = "+" if rec["amount"] > 0 else "-"
        text = f"–ó–∞–ø–∏—Å—å {rec['short_id']}\n{sign}{fmt_num(abs(rec['amount']))} ‚Äî {rec.get('note','')}\n–î–æ–±–∞–≤–ª–µ–Ω–∞: {rec.get('timestamp')}"
        kb = build_edit_keyboard_for_record(day_key, rid)
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try: bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            except telebot.apihelper.ApiException as e: log_error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –¥–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏: {e}")
        bot.answer_callback_query(call.id); return

    if action == "edit_manual" and len(action_tail) >= 2:
        try: rid = int(action_tail[1])
        except: bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID"); return
        store["edit_wait"] = f"change_value:{day_key}"
        store["edit_target"] = rid
        save_data(data)
        text = (
            f"‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ R{rid}\n\n"
            "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—É–º–º—É –∏ –∑–∞–º–µ—Ç–∫—É:\n"
            "+500 –ó–∞—Ä–ø–ª–∞—Ç–∞  –∏–ª–∏  ^+^500^ –ó–∞—Ä–ø–ª–∞—Ç–∞  –∏–ª–∏  ^-^150^ –û–±–µ–¥"
        )
        kb = types.InlineKeyboardMarkup(row_width=1)
        kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:edit_list"))
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try: bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            except telebot.apihelper.ApiException as e: log_error(f"edit_manual edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key, create_if_missing=True)
        bot.answer_callback_query(call.id, "–û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—É–º–º—ã ‚úèÔ∏è"); return

    if action == "edit_delete" and len(action_tail) >= 2:
        try: rid = int(action_tail[1])
        except: bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID"); return
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(
                    f"‚ùó –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ R{rid}:",
                    chat_id, active_id, reply_markup=build_confirm_delete_keyboard(day_key, rid)
                )
            except telebot.apihelper.ApiException as e:
                log_error(f"edit_delete confirm edit: {e}")
        bot.answer_callback_query(call.id); return

    if action == "confirm_delete" and len(action_tail) >= 2:
        try: rid = int(action_tail[1])
        except: bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID"); return
        success, _ = delete_record_in_chat(chat_id, rid, user=call.from_user)
        text = "‚úÖ –ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞" if success else "‚ö†Ô∏è –ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))
        bot.answer_callback_query(call.id, "–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞" if success else "–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"); return

    if action == "cancel_delete":
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            bot.edit_message_text("‚úèÔ∏è –ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è", chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))
        bot.answer_callback_query(call.id, "–û—Ç–º–µ–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è"); return

    if action == "confirm_reset_all":
        try:
            cid = str(chat_id)
            if cid in data.get("chats", {}):
                data["chats"].pop(cid, None)
            data["records"] = [r for r in data.get("records", []) if str(r.get("owner")) != cid]
            data["overall_balance"] = sum(x["amount"] for x in data.get("records", []))
            save_data(data)
            text = "‚öôÔ∏è –í—Å–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω—ã."
            active_id = get_active_window_id(chat_id, day_key)
            if active_id:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(today_key(), chat_id))
            else:
                bot.send_message(chat_id, text)
            bot.answer_callback_query(call.id, "–î–∞–Ω–Ω—ã–µ –æ–±–Ω—É–ª–µ–Ω—ã ‚úÖ")
        except Exception as e:
            log_error(f"confirm_reset_all: {e}")
            send_temp_message(chat_id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω—É–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.")
            bot.answer_callback_query(call.id, "–û—à–∏–±–∫–∞ –æ–±–Ω—É–ª–µ–Ω–∏—è")
        return

    bot.answer_callback_query(call.id)

# -----------------------------
# üë§ –†—É—á–Ω–æ–π –≤–≤–æ–¥ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏
# -----------------------------
def process_forward_target(message, day_key_for_refresh=None):
    try:
        chat_id = message.chat.id
        store = get_chat_store(chat_id)
        text = (message.text or "").strip()
        if text == "0":
            store["forward_target_id"] = None
            save_data(data)
            send_temp_message(chat_id, "‚úÖ –ü–æ–ª—É—á–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Å—ã–ª–∫–∏ —Å–±—Ä–æ—à–µ–Ω (–±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è OWNER_ID, –µ—Å–ª–∏ –æ–Ω –∑–∞–¥–∞–Ω).")
            update_or_send_day_window(chat_id, day_key_for_refresh or today_key())
            return
        if not (text.startswith("-") or text.isdigit()):
            send_temp_message(chat_id, "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID. –ü—Ä–∏–º–µ—Ä: -1001234567890\n–í–≤–µ–¥–∏—Ç–µ —Å–Ω–æ–≤–∞ –∏–ª–∏ 0 –¥–ª—è —Å–±—Ä–æ—Å–∞.")
            return
        target = int(text)
        store["forward_target_id"] = target
        save_data(data)
        send_temp_message(chat_id, f"‚úÖ –ü–µ—Ä–µ—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –∏–¥—Ç–∏ ID {target}.")
        update_or_send_day_window(chat_id, day_key_for_refresh or today_key())
    except Exception as e:
        log_error(f"process_forward_target: {e}")
        try: send_temp_message(message.chat.id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.")
        except: pass

# -----------------------------
# üß∞ –ö–æ–º–∞–Ω–¥—ã
# -----------------------------
@bot.message_handler(commands=["start","info"])
def cmd_start(msg):
    chat_id = msg.chat.id
    update_or_send_day_window(chat_id, today_key(), create_if_missing=True, force_new=True, delete_target_old=True)

@bot.message_handler(commands=["help"])
def cmd_help(msg):
    chat_id = msg.chat.id
    send_temp_message(
        chat_id,
        "üìò –î–æ–±–∞–≤–ª—è–π—Ç–µ –∑–∞–ø–∏—Å–∏ —Ç–∞–∫: +500 –ó–∞—Ä–ø–ª–∞—Ç–∞ –∏–ª–∏ -150 –û–±–µ–¥.\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/start /view YYYY-MM-DD /prev /next /balance /report /csv /reset /ping /help /json /file_id /file_id_all",
        delay=15
    )

@bot.message_handler(commands=["ping"])
def cmd_ping(msg): send_temp_message(msg.chat.id, "PONG ‚Äî –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ")

@bot.message_handler(commands=["view"])
def cmd_view(msg):
    chat_id = msg.chat.id
    parts = (msg.text or "").split()
    if len(parts) < 2: send_temp_message(chat_id, "–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É: /view YYYY-MM-DD"); return
    d = parse_date_key(parts[1])
    if not d: send_temp_message(chat_id, "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ü—Ä–∏–º–µ—Ä: /view 2025-11-02"); return
    dk = d.strftime("%Y-%m-%d")
    prev_day = get_current_view_day(chat_id)
    update_or_send_day_window(chat_id, dk, create_if_missing=True, force_new=True, delete_target_old=True, source_day_key=prev_day)

@bot.message_handler(commands=["prev"])
def cmd_prev(msg):
    chat_id = msg.chat.id
    current = get_current_view_day(chat_id)
    prev_key = shift_date_key(current, -1)
    update_or_send_day_window(chat_id, prev_key, create_if_missing=True, force_new=True, delete_target_old=True, source_day_key=current)

@bot.message_handler(commands=["next"])
def cmd_next(msg):
    chat_id = msg.chat.id
    current = get_current_view_day(chat_id)
    next_key = shift_date_key(current, +1)
    update_or_send_day_window(chat_id, next_key, create_if_missing=True, force_new=True, delete_target_old=True, source_day_key=current)

@bot.message_handler(commands=["balance"])
def cmd_balance(msg):
    chat_id = msg.chat.id
    store = get_chat_store(chat_id); dk = today_key()
    day_records = store.get("daily_records", {}).get(dk, [])
    inc = sum(r["amount"] for r in day_records if r["amount"] > 0)
    exp = sum(r["amount"] for r in day_records if r["amount"] < 0)
    bal = store.get("balance", 0)
    bot.send_message(chat_id, f"üìÖ {dk}\n\nüí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(bal)} ARS\nüíµ –ü—Ä–∏—Ö–æ–¥: {fmt_num(inc)} ARS\nüí∏ –†–∞—Å—Ö–æ–¥: {fmt_num(abs(exp))} ARS")

@bot.message_handler(commands=["report"])
def cmd_report(msg):
    chat_id = msg.chat.id
    store = get_chat_store(chat_id); dk = today_key()
    day_records = store.get("daily_records", {}).get(dk, [])
    expenses = [r for r in day_records if r["amount"] < 0]
    if not expenses:
        bot.send_message(chat_id, f"üìÖ {dk}\n–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è.\nüí∏ –†–∞—Å—Ö–æ–¥: 0 ARS"); return
    lines = [f"üìÖ {dk}", "üìã –†–∞—Å—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å:"]
    for r in expenses[-30:]:
        lines.append(f"{r['short_id']}: -{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
    lines.append(f"\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(sum(abs(r['amount']) for r in expenses))} ARS")
    bot.send_message(chat_id, "\n".join(lines))

@bot.message_handler(commands=["reset"])
def cmd_reset(msg):
    chat_id = msg.chat.id; dk = today_key()
    active_id = get_active_window_id(chat_id, dk)
    if active_id:
        try:
            bot.edit_message_text(
                "‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞?",
                chat_id, active_id, reply_markup=build_reset_confirm_keyboard(dk)
            )
        except Exception as e:
            log_error(f"/reset edit_message_text: {e}")
    else:
        bot.send_message(
            chat_id, "‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞?",
            reply_markup=build_reset_confirm_keyboard(dk)
        )

@bot.message_handler(commands=["csv"])
def cmd_csv(msg):
    if OWNER_ID and str(msg.chat.id) == str(OWNER_ID):
        bot.send_message(msg.chat.id, "üìä –û—Ç–ø—Ä–∞–≤–ª—è—é –∞–∫—Ç—É–∞–ª—å–Ω—ã–π CSV...")
        safe_csv_backup_to_telegram()

@bot.message_handler(commands=["json"])
def cmd_json(msg):
    if OWNER_ID and str(msg.chat.id) == str(OWNER_ID):
        bot.send_message(msg.chat.id, "üßæ –û—Ç–ø—Ä–∞–≤–ª—è—é –∞–∫—Ç—É–∞–ª—å–Ω—ã–π data.json...")
        send_data_json_to_telegram()
        send_backup_to_channel()

@bot.message_handler(commands=["file_id"])
def cmd_file_id(msg):
    meta = _load_csv_meta()
    fid = meta.get("file_id_datajson")
    if fid:
        bot.send_message(msg.chat.id, f"ü™Ñ –ê–∫—Ç—É–∞–ª—å–Ω—ã–π file_id –¥–ª—è data.json:\n<code>{html.escape(fid)}</code>", parse_mode="HTML")
    else:
        bot.send_message(msg.chat.id, "‚ö†Ô∏è file_id –¥–ª—è data.json –µ—â—ë –Ω–µ –Ω–∞–π–¥–µ–Ω (—Ñ–∞–π–ª –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª—Å—è).")

@bot.message_handler(commands=["file_id_all"])
def cmd_file_id_all(msg):
    try:
        meta = _load_csv_meta()
        fid_csv = meta.get("file_id_csv") or meta.get("message_id")
        fid_json = meta.get("file_id_datajson")
        fid_meta = meta.get("file_id_csvmeta") or meta.get("file_id_meta")
        lines = ["üì¶ *–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ file_id –±—ç–∫–∞–ø–æ–≤:*",
                 f"üìä CSV: `{fid_csv or '_–Ω–µ –Ω–∞–π–¥–µ–Ω_'}`",
                 f"üßæ data.json: `{fid_json or '_–Ω–µ –Ω–∞–π–¥–µ–Ω_'}`",
                 f"üß† csv_meta.json: `{fid_meta or '_–Ω–µ –Ω–∞–π–¥–µ–Ω_'}`"]
        bot.send_message(msg.chat.id, "\n".join(lines), parse_mode="Markdown")
    except Exception as e:
        log_error(f"/file_id_all error: {e}")
        bot.send_message(msg.chat.id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ file_id: {e}")

# -----------------------------
# üìÑ –ü—Ä–∏—ë–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –ø—Ä–∏—Å–ª–∞–Ω–Ω–æ–≥–æ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º data.json)
# -----------------------------
@bot.message_handler(content_types=["document"])
def handle_document(msg):
    try:
        doc = msg.document
        if not doc or not doc.file_name:
            return
        fname = doc.file_name.lower()
        owner_id = int(OWNER_ID) if OWNER_ID else None

        if fname == "data.json" and owner_id and msg.chat.id == owner_id:
            file_info = bot.get_file(doc.file_id)
            downloaded = bot.download_file(file_info.file_path)
            with open(DATA_FILE, "wb") as f:
                f.write(downloaded)
            restored = _load_json(DATA_FILE, {})
            if isinstance(restored, dict) and "records" in restored:
                globals()["data"] = restored
                send_temp_message(msg.chat.id, "‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!")
                export_to_csv(data)
                _schedule_csv_backup_debounced()
            else:
                send_temp_message(msg.chat.id, "‚ö†Ô∏è –§–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö.")
            return

        elif fname.endswith(".json") or fname.endswith(".csv"):
            file_info = bot.get_file(doc.file_id)
            downloaded = bot.download_file(file_info.file_path)
            text = downloaded.decode("utf-8", errors="ignore")
            parts = [text[i:i+3500] for i in range(0, len(text), 3500)]
            for chunk in parts:
                bot.send_message(msg.chat.id, f"```{chunk}```", parse_mode="Markdown")
            return
        else:
            bot.send_message(msg.chat.id, "üìÅ –§–∞–π–ª –ø–æ–ª—É—á–µ–Ω, –Ω–æ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.")
    except Exception as e:
        log_error(f"handle_document error: {e}")
        send_temp_message(msg.chat.id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: {e}")

# -----------------------------
# üì® –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
# -----------------------------
@bot.message_handler(func=lambda m: True)
def handle_message(msg):
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    wait_action = store.get("edit_wait")

    # —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä—É—á–Ω—É—é
    if wait_action and wait_action.startswith("change_value"):
        day_key = today_key()
        if ":" in wait_action: _, day_key = wait_action.split(":", 1)
        rid = store.get("edit_target")
        if not rid:
            store["edit_wait"] = None; store["edit_target"] = None; save_data(data); return

        parts = (msg.text or "").strip().split(" ", 1)
        try:
            amount_token = parts[0]
            amount = parse_amount_token(amount_token)
            note = parts[1] if len(parts) > 1 else ""
            success, _ = update_record_in_chat(chat_id, rid, amount, note, user=msg.from_user)
            store["edit_wait"] = None; store["edit_target"] = None; save_data(data)
            active_id = get_active_window_id(chat_id, day_key)
            text = render_day_text(store, day_key)
            if active_id:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            else:
                update_or_send_day_window(chat_id, day_key)
            send_temp_message(chat_id, f"‚úÖ –ó–∞–ø–∏—Å—å R{rid} {'–∏–∑–º–µ–Ω–µ–Ω–∞' if success else '–Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}")
        except Exception as e:
            log_error(f"edit manual: {e}")
            send_temp_message(chat_id, "‚ùå –§–æ—Ä–º–∞—Ç: +500 –ó–∞—Ä–ø–ª–∞—Ç–∞ –∏–ª–∏ -150 –û–±–µ–¥", delay=10)
        return

    if not msg.text:
        return

    # –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π (–º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π –≤–≤–æ–¥)
    lines = (msg.text or "").strip().split("\n")
    for line in lines:
        line = line.strip()
        if not line: continue
        m = re.search(num_re, line)
        if not m: continue
        try:
            raw = m.group(0)
            raw_clean = raw.replace("^", "").replace(" ", "")
            amount = parse_amount_token(raw_clean)
            note = line.replace(m.group(0), "").strip()
            add_record_to_chat(chat_id, amount, note, msg.from_user.id)
        except Exception as e:
            log_error(f"auto-add record: {e}")
            send_temp_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏: {line}")

    dk = today_key()
    active_id = get_active_window_id(chat_id, dk)
    if active_id:
        text = render_day_text(store, dk)
        bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(dk, chat_id))
    else:
        update_or_send_day_window(chat_id, dk)
    send_temp_message(chat_id, "‚úÖ –ó–∞–ø–∏—Å–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã")

#========================================
#üß© –ß–ê–°–¢–¨ 4 / 4
#(Webhook/Flask, –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∏, keep-alive, –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Äî –±–µ–∑ getUpdates-–ø–æ–∏—Å–∫–∞ –∏ –±–µ–∑ Google Drive)
# -----------------------------
# üåê Flask webhook
# -----------------------------
@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    try:
        update = telebot.types.Update.de_json(request.get_data().decode("utf-8"))
        bot.process_new_updates([update])
    except Exception as e:
        log_error(f"webhook error: {e}")
    return "OK", 200

@app.route("/", methods=["GET"])
def index():
    return f"–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è {VERSION} —Ä–∞–±–æ—Ç–∞–µ—Ç", 200

# -----------------------------
# üü¢ Keep-alive
# -----------------------------
def keep_alive_task():
    while True:
        try:
            log_info("Keep-alive: –ø–∏–Ω–≥ self –∏, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –≤–ª–∞–¥–µ–ª—å—Ü–∞.")
            if APP_URL:
                try:
                    resp = requests.get(APP_URL, timeout=10)
                    log_info(f"Keep-alive {APP_URL} -> {getattr(resp, 'status_code', '?')}")
                except Exception as e:
                    log_error(f"Keep-alive self-ping error: {e}")
            if KEEP_ALIVE_SEND_TO_OWNER and OWNER_ID:
                try:
                    bot.send_message(int(OWNER_ID), f"üü¢ Keep-alive: –±–æ—Ç {VERSION} –∞–∫—Ç–∏–≤–µ–Ω.\n{now_local().isoformat(timespec='seconds')}")
                except Exception as e:
                    log_error(f"Keep-alive notify owner: {e}")
        except Exception as e:
            log_error(f"Keep-alive loop: {e}")
        time.sleep(max(10, KEEP_ALIVE_INTERVAL_SECONDS))

def start_keep_alive_thread():
    threading.Thread(target=keep_alive_task, daemon=True).start()

# -----------------------------
# üóì –ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞ –Ω–æ–≤–æ–≥–æ –¥–Ω—è
# -----------------------------
def schedule_daily_window_creation():
    def task():
        last_day = today_key()
        while True:
            try:
                time.sleep(60)
                current_day = today_key()
                if current_day != last_day:
                    for chat_id_str in list(data.get("chats", {}).keys()):
                        try: chat_id = int(chat_id_str)
                        except: continue
                        try:
                            update_or_send_day_window(
                                chat_id, current_day,
                                create_if_missing=True, force_new=True,
                                delete_target_old=True, delete_source_old=False
                            )
                        except Exception as e:
                            log_error(f"daily new window {chat_id}: {e}")
                    last_day = current_day
            except Exception as e:
                log_error(f"daily loop: {e}"); time.sleep(5)
    threading.Thread(target=task, daemon=True).start()

# -----------------------------
# ü™ù Webhook
# -----------------------------
def set_webhook():
    url = f"{APP_URL}/{TOKEN}"
    try:
        bot.remove_webhook()
        time.sleep(0.5)
        bot.set_webhook(url=url)
        log_info(f"Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {url}")
    except Exception as e:
        log_error(f"set_webhook: {e}")

# -----------------------------
# üöÄ –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
# -----------------------------
if __name__ == "__main__":
    try:
        # üîÑ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –∫–∞–Ω–∞–ª–∞ —á–µ—Ä–µ–∑ Telethon
        with tele_client:
            tele_client.loop.run_until_complete(restore_files_via_telethon())
            tele_client.loop.run_until_complete(restore_data_json_via_telethon())
    except Exception as e:
        log_error(f"startup telethon restore: {e}")

    # ü™ù Webhook
    set_webhook()

    # –ü–ª–∞–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
    schedule_daily_window_creation()
    start_keep_alive_thread()

    try:
        if OWNER_ID:
            bot.send_message(int(OWNER_ID), f"‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! (–≤–µ—Ä—Å–∏—è {VERSION})")
    except Exception as e:
        log_error(f"send startup msg: {e}")

    # Flask
    app.run(host="0.0.0.0", port=PORT)