# ============================================
# Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð±Ð¾Ñ‚ â€” Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ
# ============================================

import os, json, csv, logging, threading, time, re
from datetime import datetime
from zoneinfo import ZoneInfo
import telebot
from flask import Flask, request
from telebot import types

# -----------------------------
# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
# -----------------------------
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = int(os.getenv("OWNER_ID", 0))
APP_URL = os.getenv("APP_URL", "https://fo-1.onrender.com")
TZ = ZoneInfo("America/Argentina/Catamarca")
DATA_FILE = "data.json"
CSV_FILE = "data.csv"
LOG_FILE = "log.txt"
PORT = int(os.environ.get("PORT", 5000))
VERSION = "9.6.1.7"

if not TOKEN:
    raise ValueError("BOT_TOKEN Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½!")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# -----------------------------
# Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
# -----------------------------
logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[logging.FileHandler(LOG_FILE, encoding="utf-8"), logging.StreamHandler()]
)
def log_info(msg): logging.info(msg)
def log_error(msg): logging.error(msg)
log_info(f"Ð¡Ñ‚Ð°Ñ€Ñ‚ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ. Ð’ÐµÑ€ÑÐ¸Ñ {VERSION}")

# -----------------------------
# Ð”Ð°Ð½Ð½Ñ‹Ðµ
# -----------------------------
def default_data():
    return {"overall_balance":0,"records":[],"chats":{},"active_messages":{},"next_id":1}

def load_data():
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE,"r",encoding="utf-8") as f:
                d=json.load(f)
        except Exception as e:
            log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ data.json: {e}")
            d=default_data()
    else:
        d=default_data()
    base=default_data()
    for k,v in base.items():
        if k not in d:
            d[k]=v
    return d

def save_data(d):
    try:
        with open(DATA_FILE,"w",encoding="utf-8") as f:
            json.dump(d,f,ensure_ascii=False,indent=2)
    except Exception as e:
        log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ data.json: {e}")

data = load_data()

# -----------------------------
# Ð§Ð°Ñ‚ / Ð´ÐµÐ½ÑŒ
# -----------------------------
def get_today_key(): return datetime.now(TZ).strftime("%Y-%m-%d")
def get_chat_store(chat_id):
    cid=str(chat_id)
    if cid not in data["chats"]:
        data["chats"][cid]={"balance":0,"records":[],"next_id":1,"daily_records":{},"active_windows":{},"edit_wait":None,"edit_target":None,"forward_target":None}
        save_data(data)
    return data["chats"][cid]

def get_today_active_window(chat_id):
    today=get_today_key()
    return data.get("active_messages",{}).get(today,{}).get(str(chat_id))

def set_today_active_window(chat_id,message_id):
    today=get_today_key()
    if "active_messages" not in data: data["active_messages"]={}
    if today not in data["active_messages"]: data["active_messages"][today]={}
    data["active_messages"][today][str(chat_id)]=message_id
    save_data(data)

# -----------------------------
# Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ Ð·Ð°Ð¿Ð¸ÑÑÐ¼Ð¸
# -----------------------------
def add_record_to_chat(chat_id,amount,note,owner):
    store=get_chat_store(chat_id)
    rid=data.get("next_id",1)
    rec={"id":rid,"short_id":f"R{rid}","timestamp":datetime.now(TZ).isoformat(timespec="seconds"),"amount":amount,"note":note,"owner":owner}
    data.setdefault("records",[]).append(rec)
    store.setdefault("records",[]).append(rec)
    day=get_today_key()
    store.setdefault("daily_records",{}).setdefault(day,[]).append(rec)
    store["balance"]=store.get("balance",0)+amount
    data["overall_balance"]=data.get("overall_balance",0)+amount
    data["next_id"]=rid+1
    save_data(data)
    try: export_to_csv(data)
    except: pass
    return rec

def update_record_in_chat(chat_id,rid,new_amount,new_note):
    store=get_chat_store(chat_id)
    found=None
    for r in store.get("records",[]):
        if r["id"]==rid:
            diff=new_amount-r["amount"]
            r["amount"]=new_amount
            r["note"]=new_note
            found=r
            break
    if found:
        for day_recs in store.get("daily_records",{}).values():
            for r in day_recs:
                if r["id"]==rid:
                    r.update(found)
        store["balance"]=sum([x["amount"] for x in store.get("records",[])])
        data["overall_balance"]=sum([x["amount"] for x in data.get("records",[])])
        save_data(data)
        export_to_csv(data)
        return True,found
    return False,None

def delete_record_in_chat(chat_id,rid):
    store=get_chat_store(chat_id)
    removed=None
    for r in list(store.get("records",[])):
        if r["id"]==rid or str(r["id"])==str(rid) or r.get("short_id")==f"R{rid}":
            removed=r
            store["records"].remove(r)
            break
    if removed:
        for day_key,recs in store.get("daily_records",{}).items():
            store["daily_records"][day_key]=[x for x in recs if x["id"]!=rid]
        store["balance"]=sum([x["amount"] for x in store.get("records",[])])
        data["records"]=[x for x in data.get("records",[]) if x["id"]!=rid]
        data["overall_balance"]=sum([x["amount"] for x in data.get("records",[])])
        save_data(data)
        export_to_csv(data)
        return True,removed
    return False,None

def export_to_csv(d):
    try:
        with open(CSV_FILE,"w",newline='',encoding="utf-8") as f:
            writer=csv.writer(f)
            writer.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
            for cid,cdata in d.get("chats",{}).items():
                for day_key,records in cdata.get("daily_records",{}).items():
                    for r in records:
                        writer.writerow([cid,r.get("id"),r.get("short_id"),r.get("timestamp"),r.get("amount"),r.get("note"),r.get("owner"),day_key])
    except Exception as e: log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð° CSV: {e}")

# -----------------------------
# ÐšÐ»Ð°Ð²Ð¸Ð°Ñ‚ÑƒÑ€Ð°
# -----------------------------
def build_main_keyboard(chat_id=None, confirm_reset=False):
    kb = types.InlineKeyboardMarkup(row_width=3)
    kb.row(
        types.InlineKeyboardButton("ðŸ’° Ð‘Ð°Ð»Ð°Ð½Ñ", callback_data="btn_balance"),
        types.InlineKeyboardButton("ðŸ“Š ÐžÑ‚Ñ‡Ñ‘Ñ‚", callback_data="btn_report"),
        types.InlineKeyboardButton("âœï¸ Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ", callback_data="btn_edit")
    )
    if confirm_reset:
        kb.row(
            types.InlineKeyboardButton("âœ… Ð”Ð°", callback_data="confirm_reset"),
            types.InlineKeyboardButton("âŒ ÐÐµÑ‚", callback_data="cancel_reset")
        )
    else:
        kb.row(
            types.InlineKeyboardButton("âš™ï¸ ÐžÐ±Ð½ÑƒÐ»Ð¸Ñ‚ÑŒ", callback_data="btn_reset"),
            types.InlineKeyboardButton("ðŸ“¤ CSV", callback_data="export_csv"),
            types.InlineKeyboardButton("ðŸ“¤ ÐŸÐµÑ€ÐµÑÐ»Ð°Ñ‚ÑŒ", callback_data="btn_forward")
        )
    kb.row(
        types.InlineKeyboardButton("ðŸš€", callback_data="btn_start"),
        types.InlineKeyboardButton("â„¹ï¸", callback_data="btn_cod")
    )
    balance_text = ""
    if chat_id is not None:
        store = get_chat_store(chat_id)
        balance_text = f"ðŸ’° {store.get('balance',0)} ARS"
    kb.add(types.InlineKeyboardButton(balance_text or "ðŸ’° 0 ARS", callback_data="noop"))
    return kb

# -----------------------------
# ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ðµ Ð¾ÐºÐ½Ð¾
# -----------------------------
def update_or_send_today_window(chat_id, extra_text=None):
    today_key = get_today_key()
    store = get_chat_store(chat_id)
    day_records = store.get("daily_records", {}).get(today_key, [])

    if not day_records:
        text = f"ðŸ“… {today_key}\nÐŸÐ¾ÐºÐ° Ð½ÐµÑ‚ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹.\nðŸ’° Ð‘Ð°Ð»Ð°Ð½Ñ: {store.get('balance',0)} ARS"
    else:
        lines = [f"ðŸ“… {today_key}", "ðŸ“‹ ÐžÐ¿ÐµÑ€Ð°Ñ†Ð¸Ð¸:"]
        for r in day_records[-50:]:
            sign = "+" if r["amount"] > 0 else ""
            lines.append(f"{r['short_id']}: {sign}{r['amount']} â€” {r.get('note','')}")
        lines.append(f"\nðŸ’° Ð‘Ð°Ð»Ð°Ð½Ñ: {store.get('balance',0)} ARS")
        text = "\n".join(lines)

    if extra_text:
        text = f"{extra_text}\n\n{text}"

    kb = build_main_keyboard(chat_id)
    today_msgs = data.setdefault("active_messages", {}).setdefault(today_key, {})
    active_id = today_msgs.get(str(chat_id))

    if active_id:
        try:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
        except Exception as e:
            if "message is not modified" not in str(e):
                log_error(f"[update_or_send_today_window] Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ: {e}")
        return

    try:
        sent = bot.send_message(chat_id, text, reply_markup=kb)
        set_today_active_window(chat_id, sent.message_id)
        log_info(f"[update_or_send_today_window] Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾ Ð½Ð¾Ð²Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð´Ð»Ñ Ñ‡Ð°Ñ‚Ð° {chat_id}, message_id={sent.message_id}")
    except Exception as e:
        log_error(f"[update_or_send_today_window] ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¾ÐºÐ½Ð¾ Ð´Ð»Ñ chat {chat_id}: {e}")

# -----------------------------
# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
# -----------------------------
@bot.message_handler(func=lambda m: True)
def handle_message(msg):
    chat_id = msg.chat.id
    text = msg.text
    store = get_chat_store(chat_id)

    # --- ÐŸÐµÑ€ÐµÑÑ‹Ð»ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†ÐµÐ¼ ---
    if chat_id == OWNER_ID and msg.chat.type == "private":
        target_chat_id = store.get("forward_target")
        if target_chat_id:
            try:
                bot.send_message(target_chat_id, text)
            except:
                update_or_send_today_window(chat_id, extra_text="âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿ÐµÑ€ÐµÑÐ»Ð°Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ")
            store["forward_target"] = None
        update_or_send_today_window(chat_id)
        return

    # --- Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚ Ð´Ñ€ÑƒÐ³Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ, Ð¿ÐµÑ€ÐµÑÑ‹Ð»ÐºÐ° Ð² Ð»Ð¸Ñ‡ÐºÑƒ Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†Ð° ---
    if chat_id != OWNER_ID and OWNER_ID:
        try:
            bot.send_message(OWNER_ID, f"Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚ {msg.from_user.first_name} ({chat_id}):\n{text}")
        except:
            log_error(f"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿ÐµÑ€ÐµÑÐ»Ð°Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð² Ð»Ð¸Ñ‡ÐºÑƒ Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†Ð°: {chat_id}")

    # --- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ---
    wait_action = store.get("edit_wait")

    if wait_action is None:
        # ÐÐ²Ñ‚Ð¾-Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð¸Ð· Ð²ÑÐµÑ… ÑÑ‚Ñ€Ð¾Ðº
        lines = text.splitlines()
        any_added = False
        for line in lines:
            clean_line = line.replace(" ","").replace(".","").replace(",","").replace("â€™","").replace("â€˜","")
            if not clean_line: continue
            match = re.match(r"([+-]?\d+)", clean_line)
            if match:
                try:
                    amount = int(match.group(1))
                    note = line[match.end():].strip()
                    add_record_to_chat(chat_id, amount, note, msg.from_user.id)
                    any_added = True
                except:
                    continue
        if any_added:
            update_or_send_today_window(chat_id, extra_text="âœ… Ð—Ð°Ð¿Ð¸ÑÐ¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ñ‹")
        else:
            update_or_send_today_window(chat_id)
        return

    # Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ
    if wait_action == "change_id":
        try:
            rid = int(text.strip())
            store["edit_wait"] = "change_value"
            store["edit_target"] = rid
            update_or_send_today_window(chat_id, extra_text=f"Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð²ÑƒÑŽ ÑÑƒÐ¼Ð¼Ñƒ Ð¸ Ð·Ð°Ð¼ÐµÑ‚ÐºÑƒ Ð´Ð»Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸ {rid}")
        except:
            update_or_send_today_window(chat_id, extra_text="âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ ID. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.")
        return

    elif wait_action == "change_value":
        rid = store.get("edit_target")
        if not rid: store["edit_wait"] = None; return
        parts = text.strip().split(" ",1)
        try:
            amount = int(parts[0])
            note = parts[1] if len(parts)>1 else ""
            success,_ = update_record_in_chat(chat_id,rid,amount,note)
            if success:
                update_or_send_today_window(chat_id, extra_text=f"âœ… Ð—Ð°Ð¿Ð¸ÑÑŒ {rid} Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð°")
            else:
                update_or_send_today_window(chat_id, extra_text=f"âŒ Ð—Ð°Ð¿Ð¸ÑÑŒ {rid} Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°")
        except:
            update_or_send_today_window(chat_id, extra_text="âŒ ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ Ð²Ð²Ð¾Ð´. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.")
        store["edit_wait"] = None
        store["edit_target"] = None
        return

    elif wait_action == "delete_id":
        try:
            rid = int(text.strip())
            success,_ = delete_record_in_chat(chat_id,rid)
            if success:
                update_or_send_today_window(chat_id, extra_text=f"âœ… Ð—Ð°Ð¿Ð¸ÑÑŒ {rid} ÑƒÐ´Ð°Ð»ÐµÐ½Ð°")
            else:
                update_or_send_today_window(chat_id, extra_text=f"âŒ Ð—Ð°Ð¿Ð¸ÑÑŒ {rid} Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°")
        except:
            update_or_send_today_window(chat_id, extra_text="âŒ ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ ID. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.")
        store["edit_wait"] = None
        return

    # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° target Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÑÑ‹Ð»ÐºÐ¸
    if wait_action == "set_forward_target":
        try:
            target_chat_id = int(text.strip())
            store["forward_target"] = target_chat_id
            store["edit_wait"] = None
            update_or_send_today_window(chat_id, extra_text=f"âœ… Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¸Ð· Ð²Ð°ÑˆÐµÐ¹ Ð»Ð¸Ñ‡ÐºÐ¸ Ð±ÑƒÐ´ÑƒÑ‚ Ð¿ÐµÑ€ÐµÑÑ‹Ð»Ð°Ñ‚ÑŒÑÑ Ð² Ñ‡Ð°Ñ‚ {target_chat_id}")
        except:
            update_or_send_today_window(chat_id, extra_text="âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ ID Ñ‡Ð°Ñ‚Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.")
        return

    # ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ñ‚ÐµÐºÑÑ‚Ð° Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÑÑ‹Ð»ÐºÐ¸
    if wait_action == "forward_msg_text":
        target_chat_id = store.get("forward_target")
        if not target_chat_id: store["edit_wait"] = None; return
        try:
            bot.send_message(target_chat_id, text)
            update_or_send_today_window(chat_id, extra_text=f"âœ… Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿ÐµÑ€ÐµÑÐ»Ð°Ð½Ð¾ Ð² Ñ‡Ð°Ñ‚ {target_chat_id}")
        except:
            update_or_send_today_window(chat_id, extra_text="âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿ÐµÑ€ÐµÑÐ»Ð°Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ")
        store["edit_wait"] = None
        store["forward_target"] = None
        return

# -----------------------------
# ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /start
# -----------------------------
@bot.message_handler(commands=["start"])
def handle_start(msg):
    chat_id = msg.chat.id
    start_text = (
        "ðŸ‘‹ ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð­Ñ‚Ð¾ Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð±Ð¾Ñ‚ Â«Ð¤ÐžÂ».\n\n"
        "ðŸ’° Ð‘Ð°Ð»Ð°Ð½Ñ â€” Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð±Ð°Ð»Ð°Ð½ÑÐ°\n"
        "ðŸ“Š ÐžÑ‚Ñ‡Ñ‘Ñ‚ â€” Ð¿Ñ€Ð¸Ñ…Ð¾Ð´, Ñ€Ð°ÑÑ…Ð¾Ð´, Ð¸Ñ‚Ð¾Ð³ Ð´Ð½Ñ\n"
        "âœï¸ Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ â€” Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð»Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸\n"
        "âš™ï¸ ÐžÐ±Ð½ÑƒÐ»Ð¸Ñ‚ÑŒ â€” Ð¿Ð¾Ð»Ð½Ð¾Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð²ÑÐµÑ… Ð´Ð°Ð½Ð½Ñ‹Ñ… Ñ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸ÐµÐ¼\n"
        "ðŸ“¤ CSV â€” ÑÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð²ÑÐµÑ… Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð² CSV\n"
        "ðŸ“¤ ÐŸÐµÑ€ÐµÑÐ»Ð°Ñ‚ÑŒ â€” Ð¿ÐµÑ€ÐµÑÑ‹Ð»ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¼ÐµÐ¶Ð´Ñƒ Ñ‡Ð°Ñ‚Ð°Ð¼Ð¸\n"
        "ðŸš€ Ð¡Ñ‚Ð°Ñ€Ñ‚ â€” Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ðº Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¼Ñƒ Ð¾ÐºÐ½Ñƒ\n"
        "â„¹ï¸ â€” Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð±Ð¾Ñ‚Ð°\n\n"
        "ðŸ“Œ ÐŸÑ€Ð¾ÑÑ‚Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐ¹Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ñ Ñ‡Ð¸ÑÐ»Ð°Ð¼Ð¸ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑƒÑ‡Ñ‘Ñ‚Ð°.\n"
        "âž• Ð¸Ð»Ð¸ Ð±ÐµÐ· Ð·Ð½Ð°ÐºÐ° â€” Ð¿Ñ€Ð¸Ñ…Ð¾Ð´, âž– â€” Ñ€Ð°ÑÑ…Ð¾Ð´.\n"
        "ÐœÐ¾Ð¶Ð½Ð¾ Ð²Ð²Ð¾Ð´Ð¸Ñ‚ÑŒ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÑ‚Ñ€Ð¾Ðº ÑÑ€Ð°Ð·Ñƒ."
    )
    update_or_send_today_window(chat_id, extra_text=start_text)

# -----------------------------
# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ½Ð¾Ð¿Ð¾Ðº
# -----------------------------
@bot.callback_query_handler(func=lambda call: True)
def handle_buttons(call):
    chat_id = call.message.chat.id
    data_id = call.data
    store = get_chat_store(chat_id)

    if data_id == "btn_report":
        today_key = get_today_key()
        day_records = store.get("daily_records", {}).get(today_key, [])
        income = sum(r["amount"] for r in day_records if r["amount"] > 0)
        expense = abs(sum(r["amount"] for r in day_records if r["amount"] < 0))
        total = income - expense
        balance = store.get("balance", 0)
        text = (
            f"ðŸ“… {today_key}\nðŸ“Š ÐžÑ‚Ñ‡Ñ‘Ñ‚ Ð·Ð° Ð´ÐµÐ½ÑŒ:\n"
            f"âž• ÐŸÑ€Ð¸Ñ…Ð¾Ð´: {income} ARS\n"
            f"âž– Ð Ð°ÑÑ…Ð¾Ð´: {expense} ARS\n"
            f"ðŸŸ° Ð˜Ñ‚Ð¾Ð³ Ð´Ð½Ñ: {total} ARS\n\n"
            f"ðŸ’° Ð‘Ð°Ð»Ð°Ð½Ñ: {balance} ARS"
        )
        kb = build_main_keyboard(chat_id)
        bot.edit_message_text(text, chat_id, call.message.message_id, reply_markup=kb)
        return

    elif data_id in ["btn_start", "cancel_reset"]:
        update_or_send_today_window(chat_id)
        return

    elif data_id == "btn_edit":
        kb = types.InlineKeyboardMarkup(row_width=2)
        kb.add(
            types.InlineKeyboardButton("âœï¸", callback_data="edit_change"),
            types.InlineKeyboardButton("âŒ", callback_data="edit_delete"),
        )
        kb.add(types.InlineKeyboardButton("ðŸ”™", callback_data="btn_start"))
        update_or_send_today_window(chat_id, extra_text="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð´Ð»Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸:")
        bot.edit_message_reply_markup(chat_id, call.message.message_id, reply_markup=kb)
        return

    elif data_id == "edit_change":
        store["edit_wait"] = "change_id"
        update_or_send_today_window(chat_id, extra_text="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ID Ð·Ð°Ð¿Ð¸ÑÐ¸, ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ:")
        return

    elif data_id == "edit_delete":
        store["edit_wait"] = "delete_id"
        update_or_send_today_window(chat_id, extra_text="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ID Ð·Ð°Ð¿Ð¸ÑÐ¸, ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ:")
        return

    elif data_id == "btn_reset":
        kb = build_main_keyboard(chat_id, confirm_reset=True)
        bot.edit_message_text("âš ï¸ Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð’Ð¡Ð• Ð´Ð°Ð½Ð½Ñ‹Ðµ?", chat_id, call.message.message_id, reply_markup=kb)
        return

    elif data_id == "confirm_reset":
        global data
        data = default_data()
        save_data(data)
        update_or_send_today_window(chat_id, extra_text="âœ… Ð’ÑÐµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ð±Ð½ÑƒÐ»ÐµÐ½Ñ‹")
        return

    elif data_id == "export_csv":
        try:
            export_to_csv(data)
            with open(CSV_FILE, "rb") as f:
                bot.send_document(chat_id, f, caption="ðŸ“„ Ð’Ð°Ñˆ CSV-Ñ„Ð°Ð¹Ð»")
        except:
            update_or_send_today_window(chat_id, extra_text="âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ CSV.")
        return

    elif data_id == "btn_forward":
        store["edit_wait"] = "set_forward_target"
        update_or_send_today_window(chat_id, extra_text="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ID Ñ‡Ð°Ñ‚Ð°, ÐºÑƒÐ´Ð° Ð¿ÐµÑ€ÐµÑÑ‹Ð»Ð°Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¸Ð· Ð²Ð°ÑˆÐµÐ¹ Ð»Ð¸Ñ‡ÐºÐ¸:")
        return

    elif data_id in ["btn_cod","noop"]:
        bot.answer_callback_query(call.id)
        return

# -----------------------------
# Flask webhook
# -----------------------------
@app.route(f"/{TOKEN}",methods=["POST"])
def webhook():
    update=telebot.types.Update.de_json(request.get_data().decode("utf-8"))
    bot.process_new_updates([update])
    return "OK",200

@app.route("/",methods=["GET"])
def index():
    return f"Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð±Ð¾Ñ‚ Â«Ð¤ÐžÂ» â€” Ð²ÐµÑ€ÑÐ¸Ñ {VERSION} Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚",200

# -----------------------------
# Webhook Ð¸ Ð·Ð°Ð¿ÑƒÑÐº
# -----------------------------
def set_webhook():
    url=f"{APP_URL}/{TOKEN}"
    try:
        bot.remove_webhook()
        time.sleep(0.5)
        bot.set_webhook(url=url)
        log_info(f"Webhook ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½: {url}")
    except Exception as e:
        log_error(f"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ webhook: {e}")

def schedule_daily_window_creation():
    def task():
        last_day=get_today_key()
        while True:
            try:
                time.sleep(60)
                current_day=get_today_key()
                if current_day!=last_day:
                    for chat_id_str in list(data.get("chats",{}).keys()):
                        try: chat_id=int(chat_id_str)
                        except: continue
                        try: update_or_send_today_window(chat_id)
                        except Exception as e: log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð¾ÐºÐ½Ð° Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð´Ð½Ñ Ð´Ð»Ñ {chat_id}: {e}")
                    last_day=current_day
            except Exception as e: log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð² daily loop: {e}"); time.sleep(5)
    thread=threading.Thread(target=task,daemon=True)
    thread.start()

# -----------------------------
# Ð—Ð°Ð¿ÑƒÑÐº
# -----------------------------
if __name__=="__main__":
    set_webhook()
    schedule_daily_window_creation()
    log_info(f"Ð‘Ð¾Ñ‚ Ð¤Ðž Ð²ÐµÑ€ÑÐ¸Ð¸ {VERSION} Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½")
    if OWNER_ID:
        try:
            bot.send_message(int(OWNER_ID),f"Ð‘Ð¾Ñ‚ Ð¤Ðž Ð²ÐµÑ€ÑÐ¸Ð¸ {VERSION} Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½")
        except: pass
    app.run(host="0.0.0.0",port=PORT)