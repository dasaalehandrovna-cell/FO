# ============================================
# –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è 9.8.7
# –ù–∞ –±–∞–∑–µ 9.8.6 ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–æ:
# - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±—ç–∫–∞–ø –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (history –≤–Ω—É—Ç—Ä–∏ data.json)
# - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ data.json (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
# - –Ω–∏–∫–∞–∫–∏—Ö —Ç–µ–ª–µ–≥—Ä–∞–º-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ (–ø–æ —Ç–≤–æ–µ–π –ø—Ä–æ—Å—å–±–µ)
# ============================================

import os
import json
import csv
import logging
from datetime import datetime
from zoneinfo import ZoneInfo
import telebot
from flask import Flask, request
from telebot import types

# –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –¥–ª—è –±—ç–∫–∞–ø–∞/–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
import threading
import time

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")
APP_URL = os.getenv("APP_URL", "https://yourapp.onrender.com")
TZ = ZoneInfo("America/Argentina/Catamarca")
DATA_FILE = "data.json"
CSV_FILE = "data.csv"
LOG_FILE = "log.txt"
PORT = int(os.environ.get("PORT", 5000))
VERSION = "9.8.7"  # bumped

if not TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# -----------------------------
# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª
# -----------------------------
def fmt_num(value):
    try:
        return f"{value:,.0f}".replace(",", ".")
    except Exception:
        return str(value)

# -----------------------------
# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# -----------------------------
logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[logging.FileHandler(LOG_FILE, encoding="utf-8"), logging.StreamHandler()]
)

def log_info(msg): logging.info(msg)
def log_error(msg): logging.error(msg)

log_info(f"–°—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –í–µ—Ä—Å–∏—è {VERSION}")

# -----------------------------
# –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏ –∏ –±—ç–∫–∞–ø–∞–º–∏
# -----------------------------
def default_data():
    return {
        "overall_balance": 0,
        "records": [],
        "chats": {},
        "active_messages": {},
        "processed_messages": [],
        "forward_targets": [],
        "tracked_messages": {},
        "next_id": 1
    }

# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö: —á–∏—Ç–∞–µ–º data.json, –µ—Å–ª–∏ —Ç–∞–º –µ—Å—Ç—å "current" ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ.
# –ï—Å–ª–∏ "current" –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –Ω–æ –µ—Å—Ç—å "backups" ‚Äî –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø.
def load_data():
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, "r", encoding="utf-8") as f:
                file_data = json.load(f)
            # prefer "current" key (actual data snapshot)
            if isinstance(file_data, dict) and "current" in file_data and isinstance(file_data["current"], dict):
                d = file_data["current"]
                log_info("–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ data.json -> current")
            else:
                # –µ—Å–ª–∏ —Ñ–∞–π–ª–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Äî —Å—Ç–∞—Ä—ã–π (plain data) –∏–ª–∏ –∏–º–µ–µ—Ç backups
                if isinstance(file_data, dict) and "backups" in file_data and isinstance(file_data["backups"], dict) and file_data["backups"]:
                    # –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø –∫–∞–∫ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    try:
                        last_key = sorted(file_data["backups"].keys())[-1]
                        d = file_data["backups"][last_key]
                        log_info(f"–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ data.json -> –ø–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø {last_key}")
                    except Exception as e:
                        log_error(f"–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±—ç–∫–∞–ø–∞: {e}")
                        d = default_data()
                else:
                    # –≤–æ–∑–º–æ–∂–Ω–æ —Ñ–∞–π–ª —É–∂–µ –ø—Ä–æ—Å—Ç–æ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—É—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
                    if isinstance(file_data, dict):
                        d = file_data
                        log_info("–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ data.json (–±–µ–∑ current/backups)")
                    else:
                        d = default_data()
        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è {DATA_FILE}: {e} ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ backups (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)")
            # –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ‚Äî –µ—Å–ª–∏ —Ñ–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥—ë–Ω, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –º–æ–∂–Ω–æ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å via fallback
            d = default_data()
    else:
        d = default_data()
    # ensure schema compatibility
    base = default_data()
    for k, v in base.items():
        if k not in d:
            d[k] = v
    return d

# save_data: –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ data.json -> –ø–æ–ª–µ "current".
# –ë—ç–∫–∞–ø-–∏—Å—Ç–æ—Ä–∏—è –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ —Ñ—É–Ω–∫—Ü–∏–µ–π backup_data(), —á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑–¥—É–≤–∞—Ç—å —Ñ–∞–π–ª –ø—Ä–∏ –∫–∞–∂–¥–æ–º save.
def save_data(d):
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å) —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å "backups"
        file_data = {}
        if os.path.exists(DATA_FILE):
            try:
                with open(DATA_FILE, "r", encoding="utf-8") as f:
                    file_data = json.load(f)
            except Exception:
                file_data = {}

        # –û–±–Ω–æ–≤–ª—è–µ–º current
        file_data["current"] = d

        # –ï—Å–ª–∏ –Ω–µ—Ç —Ä–∞–∑–¥–µ–ª–∞ backups ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å (backup_data —Å–æ–∑–¥–∞—Å—Ç –µ–≥–æ)
        with open(DATA_FILE, "w", encoding="utf-8") as f:
            json.dump(file_data, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: {e}")

# backup_data: –¥–æ–±–∞–≤–ª—è–µ—Ç snapshot —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –≤ file_data["backups"] —Å –º–µ—Ç–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏.
# –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –≤–µ—Ä—Å–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10).
def backup_data(max_backups=10):
    try:
        # –¢–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç
        ts = datetime.now(TZ).strftime("%Y-%m-%d %H:%M:%S")

        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        file_data = {}
        if os.path.exists(DATA_FILE):
            try:
                with open(DATA_FILE, "r", encoding="utf-8") as f:
                    file_data = json.load(f)
            except Exception:
                file_data = {}

        # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ current —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –µ—Å–ª–∏ –Ω–µ—Ç, –ø–æ–ª–æ–∂–∏–º —Ç–µ–∫—É—â—É—é in-memory –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
        current_snapshot = file_data.get("current") if isinstance(file_data, dict) and file_data.get("current") else data

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è backups
        if "backups" not in file_data or not isinstance(file_data["backups"], dict):
            file_data["backups"] = {}

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å –ø–æ–ª–Ω—ã–º —Å–Ω–∏–º–∫–æ–º (–º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë ‚Äî current_snapshot)
        # –ß—Ç–æ–±—ã –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—å —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –æ–±—ä–µ–º, –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å current_snapshot —Ü–µ–ª–∏–∫–æ–º.
        file_data["backups"][ts] = current_snapshot

        # –û–±—Ä–µ–∑–∞–µ–º —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (–æ—Å—Ç–∞–≤–ª—è–µ–º max_backups –ø–æ—Å–ª–µ–¥–Ω–∏—Ö)
        if len(file_data["backups"]) > max_backups:
            keys = sorted(file_data["backups"].keys())
            while len(keys) > max_backups:
                del_key = keys.pop(0)
                try:
                    del file_data["backups"][del_key]
                except KeyError:
                    pass

        # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ current (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π ‚Äî —É–∂–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å)
        file_data["current"] = current_snapshot

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ
        with open(DATA_FILE, "w", encoding="utf-8") as f:
            json.dump(file_data, f, ensure_ascii=False, indent=2)

        log_info(f"–ë—ç–∫–∞–ø {ts} –¥–æ–±–∞–≤–ª–µ–Ω –≤ {DATA_FILE}")
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—ç–∫–∞–ø–∞: {e}")

# –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
data = load_data()

# –µ—Å–ª–∏ –∑–∞–¥–∞–Ω OWNER_ID ‚Äî –¥–æ–±–∞–≤–∏–º –µ–≥–æ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ü–µ–ª–∏ (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
if OWNER_ID:
    try:
        oi = int(OWNER_ID)
        if oi not in data.get("forward_targets", []):
            data["forward_targets"].append(oi)
            save_data(data)
    except Exception:
        pass

# -----------------------------
# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
# -----------------------------
def get_today_key():
    return datetime.now(TZ).strftime("%Y-%m-%d")

def get_chat_store(chat_id):
    cid = str(chat_id)
    if cid not in data["chats"]:
        data["chats"][cid] = {
            "balance": 0,
            "records": [],
            "daily_records": {},
            "forward_enabled": False,
            "forward_target_id": None
        }
        save_data(data)
    return data["chats"][cid]

def set_today_active_window(chat_id, message_id):
    today = get_today_key()
    data.setdefault("active_messages", {}).setdefault(today, {})[str(chat_id)] = message_id
    save_data(data)

# -----------------------------
# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
# -----------------------------
def add_record_to_chat(chat_id, amount, note, owner):
    store = get_chat_store(chat_id)
    rid = data["next_id"]
    rec = {
        "id": rid,
        "short_id": f"R{rid}",
        "timestamp": datetime.now(TZ).isoformat(timespec="seconds"),
        "amount": amount,
        "note": note,
        "owner": owner
    }
    store["records"].append(rec)
    store.setdefault("daily_records", {}).setdefault(get_today_key(), []).append(rec)
    store["balance"] = store.get("balance", 0) + amount
    data.setdefault("records", []).append(rec)
    data["overall_balance"] = data.get("overall_balance", 0) + amount
    data["next_id"] = data.get("next_id", 1) + 1
    save_data(data)
    export_to_csv(data)

    # –ü–µ—Ä–µ—Å—ã–ª–∫–∞, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ (–±–µ–∑–æ–ø–∞—Å–Ω–æ ‚Äî –≤ try)
    try:
        if store.get("forward_enabled"):
            target = store.get("forward_target_id") or OWNER_ID
            if target:
                bot.send_message(int(target), f"üí∞ {fmt_num(amount)} ARS ‚Äî {note}")
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏: {e}")

    return rec

# -----------------------------
# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ
# -----------------------------
def update_record_in_chat(chat_id, rid, new_amount, new_note):
    store = get_chat_store(chat_id)
    for r in store["records"]:
        if r["id"] == rid:
            r["amount"] = new_amount
            r["note"] = new_note
    store["balance"] = sum(x["amount"] for x in store["records"])
    data["overall_balance"] = sum(x["amount"] for x in data.get("records", []))
    save_data(data)
    export_to_csv(data)

def delete_record_in_chat(chat_id, rid):
    store = get_chat_store(chat_id)
    store["records"] = [r for r in store["records"] if r["id"] != rid]
    store["balance"] = sum(x["amount"] for x in store["records"])
    data["records"] = [x for x in data.get("records", []) if x["id"] != rid]
    data["overall_balance"] = sum(x["amount"] for x in data.get("records", []))
    save_data(data)
    export_to_csv(data)

# -----------------------------
# CSV
# -----------------------------
def export_to_csv(d):
    try:
        with open(CSV_FILE, "w", newline='', encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow(["chat_id","id","short_id","timestamp","amount","note","owner"])
            for cid, store in d.get("chats", {}).items():
                for rec in store.get("records", []):
                    writer.writerow([cid, rec["id"], rec["short_id"], rec["timestamp"], rec["amount"], rec["note"], rec["owner"]])
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ CSV: {e}")

# -----------------------------
# –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
# -----------------------------
def build_edit_menu_keyboard(chat_id=None):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("üìÇ CSV", callback_data="btn_csv"),
        types.InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å–∏", callback_data="btn_edit_list")
    )
    kb.row(
        types.InlineKeyboardButton("üì® –§–æ—Ä–≤–∞—Ä–¥", callback_data="btn_toggle_forward"),
        types.InlineKeyboardButton("üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å", callback_data="btn_set_forward_target")
    )
    kb.row(
        types.InlineKeyboardButton("‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å", callback_data="btn_reset"),
        types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_main")
    )
    return kb

def build_main_keyboard(chat_id=None):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å", callback_data="btn_balance"),
        types.InlineKeyboardButton("üìä –û—Ç—á—ë—Ç", callback_data="btn_report"),
        types.InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data="btn_edit_menu")
    )
    kb.row(
        types.InlineKeyboardButton("üöÄ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="btn_start"),
        types.InlineKeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ", callback_data="btn_cod")
    )
    return kb

# -----------------------------
# Callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
# -----------------------------
@bot.callback_query_handler(func=lambda c: True)
def handle_callback(call):
    chat_id = call.message.chat.id
    store = get_chat_store(chat_id)

    if call.data == "btn_toggle_forward":
        store["forward_enabled"] = not store["forward_enabled"]
        save_data(data)
        status = "–≤–∫–ª—é—á–µ–Ω–∞ ‚úÖ" if store["forward_enabled"] else "–≤—ã–∫–ª—é—á–µ–Ω–∞ ‚ùå"
        bot.answer_callback_query(call.id, f"–ü–µ—Ä–µ—Å—ã–ª–∫–∞ {status}")
        return

    if call.data == "btn_set_forward_target":
        msg = bot.send_message(chat_id, "–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è (0 ‚Äî —Å–±—Ä–æ—Å):")
        bot.register_next_step_handler(msg, process_forward_target)
        return

def process_forward_target(message):
    chat_id = message.chat.id
    store = get_chat_store(chat_id)
    try:
        tid = int(message.text)
        if tid == 0:
            store["forward_target_id"] = None
            bot.send_message(chat_id, "–ü–æ–ª—É—á–∞—Ç–µ–ª—å —Å–±—Ä–æ—à–µ–Ω.")
        else:
            store["forward_target_id"] = tid
            bot.send_message(chat_id, f"–ü–æ–ª—É—á–∞—Ç–µ–ª—å –∑–∞–¥–∞–Ω: {tid}")
        save_data(data)
    except Exception:
        bot.send_message(chat_id, "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID.")

# -----------------------------
# Flask webhook
# -----------------------------
@app.route("/" + TOKEN, methods=["POST"])
def receive_update():
    bot.process_new_updates([telebot.types.Update.de_json(request.stream.read().decode("utf-8"))])
    return "ok", 200

@app.route("/")
def index():
    return "Bot is running.", 200

# -----------------------------
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±—ç–∫–∞–ø (–∑–∞–ø—É—Å–∫ –ø–æ—Ç–æ–∫a)
# -----------------------------
def _start_auto_backup_loop():
    def loop():
        # –°–Ω–∞—á–∞–ª–∞ –¥–µ–ª–∞–µ–º –±—ç–∫–∞–ø –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (—á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
        try:
            backup_data()
        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–∞–ø-–±—ç–∫–∞–ø–µ: {e}")
        # –ó–∞—Ç–µ–º —Ü–∏–∫–ª –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        while True:
            time.sleep(300)  # 5 –º–∏–Ω—É—Ç
            try:
                backup_data()
            except Exception as e:
                log_error(f"–û—à–∏–±–∫–∞ –≤ –∞–≤—Ç–æ–±—ç–∫–∞–ø–µ: {e}")
    t = threading.Thread(target=loop, daemon=True)
    t.start()

# -----------------------------
# –ó–∞–ø—É—Å–∫
# -----------------------------
if __name__ == "__main__":
    # Start auto-backup thread silently (no Telegram notifications)
    _start_auto_backup_loop()

    log_info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –Ω–∞ Flask")
    app.run(host="0.0.0.0", port=PORT)
# -----------------------------
# –ó–∞–ø—É—Å–∫
# -----------------------------
if __name__ == "__main__":
    set_webhook()
    schedule_daily_window_creation()
    log_info(f"–ë–æ—Ç –§–û –≤–µ—Ä—Å–∏–∏ {VERSION} –∑–∞–ø—É—â–µ–Ω")
    try:
        if OWNER_ID:
            bot.send_message(int(OWNER_ID), f"‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! (–≤–µ—Ä—Å–∏—è {VERSION})")
    except Exception as e:
        log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ: {e}")
    app.run(host="0.0.0.0", port=PORT)