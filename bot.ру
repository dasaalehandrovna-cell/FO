#–ü—Ä–æ–≤–µ—Ä—å. –ü—Ä–∞–≤–∏–ª—å–Ω–æ —è –≤—Å—Ç–∞–≤–∏–ª , —ç—Ç–æ –≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ?
#1588üíæ —Ñ–æ –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è 9.8.6-fo_6+autoCSV
# ID Code_019c
# ============================================
# üß≠ –û–ø–∏—Å–∞–Ω–∏–µ:
#  ‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—á–Ω—ã–º–∏ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –ø–æ –¥–Ω—è–º
#  ‚Ä¢ –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ /prev /next –∏ –≤—ã–±–æ—Ä –¥–∞—Ç—ã —á–µ—Ä–µ–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—å
#  ‚Ä¢ –û—Ç—á—ë—Ç—ã, CSV-—ç–∫—Å–ø–æ—Ä—Ç, –ø–µ—Ä–µ—Å—á—ë—Ç –±–∞–ª–∞–Ω—Å–∞ –∏ –ø–µ—Ä–µ—Å—ã–ª–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü—É
#  ‚Ä¢ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ CSV –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ
#  ‚Ä¢ –ê–≤—Ç–æ–ø–∏–Ω–≥ (keep-alive) –∏ webhook –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –Ω–∞ Render
# ============================================

import os
import json
import csv
import re
import logging
import threading
import time
from datetime import datetime, timedelta, timezone
from zoneinfo import ZoneInfo

import requests
import telebot
from telebot import types
from flask import Flask, request

# -----------------------------
# ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞
# -----------------------------
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")  # ID –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
APP_URL = os.getenv("APP_URL", "https://yourapp.onrender.com")

# ‚úÖ –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è tzdata
try:
    TZ = ZoneInfo((os.getenv("TZ") or "America/Argentina/Buenos_Aires").strip())
except Exception:
    TZ = timezone(timedelta(hours=-3))  # fallback UTC‚àí3

DATA_FILE = "data.json"
CSV_FILE = "data.csv"
LOG_FILE = "log.txt"
PORT = int(os.environ.get("PORT", 5000))
VERSION = "9.8.6-fo_6+autoCSV"

# üîÑ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ-–ø–∏–Ω–≥–∞
KEEP_ALIVE_INTERVAL_SECONDS = int(os.getenv("KEEP_ALIVE_INTERVAL_SECONDS", 11 * 60))
KEEP_ALIVE_SEND_TO_OWNER = True

# ‚úÖ –ü–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ ‚Äî –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –æ–∫–Ω–∞ –ø–æ –¥–∞—Ç–∞–º
DELETE_SOURCE_WINDOW_ON_NAV = False        # –∏—Å—Ö–æ–¥–Ω—ã–π –¥–µ–Ω—å –Ω–µ —É–¥–∞–ª—è–µ–º
DELETE_TARGET_OLD_WINDOW_ON_NAV = True     # —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –æ–∫–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
ALWAYS_CREATE_NEW_ON_NAV = True            # —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

if not TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# -----------------------------
# üßæ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# -----------------------------
logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[logging.FileHandler(LOG_FILE, encoding="utf-8"), logging.StreamHandler()]
)

def log_info(msg): logging.info(msg)
def log_error(msg): logging.error(msg)

# ----------------------------------
# üì¨ –û—Ç–ø—Ä–∞–≤–∫–∞ –ª–æ–≥–æ–≤ –≤–ª–∞–¥–µ–ª—å—Ü—É (–≤ —á–∞—Ç)
# ----------------------------------
def log_chat(msg: str, error: bool = False):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ª–æ–≥ –≤–ª–∞–¥–µ–ª—å—Ü—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ log.txt"""
    log_func = log_error if error else log_info
    log_func(msg)
    try:
        if OWNER_ID:
            bot.send_message(int(OWNER_ID), f"ü™µ {msg}")
    except Exception as e:
        log_error(f"log_chat send failed: {e}")

log_info(f"üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –í–µ—Ä—Å–∏—è {VERSION}")


# -----------------------------
# üïí –†–∞–±–æ—Ç–∞ —Å –≤—Ä–µ–º–µ–Ω–µ–º –∏ –¥–∞—Ç–∞–º–∏
# -----------------------------
def now_local() -> datetime:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Å —É—á—ë—Ç–æ–º TZ"""
    return datetime.now(TZ)

def today_key() -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD"""
    return now_local().strftime("%Y-%m-%d")

def parse_date_key(s: str):
    """–ü–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫—É –¥–∞—Ç—ã 'YYYY-MM-DD' ‚Üí datetime.date"""
    try:
        return datetime.strptime(s, "%Y-%m-%d").date()
    except Exception:
        return None

def shift_date_key(day_key: str, days: int) -> str:
    """–°–¥–≤–∏–≥–∞–µ—Ç –¥–∞—Ç—É –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π"""
    d = parse_date_key(day_key) or now_local().date()
    return (d + timedelta(days=days)).strftime("%Y-%m-%d")

def fmt_num(value):
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —á–∏—Å–ª–æ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º —Ç–æ—á–∫–æ–π"""
    try:
        return f"{value:,.0f}".replace(",", ".")
    except Exception:
        return str(value)

# -----------------------------
# üíæ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≤–≤–æ–¥–∞/–≤—ã–≤–æ–¥–∞
# -----------------------------
def default_data():
    """–°–æ–∑–¥–∞—ë—Ç –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ"""
    return {
        "overall_balance": 0,      # –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π
        "records": [],             # —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
        "chats": {},               # –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞–∂–¥–æ–º—É —á–∞—Ç—É
        "active_messages": {},     # –∞–∫—Ç–∏–≤–Ω—ã–µ –æ–∫–Ω–∞ (–ø–æ –¥–Ω—è–º)
        "processed_messages": [],  # —Å–ø–∏—Å–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        "forward_targets": [],     # –ø–æ–ª—É—á–∞—Ç–µ–ª–∏ –ø–µ—Ä–µ—Å—ã–ª–∫–∏
        "tracked_messages": {},    # –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        "next_id": 1               # —Å–ª–µ–¥—É—é—â–∏–π ID –∑–∞–ø–∏—Å–∏
    }

def _load_json(path, fallback):
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç JSON —Å –¥–∏—Å–∫–∞, –ø—Ä–∏ –æ—à–∏–±–∫–µ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–∞–ø–∞—Å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É"""
    try:
        if os.path.exists(path):
            with open(path, "r", encoding="utf-8") as f:
                return json.load(f)
    except Exception as e:
        log_error(f"_load_json: {path}: {e}")
    return fallback

def _save_json(path, payload):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç JSON-—Ñ–∞–π–ª –Ω–∞ –¥–∏—Å–∫"""
    try:
        with open(path, "w", encoding="utf-8") as f:
            json.dump(payload, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"_save_json: {path}: {e}")

def load_data():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞ data.json"""
    d = _load_json(DATA_FILE, default_data())
    base = default_data()
    for k, v in base.items():
        if k not in d:
            d[k] = v
    return d

data = load_data()

# -----------------------------
# üìÇ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ CSV
# -----------------------------
def restore_from_telegram_backup():
    """üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ CSV –≤ —á–∞—Ç–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞"""
    try:
        log_chat("üîÑ –°—Ç–∞—Ä—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ Telegram CSV...")
        if not OWNER_ID:
            log_chat("‚ö†Ô∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ ‚Äî OWNER_ID –Ω–µ –∑–∞–¥–∞–Ω.")
            return

        owner_id = int(OWNER_ID)
        log_info("üîç –ü–æ–∏—Å–∫ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ CSV –≤ —á–∞—Ç–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞...")

        # üßπ –ü–µ—Ä–µ–¥ getUpdates —É–¥–∞–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π webhook (–∏–Ω–∞—á–µ –æ—à–∏–±–∫–∞ 409)
        try:
            bot.delete_webhook()
            log_info("üîß Webhook –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á—ë–Ω –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è CSV.")
            time.sleep(1.0)
        except Exception as e:
            log_error(f"delete_webhook –ø–µ—Ä–µ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º: {e}")

        updates = bot.get_updates(limit=50)
        file_id = None
        for u in reversed(updates):
            m = getattr(u, "message", None)
            if not m or not getattr(m, "document", None):
                continue
            fn = m.document.file_name.lower()
            if fn.startswith("data") and fn.endswith(".csv"):
                file_id = m.document.file_id
                log_info(f"üì¶ –ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª –±—ç–∫–∞–ø–∞: {fn}")
                break

        if not file_id:
            log_info("‚ùï –§–∞–π–ª CSV –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π data.json.")
            return

        file_info = bot.get_file(file_id)
        downloaded = bot.download_file(file_info.file_path)
        tmp = "restore.csv"
        with open(tmp, "wb") as f:
            f.write(downloaded)

        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º CSV ‚Üí JSON-—Å—Ç—Ä—É–∫—Ç—É—Ä—É
        import csv
        restored = default_data()
        with open(tmp, "r", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            for row in reader:
                chat_id = str(row["chat_id"])
                rec = {
                    "id": int(row["ID"]),
                    "short_id": row["short_id"],
                    "timestamp": row["timestamp"],
                    "amount": int(row["amount"]),
                    "note": row["note"],
                    "owner": row["owner"]
                }
                restored["records"].append(rec)
                restored["chats"].setdefault(chat_id, {"records": [], "daily_records": {}, "balance": 0})
                restored["chats"][chat_id]["records"].append(rec)
                day = row["day_key"]
                restored["chats"][chat_id]["daily_records"].setdefault(day, []).append(rec)
                restored["chats"][chat_id]["balance"] += rec["amount"]
                restored["overall_balance"] += rec["amount"]
                restored["next_id"] = max(restored["next_id"], rec["id"] + 1)

        _save_json(DATA_FILE, restored)
        log_info("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ Telegram CSV.")
        log_chat("‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!")
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ Telegram: {e}")
        log_chat(f"‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: {e}", error=True)


def save_data(d):
    """üíæ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç JSON, –æ–±–Ω–æ–≤–ª—è–µ—Ç CSV –∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç Telegram-–±—ç–∫–∞–ø"""
    try:
        _save_json(DATA_FILE, d)
        export_to_csv(d)
        log_chat("üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ CSV –æ–±–Ω–æ–≤–ª—ë–Ω (–∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram).")
        _schedule_csv_backup_debounced()  # ‚òÅÔ∏è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ CSV –≤ Telegram —Å —Å–∞–º–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: {e}")
        log_chat(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: {e}", error=True)

def auto_update_task():
    """üïí –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∫–∞–∂–¥—ã–µ 3 —á–∞—Å–∞"""
    while True:
        try:
            log_info("üïí –ü–ª–∞–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ JSON –∏ CSV...")
            save_data(data)
            time.sleep(3 * 60 * 60)  # –∫–∞–∂–¥—ã–µ 3 —á–∞—Å–∞
        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ —Ñ–æ–Ω–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {e}")
            time.sleep(60)
# -----------------------------
# üóÉ –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö —á–∞—Ç–∞ –∏ –æ–∫–æ–Ω
# -----------------------------
def get_chat_store(chat_id: int) -> dict:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç/—Å–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å —á–∞—Ç–∞ —Å–æ –≤—Å–µ–º–∏ –ø–æ–ª—è–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
    cid = str(chat_id)
    if cid not in data["chats"]:
        data["chats"][cid] = {
            "balance": 0,
            "records": [],
            "next_id": 1,
            "daily_records": {},        # {day_key: [records]}
            "active_windows": {},       # –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏
            "edit_wait": None,
            "edit_target": None,
            "forward_enabled": False,
            "forward_target_id": None,
            "current_view_day": today_key()
        }
        save_data(data)
    store = data["chats"][cid]
    # —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–æ–ª–µ–π
    store.setdefault("forward_enabled", False)
    store.setdefault("forward_target_id", None)
    store.setdefault("current_view_day", today_key())
    save_data(data)
    return store


def get_active_window_id(chat_id: int, day_key: str):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç message_id –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã"""
    return data.setdefault("active_messages", {}).setdefault(day_key, {}).get(str(chat_id))


def set_active_window(chat_id: int, day_key: str, message_id: int):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–≤—è–∑—å (chat_id, day_key) ‚Üí message_id"""
    data.setdefault("active_messages", {}).setdefault(day_key, {})[str(chat_id)] = message_id
    save_data(data)


def clear_active_window(chat_id: int, day_key: str):
    """–û—á–∏—â–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π message_id –æ–∫–Ω–∞ –¥–∞—Ç—ã"""
    am = data.setdefault("active_messages", {}).setdefault(day_key, {})
    if str(chat_id) in am:
        am.pop(str(chat_id), None)
        save_data(data)


def delete_message_safe(chat_id: int, message_id: int):
    """–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ Telegram API)"""
    try:
        bot.delete_message(chat_id, message_id)
    except Exception:
        pass


def delete_active_window_if_exists(chat_id: int, day_key: str):
    """–£–¥–∞–ª—è–µ—Ç —Ä–∞–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)"""
    old_id = get_active_window_id(chat_id, day_key)
    if old_id:
        delete_message_safe(chat_id, old_id)
        clear_active_window(chat_id, day_key)


def send_temp_message(chat_id: int, text: str, delay: int = 5, **kwargs):
    """–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Å–∞–º–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ delay —Å–µ–∫—É–Ω–¥)"""
    try:
        msg = bot.send_message(chat_id, text, **kwargs)
        if delay and delay > 0:
            threading.Timer(delay, lambda: delete_message_safe(chat_id, msg.message_id)).start()
        return msg
    except Exception as e:
        log_error(f"send_temp_message: {e}")
        return None


def set_current_view_day(chat_id: int, day_key: str):
    """–ó–∞–ø–æ–º–∏–Ω–∞–µ—Ç —Ç–µ–∫—É—â—É—é –æ—Ç–∫—Ä—ã—Ç—É—é –¥–∞—Ç—É –¥–ª—è —á–∞—Ç–∞"""
    store = get_chat_store(chat_id)
    store["current_view_day"] = day_key
    save_data(data)


def get_current_view_day(chat_id: int) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é ¬´—Ç–µ–∫—É—â—É—é¬ª –¥–∞—Ç—É, –æ—Ç–∫—Ä—ã—Ç—É—é –≤ —á–∞—Ç–µ"""
    store = get_chat_store(chat_id)
    return store.get("current_view_day", today_key())


# -----------------------------
# üì§ –≠–∫—Å–ø–æ—Ä—Ç CSV
# -----------------------------
def export_to_csv(d):
    """–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏ –≤–æ –æ–±—â–∏–π CSV (data.csv)"""
    try:
        with open(CSV_FILE, "w", newline='', encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
            for cid, cdata in d.get("chats", {}).items():
                for dk, records in cdata.get("daily_records", {}).items():
                    for r in records:
                        writer.writerow([
                            cid,
                            r.get("id"), r.get("short_id"), r.get("timestamp"),
                            r.get("amount"), r.get("note"), r.get("owner"), dk
                        ])
    except Exception as e:
        log_error(f"export_to_csv: {e}")

# -----------------------------
# ‚òÅÔ∏è –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ CSV –≤ Telegram (—É—Å—Ç–æ–π—á–∏–≤—ã–π –±—ç–∫–∞–ø —Å —Å–∞–º–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º)
# -----------------------------
_CSV_BACKUP_META = "csv_meta.json"
_CSV_DEBOUNCE_SECONDS = 3
_csv_backup_timer = None
_csv_backup_lock = threading.Lock()


def _load_csv_meta():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ CSV-–±—ç–∫–∞–ø–µ (message_id –∏ –¥—Ä.)"""
    try:
        if os.path.exists(_CSV_BACKUP_META):
            with open(_CSV_BACKUP_META, "r", encoding="utf-8") as f:
                return json.load(f)
    except Exception as e:
        log_error(f"_load_csv_meta: {e}")
    return {}


def _save_csv_meta(meta: dict):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ CSV-–±—ç–∫–∞–ø–µ"""
    try:
        with open(_CSV_BACKUP_META, "w", encoding="utf-8") as f:
            json.dump(meta, f, ensure_ascii=False, indent=2)
        log_chat("üíæ –§–∞–π–ª csv_meta.json –æ–±–Ω–æ–≤–ª—ë–Ω.")
    except Exception as e:
        log_error(f"_save_csv_meta: {e}")
        log_chat(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ csv_meta.json: {e}", error=True)

def _schedule_csv_backup_debounced():
    """–ü–ª–∞–Ω–∏—Ä—É–µ—Ç –∞–≤—Ç–æ-–±—ç–∫–∞–ø CSV –≤ Telegram —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π (–∞–Ω—Ç–∏—Å–ø–∞–º)"""
    global _csv_backup_timer
    with _csv_backup_lock:
        if _csv_backup_timer and _csv_backup_timer.is_alive():
            _csv_backup_timer.cancel()
        _csv_backup_timer = threading.Timer(_CSV_DEBOUNCE_SECONDS, safe_csv_backup_to_telegram)
        _csv_backup_timer.daemon = True
        _csv_backup_timer.start()


def safe_csv_backup_to_telegram():
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç CSV-—Ñ–∞–π–ª –≤ —á–∞—Ç–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞, –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏"""
    try:
        log_chat("‚òÅÔ∏è –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ-–±—ç–∫–∞–ø–∞ CSV –≤ Telegram...")
        if not OWNER_ID:
            log_chat("‚ö†Ô∏è CSV-–±—ç–∫–∞–ø –ø—Ä–æ–ø—É—â–µ–Ω ‚Äî OWNER_ID –Ω–µ –∑–∞–¥–∞–Ω.")
            return

        owner_id = int(OWNER_ID)
        export_to_csv(data)
        meta = _load_csv_meta()
        message_id = meta.get("message_id")

        with open(CSV_FILE, "rb") as f:
            try:
                # üîÅ –ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–π CSV –≤ Telegram
                if message_id:
                    bot.edit_message_media(
                        chat_id=owner_id,
                        message_id=message_id,
                        media=telebot.types.InputMediaDocument(f, caption="üìä –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π CSV-–±—ç–∫–∞–ø –¥–∞–Ω–Ω—ã—Ö")
                    )
                    log_chat("‚úÖ CSV-–±—ç–∫–∞–ø —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω –≤ Telegram.")
                    log_info("‚úÖ CSV-–±—ç–∫–∞–ø —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω –≤ Telegram.")
                    return

            except telebot.apihelper.ApiTelegramException as e:
                err = str(e).lower()
                log_error(f"CSV edit_message_media error: {err}")
                if "message to edit not found" in err or "not found" in err or "invalid message" in err:
                    log_info("‚ôªÔ∏è –°—Ç–∞—Ä—ã–π CSV-—Ñ–∞–π–ª —É–¥–∞–ª—ë–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –°–æ–∑–¥–∞—é –Ω–æ–≤—ã–π...")
                else:
                    # –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –Ω–µ —Å–≤—è–∑–∞–Ω–∞ —Å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º —Ñ–∞–π–ª–∞ ‚Äî –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–ª—å—à–µ
                    raise

            # ‚ôªÔ∏è –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π CSV, –µ—Å–ª–∏ —Å—Ç–∞—Ä—ã–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
            try:
                f.seek(0)  # –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞
                sent = bot.send_document(
                    owner_id, f, caption="üìä –ù–æ–≤—ã–π CSV-–±—ç–∫–∞–ø –¥–∞–Ω–Ω—ã—Ö (—Å–æ–∑–¥–∞–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)"
                )
                meta["message_id"] = sent.message_id
                meta["timestamp"] = datetime.now(TZ).isoformat(timespec="seconds")
                _save_csv_meta(meta)
                log_chat("‚ôªÔ∏è –ù–æ–≤—ã–π CSV-–±—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω –∑–∞–Ω–æ–≤–æ.")
                log_info("‚úÖ CSV-–±—ç–∫–∞–ø –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω –∏ —Ç–µ–ø–µ—Ä—å –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.")
            except Exception as e2:
                log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏ CSV-–±—ç–∫–∞–ø–∞: {e2}")

    except Exception as e:
        log_error(f"safe_csv_backup_to_telegram: {e}")

def export_day_csv(chat_id: int, day_key: str):
    """–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–Ω—è –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π CSV data_YYYY-MM-DD.csv"""
    store = get_chat_store(chat_id)
    day_records = store.get("daily_records", {}).get(day_key, [])
    filename = f"data_{day_key}.csv"
    try:
        with open(filename, "w", newline='', encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
            for r in day_records:
                writer.writerow([
                    chat_id,
                    r.get("id"), r.get("short_id"), r.get("timestamp"),
                    r.get("amount"), r.get("note"), r.get("owner"), day_key
                ])
    except Exception as e:
        log_error(f"export_day_csv: {e}")
        return None
    return filename


# -----------------------------
# ‚ûï/‚úèÔ∏è/üóë –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –∑–∞–ø–∏—Å—è–º–∏
# -----------------------------
def add_record_to_chat(chat_id: int, amount: int, note: str, owner):
    """–î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å, –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å—ã, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç CSV"""
    store = get_chat_store(chat_id)
    rid = data.get("next_id", 1)
    rec = {
        "id": rid,
        "short_id": f"R{rid}",
        "timestamp": now_local().isoformat(timespec="seconds"),
        "amount": amount,
        "note": note,
        "owner": owner
    }
    data.setdefault("records", []).append(rec)
    store.setdefault("records", []).append(rec)
    day = today_key()
    store.setdefault("daily_records", {}).setdefault(day, []).append(rec)

    # –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å—ã
    store["balance"] = store.get("balance", 0) + amount
    data["overall_balance"] = data.get("overall_balance", 0) + amount
    data["next_id"] = rid + 1

    save_data(data)  # üíæ JSON + CSV
    log_chat(f"‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å: {amount} ({note}) ‚Äî —á–∞—Ç {chat_id}")
    return rec


def update_record_in_chat(chat_id: int, rid: int, new_amount: int, new_note: str, user=None):
    """–ò–∑–º–µ–Ω—è–µ—Ç —Å—É–º–º—É/–∑–∞–º–µ—Ç–∫—É –∑–∞–ø–∏—Å–∏ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º ID"""
    store = get_chat_store(chat_id)
    found = None
    for r in store.get("records", []):
        if r["id"] == rid:
            r["amount"] = new_amount
            r["note"] = new_note
            found = r
            break

    if found:
        # —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–Ω–µ–≤–Ω—ã—Ö —Å—Ä–µ–∑–æ–≤
        for day_recs in store.get("daily_records", {}).values():
            for r in day_recs:
                if r["id"] == rid:
                    r.update(found)

        # –ø–µ—Ä–µ—Å—á—ë—Ç –±–∞–ª–∞–Ω—Å–æ–≤
        store["balance"] = sum(x["amount"] for x in store.get("records", []))
        data["records"] = [x if x["id"] != rid else found for x in data.get("records", [])]
        data["overall_balance"] = sum(x["amount"] for x in data.get("records", []))

        save_data(data)  # üíæ JSON + CSV
        log_chat(f"‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∑–∞–ø–∏—Å—å ID {rid} –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Äî —á–∞—Ç {chat_id}")
        return True, found
    return False, None


def delete_record_in_chat(chat_id: int, rid: int, user=None):
    """–£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å—ã"""
    store = get_chat_store(chat_id)
    removed = None
    for r in list(store.get("records", [])):
        if r["id"] == rid:
            removed = r
            store["records"].remove(r)
            break

    if removed:
        # —É–±—Ä–∞—Ç—å –∑–∞–ø–∏—Å—å –∏–∑ –≤—Å–µ—Ö –¥–Ω–µ–≤–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤
        for dk, recs in store.get("daily_records", {}).items():
            store["daily_records"][dk] = [x for x in recs if x["id"] != rid]

        # –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –±–∞–ª–∞–Ω—Å—ã
        store["balance"] = sum(x["amount"] for x in store.get("records", []))
        data["records"] = [x for x in data.get("records", []) if x["id"] != rid]
        data["overall_balance"] = sum(x["amount"] for x in data.get("records", []))

        save_data(data)  # üíæ JSON + CSV
        return True, removed
    return False, None


# -----------------------------
# ‚å®Ô∏è –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
# -----------------------------
def build_main_keyboard(day_key: str, chat_id: int | None = None):
    """–ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ –¥–Ω—è ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–æ–µ –º–µ–Ω—é –∏–∑ 5 –∫–Ω–æ–ø–æ–∫ + –æ–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫"""
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å", callback_data=f"d:{day_key}:balance"),
        types.InlineKeyboardButton("üìä –û—Ç—á—ë—Ç", callback_data=f"d:{day_key}:report"),
    )
    kb.row(
        types.InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data=f"d:{day_key}:refresh"),
        types.InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"d:{day_key}:edit_menu"),
    )
    total = fmt_num(data.get("overall_balance", 0))
    kb.add(types.InlineKeyboardButton(f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {total} ARS", callback_data=f"d:{day_key}:total"))
    return kb


def build_edit_menu_keyboard(day_key: str, chat_id=None):
    """–ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã"""
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å", callback_data=f"d:{day_key}:edit_list"),
        types.InlineKeyboardButton("üìÇ –û–±—â–∏–π CSV", callback_data=f"d:{day_key}:csv_all")
    )
    kb.row(
        types.InlineKeyboardButton("üìÖ CSV –∑–∞ –¥–µ–Ω—å", callback_data=f"d:{day_key}:csv_day"),
        types.InlineKeyboardButton("üì® –§–æ—Ä–≤–∞—Ä–¥", callback_data=f"d:{day_key}:toggle_forward")
    )
    kb.row(
        types.InlineKeyboardButton("üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å", callback_data=f"d:{day_key}:set_forward_target"),
        types.InlineKeyboardButton("‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å", callback_data=f"d:{day_key}:reset")
    )
    kb.row(
        types.InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data=f"d:{today_key()}:open"),
        types.InlineKeyboardButton("üìÜ –í—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å", callback_data=f"d:{day_key}:pick_date")
    )
    kb.row(
        types.InlineKeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ", callback_data=f"d:{day_key}:info"),
        types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:back_main")
    )
    return kb


def build_edit_keyboard_for_record(day_key: str, rid: int):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏"""
    kb = types.InlineKeyboardMarkup(row_width=1)
    kb.add(types.InlineKeyboardButton("‚úè –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é", callback_data=f"d:{day_key}:edit_manual:{rid}"))
    kb.add(types.InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å", callback_data=f"d:{day_key}:edit_delete:{rid}"))
    kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:edit_back"))
    return kb


def build_confirm_delete_keyboard(day_key: str, rid: int):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏"""
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å", callback_data=f"d:{day_key}:confirm_delete:{rid}"),
        types.InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data=f"d:{day_key}:cancel_delete")
    )
    return kb


def build_reset_confirm_keyboard(day_key: str):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–±–Ω—É–ª–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —á–∞—Ç–∞"""
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("‚úÖ –î–∞, –æ–±–Ω—É–ª–∏—Ç—å", callback_data=f"d:{day_key}:confirm_reset_all"),
        types.InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data=f"d:{day_key}:cancel_reset_all")
    )
    return kb


# -----------------------------
# üóì –ö–∞–ª–µ–Ω–¥–∞—Ä—å ¬´–ø–æ—Å–ª–µ–¥–Ω–∏–µ 31 –¥–µ–Ω—å¬ª (–∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞)
# -----------------------------
def build_last_31days_calendar():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç inline-–∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ 31 –¥–Ω—ë–º"""
    today = now_local().date()
    days = [today - timedelta(days=i) for i in range(0, 31)]
    kb = types.InlineKeyboardMarkup()
    row = []
    for idx, d in enumerate(days, start=1):
        label = d.strftime("%d/%m")
        dk = d.strftime("%Y-%m-%d")
        row.append(types.InlineKeyboardButton(text=label, callback_data=f"d:{dk}:calopen"))
        if idx % 7 == 0:
            kb.row(*row); row = []
    if row:
        kb.row(*row)
    return kb


# -----------------------------
# üñº –†–µ–Ω–¥–µ—Ä –æ–∫–Ω–∞ –¥–Ω—è (—Ç–µ–∫—Å—Ç)
# -----------------------------
def render_day_text(store: dict, day_key: str) -> str:
    """–§–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è"""
    day_records = store.get("daily_records", {}).get(day_key, [])
    daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
    daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
    overall_balance = store.get("balance", 0)

    if not day_records:
        text = (
            f"üìÖ {day_key}\n"
            f"–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å.\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥: {fmt_num(daily_income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {fmt_num(abs(daily_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall_balance)} ARS"
        )
    else:
        lines = [f"üìÖ {day_key}", "üìã –û–ø–µ—Ä–∞—Ü–∏–∏:"]
        for r in day_records[-50:]:
            sign = "+" if r["amount"] > 0 else "-"
            lines.append(f"{r['short_id']}: {sign}{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
        lines.append(
            f"\nüíµ –ü—Ä–∏—Ö–æ–¥: {fmt_num(daily_income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {fmt_num(abs(daily_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall_balance)} ARS"
        )
        text = "\n".join(lines)

    try:
        if store.get("forward_enabled"):
            tgt = store.get("forward_target_id") or OWNER_ID
            text += f"\n\nüì® –ü–µ—Ä–µ—Å—ã–ª–∫–∞: –í–∫–ª—é—á–µ–Ω–∞ ‚Üí {tgt}"
        else:
            text += f"\n\nüì® –ü–µ—Ä–µ—Å—ã–ª–∫–∞: –í—ã–∫–ª—é—á–µ–Ω–∞"
    except:
        pass
    return text


# -----------------------------
# üîÅ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞ –¥–Ω—è
# -----------------------------
def update_or_send_day_window(
    chat_id: int,
    day_key: str = None,
    create_if_missing: bool = True,
    force_new: bool = False,
    delete_target_old: bool = False,
    delete_source_old: bool = False,
    source_day_key: str | None = None
):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –æ–∫–Ω–æ –∏–ª–∏ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã"""
    day_key = day_key or today_key()
    store = get_chat_store(chat_id)

    if delete_target_old:
        delete_active_window_if_exists(chat_id, day_key)
    if delete_source_old and source_day_key and source_day_key != day_key:
        delete_active_window_if_exists(chat_id, source_day_key)

    set_current_view_day(chat_id, day_key)

    text = render_day_text(store, day_key)
    kb = build_main_keyboard(day_key, chat_id)
    active_id = get_active_window_id(chat_id, day_key)

    if not force_new and active_id:
        try:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            return
        except telebot.apihelper.ApiException as e:
            log_error(f"edit_message_text: {e}")

    if not create_if_missing and not force_new:
        return

    try:
        sent = bot.send_message(chat_id, text, reply_markup=kb)
        set_active_window(chat_id, day_key, sent.message_id)
    except Exception as e:
        log_error(f"send new window: {e}")


# -----------------------------
# üß≤ Callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (—á–∞—Å—Ç—å 1)
# -----------------------------
@bot.callback_query_handler(func=lambda c: True)
def handle_callback(call):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –Ω–∞–∂–∞—Ç–∏—è inline-–∫–Ω–æ–ø–æ–∫"""
    try:
        chat_id = call.message.chat.id
    except Exception:
        return

    data_str = call.data or ""
    if not data_str.startswith("d:"):
        update_or_send_day_window(chat_id, today_key())
        bot.answer_callback_query(call.id)
        return

    parts = data_str.split(":")
    if len(parts) < 3:
        bot.answer_callback_query(call.id)
        return

    day_key = parts[1]
    action_tail = parts[2:]
    action = action_tail[0] if action_tail else ""
    store = get_chat_store(chat_id)
    prev_day = get_current_view_day(chat_id)
    set_current_view_day(chat_id, day_key)

    # --- –ö–∞–ª–µ–Ω–¥–∞—Ä—å: –æ—Ç–∫—Ä—ã—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É ---
    if action == "calopen":
        update_or_send_day_window(
            chat_id,
            day_key,
            create_if_missing=True,
            force_new=ALWAYS_CREATE_NEW_ON_NAV,
            delete_target_old=DELETE_TARGET_OLD_WINDOW_ON_NAV,
            delete_source_old=True,
            source_day_key=prev_day
        )
        bot.answer_callback_query(call.id, f"–û—Ç–∫—Ä—ã—Ç –¥–µ–Ω—å {day_key}")
        return

    # --- –û—Ç–∫—Ä—ã—Ç—å –æ–±—ã—á–Ω—ã–π –¥–µ–Ω—å (–∫–Ω–æ–ø–∫–∏ –°–µ–≥–æ–¥–Ω—è/–¥–∞—Ç–∞) ---
    if action == "open":
        update_or_send_day_window(
            chat_id,
            day_key,
            create_if_missing=True,
            force_new=ALWAYS_CREATE_NEW_ON_NAV,
            delete_target_old=DELETE_TARGET_OLD_WINDOW_ON_NAV,
            delete_source_old=DELETE_SOURCE_WINDOW_ON_NAV,
            source_day_key=prev_day
        )
        bot.answer_callback_query(call.id, f"–û—Ç–∫—Ä—ã—Ç –¥–µ–Ω—å {day_key}")
        return

    # --- –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 31 –¥–Ω—è ---
    if action == "pick_date":
        kb = build_last_31days_calendar()
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text("üóì –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 31 –¥–µ–Ω—å):", chat_id, active_id, reply_markup=kb)
            except telebot.apihelper.ApiException as e:
                log_error(f"calendar edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id)
        return

    # --- –ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ---
    if action == "edit_menu":
        text = (
            "‚úèÔ∏è –ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n\n"
            "üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é\n"
            "üìÇ –û–±—â–∏–π CSV ‚Äî –ø–æ–ª–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç\n"
            "üìÖ CSV –∑–∞ –¥–µ–Ω—å ‚Äî —ç–∫—Å–ø–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã\n"
            "üì® –§–æ—Ä–≤–∞—Ä–¥ ‚Äî –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –ø–µ—Ä–µ—Å—ã–ª–∫—É\n"
            "üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å ‚Äî –∑–∞–¥–∞—Ç—å ID –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏\n"
            "‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞\n\n"
            "üìÖ –°–µ–≥–æ–¥–Ω—è / üìÜ –í—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å / ‚ÑπÔ∏è –ò–Ω—Ñ–æ / üîô –ù–∞–∑–∞–¥"
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"edit_menu edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key, create_if_missing=True)
        bot.answer_callback_query(call.id, "–ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚úèÔ∏è")
        return

    # --- –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –æ–∫–Ω–æ ---
    if action == "refresh":
        active_id = get_active_window_id(chat_id, day_key)
        text = render_day_text(store, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"refresh edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key, create_if_missing=True)
        bot.answer_callback_query(call.id, "–û–±–Ω–æ–≤–ª–µ–Ω–æ üîÑ")
        return

    # --- –ò–Ω—Ñ–æ ---
    if action == "info":
        info_text = (
            f"‚ÑπÔ∏è –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è {VERSION}\n\n"
            "üìå –ö–æ–º–∞–Ω–¥—ã:\n"
            "/start ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –∑–∞ —Å–µ–≥–æ–¥–Ω—è\n"
            "/view YYYY-MM-DD ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –¥–µ–Ω—å\n"
            "/prev /next ‚Äî –Ω–∞–≤–∏–≥–∞—Ü–∏—è\n"
            "/balance ‚Äî –æ—Å—Ç–∞—Ç–æ–∫ –∑–∞ –¥–µ–Ω—å\n"
            "/report ‚Äî —Å–ø–∏—Å–æ–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤\n"
            "/csv ‚Äî –æ–±—â–∏–π CSV\n"
            "/reset ‚Äî –æ–±–Ω—É–ª–µ–Ω–∏–µ —á–∞—Ç–∞\n"
            "/ping ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\n\n"
            "üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π: +500 –ó–∞—Ä–ø–ª–∞—Ç–∞ –∏–ª–∏ -150 –û–±–µ–¥\n"
            "‚öôÔ∏è –°–∏—Å—Ç–µ–º–Ω–æ: CSV, —Ñ–æ—Ä–≤–∞—Ä–¥, webhook, keep-alive."
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(info_text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"info edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id)
        return

    # --- –ë–∞–ª–∞–Ω—Å –∑–∞ –¥–µ–Ω—å ---
    if action == "balance":
        day_records = store.get("daily_records", {}).get(day_key, [])
        income = sum(r["amount"] for r in day_records if r["amount"] > 0)
        expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
        overall = store.get("balance", 0)
        text = (
            f"üìÖ {day_key}\n\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(abs(expense))} ARS\n"
            f"üí∞ –û—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall)} ARS"
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"balance edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, "–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—ë–Ω ‚úÖ")
        return

    # --- –û–±—â–∏–π –∏—Ç–æ–≥ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è ---
    if action == "total":
        all_records = data.get("records", [])
        total = data.get("overall_balance", 0)
        total_income = sum(r["amount"] for r in all_records if r["amount"] > 0)
        total_expense = sum(r["amount"] for r in all_records if r["amount"] < 0)
        text = (
            f"üìä –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è:\n\n"
            f"üíµ –û–±—â–∏–π –ø—Ä–∏—Ö–æ–¥: {fmt_num(total_income)} ARS\n"
            f"üí∏ –û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥: {fmt_num(abs(total_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(total)} ARS"
        )
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"total edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, "–û–±—â–∏–π –∏—Ç–æ–≥ üìä")
        return

    # --- –û—Ç—á—ë—Ç (—Ä–∞—Å—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å) ---
    if action == "report":
        day_records = store.get("daily_records", {}).get(day_key, [])
        expenses = [r for r in day_records if r["amount"] < 0]
        daily_expense_total = sum(abs(r["amount"]) for r in expenses)
        if not expenses:
            text = f"üìÖ {day_key}\n–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å.\nüí∏ –†–∞—Å—Ö–æ–¥: 0 ARS"
        else:
            lines = [f"üìÖ {day_key}", "üìã –†–∞—Å—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å:"]
            for r in expenses[-30:]:
                lines.append(f"{r['short_id']}: -{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
            lines.append(f"\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(daily_expense_total)} ARS")
            text = "\n".join(lines)
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            except telebot.apihelper.ApiException as e:
                log_error(f"report edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, "–û—Ç—á—ë—Ç –æ–±–Ω–æ–≤–ª—ë–Ω üìä")
        return

        # --- CSV: –æ–±—â–∏–π –∏ –¥–Ω–µ–≤–Ω–æ–π ---
    if action == "csv_all":
        try:
            export_to_csv(data)
            with open(CSV_FILE, "rb") as f:
                sent = bot.send_document(chat_id, f, caption="üìÇ –ü–æ–ª–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç: data.csv")

            # üß© –ï—Å–ª–∏ —Ñ–∞–π–ª –≤—ã—Å–ª–∞–Ω –≤–ª–∞–¥–µ–ª—å—Ü—É ‚Äî —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ –Ω–æ–≤—ã–º –±—ç–∫–∞–ø–æ–º
            if OWNER_ID and chat_id == int(OWNER_ID):
                meta = {
                    "message_id": sent.message_id,
                    "timestamp": datetime.now(TZ).isoformat(timespec="seconds")
                }
                _save_csv_meta(meta)
                log_info("‚úÖ –ù–æ–≤—ã–π CSV –Ω–∞–∑–Ω–∞—á–µ–Ω –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π Telegram-–±—ç–∫–∞–ø.")

            bot.answer_callback_query(call.id, "CSV –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω üìÅ")

        except Exception as e:
            send_temp_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ CSV: {e}")
            bot.answer_callback_query(call.id)
        return

    if action == "csv_day":
        filename = export_day_csv(chat_id, day_key)
        if not filename:
            send_temp_message(chat_id, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å CSV –∑–∞ –¥–µ–Ω—å.")
            bot.answer_callback_query(call.id); return
        try:
            with open(filename, "rb") as f:
                bot.send_document(chat_id, f, caption=f"üìÖ CSV –∑–∞ –¥–µ–Ω—å: {filename}")
            bot.answer_callback_query(call.id, f"CSV –∑–∞ –¥–µ–Ω—å {day_key} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")
        except Exception as e:
            send_temp_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ {filename}: {e}")
            bot.answer_callback_query(call.id)
        return
    # --- –ü–µ—Ä–µ—Å—ã–ª–∫–∞: –≤–∫–ª/–≤—ã–∫–ª ---
    if action == "toggle_forward":
        store["forward_enabled"] = not store.get("forward_enabled", False)
        save_data(data)
        status = "–≤–∫–ª—é—á–µ–Ω–∞ ‚úÖ" if store["forward_enabled"] else "–≤—ã–∫–ª—é—á–µ–Ω–∞ ‚ùå"
        update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, f"–ü–µ—Ä–µ—Å—ã–ª–∫–∞ {status}")
        return

    # --- –ü–µ—Ä–µ—Å—ã–ª–∫–∞: –∑–∞–¥–∞—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è ---
    if action == "set_forward_target":
        try:
            bot.answer_callback_query(call.id)
            sent = send_temp_message(chat_id, "–í–≤–µ–¥–∏—Ç–µ ID (–º–æ–∂–Ω–æ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –¥–ª—è —á–∞—Ç–æ–≤) –∏–ª–∏ 0 –¥–ª—è —Å–±—Ä–æ—Å–∞:", delay=25)
            if sent:
                bot.register_next_step_handler(sent, lambda m: process_forward_target(m, day_key))
        except Exception as e:
            log_error(f"set_forward_target: {e}")
            bot.answer_callback_query(call.id, "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—Ä–æ—Å–∏—Ç—å ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è.")
        return

    # --- –°–±—Ä–æ—Å (–ø–æ–¥—Å–∫–∞–∑–∫–∞) ---
    if action == "reset":
        update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id, "–î–ª—è –æ–±–Ω—É–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /reset")
        return

    # --- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –≤–æ–∑–≤—Ä–∞—Ç—ã –≤ –≥–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ ---
    if action in ("back_main", "edit_back", "noop", "info_ok"):
        update_or_send_day_window(chat_id, day_key)
        bot.answer_callback_query(call.id)
        return

    # --- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π ---
    if action == "edit_list":
        day_records = store.get("daily_records", {}).get(day_key, [])
        if not day_records:
            text = f"üìÖ {day_key}\n–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å."
            active_id = get_active_window_id(chat_id, day_key)
            if active_id:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))
            bot.answer_callback_query(call.id, "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
            return

        lines = [f"üìÖ {day_key}", "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"]
        kb = types.InlineKeyboardMarkup(row_width=1)
        for r in reversed(day_records[-20:]):
            sign = "+" if r["amount"] > 0 else "-"
            label = f"{r['short_id']}: {sign}{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}"
            kb.add(types.InlineKeyboardButton(label, callback_data=f"d:{day_key}:rec:{r['id']}"))
        kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:back_main"))

        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text("\n".join(lines), chat_id, active_id, reply_markup=kb)
            except telebot.apihelper.ApiException as e:
                log_error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —Å–ø–∏—Å–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
        bot.answer_callback_query(call.id)
        return

    # --- –û—Ç–∫—Ä—ã—Ç—å –∑–∞–ø–∏—Å—å ---
    if action == "rec" and len(action_tail) >= 2:
        try:
            rid = int(action_tail[1])
        except:
            bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID"); return

        day_records = store.get("daily_records", {}).get(day_key, [])
        rec = next((r for r in day_records if r["id"] == rid), None)
        if not rec:
            bot.answer_callback_query(call.id, "–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"); return

        sign = "+" if rec["amount"] > 0 else "-"
        text = f"–ó–∞–ø–∏—Å—å {rec['short_id']}\n{sign}{fmt_num(abs(rec['amount']))} ‚Äî {rec.get('note','')}\n–î–æ–±–∞–≤–ª–µ–Ω–∞: {rec.get('timestamp')}"
        kb = build_edit_keyboard_for_record(day_key, rid)

        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            except telebot.apihelper.ApiException as e:
                log_error(f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –¥–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏: {e}")
        bot.answer_callback_query(call.id)
        return

    # --- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä—É—á–Ω—É—é (–≤ —Ç–æ–º –∂–µ –æ–∫–Ω–µ) ---
    if action == "edit_manual" and len(action_tail) >= 2:
        try:
            rid = int(action_tail[1])
        except:
            bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID"); return

        store["edit_wait"] = f"change_value:{day_key}"
        store["edit_target"] = rid
        save_data(data)

        text = (
            f"‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ R{rid}\n\n"
            "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—É–º–º—É –∏ –∑–∞–º–µ—Ç–∫—É:\n"
            "+500 –ó–∞—Ä–ø–ª–∞—Ç–∞  –∏–ª–∏  ^+^500^ –ó–∞—Ä–ø–ª–∞—Ç–∞  –∏–ª–∏  ^-^150^ –û–±–µ–¥"
        )
        kb = types.InlineKeyboardMarkup(row_width=1)
        kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:edit_list"))

        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            except telebot.apihelper.ApiException as e:
                log_error(f"edit_manual edit: {e}")
        else:
            update_or_send_day_window(chat_id, day_key, create_if_missing=True)

        bot.answer_callback_query(call.id, "–û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—É–º–º—ã ‚úèÔ∏è")
        return

    # --- –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ) ---
    if action == "edit_delete" and len(action_tail) >= 2:
        try:
            rid = int(action_tail[1])
        except:
            bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID"); return

        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            try:
                bot.edit_message_text(
                    f"‚ùó –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ R{rid}:",
                    chat_id,
                    active_id,
                    reply_markup=build_confirm_delete_keyboard(day_key, rid)
                )
            except telebot.apihelper.ApiException as e:
                log_error(f"edit_delete confirm edit: {e}")
        bot.answer_callback_query(call.id)
        return

    # --- –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ (–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ) ---
    if action == "confirm_delete" and len(action_tail) >= 2:
        try:
            rid = int(action_tail[1])
        except:
            bot.answer_callback_query(call.id, "–ù–µ–≤–µ—Ä–Ω—ã–π ID"); return

        success, _ = delete_record_in_chat(chat_id, rid, user=call.from_user)
        text = "‚úÖ –ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞" if success else "‚ö†Ô∏è –ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))

        bot.answer_callback_query(call.id, "–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞" if success else "–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return

    # --- –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ (–æ—Ç–º–µ–Ω–∞) ---
    if action == "cancel_delete":
        active_id = get_active_window_id(chat_id, day_key)
        if active_id:
            text = "‚úèÔ∏è –ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
            bot.edit_message_text(text, chat_id, active_id, reply_markup=build_edit_menu_keyboard(day_key, chat_id))
        bot.answer_callback_query(call.id, "–û—Ç–º–µ–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è")
        return
    
    # --- –û–±–Ω—É–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ) ---
    if action == "confirm_reset_all":
        try:
            # —É–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞
            cid = str(chat_id)
            if cid in data.get("chats", {}):
                data["chats"].pop(cid, None)
            # –ø–µ—Ä–µ—Å—á—ë—Ç –æ–±—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞
            data["records"] = [
                r for r in data.get("records", [])
                if str(r.get("owner")) != cid
            ]
            data["overall_balance"] = sum(x["amount"] for x in data.get("records", []))
            save_data(data)

            # —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —Å–±—Ä–æ—Å–µ
            text = "‚öôÔ∏è –í—Å–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω—É–ª–µ–Ω—ã."
            active_id = get_active_window_id(chat_id, day_key)
            if active_id:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(today_key(), chat_id))
            else:
                bot.send_message(chat_id, text)

            bot.answer_callback_query(call.id, "–î–∞–Ω–Ω—ã–µ –æ–±–Ω—É–ª–µ–Ω—ã ‚úÖ")
        except Exception as e:
            log_error(f"confirm_reset_all: {e}")
            send_temp_message(chat_id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω—É–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.")
            bot.answer_callback_query(call.id, "–û—à–∏–±–∫–∞ –æ–±–Ω—É–ª–µ–Ω–∏—è")
        return
    
    
    bot.answer_callback_query(call.id)
    return


# -----------------------------
# üë§ –†—É—á–Ω–æ–π –≤–≤–æ–¥ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏
# -----------------------------
def process_forward_target(message, day_key_for_refresh=None):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–≤–æ–¥ ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏ (–∏–ª–∏ 0 –¥–ª—è —Å–±—Ä–æ—Å–∞)"""
    try:
        chat_id = message.chat.id
        store = get_chat_store(chat_id)
        text = (message.text or "").strip()

        if text == "0":
            store["forward_target_id"] = None
            save_data(data)
            send_temp_message(chat_id, "‚úÖ –ü–æ–ª—É—á–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Å—ã–ª–∫–∏ —Å–±—Ä–æ—à–µ–Ω (–±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è OWNER_ID, –µ—Å–ª–∏ –æ–Ω –∑–∞–¥–∞–Ω).")
            update_or_send_day_window(chat_id, day_key_for_refresh or today_key())
            return

        if not (text.startswith("-") or text.isdigit()):
            send_temp_message(chat_id, "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID. –ü—Ä–∏–º–µ—Ä: -1001234567890\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ 0 –¥–ª—è —Å–±—Ä–æ—Å–∞.")
            return

        try:
            target = int(text)
        except Exception:
            send_temp_message(chat_id, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å ID. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
            return

        store["forward_target_id"] = target
        save_data(data)
        send_temp_message(chat_id, f"‚úÖ –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –∏–¥—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å ID {target}.")
        update_or_send_day_window(chat_id, day_key_for_refresh or today_key())

    except Exception as e:
        log_error(f"process_forward_target: {e}")
        try:
            send_temp_message(message.chat.id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.")
        except:
            pass


# -----------------------------
# üî¢ Regex –∏ –ø–∞—Ä—Å–µ—Ä —Å—É–º–º
# -----------------------------
num_re = re.compile(r'(\^[+-]\^[0-9]+|\^[+-]?[0-9]+\^|[+-]?\s*\d+)')

def parse_amount_token(token: str) -> int:
    """–†–∞–∑–±–∏—Ä–∞–µ—Ç —Å—É–º–º—É —Å –ª—é–±—ã–º–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á (–ø—Ä–æ–±–µ–ª, —Ç–æ—á–∫–∞, –∑–∞–ø—è—Ç–∞—è, —Ç–∏—Ä–µ, –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ, –∫–∞–≤—ã—á–∫–∏)"""
    t = token.strip()
    # —É–±–∏—Ä–∞–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
    for ch in ["^", " ", ".", ",", "-", "_", "'", '"']:
        t = t.replace(ch, "")
    # –¥–æ–ø—É—Å–∫–∞–µ–º –∑–Ω–∞–∫ –≤ –Ω–∞—á–∞–ª–µ
    if not t:
        return 0
    if t[0] == "+":
        return int(t[1:])
    if t[0] == "-":
        return -int(t[1:])
    # –µ—Å–ª–∏ –∑–Ω–∞–∫ –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî —Å—á–∏—Ç–∞–µ–º —Ä–∞—Å—Ö–æ–¥–æ–º
    return -int(t)

# -----------------------------
# üß∞ –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞
# -----------------------------
@bot.message_handler(commands=["start", "info"])
def cmd_start(msg):
    """/start ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è"""
    chat_id = msg.chat.id
    update_or_send_day_window(
        chat_id, today_key(),
        create_if_missing=True, force_new=True,
        delete_target_old=True, delete_source_old=False
    )


@bot.message_handler(commands=["help"])
def cmd_help(msg):
    """/help ‚Äî –∫—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ —Ñ–æ—Ä–º–∞—Ç–∞–º –∏ –∫–æ–º–∞–Ω–¥–∞–º"""
    chat_id = msg.chat.id
    send_temp_message(
        chat_id,
        "üìò –î–æ–±–∞–≤–ª—è–π—Ç–µ –∑–∞–ø–∏—Å–∏ —Ç–∞–∫: +500 –ó–∞—Ä–ø–ª–∞—Ç–∞ –∏–ª–∏ -150 –û–±–µ–¥.\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/start /view YYYY-MM-DD /prev /next /balance /report /csv /reset /ping /help",
        delay=15
    )


@bot.message_handler(commands=["ping"])
def cmd_ping(msg):
    """/ping ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"""
    send_temp_message(msg.chat.id, "PONG ‚Äî –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ")


@bot.message_handler(commands=["view"])
def cmd_view(msg):
    """/view YYYY-MM-DD ‚Äî –æ—Ç–∫—Ä—ã—Ç—å —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É"""
    chat_id = msg.chat.id
    parts = (msg.text or "").split()
    if len(parts) < 2:
        send_temp_message(chat_id, "–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É: /view YYYY-MM-DD"); return
    d = parse_date_key(parts[1])
    if not d:
        send_temp_message(chat_id, "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ü—Ä–∏–º–µ—Ä: /view 2025-11-02"); return
    dk = d.strftime("%Y-%m-%d")
    prev_day = get_current_view_day(chat_id)
    update_or_send_day_window(
        chat_id, dk,
        create_if_missing=True, force_new=True,
        delete_target_old=True, delete_source_old=DELETE_SOURCE_WINDOW_ON_NAV,
        source_day_key=prev_day
    )


@bot.message_handler(commands=["prev"])
def cmd_prev(msg):
    """/prev ‚Äî –ø–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –¥–Ω—é"""
    chat_id = msg.chat.id
    current = get_current_view_day(chat_id)
    prev_key = shift_date_key(current, -1)
    update_or_send_day_window(
        chat_id, prev_key,
        create_if_missing=True, force_new=True,
        delete_target_old=True, delete_source_old=DELETE_SOURCE_WINDOW_ON_NAV,
        source_day_key=current
    )


@bot.message_handler(commands=["next"])
def cmd_next(msg):
    """/next ‚Äî –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–Ω—é"""
    chat_id = msg.chat.id
    current = get_current_view_day(chat_id)
    next_key = shift_date_key(current, +1)
    update_or_send_day_window(
        chat_id, next_key,
        create_if_missing=True, force_new=True,
        delete_target_old=True, delete_source_old=DELETE_SOURCE_WINDOW_ON_NAV,
        source_day_key=current
    )


@bot.message_handler(commands=["balance"])
def cmd_balance(msg):
    """/balance ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ –∑–∞ —Å–µ–≥–æ–¥–Ω—è"""
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    dk = today_key()
    day_records = store.get("daily_records", {}).get(dk, [])
    inc = sum(r["amount"] for r in day_records if r["amount"] > 0)
    exp = sum(r["amount"] for r in day_records if r["amount"] < 0)
    bal = store.get("balance", 0)
    text = (
        f"üìÖ {dk}\n\n"
        f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(bal)} ARS\n"
        f"üíµ –ü—Ä–∏—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(inc)} ARS\n"
        f"üí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(abs(exp))} ARS"
    )
    bot.send_message(chat_id, text)


@bot.message_handler(commands=["report"])
def cmd_report(msg):
    """/report ‚Äî —Å–ø–∏—Å–æ–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è"""
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    dk = today_key()
    day_records = store.get("daily_records", {}).get(dk, [])
    expenses = [r for r in day_records if r["amount"] < 0]
    if not expenses:
        bot.send_message(chat_id, f"üìÖ {dk}\n–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è.\nüí∏ –†–∞—Å—Ö–æ–¥: 0 ARS"); return
    lines = [f"üìÖ {dk}", "üìã –†–∞—Å—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å:"]
    for r in expenses[-30:]:
        lines.append(f"{r['short_id']}: -{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
    lines.append(f"\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(sum(abs(r['amount']) for r in expenses))} ARS")
    bot.send_message(chat_id, "\n".join(lines))


@bot.message_handler(commands=["csv"])
def cmd_csv(msg):
    """/csv ‚Äî —ç–∫—Å–ø–æ—Ä—Ç –æ–±—â–µ–≥–æ CSV"""
    chat_id = msg.chat.id
    try:
        export_to_csv(data)
        with open(CSV_FILE, "rb") as f:
            bot.send_document(chat_id, f, caption="üìÇ –ü–æ–ª–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç: data.csv")
    except Exception as e:
        send_temp_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ CSV: {e}")


@bot.message_handler(commands=["reset"])
def cmd_reset(msg):
    """/reset ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–±–Ω—É–ª–µ–Ω–∏—è (inline)"""
    chat_id = msg.chat.id
    dk = today_key()
    active_id = get_active_window_id(chat_id, dk)
    if active_id:
        try:
            bot.edit_message_text(
                "‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞?",
                chat_id,
                active_id,
                reply_markup=build_reset_confirm_keyboard(dk)
            )
        except Exception as e:
            log_error(f"/reset edit_message_text: {e}")
    else:
        bot.send_message(
            chat_id,
            "‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞?",
            reply_markup=build_reset_confirm_keyboard(dk)
        )


# -----------------------------
# üì® –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
# -----------------------------
@bot.message_handler(func=lambda m: True)
def handle_message(msg):
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞"""
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    wait_action = store.get("edit_wait")

    # 1) –†—É—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
    if wait_action and wait_action.startswith("change_value"):
        day_key = today_key()
        if ":" in wait_action:
            _, day_key = wait_action.split(":", 1)

        rid = store.get("edit_target")
        if not rid:
            store["edit_wait"] = None
            store["edit_target"] = None
            save_data(data)
            return

        parts = (msg.text or "").strip().split(" ", 1)
        try:
            amount_token = parts[0]
            amount = parse_amount_token(amount_token)
            note = parts[1] if len(parts) > 1 else ""
            success, _ = update_record_in_chat(chat_id, rid, amount, note, user=msg.from_user)

            # —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
            store["edit_wait"] = None
            store["edit_target"] = None
            save_data(data)

            # –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –æ–∫–Ω–æ
            active_id = get_active_window_id(chat_id, day_key)
            text = render_day_text(store, day_key)
            if active_id:
                bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(day_key, chat_id))
            else:
                update_or_send_day_window(chat_id, day_key)

            send_temp_message(chat_id, f"‚úÖ –ó–∞–ø–∏—Å—å R{rid} {'–∏–∑–º–µ–Ω–µ–Ω–∞' if success else '–Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}")

        except Exception as e:
            log_error(f"edit manual: {e}")
            send_temp_message(chat_id, "‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞. –ü—Ä–∏–º–µ—Ä: +500 –ó–∞—Ä–ø–ª–∞—Ç–∞ –∏–ª–∏ -150 –û–±–µ–¥", delay=10)
        return
    
    # ‚úÖ 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ (–º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π –≤–≤–æ–¥)
    if not msg.text:
        return

    # –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è (–¥–æ—Ö–æ–¥ –∏–ª–∏ —Ä–∞—Å—Ö–æ–¥)
    lines = (msg.text or "").strip().split("\n")
    for line in lines:
        line = line.strip()
        if not line:
            continue
        m = re.search(num_re, line)
        if not m:
            continue
        try:
            raw = m.group(0)
            raw_clean = raw.replace("^", "").replace(" ", "")
            amount = parse_amount_token(raw_clean)
            note = line.replace(m.group(0), "").strip()

            add_record_to_chat(chat_id, amount, note, msg.from_user.id)

        except Exception as e:
            log_error(f"auto-add record: {e}")
            send_temp_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏: {line}")

    # –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª—è–µ–º –æ–∫–Ω–æ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
    dk = today_key()
    active_id = get_active_window_id(chat_id, dk)
    if active_id:
        text = render_day_text(store, dk)
        bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(dk, chat_id))
    else:
        update_or_send_day_window(chat_id, dk)

    send_temp_message(chat_id, "‚úÖ –ó–∞–ø–∏—Å–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã")
    return
    
    # 3) –ò–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞
    send_temp_message(chat_id, "üìò –ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—É–º–º—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ +500 –ó–∞–º–µ—Ç–∫–∞. /help", delay=10)

# -----------------------------
# üß© –û—Ç–ª–∞–¥–∫–∞: –ø–æ–∫–∞–∑–∞—Ç—å ¬´–≤—Å—ë, —á—Ç–æ –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º¬ª
# -----------------------------
# -----------------------------
# üß© –û—Ç–ª–∞–¥–∫–∞: –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë, —á—Ç–æ –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º
# -----------------------------
@bot.message_handler(content_types=["document"])
def show_raw_message(msg):
    """–ö–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É message"""
    import json
    try:
        raw = msg.json if hasattr(msg, "json") else msg.__dict__
        text = json.dumps(raw, ensure_ascii=False, indent=2)
        # —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–∫–∏ "message too long" ‚Äî –¥–µ–ª–∏–º –Ω–∞ —á–∞—Å—Ç–∏
        parts = [text[i:i+3500] for i in range(0, len(text), 3500)]
        for chunk in parts:
            bot.send_message(msg.chat.id, f"```json\n{chunk}\n```", parse_mode="Markdown")
    except Exception as e:
        bot.send_message(msg.chat.id, f"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ raw: {e}")
# -----------------------------
# üåê Flask webhook
# -----------------------------
@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram —á–µ—Ä–µ–∑ webhook"""
    try:
        update = telebot.types.Update.de_json(request.get_data().decode("utf-8"))
        bot.process_new_updates([update])
    except Exception as e:
        log_error(f"webhook error: {e}")
    return "OK", 200


@app.route("/", methods=["GET"])
def index():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    return f"–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è {VERSION} —Ä–∞–±–æ—Ç–∞–µ—Ç", 200


# -----------------------------
# üü¢ Keep-alive (—Å–∞–º–æ–ø–∏–Ω–≥ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞)
# -----------------------------
def keep_alive_task():
    """–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ keep-alive: –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –ø–∏–Ω–≥ self –∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –≤–ª–∞–¥–µ–ª—å—Ü–∞"""
    while True:
        try:
            log_info("Keep-alive: –ø–∏–Ω–≥ self –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞.")
            if APP_URL:
                try:
                    resp = requests.get(APP_URL, timeout=10)
                    log_info(f"Keep-alive self-ping {APP_URL} -> {getattr(resp, 'status_code', '?')}")
                except Exception as e:
                    log_error(f"Keep-alive self-ping error: {e}")

            if KEEP_ALIVE_SEND_TO_OWNER and OWNER_ID:
                try:
                    tgt = int(OWNER_ID)
                    send_temp_message(
                        tgt,
                        f"üü¢ Keep-alive: –±–æ—Ç {VERSION} –∞–∫—Ç–∏–≤–µ–Ω.\n{now_local().isoformat(timespec='seconds')}"
                    )
                except Exception as e:
                    log_error(f"Keep-alive notify owner: {e}")

        except Exception as e:
            log_error(f"Keep-alive loop: {e}")

        time.sleep(max(10, KEEP_ALIVE_INTERVAL_SECONDS))


def start_keep_alive_thread():
    """–ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞ keep-alive"""
    threading.Thread(target=keep_alive_task, daemon=True).start()


# -----------------------------
# üóì –ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞ –Ω–æ–≤–æ–≥–æ –¥–Ω—è (–ø–æ –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏—é —Å–ª–µ–¥—É—é—â–µ–π –¥–∞—Ç—ã)
# -----------------------------
def schedule_daily_window_creation():
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–π –¥–∞—Ç—ã"""
    def task():
        last_day = today_key()
        while True:
            try:
                time.sleep(60)
                current_day = today_key()
                if current_day != last_day:
                    for chat_id_str in list(data.get("chats", {}).keys()):
                        try:
                            chat_id = int(chat_id_str)
                        except:
                            continue
                        try:
                            update_or_send_day_window(
                                chat_id, current_day,
                                create_if_missing=True, force_new=True,
                                delete_target_old=True, delete_source_old=False
                            )
                        except Exception as e:
                            log_error(f"daily new window {chat_id}: {e}")
                    last_day = current_day
            except Exception as e:
                log_error(f"daily loop: {e}")
                time.sleep(5)

    threading.Thread(target=task, daemon=True).start()


# -----------------------------
# ü™ù Webhook –∏ –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# -----------------------------
def set_webhook():
    """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç webhook –¥–ª—è Telegram"""
    url = f"{APP_URL}/{TOKEN}"
    try:
        bot.remove_webhook()
        time.sleep(0.5)
        bot.set_webhook(url=url)
        log_info(f"Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {url}")
    except Exception as e:
        log_error(f"set_webhook: {e}")


if __name__ == "__main__":
    """–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ ‚Äî –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    log_chat("üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –ø–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è CSV...")
    # üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ Telegram CSV –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    restore_from_telegram_backup()

    # ü™ù Webhook
    set_webhook()
    log_chat("ü™ù Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ.")

    # üóì –ü–ª–∞–Ω–æ–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –¥–Ω—è
    schedule_daily_window_creation()

    # üïí –§–æ–Ω–æ–≤–æ–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 3 —á–∞—Å–∞
    threading.Thread(target=auto_update_task, daemon=True).start()

    # üü¢ Keep-alive
    start_keep_alive_thread()

    log_info(f"–ë–æ—Ç –≤–µ—Ä—Å–∏–∏ {VERSION} –∑–∞–ø—É—â–µ–Ω")

    try:
        if OWNER_ID:
            bot.send_message(int(OWNER_ID), f"‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! (–≤–µ—Ä—Å–∏—è {VERSION})")
    except Exception as e:
        log_error(f"send startup msg: {e}")

    app.run(host="0.0.0.0", port=PORT)