import telebot
from telebot import types
import json
import os
from datetime import date

# ğŸ”¹ Ğ£ĞºĞ°Ğ¶Ğ¸ Ñ‚Ğ¾ĞºĞµĞ½
TOKEN = os.getenv("BOT_TOKEN") or "Ğ’Ğ¡Ğ¢ĞĞ’Ğ¬_Ğ¡Ğ®Ğ”Ğ_Ğ¡Ğ’ĞĞ™_Ğ¢ĞĞšĞ•Ğ"

bot = telebot.TeleBot(TOKEN)
DATA_FILE = "finance_data.json"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ / ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if os.path.exists(DATA_FILE):
    with open(DATA_FILE, "r", encoding="utf-8") as f:
        finance_data = json.load(f)
else:
    finance_data = {}

def save_data():
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(finance_data, f, ensure_ascii=False, indent=2)

def today():
    return str(date.today())

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def get_summary(user_id, day=None):
    user_id = str(user_id)
    if day is None:
        day = today()
    user_data = finance_data.get(user_id, {})
    day_data = user_data.get(day, {"income": 0, "expense": 0, "operations": []})

    income = day_data.get("income", 0)
    expense = abs(day_data.get("expense", 0))

    all_time = sum([
        (d.get("income", 0) + d.get("expense", 0))
        for d in user_data.values()
    ]) if user_data else 0

    operations = day_data.get("operations", [])
    ops_text = "\n".join(operations) if operations else "ĞĞµÑ‚ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ."

    text = (
        f"ğŸ“… <b>{day}</b>\n"
        f"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
        f"{ops_text}\n"
        f"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
        f"ğŸ’° ĞŸÑ€Ğ¸Ñ…Ğ¾Ğ´ Ğ´Ğ½Ñ: <b>{income:.2f}</b>\n"
        f"ğŸ’¸ Ğ Ğ°ÑÑ…Ğ¾Ğ´ Ğ´Ğ½Ñ: <b>{expense:.2f}</b>\n"
        f"ğŸ“Š ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº: <b>{all_time:.2f}</b>"
    )
    return text

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñ‹
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def get_main_keyboard(day):
    kb = types.InlineKeyboardMarkup()
    kb.row(
        types.InlineKeyboardButton("âœï¸ Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ´ĞµĞ½ÑŒ", callback_data=f"edit_{day}"),
        types.InlineKeyboardButton("ğŸ“… Ğ”Ñ€ÑƒĞ³Ğ¾Ğ¹ Ğ´ĞµĞ½ÑŒ", callback_data="select_day")
    )
    return kb

def get_edit_keyboard(day):
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton("â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ", callback_data=f"add_{day}"))
    kb.add(types.InlineKeyboardButton("ğŸ—‘ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ", callback_data=f"delete_{day}"))
    kb.add(types.InlineKeyboardButton("â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data=f"back_{day}"))
    return kb

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° /start
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@bot.message_handler(commands=["start"])
def start(message):
    bot.reply_to(
        message,
        "ğŸ‘‹ ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ­Ñ‚Ğ¾ Ğ±Ğ¾Ñ‚ ÑƒÑ‡Ñ‘Ñ‚Ğ° Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ².\n\n"
        "ğŸ“— ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ²Ğ²Ğ¾Ğ´Ğ°:\n"
        "`-1000 Ñ…Ğ»ĞµĞ±` â†’ Ñ€Ğ°ÑÑ…Ğ¾Ğ´\n"
        "`1000` â†’ Ñ€Ğ°ÑÑ…Ğ¾Ğ´\n"
        "`+500 Ğ·Ğ¿` â†’ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´\n\n"
        "Ğ‘Ğ¾Ñ‚ Ğ¿Ğ¾ĞºĞ°Ğ¶ĞµÑ‚ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¸ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹.",
        parse_mode="Markdown"
    )

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@bot.message_handler(func=lambda msg: True)
def handle_message(message):
    user_id = str(message.from_user.id)
    text = message.text.strip()

    num_str = ""
    for ch in text:
        if ch in "+-0123456789.":
            num_str += ch
        else:
            break

    if not num_str:
        return

    try:
        number = float(num_str)
    except:
        return

    first_char = num_str[0]
    if first_char == "+":
        is_income = True
    else:
        is_income = False

    if user_id not in finance_data:
        finance_data[user_id] = {}
    if today() not in finance_data[user_id]:
        finance_data[user_id][today()] = {"income": 0, "expense": 0, "operations": []}

    note = text
    day_data = finance_data[user_id][today()]

    if is_income:
        day_data["income"] += abs(number)
        op_text = f"ğŸ’° +{abs(number)} {note[len(num_str):].strip()}"
    else:
        day_data["expense"] -= abs(number)
        op_text = f"ğŸ’¸ -{abs(number)} {note[len(num_str):].strip()}"

    day_data["operations"].append(op_text)
    save_data()

    summary_text = get_summary(user_id)
    sent = bot.send_message(message.chat.id, summary_text, parse_mode="HTML", reply_markup=get_main_keyboard(today()))

    try:
        old_id = day_data.get("prev_msg")
        if old_id:
            bot.delete_message(message.chat.id, old_id)
        day_data["prev_msg"] = sent.message_id
        save_data()
    except:
        pass

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@bot.callback_query_handler(func=lambda call: call.data.startswith("edit_"))
def edit_day(call):
    day = call.data.split("_")[1]
    bot.edit_message_text(
        f"ğŸ›  Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ´Ğ»Ñ {day}:",
        call.message.chat.id,
        call.message.message_id,
        reply_markup=get_edit_keyboard(day)
    )

@bot.callback_query_handler(func=lambda call: call.data.startswith("back_"))
def back_to_summary(call):
    day = call.data.split("_")[1]
    summary_text = get_summary(call.from_user.id, day)
    bot.edit_message_text(
        summary_text,
        call.message.chat.id,
        call.message.message_id,
        parse_mode="HTML",
        reply_markup=get_main_keyboard(day)
    )

@bot.callback_query_handler(func=lambda call: call.data.startswith("add_"))
def add_operation(call):
    day = call.data.split("_")[1]
    msg = bot.send_message(call.message.chat.id, f"âœï¸ Ğ’Ğ²ĞµĞ´Ğ¸ Ğ½Ğ¾Ğ²ÑƒÑ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ {day} (Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: `+500 Ğ¿Ğ¾Ğ´Ğ°Ñ€Ğ¾Ğº`)", parse_mode="Markdown")
    bot.register_next_step_handler(msg, lambda m: add_op_step(m, day))

def add_op_step(message, day):
    user_id = str(message.from_user.id)
    text = message.text.strip()

    num_str = ""
    for ch in text:
        if ch in "+-0123456789.":
            num_str += ch
        else:
            break

    try:
        number = float(num_str)
    except:
        bot.reply_to(message, "âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ ÑÑƒĞ¼Ğ¼Ñƒ.")
        return

    first_char = num_str[0]
    is_income = first_char == "+"
    if user_id not in finance_data:
        finance_data[user_id] = {}
    if day not in finance_data[user_id]:
        finance_data[user_id][day] = {"income": 0, "expense": 0, "operations": []}

    day_data = finance_data[user_id][day]
    note = text[len(num_str):].strip()

    if is_income:
        day_data["income"] += abs(number)
        op_text = f"ğŸ’° +{abs(number)} {note}"
    else:
        day_data["expense"] -= abs(number)
        op_text = f"ğŸ’¸ -{abs(number)} {note}"

    day_data["operations"].append(op_text)
    save_data()

    bot.send_message(message.chat.id, f"âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾: {op_text}")
    summary_text = get_summary(user_id, day)
    bot.send_message(message.chat.id, summary_text, parse_mode="HTML", reply_markup=get_main_keyboard(day))

@bot.callback_query_handler(func=lambda call: call.data.startswith("delete_"))
def delete_operation(call):
    day = call.data.split("_")[1]
    user_id = str(call.from_user.id)
    day_data = finance_data.get(user_id, {}).get(day, {})
    ops = day_data.get("operations", [])

    if not ops:
        bot.answer_callback_query(call.id, "ĞĞµÑ‚ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ.")
        return

    kb = types.InlineKeyboardMarkup()
    for i, op in enumerate(ops):
        kb.add(types.InlineKeyboardButton(f"âŒ {op}", callback_data=f"delop_{day}_{i}"))
    kb.add(types.InlineKeyboardButton("â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data=f"edit_{day}"))

    bot.edit_message_text(
        "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ:",
        call.message.chat.id,
        call.message.message_id,
        reply_markup=kb
    )

@bot.callback_query_handler(func=lambda call: call.data.startswith("delop_"))
def del_operation(call):
    _, day, idx = call.data.split("_")
    idx = int(idx)
    user_id = str(call.from_user.id)

    ops = finance_data[user_id][day]["operations"]
    op_text = ops.pop(idx)

    # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑƒĞ¼Ğ¼Ñ‹
    if op_text.startswith("ğŸ’°"):
        amount = float(op_text.split()[1].replace("+", ""))
        finance_data[user_id][day]["income"] -= amount
    elif op_text.startswith("ğŸ’¸"):
        amount = float(op_text.split()[1].replace("-", ""))
        finance_data[user_id][day]["expense"] += amount

    save_data()

    bot.answer_callback_query(call.id, f"Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾: {op_text}")
    summary_text = get_summary(user_id, day)
    bot.edit_message_text(
        summary_text,
        call.message.chat.id,
        call.message.message_id,
        parse_mode="HTML",
        reply_markup=get_main_keyboard(day)
    )

print("âœ… Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½...")
bot.polling(non_stop=True)
