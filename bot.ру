# 9.8.6 –ø–æ—Å–ª–µ–¥ ‚Äî —Å keep-alive –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞
# ============================================
# –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è 9.8.6
# –û–±–Ω–æ–≤–ª–µ–Ω–æ: –ø–æ–¥–º–µ–Ω—é "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" —Å–æ–¥–µ—Ä–∂–∏—Ç CSV, –§–æ—Ä–≤–∞—Ä–¥, –ü–æ–ª—É—á–∞—Ç–µ–ª—å, –û–±–Ω—É–ª–∏—Ç—å, –ù–∞–∑–∞–¥
# –î–æ–±–∞–≤–ª–µ–Ω–æ: keep-alive (–ø–∏–Ω–≥ OWNER_ID –∏ self-ping)
# ============================================

import os
import json
import csv
import logging
import re
import threading
import time
from datetime import datetime
from zoneinfo import ZoneInfo

import requests
import telebot
from flask import Flask, request
from telebot import types

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–Ω–µ –º–µ–Ω—è–π, –µ—Å–ª–∏ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏) ---
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")  # —Å—Ç—Ä–æ–∫–∞ —Å —á–∏—Å–ª–æ–º –∏–ª–∏ None
APP_URL = os.getenv("APP_URL", "https://yourapp.onrender.com")
TZ = ZoneInfo("America/Argentina/Catamarca")
DATA_FILE = "data.json"
CSV_FILE = "data.csv"
LOG_FILE = "log.txt"
PORT = int(os.environ.get("PORT", 5000))
VERSION = "9.8.6"

# Keep-alive –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
KEEP_ALIVE_INTERVAL_SECONDS = int(os.getenv("KEEP_ALIVE_INTERVAL_SECONDS", 12 * 60))  # –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ? –º–∏–Ω—É—Ç
KEEP_ALIVE_SEND_TO_OWNER = True  # –µ—Å–ª–∏ False ‚Äî –Ω–µ —à–ª—ë–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤–ª–∞–¥–µ–ª—å—Ü—É, —Ç–æ–ª—å–∫–æ self-ping

if not TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

#—É–ª–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π

def send_temp_message(chat_id, text, delay=5, **kwargs):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ —É–¥–∞–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ delay —Å–µ–∫—É–Ω–¥."""
    try:
        msg = bot.send_message(chat_id, text, **kwargs)
        threading.Timer(delay, lambda: delete_message_safe(chat_id, msg.message_id)).start()
    except Exception as e:
        log_error(f"send_temp_message: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")

def delete_message_safe(chat_id, message_id):
    """–£–¥–∞–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –æ—à–∏–±–∫–∏."""
    try:
        bot.delete_message(chat_id, message_id)
    except:
        pass

# ----------------------------------------
# –§–£–ù–ö–¶–ò–Ø –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø –ß–ò–°–ï–õ
# ----------------------------------------
def fmt_num(value):
    try:
        return f"{value:,.0f}".replace(",", ".")
    except Exception:
        return str(value)

# -----------------------------
# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# -----------------------------
logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[logging.FileHandler(LOG_FILE, encoding="utf-8"), logging.StreamHandler()]
)

def log_info(msg):
    logging.info(msg)
def log_error(msg):
    logging.error(msg)

log_info(f"–°—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –í–µ—Ä—Å–∏—è {VERSION}")

# -----------------------------
# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏ IO
# -----------------------------
def default_data():
    return {
        "overall_balance": 0,
        "records": [],
        "chats": {},
        "active_messages": {},
        "processed_messages": [],
        "forward_targets": [],
        "tracked_messages": {},
        "next_id": 1
    }

def load_data():
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, "r", encoding="utf-8") as f:
                d = json.load(f)
        except Exception as e:
            log_error(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è data.json: {e}")
            d = default_data()
    else:
        d = default_data()
    base = default_data()
    for k, v in base.items():
        if k not in d:
            d[k] = v
    return d

def save_data(d):
    try:
        with open(DATA_FILE, "w", encoding="utf-8") as f:
            json.dump(d, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è data.json: {e}")

data = load_data()

# –µ—Å–ª–∏ –∑–∞–¥–∞–Ω OWNER_ID ‚Äî –¥–æ–±–∞–≤–∏–º –µ–≥–æ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ü–µ–ª–∏ (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º –∫–æ–¥–æ–º)
if OWNER_ID:
    try:
        oi = int(OWNER_ID)
        if oi not in data.get("forward_targets", []):
            data["forward_targets"].append(oi)
            save_data(data)
    except Exception:
        pass

# -----------------------------
# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ
# -----------------------------
def get_today_key():
    return datetime.now(TZ).strftime("%Y-%m-%d")

def get_chat_store(chat_id):
    cid = str(chat_id)
    if cid not in data["chats"]:
        data["chats"][cid] = {
            "balance": 0,
            "records": [],
            "next_id": 1,
            "daily_records": {},
            "active_windows": {},
            "edit_wait": None,
            "edit_target": None,
            "forward_enabled": False,
            "forward_target_id": None
        }
        save_data(data)
    store = data["chats"][cid]
    if "forward_enabled" not in store:
        store["forward_enabled"] = False
    if "forward_target_id" not in store:
        store["forward_target_id"] = None
    save_data(data)
    return store

def set_today_active_window(chat_id, message_id):
    today = get_today_key()
    if "active_messages" not in data:
        data["active_messages"] = {}
    if today not in data["active_messages"]:
        data["active_messages"][today] = {}
    data["active_messages"][today][str(chat_id)] = message_id
    save_data(data)

# -----------------------------
# –†–∞–±–æ—Ç–∞ —Å –∑–∞–ø–∏—Å—è–º–∏
# -----------------------------
def add_record_to_chat(chat_id, amount, note, owner):
    store = get_chat_store(chat_id)
    rid = data.get("next_id", 1)
    rec = {
        "id": rid,
        "short_id": f"R{rid}",
        "timestamp": datetime.now(TZ).isoformat(timespec="seconds"),
        "amount": amount,
        "note": note,
        "owner": owner
    }
    data.setdefault("records", []).append(rec)
    store.setdefault("records", []).append(rec)
    day = get_today_key()
    store.setdefault("daily_records", {}).setdefault(day, []).append(rec)
    store["balance"] = store.get("balance", 0) + amount
    data["overall_balance"] = data.get("overall_balance", 0) + amount
    data["next_id"] = rid + 1
    save_data(data)
    try:
        export_to_csv(data)
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –≤ CSV –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: {e}")

    # –§–æ—Ä–≤–∞—Ä–¥ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ –≤–ª–∞–¥–µ–ª—å—Ü—É –∏–ª–∏ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –ø–æ–ª—É—á–∞—Ç–µ–ª—é, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
    try:
        if store.get("forward_enabled"):
            target = store.get("forward_target_id")
            if not target and OWNER_ID:
                try:
                    target = int(OWNER_ID)
                except:
                    target = None
            if target:
                try:
                    bot.send_message(
                        int(target),
                        f"üí∞ {fmt_num(rec['amount'])} ARS\nüÜî {rec['short_id']}\nüìù {rec.get('note','')}\n‚è± {rec.get('timestamp')}"
                    )
                except Exception as e:
                    log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ—Å–ª–∞—Ç—å –∑–∞–ø–∏—Å—å (target {target}): {e}")
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –∑–∞–ø–∏—Å–∏: {e}")

    return rec

def update_record_in_chat(chat_id, rid, new_amount, new_note, user=None):
    store = get_chat_store(chat_id)
    found = None
    for r in store.get("records", []):
        if r["id"] == rid:
            old = r.copy()
            r["amount"] = new_amount
            r["note"] = new_note
            found = r
            break
    if found:
        for day_recs in store.get("daily_records", {}).values():
            for r in day_recs:
                if r["id"] == rid:
                    r.update(found)
        store["balance"] = sum([x["amount"] for x in store.get("records", [])])
        data["overall_balance"] = sum([x["amount"] for x in data.get("records", [])])
        save_data(data)
        try:
            export_to_csv(data)
        except:
            pass
        user_repr = f"{user.id}/{user.username}" if user else "unknown"
        log_info(f"Edit by {user_repr}: R{rid} -> amount={new_amount}, note='{new_note}'")
        return True, found
    return False, None

def delete_record_in_chat(chat_id, rid, user=None):
    store = get_chat_store(chat_id)
    removed = None
    for r in list(store.get("records", [])):
        if r["id"] == rid or str(r["id"]) == str(rid) or r.get("short_id") == f"R{rid}":
            removed = r
            store["records"].remove(r)
            break
    if removed:
        for day_key, recs in store.get("daily_records", {}).items():
            store["daily_records"][day_key] = [x for x in recs if x["id"] != rid]
        store["balance"] = sum([x["amount"] for x in store.get("records", [])])
        data["records"] = [x for x in data.get("records", []) if x["id"] != rid]
        data["overall_balance"] = sum([x["amount"] for x in data.get("records", [])])
        save_data(data)
        try:
            export_to_csv(data)
        except:
            pass
        user_repr = f"{user.id}/{user.username}" if user else "unknown"
        log_info(f"Delete by {user_repr}: R{rid} removed")
        return True, removed
    return False, None

def export_to_csv(d):
    try:
        with open(CSV_FILE, "w", newline='', encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
            for cid, cdata in d.get("chats", {}).items():
                for day_key, records in cdata.get("daily_records", {}).items():
                    for r in records:
                        writer.writerow([cid, r.get("id"), r.get("short_id"), r.get("timestamp"), r.get("amount"), r.get("note"), r.get("owner"), day_key])
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ CSV: {e}")

# -----------------------------
# –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
# -----------------------------
def build_main_keyboard(chat_id=None, confirm_reset=False):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å", callback_data="btn_balance"),
        types.InlineKeyboardButton("üìä –û—Ç—á—ë—Ç", callback_data="btn_report"),
        types.InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data="btn_edit_menu"))
    kb.row(
        types.InlineKeyboardButton("üöÄ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="btn_start"),
        types.InlineKeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ", callback_data="btn_cod")
    )
    balance_text = ""
    if chat_id is not None:
        store = get_chat_store(chat_id)
        balance_text = f"üí∞ {fmt_num(store.get('balance', 0))} ARS"
    kb.add(types.InlineKeyboardButton(balance_text or "üí∞ 0 ARS", callback_data="noop"))
    return kb

def build_edit_menu_keyboard(chat_id=None):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("üìÇ CSV", callback_data="btn_csv"),
        types.InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å–∏", callback_data="btn_edit_list")
    )
    kb.row(
        types.InlineKeyboardButton("üì® –§–æ—Ä–≤–∞—Ä–¥", callback_data="btn_toggle_forward"),
        types.InlineKeyboardButton("üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å", callback_data="btn_set_forward_target")
    )
    kb.row(
        types.InlineKeyboardButton("‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å", callback_data="btn_reset"),
        types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_main")
    )
    return kb

def build_edit_keyboard_for_record(rid):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.add(types.InlineKeyboardButton("‚úè –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é", callback_data=f"edit_manual_{rid}"))
    kb.add(types.InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å", callback_data=f"edit_delete_{rid}"))
    kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="edit_back_to_list"))
    return kb

def build_confirm_delete_keyboard(rid):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(types.InlineKeyboardButton("‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å", callback_data=f"confirm_delete_{rid}"),
           types.InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_delete"))
    return kb

# -----------------------------
# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞
# -----------------------------
def update_or_send_today_window(chat_id, create_if_missing=True):
    today_key = get_today_key()
    store = get_chat_store(chat_id)
    day_records = store.get("daily_records", {}).get(today_key, [])

    daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
    daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
    overall_balance = store.get("balance", 0)

    if not day_records:
        text = (
            f"üìÖ {today_key}\n"
            f"–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π.\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥: {fmt_num(daily_income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {fmt_num(abs(daily_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall_balance)} ARS"
        )
    else:
        lines = [f"üìÖ {today_key}", "üìã –û–ø–µ—Ä–∞—Ü–∏–∏:"]
        for r in day_records[-50:]:
            sign = "+" if r["amount"] > 0 else "-"
            lines.append(f"{r['short_id']}: {sign}{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
        lines.append(
            f"\nüíµ –ü—Ä–∏—Ö–æ–¥: {fmt_num(daily_income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {fmt_num(abs(daily_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall_balance)} ARS"
        )
        text = "\n".join(lines)

    kb = build_main_keyboard(chat_id)
    try:
        forward_info = ""
        if store.get("forward_enabled"):
            tgt = store.get("forward_target_id") or OWNER_ID
            forward_info = f"\n\nüì® –ü–µ—Ä–µ—Å—ã–ª–∫–∞: –í–∫–ª—é—á–µ–Ω–∞ ‚Üí {tgt}"
        else:
            forward_info = f"\n\nüì® –ü–µ—Ä–µ—Å—ã–ª–∫–∞: –í—ã–∫–ª—é—á–µ–Ω–∞"
        text = text + forward_info
    except:
        pass

    today_msgs = data.setdefault("active_messages", {}).setdefault(get_today_key(), {})
    active_id = today_msgs.get(str(chat_id))

    if active_id:
        try:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
        except telebot.apihelper.ApiException as e:
            log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–∫–Ω–æ {active_id} –¥–ª—è —á–∞—Ç–∞ {chat_id}: {e}")
        return

    if not create_if_missing:
        return

    try:
        sent = bot.send_message(chat_id, text, reply_markup=kb)
        set_today_active_window(chat_id, sent.message_id)
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è {chat_id}: {e}")

# -----------------------------
# Callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
# -----------------------------
@bot.callback_query_handler(func=lambda call: True)
def handle_callback(call):
    try:
        chat_id = call.message.chat.id
        message_id = call.message.message_id
    except Exception:
        return

    store = get_chat_store(chat_id)
    today_key = get_today_key()
    day_records = store.get("daily_records", {}).get(today_key, [])
    today_msgs = data.setdefault("active_messages", {}).setdefault(today_key, {})
    active_id = today_msgs.get(str(chat_id)) or message_id

    def edit_window(text, reply_markup=None):
        try:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=reply_markup)
        except telebot.apihelper.ApiException as e:
            log_error(f"–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–∫–Ω–∞: {e}")

    def send_and_set_window(text, reply_markup=None):
        sent = bot.send_message(chat_id, text, reply_markup=reply_markup)
        set_today_active_window(chat_id, sent.message_id)

    # ---------- –ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ----------
    if call.data == "btn_edit_menu":
        text = (
            "‚úèÔ∏è –ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n\n"
            "üìÇ CSV ‚Äî —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö\n"
            "üì® –§–æ—Ä–≤–∞—Ä–¥ ‚Äî –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –ø–µ—Ä–µ—Å—ã–ª–∫—É\n"
            "üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å ‚Äî –∑–∞–¥–∞—Ç—å ID –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏\n"
            "‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ\n"
        )
        edit_window(text, build_edit_menu_keyboard(chat_id))
        bot.answer_callback_query(call.id)
        return

    # ---------- –ë–∞–ª–∞–Ω—Å ----------
    if call.data == "btn_balance":
        daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
        daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
        overall_balance = store.get("balance", 0)
        text = (
            f"üìÖ {today_key}\n\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è: {fmt_num(daily_income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è: {fmt_num(abs(daily_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall_balance)} ARS"
        )
        edit_window(text, build_main_keyboard(chat_id))
        bot.answer_callback_query(call.id, "–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—ë–Ω ‚úÖ")
        return

    # ---------- –û—Ç—á—ë—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ ----------
    if call.data == "btn_report":
        expenses = [r for r in day_records if r["amount"] < 0]
        if not expenses:
            text = f"üìÖ {today_key}\n–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è.\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: 0 ARS"
        else:
            lines = [f"üìÖ {today_key}", "üìã –†–∞—Å—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å:"]
            for r in expenses[-30:]:
                lines.append(f"{r['short_id']}: -{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
            lines.append(f"\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(sum(abs(r['amount']) for r in expenses))} ARS")
            text = "\n".join(lines)
        edit_window(text, build_main_keyboard(chat_id))
        bot.answer_callback_query(call.id, "–û—Ç—á—ë—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –æ–±–Ω–æ–≤–ª—ë–Ω üìä")
        return

    # ---------- CSV ----------
    if call.data == "btn_csv":
        try:
            with open(CSV_FILE, "rb") as f:
                bot.send_document(chat_id, f, caption="üìÇ –í–∞—à —Ñ–∞–π–ª data.csv")
            bot.answer_callback_query(call.id, "CSV –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω üìÅ")
        except Exception as e:
            bot.send_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ CSV: {e}")
            bot.answer_callback_query(call.id)
        return

    # ---------- –§–æ—Ä–≤–∞—Ä–¥ ----------
    if call.data == "btn_toggle_forward":
        store["forward_enabled"] = not store.get("forward_enabled", False)
        save_data(data)
        status = "–≤–∫–ª—é—á–µ–Ω–∞ ‚úÖ" if store["forward_enabled"] else "–≤—ã–∫–ª—é—á–µ–Ω–∞ ‚ùå"
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, f"–ü–µ—Ä–µ—Å—ã–ª–∫–∞ {status}")
        return

    if call.data == "btn_set_forward_target":
        bot.answer_callback_query(call.id)
        text = "–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–º—É –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å—ã–ª–∞—Ç—å –∑–∞–ø–∏—Å–∏\n(–∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ 0, —á—Ç–æ–±—ã —Å–±—Ä–æ—Å–∏—Ç—å):"
        edit_window(text, call.message.reply_markup)
        bot.register_next_step_handler_by_chat_id(chat_id, process_forward_target)
        return

    # ---------- –†—É—á–Ω–æ–π –≤–≤–æ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–π ----------
    if call.data.startswith("edit_manual_"):
        rid = int(call.data.split("_")[2])
        store["edit_target"] = rid
        save_data(data)
        text = "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—É–º–º—É –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:"
        edit_window(text, call.message.reply_markup)
        bot.register_next_step_handler_by_chat_id(chat_id, process_manual_input)
        bot.answer_callback_query(call.id)
        return

    # ---------- –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ ----------
    if call.data.startswith("edit_delete_"):
        rid = int(call.data.split("_")[2])
        text = f"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ R{rid}:"
        edit_window(text, build_confirm_delete_keyboard(rid))
        bot.answer_callback_query(call.id)
        return

    if call.data.startswith("confirm_delete_"):
        rid = int(call.data.split("_")[2])
        success, _ = delete_record_in_chat(chat_id, rid, user=call.from_user)
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, "–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞" if success else "–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return

    if call.data == "cancel_delete":
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, "–û—Ç–º–µ–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è")
        return

    # ---------- –û–±–Ω—É–ª–µ–Ω–∏–µ ----------
    if call.data == "btn_reset":
        text = "–î–ª—è –æ–±–Ω—É–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /reset (–≤–≤–µ–¥–∏—Ç–µ `/reset` –≤ —á–∞—Ç–µ)."
        edit_window(text, build_main_keyboard(chat_id))
        bot.answer_callback_query(call.id)
        return

    if call.data == "confirm_reset":
        store["records"] = []
        store["daily_records"] = {}
        store["balance"] = 0
        data["records"] = [x for x in data.get("records", []) if x.get("owner") != chat_id]
        data["overall_balance"] = sum([x["amount"] for x in data.get("records", [])]) if data.get("records") else 0
        save_data(data)
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, "–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã üßπ")
        return

    if call.data == "cancel_reset":
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, "–û—Ç–º–µ–Ω–∞")
        return

    # ---------- –°—Ç–∞—Ä—Ç / –ò–Ω—Ñ–æ ----------
    if call.data == "btn_start":
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, "–û–∫–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ üîÑ")
        return

    if call.data == "btn_cod":
        info_text = (
            f"‚ÑπÔ∏è –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è {VERSION}\n\n"
            "üìå –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "/start - –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–∫–Ω–∞ –æ—Ç—á—ë—Ç–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è\n"
            "/balance - –ü–æ–∫–∞–∑–∞—Ç—å –æ–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –∑–∞ –¥–µ–Ω—å\n"
            "/report - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è\n"
            "/csv - –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª —Å –∏—Å—Ç–æ—Ä–∏–µ–π –æ–ø–µ—Ä–∞—Ü–∏–π\n"
            "/reset - –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ (–ø–æ–∫–∞–∂–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ)\n"
            "/ping - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∂–∏–≤ –ª–∏ –±–æ—Ç\n"
            "/help - –ü–æ–º–æ—â—å\n\n"
            "üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π (—Ñ–æ—Ä–º–∞—Ç—ã):\n"
            "+500 –ó–∞—Ä–ø–ª–∞—Ç–∞    (–∏–ª–∏ ^+^500^)\n"
            "-150 –û–±–µ–¥       (–∏–ª–∏ ^-^150^ –û–±–µ–¥)\n"
        )
        edit_window(info_text, build_main_keyboard(chat_id))
        bot.answer_callback_query(call.id)
        return

    # ---------- –°–ø–∏—Å–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ----------
    if call.data == "btn_edit_list":
        if not day_records:
            text = f"üìÖ {today_key}\n–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è."
            edit_window(text, build_main_keyboard(chat_id))
            bot.answer_callback_query(call.id, "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
            return

        lines = [f"üìÖ {today_key}", "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"]
        kb = types.InlineKeyboardMarkup(row_width=1)
        for r in reversed(day_records[-20:]):
            sign = "+" if r["amount"] > 0 else "-"
            label = f"{r['short_id']}: {sign}{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}"
            kb.add(types.InlineKeyboardButton(label, callback_data=f"rec_{r['id']}"))
        kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_main"))
        text = "\n".join(lines)
        edit_window(text, kb)
        bot.answer_callback_query(call.id)
        return

    # ---------- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ ----------
    if call.data.startswith("rec_"):
        rid = int(call.data.split("_")[1])
        rec = next((r for r in day_records if r["id"] == rid), None)
        if not rec:
            bot.answer_callback_query(call.id, "–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            return
        sign = "+" if rec["amount"] > 0 else "-"
        text = f"–ó–∞–ø–∏—Å—å {rec['short_id']}\n{sign}{fmt_num(abs(rec['amount']))} ‚Äî {rec.get('note','')}\n–î–æ–±–∞–≤–ª–µ–Ω–∞: {rec.get('timestamp')}"
        kb = build_edit_keyboard_for_record(rid)
        edit_window(text, kb)
        bot.answer_callback_query(call.id)
        return

    # ---------- –õ—é–±—ã–µ –¥—Ä—É–≥–∏–µ –∫–Ω–æ–ø–∫–∏ ----------
    update_or_send_today_window(chat_id)
    bot.answer_callback_query(call.id)

# -----------------------------
# Regex –¥–ª—è —Å—É–º–º
# -----------------------------
num_re = re.compile(r'(\^[+-]\^[0-9]+|\^[+-]?[0-9]+\^|[+-]?\s*\d+)')

def parse_amount_token(token:str):
    t = token.strip()
    t = t.replace("^", "")
    t = t.replace(" ", "")
    if t.startswith("+"):
        return int(t[1:])
    if t.startswith("-"):
        return -int(t[1:])
    return -int(t)

# -----------------------------
# –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è —Ñ–æ—Ä–≤–∞—Ä–¥–∞ (next-step)
# -----------------------------
def process_forward_target(message):
    try:
        chat_id = message.chat.id
        store = get_chat_store(chat_id)
        text = (message.text or "").strip()
        active_id = get_today_active_window(chat_id)

        if text == "0":
            store["forward_target_id"] = None
            save_data(data)
            edit_text = "‚úÖ –ü–æ–ª—É—á–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Å—ã–ª–∫–∏ —Å–±—Ä–æ—à–µ–Ω (–±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è OWNER_ID, –µ—Å–ª–∏ –æ–Ω –∑–∞–¥–∞–Ω)."
            if active_id:
                bot.edit_message_text(edit_text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
            else:
                update_or_send_today_window(chat_id)
            return

        if not (text.startswith("-") or text.isdigit()):
            edit_text = "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID. –ü—Ä–∏–º–µ—Ä: -1001234567890\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ 0 –¥–ª—è —Å–±—Ä–æ—Å–∞."
            if active_id:
                bot.edit_message_text(edit_text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
            return

        try:
            target = int(text)
        except Exception:
            edit_text = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å ID. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
            if active_id:
                bot.edit_message_text(edit_text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
            return

        store["forward_target_id"] = target
        save_data(data)
        edit_text = f"‚úÖ –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –∏–¥—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å ID {target}."
        if active_id:
            bot.edit_message_text(edit_text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
        else:
            update_or_send_today_window(chat_id)

    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ process_forward_target: {e}")
        active_id = get_today_active_window(message.chat.id)
        try:
            if active_id:
                bot.edit_message_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.", chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
            else:
                bot.send_message(message.chat.id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.")
        except:
            pass

# -----------------------------
# –í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∫–æ–º–∞–Ω–¥—ã
# -----------------------------
@bot.message_handler(commands=["start", "info"])
def cmd_start(msg):
    chat_id = msg.chat.id
    update_or_send_today_window(chat_id, create_if_missing=True)

@bot.message_handler(commands=["help"])
def cmd_help(msg):
    chat_id = msg.chat.id
    edit_text = "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—É–º–º—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ +500 –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –∏–ª–∏ -150 –û–±–µ–¥. –ö–æ–º–∞–Ω–¥—ã: /start /balance /report /csv /reset /ping"
    active_id = get_today_active_window(chat_id)
    if active_id:
        bot.edit_message_text(edit_text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
    else:
        update_or_send_today_window(chat_id)

@bot.message_handler(commands=["ping"])
def cmd_ping(msg):
    chat_id = msg.chat.id
    active_id = get_today_active_window(chat_id)
    if active_id:
        bot.edit_message_text("PONG ‚Äî –±–æ—Ç –∂–∏–≤–æ–π ‚úÖ", chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
    else:
        update_or_send_today_window(chat_id)

@bot.message_handler(commands=["balance"])
def cmd_balance(msg):
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    today_key = get_today_key()
    day_records = store.get("daily_records", {}).get(today_key, [])
    daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
    daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
    overall_balance = store.get("balance", 0)
    text = (
        f"üìÖ {today_key}\n\n"
        f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall_balance)} ARS\n"
        f"üíµ –ü—Ä–∏—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è: {fmt_num(daily_income)} ARS\n"
        f"üí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è: {fmt_num(abs(daily_expense))} ARS"
    )
    active_id = get_today_active_window(chat_id)
    if active_id:
        bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
    else:
        update_or_send_today_window(chat_id)

@bot.message_handler(commands=["report"])
def cmd_report(msg):
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    today_key = get_today_key()
    day_records = store.get("daily_records", {}).get(today_key, [])
    expenses = [r for r in day_records if r["amount"] < 0]
    if not expenses:
        text = f"üìÖ {today_key}\n–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è.\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: 0 ARS"
    else:
        lines = [f"üìÖ {today_key}", "üìã –†–∞—Å—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å:"]
        for r in expenses[-30:]:
            lines.append(f"{r['short_id']}: -{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
        lines.append(f"\nüí∏ –†–∞—Å—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å: {fmt_num(sum(abs(r['amount']) for r in expenses))} ARS")
        text = "\n".join(lines)
    active_id = get_today_active_window(chat_id)
    if active_id:
        bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
    else:
        update_or_send_today_window(chat_id)

@bot.message_handler(commands=["csv"])
def cmd_csv(msg):
    chat_id = msg.chat.id
    try:
        with open(CSV_FILE, "rb") as f:
            bot.send_document(chat_id, f, caption="üìÇ –í–∞—à —Ñ–∞–π–ª data.csv")
    except Exception as e:
        active_id = get_today_active_window(chat_id)
        if active_id:
            bot.edit_message_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ CSV: {e}", chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
        else:
            bot.send_message(chat_id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ CSV: {e}")

@bot.message_handler(commands=["reset"])
def cmd_reset(msg):
    chat_id = msg.chat.id
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(types.InlineKeyboardButton("‚úÖ –î–∞, –æ–±–Ω—É–ª–∏—Ç—å", callback_data="confirm_reset"),
           types.InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_reset"))
    active_id = get_today_active_window(chat_id)
    text = "‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å."
    if active_id:
        bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
    else:
        update_or_send_today_window(chat_id)

# -----------------------------
# Flask webhook
# -----------------------------
@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    update = telebot.types.Update.de_json(request.get_data().decode("utf-8"))
    bot.process_new_updates([update])
    return "OK", 200

@app.route("/", methods=["GET"])
def index():
    return f"–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ¬´–§–û¬ª ‚Äî –≤–µ—Ä—Å–∏—è {VERSION} —Ä–∞–±–æ—Ç–∞–µ—Ç", 200

# -----------------------------
# Keep-alive / self-ping / notify owner
# -----------------------------
def keep_alive_task():
    last_notice = 0
    while True:
        try:
            log_info("Keep-alive: –≤—ã–ø–æ–ª–Ω—è–µ–º –ø–∏–Ω–≥ self –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞ (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω).")
            # self-ping (–ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ö–æ—Å—Ç–æ–≤)
            try:
                if APP_URL:
                    resp = requests.get(APP_URL, timeout=10)
                    log_info(f"Keep-alive: self-ping {APP_URL} -> {resp.status_code}")
            except Exception as e:
                log_error(f"Keep-alive: –æ—à–∏–±–∫–∞ self-ping: {e}")

            # —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É (–æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª)
            if KEEP_ALIVE_SEND_TO_OWNER and OWNER_ID:
                try:
                    tgt = int(OWNER_ID)
                    # –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ—Å—Ç–æ–µ –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ (–Ω–µ —Å–ø–∞–º–∏–º ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ –≤—Ä–µ–º—è)
                    bot.send_message(tgt, f"üü¢ Keep-alive: –±–æ—Ç –≤–µ—Ä—Å–∏—è {VERSION} —Ä–∞–±–æ—Ç–∞–µ—Ç. –í—Ä–µ–º—è: {datetime.now(TZ).isoformat(timespec='seconds')}")
                    log_info(f"Keep-alive: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤–ª–∞–¥–µ–ª—å—Ü—É {tgt}")
                except Exception as e:
                    log_error(f"Keep-alive: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É: {e}")
        except Exception as e:
            log_error(f"Keep-alive: –æ—à–∏–±–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞: {e}")
        # –∂–¥–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
        time.sleep(max(10, KEEP_ALIVE_INTERVAL_SECONDS))

def start_keep_alive_thread():
    thread = threading.Thread(target=keep_alive_task, daemon=True)
    thread.start()

# -----------------------------
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
# -----------------------------
def set_webhook():
    url = f"{APP_URL}/{TOKEN}"
    try:
        bot.remove_webhook()
        time.sleep(0.5)
        bot.set_webhook(url=url)
        log_info(f"Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {url}")
    except Exception as e:
        log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å webhook: {e}")

def schedule_daily_window_creation():
    def task():
        last_day = get_today_key()
        while True:
            try:
                time.sleep(60)
                current_day = get_today_key()
                if current_day != last_day:
                    for chat_id_str in list(data.get("chats", {}).keys()):
                        try:
                            chat_id = int(chat_id_str)
                        except:
                            continue
                        try:
                            update_or_send_today_window(chat_id)
                        except Exception as e:
                            log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–∫–Ω–∞ –Ω–æ–≤–æ–≥–æ –¥–Ω—è –¥–ª—è {chat_id}: {e}")
                    last_day = current_day
            except Exception as e:
                log_error(f"–û—à–∏–±–∫–∞ –≤ daily loop: {e}")
                time.sleep(5)
    thread = threading.Thread(target=task, daemon=True)
    thread.start()

# -----------------------------
# –ó–∞–ø—É—Å–∫
# -----------------------------
if __name__ == "__main__":
    set_webhook()
    schedule_daily_window_creation()
    start_keep_alive_thread()
    log_info(f"–ë–æ—Ç –§–û –≤–µ—Ä—Å–∏–∏ {VERSION} –∑–∞–ø—É—â–µ–Ω")
    try:
        if OWNER_ID:
            bot.send_message(int(OWNER_ID), f"‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç! (–≤–µ—Ä—Å–∏—è {VERSION})")
    except Exception as e:
        log_error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ: {e}")
    app.run(host="0.0.0.0", port=PORT)