# ============================================
# üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è 9.8.7-FO-STABLE+jsonsync
# ID Code_020
# ============================================
# üß≠ –ß—Ç–æ —É–º–µ–µ—Ç:
#  ‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏ –ø–æ –¥–Ω—è–º (–æ—Ç–¥–µ–ª—å–Ω—ã–µ data_YYYY-MM-DD.csv)
#  ‚Ä¢ ¬´üìä –û–±—â–µ–µ CSV¬ª (–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–Ω–µ–π) + –æ—Ç–ø—Ä–∞–≤–∫–∞ csv_meta.json
#  ‚Ä¢ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞
#  ‚Ä¢ Telegram-–±—ç–∫–∞–ø: –æ—Ç–ø—Ä–∞–≤–∫–∞ data.csv -> —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ file_id –≤ csv_meta.json
#  ‚Ä¢ –ê–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø–æ file_id_csv –∏–∑ csv_meta.json
#  ‚Ä¢ –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ csv_meta.json –Ω–µ—Ç: –ø—Ä–æ–±—É–µ—Ç —Å–∫–∞—á–∞—Ç—å –ø–æ CSV_META_FILE_ID (env)
#  ‚Ä¢ Keep-alive + webhook
# ============================================

import os
import io
import re
import csv
import json
import time
import threading
import logging
import requests
from datetime import datetime, timedelta
from zoneinfo import ZoneInfo
from flask import Flask, request
import telebot
from telebot import types

# --------------------------------------------
# üß© –û–¢–°–ï–ö 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
# --------------------------------------------
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = int(os.getenv("OWNER_ID", "0"))
APP_URL = os.getenv("APP_URL", "https://yourapp.onrender.com")
TZ = ZoneInfo(os.getenv("TZ", "America/Argentina/Buenos_Aires"))
PORT = int(os.getenv("PORT", "5000"))
KEEP_ALIVE_INTERVAL = int(os.getenv("KEEP_ALIVE_INTERVAL_SECONDS", str(13*60)))

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –µ—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ csv_meta.json –Ω–µ—Ç, –æ—Ç–∫—É–¥–∞ –≤–∑—è—Ç—å –µ–≥–æ file_id
CSV_META_FILE_ID_ENV = os.getenv("CSV_META_FILE_ID", "").strip()

if not TOKEN or not OWNER_ID:
    raise RuntimeError("–ù—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å BOT_TOKEN –∏ OWNER_ID –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.")

bot = telebot.TeleBot(TOKEN, threaded=True, num_threads=3)
app = Flask(__name__)

# --------------------------------------------
# üß© –û–¢–°–ï–ö 2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# --------------------------------------------
logging.basicConfig(level=logging.INFO, format="%(asctime)s [%(levelname)s] %(message)s")
def log_info(msg): logging.info(msg)
def log_err(msg): logging.error(msg)

# --------------------------------------------
# üß© –û–¢–°–ï–ö 3. –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ IO
# --------------------------------------------
META_PATH = "csv_meta.json"

def safe_json_load(path, fallback):
    try:
        if os.path.exists(path):
            with open(path, "r", encoding="utf-8") as f:
                return json.load(f)
    except Exception as e:
        log_err(f"safe_json_load({path}): {e}")
    return fallback

def safe_json_write(path, payload):
    try:
        with open(path, "w", encoding="utf-8") as f:
            json.dump(payload, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_err(f"safe_json_write({path}): {e}")

def day_file_path(day_key: str) -> str:
    return f"data_{day_key}.csv"

def list_day_keys_from_disk():
    keys = []
    for fn in os.listdir():
        if fn.startswith("data_") and fn.endswith(".csv"):
            keys.append(fn[5:-4])  # data_YYYY-MM-DD.csv -> YYYY-MM-DD
    return sorted(keys)

# --------------------------------------------
# üß© –û–¢–°–ï–ö 4. –•—Ä–∞–Ω–∏–ª–∏—â–µ –≤ –ø–∞–º—è—Ç–∏
# --------------------------------------------
DATA = {
    "daily": {},   # { "YYYY-MM-DD": [ {id, amount, note}, ... ] }
    "last_id": 1,
}

def load_day_csv(day_key):
    recs = []
    path = day_file_path(day_key)
    if not os.path.exists(path):
        return recs
    try:
        with open(path, "r", encoding="utf-8") as f:
            rd = csv.DictReader(f)
            for row in rd:
                recs.append({"id": int(row["id"]), "amount": int(row["amount"]), "note": row.get("note","")})
    except Exception as e:
        log_err(f"load_day_csv({day_key}): {e}")
    return recs

def save_day_csv(day_key, records):
    try:
        with open(day_file_path(day_key), "w", newline="", encoding="utf-8") as f:
            wr = csv.writer(f)
            wr.writerow(["id", "amount", "note"])
            for r in records:
                wr.writerow([r["id"], r["amount"], r["note"]])
    except Exception as e:
        log_err(f"save_day_csv({day_key}): {e}")

def load_all_days_from_disk():
    DATA["daily"].clear()
    max_id = 1
    for key in list_day_keys_from_disk():
        recs = load_day_csv(key)
        if recs:
            DATA["daily"][key] = recs
            max_id = max(max_id, max(r["id"] for r in recs) + 1)
    DATA["last_id"] = max_id
    log_info(f"üìÇ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –¥–Ω–µ–π: {len(DATA['daily'])}; next id = {DATA['last_id']}")

# --------------------------------------------
# üß© –û–¢–°–ï–ö 5. Telegram File API
# --------------------------------------------
def download_file_by_id(file_id: str) -> bytes:
    """–°–∫–∞—á–∏–≤–∞–µ—Ç —Ñ–∞–π–ª –ø–æ file_id —á–µ—Ä–µ–∑ Bot API."""
    try:
        f = bot.get_file(file_id)
        url = f"https://api.telegram.org/file/bot{TOKEN}/{f.file_path}"
        r = requests.get(url, timeout=30)
        r.raise_for_status()
        return r.content
    except Exception as e:
        log_err(f"download_file_by_id: {e}")
        return b""

# --------------------------------------------
# üß© –û–¢–°–ï–ö 6. –†–∞–±–æ—Ç–∞ —Å csv_meta.json
# --------------------------------------------
def ensure_local_meta_or_fetch():
    """
    –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –Ω–∞–ª–∏—á–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ csv_meta.json.
    - –µ—Å–ª–∏ –µ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º;
    - –µ—Å–ª–∏ –Ω–µ—Ç –∏ –µ—Å—Ç—å CSV_META_FILE_ID (env) ‚Äî –∫–∞—á–∞–µ–º meta –∏–∑ Telegram;
    - –∏–Ω–∞—á–µ —Å–æ–∑–¥–∞—ë–º "–ø—É—Å—Ç–æ–π" meta.
    –°—Ç—Ä—É–∫—Ç—É—Ä–∞ meta:
      {
        "file_id_csv": "...",        # –ø–æ—Å–ª–µ–¥–Ω–∏–π file_id –æ–±—â–µ–≥–æ data.csv
        "meta_file_id": "...",       # file_id —Å–∞–º–æ–≥–æ csv_meta.json (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏)
        "updated": "ISO-–¥–∞—Ç–∞–≤—Ä–µ–º—è"
      }
    """
    if os.path.exists(META_PATH):
        return

    if CSV_META_FILE_ID_ENV:
        log_info("üîé –õ–æ–∫–∞–ª—å–Ω–æ–≥–æ csv_meta.json –Ω–µ—Ç. –ü—ã—Ç–∞—é—Å—å —Å–∫–∞—á–∞—Ç—å –ø–æ CSV_META_FILE_ID (env)...")
        raw = download_file_by_id(CSV_META_FILE_ID_ENV)
        if raw:
            try:
                meta = json.loads(raw.decode("utf-8"))
                safe_json_write(META_PATH, meta)
                log_info("‚úÖ csv_meta.json –ø–æ–ª—É—á–µ–Ω –∏–∑ Telegram –ø–æ CSV_META_FILE_ID (env)")
                return
            except Exception as e:
                log_err(f"ensure_local_meta_or_fetch: –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–π meta –∏–∑ Telegram: {e}")

    # —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π meta
    meta = {"file_id_csv": None, "meta_file_id": None, "updated": datetime.now().isoformat()}
    safe_json_write(META_PATH, meta)
    log_info("üìÑ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π csv_meta.json (–ø—É—Å—Ç–æ–π)")

def send_csv_meta_to_owner():
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü—É –∞–∫—Ç—É–∞–ª—å–Ω—ã–π csv_meta.json (—Å–æ–∑–¥–∞—ë—Ç –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏). –û–±–Ω–æ–≤–ª—è–µ—Ç meta_file_id."""
    ensure_local_meta_or_fetch()
    try:
        with open(META_PATH, "rb") as f:
            msg = bot.send_document(OWNER_ID, f, caption="üìÑ –¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª csv_meta.json")
        # –æ–±–Ω–æ–≤–∏–º meta_file_id
        meta = safe_json_load(META_PATH, {})
        meta["meta_file_id"] = msg.document.file_id if hasattr(msg, "document") else meta.get("meta_file_id")
        meta["updated"] = datetime.now().isoformat()
        safe_json_write(META_PATH, meta)
        log_info("‚úÖ csv_meta.json –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤–ª–∞–¥–µ–ª—å—Ü—É –∏ meta_file_id –æ–±–Ω–æ–≤–ª—ë–Ω")
    except Exception as e:
        log_err(f"send_csv_meta_to_owner: {e}")

# --------------------------------------------
# üß© –û–¢–°–ï–ö 7. –≠–∫—Å–ø–æ—Ä—Ç –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
# --------------------------------------------
def export_all_to_data_csv_bytes() -> bytes:
    """–§–æ—Ä–º–∏—Ä—É–µ—Ç –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π data.csv –∏–∑ –≤—Å–µ—Ö –¥–Ω–µ–π –≤ –ø–∞–º—è—Ç–∏."""
    sio = io.StringIO()
    wr = csv.writer(sio)
    wr.writerow(["date", "id", "amount", "note"])
    for day_key in sorted(DATA["daily"].keys()):
        for r in DATA["daily"][day_key]:
            wr.writerow([day_key, r["id"], r["amount"], r["note"]])
    return sio.getvalue().encode("utf-8")

def send_all_csv_and_update_meta():
    """
    –®–ª—ë—Ç –≤–ª–∞–¥–µ–ª—å—Ü—É –æ–±—â–∏–π data.csv –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç file_id_csv –≤ csv_meta.json.
    –ó–∞—Ç–µ–º —à–ª—ë—Ç csv_meta.json (—É–∂–µ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º).
    """
    try:
        csv_bytes = export_all_to_data_csv_bytes()
        msg = bot.send_document(
            OWNER_ID,
            io.BytesIO(csv_bytes),
            visible_file_name="data.csv",
            caption="üìä –û–±—â–µ–µ CSV ‚Äî –≤—Å–µ –¥–Ω–∏"
        )
        # –æ–±–Ω–æ–≤–ª—è–µ–º meta -> file_id_csv
        meta = safe_json_load(META_PATH, {})
        if hasattr(msg, "document") and msg.document:
            meta["file_id_csv"] = msg.document.file_id
        meta["updated"] = datetime.now().isoformat()
        safe_json_write(META_PATH, meta)

        # –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º csv_meta.json —Å–ª–µ–¥–æ–º
        send_csv_meta_to_owner()
    except Exception as e:
        log_err(f"send_all_csv_and_update_meta: {e}")

def restore_from_telegram_backup_if_possible():
    """
    –ï—Å–ª–∏ –≤ meta –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç file_id_csv ‚Äî –∫–∞—á–∞–µ–º data.csv –∏–∑ Telegram –∏
    –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–Ω–µ–≤–Ω—ã–µ CSV + –ø–∞–º—è—Ç—å.
    """
    meta = safe_json_load(META_PATH, {})
    file_id_csv = meta.get("file_id_csv")
    if not file_id_csv:
        log_info("‚ÑπÔ∏è restore: file_id_csv –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –ø—Ä–æ–ø—É—Å–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ Telegram.")
        return

    raw = download_file_by_id(file_id_csv)
    if not raw:
        log_err("restore: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å data.csv –ø–æ file_id_csv.")
        return

    try:
        # —á–∏—Ç–∞–µ–º –æ–±—â–∏–π CSV –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–Ω–µ–≤–Ω—ã–µ
        text = raw.decode("utf-8", errors="replace")
        rd = csv.DictReader(io.StringIO(text))
        restored = {}
        max_id = 1
        for row in rd:
            day_key = row["date"]
            rid = int(row["id"])
            amt = int(row["amount"])
            note = row.get("note", "")
            restored.setdefault(day_key, []).append({"id": rid, "amount": amt, "note": note})
            if rid >= max_id:
                max_id = rid + 1

        # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ –¥–∏—Å–∫ –∏ –≤ –ø–∞–º—è—Ç—å
        for day_key, recs in restored.items():
            save_day_csv(day_key, recs)
        DATA["daily"] = restored
        DATA["last_id"] = max(1, max_id)
        log_info(f"üß© –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ Telegram: –¥–Ω–µ–π {len(restored)}, next id = {DATA['last_id']}")
    except Exception as e:
        log_err(f"restore_from_telegram_backup_if_possible: {e}")

# --------------------------------------------
# üß© –û–¢–°–ï–ö 8. –ü–∞—Ä—Å–∏–Ω–≥ –≤–≤–æ–¥–∞ –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏
# --------------------------------------------
num_re = re.compile(r'^[\+\-]?\s*\d+')

def parse_add_line(text: str):
    """
    –§–æ—Ä–º–∞—Ç: +500 –ó–∞—Ä–ø–ª–∞—Ç–∞   |   -200 –û–±–µ–¥
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (amount:int, note:str) –∏–ª–∏ None
    """
    t = text.strip()
    m = num_re.match(t)
    if not m:
        return None
    num_token = m.group(0).replace(" ", "")
    try:
        amount = int(num_token)
    except:
        return None
    note = t[m.end():].strip()
    return amount, note

def add_record(day_key: str, amount: int, note: str):
    rid = DATA["last_id"]
    DATA["last_id"] += 1
    rec = {"id": rid, "amount": amount, "note": note}
    DATA["daily"].setdefault(day_key, []).append(rec)
    # —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–µ–Ω—å –Ω–∞ –¥–∏—Å–∫
    save_day_csv(day_key, DATA["daily"][day_key])
    return rec

def today_key():
    return datetime.now(TZ).strftime("%Y-%m-%d")

def total_balance():
    s = 0
    for recs in DATA["daily"].values():
        s += sum(r["amount"] for r in recs)
    return s

# --------------------------------------------
# üß© –û–¢–°–ï–ö 9. UI (–∫–Ω–æ–ø–∫–∏)
# --------------------------------------------
def kb_main():
    kb = types.InlineKeyboardMarkup()
    kb.row(
        types.InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å", callback_data="add"),
        types.InlineKeyboardButton("üìä –û–±—â–µ–µ CSV", callback_data="csv_all"),
    )
    kb.row(
        types.InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data="day_today"),
        types.InlineKeyboardButton("üíµ –ë–∞–ª–∞–Ω—Å", callback_data="balance"),
    )
    return kb

# --------------------------------------------
# üß© –û–¢–°–ï–ö 10. –ö–æ–º–∞–Ω–¥—ã
# --------------------------------------------
@bot.message_handler(commands=["start"])
def on_start(message):
    bot.send_message(message.chat.id, "üëã –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ.", reply_markup=kb_main())
    # –≤—Å–µ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º csv_meta.json –ø—Ä–∏ /start
    send_csv_meta_to_owner()

@bot.message_handler(commands=["balance"])
def on_balance(message):
    bot.send_message(message.chat.id, f"üíµ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {total_balance()}")

# –ü—Ä–æ—Å—Ç–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏—Å—ã–ª–∞–µ—Ç —Å—Ç—Ä–æ–∫—É "+500 –ó–∞–º–µ—Ç–∫–∞"
@bot.message_handler(content_types=["text"])
def on_text(message):
    parsed = parse_add_line(message.text or "")
    if not parsed:
        return
    day = today_key()
    amount, note = parsed
    rec = add_record(day, amount, note)
    bot.reply_to(message, f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: R{rec['id']} {amount} ‚Äî {note}\nüìÖ –î–µ–Ω—å: {day}\nüíµ –ë–∞–ª–∞–Ω—Å: {total_balance()}")

# --------------------------------------------
# üß© –û–¢–°–ï–ö 11. Callback-–∫–Ω–æ–ø–∫–∏
# --------------------------------------------
@bot.callback_query_handler(func=lambda c: True)
def on_cb(call):
    try:
        if call.data == "csv_all":
            send_all_csv_and_update_meta()
            bot.answer_callback_query(call.id, "–û—Ç–ø—Ä–∞–≤–∏–ª data.csv –∏ csv_meta.json –≤–ª–∞–¥–µ–ª—å—Ü—É")
        elif call.data == "add":
            bot.answer_callback_query(call.id)
            bot.send_message(call.message.chat.id, "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∏ –∑–∞–º–µ—Ç–∫—É: –ø—Ä–∏–º–µ—Ä `+500 –ó–∞—Ä–ø–ª–∞—Ç–∞` –∏–ª–∏ `-200 –û–±–µ–¥`")
        elif call.data == "day_today":
            bot.answer_callback_query(call.id, f"–°–µ–≥–æ–¥–Ω—è: {today_key()}")
        elif call.data == "balance":
            bot.answer_callback_query(call.id, f"–ë–∞–ª–∞–Ω—Å: {total_balance()}")
        else:
            bot.answer_callback_query(call.id, "–û–∫")
    except Exception as e:
        log_err(f"on_cb: {e}")

# --------------------------------------------
# üß© –û–¢–°–ï–ö 12. Keep-Alive
# --------------------------------------------
def keep_alive_loop():
    while True:
        try:
            requests.get(APP_URL, timeout=10)
            log_info("üåê Keep-alive ping")
        except Exception as e:
            log_err(f"keep_alive: {e}")
        time.sleep(KEEP_ALIVE_INTERVAL)

# --------------------------------------------
# üß© –û–¢–°–ï–ö 13. Flask + webhook
# --------------------------------------------
@app.route("/", methods=["GET"])
def index():
    return "OK", 200

@app.route(f"/{TOKEN}", methods=["POST"])
def bot_webhook():
    try:
        upd = telebot.types.Update.de_json(request.stream.read().decode("utf-8"))
        bot.process_new_updates([upd])
    except Exception as e:
        log_err(f"webhook: {e}")
    return "OK", 200

# --------------------------------------------
# üß© –û–¢–°–ï–ö 14. –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
# --------------------------------------------
def main():
    # 1) –ü–æ–¥–Ω—è—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ CSV (–µ—Å–ª–∏ –µ—Å—Ç—å)
    load_all_days_from_disk()

    # 2) –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π csv_meta.json (–∏–ª–∏ –ø–æ–ª—É—á–∏—Ç—å –∏–∑ TG –ø–æ env file_id)
    ensure_local_meta_or_fetch()

    # 3) –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –∏–∑ Telegram –ø–æ file_id_csv
    restore_from_telegram_backup_if_possible()

    # 4) –û—Ç–ø—Ä–∞–≤–∏—Ç—å csv_meta.json –≤–ª–∞–¥–µ–ª—å—Ü—É (–∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª ‚Äî –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ)
    send_csv_meta_to_owner()

    # 5) –í–∫–ª—é—á–∏—Ç—å webhook –∏ keep-alive
    bot.remove_webhook()
    time.sleep(1)
    bot.set_webhook(url=f"{APP_URL}/{TOKEN}")
    log_info("ü§ñ Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")

    threading.Thread(target=keep_alive_loop, daemon=True).start()
    app.run(host="0.0.0.0", port=PORT)

if __name__ == "__main__":
    main()