# ============================================
# Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð±Ð¾Ñ‚ Â«Ð¤ÐžÂ» â€” Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ ÑÐ±Ð¾Ñ€ÐºÐ°
# Ð’ÐµÑ€ÑÐ¸Ñ: 3.1
# ============================================

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 1 â€” Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ñ‹ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
# -----------------------------
import os, json, csv, logging, threading, time, re
from datetime import datetime
from zoneinfo import ZoneInfo
import telebot
from flask import Flask, request
from telebot import types

# ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ (Ð·Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ñ‡ÐµÑ€ÐµÐ· env Ð¸Ð»Ð¸ Ð¿Ñ€ÑÐ¼Ð¾ Ð² ÐºÐ¾Ð´Ðµ Ð¿Ñ€Ð¸ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐµ)
TOKEN = os.getenv("BOT_TOKEN", "")     # Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾: ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð´Ð²Ð¾ÐµÑ‚Ð¾Ñ‡Ð¸Ðµ
OWNER_ID = int(os.getenv("OWNER_ID", "0") or 0)
APP_URL = os.getenv("APP_URL", "https://example-app.onrender.com")
TZ = ZoneInfo("America/Argentina/Catamarca")
DATA_FILE = "data.json"
CSV_FILE = "data.csv"
LOG_FILE = "log.txt"
PORT = int(os.environ.get("PORT", 5000))
VERSION = "3.1"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‚Ð¾ÐºÐµÐ½Ð° â€” ÐµÑÐ»Ð¸ Ð¿ÑƒÑÑ‚Ð¾Ð¹ Ð¸Ð»Ð¸ Ð½ÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹, Ð¿Ð°Ð´Ð°Ñ‚ÑŒ Ñ Ð¿Ð¾Ð½ÑÑ‚Ð½Ñ‹Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÐµÐ¼
if not TOKEN or ":" not in TOKEN:
    raise ValueError("BOT_TOKEN Ð½Ðµ Ð·Ð°Ð´Ð°Ð½ Ð¸Ð»Ð¸ Ð½ÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚ÐµÐ½. Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Ð² Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ð¸ ÐµÑÑ‚ÑŒ BOT_TOKEN Ð¸ Ð¾Ð½ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ ':'.")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[logging.FileHandler(LOG_FILE, encoding="utf-8"), logging.StreamHandler()]
)
def log_info(msg): logging.info(msg)
def log_error(msg): logging.error(msg)

log_info(f"Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð¾Ñ‚Ð° Ð¤Ðž Ð²ÐµÑ€ÑÐ¸Ñ {VERSION}")

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 2 â€” Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ð¸ IO
# -----------------------------
def default_data():
    return {"overall_balance":0,"records":[],"chats":{},"active_messages":{},"next_id":1}

def load_data():
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE,"r",encoding="utf-8") as f:
                d=json.load(f)
        except Exception as e:
            log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ data.json: {e}")
            d=default_data()
    else:
        d=default_data()
    # Ð´Ð¾Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð¿Ð¾Ð»Ñ
    base=default_data()
    for k,v in base.items():
        if k not in d:
            d[k]=v
    return d

def save_data(d):
    try:
        with open(DATA_FILE,"w",encoding="utf-8") as f:
            json.dump(d,f,ensure_ascii=False,indent=2)
    except Exception as e:
        log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ data.json: {e}")

data = load_data()

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 3 â€” Ð§Ð°Ñ‚/Ð´Ð°Ñ‚Ð°/Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚
# -----------------------------
def get_today_key(): return datetime.now(TZ).strftime("%Y-%m-%d")
def get_chat_store(chat_id):
    cid=str(chat_id)
    if cid not in data["chats"]:
        data["chats"][cid]={"balance":0,"records":[],"next_id":1,"daily_records":{},"active_windows":{},"edit_wait":None,"edit_target":None,"forward_target":None}
        save_data(data)
    return data["chats"][cid]

def get_today_active_window(chat_id):
    today=get_today_key()
    return data.get("active_messages",{}).get(today,{}).get(str(chat_id))

def set_today_active_window(chat_id,message_id):
    today=get_today_key()
    if "active_messages" not in data: data["active_messages"]={}
    if today not in data["active_messages"]: data["active_messages"][today]={}
    data["active_messages"][today][str(chat_id)]=message_id
    save_data(data)

def format_amount(a):
    # Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÑÑ‚Ñ€Ð¾ÐºÑƒ Ñ Ñ‚Ñ‹ÑÑÑ‡Ð½Ñ‹Ð¼Ð¸ Ñ€Ð°Ð·Ð´ÐµÐ»Ð¸Ñ‚ÐµÐ»ÑÐ¼Ð¸ Ð¿Ñ€Ð¾Ð±ÐµÐ»Ð¾Ð¼, Ð´Ð»Ñ Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÑ‚ +.
    sign = "+" if a>0 else ""
    return f"{sign}{abs(int(a)):,}".replace(",", " ")

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 4 â€” Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ CSV
# -----------------------------
def export_to_csv(d):
    try:
        with open(CSV_FILE,"w",newline='',encoding="utf-8") as f:
            writer=csv.writer(f)
            writer.writerow(["chat_id","ID","timestamp","amount","note","owner","day_key"])
            for cid,cdata in d.get("chats",{}).items():
                for day_key,records in cdata.get("daily_records",{}).items():
                    for r in records:
                        writer.writerow([cid,r.get("id"),r.get("timestamp"),r.get("amount"),r.get("note"),r.get("owner"),day_key])
    except Exception as e:
        log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð° CSV: {e}")

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 5 â€” Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ/Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ/ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹
# -----------------------------
def add_record_to_chat(chat_id,amount,note,owner):
    store=get_chat_store(chat_id)
    rid=data.get("next_id",1)
    rec={"id":rid,"short_id":f"R{rid}","timestamp":datetime.now(TZ).isoformat(timespec="seconds"),"amount":int(amount),"note":note,"owner":owner}
    data.setdefault("records",[]).append(rec)
    store.setdefault("records",[]).append(rec)
    day=get_today_key()
    store.setdefault("daily_records",{}).setdefault(day,[]).append(rec)
    store["balance"]=sum([r["amount"] for r in store.get("records",[])])
    data["overall_balance"]=sum([r["amount"] for r in data.get("records",[])])
    data["next_id"]=rid+1
    save_data(data)
    try: export_to_csv(data)
    except: pass
    return rec

def update_record_in_chat(chat_id,rid,new_amount,new_note):
    store=get_chat_store(chat_id)
    found=None
    for r in store.get("records",[]):
        if r["id"]==rid:
            r["amount"]=int(new_amount)
            r["note"]=new_note
            found=r
            break
    if found:
        for day_recs in store.get("daily_records",{}).values():
            for r in day_recs:
                if r["id"]==rid:
                    r.update(found)
        store["balance"]=sum([x["amount"] for x in store.get("records",[])])
        data["overall_balance"]=sum([x["amount"] for x in data.get("records",[])])
        save_data(data)
        export_to_csv(data)
        return True,found
    return False,None

def delete_record_in_chat(chat_id,rid):
    store=get_chat_store(chat_id)
    removed=None
    for r in list(store.get("records",[])):
        if r["id"]==rid or str(r["id"])==str(rid) or r.get("short_id")==f"R{rid}":
            removed=r
            store["records"].remove(r)
            break
    if removed:
        for day_key,recs in store.get("daily_records",{}).items():
            store["daily_records"][day_key]=[x for x in recs if x["id"]!=rid]
        store["balance"]=sum([x["amount"] for x in store.get("records",[])])
        data["records"]=[x for x in data.get("records",[]) if x["id"]!=rid]
        data["overall_balance"]=sum([x["amount"] for x in data.get("records",[])])
        save_data(data)
        export_to_csv(data)
        return True,removed
    return False,None

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 6 â€” ÐšÐ»Ð°Ð²Ð¸Ð°Ñ‚ÑƒÑ€Ð° Ð±ÐµÐ· ÐºÐ½Ð¾Ð¿ÐºÐ¸ Â«Ð¡Ñ‚Ð°Ñ€Ñ‚Â»
# -----------------------------
def build_main_keyboard(chat_id=None, confirm_reset=False):
    kb = types.InlineKeyboardMarkup(row_width=3)
    kb.row(
        types.InlineKeyboardButton("ðŸ’° Ð‘Ð°Ð»Ð°Ð½Ñ", callback_data="btn_balance"),
        types.InlineKeyboardButton("ðŸ“Š ÐžÑ‚Ñ‡Ñ‘Ñ‚", callback_data="btn_report"),
        types.InlineKeyboardButton("âœï¸ Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ", callback_data="btn_edit")
    )
    if confirm_reset:
        kb.row(
            types.InlineKeyboardButton("âœ… Ð”Ð°", callback_data="confirm_reset"),
            types.InlineKeyboardButton("âŒ ÐÐµÑ‚", callback_data="cancel_reset")
        )
    else:
        kb.row(
            types.InlineKeyboardButton("â™»ï¸ ÐžÐ±Ð½ÑƒÐ»Ð¸Ñ‚ÑŒ", callback_data="btn_reset"),
            types.InlineKeyboardButton("ðŸ“¤ CSV", callback_data="export_csv"),
            types.InlineKeyboardButton("ðŸ“¤ ÐŸÐµÑ€ÐµÑÐ»Ð°Ñ‚ÑŒ", callback_data="btn_forward")
        )
    kb.row(
        types.InlineKeyboardButton("â„¹ï¸", callback_data="btn_cod")
    )
    balance_text = ""
    if chat_id is not None:
        store = get_chat_store(chat_id)
        balance_text = f"ðŸ’° {format_amount(store.get('balance',0))} ARS"
    kb.add(types.InlineKeyboardButton(balance_text or "ðŸ’° 0 ARS", callback_data="noop"))
    return kb

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 7 â€” ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ / Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð³Ð¾ Ð¾ÐºÐ½Ð°
# -----------------------------
def update_or_send_today_window(chat_id, extra_text=None):
    today_key = get_today_key()
    store = get_chat_store(chat_id)
    day_records = store.get("daily_records", {}).get(today_key, [])

    if not day_records:
        text = f"ðŸ“… {today_key}\nÐŸÐ¾ÐºÐ° Ð½ÐµÑ‚ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹.\nðŸ’° Ð‘Ð°Ð»Ð°Ð½Ñ: {format_amount(store.get('balance',0))} ARS"
    else:
        lines = [f"ðŸ“… {today_key}", "ðŸ“‹ ÐžÐ¿ÐµÑ€Ð°Ñ†Ð¸Ð¸:"]
        for r in day_records[-50:]:
            amount_str = format_amount(r["amount"])
            lines.append(f"{r['short_id']}: {amount_str} â€” {r.get('note','')}")
        lines.append(f"\nðŸ’° Ð‘Ð°Ð»Ð°Ð½Ñ: {format_amount(store.get('balance',0))} ARS")
        text = "\n".join(lines)

    if extra_text:
        text = f"{extra_text}\n\n{text}"

    kb = build_main_keyboard(chat_id)
    today_msgs = data.setdefault("active_messages", {}).setdefault(today_key, {})
    active_id = today_msgs.get(str(chat_id))

    if active_id:
        try:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
        except Exception as e:
            # ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ÑÑ‚Ð°Ñ€Ñ‹Ð¹ message_id), Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð¾Ð²Ð¾Ðµ Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼
            try:
                sent = bot.send_message(chat_id, text, reply_markup=kb)
                set_today_active_window(chat_id, sent.message_id)
            except Exception as e2:
                log_error(f"[update_or_send_today_window] Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð½Ðµ ÑƒÐ´Ð°Ð»Ð°ÑÑŒ: {e2}")
        return

    try:
        sent = bot.send_message(chat_id, text, reply_markup=kb)
        set_today_active_window(chat_id, sent.message_id)
        log_info(f"[update_or_send_today_window] Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾ Ð½Ð¾Ð²Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð´Ð»Ñ Ñ‡Ð°Ñ‚Ð° {chat_id}, message_id={sent.message_id}")
    except Exception as e:
        log_error(f"[update_or_send_today_window] ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¾ÐºÐ½Ð¾ Ð´Ð»Ñ chat {chat_id}: {e}")

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 8 â€” ÐŸÐ°Ñ€ÑÐ¸Ð½Ð³ Ð²Ñ…Ð¾Ð´ÑÑ‰Ð¸Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ (Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°: + â†’ Ð¿Ñ€Ð¸Ñ…Ð¾Ð´, Ð±ÐµÐ· Ð¸ - â†’ Ñ€Ð°ÑÑ…Ð¾Ð´)
# -----------------------------
def parse_line_amount(line: str):
    """
    ÐŸÐ°Ñ€ÑÐ¸Ñ‚ Ð¾Ð´Ð½Ñƒ ÑÑ‚Ñ€Ð¾ÐºÑƒ. Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ (amount:int, note:str) Ð¸Ð»Ð¸ (None, None).
    ÐŸÑ€Ð°Ð²Ð¸Ð»Ð¾: ÐµÑÐ»Ð¸ ÑÑ‚Ñ€Ð¾ÐºÐ° Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ Ñ '+', Ñ‚Ð¾ ÑÑ‚Ð¾ Ð¿Ñ€Ð¸Ñ…Ð¾Ð´ (Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ñ‡Ð¸ÑÐ»Ð¾).
             Ð¸Ð½Ð°Ñ‡Ðµ (Ð±ÐµÐ· Ð·Ð½Ð°ÐºÐ° Ð¸Ð»Ð¸ Ñ '-') â€” ÑÑ‚Ð¾ Ñ€Ð°ÑÑ…Ð¾Ð´ (Ð¾Ñ‚Ñ€Ð¸Ñ†Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ñ‡Ð¸ÑÐ»Ð¾).
    ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ Ñ€Ð°Ð·Ð´ÐµÐ»Ð¸Ñ‚ÐµÐ»Ð¸ Ñ‚Ñ‹ÑÑÑ‡: Ð¿Ñ€Ð¾Ð±ÐµÐ», Ñ‚Ð¾Ñ‡ÐºÐ°, Ð·Ð°Ð¿ÑÑ‚Ð°Ñ, Ð°Ð¿Ð¾ÑÑ‚Ñ€Ð¾Ñ„Ñ‹.
    Ð‘ÐµÑ€Ñ‘Ñ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿ÐµÑ€Ð²Ð¾Ðµ Ñ‡Ð¸ÑÐ»Ð¾Ð²Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð² ÑÑ‚Ñ€Ð¾ÐºÐµ.
    """
    if not line or not line.strip():
        return None, None
    orig = line.strip()
    # ÐÐ°Ð¹Ð´Ñ‘Ð¼ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚, Ð½Ð°Ñ‡Ð¸Ð½Ð°ÑŽÑ‰Ð¸Ð¹ÑÑ Ñ optional sign Ð¸ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‰Ð¸Ð¹ Ñ†Ð¸Ñ„Ñ€Ñ‹ Ð¸ Ñ€Ð°Ð·Ð´ÐµÐ»Ð¸Ñ‚ÐµÐ»Ð¸
    m = re.search(r"^\s*([+-]?)[\s]*([\d\s\.,â€™']+)", orig)
    if not m:
        return None, None
    sign_token = m.group(1)  # '+' Ð¸Ð»Ð¸ '-' Ð¸Ð»Ð¸ ''
    numpart = m.group(2)
    # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ñ€Ð°Ð·Ð´ÐµÐ»Ð¸Ñ‚ÐµÐ»Ð¸ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ Ñ‡Ð¸ÑÐ»Ð°
    cleaned = re.sub(r"[ \.,â€™']", "", numpart)
    if not re.match(r"^\d+$", cleaned):
        # ÐµÑÐ»Ð¸ Ð¿Ð¾ÑÐ»Ðµ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ Ð½ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ†Ð¸Ñ„Ñ€ â€” Ð¾Ñ‚ÐºÐ°Ð·
        return None, None
    try:
        val = int(cleaned)
    except:
        return None, None
    # Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð¾: + => income (positive), else => expense (negative)
    if sign_token == "+":
        amount = abs(val)
    else:
        amount = -abs(val)
    note = orig[m.end():].strip()
    return amount, note

@bot.message_handler(func=lambda m: True, content_types=['text'])
def handle_message(msg):
    chat_id = msg.chat.id
    text = msg.text or ""
    store = get_chat_store(chat_id)

    # 8.1 â€” Ð•ÑÐ»Ð¸ Ð²Ð»Ð°Ð´ÐµÐ»ÐµÑ† Ð¿ÐµÑ€ÐµÑÑ‹Ð»Ð°ÐµÑ‚ Ð¸Ð· Ð»Ð¸Ñ‡ÐºÐ¸ Ð² ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ (Ð±ÐµÐ· ÑÑ…Ð¾ Ð² Ð»Ð¸Ñ‡ÐºÐµ)
    if chat_id == OWNER_ID and msg.chat.type == "private":
        target_chat_id = store.get("forward_target")
        if target_chat_id:
            try:
                # ÐŸÐµÑ€ÐµÑÑ‹Ð»Ð°ÐµÐ¼ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ñ‚ÐµÐºÑÑ‚ Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†Ð° Ð² Ñ†ÐµÐ»ÐµÐ²Ð¾Ð¹ Ñ‡Ð°Ñ‚ (Ð±ÐµÐ· ÑÑ…Ð° Ð² Ð»Ð¸Ñ‡ÐºÐµ)
                bot.send_message(target_chat_id, f"[ÐŸÐµÑ€ÐµÑÐ»Ð°Ð½Ð¾ Ð¾Ñ‚ Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†Ð° {datetime.now(TZ).date()}]\n{text}")
            except Exception as e:
                update_or_send_today_window(chat_id, extra_text=f"âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿ÐµÑ€ÐµÑÐ»Ð°Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ: {e}")
            store["forward_target"] = None
            save_data(data)
            # Ð½Ðµ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ÑÑ â€” Ð²Ð»Ð°Ð´ÐµÐ»ÐµÑ† Ð¼Ð¾Ð¶ÐµÑ‚ Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÐ¸
    # 8.2 â€” ÐŸÐµÑ€ÐµÑÑ‹Ð»ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¸Ð· Ñ‡Ð°Ñ‚Ð° Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†Ñƒ (ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ)
    if chat_id != OWNER_ID and OWNER_ID:
        try:
            bot.send_message(OWNER_ID, f"Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚ {msg.from_user.first_name} ({chat_id}):\n{text}")
        except Exception as e:
            log_error(f"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿ÐµÑ€ÐµÑÐ»Ð°Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†Ñƒ: {e}")

    # 8.3 â€” Ð ÐµÐ¶Ð¸Ð¼Ñ‹ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ (Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ/ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ/Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿ÐµÑ€ÐµÑÑ‹Ð»ÐºÐ¸)
    wait_action = store.get("edit_wait")

    if wait_action is None:
        # ÐÐ²Ñ‚Ð¾-Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ: Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ°Ð¶Ð´ÑƒÑŽ ÑÑ‚Ñ€Ð¾ÐºÑƒ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾
        any_added = False
        for line in text.splitlines():
            amount, note = parse_line_amount(line)
            if amount is not None:
                add_record_to_chat(chat_id, amount, note, msg.from_user.id)
                any_added = True
        if any_added:
            update_or_send_today_window(chat_id, extra_text="âœ… Ð—Ð°Ð¿Ð¸ÑÐ¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ñ‹")
        else:
            # Ñ‚Ð°ÐºÐ¶Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ»ÑƒÐ¶ÐµÐ±Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð² Ð»Ð¸Ñ‡ÐºÐµ: /ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ_Ð¿ÐµÑ€ÐµÑÑ‹Ð»ÐºÑƒ
            if msg.text and msg.text.strip().lower() in ["/ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ_Ð¿ÐµÑ€ÐµÑÑ‹Ð»ÐºÑƒ", "/ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ_Ð¿ÐµÑ€ÐµÑÑ‹Ð»ÐºÑƒ@"+bot.get_me().username]:
                # ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¿ÐµÑ€ÐµÑÑ‹Ð»ÐºÑƒ Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð° (ÐµÑÐ»Ð¸ Ð±Ñ‹Ð»Ð°)
                store["forward_target"] = None
                save_data(data)
                update_or_send_today_window(chat_id, extra_text="ðŸ”• ÐŸÐµÑ€ÐµÑÑ‹Ð»ÐºÐ° Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°.")
                return
            update_or_send_today_window(chat_id)
        return

    # ÐµÑÐ»Ð¸ Ð¶Ð´ÐµÐ¼ ID Ð´Ð»Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸
    if wait_action == "change_id":
        try:
            rid = int(text.strip())
            # Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ð¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñ‚Ð°ÐºÐ°Ñ Ð·Ð°Ð¿Ð¸ÑÑŒ
            existing = False
            for r in store.get("records",[]):
                if r["id"]==rid:
                    existing=True; break
            if existing:
                store["edit_wait"]="change_value"
                store["edit_target"]=rid
                update_or_send_today_window(chat_id, extra_text=f"âœï¸ Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð²ÑƒÑŽ ÑÑƒÐ¼Ð¼Ñƒ Ð¸ Ð·Ð°Ð¼ÐµÑ‚ÐºÑƒ Ð´Ð»Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸ {rid} (Ñ + Ð´Ð»Ñ Ð¿Ñ€Ð¸Ñ…Ð¾Ð´Ð°):")
            else:
                update_or_send_today_window(chat_id, extra_text="âŒ Ð—Ð°Ð¿Ð¸ÑÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°. Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²ÐµÑ€Ð½Ñ‹Ð¹ ID.")
        except:
            update_or_send_today_window(chat_id, extra_text="âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ ID. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.")
        return

    # ÐµÑÐ»Ð¸ Ð¶Ð´ÐµÐ¼ Ð½Ð¾Ð²Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
    if wait_action == "change_value":
        rid = store.get("edit_target")
        if not rid:
            store["edit_wait"]=None
            store["edit_target"]=None
            return
        amount, note = parse_line_amount(text)
        if amount is None:
            update_or_send_today_window(chat_id, extra_text="âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ ÑÑƒÐ¼Ð¼Ñ‹. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ + Ð´Ð»Ñ Ð¿Ñ€Ð¸Ñ…Ð¾Ð´Ð° Ð¸Ð»Ð¸ -/Ð±ÐµÐ· Ð·Ð½Ð°ÐºÐ° Ð´Ð»Ñ Ñ€Ð°ÑÑ…Ð¾Ð´Ð°.")
            return
        success,_ = update_record_in_chat(chat_id, rid, amount, note)
        if success:
            update_or_send_today_window(chat_id, extra_text=f"âœ… Ð—Ð°Ð¿Ð¸ÑÑŒ {rid} Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð°")
        else:
            update_or_send_today_window(chat_id, extra_text=f"âŒ Ð—Ð°Ð¿Ð¸ÑÑŒ {rid} Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°")
        store["edit_wait"]=None
        store["edit_target"]=None
        return

    # ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾ ID
    if wait_action == "delete_id":
        try:
            rid = int(text.strip())
            success,_ = delete_record_in_chat(chat_id, rid)
            if success:
                update_or_send_today_window(chat_id, extra_text=f"âœ… Ð—Ð°Ð¿Ð¸ÑÑŒ {rid} ÑƒÐ´Ð°Ð»ÐµÐ½Ð°")
            else:
                update_or_send_today_window(chat_id, extra_text=f"âŒ Ð—Ð°Ð¿Ð¸ÑÑŒ {rid} Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°")
        except:
            update_or_send_today_window(chat_id, extra_text="âŒ ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ ID. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.")
        store["edit_wait"]=None
        store["edit_target"]=None
        return

    # ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° target Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÑÑ‹Ð»ÐºÐ¸ Ð¸Ð· Ð»Ð¸Ñ‡ÐºÐ¸ Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†Ð°
    if wait_action == "set_forward_target":
        try:
            target_chat_id = int(text.strip())
            store["forward_target"] = target_chat_id
            store["edit_wait"] = None
            save_data(data)
            update_or_send_today_window(chat_id, extra_text=f"âœ… ÐŸÐµÑ€ÐµÑÑ‹Ð»ÐºÐ° Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð° Ð² Ñ‡Ð°Ñ‚ {target_chat_id}")
        except:
            update_or_send_today_window(chat_id, extra_text="âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ ID Ñ‡Ð°Ñ‚Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.")
        return

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 9 â€” ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° callback-ÐºÐ½Ð¾Ð¿Ð¾Ðº
# -----------------------------
@bot.callback_query_handler(func=lambda call: True)
def handle_buttons(call):
    chat_id = call.message.chat.id
    store = get_chat_store(chat_id)
    data_id = call.data
    msg_id = call.message.message_id

    # noop
    if data_id == "noop":
        bot.answer_callback_query(call.id)
        return

    # Ð±Ð°Ð»Ð°Ð½Ñ Ð¿Ð¾Ð´ÑÐºÐ°Ð·ÐºÐ¾Ð¹
    if data_id == "btn_balance":
        bot.answer_callback_query(call.id, f"ðŸ’° Ð‘Ð°Ð»Ð°Ð½Ñ: {format_amount(store.get('balance',0))} ARS")
        return

    # Ð¾Ñ‚Ñ‡Ñ‘Ñ‚: Ð¿Ñ€Ð¸Ñ…Ð¾Ð´/Ñ€Ð°ÑÑ…Ð¾Ð´/Ð¾Ð±Ñ‰Ð¸Ð¹ Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ðº
    if data_id == "btn_report":
        today_key = get_today_key()
        day_records = store.get("daily_records", {}).get(today_key, [])
        inc = sum(r["amount"] for r in day_records if r["amount"]>0)
        exp = sum(r["amount"] for r in day_records if r["amount"]<0)
        text = (f"ðŸ“… {today_key}\n"
                f"ÐŸÑ€Ð¸Ñ…Ð¾Ð´: {format_amount(inc)}\n"
                f"Ð Ð°ÑÑ…Ð¾Ð´: {format_amount(abs(exp))}\n"
                f"ÐžÐ±Ñ‰Ð¸Ð¹ Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ðº: {format_amount(store.get('balance',0))}")
        try:
            bot.edit_message_text(text, chat_id, msg_id, reply_markup=build_main_keyboard(chat_id))
        except:
            bot.send_message(chat_id, text, reply_markup=build_main_keyboard(chat_id))
        bot.answer_callback_query(call.id)
        return

    # Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ â€” Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð·Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ Ñ ÐºÐ½Ð¾Ð¿ÐºÐ°Ð¼Ð¸ ÑÐ¿Ñ€Ð°Ð²Ð°
    if data_id == "btn_edit":
        today_key = get_today_key()
        day_records = store.get("daily_records", {}).get(today_key, [])[-12:]
        if not day_records:
            update_or_send_today_window(chat_id, extra_text="ðŸ“‹ ÐÐµÑ‚ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð´Ð»Ñ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÑÐµÐ³Ð¾Ð´Ð½Ñ.")
            bot.answer_callback_query(call.id)
            return
        lines = [f"ðŸ“‹ Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð° {today_key}:"]
        kb = types.InlineKeyboardMarkup(row_width=2)
        for r in day_records:
            amount_str = format_amount(r["amount"])
            lines.append(f"{r['short_id']}: {amount_str} â€” {r.get('note','')}")
            kb.add(
                types.InlineKeyboardButton(f"âœï¸{r['short_id']}", callback_data=f"edit_change_{r['id']}"),
                types.InlineKeyboardButton(f"ðŸ—‘ï¸{r['short_id']}", callback_data=f"edit_delete_{r['id']}")
            )
        kb.add(types.InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data="btn_back_info"))
        text = "\n".join(lines)
        try:
            bot.edit_message_text(text, chat_id, msg_id, reply_markup=kb)
        except Exception as e:
            try:
                sent = bot.send_message(chat_id, text, reply_markup=kb)
                set_today_active_window(chat_id, sent.message_id)
            except Exception as e2:
                log_error(f"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ: {e2}")
        bot.answer_callback_query(call.id)
        return

    # Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ½Ð¾Ð¿Ð¾Ðº Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¿Ð¾ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð¼Ñƒ id
    if data_id.startswith("edit_change_"):
        rid = int(data_id.split("_")[-1])
        # Ð¡Ñ‚Ð°Ð²Ð¸Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ Ð²Ð²Ð¾Ð´Ð° Ð½Ð¾Ð²Ð¾Ð¹ ÑÑƒÐ¼Ð¼Ñ‹
        store["edit_wait"] = "change_id"
        store["edit_target"] = rid
        save_data(data)
        update_or_send_today_window(chat_id, extra_text=f"âœï¸ Ð’Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ð»Ð¸ {rid}. Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð²ÑƒÑŽ ÑÑƒÐ¼Ð¼Ñƒ (Ñ + Ð´Ð»Ñ Ð¿Ñ€Ð¸Ñ…Ð¾Ð´Ð°).")
        bot.answer_callback_query(call.id)
        return

    if data_id.startswith("edit_delete_"):
        rid = int(data_id.split("_")[-1])
        success,_ = delete_record_in_chat(chat_id, rid)
        if success:
            update_or_send_today_window(chat_id, extra_text=f"âœ… Ð—Ð°Ð¿Ð¸ÑÑŒ {rid} ÑƒÐ´Ð°Ð»ÐµÐ½Ð°")
        else:
            update_or_send_today_window(chat_id, extra_text=f"âŒ Ð—Ð°Ð¿Ð¸ÑÑŒ {rid} Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°")
        bot.answer_callback_query(call.id)
        return

    # ÐºÐ½Ð¾Ð¿ÐºÐ° Ð¾Ð±Ð½ÑƒÐ»Ð¸Ñ‚ÑŒ â€” Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ
    if data_id == "btn_reset":
        kb = build_main_keyboard(chat_id, confirm_reset=True)
        try:
            bot.edit_message_reply_markup(chat_id, msg_id, reply_markup=kb)
        except:
            try:
                bot.send_message(chat_id, "âš ï¸ ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…:", reply_markup=kb)
            except:
                pass
        bot.answer_callback_query(call.id)
        return

    if data_id == "confirm_reset":
        # ÐžÐ±Ð½ÑƒÐ»ÑÐµÐ¼ Ð¢ÐžÐ›Ð¬ÐšÐž Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÑ‚Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°
        data["chats"][str(chat_id)]={"balance":0,"records":[],"next_id":1,"daily_records":{},"active_windows":{},"edit_wait":None,"edit_target":None,"forward_target":None}
        save_data(data)
        export_to_csv(data)
        update_or_send_today_window(chat_id, extra_text="â™»ï¸ Ð’ÑÐµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ð±Ð½ÑƒÐ»ÐµÐ½Ñ‹ Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°")
        bot.answer_callback_query(call.id)
        return

    if data_id == "cancel_reset":
        update_or_send_today_window(chat_id, extra_text="ÐžÑ‚Ð¼ÐµÐ½Ð° âœ…")
        bot.answer_callback_query(call.id)
        return

    if data_id == "export_csv":
        try:
            export_to_csv(data)
            with open(CSV_FILE, "rb") as f:
                bot.send_document(chat_id, f, caption="ðŸ“„ Ð’Ð°Ñˆ CSV-Ñ„Ð°Ð¹Ð»")
        except Exception as e:
            update_or_send_today_window(chat_id, extra_text="âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ CSV.")
        bot.answer_callback_query(call.id)
        return

    # btn_forward â€” Ð²ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ñ€ÐµÐ¶Ð¸Ð¼ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ñ Ð²Ð²Ð¾Ð´Ð° ID Ñ‡Ð°Ñ‚Ð° Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÑÑ‹Ð»ÐºÐ¸ Ð¸Ð· Ð»Ð¸Ñ‡ÐºÐ¸ Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†Ð°
    if data_id == "btn_forward":
        store["edit_wait"] = "set_forward_target"
        save_data(data)
        update_or_send_today_window(chat_id, extra_text="ðŸ“¤ Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ID Ñ‡Ð°Ñ‚Ð°, ÐºÑƒÐ´Ð° Ð¿ÐµÑ€ÐµÑÑ‹Ð»Ð°Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¸Ð· Ð²Ð°ÑˆÐµÐ¹ Ð»Ð¸Ñ‡ÐºÐ¸:")
        bot.answer_callback_query(call.id)
        return

    if data_id == "btn_back_info":
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id)
        return

    if data_id == "btn_cod":
        bot.answer_callback_query(call.id)
        bot.send_message(chat_id, f"Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð±Ð¾Ñ‚ â€” Ð²ÐµÑ€ÑÐ¸Ñ {VERSION}\nÐŸÑ€Ð°Ð²Ð¸Ð»Ð¾: + â€” Ð¿Ñ€Ð¸Ñ…Ð¾Ð´, Ð±ÐµÐ· Ð·Ð½Ð°ÐºÐ° Ð¸Ð»Ð¸ - â€” Ñ€Ð°ÑÑ…Ð¾Ð´.\nÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ_Ð¿ÐµÑ€ÐµÑÑ‹Ð»ÐºÑƒ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ Ð¿ÐµÑ€ÐµÑÑ‹Ð»ÐºÑƒ.")
        return

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 10 â€” Flask webhook
# -----------------------------
@app.route(f"/{TOKEN}",methods=["POST"])
def webhook():
    update=telebot.types.Update.de_json(request.get_data().decode("utf-8"))
    bot.process_new_updates([update])
    return "OK",200

@app.route("/",methods=["GET"])
def index():
    return f"Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð±Ð¾Ñ‚ Â«Ð¤ÐžÂ» â€” Ð²ÐµÑ€ÑÐ¸Ñ {VERSION} Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚",200

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 11 â€” ÐŸÐ»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ñ‰Ð¸Ðº ÑÐ¼ÐµÐ½Ñ‹ Ð´Ð½Ñ
# -----------------------------
def schedule_daily_window_creation():
    def task():
        last_day=get_today_key()
        while True:
            try:
                time.sleep(60)
                current_day=get_today_key()
                if current_day!=last_day:
                    for chat_id_str in list(data.get("chats",{}).keys()):
                        try: chat_id=int(chat_id_str)
                        except: continue
                        try: update_or_send_today_window(chat_id)
                        except Exception as e: log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð¾ÐºÐ½Ð° Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð´Ð½Ñ Ð´Ð»Ñ {chat_id}: {e}")
                    last_day=current_day
            except Exception as e:
                log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð² daily loop: {e}"); time.sleep(5)
    thread=threading.Thread(target=task,daemon=True)
    thread.start()

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 12 â€” Ð—Ð°Ð¿ÑƒÑÐº
# -----------------------------
def set_webhook():
    url=f"{APP_URL}/{TOKEN}"
    try:
        bot.remove_webhook()
        time.sleep(0.5)
        bot.set_webhook(url=url)
        log_info(f"Webhook ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½: {url}")
    except Exception as e:
        log_error(f"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ webhook: {e}")

if __name__=="__main__":
    set_webhook()
    schedule_daily_window_creation()
    log_info(f"Ð‘Ð¾Ñ‚ Ð¤Ðž Ð²ÐµÑ€ÑÐ¸Ð¸ {VERSION} Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½")
    if OWNER_ID:
        try:
            bot.send_message(int(OWNER_ID),f"Ð‘Ð¾Ñ‚ Ð¤Ðž Ð²ÐµÑ€ÑÐ¸Ð¸ {VERSION} Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½")
        except Exception:
            pass
    app.run(host="0.0.0.0",port=PORT)