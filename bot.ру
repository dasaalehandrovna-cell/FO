#–û–¢–°–ï–ö–ò 1‚Äì3: –∏–º–ø–æ—Ä—Ç—ã, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, Telethon, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –±–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö

# ============================================================
# üßæ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è 9.8.6-fo_6+autoCSV (Telethon-channel, –±–µ–∑ Drive/–ª–∏—á–∫–∏)
# ID Code_020b
# ============================================================
# üß≠ –û–ø–∏—Å–∞–Ω–∏–µ:
#  ‚Ä¢ –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è –≤–µ—Ä—Å–∏—è –±–µ–∑ Google Drive –∏ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤–ª–∞–¥–µ–ª—å—Ü—É
#  ‚Ä¢ –ë—ç–∫–∞–ø –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–∞–Ω–∞–ª (Telethon)
#  ‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –ª—é–±—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –º–µ–∂–¥—É —á–∞—Ç–∞–º–∏
#  ‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ—Å—ã–ª–∫–æ–π ‚Äî —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º
#  ‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å
#  ‚Ä¢ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π /–ø–æ–µ—Ö–∞–ª–∏–§–û123/
# ============================================================

import os
import json
import csv
import re
import html
import logging
import threading
import time
from datetime import datetime, timedelta, timezone
from zoneinfo import ZoneInfo

import requests
import telebot
from telebot import types
from flask import Flask, request
from telethon import TelegramClient

# ============================================================
# ‚öôÔ∏è –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
# ============================================================
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")  # —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤
APP_URL = os.getenv("APP_URL", "https://yourapp.onrender.com")
BACKUP_CHAT_ID = os.getenv("BACKUP_CHAT_ID")  # ID –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –¥–ª—è –±—ç–∫–∞–ø–æ–≤
API_ID = int(os.getenv("API_ID", 38779045))
API_HASH = os.getenv("API_HASH", "8d351ca6eb4b233fa86d898c6bdd9173")
SESSION_NAME = "my_account"

if not TOKEN:
    raise ValueError("‚ùå BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# ============================================================
# üïí –ù–ê–°–¢–†–û–ô–ö–ò –í–†–ï–ú–ï–ù–ò –ò –ü–û–í–ï–î–ï–ù–ò–Ø
# ============================================================
try:
    TZ = ZoneInfo((os.getenv("TZ") or "America/Argentina/Buenos_Aires").strip())
except Exception:
    TZ = timezone(timedelta(hours=-3))  # UTC‚àí3 ‚Äî fallback

PORT = int(os.environ.get("PORT", 5000))
VERSION = "9.8.6-fo_6+autoCSV (Telethon-channel, –±–µ–∑ Drive/–ª–∏—á–∫–∏)"

KEEP_ALIVE_INTERVAL_SECONDS = int(os.getenv("KEEP_ALIVE_INTERVAL_SECONDS", 11 * 60))
DELETE_SOURCE_WINDOW_ON_NAV = False
DELETE_TARGET_OLD_WINDOW_ON_NAV = True
ALWAYS_CREATE_NEW_ON_NAV = True

DATA_FILE = "data.json"
CSV_FILE = "data.csv"
CSV_META_FILE = "csv_meta.json"
LOG_FILE = "log.txt"

# ============================================================
# ü§ñ TELETHON
# ============================================================
tele_client = TelegramClient(SESSION_NAME, API_ID, API_HASH)

async def telethon_info():
    try:
        me = await tele_client.get_me()
        print(f"‚úÖ Telethon –ø–æ–¥–∫–ª—é—á—ë–Ω –∫–∞–∫ {me.first_name} (ID: {me.id})")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ Telethon: {e}")

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telethon (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)
with tele_client:
    tele_client.loop.run_until_complete(telethon_info())

# ============================================================
# üß© –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –§–ê–ô–õ–û–í –ß–ï–†–ï–ó TELETHON
# ============================================================
async def restore_files_via_telethon():
    """
    –ò—â–µ—Ç –∏ —Å–∫–∞—á–∏–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ —Ñ–∞–π–ª–æ–≤ (data.csv, data.json, csv_meta.json)
    –∏–∑ –∫–∞–Ω–∞–ª–∞ BACKUP_CHAT_ID.
    """
    chat_id = int(os.getenv("BACKUP_CHAT_ID", 0))
    if not chat_id:
        print("‚ö†Ô∏è BACKUP_CHAT_ID –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.")
        return

    target_files = {"data.csv", "data.json", "csv_meta.json"}
    found = 0
    try:
        async for msg in tele_client.iter_messages(chat_id, limit=100):
            if not msg.file or not msg.file.name:
                continue
            fname = msg.file.name
            if fname in target_files:
                await msg.download_media(file=fname)
                print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω {fname} —á–µ—Ä–µ–∑ Telethon.")
                found += 1
                target_files.remove(fname)
            if not target_files:
                break
        if found == 0:
            print("‚ö†Ô∏è –§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –∫–∞–Ω–∞–ª–µ.")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ restore_files_via_telethon: {e}")

# ============================================================
# üßæ –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
# ============================================================
logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[
        logging.FileHandler(LOG_FILE, encoding="utf-8"),
        logging.StreamHandler()
    ]
)

def log_info(msg): logging.info(msg)
def log_error(msg): logging.error(msg)
def log_warning(msg): logging.warning(msg)

# ============================================================
# üïí –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –í–†–ï–ú–ï–ù–ò
# ============================================================
def now_local() -> datetime:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è"""
    return datetime.now(TZ)

def today_key() -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞—Ç—É YYYY-MM-DD"""
    return now_local().strftime("%Y-%m-%d")

def parse_date_key(s: str):
    """–ü–∞—Ä—Å–∏—Ç YYYY-MM-DD –≤ datetime.date"""
    try:
        return datetime.strptime(s, "%Y-%m-%d").date()
    except Exception:
        return None

def shift_date_key(day_key: str, days: int) -> str:
    """–°–¥–≤–∏–≥–∞–µ—Ç –¥–∞—Ç—É –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π"""
    d = parse_date_key(day_key) or now_local().date()
    return (d + timedelta(days=days)).strftime("%Y-%m-%d")

def fmt_num(value):
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —á–∏—Å–ª–æ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏"""
    try:
        return f"{value:,.0f}".replace(",", ".")
    except Exception:
        return str(value)

# ============================================================
# üíæ –û–°–ù–û–í–ù–´–ï –°–¢–†–£–ö–¢–£–†–´ –î–ê–ù–ù–´–•
# ============================================================
def default_data():
    """–ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö"""
    return {
        "overall_balance": 0,
        "records": [],
        "chats": {},
        "active_messages": {},
        "processed_messages": [],
        "forward_rules": {},       # üî∏ NEW ‚Äî –ø—Ä–∞–≤–∏–ª–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏
        "next_id": 1
    }

def _load_json(path, fallback):
    try:
        if os.path.exists(path):
            with open(path, "r", encoding="utf-8") as f:
                return json.load(f)
    except Exception as e:
        log_error(f"_load_json: {path}: {e}")
    return fallback

def _save_json(path, payload):
    try:
        with open(path, "w", encoding="utf-8") as f:
            json.dump(payload, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"_save_json: {path}: {e}")

def load_data():
    d = _load_json(DATA_FILE, default_data())
    base = default_data()
    for k, v in base.items():
        if k not in d:
            d[k] = v
    return d

data = load_data()
log_info(f"üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤–µ—Ä—Å–∏–∏ {VERSION}")

#=== –ß–ê–°–¢–¨ 1 –ó–ê–ö–û–ù–ß–ï–ù–ê ===
#(–°–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å ‚Äî –ß–ê–°–¢–¨ 2 / 6: —Ñ—É–Ω–∫—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞, –±—ç–∫–∞–ø –≤ –∫–∞–Ω–∞–ª —á–µ—Ä–µ–∑ Telethon, CSV, restore, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.)
# ============================================================
# üì¶ –û–¢–°–ï–ö 4 ‚Äî –≠–ö–°–ü–û–†–¢ CSV –ò –ú–ï–¢–ê
# ============================================================

def export_to_csv(data):
    """–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ CSV"""
    try:
        rows = []
        for chat_id, chat_data in data.get("chats", {}).items():
            for day, items in chat_data.get("records", {}).items():
                for rec in items:
                    rows.append([
                        chat_id,
                        day,
                        rec.get("id", ""),
                        rec.get("category", ""),
                        rec.get("comment", ""),
                        rec.get("amount", 0)
                    ])
        with open(CSV_FILE, "w", newline="", encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow(["chat_id", "date", "id", "category", "comment", "amount"])
            writer.writerows(rows)
        log_info("‚úÖ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ CSV.")
    except Exception as e:
        log_error(f"export_to_csv: {e}")

def _load_csv_meta():
    """–ó–∞–≥—Ä—É–∑–∫–∞ csv_meta.json"""
    return _load_json(CSV_META_FILE, {"message_id": None, "file_id": None})

def _save_csv_meta(meta):
    _save_json(CSV_META_FILE, meta)

# ============================================================
# üì§ –û–¢–°–ï–ö 5 ‚Äî –ë–≠–ö–ê–ü –í –ö–ê–ù–ê–õ –ß–ï–†–ï–ó TELETHON
# ============================================================

async def backup_files_to_channel():
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç JSON/CSV/–º–µ—Ç–∞ –≤ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–∞–Ω–∞–ª —á–µ—Ä–µ–∑ Telethon"""
    try:
        chat_id = int(os.getenv("BACKUP_CHAT_ID", 0))
        if not chat_id:
            log_warning("‚ö†Ô∏è BACKUP_CHAT_ID –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫ –±—ç–∫–∞–ø–∞.")
            return

        export_to_csv(data)
        meta = _load_csv_meta()
        files_to_send = [DATA_FILE, CSV_FILE, CSV_META_FILE]
        log_info("‚òÅÔ∏è –ó–∞–ø—É—Å–∫ –±—ç–∫–∞–ø–∞ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ Telethon...")

        async with tele_client:
            for fname in files_to_send:
                if not os.path.exists(fname):
                    continue
                try:
                    await tele_client.send_file(
                        chat_id,
                        file=fname,
                        caption=f"üì¶ –ë—ç–∫–∞–ø {fname} ({datetime.now(TZ).strftime('%Y-%m-%d %H:%M:%S')})",
                        force_document=True
                    )
                    log_info(f"‚úÖ {fname} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –∫–∞–Ω–∞–ª.")
                except Exception as e:
                    log_error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ {fname}: {e}")
    except Exception as e:
        log_error(f"backup_files_to_channel: {e}")

def schedule_backup_to_channel():
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π Telethon-–±—ç–∫–∞–ø –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ"""
    try:
        import asyncio
        loop = asyncio.get_event_loop()
        if loop.is_running():
            asyncio.create_task(backup_files_to_channel())
        else:
            loop.run_until_complete(backup_files_to_channel())
    except Exception as e:
        log_error(f"schedule_backup_to_channel: {e}")

# ============================================================
# üîÑ –û–¢–°–ï–ö 6 ‚Äî –ê–í–¢–û–°–û–•–†–ê–ù–ï–ù–ò–ï, –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï
# ============================================================

def save_data():
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ JSON"""
    _save_json(DATA_FILE, data)
    log_info("üíæ data.json —Å–æ—Ö—Ä–∞–Ω—ë–Ω")

def restore_from_backup_if_needed():
    """–ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ Telethon"""
    missing = []
    for f in [DATA_FILE, CSV_FILE, CSV_META_FILE]:
        if not os.path.exists(f):
            missing.append(f)
    if not missing:
        return
    log_warning(f"üì¶ –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ñ–∞–π–ª—ã: {missing} ‚Üí –ø–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ –∫–∞–Ω–∞–ª...")
    import asyncio
    asyncio.run(restore_files_via_telethon())
    print("‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.")

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
restore_from_backup_if_needed()

# ============================================================
# üß† –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ß–ò–°–ï–õ
# ============================================================

def parse_amount(raw):
    """
    –ü–∞—Ä—Å–∏—Ç —Å—É–º–º—É, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—è –ø—Ä–æ–±–µ–ª—ã, —Ç–æ—á–∫–∏, –∑–∞–ø—è—Ç—ã–µ –∏ —Å–º–µ—à–∞–Ω–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏.
    –ü—Ä–∏–º–µ—Ä—ã: "1.200", "1 200", "1,200", "1.200,50", "-2.345,60"
    """
    try:
        if not raw:
            return 0
        s = str(raw).strip()
        s = s.replace(" ", "").replace(",", ".")
        # —É–¥–∞–ª—è–µ–º –≤—Å–µ, –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä, —Ç–æ—á–∫–∏ –∏ –º–∏–Ω—É—Å–∞
        s = re.sub(r"[^0-9\.-]", "", s)
        return float(s)
    except Exception:
        return 0.0

# ============================================================
# üß© –û–¢–°–ï–ö 7 ‚Äî –ü–ï–†–ï–°–ß–Å–¢ –û–ë–©–ï–ì–û –ë–ê–õ–ê–ù–°–ê (–ü–û –ß–ê–¢–£)
# ============================================================

def calculate_total_for_chat(chat_id: int):
    """–°—á–∏—Ç–∞–µ—Ç –±–∞–ª–∞–Ω—Å —Ç–æ–ª—å–∫–æ –ø–æ —Ç–µ–∫—É—â–µ–º—É —á–∞—Ç—É"""
    try:
        chat_data = data.get("chats", {}).get(str(chat_id), {})
        total = 0
        for day, records in chat_data.get("records", {}).items():
            for rec in records:
                total += rec.get("amount", 0)
        return total
    except Exception:
        return 0
        
        #=== –ß–ê–°–¢–¨ 2 –ó–ê–ö–û–ù–ß–ï–ù–ê ===

#(–°–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å ‚Äî –ß–ê–°–¢–¨ 3 / 6: –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ–º–∞–Ω–¥—ã, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–∫–Ω–∞ –¥–Ω—è, –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π —Å –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–æ–π ¬´‚ûï –î–æ–±–∞–≤–∏—Ç—å¬ª.)
# ============================================================
# üí¨ –û–¢–°–ï–ö 8 ‚Äî –ò–ù–¢–ï–†–§–ï–ô–° –û–°–ù–û–í–ù–û–ì–û –û–ö–ù–ê
# ============================================================

def build_main_menu(chat_id, day_key):
    """–§–æ—Ä–º–∏—Ä—É–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è"""
    keyboard = types.InlineKeyboardMarkup()
    keyboard.row(
        types.InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å", callback_data=f"add_record:{day_key}"),
        types.InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"edit_menu:{day_key}")
    )
    keyboard.row(
        types.InlineKeyboardButton("‚¨ÖÔ∏è –ü—Ä–µ–¥—ã–¥—É—â–∏–π", callback_data=f"nav_prev:{day_key}"),
        types.InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data=f"nav_today"),
        types.InlineKeyboardButton("‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π", callback_data=f"nav_next:{day_key}")
    )
    keyboard.row(
        types.InlineKeyboardButton("üìÜ –í—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å", callback_data=f"calendar:{day_key}")
    )
    keyboard.row(
        types.InlineKeyboardButton("üí∞ –û–±—â–∏–π –∏—Ç–æ–≥", callback_data=f"show_balance:{day_key}")
    )
    return keyboard


def render_day_window(chat_id, day_key):
    """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –æ–∫–Ω–æ –¥–Ω—è"""
    chat_data = data.get("chats", {}).setdefault(str(chat_id), {"records": {}})
    records = chat_data["records"].get(day_key, [])
    lines = [f"üìÖ <b>{day_key}</b>"]
    total = 0
    for rec in records:
        amount = rec.get("amount", 0)
        total += amount
        sign = "‚ûï" if amount >= 0 else "‚ûñ"
        lines.append(f"{sign} {fmt_num(amount)} ‚Äî {html.escape(rec.get('comment',''))}")
    lines.append("")
    lines.append(f"<b>üí∞ –ò—Ç–æ–≥–æ:</b> {fmt_num(total)}")
    text = "\n".join(lines)
    keyboard = build_main_menu(chat_id, day_key)
    return text, keyboard


def update_main_window(chat_id, msg_id, day_key):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –æ–∫–Ω–æ –¥–Ω—è"""
    try:
        text, keyboard = render_day_window(chat_id, day_key)
        bot.edit_message_text(
            text,
            chat_id=chat_id,
            message_id=msg_id,
            reply_markup=keyboard,
            parse_mode="HTML"
        )
    except Exception as e:
        log_warning(f"refresh edit: {e}")


# ============================================================
# ‚úèÔ∏è –û–¢–°–ï–ö 9 ‚Äî –ú–ï–ù–Æ –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø (—Å –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–æ–π ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª)
# ============================================================

def build_edit_menu(day_key):
    kb = types.InlineKeyboardMarkup()
    kb.row(types.InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å", callback_data=f"edit_add:{day_key}"))  # üî∏ NEW
    kb.row(types.InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å", callback_data=f"edit_delete:{day_key}"))
    kb.row(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"back_to_main:{day_key}"))
    return kb


@bot.callback_query_handler(func=lambda c: c.data.startswith("edit_menu:"))
def handle_edit_menu(call):
    day_key = call.data.split(":", 1)[1]
    kb = build_edit_menu(day_key)
    bot.edit_message_text(
        f"‚úèÔ∏è <b>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å–∏ –∑–∞ {day_key}</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        chat_id=call.message.chat.id,
        message_id=call.message.id,
        reply_markup=kb,
        parse_mode="HTML"
    )

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
@bot.callback_query_handler(func=lambda c: c.data.startswith("edit_add:"))
def handle_edit_add(call):
    day_key = call.data.split(":", 1)[1]
    chat_id = call.message.chat.id
    bot.send_message(chat_id, f"–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è {day_key}:")
    data["chats"].setdefault(str(chat_id), {"records": {}})

    # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    data["active_messages"][str(chat_id)] = {"mode": "add_edit", "day": day_key, "time": time.time()}
    save_data()

# –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ 30 —Å–µ–∫—É–Ω–¥ –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
def monitor_edit_timeout():
    while True:
        now = time.time()
        to_reset = []
        for cid, st in data.get("active_messages", {}).items():
            if st.get("mode") in ("add_edit", "edit_del"):
                if now - st.get("time", 0) > 30:
                    to_reset.append(cid)
        for cid in to_reset:
            chat_id = int(cid)
            day_key = data["active_messages"][cid]["day"]
            data["active_messages"].pop(cid, None)
            text, kb = render_day_window(chat_id, day_key)
            try:
                bot.send_message(chat_id, "‚åõ –í—Ä–µ–º—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.")
                bot.send_message(chat_id, text, reply_markup=kb, parse_mode="HTML")
            except:
                pass
        time.sleep(5)

threading.Thread(target=monitor_edit_timeout, daemon=True).start()

# ============================================================
# üìÜ –û–¢–°–ï–ö 10 ‚Äî –ö–ê–õ–ï–ù–î–ê–†–¨ (–¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ ¬´–ù–∞–∑–∞–¥¬ª)
# ============================================================

def build_calendar_keyboard(current_day):
    """–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ 31 –¥–µ–Ω—å"""
    kb = types.InlineKeyboardMarkup()
    today = parse_date_key(current_day) or now_local().date()
    dates = [(today - timedelta(days=i)).strftime("%Y-%m-%d") for i in range(31)]
    row = []
    for i, d in enumerate(dates):
        row.append(types.InlineKeyboardButton(d[-2:], callback_data=f"view:{d}"))
        if len(row) == 7:
            kb.row(*row)
            row = []
    if row:
        kb.row(*row)
    kb.row(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"back_to_main:{current_day}"))  # üî∏ NEW
    return kb


@bot.callback_query_handler(func=lambda c: c.data.startswith("calendar:"))
def handle_calendar(call):
    current_day = call.data.split(":", 1)[1]
    kb = build_calendar_keyboard(current_day)
    bot.edit_message_text(
        "üìÜ –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å:",
        chat_id=call.message.chat.id,
        message_id=call.message.id,
        reply_markup=kb
    )
    
    #=== –ß–ê–°–¢–¨ 3 –ó–ê–ö–û–ù–ß–ï–ù–ê ===
    #–°–ª–µ–¥—É—é—â–∞—è ‚Äî –ß–ê–°–¢–¨ 4 / 6, –≥–¥–µ –±—É–¥—É—Ç:‚Ä¢	–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π;‚Ä¢	–ø–µ—Ä–µ—Å—á—ë—Ç, –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ,‚Ä¢	–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–∫–Ω–∞ –∏ –∑–∞–ø—É—Å–∫ –±—ç–∫–∞–ø–∞ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–ø–æ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–µ).

# ============================================================
# üßæ –û–¢–°–ï–ö 11 ‚Äî –î–û–ë–ê–í–õ–ï–ù–ò–ï –ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–ü–ò–°–ï–ô
# ============================================================

@bot.callback_query_handler(func=lambda c: c.data.startswith("add_record:"))
def handle_add_record(call):
    """–ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ (–æ—Å–Ω–æ–≤–Ω–æ–µ –æ–∫–Ω–æ)"""
    day_key = call.data.split(":", 1)[1]
    chat_id = call.message.chat.id
    msg = bot.send_message(chat_id, f"–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è {day_key}:")
    data["active_messages"][str(chat_id)] = {"mode": "add_main", "day": day_key, "msg_id": msg.id, "time": time.time()}
    save_data()


@bot.message_handler(func=lambda m: str(m.chat.id) in data.get("active_messages", {}))
def handle_add_text(msg):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–≤–æ–¥ —Å—É–º–º—ã –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è"""
    chat_id = msg.chat.id
    state = data["active_messages"].get(str(chat_id))
    if not state:
        return
    day_key = state["day"]
    text = msg.text.strip()
    parts = text.split(maxsplit=1)
    amount = parse_amount(parts[0]) if parts else 0
    comment = parts[1] if len(parts) > 1 else ""

    # –°–æ–∑–¥–∞—ë–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å
    chat_data = data["chats"].setdefault(str(chat_id), {"records": {}})
    recs = chat_data["records"].setdefault(day_key, [])
    rec_id = data["next_id"]
    data["next_id"] += 1
    recs.append({"id": rec_id, "amount": amount, "comment": comment})

    # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    data["active_messages"].pop(str(chat_id), None)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
    save_data()

    # –û–±–Ω–æ–≤–ª—è–µ–º –æ–∫–Ω–æ –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –¥–µ–ª–∞–µ–º –±—ç–∫–∞–ø (–ø–æ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–µ)
    try:
        text, kb = render_day_window(chat_id, day_key)
        bot.send_message(chat_id, "‚úÖ –ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞.")
        bot.send_message(chat_id, text, reply_markup=kb, parse_mode="HTML")
    except Exception as e:
        log_warning(f"update window after add: {e}")

    # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º –±—ç–∫–∞–ø
    schedule_backup_to_channel()


# ============================================================
# üóë –û–¢–°–ï–ö 12 ‚Äî –£–î–ê–õ–ï–ù–ò–ï –ó–ê–ü–ò–°–ï–ô
# ============================================================

@bot.callback_query_handler(func=lambda c: c.data.startswith("edit_delete:"))
def handle_edit_delete(call):
    day_key = call.data.split(":", 1)[1]
    chat_id = call.message.chat.id
    chat_data = data.get("chats", {}).get(str(chat_id), {"records": {}})
    recs = chat_data.get("records", {}).get(day_key, [])
    if not recs:
        bot.answer_callback_query(call.id, "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
        return

    kb = types.InlineKeyboardMarkup()
    for rec in recs:
        label = f"{fmt_num(rec['amount'])} {rec.get('comment','')[:15]}"
        kb.row(types.InlineKeyboardButton(f"‚ùå {label}", callback_data=f"delrec:{day_key}:{rec['id']}"))
    kb.row(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"back_to_main:{day_key}"))
    bot.edit_message_text(
        f"–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è ({day_key}):",
        chat_id=chat_id,
        message_id=call.message.id,
        reply_markup=kb
    )


@bot.callback_query_handler(func=lambda c: c.data.startswith("delrec:"))
def handle_delete_record(call):
    parts = call.data.split(":")
    if len(parts) != 3:
        return
    day_key, rec_id = parts[1], int(parts[2])
    chat_id = call.message.chat.id
    chat_data = data["chats"].setdefault(str(chat_id), {"records": {}})
    recs = chat_data["records"].setdefault(day_key, [])
    before = len(recs)
    recs = [r for r in recs if r.get("id") != rec_id]
    chat_data["records"][day_key] = recs
    after = len(recs)
    data["chats"][str(chat_id)] = chat_data
    save_data()

    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–∫–Ω–∞ –∏ –±—ç–∫–∞–ø –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
    text, kb = render_day_window(chat_id, day_key)
    bot.edit_message_text(text, chat_id=chat_id, message_id=call.message.id, reply_markup=kb, parse_mode="HTML")
    if before != after:
        log_info(f"üóë –£–¥–∞–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å ID {rec_id} ({day_key}) –≤ —á–∞—Ç–µ {chat_id}")
    schedule_backup_to_channel()


# ============================================================
# üí∞ –û–¢–°–ï–ö 13 ‚Äî –û–ë–©–ò–ô –ò–¢–û–ì (–ø–æ —Ç–µ–∫—É—â–µ–º—É —á–∞—Ç—É)
# ============================================================

@bot.callback_query_handler(func=lambda c: c.data.startswith("show_balance:"))
def handle_show_balance(call):
    chat_id = call.message.chat.id
    total = calculate_total_for_chat(chat_id)
    bot.answer_callback_query(call.id, text=f"üí∞ –û–±—â–∏–π –∏—Ç–æ–≥: {fmt_num(total)}", show_alert=True)


# ============================================================
# üîô –í–û–ó–í–†–ê–¢ –í –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ
# ============================================================

@bot.callback_query_handler(func=lambda c: c.data.startswith("back_to_main:"))
def handle_back_to_main(call):
    day_key = call.data.split(":", 1)[1]
    chat_id = call.message.chat.id
    text, kb = render_day_window(chat_id, day_key)
    bot.edit_message_text(text, chat_id=chat_id, message_id=call.message.id, reply_markup=kb, parse_mode="HTML")

#=== –ß–ê–°–¢–¨ 4 –ó–ê–ö–û–ù–ß–ï–ù–ê ===

#–°–ª–µ–¥—É—é—â–∞—è ‚Äî –ß–ê–°–¢–¨ 5 / 6:
	#‚Ä¢	—Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π (–Ω–æ–≤–∞—è #–ø–æ–¥—Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞),
	#‚Ä¢	–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤ –ø–µ—Ä–µ—Å—ã–ª–∫–∏,
	#‚Ä¢	–ø–µ—Ä–µ—Å—ã–ª–∫–∞ –ª—é–±—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π –º–µ–∂–¥—É —á–∞—Ç–∞–º–∏.

# ============================================================
# üîÅ –û–¢–°–ï–ö 14 ‚Äî –ü–ï–†–ï–°–´–õ–ö–ê –°–û–û–ë–©–ï–ù–ò–ô (–ù–ê–°–¢–†–û–ô–ö–ê –ò –õ–û–ì–ò–ö–ê)
# ============================================================

def get_forward_rules():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å –ø—Ä–∞–≤–∏–ª –ø–µ—Ä–µ—Å—ã–ª–∫–∏"""
    return data.setdefault("forward_rules", {})

def save_forward_rules(rules):
    data["forward_rules"] = rules
    save_data()
    schedule_backup_to_channel()

def get_all_chat_titles():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —á–∞—Ç–æ–≤ —Å –∏—Ö ID –∏ –∏–º–µ–Ω–∞–º–∏"""
    chats = []
    for chat_id, ch in data.get("chats", {}).items():
        title = ch.get("title") or chat_id
        chats.append((chat_id, title))
    return chats


# ====== –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å ¬´–ü–µ—Ä–µ—Å—ã–ª–∫–∞¬ª ======

def build_forward_main_menu():
    kb = types.InlineKeyboardMarkup()
    for chat_id, title in get_all_chat_titles():
        kb.row(types.InlineKeyboardButton(f"{title}", callback_data=f"fw_select:{chat_id}"))
    kb.row(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="owner_back_main"))
    return kb


def build_forward_direction_menu(from_chat_id):
    kb = types.InlineKeyboardMarkup()
    for chat_id, title in get_all_chat_titles():
        if chat_id == from_chat_id:
            continue
        kb.row(types.InlineKeyboardButton(f"‚ûú {title}", callback_data=f"fw_oneway:{from_chat_id}:{chat_id}"))
        kb.row(types.InlineKeyboardButton(f"‚áÑ {title}", callback_data=f"fw_twoway:{from_chat_id}:{chat_id}"))
    kb.row(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="owner_back_fw"))
    return kb


@bot.callback_query_handler(func=lambda c: c.data == "edit_forward")
def handle_edit_forward(call):
    """–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø–µ—Ä–µ—Å—ã–ª–∫–∏ (—Ç–æ–ª—å–∫–æ OWNER)"""
    if str(call.message.chat.id) != str(OWNER_ID):
        bot.answer_callback_query(call.id, "–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ.")
        return
    kb = build_forward_main_menu()
    bot.edit_message_text(
        "üîÅ <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏</b>\n–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç, –æ—Ç–∫—É–¥–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å—ã–ª–∫–∞:",
        chat_id=call.message.chat.id,
        message_id=call.message.id,
        reply_markup=kb,
        parse_mode="HTML"
    )


@bot.callback_query_handler(func=lambda c: c.data.startswith("fw_select:"))
def handle_fw_select(call):
    if str(call.message.chat.id) != str(OWNER_ID):
        return
    from_chat_id = call.data.split(":", 1)[1]
    kb = build_forward_direction_menu(from_chat_id)
    bot.edit_message_text(
        f"–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –∏–∑ <b>{from_chat_id}</b>:",
        chat_id=call.message.chat.id,
        message_id=call.message.id,
        reply_markup=kb,
        parse_mode="HTML"
    )


def add_forward_rule(a, b, two_way=False):
    """–î–æ–±–∞–≤–ª—è–µ—Ç –º–∞—Ä—à—Ä—É—Ç –ø–µ—Ä–µ—Å—ã–ª–∫–∏"""
    rules = get_forward_rules()
    rules.setdefault(a, []).append(b)
    if two_way:
        rules.setdefault(b, []).append(a)
    save_forward_rules(rules)


@bot.callback_query_handler(func=lambda c: c.data.startswith("fw_oneway:"))
def handle_fw_oneway(call):
    if str(call.message.chat.id) != str(OWNER_ID):
        return
    _, from_id, to_id = call.data.split(":")
    add_forward_rule(from_id, to_id, two_way=False)
    bot.answer_callback_query(call.id, "‚úÖ –û–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—è—è –ø–µ—Ä–µ—Å—ã–ª–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞.")
    bot.edit_message_text("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∞ ‚ûú", call.message.chat.id, call.message.id)


@bot.callback_query_handler(func=lambda c: c.data.startswith("fw_twoway:"))
def handle_fw_twoway(call):
    if str(call.message.chat.id) != str(OWNER_ID):
        return
    _, from_id, to_id = call.data.split(":")
    add_forward_rule(from_id, to_id, two_way=True)
    bot.answer_callback_query(call.id, "‚úÖ –î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è –ø–µ—Ä–µ—Å—ã–ª–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞.")
    bot.edit_message_text("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∞ ‚áÑ", call.message.chat.id, call.message.id)


# ====== –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–µ—Ä–µ—Å—ã–ª–æ–∫ ======
def format_forward_rules():
    lines = ["üîó <b>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–µ—Ä–µ—Å—ã–ª–∫–∏:</b>"]
    rules = get_forward_rules()
    if not rules:
        lines.append("‚Äî –ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ ‚Äî")
    else:
        for a, targets in rules.items():
            tgt = ", ".join(targets)
            lines.append(f"<code>{a}</code> ‚ûú <code>{tgt}</code>")
    return "\n".join(lines)


@bot.message_handler(commands=["–ø–µ—Ä–µ—Å—ã–ª–∫–∏"])
def cmd_show_forwards(msg):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É)"""
    if str(msg.chat.id) != str(OWNER_ID):
        return
    text = format_forward_rules()
    bot.send_message(msg.chat.id, text, parse_mode="HTML")


# ============================================================
# üì° –û–¢–°–ï–ö 15 ‚Äî –õ–û–ì–ò–ö–ê –ü–ï–†–ï–°–´–õ–ö–ò –°–û–û–ë–©–ï–ù–ò–ô
# ============================================================

@bot.message_handler(content_types=[
    "text", "photo", "video", "audio", "document", "voice", "sticker", "animation", "video_note"
])
def handle_forwarding(msg):
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏.
    –ï—Å–ª–∏ —á–∞—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–≥–∏–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤,
    –∏–Ω–∞—á–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º.
    """
    chat_id = str(msg.chat.id)
    rules = get_forward_rules()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–∞—Ü–∏—é —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞
    if chat_id in data.get("active_finance_chats", []):
        # –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –¥—Ä—É–≥–∏–º–∏ —Ö—ç–Ω–¥–ª–µ—Ä–∞–º–∏
        return

    # –ï—Å–ª–∏ –ø–µ—Ä–µ—Å—ã–ª–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞
    if chat_id in rules:
        async def async_forward():
            try:
                for target in rules[chat_id]:
                    await tele_client.send_message(int(target), msg.text or "")
                    if msg.content_type in ["photo", "video", "document", "audio", "voice", "sticker", "animation", "video_note"]:
                        await tele_client.send_file(int(target), msg)
            except Exception as e:
                log_error(f"–ü–µ—Ä–µ—Å—ã–ª–∫–∞ {chat_id} -> {target}: {e}")

        import asyncio
        try:
            loop = asyncio.get_event_loop()
            if loop.is_running():
                asyncio.create_task(async_forward())
            else:
                loop.run_until_complete(async_forward())
        except Exception as e:
            log_error(f"forward loop error: {e}")

#=== –ß–ê–°–¢–¨ 5 –ó–ê–ö–û–ù–ß–ï–ù–ê ===

#–°–ª–µ–¥—É—é—â–∞—è ‚Äî –ß–ê–°–¢–¨ 6 / 6:‚Ä¢	–∫–æ–º–∞–Ω–¥–∞ /–ø–æ–µ—Ö–∞–ª–∏–§–û123/ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞,‚Ä¢	keep-alive –∏ webhook, —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ Flask-—Å–µ—Ä–≤–µ—Ä–∞.

#=== –ß–ê–°–¢–¨ 5 –ó–ê–ö–û–ù–ß–ï–ù–ê ===

#–°–ª–µ–¥—É—é—â–∞—è ‚Äî –ß–ê–°–¢–¨ 6 / 6:‚Ä¢	–∫–æ–º–∞–Ω–¥–∞ /–ø–æ–µ—Ö–∞–ª–∏–§–û123/ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞,‚Ä¢	keep-alive –∏ webhook,‚Ä¢	—Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ Flask-—Å–µ—Ä–≤–µ—Ä–∞.

# ============================================================
# üöÄ –û–¢–°–ï–ö 16 ‚Äî –ê–ö–¢–ò–í–ê–¶–ò–Ø –§–ò–ù–ê–ù–°–û–í–û–ì–û –†–ï–ñ–ò–ú–ê
# ============================================================

@bot.message_handler(commands=["–ø–æ–µ—Ö–∞–ª–∏–§–û123"])
def activate_financial_mode(msg):
    """–ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ —á–∞—Ç–µ"""
    chat_id = str(msg.chat.id)
    data.setdefault("active_finance_chats", [])
    if chat_id not in data["active_finance_chats"]:
        data["active_finance_chats"].append(chat_id)
        save_data()
        bot.send_message(chat_id, "‚úÖ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –≤–µ—Å—Ç–∏ —É—á—ë—Ç.")
        log_info(f"–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω –¥–ª—è —á–∞—Ç–∞ {chat_id}")
    else:
        bot.send_message(chat_id, "‚öôÔ∏è –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω.")


@bot.message_handler(commands=["stop–§–û"])
def deactivate_financial_mode(msg):
    """–û—Ç–∫–ª—é—á–∞–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º"""
    chat_id = str(msg.chat.id)
    if chat_id in data.get("active_finance_chats", []):
        data["active_finance_chats"].remove(chat_id)
        save_data()
        bot.send_message(chat_id, "üõë –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω.")
    else:
        bot.send_message(chat_id, "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º –Ω–µ –±—ã–ª –≤–∫–ª—é—á—ë–Ω.")


# ============================================================
# ü©∫ –û–¢–°–ï–ö 17 ‚Äî KEEP-ALIVE –ò WEBHOOK
# ============================================================

def keep_alive():
    """–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –ø–∏–Ω–≥ –¥–ª—è Render"""
    while True:
        try:
            url = APP_URL + "/ping"
            requests.get(url, timeout=10)
            log_info(f"üåê Keep-alive ping ‚Üí {url}")
        except Exception as e:
            log_warning(f"Keep-alive error: {e}")
        time.sleep(KEEP_ALIVE_INTERVAL_SECONDS)


@app.route("/ping")
def ping():
    return "pong", 200


@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ –≤–µ–±—Ö—É–∫–∏ Telegram"""
    try:
        update = telebot.types.Update.de_json(request.stream.read().decode("utf-8"))
        bot.process_new_updates([update])
    except Exception as e:
        log_error(f"Webhook error: {e}")
    return "!", 200


@app.route("/")
def index():
    return f"‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç. –í–µ—Ä—Å–∏—è: {VERSION}", 200


def start_webhook():
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç Flask –∏ webhook"""
    bot.remove_webhook()
    time.sleep(1)
    bot.set_webhook(url=f"{APP_URL}/{TOKEN}")
    log_info("üåê Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
    app.run(host="0.0.0.0", port=PORT, threaded=True)


# ============================================================
# üèÅ –ó–ê–ü–£–°–ö
# ============================================================

if __name__ == "__main__":
    # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    try:
        restore_from_backup_if_needed()
        print("‚úÖ –î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ.")
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏: {e}")

    # Keep-alive –ø–æ—Ç–æ–∫
    threading.Thread(target=keep_alive, daemon=True).start()

    # –ó–∞–ø—É—Å–∫ –≤–µ–±—Ö—É–∫–∞
    start_webhook()
