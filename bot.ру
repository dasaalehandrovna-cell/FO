# 2661/–∏—Å–ø—Ä —á–∏—Å–ª–∞/ –ö–∞–∂–¥—ã–π —á–∞—Ç –≤–µ–¥—ë—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
# ======================================
# üß≠ –û–ø–∏—Å–∞–Ω–∏–µ: Code_021b
#  ‚Ä¢ –ü–æ–ª–Ω—ã–π UI –∫–∞–∫ –≤ 9.8.6-fo_6: –æ–∫–Ω–æ –¥–Ω—è, –∫–Ω–æ–ø–∫–∏, –º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è,
#    –Ω–∞–≤–∏–≥–∞—Ü–∏—è /prev /next /view, –∫–∞–ª–µ–Ω–¥–∞—Ä—å 31 –¥–µ–Ω—å, –æ—Ç—á—ë—Ç—ã, –ø–µ—Ä–µ—Å—á—ë—Ç—ã
#  ‚Ä¢ ‚òÅÔ∏è –ë—ç–∫–∞–ø –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Google Drive + –∫–∞–Ω–∞–ª
#  ‚Ä¢ üíæ –ö–∞–∂–¥—ã–π —á–∞—Ç –≤–µ–¥—ë—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
#    data_<chat_id>.json, data_<chat_id>.csv, csv_meta_<chat_id>.json
# ==========================================================

# ========== –û–¢–°–ï–ö 1 ‚Äî –ò–º–ø–æ—Ä—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ==========
import os
import io
import json
import csv
import re
import html
import logging
import threading
import time
from datetime import datetime, timedelta, timezone, date
from zoneinfo import ZoneInfo

import requests
import telebot
from telebot import types
from flask import Flask, request

# --- Google Drive ---
from googleapiclient.http import MediaFileUpload, MediaIoBaseDownload
from googleapiclient.discovery import build
from google.oauth2 import service_account

# -----------------------------
# ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
# -----------------------------
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")
APP_URL = os.getenv("APP_URL", "")
PORT = int(os.getenv("PORT", 5000))
VERSION = "Code_021b"

try:
    TZ = ZoneInfo((os.getenv("TZ") or "America/Argentina/Buenos_Aires").strip())
except Exception:
    TZ = timezone(timedelta(hours=-3))

try:
    UTC = timezone.utc
except Exception:
    UTC = timezone(timedelta(0))

DATA_FILE = "data.json"
DATA_FILE_OLD = "data_backup_old.json"

LOG_FILE = "log.txt"

# ---------- –ø–µ—Ä-—á–∞—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã ----------
def chat_data_file(chat_id: int) -> str:
    return f"data_{chat_id}.json"

def chat_csv_file(chat_id: int) -> str:
    return f"data_{chat_id}.csv"

def chat_meta_file(chat_id: int) -> str:
    return f"csv_meta_{chat_id}.json"

KEEP_ALIVE_INTERVAL_SECONDS = int(os.getenv("KEEP_ALIVE_INTERVAL_SECONDS", 11 * 60))
KEEP_ALIVE_SEND_TO_OWNER = True
GDRIVE_FOLDER_ID = os.getenv("GDRIVE_FOLDER_ID")
SERVICE_ACCOUNT_JSON = os.getenv("SERVICE_ACCOUNT_JSON", "service_account.json")
SCOPES = ["https://www.googleapis.com/auth/drive.file"]
BACKUP_CHAT_ID = os.getenv("BACKUP_CHAT_ID")
# === –•—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —á–∞—Ç–æ–≤ (–æ–±—â–∏–π —Å–ø–∏—Å–æ–∫) ===
KNOWN_CHATS_FILE = "known_chats.json"
known_chats = {}
if not TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# -----------------------------
# üßæ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# -----------------------------
logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[logging.FileHandler(LOG_FILE, encoding="utf-8"), logging.StreamHandler()]
)
def log_info(msg): logging.info(msg)
def log_error(msg): logging.error(msg)

log_info(f"üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ {VERSION}")

# -----------------------------
# ‚è±Ô∏è –í—Ä–µ–º—è –∏ —á–∏—Å–ª–∞
# -----------------------------
def now_local() -> datetime: return datetime.now(TZ)
def today_key() -> str: return now_local().strftime("%Y-%m-%d")
def parse_date_key(s: str):
    try: return datetime.strptime(s, "%Y-%m-%d").date
    except: return None

def parse_amount(text: str):
    """
    –ü–∞—Ä—Å–∏–Ω–≥ —Å—É–º–º—ã —Å —É—á—ë—Ç–æ–º —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π:
    1.200
    1 200
    1,200
    1.200,50
    -1 500
    """
    if not isinstance(text, str):
        return None
    t = text.strip()
    if not t:
        return None

    t = t.replace(" ", "")
    if "," in t and "." in t:
        if t.rfind(",") > t.rfind("."):
            t = t.replace(".", "").replace(",", ".")
        else:
            t = t.replace(",", "")
    else:
        t = t.replace(",", "")

    try:
        return float(t)
    except:
        return None

def format_amount(num) -> str:
    try:
        s = f"{float(num):,.2f}"
        s = s.replace(",", " ").replace(".", ",")
        return s
    except:
        return str(num)

# -----------------------------
# üìÅ –£—Ç–∏–ª–∏—Ç—ã JSON
# -----------------------------
def _load_json(path: str, default):
    if not os.path.exists(path):
        return default
    try:
        with open(path, "r", encoding="utf-8") as f:
            return json.load(f)
    except Exception as e:
        log_error(f"_load_json error {path}: {e}")
        return default

def _save_json(path: str, data):
    try:
        with open(path, "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"_save_json error {path}: {e}")

# ==========================================================
# –û–¢–°–ï–ö 2 ‚Äî –°–¢–ê–†–´–ô –§–û–†–ú–ê–¢ data.json
# ==========================================================
def default_data():
    return {
        "chats": {},
        "finance_active_chats": {},
        "forward_rules": {},
        "backup_flags": {
            "drive": True,
            "channel": True
        }
    }

def load_data():
    d = _load_json(DATA_FILE, default_data())
    base = default_data()
    for k, v in base.items():
        if k not in d:
            d[k] = v
    return d

def save_data(d):
    try:
        trimmed = dict(d)
        _save_json(DATA_FILE, trimmed)
        log_info("üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ data.json")
    except Exception as e:
        log_error(f"save_data error: {e}")

data = load_data()

def ensure_chat(d, chat_id: int):
    chat_id_str = str(chat_id)
    if chat_id_str not in d["chats"]:
        d["chats"][chat_id_str] = {
            "info": {},
            "balance": 0,
            "records": [],
            "daily_records": {},
            "next_id": 1,
            "active_windows": {},
            "edit_wait": None,
            "edit_target": None,
            "current_view_day": today_key()
        }
    return d["chats"][chat_id_str]

def set_chat_info(d, chat_id: int, title: str = None, username: str = None, chat_type: str = None):
    chat_data = ensure_chat(d, chat_id)
    info = chat_data.setdefault("info", {})
    if title is not None:
        info["title"] = title
    if username is not None:
        info["username"] = username
    if chat_type is not None:
        info["type"] = chat_type

# ==========================================================
# –û–¢–°–ï–ö 3 ‚Äî –ü–ï–†-–ß–ê–¢–û–í–´–ï –§–ê–ô–õ–´
# ==========================================================
def load_chat_json(chat_id: int):
    path = chat_data_file(chat_id)
    if not os.path.exists(path):
        return {
            "chat_id": chat_id,
            "days": {},
            "current_day": today_key(),
            "window": None,
            "config": {},
        }
    try:
        with open(path, "r", encoding="utf-8") as f:
            data_chat = json.load(f)
    except Exception as e:
        log_error(f"load_chat_json error {chat_id}: {e}")
        data_chat = {
            "chat_id": chat_id,
            "days": {},
            "current_day": today_key(),
            "window": None,
            "config": {},
        }

    if "days" not in data_chat:
        data_chat["days"] = {}
    if "current_day" not in data_chat:
        data_chat["current_day"] = today_key()
    if "window" not in data_chat:
        data_chat["window"] = None
    if "config" not in data_chat:
        data_chat["config"] = {}
    return data_chat

def save_chat_json(chat_id: int, data_chat: dict):
    path = chat_data_file(chat_id)
    try:
        with open(path, "w", encoding="utf-8") as f:
            json.dump(data_chat, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"save_chat_json error {chat_id}: {e}")

def reset_chat_json(chat_id: int):
    path = chat_data_file(chat_id)
    if os.path.exists(path):
        try:
            os.remove(path)
        except Exception as e:
            log_error(f"reset_chat_json remove error {chat_id}: {e}")

# CSV per-—á–∞—Ç
def append_chat_csv(chat_id: int, row: list):
    path = chat_csv_file(chat_id)
    write_header = not os.path.exists(path)
    try:
        with open(path, "a", newline="", encoding="utf-8") as f:
            writer = csv.writer(f, delimiter=";")
            if write_header:
                writer.writerow(["date", "time", "category", "amount", "comment"])
            writer.writerow(row)
    except Exception as e:
        log_error(f"append_chat_csv error {chat_id}: {e}")

def export_chat_to_csv(chat_id: int, data_chat: dict):
    path = chat_csv_file(chat_id)
    try:
        with open(path, "w", newline="", encoding="utf-8") as f:
            writer = csv.writer(f, delimiter=";")
            writer.writerow(["date", "time", "category", "amount", "comment"])
            days = data_chat.get("days", {})
            for day_key, day_data in sorted(days.items()):
                for rec in day_data.get("records", []):
                    writer.writerow([
                        day_key,
                        rec.get("time", ""),
                        rec.get("category", ""),
                        rec.get("amount", ""),
                        rec.get("comment", "")
                    ])
    except Exception as e:
        log_error(f"export_chat_to_csv error {chat_id}: {e}")

# ==========================================================
# –û–¢–°–ï–ö 4 ‚Äî –†–ê–°–ß–Å–¢–´ –ü–û –î–ù–Ø–ú
# ==========================================================
def ensure_day(data_chat: dict, day_key: str):
    days = data_chat.setdefault("days", {})
    if day_key not in days:
        days[day_key] = {
            "records": [],
            "summary": 0.0
        }
    return days[day_key]

def recalc_day_summary(data_chat: dict, day_key: str):
    day = ensure_day(data_chat, day_key)
    total = 0.0
    for rec in day.get("records", []):
        try:
            total += float(rec.get("amount", 0) or 0)
        except:
            pass
    day["summary"] = total

def recalc_all_summaries(data_chat: dict):
    for day_key in list(data_chat.get("days", {}).keys()):
        recalc_day_summary(data_chat, day_key)

def get_total_balance_for_chat(data_chat: dict) -> float:
    total = 0.0
    for day_key, day_data in data_chat.get("days", {}).items():
        try:
            total += float(day_data.get("summary", 0) or 0)
        except:
            pass
    return total

# ==========================================================
# –û–¢–°–ï–ö 5 ‚Äî GDRIVE
# ==========================================================
def get_gdrive_service():
    if not GDRIVE_FOLDER_ID:
        log_info("GDRIVE_FOLDER_ID –Ω–µ –∑–∞–¥–∞–Ω, Google Drive –æ—Ç–∫–ª—é—á—ë–Ω.")
        return None

    try:
        if SERVICE_ACCOUNT_JSON and os.path.exists(SERVICE_ACCOUNT_JSON):
            with open(SERVICE_ACCOUNT_JSON, "r", encoding="utf-8") as f:
                info = json.load(f)
        else:
            info = json.loads(SERVICE_ACCOUNT_JSON)

        creds = service_account.Credentials.from_service_account_info(info, scopes=SCOPES)
        service = build("drive", "v3", credentials=creds)
        return service
    except Exception as e:
        log_error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ GDrive: {e}")
        return None

def upload_to_gdrive(path: str, description: str = None):
    service = get_gdrive_service()
    if not service:
        return None
    file_name = os.path.basename(path)
    media = MediaFileUpload(path, resumable=True)
    body = {
        "name": file_name,
        "parents": [GDRIVE_FOLDER_ID],
    }
    if description:
        body["description"] = description
    try:
        file = service.files().create(
            body=body,
            media_body=media,
            fields="id, name, webViewLink"
        ).execute()
        log_info(f"GDrive upload success: {file.get('id')} {file.get('name')}")
        return file
    except Exception as e:
        log_error(f"GDrive upload error: {e}")
        return None

# ==========================================================
# –û–¢–°–ï–ö 6 ‚Äî –§–ò–ù–ú–û–î, –û–ö–ù–û, –ö–ù–û–ü–ö–ò
# ==========================================================
ACTIVATION_COMMAND = "/–ø–æ–µ—Ö–∞–ª–∏–§–û123"

def is_finance_mode(chat_id: int) -> bool:
    return bool(data.get("finance_active_chats", {}).get(str(chat_id), False))

def set_finance_mode(chat_id: int, active: bool):
    data.setdefault("finance_active_chats", {})[str(chat_id)] = bool(active)
    save_data(data)

def build_main_keyboard() -> types.InlineKeyboardMarkup:
    kb = types.InlineKeyboardMarkup()
    kb.row(
        types.InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å", callback_data="add_record"),
        types.InlineKeyboardButton("üìä –û—Ç—á—ë—Ç", callback_data="report_menu")
    )
    kb.row(
        types.InlineKeyboardButton("‚¨ÖÔ∏è –í—á–µ—Ä–∞", callback_data="prev_day"),
        types.InlineKeyboardButton("–°–µ–≥–æ–¥–Ω—è üìÖ", callback_data="today"),
        types.InlineKeyboardButton("–ó–∞–≤—Ç—Ä–∞ ‚û°Ô∏è", callback_data="next_day"),
    )
    kb.row(
        types.InlineKeyboardButton("üìÜ –í—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å", callback_data="pick_day"),
    )
    kb.row(
        types.InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data="edit_menu"),
    )
    kb.row(
        types.InlineKeyboardButton("üí∞ –û–±—â–∏–π –∏—Ç–æ–≥", callback_data="total_balance")
    )
    return kb

def build_day_header(day_key: str) -> str:
    try:
        dt = datetime.strptime(day_key, "%Y-%m-%d").date()
        return dt.strftime("%d.%m.%Y")
    except:
        return day_key

def build_day_text(data_chat: dict, day_key: str) -> str:
    day = ensure_day(data_chat, day_key)
    header = build_day_header(day_key)
    lines = [f"üìÖ <b>{header}</b>"]

    for idx, rec in enumerate(day.get("records", []), start=1):
        cat = rec.get("category", "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏")
        amt = rec.get("amount", 0)
        comment = rec.get("comment", "")
        try:
            famt = format_amount(amt)
        except:
            famt = str(amt)
        line = f"{idx}. {cat}: <b>{famt}</b>"
        if comment:
            line += f" ‚Äî {html.escape(str(comment))}"
        lines.append(line)

    summary = day.get("summary", 0)
    lines.append("")
    lines.append(f"–ò—Ç–æ–≥–æ –∑–∞ –¥–µ–Ω—å: <b>{format_amount(summary)}</b>")
    return "\n".join(lines)

def open_or_update_main_window(chat_id: int):
    data_chat = load_chat_json(chat_id)
    day_key = data_chat.get("current_day") or today_key()
    ensure_day(data_chat, day_key)
    recalc_day_summary(data_chat, day_key)
    recalc_all_summaries(data_chat)
    text_msg = build_day_text(data_chat, day_key)
    kb = build_main_keyboard()

    window = data_chat.get("window")
    if window and window.get("message_id"):
        msg_id = window["message_id"]
        try:
            bot.edit_message_text(
                chat_id=chat_id,
                message_id=msg_id,
                text=text_msg,
                reply_markup=kb
            )
        except Exception as e:
            log_error(f"open_or_update_main_window edit error: {e}")
            try:
                m = bot.send_message(chat_id, text_msg, reply_markup=kb)
                data_chat["window"] = {"message_id": m.message_id}
            except Exception as e2:
                log_error(f"open_or_update_main_window send fallback error: {e2}")
    else:
        try:
            m = bot.send_message(chat_id, text_msg, reply_markup=kb)
            data_chat["window"] = {"message_id": m.message_id}
        except Exception as e:
            log_error(f"open_or_update_main_window send error: {e}")

    save_chat_json(chat_id, data_chat)

# ==========================================================
# –û–¢–°–ï–ö 7 ‚Äî –ü–ï–†–ï–°–´–õ–ö–ê (forward_rules)
# ==========================================================
def load_forward_rules():
    return data.get("forward_rules", {})

def save_forward_rules(rules):
    data["forward_rules"] = rules
    save_data(data)

def get_forward_routes_for(chat_id: int):
    rules = load_forward_rules()
    routes = rules.get("routes", [])
    return [r for r in routes if r.get("src") == chat_id or r.get("dst") == chat_id]

def add_forward_route(src_id: int, dst_id: int, mode: str = "oneway"):
    rules = load_forward_rules()
    routes = rules.setdefault("routes", [])
    routes.append({
        "src": src_id,
        "dst": dst_id,
        "mode": mode,
    })
    save_forward_rules(rules)

def remove_forward_route(index: int):
    rules = load_forward_rules()
    routes = rules.get("routes", [])
    if 0 <= index < len(routes):
        routes.pop(index)
    save_forward_rules(rules)

def forward_message_safely(original_msg: telebot.types.Message, target_chat_id: int):
    try:
        if original_msg.content_type == "text":
            bot.send_message(target_chat_id, original_msg.text)
        elif original_msg.content_type == "photo":
            file_id = original_msg.photo[-1].file_id
            bot.send_photo(target_chat_id, file_id, caption=original_msg.caption or "")
        elif original_msg.content_type == "document":
            file_id = original_msg.document.file_id
            bot.send_document(target_chat_id, file_id, caption=original_msg.caption or "")
        elif original_msg.content_type == "audio":
            bot.send_audio(target_chat_id, original_msg.audio.file_id, caption=original_msg.caption or "")
        elif original_msg.content_type == "video":
            bot.send_video(target_chat_id, original_msg.video.file_id, caption=original_msg.caption or "")
        elif original_msg.content_type == "voice":
            bot.send_voice(target_chat_id, original_msg.voice.file_id, caption=original_msg.caption or "")
        elif original_msg.content_type == "sticker":
            bot.send_sticker(target_chat_id, original_msg.sticker.file_id)
        else:
            bot.forward_message(target_chat_id, original_msg.chat.id, original_msg.message_id)
    except Exception as e:
        log_error(f"forward_message_safely error to {target_chat_id}: {e}")

def handle_forwarding_for_message(msg: telebot.types.Message):
    rules = load_forward_rules().get("routes", [])
    chat_id = msg.chat.id
    for rule in rules:
        mode = rule.get("mode", "oneway")
        src = rule.get("src")
        dst = rule.get("dst")
        if mode == "oneway":
            if chat_id == src:
                forward_message_safely(msg, dst)
        elif mode == "both":
            if chat_id == src:
                forward_message_safely(msg, dst)
            elif chat_id == dst:
                forward_message_safely(msg, src)

# ================================================================
# üìã –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –±—ç–∫–∞–ø —Å–ø–∏—Å–∫–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —á–∞—Ç–æ–≤ (–≤ —Ñ–∞–π–ª –≤–ª–∞–¥–µ–ª—å—Ü–∞)
# ================================================================
def save_known_chats_for_owner():
    """üìã –î–æ–±–∞–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —á–∞—Ç–æ–≤ –≤–Ω—É—Ç—Ä—å —Ñ–∞–π–ª–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ (data_<OWNER_ID>.json)."""
    try:
        if not OWNER_ID:
            return
        owner_id = int(OWNER_ID)
        path = f"data_{owner_id}.json"

        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–π JSON –≤–ª–∞–¥–µ–ª—å—Ü–∞
        if os.path.exists(path):
            with open(path, "r", encoding="utf-8") as f:
                content = json.load(f)
        else:
            content = {"chat_id": owner_id}

        # –î–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª known_chats
        known = {}
        for cid, info in data.get("chats", {}).items():
            meta = info.get("info", {})
            known[cid] = {
                "title": meta.get("title") or meta.get("name") or f"–ß–∞—Ç {cid}",
                "username": meta.get("username"),
                "type": meta.get("type"),
                "finance_active": data.get("finance_active_chats", {}).get(cid, False),
                "records_count": len(info.get("records", [])) if "records" in info else 0,
            }

        content["known_chats"] = known
        content["known_chats_updated"] = now_local().isoformat(timespec="seconds")

        # üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª –≤–ª–∞–¥–µ–ª—å—Ü–∞
        with open(path, "w", encoding="utf-8") as f:
            json.dump(content, f, ensure_ascii=False, indent=2)
        log_info(f"üìã known_chats –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ {path} ({len(known)} —á–∞—Ç–æ–≤)")

        # ‚òÅÔ∏è –∏ –±—ç–∫–∞–ø–∏–º –≤ Drive / –∫–∞–Ω–∞–ª
        if data.get("backup_flags", {}).get("drive", False):
            upload_to_gdrive(path)
        if BACKUP_CHAT_ID:
            with open(path, "rb") as f:
                caption = f"üìã –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ data_{owner_id}.json"
                bot.send_document(int(BACKUP_CHAT_ID), f, caption=caption)
    except Exception as e:
        log_error(f"save_known_chats_for_owner: {e}")

# ================================================================
# üìò –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ –≤ JSON –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –∫–∞–Ω–∞–ª
# ================================================================
def save_known_chats_json():
    """
    –°–æ–∑–¥–∞—ë—Ç —Ñ–∞–π–ª known_chats.json —Å–æ —Å–ø–∏—Å–∫–æ–º –≤—Å–µ—Ö —á–∞—Ç–æ–≤,
    –≥–¥–µ –±–æ—Ç –∫–æ–≥–¥–∞-–ª–∏–±–æ —Å–æ—Å—Ç–æ—è–ª, –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ BACKUP_CHAT_ID.
    """
    try:
        fname = "known_chats.json"

        output = {
            "updated": now_local().isoformat(timespec="seconds"),
            "chats": {}
        }

        for cid, cdata in data.get("chats", {}).items():
            info = cdata.get("info", {}) or {}
            output["chats"][cid] = {
                "title": info.get("title"),
                "username": info.get("username"),
                "type": info.get("type"),
                "name": info.get("name"),
                "records_count": sum(len(v) for v in cdata.get("daily_records", {}).values()),
                "balance": cdata.get("balance", 0)
            }

        # üíæ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
        with open(fname, "w", encoding="utf-8") as f:
            json.dump(output, f, ensure_ascii=False, indent=2)

        log_info(f"üìò known_chats.json —Å–æ—Ö—Ä–∞–Ω—ë–Ω ({len(output['chats'])} —á–∞—Ç–æ–≤)")

        # üì§ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ BACKUP_CHAT_ID
        if BACKUP_CHAT_ID:
            with open(fname, "rb") as f:
                bot.send_document(
                    int(BACKUP_CHAT_ID),
                    f,
                    caption=f"üìò –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ (–æ–±–Ω–æ–≤–ª—ë–Ω {output['updated']})"
                )
            log_info("üì§ known_chats.json –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ BACKUP_CHAT_ID")

    except Exception as e:
        log_error(f"save_known_chats_json: {e}")

# ================================================================
# üîç –ê–í–¢–û–û–ë–ù–ê–†–£–ñ–ï–ù–ò–ï –ß–ê–¢–û–í, –≥–¥–µ –±–æ—Ç —Å–æ—Å—Ç–æ–∏—Ç (–ª–∏—á–∫–∏, –≥—Ä—É–ø–ø—ã, –∫–∞–Ω–∞–ª—ã)
# ================================================================
def preload_all_bot_chats():
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –≤ data['chats'] –≤—Å–µ —á–∞—Ç—ã, –≥–¥–µ –±–æ—Ç —Ä–µ–∞–ª—å–Ω–æ —Å–æ—Å—Ç–æ–∏—Ç (–ª–∏—á–∫–∏, –≥—Ä—É–ø–ø—ã, –∫–∞–Ω–∞–ª—ã),
    –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–∞–º –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º –∏ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π.
    """
    try:
        me = bot.get_me()
        my_id = me.id
        data.setdefault("chats", {})

        # --- 1Ô∏è‚É£ –ë–µ—Ä—ë–º —á–∞—Ç—ã –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∞–ø–¥–µ–π—Ç–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        updates = bot.get_updates(limit=200)
        for u in updates:
            m = getattr(u, "message", None) or getattr(u, "channel_post", None)
            if not m or not m.chat:
                continue

            cid = str(m.chat.id)
            if cid not in data["chats"]:
                chat_obj = m.chat
                info = {
                    "title": getattr(chat_obj, "title", None),
                    "username": getattr(chat_obj, "username", None),
                    "type": getattr(chat_obj, "type", None),
                    "name": (
                        (getattr(chat_obj, "first_name", "") + " " +
                         getattr(chat_obj, "last_name", "")).strip()
                    ),
                }
                data["chats"][cid] = {
                    "info": info,
                    "balance": 0,
                    "records": [],
                    "daily_records": {},
                    "next_id": 1,
                    "active_windows": {},
                    "edit_wait": None,
                    "edit_target": None,
                    "current_view_day": today_key()
                }
                log_info(f"üì° –î–æ–±–∞–≤–ª–µ–Ω —á–∞—Ç –∏–∑ –∞–ø–¥–µ–π—Ç–æ–≤: {cid} ({info.get('title') or info.get('name')})")

        # --- 2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —á–∞—Ç—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–µ —á–ª–µ–Ω—Å—Ç–≤–æ –±–æ—Ç–∞
        verified_chats = {}
        for cid, cdata in list(data["chats"].items()):
            try:
                cid_int = int(cid)
                member = bot.get_chat_member(cid_int, my_id)
                if not member or member.status in ("left", "kicked"):
                    log_info(f"üö´ –ë–æ—Ç –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ —á–∞—Ç–µ {cid}, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º.")
                    continue

                chat_obj = bot.get_chat(cid_int)
                info = {
                    "title": getattr(chat_obj, "title", None),
                    "username": getattr(chat_obj, "username", None),
                    "type": getattr(chat_obj, "type", None),
                    "name": (
                        (getattr(chat_obj, "first_name", "") + " " +
                         getattr(chat_obj, "last_name", "")).strip()
                    ),
                }
                data["chats"][cid]["info"] = info
                verified_chats[cid] = info
                log_info(f"‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω —á–∞—Ç {cid} ({info.get('title') or info.get('name')})")
            except Exception as e:
                log_error(f"preload_all_bot_chats check {cid}: {e}")

        save_data(data)
        # –∑–¥–µ—Å—å –º–æ–≥—É—Ç –±—ã—Ç—å —Å–∏–Ω–∫–∏ —Å GDrive, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        save_known_chats_for_owner()
        save_known_chats_json()
        log_info(f"üìã –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ —á–∞—Ç–æ–≤: {len(verified_chats)}")
    except Exception as e:
        log_error(f"preload_all_bot_chats: {e}")

# ==========================================================
# –û–¢–°–ï–ö 10 ‚Äî –ö–û–ú–ê–ù–î–´
# ==========================================================
@bot.message_handler(commands=["start", "help"])
def cmd_start(msg: telebot.types.Message):
    chat_id = msg.chat.id
    text = (
        "–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç.\n\n"
        "–ß—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º —É—á—ë—Ç–∞ –≤ —ç—Ç–æ–º —á–∞—Ç–µ, –æ—Ç–ø—Ä–∞–≤—å:\n"
        f"<code>{ACTIVATION_COMMAND}</code>\n\n"
        "–ü–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ—è–≤–∏—Ç—Å—è –≥–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ —Å –∫–Ω–æ–ø–∫–∞–º–∏."
    )
    bot.send_message(chat_id, text, parse_mode="HTML")

@bot.message_handler(commands=["id"])
def cmd_id(msg: telebot.types.Message):
    chat_id = msg.chat.id
    bot.send_message(chat_id, f"ID —ç—Ç–æ–≥–æ —á–∞—Ç–∞: <code>{chat_id}</code>", parse_mode="HTML")

@bot.message_handler(commands=["version"])
def cmd_version(msg: telebot.types.Message):
    bot.send_message(msg.chat.id, f"–í–µ—Ä—Å–∏—è: <code>{VERSION}</code>", parse_mode="HTML")

@bot.message_handler(commands=["backup"])
def cmd_backup(msg: telebot.types.Message):
    if str(msg.from_user.id) != str(OWNER_ID):
        return
    chat_id = msg.chat.id
    try:
        export_to_csv(data)
        send_backup_to_channel()
        bot.send_message(chat_id, "üì§ –†—É—á–Ω–æ–π –±—ç–∫–∞–ø –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –∫–∞–Ω–∞–ª.")
    except Exception as e:
        log_error(f"/backup error: {e}")
        bot.send_message(chat_id, f"–û—à–∏–±–∫–∞ –±—ç–∫–∞–ø–∞: {e}")

# --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã –≤–∫–ª—é—á–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞ ---
@bot.message_handler(commands=["–ø–æ–µ—Ö–∞–ª–∏"])
def cmd_enable_finance(msg):
    chat_id = msg.chat.id
    set_finance_mode(chat_id, True)
    bot.send_message(chat_id, "üöÄ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞!")
    open_or_update_main_window(chat_id)

@bot.message_handler(commands=["—Å—Ç–æ–ø—Ñ–æ"])
def cmd_disable_finance(msg):
    chat_id = msg.chat.id
    set_finance_mode(chat_id, False)
    bot.send_message(chat_id, "‚õî –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω –≤ —ç—Ç–æ–º —á–∞—Ç–µ.")

# ==========================================================
# –û–¢–°–ï–ö 11 ‚Äî –°–õ–£–ñ–ï–ë–ù–´–ï –°–û–ë–´–¢–ò–Ø (–±–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω/—É–¥–∞–ª—ë–Ω)
# ==========================================================
def handle_bot_membership_change(update):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è, –∫–æ–≥–¥–∞ –±–æ—Ç–∞ –¥–æ–±–∞–≤–ª—è—é—Ç –∏–ª–∏ —É–¥–∞–ª—è—é—Ç –∏–∑ –≥—Ä—É–ø–ø/–∫–∞–Ω–∞–ª–æ–≤.
    –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —á–∞—Ç –¥–∞–∂–µ –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –µ—â—ë –Ω–µ –±—ã–ª–æ.
    """
    try:
        chat = update.chat
        if not chat:
            return

        cid = str(chat.id)
        new_status = update.new_chat_member.status
        old_status = update.old_chat_member.status if update.old_chat_member else None

        # üß≠ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç —Å—Ç–∞—Ç—É—Å—ã, –≥–¥–µ –±–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω –≤ —á–∞—Ç–µ
        if new_status in ("member", "administrator") and chat.type in ("group", "supergroup", "channel", "private"):
            data.setdefault("chats", {})

            if cid not in data["chats"]:
                chat_info = {
                    "title": getattr(chat, "title", None),
                    "username": getattr(chat, "username", None),
                    "type": getattr(chat, "type", None),
                    "name": (
                        (getattr(chat, "first_name", "") + " " +
                         getattr(chat, "last_name", "")).strip()
                    ),
                }
                data["chats"][cid] = {
                    "info": chat_info,
                    "balance": 0,
                    "records": [],
                    "daily_records": {},
                    "next_id": 1,
                    "active_windows": {},
                    "edit_wait": None,
                    "edit_target": None,
                    "current_view_day": today_key()
                }

                save_data(data)
                save_chat_json(chat.id, data)
                # —Ç—É—Ç –º–æ–≥ –±—ã—Ç—å sync_all_backups_gdrive_async(data) –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                log_info(f"üì° –ë–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –Ω–æ–≤—ã–π —á–∞—Ç: {cid} ({chat_info.get('title') or chat_info.get('name')})")
                # üîî –£–≤–µ–¥–æ–º–ª—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –æ –Ω–æ–≤–æ–º —á–∞—Ç–µ
                try:
                    if OWNER_ID:
                        bot.send_message(
                            int(OWNER_ID),
                            "üîî –ë–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –Ω–æ–≤—ã–π —á–∞—Ç:\n"
                            f"‚Ä¢ ID: `{cid}`\n"
                            f"‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ: {chat_info.get('title') or chat_info.get('name')}\n"
                            f"‚Ä¢ –¢–∏–ø: {chat_info.get('type')}",
                            parse_mode="Markdown"
                        )
                except Exception as e:
                    log_error(f"notify owner new chat: {e}")

                # üßæ –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –≤–ª–∞–¥–µ–ª—å—Ü—É
                try:
                    save_known_chats_for_owner()
                    save_known_chats_json()
                except Exception as e:
                    log_error(f"save_known_chats_for_owner (membership): {e}")

                # üì§ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ BACKUP_CHAT_ID
                try:
                    if BACKUP_CHAT_ID:
                        caption = (
                            "üì• –ù–æ–≤—ã–π —á–∞—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:\n"
                            f"‚Ä¢ ID: `{cid}`\n"
                            f"‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ: {chat_info.get('title') or chat_info.get('name')}\n"
                            f"‚Ä¢ –¢–∏–ø: {chat_info.get('type')}"
                        )
                        bot.send_message(int(BACKUP_CHAT_ID), caption, parse_mode="Markdown")
                except Exception as e:
                    log_error(f"backup notify new chat: {e}")

        # üßπ –µ—Å–ª–∏ –±–æ—Ç–∞ —É–¥–∞–ª–∏–ª–∏ –∏–∑ —á–∞—Ç–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
        elif new_status in ("kicked", "left"):
            log_info(f"üö™ –ë–æ—Ç —É–¥–∞–ª—ë–Ω –∏–∑ —á–∞—Ç–∞: {cid} ({getattr(chat, 'title', '')}) ‚Äî —Å—Ç–∞—Ä—ã–π —Å—Ç–∞—Ç—É—Å: {old_status}")

    except Exception as e:
        log_error(f"handle_bot_membership_change: {e}")

# ==========================================================
# –û–¢–°–ï–ö 12 ‚Äî –û–ë–†–ê–ë–û–¢–ß–ò–ö –¢–ï–ö–°–¢–û–í (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π)
# ==========================================================
@bot.message_handler(func=lambda m: True)
def handle_message(msg):
    chat_id = msg.chat.id
    cid = str(chat_id)

    # 1. –ê–≤—Ç–æ-—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–∞—Ç–∞ (fallback, –µ—Å–ª–∏ event membership –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª)
    try:
        if "chats" not in data:
            data["chats"] = {}
        if cid not in data["chats"]:
            chat_info = {
                "title": getattr(msg.chat, "title", None),
                "username": getattr(msg.chat, "username", None),
                "type": getattr(msg.chat, "type", None),
                "name": (
                    (getattr(msg.chat, "first_name", "") + " " +
                     getattr(msg.chat, "last_name", "")).strip()
                ),
            }
            data["chats"][cid] = {
                "info": chat_info,
                "balance": 0,
                "records": [],
                "daily_records": {},
                "next_id": 1,
                "active_windows": {},
                "edit_wait": None,
                "edit_target": None,
                "current_view_day": today_key()
            }

            save_data(data)
            save_chat_json(chat_id, data)
            # –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ —Ç–æ–∂–µ —Å–ª–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É/–≤ –∫–∞–Ω–∞–ª

    except Exception as e:
        log_error(f"auto-register chat in text handler: {e}")

    # 2. –ü–µ—Ä–µ—Å—ã–ª–∫–∞ (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞)
    try:
        handle_forwarding_for_message(msg)
    except Exception as e:
        log_error(f"forward in text handler: {e}")

    # 3. –î–∞–ª—å—à–µ ‚Äî –ª–æ–≥–∏–∫–∞ —Ñ–∏–Ω–±–æ—Ç–∞
    if not msg.text:
        return

    if msg.text.strip().startswith(ACTIVATION_COMMAND):
        set_finance_mode(chat_id, True)
        bot.send_message(chat_id, "üöÄ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞!")
        open_or_update_main_window(chat_id)
        return

    if not is_finance_mode(chat_id):
        return

    # –ü—Ä–∏–º–µ—Ä –ø—Ä–æ—Å—Ç–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞: "+1000 –ü—Ä–æ–¥—É–∫—Ç—ã —Ö–ª–µ–±"
    parts = msg.text.strip().split(" ", 2)
    if len(parts) >= 2:
        amt = parse_amount(parts[0])
        if amt is not None:
            category = parts[1]
            comment = parts[2] if len(parts) > 2 else ""
            data_chat = load_chat_json(chat_id)
            day_key = data_chat.get("current_day") or today_key()
            day = ensure_day(data_chat, day_key)
            rec = {
                "time": now_local().strftime("%H:%M"),
                "category": category,
                "amount": amt,
                "comment": comment,
            }
            day["records"].append(rec)
            recalc_day_summary(data_chat, day_key)
            recalc_all_summaries(data_chat)
            save_chat_json(chat_id, data_chat)
            append_chat_csv(chat_id, [day_key, rec["time"], category, amt, comment])

            try:
                open_or_update_main_window(chat_id)
            except Exception as e:
                log_error(f"open_or_update_main_window after add error: {e}")
            return

# ==========================================================
# –û–¢–°–ï–ö 13 ‚Äî CALLBACK_QUERY HANDLERS (–ö–ù–û–ü–ö–ò)
# ==========================================================
@bot.callback_query_handler(func=lambda c: True)
def on_callback_query(call: telebot.types.CallbackQuery):
    chat_id = call.message.chat.id
    data_chat = load_chat_json(chat_id)
    day_key = data_chat.get("current_day") or today_key()
    ensure_day(data_chat, day_key)

    if call.data == "back_to_main":
        text_msg = build_day_text(data_chat, day_key)
        kb = build_main_keyboard()
        try:
            bot.edit_message_text(
                chat_id=chat_id,
                message_id=call.message.message_id,
                text=text_msg,
                reply_markup=kb
            )
        except Exception as e:
            log_error(f"back_to_main error: {e}")
        return

    if call.data == "edit_menu":
        kb = types.InlineKeyboardMarkup()
        kb.row(
            types.InlineKeyboardButton("üìù –ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å", callback_data="edit_record"),
            types.InlineKeyboardButton("‚ùå –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å", callback_data="delete_record"),
        )
        kb.row(
            types.InlineKeyboardButton("üóë –û—á–∏—Å—Ç–∏—Ç—å –¥–µ–Ω—å", callback_data="clear_day"),
        )
        kb.row(
            types.InlineKeyboardButton("üì§ –≠–∫—Å–ø–æ—Ä—Ç CSV", callback_data="export_csv"),
        )
        kb.row(
            types.InlineKeyboardButton("üîÅ –ü–µ—Ä–µ—Å—ã–ª–∫–∞", callback_data="forward_menu"),
        )
        kb.row(
            types.InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_main"),
        )
        try:
            bot.edit_message_reply_markup(
                chat_id=chat_id,
                message_id=call.message.message_id,
                reply_markup=kb
            )
        except Exception as e:
            log_error(f"edit_menu error: {e}")
        return

    if call.data == "total_balance":
        total = get_total_balance_for_chat(data_chat)
        try:
            bot.answer_callback_query(
                callback_query_id=call.id,
                text=f"–û–±—â–∏–π –∏—Ç–æ–≥ –ø–æ —ç—Ç–æ–º—É —á–∞—Ç—É: {format_amount(total)}",
                show_alert=True
            )
        except Exception as e:
            log_error(f"total_balance callback error: {e}")
        return

    if call.data == "export_csv":
        try:
            export_chat_to_csv(chat_id, data_chat)
            path = chat_csv_file(chat_id)
            with open(path, "rb") as f:
                bot.send_document(chat_id, f)
        except Exception as e:
            log_error(f"export_csv error: {e}")
        return

# ==========================================================
# –û–¢–°–ï–ö 14 ‚Äî –ë–≠–ö–ê–ü–´ –í –ö–ê–ù–ê–õ
# ==========================================================
def export_to_csv(d):
    try:
        with open("data_export.csv", "w", newline="", encoding="utf-8") as f:
            writer = csv.writer(f, delimiter=";")
            writer.writerow(["chat_id", "idx", "category", "amount", "comment"])
            for cid, info in d.get("chats", {}).items():
                for idx, rec in enumerate(info.get("records", []), start=1):
                    writer.writerow([
                        cid,
                        idx,
                        rec.get("category", ""),
                        rec.get("amount", ""),
                        rec.get("comment", "")
                    ])
        log_info("CSV —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ data_export.csv")
    except Exception as e:
        log_error(f"export_to_csv error: {e}")

def send_backup_to_channel():
    if not BACKUP_CHAT_ID:
        log_info("BACKUP_CHAT_ID –Ω–µ –∑–∞–¥–∞–Ω, –±—ç–∫–∞–ø –≤ –∫–∞–Ω–∞–ª –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è.")
        return

    try:
        if os.path.exists(DATA_FILE):
            with open(DATA_FILE, "rb") as f:
                bot.send_document(
                    int(BACKUP_CHAT_ID),
                    f,
                    caption=f"data.json backup ({now_local().isoformat(timespec='seconds')})",
                )
    except Exception as e:
        log_error(f"send_backup_to_channel data.json error: {e}")

    try:
        if os.path.exists("data_export.csv"):
            with open("data_export.csv", "rb") as f:
                bot.send_document(
                    int(BACKUP_CHAT_ID),
                    f,
                    caption="data_export.csv (—ç–∫—Å–ø–æ—Ä—Ç –∏–∑ data.json)",
                )
    except Exception as e:
        log_error(f"send_backup_to_channel csv error: {e}")

# ==========================================================
# –û–¢–°–ï–ö 15 ‚Äî KEEP-ALIVE
# ==========================================================
def keep_alive_loop():
    while True:
        try:
            if KEEP_ALIVE_SEND_TO_OWNER and OWNER_ID:
                try:
                    bot.send_chat_action(int(OWNER_ID), "typing")
                except Exception as e:
                    log_error(f"keep_alive send_chat_action error: {e}")
            time.sleep(KEEP_ALIVE_INTERVAL_SECONDS)
        except Exception as e:
            log_error(f"keep_alive_loop error: {e}")
            time.sleep(60)

def start_keep_alive_thread():
    t = threading.Thread(target=keep_alive_loop, daemon=True)
    t.start()

# ==========================================================
# –û–¢–°–ï–ö 16 ‚Äî –í–ï–ë–•–£–ö / –ü–û–õ–õ–ò–ù–ì
# ==========================================================
@app.route("/" + TOKEN, methods=["POST"])
def webhook():
    json_str = request.get_data().decode("utf-8")
    update = telebot.types.Update.de_json(json_str)
    # –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å handle_bot_membership_change –ø—Ä–∏ –Ω—É–∂–Ω–æ–º —Ç–∏–ø–µ –∞–ø–¥–µ–π—Ç–∞
    bot.process_new_updates([update])
    return "OK", 200

@app.route("/")
def index():
    return "Bot is running", 200

def setup_webhook():
    if not APP_URL:
        log_info("APP_URL –Ω–µ –∑–∞–¥–∞–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É –≤–µ–±—Ö—É–∫–∞.")
        return
    url = f"{APP_URL}/{TOKEN}"
    try:
        bot.remove_webhook()
        time.sleep(1)
        bot.set_webhook(url=url)
        log_info(f"Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {url}")
    except Exception as e:
        log_error(f"setup_webhook error: {e}")

def start_polling():
    log_info("–ó–∞–ø—É—Å–∫ polling...")
    bot.infinity_polling(skip_pending=True, timeout=60, long_polling_timeout=60)

# ==========================================================
# –û–¢–°–ï–ö 17 ‚Äî –¢–û–ß–ö–ê –í–•–û–î–ê
# ==========================================================
if __name__ == "__main__":
    log_info(f"–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤–µ—Ä—Å–∏–∏ {VERSION}")
    start_keep_alive_thread()

    if APP_URL:
        setup_webhook()
        app.run(host="0.0.0.0", port=PORT)
    else:
        start_polling()