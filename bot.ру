import telebot
from telebot import types
import json
import os
from datetime import date

# üîπ –¢–æ–∫–µ–Ω –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å —Å—é–¥–∞ –ø—Ä—è–º–æ, –µ—Å–ª–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø—Ä–∏–≤–∞—Ç–Ω—ã–π:
# TOKEN = "–í–ê–®_–¢–û–ö–ï–ù_–û–¢_BOTFATHER"
# üîπ –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è (–±–µ–∑–æ–ø–∞—Å–Ω–µ–µ):
TOKEN = os.getenv("BOT_TOKEN") or "–í–°–¢–ê–í–¨_–°–Æ–î–ê_–¢–û–ö–ï–ù"

bot = telebot.TeleBot(TOKEN)

DATA_FILE = "finance_data.json"

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
if os.path.exists(DATA_FILE):
    with open(DATA_FILE, "r", encoding="utf-8") as f:
        finance_data = json.load(f)
else:
    finance_data = {}

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª
def save_data():
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(finance_data, f, ensure_ascii=False, indent=2)

# –ü–æ–ª—É—á–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
def today():
    return str(date.today())

# –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
def get_summary(user_id):
    user_id = str(user_id)
    user_data = finance_data.get(user_id, {})
    all_time = sum([
        (day_data.get("income", 0) + day_data.get("expense", 0))
        for day_data in user_data.values()
    ]) if user_data else 0

    today_data = user_data.get(today(), {"income": 0, "expense": 0})
    income = today_data.get("income", 0)
    expense = today_data.get("expense", 0)

    text = (
        f"üìÖ <b>{today()}</b>\n"
        f"üí∞ –ü—Ä–∏—Ö–æ–¥ –¥–Ω—è: <b>{income:.2f}</b>\n"
        f"üí∏ –†–∞—Å—Ö–æ–¥ –¥–Ω—è: <b>{abs(expense):.2f}</b>\n"
        f"üìä –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: <b>{all_time:.2f}</b>"
    )
    return text

# –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
def get_keyboard():
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—Ö–æ–¥ –¥–Ω—è", callback_data="edit_day"))
    return kb

@bot.message_handler(commands=["start"])
def start(message):
    bot.reply_to(
        message,
        "üëã –ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ –±–æ—Ç —É—á—ë—Ç–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤.\n"
        "–û—Ç–ø—Ä–∞–≤—å —á–∏—Å–ª–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä:\n"
        "`-1000 —Ö–ª–µ–±` ‚Äî —Ä–∞—Å—Ö–æ–¥\n"
        "`1000` ‚Äî —Ä–∞—Å—Ö–æ–¥\n"
        "`+1000 –∑–ø` ‚Äî –ø—Ä–∏—Ö–æ–¥\n\n"
        "–Ø –ø–æ—Å—á–∏—Ç–∞—é –∏ –ø–æ–∫–∞–∂—É –±–∞–ª–∞–Ω—Å üí∞",
        parse_mode="Markdown"
    )

@bot.message_handler(func=lambda msg: True)
def handle_message(message):
    user_id = str(message.from_user.id)
    text = message.text.strip()

    # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–µ—Ä–≤–æ–µ —á–∏—Å–ª–æ
    num_str = ""
    for ch in text:
        if ch in "+-0123456789.":
            num_str += ch
        else:
            break

    if not num_str:
        return  # –Ω–µ—Ç —á–∏—Å–ª–∞

    try:
        number = float(num_str)
    except:
        return  # –Ω–µ —á–∏—Å–ª–æ

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ –ø–µ—Ä–≤–æ–º—É —Å–∏–º–≤–æ–ª—É
    first_char = num_str[0]
    if first_char == "+":
        is_income = True
    else:
        is_income = False  # –º–∏–Ω—É—Å –∏–ª–∏ –±–µ–∑ –∑–Ω–∞–∫–∞ ‚Üí —Ä–∞—Å—Ö–æ–¥

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if user_id not in finance_data:
        finance_data[user_id] = {}
    if today() not in finance_data[user_id]:
        finance_data[user_id][today()] = {"income": 0, "expense": 0}

    # –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
    if is_income:
        finance_data[user_id][today()]["income"] += abs(number)
        action = f"üí∞ –ü—Ä–∏—Ö–æ–¥: +{abs(number)}"
    else:
        finance_data[user_id][today()]["expense"] -= abs(number)
        action = f"üí∏ –†–∞—Å—Ö–æ–¥: -{abs(number)}"

    save_data()

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ
    summary_text = action + "\n\n" + get_summary(user_id)
    sent = bot.send_message(message.chat.id, summary_text, parse_mode="HTML", reply_markup=get_keyboard())

    # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å
    try:
        old_id = finance_data[user_id][today()].get("prev_msg")
        if old_id:
            bot.delete_message(message.chat.id, old_id)
        finance_data[user_id][today()]["prev_msg"] = sent.message_id
        save_data()
    except:
        pass

@bot.callback_query_handler(func=lambda call: call.data == "edit_day")
def edit_day(call):
    bot.answer_callback_query(call.id)
    bot.send_message(call.message.chat.id, "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.")

print("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
bot.polling(non_stop=True)
