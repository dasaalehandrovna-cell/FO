# üßæ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç ‚Äî –≤–µ—Ä—Å–∏—è 9.8.6-fo_6+GDriveOnly (–∫–∞–Ω–∞–ª, per-chat)
# ID Code_021a ‚Äî –æ–±–Ω–æ–≤–ª—ë–Ω –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø–æ —á–∞—Ç–∞–º
# ==========================================================
# üß≠ –û–ø–∏—Å–∞–Ω–∏–µ:
#  ‚Ä¢ –ü–æ–ª–Ω—ã–π UI –∫–∞–∫ –≤ 9.8.6-fo_6
#  ‚Ä¢ ‚òÅÔ∏è –ë—ç–∫–∞–ø –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ Google Drive
#  ‚Ä¢ üì¶ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –¥—É–±–ª–∏—Ä—É–µ—Ç –±—ç–∫–∞–ø –≤ –∫–∞–Ω–∞–ª
#  ‚Ä¢ üíæ –ö–∞–∂–¥—ã–π —á–∞—Ç —Ö—Ä–∞–Ω–∏—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
#    data_<chat_id>.json, data_<chat_id>.csv, csv_meta_<chat_id>.json
# ============================================================
#‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚öôÔ∏è –ù–∞—á–∏–Ω–∞–µ–º ‚Äî –≤–æ—Ç –ß–ê–°–¢–¨ 1 / 4:‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢
import os
import io
import json
import csv
import re
import html
import logging
import threading
import time
from datetime import datetime, timedelta, timezone
from zoneinfo import ZoneInfo

import requests
import telebot
from telebot import types
from flask import Flask, request

# --- Google Drive ---
from googleapiclient.http import MediaFileUpload, MediaIoBaseDownload
from googleapiclient.discovery import build
from google.oauth2 import service_account

# -----------------------------
# ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
# -----------------------------
TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")
APP_URL = os.getenv("APP_URL", "https://yourapp.onrender.com")
PORT = int(os.getenv("PORT", 5000))
VERSION = "9.8.6-fo_6+GDriveOnly-perChat"

try:
    TZ = ZoneInfo((os.getenv("TZ") or "America/Argentina/Buenos_Aires").strip())
except Exception:
    TZ = timezone(timedelta(hours=-3))

DATA_FILE = "data.json"
CSV_FILE = "data.csv"
CSV_META_FILE = "csv_meta.json"
LOG_FILE = "log.txt"

# üíæ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞
def chat_data_file(chat_id: int) -> str:
    return f"data_{chat_id}.json"

def chat_csv_file(chat_id: int) -> str:
    return f"data_{chat_id}.csv"

def chat_csv_meta_file(chat_id: int) -> str:
    return f"csv_meta_{chat_id}.json"

KEEP_ALIVE_INTERVAL_SECONDS = int(os.getenv("KEEP_ALIVE_INTERVAL_SECONDS", 11 * 60))
KEEP_ALIVE_SEND_TO_OWNER = True
GDRIVE_FOLDER_ID = os.getenv("GDRIVE_FOLDER_ID")
SERVICE_ACCOUNT_JSON = os.getenv("SERVICE_ACCOUNT_JSON", "service_account.json")
BACKUP_CHAT_ID = os.getenv("BACKUP_CHAT_ID")

if not TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[logging.FileHandler(LOG_FILE, encoding="utf-8"), logging.StreamHandler()]
)
def log_info(msg): logging.info(msg)
def log_error(msg): logging.error(msg)

log_info(f"üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ {VERSION}")

def now_local() -> datetime: return datetime.now(TZ)
def today_key() -> str: return now_local().strftime("%Y-%m-%d")
def parse_date_key(s: str):
    try: return datetime.strptime(s, "%Y-%m-%d").date()
    except: return None
def shift_date_key(day_key: str, days: int) -> str:
    d = parse_date_key(day_key) or now_local().date()
    return (d + timedelta(days=days)).strftime("%Y-%m-%d")

def fmt_num(value):
    try:
        s = f"{float(value):,.2f}".replace(",", "X").replace(".", ",").replace("X", ".")
        return s
    except Exception:
        return str(value)

def auto_double_message(chat_id, text):
    if "–±–æ—Ç –∑–∞–ø—É—â–µ–Ω" in (text or "").lower():
        return
    def delayed():
        time.sleep(30)
        try:
            bot.send_message(chat_id, text, parse_mode="HTML")
        except Exception as e:
            log_error(f"auto_double_message: {e}")
    threading.Thread(target=delayed, daemon=True).start()

def send_info(chat_id, text):
    try:
        bot.send_message(chat_id, text, parse_mode="HTML")
        auto_double_message(chat_id, text)
    except Exception as e:
        log_error(f"send_info: {e}")

def send_temp_message(chat_id, text, delay=5):
    msg = bot.send_message(chat_id, text)
    threading.Timer(delay, lambda: bot.delete_message(chat_id, msg.message_id)).start()

# ---------- JSON –∏ CSV ----------
def _load_json(path, fallback):
    try:
        if os.path.exists(path):
            with open(path, "r", encoding="utf-8") as f:
                return json.load(f)
    except Exception as e:
        log_error(f"_load_json: {path}: {e}")
    return fallback

def _save_json(path, payload):
    try:
        with open(path, "w", encoding="utf-8") as f:
            json.dump(payload, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"_save_json: {path}: {e}")

def default_data():
    return {
        "overall_balance": 0,
        "records": [],
        "chats": {},
        "active_messages": {},
        "next_id": 1
    }

def load_data():
    d = _load_json(DATA_FILE, default_data())
    base = default_data()
    for k, v in base.items():
        if k not in d:
            d[k] = v
    return d

def save_data(d):
    try:
        _save_json(DATA_FILE, d)
        export_to_csv(d)
        log_info("üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ (–æ–±—â–∏–π –∫—ç—à).")
    except Exception as e:
        log_error(f"save_data: {e}")

def export_to_csv(d):
    try:
        with open(CSV_FILE, "w", newline="", encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
            for cid, cdata in d.get("chats", {}).items():
                for dk, records in cdata.get("daily_records", {}).items():
                    for r in records:
                        writer.writerow([
                            cid,
                            r.get("id"), r.get("short_id"), r.get("timestamp"),
                            r.get("amount"), r.get("note"), r.get("owner"), dk
                        ])
    except Exception as e:
        log_error(f"export_to_csv: {e}")

# ---------- —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ JSON –∏ CSV –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞ ----------
def save_chat_json(chat_id: int, data):
    try:
        store = data.get("chats", {}).get(str(chat_id), {})
        payload = {
            "chat_id": chat_id,
            "balance": store.get("balance", 0),
            "records": store.get("records", []),
            "daily_records": store.get("daily_records", {}),
            "next_id": store.get("next_id", 1),
        }
        with open(chat_data_file(chat_id), "w", encoding="utf-8") as f:
            json.dump(payload, f, ensure_ascii=False, indent=2)
        with open(chat_csv_file(chat_id), "w", newline="", encoding="utf-8") as f:
            w = csv.writer(f)
            w.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
            for dk, recs in store.get("daily_records", {}).items():
                for r in recs:
                    w.writerow([chat_id, r.get("id"), r.get("short_id"),
                                r.get("timestamp"), r.get("amount"),
                                r.get("note"), r.get("owner"), dk])
        log_info(f"üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è —á–∞—Ç–∞ {chat_id}")
    except Exception as e:
        log_error(f"save_chat_json({chat_id}): {e}")

#‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢–ì–æ—Ç–æ–≤–æ. –í–æ—Ç –ß–ê–°–¢–¨ 2 / 4.‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢
# ---------- Google Drive ----------
def _build_gdrive_credentials():
    if not SERVICE_ACCOUNT_JSON:
        raise RuntimeError("SERVICE_ACCOUNT_JSON –Ω–µ –∑–∞–¥–∞–Ω–∞")
    try:
        if isinstance(SERVICE_ACCOUNT_JSON, str) and SERVICE_ACCOUNT_JSON.strip().startswith("{"):
            sa_info = json.loads(SERVICE_ACCOUNT_JSON)
            scopes = ["https://www.googleapis.com/auth/drive"]
            return service_account.Credentials.from_service_account_info(sa_info, scopes=scopes)
        else:
            scopes = ["https://www.googleapis.com/auth/drive"]
            return service_account.Credentials.from_service_account_file(SERVICE_ACCOUNT_JSON, scopes=scopes)
    except Exception as e:
        log_error(f"GDrive creds error: {e}")
        raise

def _drive_service():
    creds = _build_gdrive_credentials()
    return build("drive", "v3", credentials=creds, cache_discovery=False)

def _gdrive_find_folder(service, name_or_id):
    if name_or_id and re.fullmatch(r"[A-Za-z0-9_-]{10,}", name_or_id):
        return name_or_id
    if not name_or_id:
        return None
    q = f"mimeType='application/vnd.google-apps.folder' and name='{name_or_id}' and trashed=false"
    res = service.files().list(q=q, spaces="drive", fields="files(id,name)", pageSize=10).execute()
    files = res.get("files", [])
    return files[0]["id"] if files else None

def _gdrive_find_file(service, filename, folder_id=None):
    if folder_id:
        q = f"name='{filename}' and '{folder_id}' in parents and trashed=false"
    else:
        q = f"name='{filename}' and trashed=false"
    res = service.files().list(q=q, spaces="drive", fields="files(id,name)", pageSize=5).execute()
    files = res.get("files", [])
    return files[0]["id"] if files else None

def _guess_mime(path):
    n = os.path.basename(path).lower()
    if n.endswith(".json"): return "application/json"
    if n.endswith(".csv"):  return "text/csv"
    return "application/octet-stream"

def _gdrive_upload(service, local_path, folder_id=None):
    name = os.path.basename(local_path)
    file_id = _gdrive_find_file(service, name, folder_id)
    media = MediaFileUpload(local_path, mimetype=_guess_mime(local_path), resumable=True)
    if file_id:
        return service.files().update(fileId=file_id, media_body=media).execute().get("id")
    meta = {"name": name}
    if folder_id: meta["parents"] = [folder_id]
    return service.files().create(body=meta, media_body=media, fields="id").execute().get("id")

def _gdrive_download(service, filename, dest_path, folder_id=None):
    file_id = _gdrive_find_file(service, filename, folder_id)
    if not file_id:
        return False
    req = service.files().get_media(fileId=file_id)
    fh = io.FileIO(dest_path, "wb")
    downloader = MediaIoBaseDownload(fh, req)
    done = False
    while not done:
        status, done = downloader.next_chunk()
    return True

def upload_to_gdrive(path):
    try:
        service = _drive_service()
        folder_id = _gdrive_find_folder(service, GDRIVE_FOLDER_ID) if GDRIVE_FOLDER_ID else None
        fid = _gdrive_upload(service, path, folder_id)
        log_info(f"‚òÅÔ∏è Upload OK: {os.path.basename(path)} ‚Üí {fid}")
        return fid
    except Exception as e:
        log_error(f"upload_to_gdrive({path}): {e}")
        return None

def download_from_gdrive(filename, dest):
    try:
        service = _drive_service()
        folder_id = _gdrive_find_folder(service, GDRIVE_FOLDER_ID) if GDRIVE_FOLDER_ID else None
        ok = _gdrive_download(service, filename, dest, folder_id)
        if ok: log_info(f"‚òÅÔ∏è Download OK: {filename} ‚Üí {dest}")
        else:  log_info(f"‚òÅÔ∏è Download MISS: {filename} (–Ω–µ –Ω–∞–π–¥–µ–Ω)")
        return ok
    except Exception as e:
        log_error(f"download_from_gdrive({filename}): {e}")
        return False

# ---------- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (–æ–±—â–∏–π –∫—ç—à) ----------
def restore_from_gdrive_if_needed():
    need = []
    if not os.path.exists(DATA_FILE): need.append(DATA_FILE)
    if not os.path.exists(CSV_FILE): need.append(CSV_FILE)
    if not os.path.exists(CSV_META_FILE): need.append(CSV_META_FILE)
    if not need:
        return
    if OWNER_ID:
        send_info(int(OWNER_ID), "‚òÅÔ∏è –ü—ã—Ç–∞—é—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã —Å Google Drive‚Ä¶")
    for fn in [CSV_META_FILE, DATA_FILE, CSV_FILE]:
        if fn in need:
            download_from_gdrive(fn, fn)
    if not os.path.exists(DATA_FILE): _save_json(DATA_FILE, default_data())
    if not os.path.exists(CSV_META_FILE): _save_json(CSV_META_FILE, {})

# ---------- –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ Drive ----------
def _sync_all_backups_gdrive(d):
    try:
        save_data(d)  # –ª–æ–∫–∞–ª—å–Ω–æ –æ–±—â–∏–π –∫—ç—à + –æ–±—â–∏–π CSV
        # –≤—ã–≥—Ä—É–∂–∞–µ–º per-chat JSON/CSV
        for cid in d.get("chats", {}):
            cjson = chat_data_file(cid)
            ccsv = chat_csv_file(cid)
            if os.path.exists(cjson): upload_to_gdrive(cjson)
            if os.path.exists(ccsv): upload_to_gdrive(ccsv)
        # –∏ –±–∞–∑–æ–≤—ã–µ —Ñ–∞–π–ª—ã (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        for p in (DATA_FILE, CSV_FILE, CSV_META_FILE):
            if os.path.exists(p):
                upload_to_gdrive(p)
    except Exception as e:
        log_error(f"_sync_all_backups_gdrive: {e}")

def sync_all_backups_gdrive_async(d):
    threading.Thread(target=_sync_all_backups_gdrive, args=(d,), daemon=True).start()

# ---------- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ----------
restore_from_gdrive_if_needed()
data = load_data()

# ---------- –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ —á–∞—Ç–∞–º ----------
def get_chat_store(chat_id: int) -> dict:
    cid = str(chat_id)
    if cid not in data["chats"]:
        data["chats"][cid] = {
            "balance": 0,
            "records": [],
            "next_id": 1,
            "daily_records": {},
            "active_windows": {},
            "edit_wait": None,
            "edit_target": None,
            "current_view_day": today_key()
        }
        save_data(data)
        save_chat_json(chat_id, data)
        sync_all_backups_gdrive_async(data)
    store = data["chats"][cid]
    store.setdefault("current_view_day", today_key())
    return store

def set_current_view_day(chat_id: int, day_key: str):
    store = get_chat_store(chat_id)
    store["current_view_day"] = day_key
    save_data(data)
    save_chat_json(chat_id, data)
    sync_all_backups_gdrive_async(data)

def get_current_view_day(chat_id: int) -> str:
    return get_chat_store(chat_id).get("current_view_day", today_key())

def get_active_window_id(chat_id: int, day_key: str):
    return data.setdefault("active_messages", {}).setdefault(day_key, {}).get(str(chat_id))

def set_active_window(chat_id: int, day_key: str, message_id: int):
    data.setdefault("active_messages", {}).setdefault(day_key, {})[str(chat_id)] = message_id
    save_data(data)
    save_chat_json(chat_id, data)
    sync_all_backups_gdrive_async(data)

def clear_active_window(chat_id: int, day_key: str):
    am = data.setdefault("active_messages", {}).setdefault(day_key, {})
    if str(chat_id) in am:
        am.pop(str(chat_id), None)
        save_data(data)
        save_chat_json(chat_id, data)
        sync_all_backups_gdrive_async(data)

def delete_message_safe(chat_id: int, message_id: int):
    try:
        bot.delete_message(chat_id, message_id)
    except Exception:
        pass

def delete_active_window_if_exists(chat_id: int, day_key: str):
    old_id = get_active_window_id(chat_id, day_key)
    if old_id:
        delete_message_safe(chat_id, old_id)
        clear_active_window(chat_id, day_key)

# ---------- –ö–∞–Ω–∞–ª—å–Ω—ã–π –±—ç–∫–∞–ø ----------
def send_backup_to_channel():
    if not BACKUP_CHAT_ID:
        log_info("‚ö†Ô∏è BACKUP_CHAT_ID –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∫–∞–Ω–∞–ª.")
        return
    try:
        time.sleep(0.8)  # –¥–∞—ë–º —Ñ–∞–π–ª–∞–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è
        # per-chat JSON/CSV
        for cid in data.get("chats", {}):
            for fpath in (chat_data_file(cid), chat_csv_file(cid)):
                if os.path.exists(fpath) and os.path.getsize(fpath) > 0:
                    with open(fpath, "rb") as f:
                        bot.send_document(
                            int(BACKUP_CHAT_ID),
                            f,
                            caption=f"üßæ {os.path.basename(fpath)} ‚Äî –∞–≤—Ç–æ-–±—ç–∫–∞–ø ({now_local().strftime('%Y-%m-%d %H:%M')})"
                        )
        # –±–∞–∑–æ–≤—ã–µ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        for fname in (DATA_FILE, CSV_FILE, CSV_META_FILE):
            if os.path.exists(fname) and os.path.getsize(fname) > 0:
                with open(fname, "rb") as f:
                    bot.send_document(
                        int(BACKUP_CHAT_ID),
                        f,
                        caption=f"üì¶ {fname} ‚Äî –æ–±—â–∏–π –±—ç–∫–∞–ø ({now_local().strftime('%Y-%m-%d %H:%M')})"
                    )
        log_info("üì§ –ë—ç–∫–∞–ø –≤ –∫–∞–Ω–∞–ª –∑–∞–≤–µ—Ä—à—ë–Ω.")
    except Exception as e:
        log_error(f"send_backup_to_channel: {e}")

# –ø–µ—Ä–≤–∏—á–Ω–∞—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏ —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –±—ç–∫–∞–ø –≤ –∫–∞–Ω–∞–ª (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
sync_all_backups_gdrive_async(data)
send_backup_to_channel()

# ---------- UI –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã ----------
def build_main_keyboard(day_key: str, chat_id: int | None = None):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å", callback_data=f"d:{day_key}:balance"),
        types.InlineKeyboardButton("üìä –û—Ç—á—ë—Ç", callback_data=f"d:{day_key}:report"),
    )
    kb.row(
        types.InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data=f"d:{day_key}:refresh"),
        types.InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"d:{day_key}:edit_menu"),
    )
    chat_data = data.get("chats", {}).get(str(chat_id), {})
    total = chat_data.get("balance", 0)
    kb.add(
        types.InlineKeyboardButton(
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(total)} ARS",
            callback_data=f"d:{day_key}:total"
        )
    )
    return kb

def build_edit_menu_keyboard(day_key: str, chat_id=None):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å", callback_data=f"d:{day_key}:edit_list"),
        types.InlineKeyboardButton("üìÇ –û–±—â–∏–π CSV", callback_data=f"d:{day_key}:csv_all")
    )
    kb.row(
        types.InlineKeyboardButton("üìÖ CSV –∑–∞ –¥–µ–Ω—å", callback_data=f"d:{day_key}:csv_day"),
        types.InlineKeyboardButton("‚öôÔ∏è –û–±–Ω—É–ª–∏—Ç—å", callback_data=f"d:{day_key}:reset")
    )
    kb.row(
        types.InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data=f"d:{today_key()}:open"),
        types.InlineKeyboardButton("üìÜ –í—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å", callback_data=f"d:{day_key}:pick_date")
    )
    kb.row(
        types.InlineKeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ", callback_data=f"d:{day_key}:info"),
        types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:back_main")
    )
    return kb

def build_edit_keyboard_for_record(day_key: str, rid: int):
    kb = types.InlineKeyboardMarkup(row_width=1)
    kb.add(types.InlineKeyboardButton("‚úè –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é", callback_data=f"d:{day_key}:edit_manual:{rid}"))
    kb.add(types.InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å", callback_data=f"d:{day_key}:edit_delete:{rid}"))
    kb.add(types.InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"d:{day_key}:edit_back"))
    return kb

def build_confirm_delete_keyboard(day_key: str, rid: int):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å", callback_data=f"d:{day_key}:confirm_delete:{rid}"),
        types.InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data=f"d:{day_key}:cancel_delete")
    )
    return kb

def build_reset_confirm_keyboard(day_key: str):
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("‚úÖ –î–∞, –æ–±–Ω—É–ª–∏—Ç—å", callback_data=f"d:{day_key}:confirm_reset_all"),
        types.InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data=f"d:{day_key}:cancel_reset_all")
    )
    return kb

def build_last_31days_calendar():
    today = now_local().date()
    days = [today - timedelta(days=i) for i in range(0, 31)]
    kb = types.InlineKeyboardMarkup()
    row = []
    for idx, d_ in enumerate(days, start=1):
        label = d_.strftime("%d/%m"); dk = d_.strftime("%Y-%m-%d")
        row.append(types.InlineKeyboardButton(text=label, callback_data=f"d:{dk}:calopen"))
        if idx % 7 == 0:
            kb.row(*row); row = []
    if row: kb.row(*row)
    return kb

def render_day_text(store: dict, day_key: str) -> str:
    day_records = store.get("daily_records", {}).get(day_key, [])
    daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
    daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
    overall_balance = store.get("balance", 0)

    if not day_records:
        text = (
            f"üìÖ {day_key}\n"
            f"–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å.\n"
            f"üíµ –ü—Ä–∏—Ö–æ–¥: {fmt_num(daily_income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {fmt_num(abs(daily_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall_balance)} ARS"
        )
    else:
        lines = [f"üìÖ {day_key}", "üìã –û–ø–µ—Ä–∞—Ü–∏–∏:"]
        for r in day_records[-50:]:
            sign = "+" if r["amount"] > 0 else "-"
            lines.append(f"{r['short_id']}: {sign}{fmt_num(abs(r['amount']))} ‚Äî {r.get('note','')}")
        lines.append(
            f"\nüíµ –ü—Ä–∏—Ö–æ–¥: {fmt_num(daily_income)} ARS\n"
            f"üí∏ –†–∞—Å—Ö–æ–¥: {fmt_num(abs(daily_expense))} ARS\n"
            f"üí∞ –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {fmt_num(overall_balance)} ARS"
        )
        text = "\n".join(lines)
    return text

#‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢–í–æ—Ç –ß–ê–°–¢–¨ 3 / 4‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢
# ---------- –ü–∞—Ä—Å–µ—Ä —Å—É–º–º ----------
def parse_amount_token(token: str) -> int:
    """
    –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Å—Ç—Ä–æ–∫—É –≤—Ä–æ–¥–µ "1.200", "1 200", "1,200", "1.200,50", "+1 000", "-2.500,75"
    –≤ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ (–æ–∫—Ä—É–≥–ª—ë–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ ARS).
    """
    if not token:
        return 0
    s = token.strip()
    s = s.replace(" ", "").replace("'", "").replace("_", "")
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–∞–ø—è—Ç—É—é –≤ —Ç–æ—á–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –≤ –¥—Ä–æ–±–Ω–æ–π —á–∞—Å—Ç–∏
    if "," in s and "." in s:
        if s.rfind(",") > s.rfind("."):
            s = s.replace(".", "").replace(",", ".")
        else:
            s = s.replace(",", "")
    elif "," in s:
        s = s.replace(",", ".")
    try:
        val = float(s)
        return int(round(val))
    except Exception:
        try:
            return int(re.sub(r"[^\d+-]", "", s))
        except Exception:
            return 0

# ---------- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ ----------
def add_record_to_chat(chat_id: int, text: str, owner=None):
    store = get_chat_store(chat_id)
    day = get_current_view_day(chat_id)
    tokens = text.split()
    if not tokens:
        return send_temp_message(chat_id, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—É–º–º—É")
    amount = parse_amount_token(tokens[0])
    note = " ".join(tokens[1:]) if len(tokens) > 1 else ""
    rec_id = store.get("next_id", 1)
    rec = {
        "id": rec_id,
        "short_id": f"#{rec_id}",
        "timestamp": now_local().isoformat(),
        "amount": amount,
        "note": note,
        "owner": owner or chat_id,
    }
    store["next_id"] = rec_id + 1
    store.setdefault("daily_records", {}).setdefault(day, []).append(rec)
    store["balance"] = store.get("balance", 0) + amount
    save_data(data)
    save_chat_json(chat_id, data)
    update_or_send_day_window(chat_id, day)
    sync_all_backups_gdrive_async(data)
    send_backup_to_channel()

# ---------- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ ----------
def update_record_in_chat(chat_id: int, record_id: int, new_text: str):
    store = get_chat_store(chat_id)
    day = get_current_view_day(chat_id)
    amount = parse_amount_token(new_text.split()[0])
    note = " ".join(new_text.split()[1:]) if len(new_text.split()) > 1 else ""
    for rec in store.get("daily_records", {}).get(day, []):
        if rec["id"] == record_id:
            diff = amount - rec["amount"]
            rec["amount"] = amount
            rec["note"] = note
            store["balance"] += diff
            break
    save_data(data)
    save_chat_json(chat_id, data)
    update_or_send_day_window(chat_id, day)
    sync_all_backups_gdrive_async(data)
    send_backup_to_channel()

# ---------- –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ ----------
def delete_record_in_chat(chat_id: int, record_id: int):
    store = get_chat_store(chat_id)
    day = get_current_view_day(chat_id)
    new_list = []
    removed = 0
    for rec in store.get("daily_records", {}).get(day, []):
        if rec["id"] == record_id:
            removed = rec["amount"]
            continue
        new_list.append(rec)
    store["daily_records"][day] = new_list
    store["balance"] -= removed
    save_data(data)
    save_chat_json(chat_id, data)
    update_or_send_day_window(chat_id, day)
    sync_all_backups_gdrive_async(data)
    send_backup_to_channel()

# ---------- –°–±—Ä–æ—Å –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π ----------
def reset_all_records(chat_id: int):
    store = get_chat_store(chat_id)
    store["daily_records"] = {}
    store["balance"] = 0
    save_data(data)
    save_chat_json(chat_id, data)
    update_or_send_day_window(chat_id, today_key())
    sync_all_backups_gdrive_async(data)
    send_backup_to_channel()

# ---------- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –≤—ã–≤–æ–¥ –æ–∫–Ω–∞ ----------
def update_or_send_day_window(chat_id: int, day_key: str):
    store = get_chat_store(chat_id)
    text = render_day_text(store, day_key)
    kb = build_main_keyboard(day_key, chat_id)
    mid = get_active_window_id(chat_id, day_key)
    try:
        if mid:
            bot.edit_message_text(
                chat_id=chat_id,
                message_id=mid,
                text=text,
                parse_mode="HTML",
                reply_markup=kb
            )
        else:
            msg = bot.send_message(chat_id, text, parse_mode="HTML", reply_markup=kb)
            set_active_window(chat_id, day_key, msg.message_id)
    except Exception as e:
        log_error(f"update_or_send_day_window: {e}")

# ---------- –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã ----------
@bot.message_handler(commands=["start", "help"])
def cmd_start(message):
    send_info(message.chat.id, "üëã –ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç.\n"
                               "–í–≤–æ–¥–∏ —Å—É–º–º—É –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –Ω–∞–ø—Ä–∏–º–µ—Ä:\n"
                               "`+1000 –µ–¥–∞` –∏–ª–∏ `-500 –∫–æ—Ñ–µ`.\n"
                               "–ö–æ–º–∞–Ω–¥—ã: /prev /next /csv /balance /report")

@bot.message_handler(commands=["csv"])
def cmd_csv(message):
    chat_id = message.chat.id
    export_to_csv(data)
    save_chat_json(chat_id, data)
    export_path = chat_csv_file(chat_id)
    upload_to_gdrive(export_path)
    send_backup_to_channel()
    if os.path.exists(export_path):
        with open(export_path, "rb") as f:
            bot.send_document(chat_id, f, caption="üìÑ CSV-—Ñ–∞–π–ª —ç—Ç–æ–≥–æ —á–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Drive –∏ –∫–∞–Ω–∞–ª.")
    else:
        send_temp_message(chat_id, "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å CSV.")

@bot.message_handler(commands=["balance"])
def cmd_balance(message):
    chat_id = message.chat.id
    store = get_chat_store(chat_id)
    send_info(chat_id, f"üí∞ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {fmt_num(store.get('balance', 0))} ARS")

@bot.message_handler(commands=["reset"])
def cmd_reset(message):
    chat_id = message.chat.id
    bot.send_message(chat_id, "‚ùó –£–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?", reply_markup=build_reset_confirm_keyboard(today_key()))

@bot.message_handler(commands=["prev"])
def cmd_prev(message):
    chat_id = message.chat.id
    cur = get_current_view_day(chat_id)
    prev_day = shift_date_key(cur, -1)
    set_current_view_day(chat_id, prev_day)
    update_or_send_day_window(chat_id, prev_day)

@bot.message_handler(commands=["next"])
def cmd_next(message):
    chat_id = message.chat.id
    cur = get_current_view_day(chat_id)
    next_day = shift_date_key(cur, 1)
    set_current_view_day(chat_id, next_day)
    update_or_send_day_window(chat_id, next_day)

@bot.message_handler(func=lambda m: re.search(r"^[+-]?\s*\d+", m.text or ""))
def any_amount_input(message):
    add_record_to_chat(message.chat.id, message.text, owner=message.from_user.id)

#‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢–í–æ—Ç –∑–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–∞—è –ß–ê–°–¢–¨ 4 / 4‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢
# ---------- –û–±—Ä–∞–±–æ—Ç–∫–∞ callback-–∫–Ω–æ–ø–æ–∫ ----------
@bot.callback_query_handler(func=lambda c: c.data.startswith("d:"))
def process_day_callback(call):
    try:
        _, day_key, action, *extra = call.data.split(":")
    except ValueError:
        return

    chat_id = call.message.chat.id

    if action == "open" or action == "calopen":
        set_current_view_day(chat_id, day_key)
        update_or_send_day_window(chat_id, day_key)

    elif action == "balance":
        store = get_chat_store(chat_id)
        send_info(chat_id, f"üí∞ –ë–∞–ª–∞–Ω—Å: {fmt_num(store.get('balance', 0))} ARS")

    elif action == "refresh":
        update_or_send_day_window(chat_id, day_key)

    elif action == "edit_menu":
        bot.edit_message_text(
            "‚úèÔ∏è –ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:",
            chat_id=chat_id,
            message_id=call.message.message_id,
            reply_markup=build_edit_menu_keyboard(day_key, chat_id)
        )

    elif action == "csv_all":
        export_to_csv(data)
        upload_to_gdrive(CSV_FILE)
        send_backup_to_channel()
        if os.path.exists(CSV_FILE):
            with open(CSV_FILE, "rb") as f:
                bot.send_document(chat_id, f, caption="üìÇ –û–±—â–∏–π CSV —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∏ –≤—ã–≥—Ä—É–∂–µ–Ω –≤ Drive/–∫–∞–Ω–∞–ª.")

    elif action == "csv_day":
        path = chat_csv_file(chat_id)
        export_to_csv(data)
        upload_to_gdrive(path)
        send_backup_to_channel()
        if os.path.exists(path):
            with open(path, "rb") as f:
                bot.send_document(chat_id, f, caption=f"üìÖ CSV –∑–∞ {day_key} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Drive/–∫–∞–Ω–∞–ª.")

    elif action == "reset":
        bot.edit_message_text(
            "‚ùó –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏?",
            chat_id=chat_id,
            message_id=call.message.message_id,
            reply_markup=build_reset_confirm_keyboard(day_key)
        )

    elif action == "confirm_reset_all":
        reset_all_records(chat_id)
        send_info(chat_id, "‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω—É–ª–µ–Ω—ã.")

    elif action == "cancel_reset_all":
        update_or_send_day_window(chat_id, day_key)

    elif action == "back_main":
        update_or_send_day_window(chat_id, day_key)

    elif action == "info":
        send_info(chat_id, "‚ÑπÔ∏è –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –±–æ—Ç 9.8.6-fo_6+GDriveOnly-perChat\n"
                           "–ö–∞–∂–¥—ã–π —á–∞—Ç –∏–º–µ–µ—Ç —Å–≤–æ–π JSON –∏ CSV.\n"
                           "–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ä–∞–∑—É –±—ç–∫–∞–ø—è—Ç—Å—è –≤ Drive –∏ –∫–∞–Ω–∞–ª.\n"
                           "–ö–æ–º–∞–Ω–¥—ã: /prev /next /csv /balance /reset /report")

# ---------- Keep-alive ----------
def keep_alive_loop():
    while True:
        try:
            if APP_URL:
                requests.get(APP_URL)
            if KEEP_ALIVE_SEND_TO_OWNER and OWNER_ID:
                bot.send_chat_action(int(OWNER_ID), "typing")
            log_info("üåê Keep-alive ping OK")
        except Exception as e:
            log_error(f"keep_alive_loop: {e}")
        time.sleep(KEEP_ALIVE_INTERVAL_SECONDS)

threading.Thread(target=keep_alive_loop, daemon=True).start()

# ---------- Flask webhook ----------
@app.route("/" + TOKEN, methods=["POST"])
def webhook_post():
    update = telebot.types.Update.de_json(request.stream.read().decode("utf-8"))
    bot.process_new_updates([update])
    return "OK", 200

@app.route("/")
def webhook_root():
    return f"‚úÖ BOT {VERSION} RUNNING", 200

# ---------- –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ ----------
if __name__ == "__main__":
    try:
        bot.delete_webhook()
        time.sleep(2)
        bot.set_webhook(url=f"{APP_URL}/{TOKEN}")
        log_info("üåç Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
    except Exception as e:
        log_error(f"set_webhook: {e}")

    try:
        app.run(host="0.0.0.0", port=PORT)
    except Exception as e:
        log_error(f"Flask run: {e}")