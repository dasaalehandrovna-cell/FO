# ============================================
# Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ¾Ñ‚ â€” Ğ²ĞµÑ€ÑĞ¸Ñ 9.8.3
# Ğ˜Ğ·Ğ¼ĞµĞ½Ñ‘Ğ½: Ğ¾Ğ±Ğ½ÑƒĞ»ĞµĞ½Ğ¸Ğµ Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ, inline-Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, Ñ„Ğ¾Ñ€Ğ²Ğ°Ñ€Ğ´ ĞºĞ½Ğ¾Ğ¿ĞºĞ°
# ID Ğ² Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸: Code_001
# ============================================

import os
import json
import csv
import logging
import re
import threading
import time
from datetime import datetime
from zoneinfo import ZoneInfo

import telebot
from flask import Flask, request
from telebot import types

TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")
APP_URL = os.getenv("APP_URL", "https://yourapp.onrender.com")
TZ = ZoneInfo("America/Argentina/Catamarca")
DATA_FILE = "data.json"
CSV_FILE = "data.csv"
LOG_FILE = "log.txt"
PORT = int(os.environ.get("PORT", 5000))
VERSION = "9.8.3"

if not TOKEN:
Â Â Â Â raise ValueError("BOT_TOKEN Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½!")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# -----------------------------
# ĞĞ²Ñ‚Ğ¾ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
# -----------------------------
def schedule_auto_delete(chat_id, message_id, delay=30):
Â Â Â Â """Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· delay ÑĞµĞºÑƒĞ½Ğ´ (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ 30)."""
Â Â Â Â def delete_later():
Â Â Â Â Â Â Â Â time.sleep(delay)
Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â bot.delete_message(chat_id, message_id)
Â Â Â Â Â Â Â Â except Exception:
Â Â Â Â Â Â Â Â Â Â Â Â pass
Â Â Â Â threading.Thread(target=delete_later, daemon=True).start()

# -----------------------------
# Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
# -----------------------------
logging.basicConfig(
Â Â Â Â level=logging.INFO,
Â Â Â Â format="[{asctime}] {levelname}: {message}",
Â Â Â Â style="{",
Â Â Â Â handlers=[logging.FileHandler(LOG_FILE, encoding="utf-8"), logging.StreamHandler()]
)

def log_info(msg):
Â Â Â Â logging.info(msg)
def log_error(msg):
Â Â Â Â logging.error(msg)

log_info(f"Ğ¡Ñ‚Ğ°Ñ€Ñ‚ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ. Ğ’ĞµÑ€ÑĞ¸Ñ {VERSION}")

# -----------------------------
# Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸ IO
# -----------------------------
def default_data():
Â Â Â Â return {
Â Â Â Â Â Â Â Â "overall_balance": 0,
Â Â Â Â Â Â Â Â "records": [],
Â Â Â Â Â Â Â Â "chats": {},
Â Â Â Â Â Â Â Â "active_messages": {},
Â Â Â Â Â Â Â Â "processed_messages": [],
Â Â Â Â Â Â Â Â "forward_targets": [],Â  Â  # Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ„Ğ¾Ñ€Ğ²Ğ°Ñ€Ğ´ Ñ†ĞµĞ»Ğ¸ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ OWNER_ID)
Â Â Â Â Â Â Â Â "tracked_messages": {},
Â Â Â Â Â Â Â Â "next_id": 1
Â Â Â Â }

def load_data():
Â Â Â Â if os.path.exists(DATA_FILE):
Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â with open(DATA_FILE, "r", encoding="utf-8") as f:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â d = json.load(f)
Â Â Â Â Â Â Â Â except:
Â Â Â Â Â Â Â Â Â Â Â Â d = default_data()
Â Â Â Â else:
Â Â Â Â Â Â Â Â d = default_data()
Â Â Â Â base = default_data()
Â Â Â Â for k, v in base.items():
Â Â Â Â Â Â Â Â if k not in d:
Â Â Â Â Â Â Â Â Â Â Â Â d[k] = v
Â Â Â Â return d

def save_data(d):
Â Â Â Â try:
Â Â Â Â Â Â Â Â with open(DATA_FILE, "w", encoding="utf-8") as f:
Â Â Â Â Â Â Â Â Â Â Â Â json.dump(d, f, ensure_ascii=False, indent=2)
Â Â Â Â except Exception as e:
Â Â Â Â Â Â Â Â log_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ data.json: {e}")

data = load_data()

if OWNER_ID:
Â Â Â Â try:
Â Â Â Â Â Â Â Â oi = int(OWNER_ID)
Â Â Â Â Â Â Â Â if oi not in data.get("forward_targets", []):
Â Â Â Â Â Â Â Â Â Â Â Â data["forward_targets"].append(oi)
Â Â Â Â Â Â Â Â Â Â Â Â save_data(data)
Â Â Â Â except Exception:
Â Â Â Â Â Â Â Â pass

# -----------------------------
# Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ
# -----------------------------
def get_today_key():
Â Â Â Â return datetime.now(TZ).strftime("%Y-%m-%d")

def get_chat_store(chat_id):
Â Â Â Â cid = str(chat_id)
Â Â Â Â if cid not in data["chats"]:
Â Â Â Â Â Â Â Â data["chats"][cid] = {
Â Â Â Â Â Â Â Â Â Â Â Â "balance": 0,
Â Â Â Â Â Â Â Â Â Â Â Â "records": [],
Â Â Â Â Â Â Â Â Â Â Â Â "next_id": 1,
Â Â Â Â Â Â Â Â Â Â Â Â "daily_records": {},
Â Â Â Â Â Â Â Â Â Â Â Â "active_windows": {},
Â Â Â Â Â Â Â Â Â Â Â Â "edit_wait": None,
Â Â Â Â Â Â Â Â Â Â Â Â "edit_target": None,
Â Â Â Â Â Â Â Â Â Â Â Â "forward_enabled": FalseÂ  # per-chat toggle for forwarding
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â save_data(data)
Â Â Â Â return data["chats"][cid]

def set_today_active_window(chat_id, message_id):
Â Â Â Â today = get_today_key()
Â Â Â Â if "active_messages" not in data:
Â Â Â Â Â Â Â Â data["active_messages"] = {}
Â Â Â Â if today not in data["active_messages"]:
Â Â Â Â Â Â Â Â data["active_messages"][today] = {}
Â Â Â Â data["active_messages"][today][str(chat_id)] = message_id
Â Â Â Â save_data(data)

# -----------------------------
# Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑĞ¼Ğ¸
# -----------------------------
def add_record_to_chat(chat_id, amount, note, owner):
Â Â Â Â store = get_chat_store(chat_id)
Â Â Â Â rid = data.get("next_id", 1)
Â Â Â Â rec = {"id": rid, "short_id": f"R{rid}", "timestamp": datetime.now(TZ).isoformat(timespec="seconds"), "amount": amount, "note": note, "owner": owner}
Â Â Â Â data.setdefault("records", []).append(rec)
Â Â Â Â store.setdefault("records", []).append(rec)
Â Â Â Â day = get_today_key()
Â Â Â Â store.setdefault("daily_records", {}).setdefault(day, []).append(rec)
Â Â Â Â store["balance"] = store.get("balance", 0) + amount
Â Â Â Â data["overall_balance"] = data.get("overall_balance", 0) + amount
Â Â Â Â data["next_id"] = rid + 1
Â Â Â Â save_data(data)
Â Â Â Â try:
Â Â Â Â Â Â Â Â export_to_csv(data)
Â Â Â Â except:
Â Â Â Â Â Â Â Â pass

Â Â Â Â # Ğ¤Ğ¾Ñ€Ğ²Ğ°Ñ€Ğ´ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ñƒ, ĞµÑĞ»Ğ¸ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾
Â Â Â Â try:
Â Â Â Â Â Â Â Â if store.get("forward_enabled") and OWNER_ID:
Â Â Â Â Â Â Â Â Â Â Â Â bot.send_message(int(OWNER_ID), f"ĞŸĞµÑ€ĞµÑÑ‹Ğ»ĞºĞ° Ğ¸Ğ· Ñ‡Ğ°Ñ‚Ğ° {chat_id}: {rec['short_id']} {rec['amount']} â€” {rec['note']}")
Â Â Â Â except Exception as e:
Â Â Â Â Â Â Â Â log_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿ĞµÑ€ĞµÑÑ‹Ğ»ĞºĞ¸ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸: {e}")

Â Â Â Â return rec

def update_record_in_chat(chat_id, rid, new_amount, new_note, user=None):
Â Â Â Â store = get_chat_store(chat_id)
Â Â Â Â found = None
Â Â Â Â for r in store.get("records", []):
Â Â Â Â Â Â Â Â if r["id"] == rid:
Â Â Â Â Â Â Â Â Â Â Â Â old = r.copy()
Â Â Â Â Â Â Â Â Â Â Â Â r["amount"] = new_amount
Â Â Â Â Â Â Â Â Â Â Â Â r["note"] = new_note
Â Â Â Â Â Â Â Â Â Â Â Â found = r
Â Â Â Â Â Â Â Â Â Â Â Â break
Â Â Â Â if found:
Â Â Â Â Â Â Â Â for day_recs in store.get("daily_records", {}).values():
Â Â Â Â Â Â Â Â Â Â Â Â for r in day_recs:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if r["id"] == rid:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â r.update(found)
Â Â Â Â Â Â Â Â store["balance"] = sum([x["amount"] for x in store.get("records", [])])
Â Â Â Â Â Â Â Â data["overall_balance"] = sum([x["amount"] for x in data.get("records", [])])
Â Â Â Â Â Â Â Â save_data(data)
Â Â Â Â Â Â Â Â export_to_csv(data)
Â Â Â Â Â Â Â Â # Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
Â Â Â Â Â Â Â Â user_repr = f"{user.id}/{user.username}" if user else "unknown"
Â Â Â Â Â Â Â Â log_info(f"Edit by {user_repr}: R{rid} -> amount={new_amount}, note='{new_note}'")
Â Â Â Â Â Â Â Â return True, found
Â Â Â Â return False, None

def delete_record_in_chat(chat_id, rid, user=None):
Â Â Â Â store = get_chat_store(chat_id)
Â Â Â Â removed = None
Â Â Â Â for r in list(store.get("records", [])):
Â Â Â Â Â Â Â Â if r["id"] == rid or str(r["id"]) == str(rid) or r.get("short_id") == f"R{rid}":
Â Â Â Â Â Â Â Â Â Â Â Â removed = r
Â Â Â Â Â Â Â Â Â Â Â Â store["records"].remove(r)
Â Â Â Â Â Â Â Â Â Â Â Â break
Â Â Â Â if removed:
Â Â Â Â Â Â Â Â for day_key, recs in store.get("daily_records", {}).items():
Â Â Â Â Â Â Â Â Â Â Â Â store["daily_records"][day_key] = [x for x in recs if x["id"] != rid]
Â Â Â Â Â Â Â Â store["balance"] = sum([x["amount"] for x in store.get("records", [])])
Â Â Â Â Â Â Â Â data["records"] = [x for x in data.get("records", []) if x["id"] != rid]
Â Â Â Â Â Â Â Â data["overall_balance"] = sum([x["amount"] for x in data.get("records", [])])
Â Â Â Â Â Â Â Â save_data(data)
Â Â Â Â Â Â Â Â export_to_csv(data)
Â Â Â Â Â Â Â Â user_repr = f"{user.id}/{user.username}" if user else "unknown"
Â Â Â Â Â Â Â Â log_info(f"Delete by {user_repr}: R{rid} removed")
Â Â Â Â Â Â Â Â return True, removed
Â Â Â Â return False, None

def export_to_csv(d):
Â Â Â Â try:
Â Â Â Â Â Â Â Â with open(CSV_FILE, "w", newline='', encoding="utf-8") as f:
Â Â Â Â Â Â Â Â Â Â Â Â writer = csv.writer(f)
Â Â Â Â Â Â Â Â Â Â Â Â writer.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
Â Â Â Â Â Â Â Â Â Â Â Â for cid, cdata in d.get("chats", {}).items():
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â for day_key, records in cdata.get("daily_records", {}).items():
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â for r in records:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â writer.writerow([cid, r.get("id"), r.get("short_id"), r.get("timestamp"), r.get("amount"), r.get("note"), r.get("owner"), day_key])
Â Â Â Â except Exception as e:
Â Â Â Â Â Â Â Â log_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ° CSV: {e}")

# -----------------------------
# ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñ‹
# -----------------------------
def build_main_keyboard(chat_id=None, confirm_reset=False):
Â Â Â Â kb = types.InlineKeyboardMarkup(row_width=3)
Â Â Â Â kb.row(
Â Â Â Â Â Â Â Â types.InlineKeyboardButton("ğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ", callback_data="btn_balance"),
Â Â Â Â Â Â Â Â types.InlineKeyboardButton("ğŸ“Š ĞÑ‚Ñ‡Ñ‘Ñ‚", callback_data="btn_report"),
Â Â Â Â Â Â Â Â types.InlineKeyboardButton("ğŸ“‚ CSV", callback_data="btn_csv")
Â Â Â Â )
Â Â Â Â kb.row(types.InlineKeyboardButton("âœï¸ Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ", callback_data="btn_edit_list"))
Â Â Â Â # Ñ„Ğ¾Ñ€Ğ²Ğ°Ñ€Ğ´ toggle
Â Â Â Â kb.row(types.InlineKeyboardButton("ğŸ“¨ Ğ¤Ğ¾Ñ€Ğ²Ğ°Ñ€Ğ´", callback_data="btn_toggle_forward"))
Â Â Â Â if confirm_reset:
Â Â Â Â Â Â Â Â kb.row(
Â Â Â Â Â Â Â Â Â Â Â Â types.InlineKeyboardButton("âœ… Ğ”Ğ°", callback_data="confirm_reset"),
Â Â Â Â Â Â Â Â Â Â Â Â types.InlineKeyboardButton("âŒ ĞĞµÑ‚", callback_data="cancel_reset")
Â Â Â Â Â Â Â Â )
Â Â Â Â else:
Â Â Â Â Â Â Â Â kb.row(types.InlineKeyboardButton("âš™ï¸ ĞĞ±Ğ½ÑƒĞ»Ğ¸Ñ‚ÑŒ (Ñ‡ĞµÑ€ĞµĞ· /reset)", callback_data="btn_reset"))
Â Â Â Â kb.row(
Â Â Â Â Â Â Â Â types.InlineKeyboardButton("ğŸš€ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ", callback_data="btn_start"),
Â Â Â Â Â Â Â Â types.InlineKeyboardButton("â„¹ï¸ Ğ˜Ğ½Ñ„Ğ¾", callback_data="btn_cod")
Â Â Â Â )
Â Â Â Â balance_text = ""
Â Â Â Â if chat_id is not None:
Â Â Â Â Â Â Â Â store = get_chat_store(chat_id)
Â Â Â Â Â Â Â Â balance_text = f"ğŸ’° {store.get('balance', 0)} ARS"
Â Â Â Â kb.add(types.InlineKeyboardButton(balance_text or "ğŸ’° 0 ARS", callback_data="noop"))
Â Â Â Â return kb

def build_edit_keyboard_for_record(rid):
Â Â Â Â kb = types.InlineKeyboardMarkup(row_width=2)
Â Â Â Â # Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğµ Ğ¿Ñ€ĞµÑĞµÑ‚Ñ‹ Ğ´Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ ÑÑƒĞ¼Ğ¼Ñ‹
Â Â Â Â kb.row(
Â Â Â Â Â Â Â Â types.InlineKeyboardButton("+10", callback_data=f"preset_add_{rid}_10"),
Â Â Â Â Â Â Â Â types.InlineKeyboardButton("-10", callback_data=f"preset_add_{rid}_-10")
Â Â Â Â )
Â Â Â Â kb.row(
Â Â Â Â Â Â Â Â types.InlineKeyboardButton("+100", callback_data=f"preset_add_{rid}_100"),
Â Â Â Â Â Â Â Â types.InlineKeyboardButton("-100", callback_data=f"preset_add_{rid}_-100")
Â Â Â Â )
Â Â Â Â kb.row(
Â Â Â Â Â Â Â Â types.InlineKeyboardButton("+500", callback_data=f"preset_add_{rid}_500"),
Â Â Â Â Â Â Â Â types.InlineKeyboardButton("-500", callback_data=f"preset_add_{rid}_-500")
Â Â Â Â )
Â Â Â Â kb.add(types.InlineKeyboardButton("âœ Ğ’Ğ²ĞµÑÑ‚Ğ¸ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ", callback_data=f"edit_manual_{rid}"))
Â Â Â Â kb.add(types.InlineKeyboardButton("ğŸ—‘ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ", callback_data=f"edit_delete_{rid}"))
Â Â Â Â kb.add(types.InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="edit_back_to_list"))
Â Â Â Â return kb

def build_confirm_delete_keyboard(rid):
Â Â Â Â kb = types.InlineKeyboardMarkup(row_width=2)
Â Â Â Â kb.row(types.InlineKeyboardButton("âœ… Ğ”Ğ°, ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ", callback_data=f"confirm_delete_{rid}"),
Â Â Â Â Â Â Â Â Â Â Â types.InlineKeyboardButton("âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°", callback_data="cancel_delete"))
Â Â Â Â return kb

# -----------------------------
# ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ/ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾ĞºĞ½Ğ°
# -----------------------------
def update_or_send_today_window(chat_id, create_if_missing=True):
Â Â Â Â today_key = get_today_key()
Â Â Â Â store = get_chat_store(chat_id)
Â Â Â Â day_records = store.get("daily_records", {}).get(today_key, [])

Â Â Â Â daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
Â Â Â Â daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
Â Â Â Â overall_balance = store.get("balance", 0)

Â Â Â Â if not day_records:
Â Â Â Â Â Â Â Â text = (
Â Â Â Â Â Â Â Â Â Â Â Â f"ğŸ“… {today_key}\n"
Â Â Â Â Â Â Â Â Â Â Â Â f"ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹.\n"
Â Â Â Â Â Â Â Â Â Â Â Â f"ğŸ’µ ĞŸÑ€Ğ¸Ñ…Ğ¾Ğ´: {daily_income} ARS\n"
Â Â Â Â Â Â Â Â Â Â Â Â f"ğŸ’¸ Ğ Ğ°ÑÑ…Ğ¾Ğ´: {abs(daily_expense)} ARS\n"
Â Â Â Â Â Â Â Â Â Â Â Â f"ğŸ’° ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº: {overall_balance} ARS"
Â Â Â Â Â Â Â Â )
Â Â Â Â else:
Â Â Â Â Â Â Â Â lines = [f"ğŸ“… {today_key}", "ğŸ“‹ ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸:"]
Â Â Â Â Â Â Â Â for r in day_records[-50:]:
Â Â Â Â Â Â Â Â Â Â Â Â sign = "+" if r["amount"] > 0 else "-"
Â Â Â Â Â Â Â Â Â Â Â Â lines.append(f"{r['short_id']}: {sign}{abs(r['amount'])} â€” {r.get('note','')}")
Â Â Â Â Â Â Â Â lines.append(
Â Â Â Â Â Â Â Â Â Â Â Â f"\nğŸ’µ ĞŸÑ€Ğ¸Ñ…Ğ¾Ğ´: {daily_income} ARS\n"
Â Â Â Â Â Â Â Â Â Â Â Â f"ğŸ’¸ Ğ Ğ°ÑÑ…Ğ¾Ğ´: {abs(daily_expense)} ARS\n"
Â Â Â Â Â Â Â Â Â Â Â Â f"ğŸ’° ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº: {overall_balance} ARS"
Â Â Â Â Â Â Â Â )
Â Â Â Â Â Â Â Â text = "\n".join(lines)

Â Â Â Â kb = build_main_keyboard(chat_id)
Â Â Â Â today_msgs = data.setdefault("active_messages", {}).setdefault(get_today_key(), {})
Â Â Â Â active_id = today_msgs.get(str(chat_id))

Â Â Â Â if active_id:
Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
Â Â Â Â Â Â Â Â except telebot.apihelper.ApiException as e:
Â Â Â Â Â Â Â Â Â Â Â Â log_error(f"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¾ĞºĞ½Ğ¾ {active_id} Ğ´Ğ»Ñ Ñ‡Ğ°Ñ‚Ğ° {chat_id}: {e}")
Â Â Â Â Â Â Â Â return

Â Â Â Â if not create_if_missing:
Â Â Â Â Â Â Â Â return

Â Â Â Â try:
Â Â Â Â Â Â Â Â sent = bot.send_message(chat_id, text, reply_markup=kb)
Â Â Â Â Â Â Â Â set_today_active_window(chat_id, sent.message_id)
Â Â Â Â except Exception as e:
Â Â Â Â Â Â Â Â log_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¾ĞºĞ½Ğ° Ğ´Ğ»Ñ {chat_id}: {e}")

# -----------------------------
# Callback Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº
# -----------------------------
@bot.callback_query_handler(func=lambda c: True)
def handle_callback(call):
Â Â Â Â try:
Â Â Â Â Â Â Â Â chat_id = call.message.chat.id
Â Â Â Â except Exception:
Â Â Â Â Â Â Â Â return
Â Â Â Â store = get_chat_store(chat_id)
Â Â Â Â today_key = get_today_key()
Â Â Â Â day_records = store.get("daily_records", {}).get(today_key, [])
Â Â Â Â today_msgs = data.setdefault("active_messages", {}).setdefault(today_key, {})
Â Â Â Â active_id = today_msgs.get(str(chat_id))

Â Â Â Â # Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ
Â Â Â Â if call.data == "btn_balance":
Â Â Â Â Â Â Â Â daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
Â Â Â Â Â Â Â Â daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
Â Â Â Â Â Â Â Â overall_balance = store.get("balance", 0)
Â Â Â Â Â Â Â Â text = (
Â Â Â Â Â Â Â Â Â Â Â Â f"ğŸ“… {today_key}\n\n"
Â Â Â Â Â Â Â Â Â Â Â Â f"ğŸ’° ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº: {overall_balance} ARS\n"
Â Â Â Â Â Â Â Â Â Â Â Â f"ğŸ’µ ĞŸÑ€Ğ¸Ñ…Ğ¾Ğ´ Ğ·Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ: {daily_income} ARS\n"
Â Â Â Â Â Â Â Â Â Â Â Â f"ğŸ’¸ Ğ Ğ°ÑÑ…Ğ¾Ğ´ Ğ·Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ: {abs(daily_expense)} ARS"
Â Â Â Â Â Â Â Â )
Â Â Â Â Â Â Â Â if active_id:
Â Â Â Â Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
Â Â Â Â Â Â Â Â Â Â Â Â except telebot.apihelper.ApiException as e:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â log_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¾ĞºĞ½Ğ° (Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ): {e}")
Â Â Â Â Â Â Â Â else:
Â Â Â Â Â Â Â Â Â Â Â Â update_or_send_today_window(chat_id)
Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id, "Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½ âœ…")
Â Â Â Â Â Â Â Â return

Â Â Â Â # ĞÑ‚Ñ‡Ñ‘Ñ‚
Â Â Â Â if call.data == "btn_report":
Â Â Â Â Â Â Â Â expenses = [r for r in day_records if r["amount"] < 0]
Â Â Â Â Â Â Â Â daily_expense_total = sum(abs(r["amount"]) for r in expenses)
Â Â Â Â Â Â Â Â if not expenses:
Â Â Â Â Â Â Â Â Â Â Â Â text = f"ğŸ“… {today_key}\nĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ğ¾Ğ² Ğ·Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ.\nğŸ’¸ Ğ Ğ°ÑÑ…Ğ¾Ğ´ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ: 0 ARS"
Â Â Â Â Â Â Â Â else:
Â Â Â Â Â Â Â Â Â Â Â Â lines = [f"ğŸ“… {today_key}", "ğŸ“‹ Ğ Ğ°ÑÑ…Ğ¾Ğ´Ñ‹ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ:"]
Â Â Â Â Â Â Â Â Â Â Â Â for r in expenses[-30:]:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â lines.append(f"{r['short_id']}: -{abs(r['amount'])} â€” {r.get('note','')}")
Â Â Â Â Â Â Â Â Â Â Â Â lines.append(f"\nğŸ’¸ Ğ Ğ°ÑÑ…Ğ¾Ğ´ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ: {daily_expense_total} ARS")
Â Â Â Â Â Â Â Â Â Â Â Â text = "\n".join(lines)
Â Â Â Â Â Â Â Â if active_id:
Â Â Â Â Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
Â Â Â Â Â Â Â Â Â Â Â Â except telebot.apihelper.ApiException as e:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â log_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¾ĞºĞ½Ğ° (ĞÑ‚Ñ‡Ñ‘Ñ‚ Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ğ¾Ğ²): {e}")
Â Â Â Â Â Â Â Â else:
Â Â Â Â Â Â Â Â Â Â Â Â update_or_send_today_window(chat_id)
Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id, "ĞÑ‚Ñ‡Ñ‘Ñ‚ Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ğ¾Ğ² Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½ ğŸ“Š")
Â Â Â Â Â Â Â Â return

Â Â Â Â # CSV
Â Â Â Â if call.data == "btn_csv":
Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â with open(CSV_FILE, "rb") as f:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â bot.send_document(chat_id, f, caption="ğŸ“‚ Ğ’Ğ°Ñˆ Ñ„Ğ°Ğ¹Ğ» data.csv")
Â Â Â Â Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id, "CSV Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½ ğŸ“")
Â Â Â Â Â Â Â Â except Exception as e:
Â Â Â Â Â Â Â Â Â Â Â Â bot.send_message(chat_id, f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ CSV: {e}")
Â Â Â Â Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id)
Â Â Â Â Â Â Â Â return

Â Â Â Â # Toggle forward
Â Â Â Â if call.data == "btn_toggle_forward":
Â Â Â Â Â Â Â Â store["forward_enabled"] = not store.get("forward_enabled", False)
Â Â Â Â Â Â Â Â save_data(data)
Â Â Â Â Â Â Â Â status = "Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ°" if store["forward_enabled"] else "Ğ²Ñ‹ĞºĞ»ÑÑ‡ĞµĞ½Ğ°"
Â Â Â Â Â Â Â Â update_or_send_today_window(chat_id)
Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id, f"ĞŸĞµÑ€ĞµÑÑ‹Ğ»ĞºĞ° {status}")
Â Â Â Â Â Â Â Â return

Â Â Â Â # reset button now just points to command
Â Â Â Â if call.data == "btn_reset":
Â Â Â Â Â Â Â Â if active_id:
Â Â Â Â Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â bot.edit_message_text("Ğ”Ğ»Ñ Ğ¾Ğ±Ğ½ÑƒĞ»ĞµĞ½Ğ¸Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ /reset (Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ `/reset` Ğ² Ñ‡Ğ°Ñ‚Ğµ).", chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
Â Â Â Â Â Â Â Â Â Â Â Â except:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â pass
Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id)
Â Â Â Â Â Â Â Â return

Â Â Â Â # confirm_reset (from /reset command's inline keyboard)
Â Â Â Â if call.data == "confirm_reset":
Â Â Â Â Â Â Â Â # Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ÑĞ±Ñ€Ğ¾Ñ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°
Â Â Â Â Â Â Â Â store["records"] = []
Â Â Â Â Â Â Â Â store["daily_records"] = {}
Â Â Â Â Â Â Â Â store["balance"] = 0
Â Â Â Â Â Â Â Â # ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ Ğ¸Ğ· Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ²ÑĞµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¿Ñ€Ğ¸Ğ½Ğ°Ğ´Ğ»ĞµĞ¶Ğ°Ñ‰Ğ¸Ğµ ÑÑ‚Ğ¾Ğ¼Ñƒ Ñ‡Ğ°Ñ‚Ñƒ (owner may be user id; keep simple: remove by matching owner==chat_id)
Â Â Â Â Â Â Â Â data["records"] = [x for x in data.get("records", []) if x.get("owner") != chat_id]
Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â data["overall_balance"] = sum([x["amount"] for x in data.get("records", [])])
Â Â Â Â Â Â Â Â except:
Â Â Â Â Â Â Â Â Â Â Â Â data["overall_balance"] = 0
Â Â Â Â Â Â Â Â save_data(data)
Â Â Â Â Â Â Â Â update_or_send_today_window(chat_id)
Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id, "Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ±Ñ€Ğ¾ÑˆĞµĞ½Ñ‹ ğŸ§¹")
Â Â Â Â Â Â Â Â return

Â Â Â Â if call.data == "cancel_reset":
Â Â Â Â Â Â Â Â update_or_send_today_window(chat_id)
Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id, "ĞÑ‚Ğ¼ĞµĞ½Ğ°")
Â Â Â Â Â Â Â Â return

Â Â Â Â # ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ
Â Â Â Â if call.data == "btn_start":
Â Â Â Â Â Â Â Â update_or_send_today_window(chat_id)
Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id, "ĞĞºĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ ğŸ”„")
Â Â Â Â Â Â Â Â return

Â Â Â Â # Ğ˜Ğ½Ñ„Ğ¾ (Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ² Ñ‚Ğ¾Ğ¼ Ğ¶Ğµ Ğ¾ĞºĞ½Ğµ)
Â Â Â Â if call.data == "btn_cod":
Â Â Â Â Â Â Â Â info_text = (
Â Â Â Â Â Â Â Â Â Â Â Â f"â„¹ï¸ Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ¾Ñ‚ â€” Ğ²ĞµÑ€ÑĞ¸Ñ {VERSION}\n\n"
Â Â Â Â Â Â Â Â Â Â Â Â "ğŸ“Œ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:\n"
Â Â Â Â Â Â Â Â Â Â Â Â "/start - Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ° Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾ĞºĞ½Ğ° Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ° Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ\n"
Â Â Â Â Â Â Â Â Â Â Â Â "/balance - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº Ğ·Ğ° Ğ´ĞµĞ½ÑŒ\n"
Â Â Â Â Â Â Â Â Â Â Â Â "/report - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ğ¾Ğ² Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ´Ğ½Ñ\n"
Â Â Â Â Â Â Â Â Â Â Â Â "/csv - Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ» Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸ĞµĞ¹ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹\n"
Â Â Â Â Â Â Â Â Â Â Â Â "/reset - ĞŸĞ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¾Ñ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ (Ğ¿Ğ¾ĞºĞ°Ğ¶ĞµÑ‚ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ)\n"
Â Â Â Â Â Â Â Â Â Â Â Â "/info - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑÑ‚Ğ¾ Ğ¾ĞºĞ½Ğ¾ ÑĞ¾ ÑĞ¿Ğ¸ÑĞºĞ¾Ğ¼ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´\n\n"
Â Â Â Â Â Â Â Â Â Â Â Â "ğŸ“ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ (Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‹):\n"
Â Â Â Â Â Â Â Â Â Â Â Â "+500 Ğ—Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ğ°Â  Â  (Ğ¸Ğ»Ğ¸ ^+^500^)\n"
Â Â Â Â Â Â Â Â Â Â Â Â "-150 ĞĞ±ĞµĞ´ Â  Â  Â  (Ğ¸Ğ»Ğ¸ ^-^150^)\n\n"
Â Â Â Â Â Â Â Â Â Â Â Â "âœï¸ ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Â«âœï¸ Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒÂ», Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑĞ¼Ğ¸.\n"
Â Â Â Â Â Â Â Â Â Â Â Â "ğŸ“¨ ĞšĞ½Ğ¾Ğ¿ĞºĞ° Â«Ğ¤Ğ¾Ñ€Ğ²Ğ°Ñ€Ğ´Â» Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ Ğ¿ĞµÑ€ĞµÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ñƒ."
Â Â Â Â Â Â Â Â )
Â Â Â Â Â Â Â Â if active_id:
Â Â Â Â Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â bot.edit_message_text(info_text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
Â Â Â Â Â Â Â Â Â Â Â Â except telebot.apihelper.ApiException as e:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â log_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¾ĞºĞ½Ğ° (Ğ˜Ğ½Ñ„Ğ¾): {e}")
Â Â Â Â Â Â Â Â else:
Â Â Â Â Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â sent = bot.send_message(chat_id, info_text, reply_markup=build_main_keyboard(chat_id))
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â set_today_active_window(chat_id, sent.message_id)
Â Â Â Â Â Â Â Â Â Â Â Â except Exception as e:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â log_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ¸Ğ½Ñ„Ğ¾: {e}")
Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id)
Â Â Â Â Â Â Â Â return

Â Â Â Â # Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ â€” ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹
Â Â Â Â if call.data == "btn_edit_list":
Â Â Â Â Â Â Â Â if not day_records:
Â Â Â Â Â Â Â Â Â Â Â Â text = f"ğŸ“… {today_key}\nĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ğ·Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ."
Â Â Â Â Â Â Â Â Â Â Â Â if active_id:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â except telebot.apihelper.ApiException as e:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â log_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¾ĞºĞ½Ğ° (Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ): {e}")
Â Â Â Â Â Â Â Â Â Â Â Â else:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â update_or_send_today_window(chat_id)
Â Â Â Â Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id, "ĞĞµÑ‚ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ")
Â Â Â Â Â Â Â Â Â Â Â Â return

Â Â Â Â Â Â Â Â lines = [f"ğŸ“… {today_key}", "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:"]
Â Â Â Â Â Â Â Â kb = types.InlineKeyboardMarkup(row_width=1)
Â Â Â Â Â Â Â Â for r in reversed(day_records[-20:]):
Â Â Â Â Â Â Â Â Â Â Â Â sign = "+" if r["amount"] > 0 else "-"
Â Â Â Â Â Â Â Â Â Â Â Â label = f"{r['short_id']}: {sign}{abs(r['amount'])} â€” {r.get('note','')}"
Â Â Â Â Â Â Â Â Â Â Â Â kb.add(types.InlineKeyboardButton(label, callback_data=f"rec_{r['id']}"))
Â Â Â Â Â Â Â Â kb.add(types.InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="back_to_main"))
Â Â Â Â Â Â Â Â text = "\n".join(lines)
Â Â Â Â Â Â Â Â if active_id:
Â Â Â Â Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
Â Â Â Â Â Â Â Â Â Â Â Â except telebot.apihelper.ApiException as e:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â log_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾ĞºĞ°Ğ·Ğ° ÑĞ¿Ğ¸ÑĞºĞ° Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ: {e}")
Â Â Â Â Â Â Â Â else:
Â Â Â Â Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â sent = bot.send_message(chat_id, text, reply_markup=kb)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â set_today_active_window(chat_id, sent.message_id)
Â Â Â Â Â Â Â Â Â Â Â Â except Exception as e:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â log_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑĞ¿Ğ¸ÑĞºĞ° Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ: {e}")
Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id)
Â Â Â Â Â Â Â Â return

Â Â Â Â # Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
Â Â Â Â if call.data and call.data.startswith("rec_"):
Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â rid = int(call.data.split("_",1)[1])
Â Â Â Â Â Â Â Â except:
Â Â Â Â Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id, "ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ ID")
Â Â Â Â Â Â Â Â Â Â Â Â return
Â Â Â Â Â Â Â Â rec = None
Â Â Â Â Â Â Â Â for r in day_records:
Â Â Â Â Â Â Â Â Â Â Â Â if r["id"] == rid:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â rec = r
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â break
Â Â Â Â Â Â Â Â if not rec:
Â Â Â Â Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id, "Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°")
Â Â Â Â Â Â Â Â Â Â Â Â return
Â Â Â Â Â Â Â Â sign = "+" if rec["amount"] > 0 else "-"
Â Â Â Â Â Â Â Â text = f"Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ {rec['short_id']}\n{sign}{abs(rec['amount'])} â€” {rec.get('note','')}\nĞ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ°: {rec.get('timestamp')}"
Â Â Â Â Â Â Â Â kb = build_edit_keyboard_for_record(rid)
Â Â Â Â Â Â Â Â if active_id:
Â Â Â Â Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
Â Â Â Â Â Â Â Â Â Â Â Â except telebot.apihelper.ApiException as e:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â log_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾ĞºĞ°Ğ·Ğ° Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸: {e}")
Â Â Â Â Â Â Â Â else:
Â Â Â Â Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â sent = bot.send_message(chat_id, text, reply_markup=kb)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â set_today_active_window(chat_id, sent.message_id)
Â Â Â Â Â Â Â Â Â Â Â Â except Exception as e:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â log_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸: {e}")
Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id)
Â Â Â Â Â Â Â Â return

Â Â Â Â # ĞŸÑ€ĞµÑĞµÑ‚Ñ‹ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ ÑÑƒĞ¼Ğ¼Ñ‹
Â Â Â Â if call.data and call.data.startswith("preset_add_"):
Â Â Â Â Â Â Â Â # Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ preset_add_{rid}_{delta}
Â Â Â Â Â Â Â Â parts = call.data.split("_")
Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â rid = int(parts[2])
Â Â Â Â Â Â Â Â Â Â Â Â delta = int(parts[3])
Â Â Â Â Â Â Â Â except:
Â Â Â Â Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id, "ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹")
Â Â Â Â Â Â Â Â Â Â Â Â return
Â Â Â Â Â Â Â Â # Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ
Â Â Â Â Â Â Â Â success = False
Â Â Â Â Â Â Â Â for r in store.get("records", []):
Â Â Â Â Â Â Â Â Â Â Â Â if r["id"] == rid:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â new_amount = r["amount"] + delta
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â new_note = r.get("note","")
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â user = call.from_user
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â success, _ = update_record_in_chat(chat_id, rid, new_amount, new_note, user=user)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â break
Â Â Â Â Â Â Â Â update_or_send_today_window(chat_id)
Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id, "Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°" if success else "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ")
Â Â Â Â Â Â Â Â return

Â Â Â Â # Ğ’Ğ²Ğ¾Ğ´ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ (Ñ„Ğ¾Ğ»Ğ»Ğ±ÑĞº) â€” Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼ Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ñ Ğ²Ğ²Ğ¾Ğ´Ğ°
Â Â Â Â if call.data and call.data.startswith("edit_manual_"):
Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â rid = int(call.data.split("_",2)[2])
Â Â Â Â Â Â Â Â except:
Â Â Â Â Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id, "ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ ID")
Â Â Â Â Â Â Â Â Â Â Â Â return
Â Â Â Â Â Â Â Â store["edit_wait"] = "change_value"
Â Â Â Â Â Â Â Â store["edit_target"] = rid
Â Â Â Â Â Â Â Â save_data(data)
Â Â Â Â Â Â Â Â bot.send_message(chat_id, f"Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²ÑƒÑ ÑÑƒĞ¼Ğ¼Ñƒ Ğ¸ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºÑƒ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ R{rid} Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ:\n+500 Ğ—Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ğ°Â  Ğ¸Ğ»Ğ¸Â  ^+^500^ Ğ—Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ğ°Â  Ğ¸Ğ»Ğ¸Â  ^-^150^ ĞĞ±ĞµĞ´")
Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id)
Â Â Â Â Â Â Â Â return

Â Â Â Â # Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ (Ğ¿Ğ¾ĞºĞ°Ğ· Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ)
Â Â Â Â if call.data and call.data.startswith("edit_delete_"):
Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â rid = int(call.data.split("_",2)[2])
Â Â Â Â Â Â Â Â except:
Â Â Â Â Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id, "ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ ID")
Â Â Â Â Â Â Â Â Â Â Â Â return
Â Â Â Â Â Â Â Â if active_id:
Â Â Â Â Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â bot.edit_message_text(f"ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ R{rid}:", chat_id, active_id, reply_markup=build_confirm_delete_keyboard(rid))
Â Â Â Â Â Â Â Â Â Â Â Â except telebot.apihelper.ApiException as e:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â log_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾ĞºĞ°Ğ·Ğ° Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ: {e}")
Â Â Â Â Â Â Â Â else:
Â Â Â Â Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â sent = bot.send_message(chat_id, f"ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ R{rid}:", reply_markup=build_confirm_delete_keyboard(rid))
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â set_today_active_window(chat_id, sent.message_id)
Â Â Â Â Â Â Â Â Â Â Â Â except Exception as e:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â log_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ: {e}")
Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id)
Â Â Â Â Â Â Â Â return

Â Â Â Â # ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ğ»Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ
Â Â Â Â if call.data and call.data.startswith("confirm_delete_"):
Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â rid = int(call.data.split("_",2)[2])
Â Â Â Â Â Â Â Â except:
Â Â Â Â Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id, "ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ ID")
Â Â Â Â Â Â Â Â Â Â Â Â return
Â Â Â Â Â Â Â Â success, _ = delete_record_in_chat(chat_id, rid, user=call.from_user)
Â Â Â Â Â Â Â Â update_or_send_today_window(chat_id)
Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id, "Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°" if success else "Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°")
Â Â Â Â Â Â Â Â return

Â Â Â Â if call.data == "cancel_delete":
Â Â Â Â Â Â Â Â update_or_send_today_window(chat_id)
Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id, "ĞÑ‚Ğ¼ĞµĞ½Ğ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ")
Â Â Â Â Â Â Â Â return

Â Â Â Â if call.data in ("back_to_main", "edit_back_to_list", "edit_back"):
Â Â Â Â Â Â Â Â update_or_send_today_window(chat_id)
Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id)
Â Â Â Â Â Â Â Â return

Â Â Â Â if call.data == "noop":
Â Â Â Â Â Â Â Â bot.answer_callback_query(call.id)
Â Â Â Â Â Â Â Â return

Â Â Â Â bot.answer_callback_query(call.id)
Â Â Â Â return

# -----------------------------
# Regex Ğ´Ğ»Ñ ÑÑƒĞ¼Ğ¼: Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµĞ¼ +500, -150 Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‹ ^+^500^ Ğ¸Ğ»Ğ¸ ^-^150^
# -----------------------------
num_re = re.compile(r'(\^?[+-]?\^?\s*\d+\^?|\^[+-]\^[\d]+|\+?-?\d+)')

def parse_amount_token(token:str):
Â Â Â Â t = token.strip()
Â Â Â Â # Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¾Ğ² ^+^500^ Ğ¸Ğ»Ğ¸ ^-^150^ Ğ¸Ğ»Ğ¸ +500 / -150 / 200
Â Â Â Â # ÑƒĞ±ĞµÑ€Ñ‘Ğ¼ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹ ^ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ
Â Â Â Â t = t.replace("^", "")
Â Â Â Â t = t.replace(" ", "")
Â Â Â Â if t.startswith("+"):
Â Â Â Â Â Â Â Â return int(t[1:])
Â Â Â Â if t.startswith("-"):
Â Â Â Â Â Â Â Â return -int(t[1:])
Â Â Â Â # ĞµÑĞ»Ğ¸ Ğ±ĞµĞ· Ğ·Ğ½Ğ°ĞºĞ° â€” ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ñ€Ğ°ÑÑ…Ğ¾Ğ´ (ĞºĞ°Ğº Ñƒ Ñ‚ĞµĞ±Ñ Ğ² ĞºĞ¾Ğ´Ğµ)
Â Â Â Â return -int(t)

# -----------------------------
# Ğ’Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹
# -----------------------------
@bot.message_handler(commands=["start", "info"])
def cmd_start(msg):
Â Â Â Â chat_id = msg.chat.id
Â Â Â Â update_or_send_today_window(chat_id, create_if_missing=True)

@bot.message_handler(commands=["balance"])
def cmd_balance(msg):
Â Â Â Â chat_id = msg.chat.id
Â Â Â Â store = get_chat_store(chat_id)
Â Â Â Â today_key = get_today_key()
Â Â Â Â day_records = store.get("daily_records", {}).get(today_key, [])
Â Â Â Â daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
Â Â Â Â daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
Â Â Â Â overall_balance = store.get("balance", 0)
Â Â Â Â text = (
Â Â Â Â Â Â Â Â f"ğŸ“… {today_key}\n\n"
Â Â Â Â Â Â Â Â f"ğŸ’° ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº: {overall_balance} ARS\n"
Â Â Â Â Â Â Â Â f"ğŸ’µ ĞŸÑ€Ğ¸Ñ…Ğ¾Ğ´ Ğ·Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ: {daily_income} ARS\n"
Â Â Â Â Â Â Â Â f"ğŸ’¸ Ğ Ğ°ÑÑ…Ğ¾Ğ´ Ğ·Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ: {abs(daily_expense)} ARS"
Â Â Â Â )
Â Â Â Â bot.send_message(chat_id, text)

@bot.message_handler(commands=["report"])
def cmd_report(msg):
Â Â Â Â chat_id = msg.chat.id
Â Â Â Â store = get_chat_store(chat_id)
Â Â Â Â today_key = get_today_key()
Â Â Â Â day_records = store.get("daily_records", {}).get(today_key, [])
Â Â Â Â expenses = [r for r in day_records if r["amount"] < 0]
Â Â Â Â if not expenses:
Â Â Â Â Â Â Â Â bot.send_message(chat_id, f"ğŸ“… {today_key}\nĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ğ¾Ğ² Ğ·Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ.\nğŸ’¸ Ğ Ğ°ÑÑ…Ğ¾Ğ´ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ: 0 ARS")
Â Â Â Â Â Â Â Â return
Â Â Â Â lines = [f"ğŸ“… {today_key}", "ğŸ“‹ Ğ Ğ°ÑÑ…Ğ¾Ğ´Ñ‹ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ:"]
Â Â Â Â for r in expenses[-30:]:
Â Â Â Â Â Â Â Â lines.append(f"{r['short_id']}: -{abs(r['amount'])} â€” {r.get('note','')}")
Â Â Â Â lines.append(f"\nğŸ’¸ Ğ Ğ°ÑÑ…Ğ¾Ğ´ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ: {sum(abs(r['amount']) for r in expenses)} ARS")
Â Â Â Â bot.send_message(chat_id, "\n".join(lines))

@bot.message_handler(commands=["csv"])
def cmd_csv(msg):
Â Â Â Â chat_id = msg.chat.id
Â Â Â Â try:
Â Â Â Â Â Â Â Â with open(CSV_FILE, "rb") as f:
Â Â Â Â Â Â Â Â Â Â Â Â bot.send_document(chat_id, f, caption="ğŸ“‚ Ğ’Ğ°Ñˆ Ñ„Ğ°Ğ¹Ğ» data.csv")
Â Â Â Â except Exception as e:
Â Â Â Â Â Â Â Â bot.send_message(chat_id, f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ CSV: {e}")

@bot.message_handler(commands=["reset"])
def cmd_reset(msg):
Â Â Â Â chat_id = msg.chat.id
Â Â Â Â # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ² Ğ²Ğ¸Ğ´Ğµ inline-ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº
Â Â Â Â kb = types.InlineKeyboardMarkup(row_width=2)
Â Â Â Â kb.row(types.InlineKeyboardButton("âœ… Ğ”Ğ°, Ğ¾Ğ±Ğ½ÑƒĞ»Ğ¸Ñ‚ÑŒ", callback_data="confirm_reset"),
Â Â Â Â Â Â Â Â Â Â Â types.InlineKeyboardButton("âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°", callback_data="cancel_reset"))
Â Â Â Â bot.send_message(chat_id, "âš ï¸ Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ¾Ğ±Ğ½ÑƒĞ»Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ°? Ğ­Ñ‚Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ.", reply_markup=kb)

# ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
@bot.message_handler(func=lambda m: True)
def handle_message(msg):
Â Â Â Â chat_id = msg.chat.id
Â Â Â Â store = get_chat_store(chat_id)
Â Â Â Â wait_action = store.get("edit_wait")

Â Â Â Â # Ğ•ÑĞ»Ğ¸ Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµĞ¼ Ğ²Ğ²Ğ¾Ğ´ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
Â Â Â Â if wait_action == "change_value":
Â Â Â Â Â Â Â Â rid = store.get("edit_target")
Â Â Â Â Â Â Â Â if not rid:
Â Â Â Â Â Â Â Â Â Â Â Â store["edit_wait"] = None
Â Â Â Â Â Â Â Â Â Â Â Â store["edit_target"] = None
Â Â Â Â Â Â Â Â Â Â Â Â save_data(data)
Â Â Â Â Â Â Â Â Â Â Â Â return
Â Â Â Â Â Â Â Â parts = msg.text.strip().split(" ", 1)
Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â amount_token = parts[0]
Â Â Â Â Â Â Â Â Â Â Â Â amount = parse_amount_token(amount_token)
Â Â Â Â Â Â Â Â Â Â Â Â note = parts[1] if len(parts) > 1 else ""
Â Â Â Â Â Â Â Â Â Â Â Â success, _ = update_record_in_chat(chat_id, rid, amount, note, user=msg.from_user)
Â Â Â Â Â Â Â Â Â Â Â Â store["edit_wait"] = None
Â Â Â Â Â Â Â Â Â Â Â Â store["edit_target"] = None
Â Â Â Â Â Â Â Â Â Â Â Â save_data(data)
Â Â Â Â Â Â Â Â Â Â Â Â update_or_send_today_window(chat_id)
Â Â Â Â Â Â Â Â Â Â Â Â bot.send_message(chat_id, f"âœ… Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ R{rid} {'Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ°' if success else 'Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°'}")
Â Â Â Â Â Â Â Â except Exception as e:
Â Â Â Â Â Â Â Â Â Â Â Â log_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ: {e}")
Â Â Â Â Â Â Â Â Â Â Â Â bot.send_message(chat_id, "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ²Ğ²Ğ¾Ğ´Ğµ ÑÑƒĞ¼Ğ¼Ñ‹. Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ +500 Ğ—Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ğ° Ğ¸Ğ»Ğ¸ ^+^500^ Ğ—Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ğ° Ğ¸Ğ»Ğ¸ ^-^150^ ĞĞ±ĞµĞ´")
Â Â Â Â Â Â Â Â return

Â Â Â Â # ĞĞ±Ñ‹Ñ‡Ğ½Ğ¾Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸. ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ñ‚Ğ¾ĞºĞµĞ½ Ñ ÑÑƒĞ¼Ğ¼Ğ¾Ğ¹.
Â Â Â Â if not msg.text:
Â Â Â Â Â Â Â Â return
Â Â Â Â # ĞĞ°Ğ¹Ğ´Ñ‘Ğ¼ Ğ¿ĞµÑ€Ğ²Ğ¾Ğµ Ğ²Ñ…Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ñ‡Ğ¸ÑĞ»Ğ° (Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµĞ¼ ^+^ / ^-^)
Â Â Â Â m = re.search(r'(\^[+-]\^[0-9]+|\^[+-]?[0-9]+\^|[+-]?\s*\d+)', msg.text)
Â Â Â Â if m:
Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â raw = m.group(0)
Â Â Â Â Â Â Â Â Â Â Â Â # Ğ¾Ñ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ²Ñ€Ğ¾Ğ´Ğµ ^+^500^ Ğ¸Ğ»Ğ¸ ^+500^ etc.
Â Â Â Â Â Â Â Â Â Â Â Â raw_clean = raw.replace("^", "").replace(" ", "")
Â Â Â Â Â Â Â Â Â Â Â Â amount = parse_amount_token(raw_clean)
Â Â Â Â Â Â Â Â Â Â Â Â note = msg.text.replace(m.group(0), "").strip()
Â Â Â Â Â Â Â Â Â Â Â Â add_record_to_chat(chat_id, amount, note, msg.from_user.id)
Â Â Â Â Â Â Â Â Â Â Â Â update_or_send_today_window(chat_id)
Â Â Â Â Â Â Â Â except Exception as e:
Â Â Â Â Â Â Â Â Â Â Â Â log_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ°Ğ²Ñ‚Ğ¾-Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸: {e}")
Â Â Â Â return

# -----------------------------
# Flask webhook
# -----------------------------
@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
Â Â Â Â update = telebot.types.Update.de_json(request.get_data().decode("utf-8"))
Â Â Â Â bot.process_new_updates([update])
Â Â Â Â return "OK", 200

@app.route("/", methods=["GET"])
def index():
Â Â Â Â return f"Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ¾Ñ‚ Â«Ğ¤ĞÂ» â€” Ğ²ĞµÑ€ÑĞ¸Ñ {VERSION} Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚", 200

# -----------------------------
# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° webhook Ğ¸ Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ñ‰Ğ¸Ğº
# -----------------------------
def set_webhook():
Â Â Â Â url = f"{APP_URL}/{TOKEN}"
Â Â Â Â try:
Â Â Â Â Â Â Â Â bot.remove_webhook()
Â Â Â Â Â Â Â Â time.sleep(0.5)
Â Â Â Â Â Â Â Â bot.set_webhook(url=url)
Â Â Â Â Â Â Â Â log_info(f"Webhook ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½: {url}")
Â Â Â Â except Exception as e:
Â Â Â Â Â Â Â Â log_error(f"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ webhook: {e}")

def schedule_daily_window_creation():
Â Â Â Â def task():
Â Â Â Â Â Â Â Â last_day = get_today_key()
Â Â Â Â Â Â Â Â while True:
Â Â Â Â Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â time.sleep(60)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â current_day = get_today_key()
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if current_day != last_day:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â for chat_id_str in list(data.get("chats", {}).keys()):
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â chat_id = int(chat_id_str)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â except:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â continue
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â try:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â update_or_send_today_window(chat_id)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â except Exception as e:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â log_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ¾ĞºĞ½Ğ° Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ Ğ´Ğ»Ñ {chat_id}: {e}")
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â last_day = current_day
Â Â Â Â Â Â Â Â Â Â Â Â except Exception as e:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â log_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² daily loop: {e}")
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â time.sleep(5)
Â Â Â Â thread = threading.Thread(target=task, daemon=True)
Â Â Â Â thread.start()

# -----------------------------
# Ğ—Ğ°Ğ¿ÑƒÑĞº
# -----------------------------
if __name__ == "__main__":
Â Â Â Â set_webhook()
Â Â Â Â schedule_daily_window_creation()
Â Â Â Â log_info(f"Ğ‘Ğ¾Ñ‚ Ğ¤Ğ Ğ²ĞµÑ€ÑĞ¸Ğ¸ {VERSION} Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½")
Â Â Â Â try:
Â Â Â Â Â Â Â Â if OWNER_ID:
Â Â Â Â Â Â Â Â Â Â Â Â bot.send_message(int(OWNER_ID), f"âœ… Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ğ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚! (Ğ²ĞµÑ€ÑĞ¸Ñ {VERSION})")
Â Â Â Â except Exception as e:
Â Â Â Â Â Â Â Â log_error(f"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ: {e}")
Â Â Â Â app.run(host="0.0.0.0", port=PORT)

