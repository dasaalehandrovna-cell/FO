# ============================================
# Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð±Ð¾Ñ‚ â€” Ð²ÐµÑ€ÑÐ¸Ñ 9.8.2
# ÐŸÐ¾Ð»Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ Ñ Ð¾Ð´Ð½Ð¸Ð¼ Ð¾ÐºÐ½Ð¾Ð¼ Ð¸ CSV
# ============================================
# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 1 â€” Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ñ‹ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
# -----------------------------
import os
import json
import csv
import logging
import re
import threading
import time
from datetime import datetime
from zoneinfo import ZoneInfo

import telebot
from flask import Flask, request
from telebot import types

TOKEN = os.getenv("BOT_TOKEN")
OWNER_ID = os.getenv("OWNER_ID")
APP_URL = os.getenv("APP_URL", "https://yourapp.onrender.com")
TZ = ZoneInfo("America/Argentina/Catamarca")
DATA_FILE = "data.json"
CSV_FILE = "data.csv"
LOG_FILE = "log.txt"
PORT = int(os.environ.get("PORT", 5000))
VERSION = "9.8.3"

if not TOKEN:
    raise ValueError("BOT_TOKEN Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½!")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 2 â€” Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
# -----------------------------
logging.basicConfig(
    level=logging.INFO,
    format="[{asctime}] {levelname}: {message}",
    style="{",
    handlers=[logging.FileHandler(LOG_FILE, encoding="utf-8"), logging.StreamHandler()]
)

def log_info(msg):
    logging.info(msg)
def log_error(msg):
    logging.error(msg)

log_info(f"Ð¡Ñ‚Ð°Ñ€Ñ‚ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ. Ð’ÐµÑ€ÑÐ¸Ñ {VERSION}")

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 3 â€” Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸ IO
# -----------------------------
def default_data():
    return {
        "overall_balance": 0,
        "records": [],
        "chats": {},
        "active_messages": {},
        "processed_messages": [],
        "forward_targets": [],
        "tracked_messages": {},
        "next_id": 1
    }

def load_data():
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, "r", encoding="utf-8") as f:
                d = json.load(f)
        except:
            d = default_data()
    else:
        d = default_data()
    base = default_data()
    for k, v in base.items():
        if k not in d:
            d[k] = v
    return d

def save_data(d):
    try:
        with open(DATA_FILE, "w", encoding="utf-8") as f:
            json.dump(d, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ data.json: {e}")

data = load_data()

if OWNER_ID:
    try:
        oi = int(OWNER_ID)
        if oi not in data.get("forward_targets", []):
            data["forward_targets"].append(oi)
            save_data(data)
    except Exception:
        pass

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 4 â€” Ð§Ð°Ñ‚/Ð´Ð°Ñ‚Ð°
# -----------------------------
def get_today_key():
    return datetime.now(TZ).strftime("%Y-%m-%d")

def get_chat_store(chat_id):
    cid = str(chat_id)
    if cid not in data["chats"]:
        data["chats"][cid] = {"balance": 0, "records": [], "next_id": 1, "daily_records": {}, "active_windows": {}}
        save_data(data)
    return data["chats"][cid]

def get_today_active_window(chat_id):
    today = get_today_key()
    day_map = data["active_messages"].get(today, {})
    return day_map.get(str(chat_id))

def set_today_active_window(chat_id, message_id):
    today = get_today_key()
    if "active_messages" not in data:
        data["active_messages"] = {}
    if today not in data["active_messages"]:
        data["active_messages"][today] = {}
    data["active_messages"][today][str(chat_id)] = message_id
    save_data(data)

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 5 â€” Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ Ð·Ð°Ð¿Ð¸ÑÑÐ¼Ð¸
# -----------------------------
def add_record_to_chat(chat_id, amount, note, owner):
    store = get_chat_store(chat_id)
    rid = data.get("next_id", 1)
    rec = {"id": rid, "short_id": f"R{rid}", "timestamp": datetime.now(TZ).isoformat(timespec="seconds"), "amount": amount, "note": note, "owner": owner}
    data.setdefault("records", []).append(rec)
    store.setdefault("records", []).append(rec)
    day = get_today_key()
    store.setdefault("daily_records", {}).setdefault(day, []).append(rec)
    store["balance"] = store.get("balance", 0) + amount
    data["overall_balance"] = data.get("overall_balance", 0) + amount
    data["next_id"] = rid + 1
    save_data(data)
    try: export_to_csv(data)
    except: pass
    return rec

def update_record_in_chat(chat_id, rid, new_amount, new_note):
    store = get_chat_store(chat_id)
    found = None
    for r in store.get("records", []):
        if r["id"] == rid:
            r["amount"] = new_amount
            r["note"] = new_note
            found = r
            break
    if found:
        for day_recs in store.get("daily_records", {}).values():
            for r in day_recs:
                if r["id"] == rid:
                    r.update(found)
        store["balance"] = sum([x["amount"] for x in store.get("records", [])])
        data["overall_balance"] = sum([x["amount"] for x in data.get("records", [])])
        save_data(data)
        export_to_csv(data)
        return True, found
    return False, None

def delete_record_in_chat(chat_id, rid):
    store = get_chat_store(chat_id)
    removed = None
    for r in list(store.get("records", [])):
        if r["id"] == rid or str(r["id"]) == str(rid) or r.get("short_id") == f"R{rid}":
            removed = r
            store["records"].remove(r)
            break
    if removed:
        for day_key, recs in store.get("daily_records", {}).items():
            store["daily_records"][day_key] = [x for x in recs if x["id"] != rid]
        store["balance"] = sum([x["amount"] for x in store.get("records", [])])
        data["records"] = [x for x in data.get("records", []) if x["id"] != rid]
        data["overall_balance"] = sum([x["amount"] for x in data.get("records", [])])
        save_data(data)
        export_to_csv(data)
        return True, removed
    return False, None

def export_to_csv(d):
    try:
        with open(CSV_FILE, "w", newline='', encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key"])
            for cid, cdata in d.get("chats", {}).items():
                for day_key, records in cdata.get("daily_records", {}).items():
                    for r in records:
                        writer.writerow([cid, r.get("id"), r.get("short_id"), r.get("timestamp"), r.get("amount"), r.get("note"), r.get("owner"), day_key])
    except Exception as e:
        log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð° CSV: {e}")

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 6 â€” ÐšÐ»Ð°Ð²Ð¸Ð°Ñ‚ÑƒÑ€Ñ‹
# -----------------------------
def build_main_keyboard(chat_id=None, confirm_reset=False):
    kb = types.InlineKeyboardMarkup(row_width=3)
    kb.row(
        types.InlineKeyboardButton("ðŸ’° Ð‘Ð°Ð»Ð°Ð½Ñ", callback_data="btn_balance"),
        types.InlineKeyboardButton("ðŸ“Š ÐžÑ‚Ñ‡Ñ‘Ñ‚", callback_data="btn_report"),
        types.InlineKeyboardButton("ðŸ“‚ CSV", callback_data="btn_csv")
    )
    if confirm_reset:
        kb.row(
            types.InlineKeyboardButton("âœ… Ð”Ð°", callback_data="confirm_reset"),
            types.InlineKeyboardButton("âŒ ÐÐµÑ‚", callback_data="cancel_reset")
        )
    else:
        kb.row(types.InlineKeyboardButton("âš™ï¸ ÐžÐ±Ð½ÑƒÐ»Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ", callback_data="btn_reset"))
    kb.row(
        types.InlineKeyboardButton("ðŸš€ ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ", callback_data="btn_start"),
        types.InlineKeyboardButton("â„¹ï¸ Ð˜Ð½Ñ„Ð¾", callback_data="btn_cod")
    )
    balance_text = ""
    if chat_id is not None:
        store = get_chat_store(chat_id)
        balance_text = f"ðŸ’° {store.get('balance', 0)} ARS"
    kb.add(types.InlineKeyboardButton(balance_text or "ðŸ’° 0 ARS", callback_data="noop"))
    return kb

def build_edit_keyboard():
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.row(
        types.InlineKeyboardButton("âœ Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ", callback_data="edit_change"),
        types.InlineKeyboardButton("ðŸ—‘ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ", callback_data="edit_delete")
    )
    kb.add(types.InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data="edit_back"))
    return kb

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 7 â€” ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ/ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾ÐºÐ½Ð°
# -----------------------------
def update_or_send_today_window(chat_id, show_report=False):
    today_key = get_today_key()
    store = get_chat_store(chat_id)
    day_records = store.get("daily_records", {}).get(today_key, [])

    daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
    daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
    overall_balance = store.get("balance", 0)

    if show_report:
        # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð° â€” Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ€Ð°ÑÑ…Ð¾Ð´Ñ‹
        expenses = [r for r in day_records if r["amount"] < 0]
        daily_expense_total = sum(abs(r["amount"]) for r in expenses)
        if not expenses:
            text = f"ðŸ“… {today_key}\nÐŸÐ¾ÐºÐ° Ð½ÐµÑ‚ Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð² Ð·Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ.\nðŸ’¸ Ð Ð°ÑÑ…Ð¾Ð´ Ð·Ð° Ð´ÐµÐ½ÑŒ: 0 ARS"
        else:
            lines = [f"ðŸ“… {today_key}", "ðŸ“‹ Ð Ð°ÑÑ…Ð¾Ð´Ñ‹ Ð·Ð° Ð´ÐµÐ½ÑŒ:"]
            for r in expenses[-30:]:
                lines.append(f"{r['short_id']}: -{abs(r['amount'])} â€” {r.get('note','')}")
            lines.append(f"\nðŸ’¸ Ð Ð°ÑÑ…Ð¾Ð´ Ð·Ð° Ð´ÐµÐ½ÑŒ: {daily_expense_total} ARS")
            text = "\n".join(lines)
    else:
        # Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð´Ð½Ñ
        if not day_records:
            text = (
                f"ðŸ“… {today_key}\n"
                f"ÐŸÐ¾ÐºÐ° Ð½ÐµÑ‚ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹.\n"
                f"ðŸ’µ ÐŸÑ€Ð¸Ñ…Ð¾Ð´: {daily_income} ARS\n"
                f"ðŸ’¸ Ð Ð°ÑÑ…Ð¾Ð´: {abs(daily_expense)} ARS\n"
                f"ðŸ’° ÐžÐ±Ñ‰Ð¸Ð¹ Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ðº: {overall_balance} ARS"
            )
        else:
            lines = [f"ðŸ“… {today_key}", "ðŸ“‹ ÐžÐ¿ÐµÑ€Ð°Ñ†Ð¸Ð¸:"]
            for r in day_records[-50:]:
                sign = "+" if r["amount"] > 0 else "-"
                lines.append(f"{r['short_id']}: {sign}{abs(r['amount'])} â€” {r.get('note','')}")
            lines.append(
                f"\nðŸ’µ ÐŸÑ€Ð¸Ñ…Ð¾Ð´: {daily_income} ARS\n"
                f"ðŸ’¸ Ð Ð°ÑÑ…Ð¾Ð´: {abs(daily_expense)} ARS\n"
                f"ðŸ’° ÐžÐ±Ñ‰Ð¸Ð¹ Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ðº: {overall_balance} ARS"
            )
            text = "\n".join(lines)

    kb = build_main_keyboard(chat_id)
    today_msgs = data.setdefault("active_messages", {}).setdefault(today_key, {})
    active_id = today_msgs.get(str(chat_id))

    if active_id:
        try:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
        except telebot.apihelper.ApiException as e:
            log_error(f"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾ÐºÐ½Ð¾ {active_id} Ð´Ð»Ñ Ñ‡Ð°Ñ‚Ð° {chat_id}: {e}")
        return

    # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð½Ð¾Ð²Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ ÐµÑ‰Ñ‘ Ð½ÐµÑ‚
    try:
        sent = bot.send_message(chat_id, text, reply_markup=kb)
        today_msgs[str(chat_id)] = sent.message_id
        save_data(data)
    except Exception as e:
        log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¾ÐºÐ½Ð° Ð´Ð»Ñ {chat_id}: {e}")


# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 8 â€” Callback ÐºÐ½Ð¾Ð¿Ð¾Ðº
# -----------------------------
@bot.callback_query_handler(func=lambda c: True)
def handle_callback(call):
    chat_id = call.message.chat.id
    store = get_chat_store(chat_id)
    today_key = get_today_key()
    day_records = store.get("daily_records", {}).get(today_key, [])
    today_msgs = data.setdefault("active_messages", {}).setdefault(today_key, {})
    active_id = today_msgs.get(str(chat_id))

    # ----------- Ð‘Ð°Ð»Ð°Ð½Ñ -----------
    if call.data == "btn_balance":
        daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
        daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
        overall_balance = store.get("balance", 0)

        text = (
            f"ðŸ“… {today_key}\n\n"
            f"ðŸ’° ÐžÐ±Ñ‰Ð¸Ð¹ Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ðº: {overall_balance} ARS\n"
            f"ðŸ’µ ÐŸÑ€Ð¸Ñ…Ð¾Ð´ Ð·Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ: {daily_income} ARS\n"
            f"ðŸ’¸ Ð Ð°ÑÑ…Ð¾Ð´ Ð·Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ: {abs(daily_expense)} ARS"
        )

        if active_id:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=build_main_keyboard(chat_id))
        else:
            update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, "Ð‘Ð°Ð»Ð°Ð½Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»Ñ‘Ð½ âœ…")
        return

    # ----------- ÐžÑ‚Ñ‡Ñ‘Ñ‚ (Ñ€Ð°ÑÑ…Ð¾Ð´Ñ‹) -----------
    if call.data == "btn_report":
        update_or_send_today_window(chat_id, show_report=True)
        bot.answer_callback_query(call.id, "ÐžÑ‚Ñ‡Ñ‘Ñ‚ Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð² Ð¾Ð±Ð½Ð¾Ð²Ð»Ñ‘Ð½ ðŸ“Š")
        return

    # ----------- CSV -----------
    if call.data == "btn_csv":
        try:
            with open(CSV_FILE, "rb") as f:
                bot.send_document(chat_id, f, caption="ðŸ“‚ Ð’Ð°Ñˆ Ñ„Ð°Ð¹Ð» data.csv")
            bot.answer_callback_query(call.id, "CSV Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½ ðŸ“")
        except Exception as e:
            bot.send_message(chat_id, f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ CSV: {e}")
            bot.answer_callback_query(call.id)
        return

    # ----------- Ð¡Ð±Ñ€Ð¾Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… -----------
    if call.data == "btn_reset":
        store["records"] = []
        store["daily_records"] = {}
        store["balance"] = 0
        data["records"] = []
        data["overall_balance"] = 0
        save_data(data)
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, "Ð”Ð°Ð½Ð½Ñ‹Ðµ ÑÐ±Ñ€Ð¾ÑˆÐµÐ½Ñ‹ ðŸ§¹")
        return

    # ----------- ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¾ÐºÐ½Ð¾ -----------
    if call.data == "btn_start":
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, "ÐžÐºÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ ðŸ”„")
        return

    # ----------- Ð˜Ð½Ñ„Ð¾ (ÑÐ¿Ð¸ÑÐ¾Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´) -----------
    if call.data == "btn_cod":
        info_text = (
            f"â„¹ï¸ Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð±Ð¾Ñ‚ â€” Ð²ÐµÑ€ÑÐ¸Ñ {VERSION}\n\n"
            "ðŸ“Œ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:\n"
            "/start - Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð° Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾ÐºÐ½Ð° Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð° Ð½Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ\n"
            "/balance - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¾Ð±Ñ‰Ð¸Ð¹ Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ðº Ð·Ð° Ð´ÐµÐ½ÑŒ\n"
            "/report - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð² Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð´Ð½Ñ\n"
            "/csv - Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÐµÐ¹ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹\n"
            "/reset - ÐŸÐ¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¾Ñ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð·Ð°Ð¿Ð¸ÑÐ¸\n"
            "/update - ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ Ð¾ÐºÐ½Ð¾\n"
            "/info - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ð¾ Ð¾ÐºÐ½Ð¾ ÑÐ¾ ÑÐ¿Ð¸ÑÐºÐ¾Ð¼ ÐºÐ¾Ð¼Ð°Ð½Ð´\n\n"
            "ðŸ“ Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹:\n"
            "+500 Ð—Ð°Ñ€Ð¿Ð»Ð°Ñ‚Ð°\n"
            "-150 ÐžÐ±ÐµÐ´\n"
            "200 Ð¢Ð°ÐºÑÐ¸\n\n"
            "âœï¸ Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ñ‡ÐµÑ€ÐµÐ· ÐºÐ½Ð¾Ð¿ÐºÐ¸ \"Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ\" / \"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ\""
        )
        bot.send_message(chat_id, info_text, reply_markup=None)
        bot.answer_callback_query(call.id)
        return
# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 9 â€” Ð’Ñ…Ð¾Ð´ÑÑ‰Ð¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
# -----------------------------
num_re = re.compile(r'([+-]?\s*\d+)')

@bot.message_handler(func=lambda m: True)
def handle_message(msg):
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    wait_action = store.get("edit_wait")

    if wait_action is None:
        m = num_re.search(msg.text)
        if m:
            try:
                raw = m.group(1).replace(" ", "")
                if raw.startswith("+"):
                    amount = int(raw[1:])        # ÐŸÑ€Ð¸Ñ…Ð¾Ð´
                elif raw.startswith("-"):
                    amount = -int(raw[1:])       # Ð Ð°ÑÑ…Ð¾Ð´
                else:
                    amount = -int(raw)           # Ð‘ÐµÐ· Ð·Ð½Ð°ÐºÐ° = Ñ€Ð°ÑÑ…Ð¾Ð´

                note = msg.text.replace(m.group(1), "").strip()
                add_record_to_chat(chat_id, amount, note, msg.from_user.id)
                update_or_send_today_window(chat_id)
            except Exception as e:
                log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð°Ð²Ñ‚Ð¾-Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸: {e}")
        return

    # Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸
    if wait_action == "change_id":
        try:
            rid = int(msg.text.strip())
            store["edit_target"] = rid
            store["edit_wait"] = "change_value"
            bot.send_message(chat_id, f"Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð²ÑƒÑŽ ÑÑƒÐ¼Ð¼Ñƒ Ð¸ Ð·Ð°Ð¼ÐµÑ‚ÐºÑƒ Ð´Ð»Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸ {rid}:")
        except:
            bot.send_message(chat_id, "ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ ID")
        return

    if wait_action == "change_value":
        rid = store.get("edit_target")
        if not rid:
            store["edit_wait"] = None
            return
        parts = msg.text.strip().split(" ", 1)
        try:
            amount = int(parts[0])
            note = parts[1] if len(parts) > 1 else ""
            success, _ = update_record_in_chat(chat_id, rid, amount, note)
            store["edit_wait"] = None
            store["edit_target"] = None
            update_or_send_today_window(chat_id)
            msg_text = f"âœ… Ð—Ð°Ð¿Ð¸ÑÑŒ {rid} Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð°" if success else f"âŒ Ð—Ð°Ð¿Ð¸ÑÑŒ {rid} Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
            bot.send_message(chat_id, msg_text)
        except:
            bot.send_message(chat_id, "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ð²Ð¾Ð´Ðµ ÑÑƒÐ¼Ð¼Ñ‹")
        return

    # Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸
    if wait_action == "delete_id":
        try:
            rid = int(msg.text.strip())
            success, _ = delete_record_in_chat(chat_id, rid)
            store["edit_wait"] = None
            update_or_send_today_window(chat_id)
            msg_text = f"âœ… Ð—Ð°Ð¿Ð¸ÑÑŒ {rid} ÑƒÐ´Ð°Ð»ÐµÐ½Ð°" if success else f"âŒ Ð—Ð°Ð¿Ð¸ÑÑŒ {rid} Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
            bot.send_message(chat_id, msg_text)
        except:
            bot.send_message(chat_id, "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ Ð·Ð°Ð¿Ð¸ÑÐ¸")

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 10 â€” ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ñ "/"
# -----------------------------
@bot.message_handler(commands=["start"])
def cmd_start(msg):
    chat_id = msg.chat.id
    # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¾ÐºÐ½Ð¾ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ ÐµÑ‰Ñ‘ Ð½ÐµÑ‚
    update_or_send_today_window(chat_id, create_if_missing=True)
    bot.send_message(chat_id, f"âœ… Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½! Ð’ÐµÑ€ÑÐ¸Ñ {VERSION}")

@bot.message_handler(commands=["balance"])
def cmd_balance(msg):
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    today_key = get_today_key()
    day_records = store.get("daily_records", {}).get(today_key, [])

    daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0)
    daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0)
    overall_balance = store.get("balance", 0)

    text = (
        f"ðŸ“… {today_key}\n\n"
        f"ðŸ’° ÐžÐ±Ñ‰Ð¸Ð¹ Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ðº: {overall_balance} ARS\n"
        f"ðŸ’µ ÐŸÑ€Ð¸Ñ…Ð¾Ð´ Ð·Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ: {daily_income} ARS\n"
        f"ðŸ’¸ Ð Ð°ÑÑ…Ð¾Ð´ Ð·Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ: {abs(daily_expense)} ARS"
    )
    update_or_send_today_window(chat_id)
    bot.send_message(chat_id, text)

@bot.message_handler(commands=["report"])
def cmd_report(msg):
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    today_key = get_today_key()
    day_records = store.get("daily_records", {}).get(today_key, [])
    expenses = [r for r in day_records if r["amount"] < 0]
    daily_expense_total = sum(abs(r["amount"]) for r in expenses)

    if not expenses:
        text = f"ðŸ“… {today_key}\nÐŸÐ¾ÐºÐ° Ð½ÐµÑ‚ Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð² Ð·Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ.\nðŸ’¸ Ð Ð°ÑÑ…Ð¾Ð´ Ð·Ð° Ð´ÐµÐ½ÑŒ: 0 ARS"
    else:
        lines = [f"ðŸ“… {today_key}", "ðŸ“‹ Ð Ð°ÑÑ…Ð¾Ð´Ñ‹ Ð·Ð° Ð´ÐµÐ½ÑŒ:"]
        for r in expenses[-30:]:
            lines.append(f"{r['short_id']}: -{abs(r['amount'])} â€” {r.get('note','')}")
        lines.append(f"\nðŸ’¸ Ð Ð°ÑÑ…Ð¾Ð´ Ð·Ð° Ð´ÐµÐ½ÑŒ: {daily_expense_total} ARS")
        text = "\n".join(lines)

    update_or_send_today_window(chat_id)
    bot.send_message(chat_id, text)

@bot.message_handler(commands=["csv"])
def cmd_csv(msg):
    chat_id = msg.chat.id
    try:
        with open(CSV_FILE, "rb") as f:
            bot.send_document(chat_id, f, caption="ðŸ“‚ Ð’Ð°Ñˆ Ñ„Ð°Ð¹Ð» data.csv")
    except Exception as e:
        bot.send_message(chat_id, f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ CSV: {e}")

@bot.message_handler(commands=["reset"])
def cmd_reset(msg):
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    store["records"] = []
    store["daily_records"] = {}
    store["balance"] = 0
    data["records"] = []
    data["overall_balance"] = 0
    save_data(data)
    update_or_send_today_window(chat_id)
    bot.send_message(chat_id, "ðŸ§¹ Ð”Ð°Ð½Ð½Ñ‹Ðµ ÑÐ±Ñ€Ð¾ÑˆÐµÐ½Ñ‹")

@bot.message_handler(commands=["info"])
def cmd_info(msg):
    chat_id = msg.chat.id
    info_text = (
        f"â„¹ï¸ Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð±Ð¾Ñ‚ â€” Ð²ÐµÑ€ÑÐ¸Ñ {VERSION}\n\n"
        "ðŸ“Œ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:\n"
        "/start - Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð° Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾ÐºÐ½Ð° Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð° Ð½Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ\n"
        "/balance - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¾Ð±Ñ‰Ð¸Ð¹ Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ðº Ð·Ð° Ð´ÐµÐ½ÑŒ\n"
        "/report - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð² Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð´Ð½Ñ\n"
        "/csv - Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÐµÐ¹ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹\n"
        "/reset - ÐŸÐ¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¾Ñ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð·Ð°Ð¿Ð¸ÑÐ¸\n"
        "/info - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ð¾ Ð¾ÐºÐ½Ð¾ ÑÐ¾ ÑÐ¿Ð¸ÑÐºÐ¾Ð¼ ÐºÐ¾Ð¼Ð°Ð½Ð´\n\n"
        "ðŸ“ Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹:\n"
        "+500 Ð—Ð°Ñ€Ð¿Ð»Ð°Ñ‚Ð°\n"
        "-150 ÐžÐ±ÐµÐ´\n"
        "200 Ð¢Ð°ÐºÑÐ¸\n\n"
        "âœï¸ Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ñ‡ÐµÑ€ÐµÐ· ÐºÐ½Ð¾Ð¿ÐºÐ¸ \"Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ\" / \"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ\""
    )
    bot.send_message(chat_id, info_text)

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 13 â€” Flask webhook
# -----------------------------
@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    update = telebot.types.Update.de_json(request.get_data().decode("utf-8"))
    bot.process_new_updates([update])
    return "OK", 200

@app.route("/", methods=["GET"])
def index():
    return f"Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð±Ð¾Ñ‚ Â«Ð¤ÐžÂ» â€” Ð²ÐµÑ€ÑÐ¸Ñ {VERSION} Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚", 200

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 14 â€” Webhook ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸ Ð·Ð°Ð¿ÑƒÑÐº
# -----------------------------
def set_webhook():
    url = f"{APP_URL}/{TOKEN}"
    try:
        bot.remove_webhook()
        time.sleep(0.5)
        bot.set_webhook(url=url)
        log_info(f"Webhook ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½: {url}")
    except Exception as e:
        log_error(f"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ webhook: {e}")

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 15 â€” ÐŸÐ»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ñ‰Ð¸Ðº ÑÐ¼ÐµÐ½Ñ‹ Ð´Ð½Ñ
# -----------------------------
def schedule_daily_window_creation():
    def task():
        last_day = get_today_key()
        while True:
            try:
                time.sleep(60)
                current_day = get_today_key()
                if current_day != last_day:
                    for chat_id_str in list(data.get("chats", {}).keys()):
                        try:
                            chat_id = int(chat_id_str)
                        except: continue
                        try: update_or_send_today_window(chat_id)
                        except Exception as e: log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð¾ÐºÐ½Ð° Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð´Ð½Ñ Ð´Ð»Ñ {chat_id}: {e}")
                    last_day = current_day
            except Exception as e:
                log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð² daily loop: {e}")
                time.sleep(5)
    thread = threading.Thread(target=task, daemon=True)
    thread.start()

# -----------------------------
# ÐžÐ¢Ð¡Ð•Ðš 16 â€” Ð—Ð°Ð¿ÑƒÑÐº
# -----------------------------
if __name__ == "__main__":
    set_webhook()
    schedule_daily_window_creation()
    log_info(f"Ð‘Ð¾Ñ‚ Ð¤Ðž Ð²ÐµÑ€ÑÐ¸Ð¸ {VERSION} Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½")

    # Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†Ñƒ Ð² Telegram
    try:
        if OWNER_ID:
            bot.send_message(int(OWNER_ID), f"âœ… Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚! (Ð²ÐµÑ€ÑÐ¸Ñ {VERSION})")
    except Exception as e:
        log_error(f"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐµ: {e}")

    app.run(host="0.0.0.0", port=PORT)