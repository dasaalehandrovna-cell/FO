# ==========================
# Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð±Ð¾Ñ‚ â€” Ð²ÐµÑ€ÑÐ¸Ñ 9.8.6 â€” Ð±Ð»Ð¾Ðº 1/3
# ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ, Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°/ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…, ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚Ñ‹
# ==========================

import os
import json
import csv
import time
import threading
from datetime import datetime
from zoneinfo import ZoneInfo

import telebot
from telebot import types
from flask import Flask, request

# ---------- ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ----------
TOKEN = os.getenv("BOT_TOKEN")
APP_URL = os.getenv("APP_URL")
OWNER_ID = os.getenv("OWNER_ID")
PORT = int(os.getenv("PORT", 5000))
DATA_FILE = "data.json"
CSV_FILE = "data.csv"
TZ = ZoneInfo("America/Argentina/Catamarca")
VERSION = "9.8.6"

if not TOKEN:
    raise ValueError("BOT_TOKEN Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½!")

bot = telebot.TeleBot(TOKEN, threaded=True)
app = Flask(__name__)

# ---------- Ð›Ð¾Ð³Ð¸ ----------
def log_info(msg): print(f"[INFO] {msg}")
def log_error(msg): print(f"[ERROR] {msg}")

log_info(f"Ð¡Ñ‚Ð°Ñ€Ñ‚ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ. Ð’ÐµÑ€ÑÐ¸Ñ {VERSION}")

# ---------- Ð”Ð°Ð½Ð½Ñ‹Ðµ ----------
def default_data():
    return {"overall_balance": 0, "records": [], "chats": {}, "active_messages": {}, "next_id": 1}

def load_data():
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, "r", encoding="utf-8") as f:
                d = json.load(f)
        except Exception as e:
            log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‡Ñ‚ÐµÐ½Ð¸Ñ {DATA_FILE}: {e}")
            d = default_data()
    else:
        d = default_data()
    # Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°ÑŽÑ‰Ð¸Ðµ ÐºÐ»ÑŽÑ‡Ð¸
    base = default_data()
    for k, v in base.items():
        if k not in d:
            d[k] = v
    return d

def save_data(d=None):
    try:
        with open(DATA_FILE, "w", encoding="utf-8") as f:
            json.dump(d or data, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ data.json: {e}")

data = load_data()

# Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ OWNER_ID Ð² forward_targets (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)
if OWNER_ID:
    try:
        oi = int(OWNER_ID)
        if oi not in data.get("forward_targets", []):
            data.setdefault("forward_targets", []).append(oi)
            save_data(data)
    except Exception as e:
        log_error(f"OWNER_ID Ð½Ðµ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½: {e}")

# ---------- Ð”Ð°Ñ‚Ð° / Ñ‡Ð°Ñ‚-Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ ----------
def get_today_key(): return datetime.now(TZ).strftime("%Y-%m-%d")

def get_chat_store(chat_id):
    cid = str(chat_id)
    if cid not in data["chats"]:
        data["chats"][cid] = {
            "balance": 0, "records": [], "next_id": 1, "daily_records": {},
            "edit_wait": None, "edit_target": None,
            "awaiting_reset_confirm": False, "delete_confirm": None
        }
        save_data(data)
    return data["chats"][cid]

def get_today_active_window(chat_id):
    today = get_today_key()
    return data.setdefault("active_messages", {}).get(today, {}).get(str(chat_id))

def set_today_active_window(chat_id, message_id):
    today = get_today_key()
    data.setdefault("active_messages", {}).setdefault(today, {})[str(chat_id)] = message_id
    save_data(data)

# ---------- Ð’ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÐµÐ´Ð¸Ð½Ð¾Ð³Ð¾ Ð¾ÐºÐ½Ð° ----------
def update_active_window(chat_id, text, kb=None):
    active_id = get_today_active_window(chat_id)
    kb = kb or build_main_keyboard(chat_id)
    if active_id:
        try:
            bot.edit_message_text(text, chat_id, active_id, reply_markup=kb)
            return
        except telebot.apihelper.ApiException:
            sent = bot.send_message(chat_id, text, reply_markup=kb)
            set_today_active_window(chat_id, sent.message_id)
            return
    else:
        sent = bot.send_message(chat_id, text, reply_markup=kb)
        set_today_active_window(chat_id, sent.message_id)
# ==========================
# Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð±Ð¾Ñ‚ â€” Ð²ÐµÑ€ÑÐ¸Ñ 9.8.6 â€” Ð±Ð»Ð¾Ðº 2/3
# Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ Ð·Ð°Ð¿Ð¸ÑÑÐ¼Ð¸, ÐºÐ»Ð°Ð²Ð¸Ð°Ñ‚ÑƒÑ€Ñ‹, ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ/Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¾ÐºÐ½Ð°
# ==========================

# ---------- Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ Ð·Ð°Ð¿Ð¸ÑÑÐ¼Ð¸ ----------
def add_record_to_chat(chat_id, amount, note, owner):
    store = get_chat_store(chat_id)
    rid = data.get("next_id", 1)
    rec = {
        "id": rid, "short_id": f"R{rid}",
        "timestamp": datetime.now(TZ).isoformat(timespec="seconds"),
        "amount": amount, "note": note, "owner": owner, "deleted": False
    }
    data.setdefault("records", []).append(rec)
    store.setdefault("records", []).append(rec)
    day = get_today_key()
    store.setdefault("daily_records", {}).setdefault(day, []).append(rec)
    # Ð¿ÐµÑ€ÐµÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð±Ð°Ð»Ð°Ð½Ñ
    store["balance"] = sum(r["amount"] for r in store.get("records", []) if not r.get("deleted", False))
    data["overall_balance"] = sum(r["amount"] for r in data.get("records", []) if not r.get("deleted", False))
    data["next_id"] = rid + 1
    save_data(data)
    try: export_to_csv(data)
    except Exception as e: log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ðµ Ð² CSV: {e}")
    return rec

def update_record_in_chat(chat_id, rid, new_amount, new_note):
    store = get_chat_store(chat_id)
    found = None
    for r in store.get("records", []):
        if r["id"] == rid:
            r["amount"], r["note"], r["deleted"] = new_amount, new_note, False
            found = r
            break
    if found:
        for day_recs in store.get("daily_records", {}).values():
            for r in day_recs:
                if r["id"] == rid: r.update(found)
        store["balance"] = sum(x["amount"] for x in store.get("records", []) if not x.get("deleted", False))
        data["overall_balance"] = sum(x["amount"] for x in data.get("records", []) if not x.get("deleted", False))
        save_data(data)
        try: export_to_csv(data)
        except: pass
        return True, found
    return False, None

def mark_deleted_record(chat_id, rid):
    store = get_chat_store(chat_id)
    removed = None
    for r in store.get("records", []):
        if r["id"] == rid:
            r["deleted"] = True
            removed = r
            break
    if removed:
        for day_recs in store.get("daily_records", {}).values():
            for r in day_recs:
                if r["id"] == rid: r["deleted"] = True
        store["balance"] = sum(x["amount"] for x in store.get("records", []) if not x.get("deleted", False))
        data["overall_balance"] = sum(x["amount"] for x in data.get("records", []) if not x.get("deleted", False))
        save_data(data)
        try: export_to_csv(data)
        except: pass
        return True, removed
    return False, None

def export_to_csv(d):
    try:
        with open(CSV_FILE, "w", newline='', encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow(["chat_id","ID","short_id","timestamp","amount","note","owner","day_key","deleted"])
            for cid, cdata in d.get("chats", {}).items():
                for day_key, records in cdata.get("daily_records", {}).items():
                    for r in records:
                        writer.writerow([cid, r.get("id"), r.get("short_id"), r.get("timestamp"), r.get("amount"), r.get("note"), r.get("owner"), day_key, r.get("deleted", False)])
    except Exception as e:
        log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð° CSV: {e}")

# ---------- ÐšÐ»Ð°Ð²Ð¸Ð°Ñ‚ÑƒÑ€Ñ‹ ----------
def build_main_keyboard(chat_id=None, confirm_reset=False, replace_update_with_edit=True):
    kb = types.InlineKeyboardMarkup(row_width=3)
    kb.row(
        types.InlineKeyboardButton("ðŸ’° Ð‘Ð°Ð»Ð°Ð½Ñ", callback_data="btn_balance"),
        types.InlineKeyboardButton("ðŸ“Š ÐžÑ‚Ñ‡Ñ‘Ñ‚", callback_data="btn_report"),
        types.InlineKeyboardButton("ðŸ“‚ CSV", callback_data="btn_csv")
    )
    if confirm_reset:
        kb.row(
            types.InlineKeyboardButton("âœ… Ð”Ð°", callback_data="confirm_reset"),
            types.InlineKeyboardButton("âŒ ÐÐµÑ‚", callback_data="cancel_reset")
        )
    else:
        kb.row(types.InlineKeyboardButton("âš™ï¸ ÐžÐ±Ð½ÑƒÐ»Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ", callback_data="btn_reset"))
    if replace_update_with_edit:
        kb.row(
            types.InlineKeyboardButton("âœï¸ Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ", callback_data="btn_edit_mode"),
            types.InlineKeyboardButton("â„¹ï¸ Ð˜Ð½Ñ„Ð¾", callback_data="btn_cod")
        )
    else:
        kb.row(
            types.InlineKeyboardButton("ðŸš€ ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ", callback_data="btn_start"),
            types.InlineKeyboardButton("â„¹ï¸ Ð˜Ð½Ñ„Ð¾", callback_data="btn_cod")
        )
    balance_text = ""
    if chat_id is not None:
        store = get_chat_store(chat_id)
        balance_text = f"ðŸ’° {store.get('balance', 0)} ARS"
    kb.add(types.InlineKeyboardButton(balance_text or "ðŸ’° 0 ARS", callback_data="noop"))
    return kb

# ---------- Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ / Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¾ÐºÐ½Ð° ----------
def update_or_send_today_window(chat_id, create_if_missing=True, show_info=False, edit_mode=False):
    today_key = get_today_key()
    store = get_chat_store(chat_id)
    day_records = store.get("daily_records", {}).get(today_key, [])

    if show_info:
        text = (
            f"â„¹ï¸ Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð±Ð¾Ñ‚ â€” Ð²ÐµÑ€ÑÐ¸Ñ {VERSION}\n\n"
            "ðŸ“Œ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:\n"
            "/start â€” ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ/Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¾ÐºÐ½Ð¾\n"
            "/balance â€” Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ðº\n"
            "/report â€” Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ€Ð°ÑÑ…Ð¾Ð´Ñ‹ Ð·Ð° Ð´ÐµÐ½ÑŒ\n"
            "/csv â€” ÑÐºÐ°Ñ‡Ð°Ñ‚ÑŒ CSV\n"
            "/reset â€” Ð¾Ð±Ð½ÑƒÐ»Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ (Ñ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸ÐµÐ¼)\n"
            "/update â€” Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¾ÐºÐ½Ð¾\n"
            "/info â€” Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ð¾ Ð¾ÐºÐ½Ð¾\n\n"
            "ðŸ“ ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹:\n"
            "+500 Ð—Ð°Ñ€Ð¿Ð»Ð°Ñ‚Ð°\n-150 ÐžÐ±ÐµÐ´\n200 Ð¢Ð°ÐºÑÐ¸\n\n"
            "âœï¸ ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Â«Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒÂ» Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑÐ¼Ð¸."
        )
        kb = build_main_keyboard(chat_id, replace_update_with_edit=True)
    else:
        daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0 and not r.get("deleted", False))
        daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0 and not r.get("deleted", False))
        overall_balance = store.get("balance", 0)

        if not day_records:
            text = (
                f"ðŸ“… {today_key}\nÐŸÐ¾ÐºÐ° Ð½ÐµÑ‚ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹.\n"
                f"ðŸ’µ ÐŸÑ€Ð¸Ñ…Ð¾Ð´: {daily_income} ARS\n"
                f"ðŸ’¸ Ð Ð°ÑÑ…Ð¾Ð´: {abs(daily_expense)} ARS\n"
                f"ðŸ’° ÐžÐ±Ñ‰Ð¸Ð¹ Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ðº: {overall_balance} ARS"
            )
            kb = build_main_keyboard(chat_id, replace_update_with_edit=True)
        else:
            lines = [f"ðŸ“… {today_key}", "ðŸ“‹ ÐžÐ¿ÐµÑ€Ð°Ñ†Ð¸Ð¸:"]
            kb = types.InlineKeyboardMarkup()
            for r in day_records[-50:]:
                if r.get("deleted", False):
                    lines.append(f"{r['short_id']}: âŒ Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ â€” {r.get('note','')}")
                else:
                    sign = "+" if r["amount"] > 0 else "-"
                    lines.append(f"{r['short_id']}: {sign}{abs(r['amount'])} â€” {r.get('note','')}")
                    if edit_mode:
                        kb.row(
                            types.InlineKeyboardButton(f"âœ {r['short_id']}", callback_data=f"edit_{r['id']}"),
                            types.InlineKeyboardButton(f"ðŸ—‘ {r['short_id']}", callback_data=f"delete_{r['id']}")
                        )
            lines.append(
                f"\nðŸ’µ ÐŸÑ€Ð¸Ñ…Ð¾Ð´: {daily_income} ARS\n"
                f"ðŸ’¸ Ð Ð°ÑÑ…Ð¾Ð´: {abs(daily_expense)} ARS\n"
                f"ðŸ’° ÐžÐ±Ñ‰Ð¸Ð¹ Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ðº: {overall_balance} ARS"
            )
            if edit_mode:
                kb.row(
                    types.InlineKeyboardButton("âš™ï¸ ÐžÐ±Ð½ÑƒÐ»Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ", callback_data="btn_reset"),
                    types.InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data="btn_back_from_edit")
                )
            else:
                kb.row(
                    types.InlineKeyboardButton("ðŸ’° Ð‘Ð°Ð»Ð°Ð½Ñ", callback_data="btn_balance"),
                    types.InlineKeyboardButton("ðŸ“Š ÐžÑ‚Ñ‡Ñ‘Ñ‚", callback_data="btn_report"),
                    types.InlineKeyboardButton("ðŸ“‚ CSV", callback_data="btn_csv")
                )
                kb.row(
                    types.InlineKeyboardButton("âœï¸ Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ", callback_data="btn_edit_mode"),
                    types.InlineKeyboardButton("â„¹ï¸ Ð˜Ð½Ñ„Ð¾", callback_data="btn_cod")
                )
            text = "\n".join(lines)

    update_active_window(chat_id, text, kb)
# ==========================
# Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð±Ð¾Ñ‚ â€” Ð²ÐµÑ€ÑÐ¸Ñ 9.8.6 â€” Ð±Ð»Ð¾Ðº 3/3
# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ½Ð¾Ð¿Ð¾Ðº, ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹, ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹, webhook, Ð·Ð°Ð¿ÑƒÑÐº
# ==========================

import re
num_re = re.compile(r'([+-]?\s*\d+)')

# ---------- Callback handler ----------
@bot.callback_query_handler(func=lambda c: True)
def handle_callback(call):
    chat_id = call.message.chat.id
    store = get_chat_store(chat_id)

    # -------- Ð ÐµÐ¶Ð¸Ð¼ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ --------
    if call.data == "btn_edit_mode":
        update_or_send_today_window(chat_id, edit_mode=True)
        bot.answer_callback_query(call.id, "Ð ÐµÐ¶Ð¸Ð¼ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ âœï¸")
        return

    if call.data.startswith("edit_"):
        rid = int(call.data.split("_")[1])
        rec = next((r for r in store.get("records", []) if r["id"]==rid), None)
        if not rec:
            bot.answer_callback_query(call.id, "Ð—Ð°Ð¿Ð¸ÑÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°")
            return
        text = f"Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ {rec['short_id']}:\nÐ¢ÐµÐºÑƒÑ‰ÐµÐµ: {rec['amount']} â€” {rec.get('note','')}\nÐ’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð²ÑƒÑŽ ÑÑƒÐ¼Ð¼Ñƒ Ð¸ Ð·Ð°Ð¼ÐµÑ‚ÐºÑƒ (Ð¿Ñ€Ð¸Ð¼ÐµÑ€: +500 Ð—Ð°Ñ€Ð¿Ð»Ð°Ñ‚Ð°)"
        update_active_window(chat_id, text)
        store["edit_wait"] = "change_value"
        store["edit_target"] = rid
        save_data(data)
        bot.answer_callback_query(call.id)
        return

    if call.data.startswith("delete_"):
        rid = int(call.data.split("_")[1])
        store["delete_confirm"] = rid
        save_data(data)
        kb = types.InlineKeyboardMarkup()
        kb.row(
            types.InlineKeyboardButton("âœ… Ð”Ð°", callback_data="confirm_delete"),
            types.InlineKeyboardButton("âŒ ÐÐµÑ‚", callback_data="cancel_delete")
        )
        update_active_window(chat_id, f"Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑŒ R{rid}?", kb)
        bot.answer_callback_query(call.id)
        return

    # ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ
    if call.data == "confirm_delete":
        rid = store.get("delete_confirm")
        if rid: mark_deleted_record(chat_id, rid)
        store["delete_confirm"] = None
        save_data(data)
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, "Ð—Ð°Ð¿Ð¸ÑÑŒ ÑƒÐ´Ð°Ð»ÐµÐ½Ð° âœ…")
        return

    if call.data == "cancel_delete":
        store["delete_confirm"] = None
        save_data(data)
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, "Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð¾ âŒ")
        return

    # -------- CSV --------
    if call.data == "btn_csv":
        try:
            with open(CSV_FILE, "rb") as f:
                bot.send_document(chat_id, f, caption="ðŸ“‚ Ð’Ð°Ñˆ Ñ„Ð°Ð¹Ð» data.csv")
            bot.answer_callback_query(call.id, "CSV Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½ ðŸ“")
        except Exception as e:
            bot.answer_callback_query(call.id, f"ÐžÑˆÐ¸Ð±ÐºÐ°: {e}")
        return

    # -------- Ð¡Ð±Ñ€Ð¾Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… --------
    if call.data == "btn_reset":
        kb = build_main_keyboard(chat_id, confirm_reset=True)
        update_active_window(chat_id, "âš ï¸ Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¾Ð±Ð½ÑƒÐ»Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð´Ð°Ð½Ð½Ñ‹Ðµ?", kb)
        store["awaiting_reset_confirm"] = True
        save_data(data)
        bot.answer_callback_query(call.id)
        return

    if call.data == "confirm_reset":
        if store.get("awaiting_reset_confirm"):
            store["records"] = []
            store["daily_records"] = {}
            store["balance"] = 0
            store["awaiting_reset_confirm"] = False
            save_data(data)
            update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, "Ð”Ð°Ð½Ð½Ñ‹Ðµ ÑÐ±Ñ€Ð¾ÑˆÐµÐ½Ñ‹ ðŸ§¹")
        return

    if call.data == "cancel_reset":
        store["awaiting_reset_confirm"] = False
        save_data(data)
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, "Ð¡Ð±Ñ€Ð¾Ñ Ð¾Ñ‚Ð¼ÐµÐ½Ñ‘Ð½ âŒ")
        return

    # -------- Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ --------
    if call.data == "btn_cod":
        update_or_send_today_window(chat_id, show_info=True)
        bot.answer_callback_query(call.id, "Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ ðŸ“„")
        return

    # -------- Ð’Ñ‹Ñ…Ð¾Ð´ Ð¸Ð· Ñ€ÐµÐ¶Ð¸Ð¼Ð° Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ --------
    if call.data == "btn_back_from_edit":
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id, "ÐÐ°Ð·Ð°Ð´")
        return

    # -------- Ð‘Ð°Ð»Ð°Ð½Ñ / ÐžÑ‚Ñ‡Ñ‘Ñ‚ / noop --------
    if call.data == "btn_balance":
        send_balance(chat_id)
        bot.answer_callback_query(call.id, "Ð‘Ð°Ð»Ð°Ð½Ñ Ð¿Ð¾ÐºÐ°Ð·Ð°Ð½ âœ…")
        return

    if call.data == "btn_report":
        send_report(chat_id)
        bot.answer_callback_query(call.id, "ÐžÑ‚Ñ‡Ñ‘Ñ‚ Ð¿Ð¾ÐºÐ°Ð·Ð°Ð½ ðŸ“Š")
        return

    if call.data == "btn_start" or call.data == "noop":
        update_or_send_today_window(chat_id)
        bot.answer_callback_query(call.id)
        return

# ---------- Ð’Ñ…Ð¾Ð´ÑÑ‰Ð¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ ----------
@bot.message_handler(func=lambda m: True)
def handle_message(msg):
    if not msg.text: return
    chat_id = msg.chat.id
    store = get_chat_store(chat_id)
    wait_action = store.get("edit_wait")

    if wait_action == "change_value":
        rid = store.get("edit_target")
        try:
            raw, note = msg.text.strip().split(" ",1)
            if raw.startswith("+"): amount = int(raw[1:])
            elif raw.startswith("-"): amount = -int(raw[1:])
            else: amount = -int(raw)
            update_record_in_chat(chat_id, rid, amount, note)
            store["edit_wait"], store["edit_target"] = None, None
            save_data(data)
            update_or_send_today_window(chat_id)
            bot.send_message(chat_id, f"âœ… Ð—Ð°Ð¿Ð¸ÑÑŒ R{rid} Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð°")
        except:
            bot.send_message(chat_id, "ÐžÑˆÐ¸Ð±ÐºÐ° Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð°. ÐŸÑ€Ð¸Ð¼ÐµÑ€: +500 Ð—Ð°Ñ€Ð¿Ð»Ð°Ñ‚Ð°")
        return

    # Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð¹ Ð·Ð°Ð¿Ð¸ÑÐ¸
    m = num_re.search(msg.text)
    if m:
        raw = m.group(1).replace(" ","")
        if raw.startswith("+"): amount = int(raw[1:])
        elif raw.startswith("-"): amount = -int(raw[1:])
        else: amount = -int(raw)
        note = msg.text.replace(m.group(1),"").strip()
        add_record_to_chat(chat_id, amount, note, msg.from_user.id)
        update_or_send_today_window(chat_id)

# ---------- Ð’ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ ----------
def send_balance(chat_id):
    store = get_chat_store(chat_id)
    today_key = get_today_key()
    day_records = store.get("daily_records", {}).get(today_key, [])
    daily_income = sum(r["amount"] for r in day_records if r["amount"] > 0 and not r.get("deleted", False))
    daily_expense = sum(r["amount"] for r in day_records if r["amount"] < 0 and not r.get("deleted", False))
    overall_balance = store.get("balance", 0)
    text = f"ðŸ“… {today_key}\nðŸ’° ÐžÐ±Ñ‰Ð¸Ð¹ Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ðº: {overall_balance} ARS\nðŸ’µ ÐŸÑ€Ð¸Ñ…Ð¾Ð´ Ð·Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ: {daily_income} ARS\nðŸ’¸ Ð Ð°ÑÑ…Ð¾Ð´ Ð·Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ: {abs(daily_expense)} ARS"
    update_active_window(chat_id, text)

def send_report(chat_id):
    store = get_chat_store(chat_id)
    today_key = get_today_key()
    day_records = store.get("daily_records", {}).get(today_key, [])
    expenses = [r for r in day_records if r["amount"] < 0 and not r.get("deleted", False)]
    if not expenses:
        text = f"ðŸ“… {today_key}\nÐŸÐ¾ÐºÐ° Ð½ÐµÑ‚ Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð² Ð·Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ.\nðŸ’¸ Ð Ð°ÑÑ…Ð¾Ð´ Ð·Ð° Ð´ÐµÐ½ÑŒ: 0 ARS"
    else:
        lines = [f"ðŸ“… {today_key}", "ðŸ“‹ Ð Ð°ÑÑ…Ð¾Ð´Ñ‹ Ð·Ð° Ð´ÐµÐ½ÑŒ:"]
        for r in expenses[-30:]:
            lines.append(f"{r['short_id']}: -{abs(r['amount'])} â€” {r.get('note','')}")
        total = sum(abs(r["amount"]) for r in expenses)
        lines.append(f"\nðŸ’¸ Ð Ð°ÑÑ…Ð¾Ð´ Ð·Ð° Ð´ÐµÐ½ÑŒ: {total} ARS")
        text = "\n".join(lines)
    update_active_window(chat_id, text)

def send_csv(chat_id):
    try:
        with open(CSV_FILE, "rb") as f:
            bot.send_document(chat_id, f, caption="ðŸ“‚ Ð’Ð°Ñˆ Ñ„Ð°Ð¹Ð» data.csv")
    except Exception as e:
        bot.send_message(chat_id, f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ CSV: {e}")

# ---------- Slash-ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ ----------
@bot.message_handler(commands=["start"])
def cmd_start(msg): update_or_send_today_window(msg.chat.id)

@bot.message_handler(commands=["balance"])
def cmd_balance(msg): send_balance(msg.chat.id)

@bot.message_handler(commands=["report"])
def cmd_report(msg): send_report(msg.chat.id)

@bot.message_handler(commands=["csv"])
def cmd_csv(msg): send_csv(msg.chat.id)

@bot.message_handler(commands=["reset"])
def cmd_reset(msg):
    kb = build_main_keyboard(msg.chat.id, confirm_reset=True)
    update_active_window(msg.chat.id, "âš ï¸ Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¾Ð±Ð½ÑƒÐ»Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð´Ð°Ð½Ð½Ñ‹Ðµ?", kb)
    store = get_chat_store(msg.chat.id)
    store["awaiting_reset_confirm"] = True
    save_data(data)

@bot.message_handler(commands=["update"])
def cmd_update(msg): update_or_send_today_window(msg.chat.id)

@bot.message_handler(commands=["info"])
def cmd_info(msg): update_or_send_today_window(msg.chat.id, show_info=True)

# ---------- Webhook / Flask ----------
@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    update = telebot.types.Update.de_json(request.get_data().decode("utf-8"))
    bot.process_new_updates([update])
    return "OK", 200

@app.route("/", methods=["GET"])
def index(): return f"Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð±Ð¾Ñ‚ â€” Ð²ÐµÑ€ÑÐ¸Ñ {VERSION} Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚", 200

def set_webhook():
    if not APP_URL: return
    url = f"{APP_URL}/{TOKEN}"
    try:
        bot.remove_webhook()
        time.sleep(0.5)
        bot.set_webhook(url=url)
        log_info(f"Webhook ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½: {url}")
    except Exception as e: log_error(f"ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ webhook: {e}")

def schedule_daily_window_creation():
    def task():
        last_day = get_today_key()
        while True:
            try:
                time.sleep(60)
                current_day = get_today_key()
                if current_day != last_day:
                    for cid in list(data.get("chats", {}).keys()):
                        try: update_or_send_today_window(int(cid))
                        except Exception as e: log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð¾ÐºÐ½Ð° Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð´Ð½Ñ Ð´Ð»Ñ {cid}: {e}")
                    last_day = current_day
            except Exception as e:
                log_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð² Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ñ‰Ð¸ÐºÐµ: {e}")
    threading.Thread(target=task, daemon=True).start()

if __name__ == "__main__":
    set_webhook()
    schedule_daily_window_creation()
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 5000)))
